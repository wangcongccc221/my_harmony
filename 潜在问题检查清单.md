# 潜在问题检查清单

## 🔍 你感觉有问题但说不出来的地方

基于代码审查，我发现了几个**可能的问题点**：

---

## ⚠️ 问题 1：页面懒加载可能不是真正的懒加载

### 问题描述
在 ArkUI 中，使用 `if/else` 条件渲染时：
- 组件可能**只是被隐藏**，而不是真正销毁
- 内存可能**没有被释放**
- 资源可能**还在运行**

### 当前实现
```typescript
@Builder
private renderPageContent(): void {
  if (this.currentPage === 'home') {
    this.buildHomePage()  // 可能只是隐藏，不是销毁
  } else if (this.currentPage === 'level') {
    this.buildLevelPage()
  }
}
```

### 可能的问题
- ❌ 组件可能还在内存中（只是不可见）
- ❌ `aboutToDisappear` 可能不会被调用
- ❌ 资源可能没有被清理

### 解决方案
使用 `visibility` 属性强制隐藏，或者使用路由系统实现真正的懒加载。

---

## ⚠️ 问题 2：全局单例可能阻止 GC

### 发现的单例
1. **WavePhaseManager** - 波浪动画管理器（全局定时器）
2. **HistoryTableManager** - 历史表格管理器
3. **GlobalCardDataManager** - 全局卡片数据管理器
4. **GlobalLevelCountManager** - 全局等级数量管理器
5. **DatabaseAdapterFactory** - 数据库适配器工厂
6. **RelationManager** - ORM 关系管理器
7. **MetadataCollector** - 元数据收集器
8. **CascadeManager** - 级联操作管理器

### 可能的问题
- ❌ 单例一直存在，不会释放
- ❌ 单例中可能持有页面引用
- ❌ 可能阻止垃圾回收

### 检查点
- [ ] 单例中是否有页面组件引用？
- [ ] 单例中是否有大数据缓存？
- [ ] 单例中是否有定时器未清理？

---

## ⚠️ 问题 3：WavePhaseManager 全局定时器

### 问题描述
```typescript
// WavePhaseManager.ets
private startGlobalAnimation(): void {
  this.animationId = setInterval(() => {
    // 全局定时器，一直运行
  }, 17)
}
```

### 可能的问题
- ❌ 即使所有页面都隐藏，定时器还在运行
- ❌ 监听器集合可能包含已销毁的组件引用
- ❌ 可能导致内存泄漏

### 检查点
- [ ] 页面切换时，WaveCard 是否移除了监听器？
- [ ] 定时器是否在应用退出时清理？

---

## ⚠️ 问题 4：数据库连接管理

### 问题描述
```typescript
// SQLiteAdapter.ets
async initialize(ctx: Context): Promise<void> {
  let db = GetIBestORM();
  if (!db) {
    await IBestORMInit(ctx, this.config);
    db = GetIBestORM();
  }
  this.initialized = true;
}
```

### 可能的问题
- ❌ 数据库连接可能没有正确关闭
- ❌ 连接可能一直保持打开状态
- ❌ 可能导致资源泄漏

### 检查点
- [ ] 数据库连接是否有关闭机制？
- [ ] 页面切换时连接是否保持打开？

---

## ⚠️ 问题 5：AppStorage 引用累积

### 问题描述
虽然我们在 `aboutToDisappear` 中清理了引用，但：
- 如果 `aboutToDisappear` 没有被调用，引用就不会清理
- 可能有其他地方也在使用 AppStorage

### 检查点
- [ ] 所有 AppStorage 引用是否都被清理？
- [ ] 是否有循环引用？

---

## 🔧 建议的检查方法

### 方法 1：添加内存监控
```typescript
// 在页面切换时记录内存
aboutToDisappear(): void {
  console.log('页面切换前内存:', /* 获取内存占用 */)
  // 清理资源
  console.log('页面切换后内存:', /* 获取内存占用 */)
}
```

### 方法 2：检查组件是否真正销毁
```typescript
// 在组件中添加日志
aboutToAppear(): void {
  console.log('组件创建:', this)
}

aboutToDisappear(): void {
  console.log('组件销毁:', this)
  // 如果这个日志没有出现，说明组件没有被销毁
}
```

### 方法 3：使用 DevEco Studio 性能分析
- 观察内存占用曲线
- 切换页面时，内存是否下降
- 如果内存不下降，说明资源没有被释放

---

## 🎯 最可能的问题

基于你的"感觉有问题"，**最可能的问题是**：

1. **页面懒加载不是真正的懒加载**（组件只是隐藏，没有销毁）
2. **全局单例持有引用**（阻止垃圾回收）
3. **WavePhaseManager 的监听器没有清理**（已销毁的组件还在监听）

---

## 💡 建议

1. **测试内存占用**：使用性能分析工具，观察切换页面时内存是否下降
2. **添加日志**：在 `aboutToDisappear` 中添加日志，确认是否被调用
3. **检查单例**：确认单例中没有持有页面引用
4. **清理监听器**：确保 WaveCard 在销毁时移除监听器

需要我帮你检查具体哪个问题吗？

