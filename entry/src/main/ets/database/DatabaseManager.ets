// IBest-ORM ä¸»å…¥å£ï¼Œç”¨äºè·å– ORM å®ä¾‹å¹¶è¿›è¡Œè¡¨è¿ç§»/CRUD
import { GetIBestORM } from '@ibestservices/ibest-orm';
import { relationalStore } from '@kit.ArkData';
// æ•°æ®æ¨¡å‹ï¼ˆå¯¹åº”å„å¼ è¡¨ï¼‰
import { User } from './models/User'; //å¯¼å…¥ç”¨æˆ·æ¨¡å‹
import { TestModel } from './models/TestModel'; //å¯¼å…¥æµ‹è¯•æ¨¡å‹
import { ProcessingHistory } from './models/ProcessingHistory'; //å¯¼å…¥å†å²åŠ å·¥æ¨¡å‹
import { UserData, TestData, ProcessingHistoryData, CreateUserParams, CreateTestRecordParams, CreateProcessingHistoryParams } from './types';
// è¡¨åæ˜ å°„ï¼ˆç»Ÿä¸€ç®¡ç†å„è¡¨çš„å®é™…åç§°ï¼‰
import { TABLE_NAMES } from './utils/TableNameMapper';
// æ•°æ®è½¬æ¢å·¥å…·ï¼ˆå®ä½“ <-> å€¼æ¡¶/æŸ¥è¯¢ç»“æœï¼‰
import { processingHistoryToValueBucket, convertToProcessingHistoryData, testModelToValueBucket } from './utils/DataConverter';
import { setValueIfNotEmpty } from './utils/ValueBucketHelper';

/**
 * æ•°æ®åº“ç®¡ç†ç±»
 * å°è£…æ‰€æœ‰æ•°æ®åº“æ“ä½œï¼Œæä¾›ç»Ÿä¸€çš„æ¥å£
 * æ”¯æŒ Userã€TestModel å’Œ ProcessingHistory æ•°æ®æ¨¡å‹
 */
export class DatabaseManager {
  // å•ä¾‹å®ä¾‹ï¼Œç¡®ä¿å…¨å±€åªå­˜åœ¨ä¸€ä¸ªæ•°æ®åº“ç®¡ç†å™¨
  private static instance: DatabaseManager | null = null;
  // ORM å®ä¾‹ï¼ˆçº¿ç¨‹å®‰å…¨ç”±åº•å±‚ä¿è¯ï¼‰
  private db = GetIBestORM(); //åˆå§‹åŒ–æ–¹å¼ï¼šåœ¨EntryAbility.etsä¸­è°ƒç”¨IBestORMInit()åˆå§‹åŒ–  

  private constructor() {
    // ç§æœ‰æ„é€ å‡½æ•°ï¼Œå®ç°å•ä¾‹æ¨¡å¼
  }

  // è·å–å•ä¾‹ï¼ˆé¦–æ¬¡è°ƒç”¨æ—¶åˆå§‹åŒ–ï¼‰
  public static getInstance(): DatabaseManager {
    if (!DatabaseManager.instance) {
      DatabaseManager.instance = new DatabaseManager();
    }
    return DatabaseManager.instance;
  }

  /**
   * åˆå§‹åŒ–æ•°æ®åº“ï¼ˆè‡ªåŠ¨å»ºè¡¨/è¿ç§»ï¼‰
   * æ³¨æ„ï¼šåº”åœ¨åº”ç”¨å¯åŠ¨é˜¶æ®µè°ƒç”¨ä¸€æ¬¡
   */
  public async initDatabase(): Promise<void> {
    try {
      // æ ¹æ®æ¨¡å‹è‡ªåŠ¨è¿ç§»è¡¨ç»“æ„ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå­˜åœ¨åˆ™å¯¹é½ï¼‰ å¯å¤ç”¨æ‰§è¡Œè¯­å¥
      this.db.AutoMigrate(User);
      this.db.AutoMigrate(TestModel);
      this.db.AutoMigrate(ProcessingHistory);
      
      // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿è¿ç§»å®Œæˆ
      await new Promise<void>((resolve: () => void) => {
        setTimeout(() => {
          resolve();
        }, 100);
      });
      
      console.info('âœ… æ•°æ®åº“è¡¨ç»“æ„åˆå§‹åŒ–æˆåŠŸï¼ˆUser, TestModel, ProcessingHistoryï¼‰');
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', errorMsg);
      throw new Error(`æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ${errorMsg}`);
    }
  }

  //User ç›¸å…³æ“ä½œ å°è£…

  /**
   * æ–°å¢ç”¨æˆ·ï¼ˆä¼ å…¥å®ä½“ï¼‰
   * ä¼˜å…ˆä½¿ç”¨ ORM çš„ Createï¼›å¤±è´¥åˆ™å›é€€åˆ° Insertï¼ˆé…åˆå€¼æ¡¶ï¼‰
   */
  public createUser(user: User): User {
    try {
      // æ ¹æ®æ–‡æ¡£ï¼Œä¼˜å…ˆä½¿ç”¨ Create æ–¹æ³•ï¼ˆæ¨èæ–¹å¼ï¼‰
      try {
        this.db.Create(user);
        console.info(`âœ… ä½¿ç”¨ Create æ–¹æ³•åˆ›å»ºç”¨æˆ·æˆåŠŸ: ${user.Name}`);
      } catch (createError) {
        // å¦‚æœ Create å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ Insert æ–¹æ³•ï¼Œå­—æ®µåä½¿ç”¨ PascalCase
        // ä½¿ç”¨è¾…åŠ©å‡½æ•°å¤„ç†ç©ºå­—ç¬¦ä¸²ï¼šç©ºå­—ç¬¦ä¸²å­—æ®µä¸è®¾ç½®ï¼Œè®©æ•°æ®åº“ä½¿ç”¨é»˜è®¤å€¼æˆ– NULL
        console.warn('âš ï¸ Create æ–¹æ³•å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ Insert æ–¹æ³•:', createError);
        const valueBucket: relationalStore.ValuesBucket = {};
        setValueIfNotEmpty(valueBucket, 'Name', user.Name);
        if (user.Age !== undefined) valueBucket.Age = user.Age;
        this.db.Table(TABLE_NAMES.User).Insert(valueBucket);
        console.info(`âœ… ä½¿ç”¨ Insert æ–¹æ³•åˆ›å»ºç”¨æˆ·æˆåŠŸ: ${user.Name}`);
      }
      return user;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ åˆ›å»ºç”¨æˆ·å¤±è´¥:', errorMsg);
      throw new Error(`åˆ›å»ºç”¨æˆ·å¤±è´¥: ${errorMsg}`);
    }
  }

  /**
   * æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ï¼ˆè¿”å›æ•°æ®æ¥å£ UserDataï¼‰
   */
  public getAllUsers(): UserData[] {
    try {
      // ä½¿ç”¨ Table æ–¹æ³•æŸ¥è¯¢ï¼Œæ ¹æ®æ–‡æ¡£åº”è¯¥ä½¿ç”¨è¡¨åå­—ç¬¦ä¸²
      const rawResult = this.db.Table(TABLE_NAMES.User).Find();
      console.info(`ğŸ“‹ æŸ¥è¯¢åˆ° ${rawResult.length} æ¡ç”¨æˆ·æ•°æ®ï¼ˆåŸå§‹ç»“æœï¼‰`);
      
      // è°ƒè¯•ï¼šæ‰“å°ç¬¬ä¸€æ¡è®°å½•çš„åŸå§‹ç»“æ„
      if (rawResult.length > 0) {
        console.info('ğŸ“‹ ç¬¬ä¸€æ¡ç”¨æˆ·è®°å½•çš„åŸå§‹æ•°æ®:', JSON.stringify(rawResult[0]));
        console.info('ğŸ“‹ ç¬¬ä¸€æ¡ç”¨æˆ·è®°å½•çš„é”®:', Object.keys(rawResult[0]));
      }
      
      // ä½¿ç”¨ Record<string, ESObject> ç±»å‹æ¥å¤„ç†å¯èƒ½çš„ä¸åŒå­—æ®µåæ ¼å¼
      type QueryResult = Record<string, ESObject>;
      const result = rawResult as QueryResult[];
      
      // è½¬æ¢å­—æ®µåï¼ˆé€‚é…ä¸åŒçš„å­—æ®µåæ ¼å¼ï¼‰
      const converted = result.map((item: QueryResult) => {
        const getValue = (key: string): ESObject | undefined => {
          return item[key];
        };
        
        const userData: UserData = {
          id: (getValue('id') as number) || undefined,
          Name: (getValue('Name') as string) || 
               (getValue('name') as string) || 
               (getValue('name') as string) || undefined,
          Age: (getValue('Age') as number) || 
              (getValue('age') as number) || undefined,
          created_at: getValue('created_at') as string,
          updated_at: getValue('updated_at') as string
        };
        return userData;
      });
      
      console.info(`ğŸ“‹ è½¬æ¢åçš„ç”¨æˆ·æ•°æ®æ•°é‡: ${converted.length}`);
      return converted;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ æŸ¥è¯¢ç”¨æˆ·å¤±è´¥:', errorMsg);
      throw new Error(`æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: ${errorMsg}`);
    }
  }

  /**
   * æ ¹æ®å¹´é¾„æŸ¥è¯¢ç”¨æˆ·
   * @param age å¹´é¾„
   * @returns ç”¨æˆ·æ•°ç»„
   */
  public getUsersByAge(age: number): UserData[] {
    try {
      // æ ¹æ®æ–‡æ¡£ï¼Œå­—æ®µååœ¨æ•°æ®åº“ä¸­æ˜¯å°å†™çš„
      const rawResult = this.db.Table(TABLE_NAMES.User).Where('age', age).Find();
      type QueryResult = Record<string, ESObject>;
      const result = rawResult as QueryResult[];
      
      // è½¬æ¢å­—æ®µå
      const converted = result.map((item: QueryResult) => {
        const getValue = (key: string): ESObject | undefined => {
          return item[key];
        };
        
        const userData: UserData = {
          id: (getValue('id') as number) || undefined,
          Name: (getValue('name') as string) || undefined,
          Age: (getValue('age') as number) || undefined,
          created_at: getValue('created_at') as string,
          updated_at: getValue('updated_at') as string
        };
        return userData;
      });
      
      console.info(`ğŸ“‹ æŸ¥è¯¢åˆ° ${converted.length} æ¡å¹´é¾„ä¸º ${age} çš„ç”¨æˆ·æ•°æ®`);
      return converted;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ æŸ¥è¯¢ç”¨æˆ·å¤±è´¥:', errorMsg);
      throw new Error(`æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: ${errorMsg}`);
    }
  }

  /**
   * æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·
   * @param id ç”¨æˆ·ID
   * @returns ç”¨æˆ·å¯¹è±¡æˆ–null
   */
  public getUserById(id: number): UserData | null {
    try {
      const rawResult = this.db.Table(TABLE_NAMES.User).Where('id', id).Find();
      type QueryResult = Record<string, ESObject>;
      const result = rawResult as QueryResult[];
      if (result && result.length > 0) {
        const item = result[0];
        const getValue = (key: string): ESObject | undefined => {
          return item[key];
        };
        
        const userData: UserData = {
          id: (getValue('id') as number) || undefined,
          Name: (getValue('name') as string) || undefined,
          Age: (getValue('age') as number) || undefined,
          created_at: getValue('created_at') as string,
          updated_at: getValue('updated_at') as string
        };
        return userData;
      }
      return null;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ æŸ¥è¯¢ç”¨æˆ·å¤±è´¥:', errorMsg);
      throw new Error(`æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: ${errorMsg}`);
    }
  }

  /**
   * æ ¹æ® ID åˆ é™¤ç”¨æˆ·
   */
  public deleteUser(id: number): void {
    try {
      this.db.Table(TABLE_NAMES.User).Where('id', id).Delete();
      console.info(`âœ… åˆ é™¤ç”¨æˆ·æˆåŠŸ: ID=${id}`);
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ åˆ é™¤ç”¨æˆ·å¤±è´¥:', errorMsg);
      throw new Error(`åˆ é™¤ç”¨æˆ·å¤±è´¥: ${errorMsg}`);
    }
  }

  // TestModel ç›¸å…³æ“ä½œ å°è£…

  /**
   * æ–°å¢æµ‹è¯•è®°å½•ï¼ˆä¼ å…¥å®ä½“ï¼‰
   * ä½¿ç”¨å°è£…çš„è½¬æ¢å‡½æ•°ç”Ÿæˆ ValuesBucketï¼Œé¿å…æ‰‹å†™å­—æ®µæ˜ å°„
   */
  public createTestRecord(testRecord: TestModel): TestModel {
    try {
      const valueBucket: relationalStore.ValuesBucket = testModelToValueBucket(testRecord);
      this.db.Table(TABLE_NAMES.TestModel).Insert(valueBucket);
      console.info(`âœ… ä½¿ç”¨ Insert æ–¹æ³•åˆ›å»ºæµ‹è¯•è®°å½•æˆåŠŸ: ${testRecord.Title}`);
      return testRecord;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ åˆ›å»ºæµ‹è¯•è®°å½•å¤±è´¥:', errorMsg);
      throw new Error(`åˆ›å»ºæµ‹è¯•è®°å½•å¤±è´¥: ${errorMsg}`);
    }
  }

  /**
   * ä¾¿æ·æ–°å¢ï¼šä¸€è¡Œåˆ›å»ºç”¨æˆ·
   * å°è£…ä½¿ç”¨ï¼šdbManager.addUser('å¼ ä¸‰', 25)  ç”¨æˆ·è¡¨
   */
  public addUser(name: string, age: number): User {
    const user = new User(name, age);
    return this.createUser(user);
  }

  /**
   * ä¾¿æ·æ–°å¢ï¼šä¸€è¡Œåˆ›å»ºæµ‹è¯•è®°å½•
   * @example dbManager.addTestRecord('æ ‡é¢˜', 'æè¿°', 10, 1)
   */
  public addTestRecord(title: string, description?: string, count?: number, isEnabled?: number): TestModel {
    const test = new TestModel(title, description, count, isEnabled);
    return this.createTestRecord(test);
  }

   /**
    * æ”¯æŒç›´æ¥å°†å·²å®šä¹‰å¥½çš„ ProcessingHistory å®ä¾‹æ’å…¥æ•°æ®åº“ã€‚
    * ä½ å¯ä»¥å…ˆæ„é€ å¥½ ProcessingHistory å¯¹è±¡ï¼Œç„¶åç›´æ¥è°ƒç”¨ insert æ–¹æ³•æ’å…¥ï¼š
    * @example
    * // æ–¹å¼1ï¼šç”¨å‚æ•°å¿«é€Ÿæ–°å¢
    * dbManager.addProcessingHistory(
    *   'å®¢æˆ·A',
    *   'å†œåœºB',
    *   'è‹¹æœ',
    *   'å·²å®Œæˆ',
    *   '2025-11-08 11:40',
    *   '2025-11-11 11:40',
    *   123.5,
    *   100
    * );
    *
    * // æ–¹å¼2ï¼šå…ˆå®šä¹‰å¯¹è±¡ï¼Œå†ä¼ å‚æ’å…¥
    * const history = new ProcessingHistory(
    *   'å®¢æˆ·A',
    *   'å†œåœºB',
    *   'è‹¹æœ',
    *   'å·²å®Œæˆ',
    *   '2025-11-08 11:40',
    *   '2025-11-11 11:40',
    *   123.5,
    *   100
    * );
    * dbManager.createProcessingHistory(history);
    *
    * // æ³¨æ„ï¼šcreateProcessingHistory(history) æ”¯æŒä¼ å…¥å·²å®šä¹‰å¥½çš„å¯¹è±¡ï¼Œç›´æ¥æ’å…¥æ•°æ®åº“ã€‚
    */
  public addProcessingHistory(
    customerName: string,
    farmName: string,
    fruitName: string,
    status: string,
    startTime: string,
    endTime: string | undefined,
    weight: number,
    quantity: number
  ): ProcessingHistory {
    const history = new ProcessingHistory(
      customerName,
      farmName,
      fruitName,
      status,
      startTime,
      endTime,
      weight,
      quantity
    );
    return this.createProcessingHistory(history);
  }

  /**
   * æŸ¥è¯¢æ‰€æœ‰æµ‹è¯•è®°å½•
   */
  public getAllTestRecords(): TestData[] {
    try {
      const rawResult = this.db.Table(TABLE_NAMES.TestModel).Find();
      console.info(`ğŸ“‹ æŸ¥è¯¢åˆ° ${rawResult.length} æ¡æµ‹è¯•è®°å½•æ•°æ®ï¼ˆåŸå§‹ç»“æœï¼‰`);
      
      // è°ƒè¯•ï¼šæ‰“å°ç¬¬ä¸€æ¡è®°å½•çš„åŸå§‹ç»“æ„
      if (rawResult.length > 0) {
        console.info('ğŸ“‹ ç¬¬ä¸€æ¡æµ‹è¯•è®°å½•çš„åŸå§‹æ•°æ®:', JSON.stringify(rawResult[0]));
        console.info('ğŸ“‹ ç¬¬ä¸€æ¡æµ‹è¯•è®°å½•çš„é”®:', Object.keys(rawResult[0]));
      }
      
      type QueryResult = Record<string, ESObject>;
      const result = rawResult as QueryResult[];
      
      const converted = result.map((item: QueryResult) => {
        const getValue = (key: string): ESObject | undefined => {
          return item[key];
        };
        
        const testData: TestData = {
          id: (getValue('id') as number) || undefined,
          Title: (getValue('Title') as string) || 
                (getValue('title') as string) || undefined,
          Description: (getValue('Description') as string) || 
                      (getValue('description') as string) || undefined,
          Count: (getValue('Count') as number) || 
                (getValue('count') as number) || undefined,
          IsEnabled: (getValue('IsEnabled') as number) || 
                    (getValue('isEnabled') as number) || 
                    (getValue('is_enabled') as number) || undefined,
          created_at: getValue('created_at') as string,
          updated_at: getValue('updated_at') as string
        };
        return testData;
      });
      
      console.info(`ğŸ“‹ è½¬æ¢åçš„æµ‹è¯•è®°å½•æ•°é‡: ${converted.length}`);
      return converted;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ æŸ¥è¯¢æµ‹è¯•è®°å½•å¤±è´¥:', errorMsg);
      throw new Error(`æŸ¥è¯¢æµ‹è¯•è®°å½•å¤±è´¥: ${errorMsg}`);
    }
  }

  /**
   * æ ¹æ® ID æŸ¥è¯¢æµ‹è¯•è®°å½•
   */
  public getTestRecordById(id: number): TestData | null {
    try {
      const rawResult = this.db.Table(TABLE_NAMES.TestModel).Where('id', id).Find();
      type QueryResult = Record<string, ESObject>;
      const result = rawResult as QueryResult[];
      if (result && result.length > 0) {
        const item = result[0];
        const getValue = (key: string): ESObject | undefined => {
          return item[key];
        };
        
        const testData: TestData = {
          id: (getValue('id') as number) || undefined,
          Title: (getValue('title') as string) || undefined,
          Description: (getValue('description') as string) || undefined,
          Count: (getValue('count') as number) || undefined,
          IsEnabled: (getValue('is_enabled') as number) || undefined,
          created_at: getValue('created_at') as string,
          updated_at: getValue('updated_at') as string
        };
        return testData;
      }
      return null;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ æŸ¥è¯¢æµ‹è¯•è®°å½•å¤±è´¥:', errorMsg);
      throw new Error(`æŸ¥è¯¢æµ‹è¯•è®°å½•å¤±è´¥: ${errorMsg}`);
    }
  }

  /**
   * æ ¹æ® ID åˆ é™¤æµ‹è¯•è®°å½•
   */
  public deleteTestRecord(id: number): void {
    try {
      this.db.Table(TABLE_NAMES.TestModel).Where('id', id).Delete();
      console.info(`âœ… åˆ é™¤æµ‹è¯•è®°å½•æˆåŠŸ: ID=${id}`);
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ åˆ é™¤æµ‹è¯•è®°å½•å¤±è´¥:', errorMsg);
      throw new Error(`åˆ é™¤æµ‹è¯•è®°å½•å¤±è´¥: ${errorMsg}`);
    }
  }


  /**
   * æ–°å¢å†å²åŠ å·¥è®°å½•ï¼ˆä¼ å…¥å®ä½“ï¼‰
   */
  public createProcessingHistory(historyRecord: ProcessingHistory): ProcessingHistory {
    try {
      // ä½¿ç”¨å°è£…çš„å‡½æ•°å°†å®ä½“å¯¹è±¡è½¬æ¢ä¸º ValuesBucket
      const valueBucket = processingHistoryToValueBucket(historyRecord);
      
      this.db.Table(TABLE_NAMES.ProcessingHistory).Insert(valueBucket);
      console.info(`âœ… åˆ›å»ºå†å²åŠ å·¥è®°å½•æˆåŠŸ: ${historyRecord.CustomerName} - ${historyRecord.FruitName}`);
      return historyRecord;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ åˆ›å»ºå†å²åŠ å·¥è®°å½•å¤±è´¥:', errorMsg);
      throw new Error(`åˆ›å»ºå†å²åŠ å·¥è®°å½•å¤±è´¥: ${errorMsg}`);
    }
  }

  /**
   * æŸ¥è¯¢æ‰€æœ‰å†å²åŠ å·¥è®°å½•
   */
  public getAllProcessingHistory(): ProcessingHistoryData[] {
    try {
      const rawResult = this.db.Table(TABLE_NAMES.ProcessingHistory).Find();
      console.info(`ğŸ“‹ æŸ¥è¯¢åˆ° ${rawResult.length} æ¡å†å²åŠ å·¥è®°å½•ï¼ˆåŸå§‹ç»“æœï¼‰`);
      
      type QueryResult = Record<string, ESObject>;
      const result = rawResult as QueryResult[];
      
      // ä½¿ç”¨å°è£…çš„è½¬æ¢å‡½æ•°
      const converted = result.map((item: QueryResult) => {
        return convertToProcessingHistoryData(item);
      });
      
      console.info(`ğŸ“‹ è½¬æ¢åçš„å†å²åŠ å·¥è®°å½•æ•°é‡: ${converted.length}`);
      return converted;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ æŸ¥è¯¢å†å²åŠ å·¥è®°å½•å¤±è´¥:', errorMsg);
      throw new Error(`æŸ¥è¯¢å†å²åŠ å·¥è®°å½•å¤±è´¥: ${errorMsg}`);
    }
  }

  /**
   * æ ¹æ® ID æŸ¥è¯¢å†å²åŠ å·¥è®°å½•
   */
  public getProcessingHistoryById(id: number): ProcessingHistoryData | null {
    try {
      const rawResult = this.db.Table(TABLE_NAMES.ProcessingHistory).Where('id', id).Find();
      type QueryResult = Record<string, ESObject>;
      const result = rawResult as QueryResult[];
      if (result && result.length > 0) {
        const item = result[0];
        const getValue = (key: string): ESObject | undefined => {
          return item[key];
        };
        
        // ä½¿ç”¨å°è£…çš„è½¬æ¢å‡½æ•°
        return convertToProcessingHistoryData(item);
      }
      return null;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ æŸ¥è¯¢å†å²åŠ å·¥è®°å½•å¤±è´¥:', errorMsg);
      throw new Error(`æŸ¥è¯¢å†å²åŠ å·¥è®°å½•å¤±è´¥: ${errorMsg}`);
    }
  }

  /**
   * æ ¹æ® ID æ›´æ–°å†å²åŠ å·¥è®°å½•ï¼ˆä¼ å…¥æ›´æ–°åçš„å®ä½“ï¼‰
   */
  public updateProcessingHistory(id: number, historyRecord: ProcessingHistory): void {
    try {
      // ä½¿ç”¨å°è£…çš„å‡½æ•°å°†å®ä½“å¯¹è±¡è½¬æ¢ä¸º ValuesBucket
      const valueBucket = processingHistoryToValueBucket(historyRecord);
      
      this.db.Table(TABLE_NAMES.ProcessingHistory).Where('id', id).Update(valueBucket);
      console.info(`âœ… æ›´æ–°å†å²åŠ å·¥è®°å½•æˆåŠŸ: ID=${id}`);
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ æ›´æ–°å†å²åŠ å·¥è®°å½•å¤±è´¥:', errorMsg);
      throw new Error(`æ›´æ–°å†å²åŠ å·¥è®°å½•å¤±è´¥: ${errorMsg}`);
    }
  }

  /**
   * æ ¹æ® ID åˆ é™¤å†å²åŠ å·¥è®°å½•
   */
  public deleteProcessingHistory(id: number): void {
    try {
      this.db.Table(TABLE_NAMES.ProcessingHistory).Where('id', id).Delete();
      console.info(`âœ… åˆ é™¤å†å²åŠ å·¥è®°å½•æˆåŠŸ: ID=${id}`);
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ åˆ é™¤å†å²åŠ å·¥è®°å½•å¤±è´¥:', errorMsg);
      throw new Error(`åˆ é™¤å†å²åŠ å·¥è®°å½•å¤±è´¥: ${errorMsg}`);
    }
  }

  // äº‹åŠ¡ç›¸å…³æ“ä½œ å°è£…

  /** å¼€å§‹äº‹åŠ¡ */
  public beginTransaction(): void {
    try {
      this.db.Begin();
      console.info('âœ… äº‹åŠ¡å·²å¼€å§‹');
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ å¼€å§‹äº‹åŠ¡å¤±è´¥:', errorMsg);
      throw new Error(`å¼€å§‹äº‹åŠ¡å¤±è´¥: ${errorMsg}`);
    }
  }

  /** æäº¤äº‹åŠ¡ */
  public commitTransaction(): void {
    try {
      this.db.Commit();
      console.info('âœ… äº‹åŠ¡å·²æäº¤');
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ æäº¤äº‹åŠ¡å¤±è´¥:', errorMsg);
      throw new Error(`æäº¤äº‹åŠ¡å¤±è´¥: ${errorMsg}`);
    }
  }

  /** å›æ»šäº‹åŠ¡ */
  public rollbackTransaction(): void {
    try {
      this.db.Rollback();
      console.info('âœ… äº‹åŠ¡å·²å›æ»š');
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ å›æ»šäº‹åŠ¡å¤±è´¥:', errorMsg);
      throw new Error(`å›æ»šäº‹åŠ¡å¤±è´¥: ${errorMsg}`);
    }
  }

  /** è·å– ORM æœ€è¿‘ä¸€æ¬¡é”™è¯¯ä¿¡æ¯ï¼ˆè‹¥æœ‰ï¼‰ */
  public getError(): string | null {
    const error = this.db.GetError();
    return error ? String(error) : null;
  }

  /**
   * äº‹åŠ¡åŒ…è£…å™¨ï¼šå°†ä¸€ç»„æ“ä½œåŒ…è£¹åœ¨ Begin/Commit ä¹‹é—´ï¼ˆå¤±è´¥è‡ªåŠ¨å›æ»šï¼‰
   */
  public async executeInTransaction(operations: () => void | Promise<void>): Promise<boolean> {
    try {
      // å¼€å§‹äº‹åŠ¡
      this.beginTransaction();
      
      // æ‰§è¡Œæ“ä½œ
      await operations();
      
      // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
      const error = this.getError();
      if (error) {
        console.warn('âš ï¸ äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œå‡†å¤‡å›æ»š:', error);
        this.rollbackTransaction();
        return false;
      }
      
      // æäº¤äº‹åŠ¡
      this.commitTransaction();
      return true;
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : String(error);
      console.error('âŒ äº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œå‡†å¤‡å›æ»š:', errorMsg);
      try {
        this.rollbackTransaction();
      } catch (rollbackError) {
        console.error('âŒ å›æ»šäº‹åŠ¡ä¹Ÿå¤±è´¥:', rollbackError);
      }
      return false;
    }
  }
}
