,k# 空字符串处理说明

## 📖 问题说明

当创建新表或插入数据时，如果某些字段是**空字符串**，数据库应该如何处理？

## 🎯 问题场景

### 场景1：创建新记录时字段为空字符串

```typescript
// 创建历史加工记录，但某些字段是空字符串
const history = new ProcessingHistory(
  "客户A",        // ✅ 有值
  "",            // ❌ 空字符串
  "苹果",        // ✅ 有值
  "",            // ❌ 空字符串
  "2025-11-11",  // ✅ 有值
  "",            // ❌ 空字符串
  1500.5,        // ✅ 有值
  100            // ✅ 有值
);
```

**问题**：空字符串应该如何处理？
- 选项1：插入空字符串 `""` 到数据库
- 选项2：不插入该字段，让数据库使用默认值或 `NULL`

### 场景2：更新记录时字段为空字符串

```typescript
// 更新记录，将某个字段清空
const history = new ProcessingHistory(...);
history.FarmName = "";  // 想要清空农场名称
```

**问题**：是设置为空字符串，还是设置为 `NULL`？

## ✅ 解决方案

### 方案：空字符串不插入字段

**原则**：如果字段是空字符串，**不设置该字段**，让数据库使用默认值或 `NULL`。

**好处**：
1. 数据库更规范（NULL 比空字符串更语义化）
2. 查询更方便（可以用 `IS NULL` 判断）
3. 节省存储空间

### 实现方式

使用 `ValueBucketHelper` 工具函数：

```typescript
import { setValueIfNotEmpty } from './utils/ValueBucketHelper';

const valueBucket: relationalStore.ValuesBucket = {};

// 如果字段是空字符串，不设置该字段
setValueIfNotEmpty(valueBucket, 'customer_name', historyRecord.CustomerName);
setValueIfNotEmpty(valueBucket, 'farm_name', historyRecord.FarmName);

// 如果 CustomerName 是 ""，则 valueBucket 中不会有 customer_name 字段
// 数据库会使用默认值或 NULL
```

## 📊 处理规则

### 规则1：字符串字段

| 值 | 处理方式 | 结果 |
|---|---|---|
| `undefined` | 不设置字段 | 数据库使用默认值或 NULL |
| `null` | 不设置字段 | 数据库使用默认值或 NULL |
| `""` (空字符串) | 不设置字段 | 数据库使用默认值或 NULL |
| `"   "` (只有空格) | 不设置字段 | 数据库使用默认值或 NULL |
| `"有值"` | 设置字段 | 正常插入 |

### 规则2：数字字段

| 值 | 处理方式 | 结果 |
|---|---|---|
| `undefined` | 不设置字段 | 数据库使用默认值或 NULL |
| `null` | 不设置字段 | 数据库使用默认值或 NULL |
| `0` | 设置字段 | 正常插入（0 是有效值） |
| `123` | 设置字段 | 正常插入 |

### 规则3：特殊字段（如 end_time）

某些字段可能需要允许空字符串（比如"进行中"的任务，结束时间为空）：

```typescript
// 使用 setValueWithDefault，允许空字符串
setValueWithDefault(valueBucket, 'end_time', historyRecord.EndTime, '');
```

## 🔧 工具函数说明

### `setValueIfNotEmpty()`

**作用**：只有当值不为空时才设置字段

```typescript
setValueIfNotEmpty(valueBucket, 'customer_name', "客户A");  // ✅ 设置
setValueIfNotEmpty(valueBucket, 'customer_name', "");      // ❌ 不设置
setValueIfNotEmpty(valueBucket, 'customer_name', undefined); // ❌ 不设置
```

### `setValueWithDefault()`

**作用**：设置值，如果值为 undefined 则使用默认值

```typescript
// 允许空字符串，但如果未定义则使用默认值
setValueWithDefault(valueBucket, 'end_time', "", '');  // ✅ 设置为 ""
setValueWithDefault(valueBucket, 'end_time', undefined, '');  // ✅ 设置为 ""
```

### `cleanEmptyStrings()`

**作用**：清理 ValuesBucket 中已有的空字符串字段

```typescript
const valueBucket: relationalStore.ValuesBucket = {
  customer_name: "客户A",
  farm_name: "",  // 空字符串
  fruit_name: "苹果"
};

cleanEmptyStrings(valueBucket);
// 结果：{ customer_name: "客户A", fruit_name: "苹果" }
// farm_name 被移除了
```

## 💡 实际应用

### 示例：创建历史加工记录

**之前（可能有问题）**：
```typescript
const valueBucket: relationalStore.ValuesBucket = {};
valueBucket.customer_name = historyRecord.CustomerName || "";  // ❌ 空字符串也会插入
valueBucket.farm_name = historyRecord.FarmName || "";          // ❌ 空字符串也会插入
```

**现在（正确处理）**：
```typescript
import { setValueIfNotEmpty } from './utils/ValueBucketHelper';

const valueBucket: relationalStore.ValuesBucket = {};
setValueIfNotEmpty(valueBucket, 'customer_name', historyRecord.CustomerName);  // ✅ 空字符串不插入
setValueIfNotEmpty(valueBucket, 'farm_name', historyRecord.FarmName);          // ✅ 空字符串不插入
```

## 📝 总结

- 创建新表或插入数据时，如果字段是空字符串，**不应该插入该字段**
- 让数据库使用默认值或 `NULL`，而不是插入空字符串 `""`

**解决方案**：
- 使用 `setValueIfNotEmpty()` 函数
- 空字符串字段不设置，让数据库处理
- 特殊字段可以使用 `setValueWithDefault()` 允许空字符串

**好处**：
- ✅ 数据更规范
- ✅ 查询更方便
- ✅ 节省存储空间

