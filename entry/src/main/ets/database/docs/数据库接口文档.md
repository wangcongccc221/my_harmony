# DatabaseManager 数据库接口文档

## 概述

`DatabaseManager` 是一个单例类，封装了所有数据库操作，提供统一的接口。使用 IBest-ORM 框架进行数据库操作。

### 获取实例

```typescript
const dbManager = DatabaseManager.getInstance();
```

---

## 初始化

### `initDatabase(): Promise<void>`

初始化数据库，自动创建或迁移表结构。

**说明**：
- 应在应用启动阶段调用一次，在生命周期时init一次
- 会自动创建 User、TestModel、ProcessingHistory 三张表
- 如果表已存在，会自动对齐表结构

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
await dbManager.initDatabase();
```

---

## User 用户相关接口

### `addUser(name: string, age: number): User`

便捷方法：一行创建用户。

**参数**：
- `name: string` - 用户姓名
- `age: number` - 用户年龄

**返回值**：`User` - 创建的用户对象

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const user = dbManager.addUser('张三', 25);
```

### `createUser(user: User): User`

创建用户（传入实体对象）。

**参数**：
- `user: User` - 用户实体对象

**返回值**：`User` - 创建的用户对象

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const user = new User('李四', 30);
const createdUser = dbManager.createUser(user);
```

### `getAllUsers(): UserData[]`

查询所有用户。

**返回值**：`UserData[]` - 用户数据数组

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const users = dbManager.getAllUsers();
console.log(`共有 ${users.length} 个用户`);
```

### `getUsersByAge(age: number): UserData[]`

根据年龄查询用户。

**参数**：
- `age: number` - 年龄

**返回值**：`UserData[]` - 用户数据数组

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const users = dbManager.getUsersByAge(25);
```

### `getUserById(id: number): UserData | null`

根据ID查询用户。

**参数**：
- `id: number` - 用户ID

**返回值**：`UserData | null` - 用户数据对象，如果不存在返回 null

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const user = dbManager.getUserById(1);
if (user) {
  console.log(`用户姓名: ${user.Name}`);
}
```

### `deleteUser(id: number): void`

根据ID删除用户。

**参数**：
- `id: number` - 用户ID

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
dbManager.deleteUser(1);
```

---

## TestModel 测试记录相关接口

### `addTestRecord(title: string, description?: string, count?: number, isEnabled?: number): TestModel`

便捷方法：一行创建测试记录。

**参数**：
- `title: string` - 标题（必填）
- `description?: string` - 描述（可选）
- `count?: number` - 数量（可选）
- `isEnabled?: number` - 是否启用（可选，1表示启用，0表示禁用）

**返回值**：`TestModel` - 创建的测试记录对象

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const test = dbManager.addTestRecord('测试标题', '这是描述', 10, 1);
```

### `createTestRecord(testRecord: TestModel): TestModel`

创建测试记录（传入实体对象）。

**参数**：
- `testRecord: TestModel` - 测试记录实体对象

**返回值**：`TestModel` - 创建的测试记录对象

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const test = new TestModel('标题', '描述', 10, 1);
const createdTest = dbManager.createTestRecord(test);
```

### `getAllTestRecords(): TestData[]`

查询所有测试记录。

**返回值**：`TestData[]` - 测试记录数据数组

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const tests = dbManager.getAllTestRecords();
```

### `getTestRecordById(id: number): TestData | null`

根据ID查询测试记录。

**参数**：
- `id: number` - 测试记录ID

**返回值**：`TestData | null` - 测试记录数据对象，如果不存在返回 null

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const test = dbManager.getTestRecordById(1);
```

### `deleteTestRecord(id: number): void`

根据ID删除测试记录。

**参数**：
- `id: number` - 测试记录ID

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
dbManager.deleteTestRecord(1);
```

---

## ProcessingHistory 历史加工记录相关接口

### `addProcessingHistory(customerName: string, farmName: string, fruitName: string, status: string, startTime: string, endTime: string | undefined, weight: number, quantity: number): ProcessingHistory`

便捷方法：一行创建历史加工记录。

**参数**：
- `customerName: string` - 客户名称
- `farmName: string` - 农场名称
- `fruitName: string` - 水果名称
- `status: string` - 状态（如：'进行中'、'已完成'）
- `startTime: string` - 开始时间（格式：'YYYY-MM-DD HH:mm:ss'）
- `endTime: string | undefined` - 结束时间（可选，未完成的任务可以不传）
- `weight: number` - 重量
- `quantity: number` - 数量

**返回值**：`ProcessingHistory` - 创建的历史加工记录对象

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const history = dbManager.addProcessingHistory(
  '客户A',
  '农场B',
  '苹果',
  '已完成',
  '2025-11-08 11:40:00',
  '2025-11-11 11:40:00',
  123.5,
  100
);
```

### `createProcessingHistory(historyRecord: ProcessingHistory): ProcessingHistory`

创建历史加工记录（传入实体对象）。

**参数**：
- `historyRecord: ProcessingHistory` - 历史加工记录实体对象

**返回值**：`ProcessingHistory` - 创建的历史加工记录对象

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const history = new ProcessingHistory(
  '客户A',
  '农场B',
  '苹果',
  '已完成',
  '2025-11-08 11:40:00',
  '2025-11-11 11:40:00',
  123.5,
  100
);
const createdHistory = dbManager.createProcessingHistory(history);
```

### `getAllProcessingHistory(): ProcessingHistoryData[]`

查询所有历史加工记录。

**返回值**：`ProcessingHistoryData[]` - 历史加工记录数据数组

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const histories = dbManager.getAllProcessingHistory();
console.log(`共有 ${histories.length} 条历史记录`);
```

### `getProcessingHistoryById(id: number): ProcessingHistoryData | null`

根据ID查询历史加工记录。

**参数**：
- `id: number` - 历史加工记录ID

**返回值**：`ProcessingHistoryData | null` - 历史加工记录数据对象，如果不存在返回 null

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const history = dbManager.getProcessingHistoryById(1);
if (history) {
  console.log(`客户: ${history.CustomerName}, 水果: ${history.FruitName}`);
}
```

### `updateProcessingHistory(id: number, historyRecord: ProcessingHistory): void`

根据ID更新历史加工记录。

**参数**：
- `id: number` - 历史加工记录ID
- `historyRecord: ProcessingHistory` - 更新后的历史加工记录实体对象

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const history = new ProcessingHistory(
  '客户A',
  '农场B',
  '苹果',
  '已完成',
  '2025-11-08 11:40:00',
  '2025-11-11 11:40:00',
  150.0,  // 更新重量
  120     // 更新数量
);
dbManager.updateProcessingHistory(1, history);
```

### `deleteProcessingHistory(id: number): void`

根据ID删除历史加工记录。

**参数**：
- `id: number` - 历史加工记录ID

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
dbManager.deleteProcessingHistory(1);
```

---

## 事务相关接口

### `beginTransaction(): void`

开始事务。

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
dbManager.beginTransaction();
```

### `commitTransaction(): void`

提交事务。

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
dbManager.commitTransaction();
```

### `rollbackTransaction(): void`

回滚事务。

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
dbManager.rollbackTransaction();
```

### `executeInTransaction(operations: () => void | Promise<void>): Promise<boolean>`

事务包装器：将一组操作包裹在事务中（失败自动回滚）。

**参数**：
- `operations: () => void | Promise<void>` - 要执行的操作函数

**返回值**：`Promise<boolean>` - 成功返回 true，失败返回 false

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
const success = await dbManager.executeInTransaction(async () => {
  // 执行一系列数据库操作
  dbManager.addUser('用户1', 20);
  dbManager.addUser('用户2', 25);
  // 如果任何操作失败，会自动回滚
});
if (success) {
  console.log('事务执行成功');
} else {
  console.log('事务执行失败，已回滚');
}
```

### `getError(): string | null`

获取 ORM 最近一次错误信息（若有）。

**返回值**：`string | null` - 错误信息，如果没有错误返回 null

**使用示例**：
```typescript
const dbManager = DatabaseManager.getInstance();
dbManager.addUser('测试', 20);
const error = dbManager.getError();
if (error) {
  console.error('数据库操作出错:', error);
}
```

---

## 错误处理

所有方法在失败时都会抛出 `Error` 异常，建议使用 try-catch 进行错误处理：

```typescript
const dbManager = DatabaseManager.getInstance();
try {
  const user = dbManager.addUser('张三', 25);
  console.log('创建成功:', user);
} catch (error) {
  console.error('创建失败:', error);
}
```

---

## 数据模型

### UserData 接口

```typescript
interface UserData {
  id?: number;
  Name?: string;
  Age?: number;
  created_at?: string;
  updated_at?: string;
}
```

### TestData 接口

```typescript
interface TestData {
  id?: number;
  Title?: string;
  Description?: string;
  Count?: number;
  IsEnabled?: number;
  created_at?: string;
  updated_at?: string;
}
```

### ProcessingHistoryData 接口

```typescript
interface ProcessingHistoryData {
  id?: number;
  CustomerName?: string;
  FarmName?: string;
  FruitName?: string;
  Status?: string;
  StartTime?: string;
  EndTime?: string;
  Weight?: number;
  Quantity?: number;
  created_at?: string;
  updated_at?: string;
}
```

---

## 注意事项

1. **单例模式**：`DatabaseManager` 使用单例模式，全局只有一个实例
2. **初始化**：使用前必须先调用 `initDatabase()` 初始化数据库
3. **字段名转换**：查询结果会自动转换字段名（支持 PascalCase 和 snake_case）
4. **空字符串处理**：空字符串字段不会设置到数据库，使用默认值或 NULL
5. **事务**：使用事务时，如果任何操作失败，记得调用 `rollbackTransaction()` 回滚

---

## 完整示例

```typescript
// 1. 初始化数据库
const dbManager = DatabaseManager.getInstance();
await dbManager.initDatabase();

// 2. 创建用户
const user = dbManager.addUser('张三', 25);

// 3. 查询所有用户
const users = dbManager.getAllUsers();
console.log(`共有 ${users.length} 个用户`);

// 4. 根据ID查询
const foundUser = dbManager.getUserById(1);
if (foundUser) {
  console.log(`用户姓名: ${foundUser.Name}`);
}

// 5. 使用事务
const success = await dbManager.executeInTransaction(async () => {
  dbManager.addUser('用户1', 20);
  dbManager.addUser('用户2', 25);
});
```

