# 数据库事务说明

## 📖 什么是事务？

**事务（Transaction）** 是一系列数据库操作的集合，这些操作要么**全部成功**，要么**全部失败**，不会出现部分成功的情况。

## 🎯 事务的作用

### 1. **保证数据一致性**
确保相关数据要么全部保存成功，要么全部不保存，避免数据不一致的情况。

### 2. **原子性（Atomicity）**
所有操作作为一个整体执行，不可分割。要么全部执行，要么全部不执行。

### 3. **错误回滚**
如果任何一步操作失败，之前的所有操作都会自动撤销，恢复到操作前的状态。

## 💡 实际应用场景

### 场景1：银行转账（经典例子）

**问题**：从账户A转100元到账户B

**没有事务的情况**：
```typescript
// 步骤1：从账户A扣100元
账户A余额 = 账户A余额 - 100;  // ✅ 成功

// 步骤2：给账户B加100元
账户B余额 = 账户B余额 + 100;  // ❌ 失败（比如数据库崩溃）
```

**结果**：账户A的钱被扣了，但账户B没收到钱！💰 丢失了！

**使用事务的情况**：
```typescript
beginTransaction();  // 开始事务

账户A余额 = 账户A余额 - 100;  // ✅ 成功
账户B余额 = 账户B余额 + 100;  // ❌ 失败

rollbackTransaction();  // 自动回滚，账户A的钱也恢复了
```

**结果**：要么转账成功，要么什么都不变，不会丢钱！

---

### 场景2：创建用户和权限（你的项目）

**问题**：创建用户时，需要同时创建用户表和权限表

**没有事务的情况**：
```typescript
// 步骤1：创建用户
createUser("张三");  // ✅ 成功，用户表有记录了

// 步骤2：创建权限
createPermission(userId, "admin");  // ❌ 失败（比如权限表不存在）
```

**结果**：用户创建了，但没有权限！用户无法登录系统！😱

**使用事务的情况**：
```typescript
executeInTransaction(async () => {
  createUser("张三");        // ✅ 成功
  createPermission(userId, "admin");  // ❌ 失败
  // 自动回滚，用户也被删除了
});
```

**结果**：要么用户和权限都创建成功，要么都不创建，保证数据一致！

---

### 场景3：订单和库存（电商系统）

**问题**：用户下单时，需要同时：
1. 创建订单记录
2. 减少商品库存
3. 扣除用户余额

**没有事务的情况**：
```typescript
创建订单();      // ✅ 成功
减少库存();      // ✅ 成功
扣除余额();      // ❌ 失败（余额不足）
```

**结果**：订单创建了，库存减少了，但钱没扣！商家亏了！💸

**使用事务的情况**：
```typescript
executeInTransaction(async () => {
  创建订单();    // ✅
  减少库存();    // ✅
  扣除余额();    // ❌ 失败
  // 自动回滚，订单和库存都恢复了
});
```

**结果**：要么全部成功，要么全部回滚，保证数据一致！

---

### 场景4：历史加工数据（你的项目）

**问题**：保存历史加工记录时，需要同时：
1. 插入历史加工表
2. 更新统计数据表
3. 更新客户信息表

**没有事务的情况**：
```typescript
插入历史加工记录();  // ✅ 成功
更新统计数据();      // ✅ 成功
更新客户信息();      // ❌ 失败
```

**结果**：历史记录有了，统计数据更新了，但客户信息没更新！数据不一致！

**使用事务的情况**：
```typescript
executeInTransaction(async () => {
  插入历史加工记录();  // ✅
  更新统计数据();      // ✅
  更新客户信息();      // ❌ 失败
  // 自动回滚，所有操作都撤销
});
```

**结果**：要么全部成功，要么全部回滚，保证数据一致！

---

## 🔍 什么时候需要使用事务？

### ✅ 需要使用事务的情况：

1. **多个表同时操作**
   - 创建用户 + 创建权限
   - 创建订单 + 减少库存 + 扣除余额

2. **数据有依赖关系**
   - 主表和子表（订单和订单详情）
   - 用户和用户配置

3. **需要保证数据一致性**
   - 转账操作
   - 库存操作
   - 积分操作

4. **批量操作**
   - 批量删除多个表的数据
   - 批量更新多个表的数据

### ❌ 不需要使用事务的情况：

1. **单个表的简单操作**
   ```typescript
   // 只查询一条数据，不需要事务
   const user = dbManager.getUserById(1);
   ```

2. **独立的操作**
   ```typescript
   // 只是查询，不修改数据，不需要事务
   const users = dbManager.getAllUsers();
   ```

3. **没有关联的操作**
   ```typescript
   // 两个操作互不影响，不需要事务
   createUser("张三");
   createHistory("记录1");  // 这两个操作互不影响
   ```

---

## 📊 事务的四个特性（ACID）

### 1. **原子性（Atomicity）**
- 事务中的所有操作要么全部成功，要么全部失败
- 不会出现部分成功的情况

### 2. **一致性（Consistency）**
- 事务执行前后，数据库的状态保持一致
- 不会出现数据不一致的情况

### 3. **隔离性（Isolation）**
- 多个事务同时执行时，互不干扰
- 每个事务看到的数据是一致的

### 4. **持久性（Durability）**
- 事务提交后，数据永久保存
- 即使系统崩溃，数据也不会丢失

---

## 🎬 实际代码示例

### 示例：创建用户和权限（推荐使用自动事务）

```typescript
const dbManager = DatabaseManager.getInstance();

const success = await dbManager.executeInTransaction(async () => {
  // 步骤1：创建用户
  const user = new User("管理员", 30);
  dbManager.createUser(user);
  
  // 步骤2：创建权限（假设有权限表）
  // const permission = new Permission(user.ID, "admin");
  // dbManager.createPermission(permission);
  
  // 如果任何一步失败，整个事务都会回滚
  // 如果所有步骤成功，事务会自动提交
});

if (success) {
  console.info('✅ 用户和权限创建成功');
} else {
  console.error('❌ 创建失败，已回滚，确保数据一致性');
}
```

---

## 💡 总结

**事务的核心作用**：
1. **保证数据一致性** - 相关数据要么全部成功，要么全部失败
2. **防止数据丢失** - 操作失败时自动回滚，不会留下"半成品"数据
3. **简化错误处理** - 不需要手动检查每一步，自动处理回滚

**使用原则**：
- ✅ 多个表有关联操作 → 使用事务
- ✅ 需要保证数据一致性 → 使用事务
- ❌ 单个表的简单操作 → 不需要事务
- ❌ 只是查询操作 → 不需要事务

**推荐使用** `executeInTransaction()` 方法，自动处理开始、提交、回滚，更安全、更简单！

