# æ•°æ®åº“æ¥å£æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†æ•°æ®åº“æŠ½è±¡å±‚çš„æ‰€æœ‰æ¥å£ï¼ŒåŒ…æ‹¬ `DatabaseHelper` æä¾›çš„ä¸šåŠ¡æ¥å£å’Œ `IDatabaseAdapter` é€‚é…å™¨æ¥å£ã€‚é€šè¿‡ç»Ÿä¸€çš„æ¥å£è®¾è®¡ï¼Œå®ç°äº†æ•°æ®åº“æ“ä½œçš„è§£è€¦ï¼Œæ”¯æŒ SQLiteï¼ˆå½“å‰ï¼‰å’Œæœªæ¥æ‰©å±• MySQLã€PostgreSQL ç­‰ã€‚

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### è®¾è®¡æ¨¡å¼

- **é€‚é…å™¨æ¨¡å¼ï¼ˆAdapter Patternï¼‰**ï¼šé€šè¿‡ `IDatabaseAdapter` æ¥å£æŠ½è±¡æ•°æ®åº“æ“ä½œ
- **å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰**ï¼šé€šè¿‡ `DatabaseAdapterFactory` ç®¡ç†é€‚é…å™¨å®ä¾‹
- **å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰**ï¼šç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªé€‚é…å™¨å®ä¾‹

### æ¶æ„å±‚æ¬¡

```
ä¸šåŠ¡å±‚ï¼ˆBusiness Layerï¼‰
    â†“
DatabaseHelperï¼ˆç»Ÿä¸€å…¥å£ï¼‰
    â†“
DatabaseAdapterFactoryï¼ˆå·¥å‚ï¼‰
    â†“
IDatabaseAdapterï¼ˆæ¥å£ï¼‰
    â†“
SQLiteAdapter / MySQLAdapterï¼ˆå®ç°ï¼‰
    â†“
æ•°æ®åº“ï¼ˆSQLite / MySQL / ...ï¼‰
```

### æ ¸å¿ƒä¼˜åŠ¿

1. **è§£è€¦**ï¼šä¸šåŠ¡ä»£ç ä¸ç›´æ¥ä¾èµ–å…·ä½“æ•°æ®åº“å®ç°
2. **å¯æ‰©å±•**ï¼šè½»æ¾åˆ‡æ¢æ•°æ®åº“ï¼Œåªéœ€å®ç° `IDatabaseAdapter` æ¥å£
3. **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰æ•°æ®åº“æ“ä½œä½¿ç”¨ç›¸åŒçš„ API
4. **ç±»å‹å®‰å…¨**ï¼šæ”¯æŒ TypeScript æ³›å‹ï¼Œæä¾›å®Œæ•´çš„ç±»å‹æ¨æ–­

---

## ğŸ“š DatabaseHelper æ¥å£æ–‡æ¡£

`DatabaseHelper` æ˜¯ä¸šåŠ¡å±‚çš„ä¸»è¦å…¥å£ï¼Œæä¾›æ‰€æœ‰æ•°æ®åº“æ“ä½œçš„é™æ€æ–¹æ³•ã€‚

### å¯¼å…¥æ–¹å¼

```typescript
import { DatabaseHelper } from './database';
```

---

### 1. queryAll - æŸ¥è¯¢æ‰€æœ‰è®°å½•

**åŠŸèƒ½ï¼š** æŸ¥è¯¢æŒ‡å®šè¡¨çš„æ‰€æœ‰è®°å½•

**æ–¹æ³•ç­¾åï¼š**
```typescript
static async queryAll<T extends ESObject = ESObject>(
  ctx: Context,
  tableName: string,
  modelClass?: Class
): Promise<T[]>
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `ctx` | `Context` | æ˜¯ | åº”ç”¨ä¸Šä¸‹æ–‡ï¼ˆä» UIAbility è·å–ï¼‰ |
| `tableName` | `string` | æ˜¯ | è¡¨å |
| `modelClass` | `Class` | å¦ | å®ä½“ç±»ï¼ˆç”¨äºç±»å‹è½¬æ¢ï¼ŒORM æ¨¡å‹ï¼‰ |

**è¿”å›å€¼ï¼š**
- `Promise<T[]>`ï¼šæŸ¥è¯¢ç»“æœæ•°ç»„

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
import { Context } from '@kit.AbilityKit';
import { DatabaseHelper } from './database';
import { ProcessingHistory } from './models/ProcessingHistory';

// æ–¹å¼1ï¼šæŸ¥è¯¢æ‰€æœ‰è®°å½•ï¼ˆè¿”å›æ™®é€šå¯¹è±¡æ•°ç»„ï¼‰
const allData = await DatabaseHelper.queryAll(ctx, 'processing_history');

// æ–¹å¼2ï¼šä½¿ç”¨æ¨¡å‹ç±»ï¼ˆè¿”å›æ¨¡å‹å®ä¾‹æ•°ç»„ï¼‰
const historyList = await DatabaseHelper.queryAll<ProcessingHistory>(
  ctx,
  'processing_history',
  ProcessingHistory
);

// æ–¹å¼3ï¼šæŒ‡å®šè¿”å›ç±»å‹
interface UserData {
  id: number;
  name: string;
  email: string;
}
const users = await DatabaseHelper.queryAll<UserData>(ctx, 'users');
```

**æ³¨æ„äº‹é¡¹ï¼š**
- å¦‚æœè¡¨æ•°æ®é‡å¾ˆå¤§ï¼Œå»ºè®®ä½¿ç”¨ `queryPage` åˆ†é¡µæŸ¥è¯¢
- é¦–æ¬¡è°ƒç”¨ä¼šè‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“è¿æ¥

---

### 2. queryPage - åˆ†é¡µæŸ¥è¯¢

**åŠŸèƒ½ï¼š** åˆ†é¡µæŸ¥è¯¢æŒ‡å®šè¡¨çš„è®°å½•

**æ–¹æ³•ç­¾åï¼š**
```typescript
static async queryPage<T extends ESObject = ESObject>(
  ctx: Context,
  tableName: string,
  page: number,
  size: number,
  modelClass?: Class
): Promise<T[]>
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `ctx` | `Context` | æ˜¯ | åº”ç”¨ä¸Šä¸‹æ–‡ |
| `tableName` | `string` | æ˜¯ | è¡¨å |
| `page` | `number` | æ˜¯ | é¡µç ï¼ˆä» 1 å¼€å§‹ï¼‰ |
| `size` | `number` | æ˜¯ | æ¯é¡µå¤§å° |
| `modelClass` | `Class` | å¦ | å®ä½“ç±»ï¼ˆå¯é€‰ï¼‰ |

**è¿”å›å€¼ï¼š**
- `Promise<T[]>`ï¼šå½“å‰é¡µçš„æ•°æ®æ•°ç»„

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
// æŸ¥è¯¢ç¬¬1é¡µï¼Œæ¯é¡µ20æ¡
const page1 = await DatabaseHelper.queryPage(ctx, 'users', 1, 20);

// æŸ¥è¯¢ç¬¬2é¡µï¼Œæ¯é¡µ50æ¡
const page2 = await DatabaseHelper.queryPage(ctx, 'users', 2, 50);

// ä½¿ç”¨æ¨¡å‹ç±»
const historyPage = await DatabaseHelper.queryPage<ProcessingHistory>(
  ctx,
  'processing_history',
  1,
  50,
  ProcessingHistory
);

// ç»“åˆ count å®ç°å®Œæ•´åˆ†é¡µ
const total = await DatabaseHelper.count(ctx, 'users');
const pageData = await DatabaseHelper.queryPage(ctx, 'users', 1, 20);
const totalPages = Math.ceil(total / 20);
```

**æ³¨æ„äº‹é¡¹ï¼š**
- é¡µç ä» 1 å¼€å§‹ï¼Œä¸æ˜¯ 0
- å¦‚æœé¡µç è¶…å‡ºèŒƒå›´ï¼Œè¿”å›ç©ºæ•°ç»„
- å»ºè®®æ¯é¡µå¤§å°è®¾ç½®ä¸º 20-100 ä¹‹é—´ï¼Œé¿å…å•æ¬¡æŸ¥è¯¢æ•°æ®è¿‡å¤š

---

### 3. count - ç»Ÿè®¡è®°å½•æ€»æ•°

**åŠŸèƒ½ï¼š** ç»Ÿè®¡æŒ‡å®šè¡¨çš„è®°å½•æ€»æ•°

**æ–¹æ³•ç­¾åï¼š**
```typescript
static async count(ctx: Context, tableName: string): Promise<number>
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `ctx` | `Context` | æ˜¯ | åº”ç”¨ä¸Šä¸‹æ–‡ |
| `tableName` | `string` | æ˜¯ | è¡¨å |

**è¿”å›å€¼ï¼š**
- `Promise<number>`ï¼šè®°å½•æ€»æ•°

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
// ç»Ÿè®¡ç”¨æˆ·æ€»æ•°
const userCount = await DatabaseHelper.count(ctx, 'users');

// ç»“åˆåˆ†é¡µä½¿ç”¨
const total = await DatabaseHelper.count(ctx, 'processing_history');
const pageSize = 50;
const totalPages = Math.ceil(total / pageSize);

// åˆ¤æ–­è¡¨æ˜¯å¦ä¸ºç©º
const isEmpty = (await DatabaseHelper.count(ctx, 'users')) === 0;
```

---

### 4. insert - æ’å…¥å•æ¡è®°å½•

**åŠŸèƒ½ï¼š** å‘æŒ‡å®šè¡¨æ’å…¥ä¸€æ¡è®°å½•

**æ–¹æ³•ç­¾åï¼š**
```typescript
static async insert(
  ctx: Context,
  tableName: string,
  values: relationalStore.ValuesBucket
): Promise<number>
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `ctx` | `Context` | æ˜¯ | åº”ç”¨ä¸Šä¸‹æ–‡ |
| `tableName` | `string` | æ˜¯ | è¡¨å |
| `values` | `ValuesBucket` | æ˜¯ | è¦æ’å…¥çš„æ•°æ®ï¼ˆé”®å€¼å¯¹å¯¹è±¡ï¼‰ |

**è¿”å›å€¼ï¼š**
- `Promise<number>`ï¼šæ’å…¥çš„è®°å½• IDï¼ˆä¸»é”®ï¼‰

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
import { relationalStore } from '@kit.ArkData';

// æ’å…¥ç”¨æˆ·è®°å½•
const userId = await DatabaseHelper.insert(ctx, 'users', {
  name: 'å¼ ä¸‰',
  email: 'zhangsan@example.com',
  age: 25,
  created_at: new Date().toISOString()
});

// æ’å…¥åŠ å·¥å†å²è®°å½•
const historyId = await DatabaseHelper.insert(ctx, 'processing_history', {
  customer_name: 'å®¢æˆ·A',
  fruit_name: 'è‹¹æœ',
  weight: 100.5,
  count: 500,
  status: 'å·²å®Œæˆ',
  start_time: new Date().toISOString()
});

// ä½¿ç”¨è¿”å›çš„ ID
console.log(`æ–°æ’å…¥çš„è®°å½•ID: ${historyId}`);
```

**æ³¨æ„äº‹é¡¹ï¼š**
- `values` ä¸­çš„é”®å¿…é¡»ä¸è¡¨å­—æ®µååŒ¹é…
- å¦‚æœè¡¨æœ‰è‡ªå¢ä¸»é”®ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶è¿”å›
- ä¸æ”¯æŒåµŒå¥—å¯¹è±¡ï¼Œå¤æ‚æ•°æ®éœ€è¦åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²

---

### 5. batchInsert - æ‰¹é‡æ’å…¥è®°å½•

**åŠŸèƒ½ï¼š** æ‰¹é‡å‘æŒ‡å®šè¡¨æ’å…¥å¤šæ¡è®°å½•

**æ–¹æ³•ç­¾åï¼š**
```typescript
static async batchInsert(
  ctx: Context,
  tableName: string,
  valuesList: Array<relationalStore.ValuesBucket>
): Promise<number>
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `ctx` | `Context` | æ˜¯ | åº”ç”¨ä¸Šä¸‹æ–‡ |
| `tableName` | `string` | æ˜¯ | è¡¨å |
| `valuesList` | `ValuesBucket[]` | æ˜¯ | è¦æ’å…¥çš„æ•°æ®æ•°ç»„ |

**è¿”å›å€¼ï¼š**
- `Promise<number>`ï¼šæˆåŠŸæ’å…¥çš„è®°å½•æ•°

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
// æ‰¹é‡æ’å…¥ç”¨æˆ·
const users = [
  { name: 'å¼ ä¸‰', email: 'zhangsan@example.com', age: 25 },
  { name: 'æå››', email: 'lisi@example.com', age: 30 },
  { name: 'ç‹äº”', email: 'wangwu@example.com', age: 28 }
];

const insertedCount = await DatabaseHelper.batchInsert(ctx, 'users', users);
console.log(`æˆåŠŸæ’å…¥ ${insertedCount} æ¡è®°å½•`);

// æ‰¹é‡æ’å…¥åŠ å·¥å†å²ï¼ˆä»å¤–éƒ¨æ•°æ®å¯¼å…¥ï¼‰
const historyList = externalData.map(item => ({
  customer_name: item.customerName,
  fruit_name: item.fruitName,
  weight: item.weight,
  count: item.count,
  status: item.status,
  start_time: item.startTime
}));

const count = await DatabaseHelper.batchInsert(ctx, 'processing_history', historyList);
```

**æ³¨æ„äº‹é¡¹ï¼š**
- æ‰¹é‡æ’å…¥æ€§èƒ½ä¼˜äºå¤šæ¬¡è°ƒç”¨ `insert`
- å»ºè®®å•æ¬¡æ‰¹é‡æ’å…¥ä¸è¶…è¿‡ 1000 æ¡ï¼Œé¿å…å†…å­˜å‹åŠ›
- å¦‚æœéƒ¨åˆ†è®°å½•æ’å…¥å¤±è´¥ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå·²æ’å…¥çš„è®°å½•ä¸ä¼šå›æ»šï¼ˆå–å†³äºæ•°æ®åº“äº‹åŠ¡æ”¯æŒï¼‰

---

### 6. update - æ›´æ–°è®°å½•

**åŠŸèƒ½ï¼š** æ›´æ–°æŒ‡å®š ID çš„è®°å½•

**æ–¹æ³•ç­¾åï¼š**
```typescript
static async update(
  ctx: Context,
  tableName: string,
  id: number,
  values: relationalStore.ValuesBucket
): Promise<number>
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `ctx` | `Context` | æ˜¯ | åº”ç”¨ä¸Šä¸‹æ–‡ |
| `tableName` | `string` | æ˜¯ | è¡¨å |
| `id` | `number` | æ˜¯ | è®°å½• IDï¼ˆä¸»é”®ï¼‰ |
| `values` | `ValuesBucket` | æ˜¯ | è¦æ›´æ–°çš„å­—æ®µï¼ˆåªåŒ…å«éœ€è¦æ›´æ–°çš„å­—æ®µï¼‰ |

**è¿”å›å€¼ï¼š**
- `Promise<number>`ï¼šå—å½±å“çš„è¡Œæ•°ï¼ˆé€šå¸¸ä¸º 0 æˆ– 1ï¼‰

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
// æ›´æ–°ç”¨æˆ·ä¿¡æ¯
const affected = await DatabaseHelper.update(ctx, 'users', 1, {
  name: 'å¼ ä¸‰ï¼ˆå·²æ›´æ–°ï¼‰',
  email: 'newemail@example.com',
  updated_at: new Date().toISOString()
});

if (affected > 0) {
  console.log('æ›´æ–°æˆåŠŸ');
} else {
  console.log('è®°å½•ä¸å­˜åœ¨æˆ–æœªå‘ç”Ÿå˜åŒ–');
}

// æ›´æ–°åŠ å·¥çŠ¶æ€
await DatabaseHelper.update(ctx, 'processing_history', 123, {
  status: 'å·²å®Œæˆ',
  end_time: new Date().toISOString()
});
```

**æ³¨æ„äº‹é¡¹ï¼š**
- åªæ›´æ–° `values` ä¸­åŒ…å«çš„å­—æ®µï¼Œå…¶ä»–å­—æ®µä¿æŒä¸å˜
- å¦‚æœ ID ä¸å­˜åœ¨ï¼Œè¿”å› 0ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸
- å»ºè®®æ›´æ–°æ—¶åŒ…å« `updated_at` æ—¶é—´æˆ³å­—æ®µ

---

### 7. delete - åˆ é™¤è®°å½•

**åŠŸèƒ½ï¼š** åˆ é™¤æŒ‡å®š ID çš„è®°å½•

**æ–¹æ³•ç­¾åï¼š**
```typescript
static async delete(
  ctx: Context,
  tableName: string,
  id: number
): Promise<number>
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `ctx` | `Context` | æ˜¯ | åº”ç”¨ä¸Šä¸‹æ–‡ |
| `tableName` | `string` | æ˜¯ | è¡¨å |
| `id` | `number` | æ˜¯ | è®°å½• IDï¼ˆä¸»é”®ï¼‰ |

**è¿”å›å€¼ï¼š**
- `Promise<number>`ï¼šå—å½±å“çš„è¡Œæ•°ï¼ˆé€šå¸¸ä¸º 0 æˆ– 1ï¼‰

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
// åˆ é™¤ç”¨æˆ·
const deleted = await DatabaseHelper.delete(ctx, 'users', 1);

if (deleted > 0) {
  console.log('åˆ é™¤æˆåŠŸ');
} else {
  console.log('è®°å½•ä¸å­˜åœ¨');
}

// æ‰¹é‡åˆ é™¤ï¼ˆéœ€è¦å¾ªç¯è°ƒç”¨æˆ–ä½¿ç”¨ SQLï¼‰
const ids = [1, 2, 3, 4, 5];
for (const id of ids) {
  await DatabaseHelper.delete(ctx, 'users', id);
}
```

**æ³¨æ„äº‹é¡¹ï¼š**
- åˆ é™¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…ä½¿ç”¨
- å¦‚æœ ID ä¸å­˜åœ¨ï¼Œè¿”å› 0ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸
- æ‰¹é‡åˆ é™¤å»ºè®®ä½¿ç”¨ `executeSql` æ‰§è¡Œ `DELETE WHERE id IN (...)`

---

### 8. querySql - æ‰§è¡ŒåŸç”Ÿ SQL æŸ¥è¯¢

**åŠŸèƒ½ï¼š** æ‰§è¡Œè‡ªå®šä¹‰ SQL æŸ¥è¯¢è¯­å¥

**æ–¹æ³•ç­¾åï¼š**
```typescript
static async querySql<T extends ESObject = ESObject>(
  ctx: Context,
  sql: string
): Promise<T[]>
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `ctx` | `Context` | æ˜¯ | åº”ç”¨ä¸Šä¸‹æ–‡ |
| `sql` | `string` | æ˜¯ | SQL æŸ¥è¯¢è¯­å¥ï¼ˆSELECTï¼‰ |

**è¿”å›å€¼ï¼š**
- `Promise<T[]>`ï¼šæŸ¥è¯¢ç»“æœæ•°ç»„

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
// å¤æ‚æŸ¥è¯¢ï¼šå¤šè¡¨è”æŸ¥
const result = await DatabaseHelper.querySql<{
  id: number;
  customer_name: string;
  total_weight: number;
}>(ctx, `
  SELECT 
    p.id,
    p.customer_name,
    SUM(p.weight) as total_weight
  FROM processing_history p
  WHERE p.status = 'å·²å®Œæˆ'
  GROUP BY p.customer_name
  ORDER BY total_weight DESC
`);

// æ¡ä»¶æŸ¥è¯¢
const filtered = await DatabaseHelper.querySql(ctx, `
  SELECT * FROM users 
  WHERE age > 25 AND email IS NOT NULL
  ORDER BY created_at DESC
  LIMIT 10
`);

// ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆé˜²æ­¢ SQL æ³¨å…¥ï¼‰
// æ³¨æ„ï¼šå½“å‰å®ç°éœ€è¦æ‰‹åŠ¨æ‹¼æ¥ï¼Œå»ºè®®ä½¿ç”¨ ORM çš„æŸ¥è¯¢æ„å»ºå™¨
```

**æ³¨æ„äº‹é¡¹ï¼š**
- âš ï¸ **å®‰å…¨è­¦å‘Š**ï¼šç›´æ¥ä½¿ç”¨ SQL å¯èƒ½å­˜åœ¨ SQL æ³¨å…¥é£é™©ï¼Œå»ºè®®ï¼š
  - ä¼˜å…ˆä½¿ç”¨ `queryAll`ã€`queryPage` ç­‰å°è£…æ–¹æ³•
  - å¦‚æœå¿…é¡»ä½¿ç”¨ SQLï¼Œç¡®ä¿å‚æ•°ç»è¿‡éªŒè¯å’Œè½¬ä¹‰
  - é¿å…ç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥çš„å­—ç¬¦ä¸²åˆ° SQL ä¸­
- åªæ”¯æŒ SELECT æŸ¥è¯¢ï¼Œæ›´æ–°æ“ä½œä½¿ç”¨ `executeSql`

---

### 9. executeSql - æ‰§è¡ŒåŸç”Ÿ SQL æ›´æ–°

**åŠŸèƒ½ï¼š** æ‰§è¡Œè‡ªå®šä¹‰ SQL æ›´æ–°è¯­å¥ï¼ˆINSERTã€UPDATEã€DELETEï¼‰

**æ–¹æ³•ç­¾åï¼š**
```typescript
static async executeSql(
  ctx: Context,
  sql: string
): Promise<number>
```

**å‚æ•°è¯´æ˜ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `ctx` | `Context` | æ˜¯ | åº”ç”¨ä¸Šä¸‹æ–‡ |
| `sql` | `string` | æ˜¯ | SQL æ›´æ–°è¯­å¥ï¼ˆINSERTã€UPDATEã€DELETEï¼‰ |

**è¿”å›å€¼ï¼š**
- `Promise<number>`ï¼šå—å½±å“çš„è¡Œæ•°

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```typescript
// æ‰¹é‡åˆ é™¤
const deleted = await DatabaseHelper.executeSql(ctx, `
  DELETE FROM users 
  WHERE created_at < '2024-01-01'
`);

// æ‰¹é‡æ›´æ–°
const updated = await DatabaseHelper.executeSql(ctx, `
  UPDATE processing_history 
  SET status = 'å·²å®Œæˆ' 
  WHERE status = 'è¿›è¡Œä¸­' AND end_time IS NOT NULL
`);

// æ¸…ç©ºè¡¨ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
const cleared = await DatabaseHelper.executeSql(ctx, 'DELETE FROM temp_table');
```

**æ³¨æ„äº‹é¡¹ï¼š**
- âš ï¸ **å®‰å…¨è­¦å‘Š**ï¼šåŒæ ·å­˜åœ¨ SQL æ³¨å…¥é£é™©ï¼Œè¯·è°¨æ…ä½¿ç”¨
- åªæ”¯æŒ INSERTã€UPDATEã€DELETE è¯­å¥ï¼Œä¸æ”¯æŒ SELECT
- æ‰¹é‡æ“ä½œå»ºè®®ä½¿ç”¨äº‹åŠ¡ï¼ˆå¦‚æœæ•°æ®åº“æ”¯æŒï¼‰

---

## ğŸ”§ IDatabaseAdapter æ¥å£æ–‡æ¡£

`IDatabaseAdapter` æ˜¯æ•°æ®åº“é€‚é…å™¨çš„æŠ½è±¡æ¥å£ï¼Œæ‰€æœ‰æ•°æ®åº“å®ç°éƒ½å¿…é¡»å®ç°æ­¤æ¥å£ã€‚

### æ¥å£å®šä¹‰

```typescript
export interface IDatabaseAdapter {
  // åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
  initialize(ctx: Context): Promise<void>;
  
  // æŸ¥è¯¢æ‰€æœ‰è®°å½•
  queryAll<T extends ESObject = ESObject>(
    ctx: Context,
    tableName: string,
    modelClass?: Class
  ): Promise<T[]>;
  
  // åˆ†é¡µæŸ¥è¯¢
  queryPage<T extends ESObject = ESObject>(
    ctx: Context,
    tableName: string,
    page: number,
    size: number,
    modelClass?: Class
  ): Promise<T[]>;
  
  // ç»Ÿè®¡è®°å½•æ€»æ•°
  count(ctx: Context, tableName: string): Promise<number>;
  
  // æ’å…¥å•æ¡è®°å½•
  insert(
    ctx: Context,
    tableName: string,
    values: relationalStore.ValuesBucket
  ): Promise<number>;
  
  // æ‰¹é‡æ’å…¥
  batchInsert(
    ctx: Context,
    tableName: string,
    valuesList: Array<relationalStore.ValuesBucket>
  ): Promise<number>;
  
  // æ›´æ–°è®°å½•
  update(
    ctx: Context,
    tableName: string,
    id: number,
    values: relationalStore.ValuesBucket
  ): Promise<number>;
  
  // åˆ é™¤è®°å½•
  delete(ctx: Context, tableName: string, id: number): Promise<number>;
  
  // æ‰§è¡ŒåŸç”Ÿ SQL æŸ¥è¯¢
  querySql<T extends ESObject = ESObject>(
    ctx: Context,
    sql: string
  ): Promise<T[]>;
  
  // æ‰§è¡ŒåŸç”Ÿ SQL æ›´æ–°
  executeSql(ctx: Context, sql: string): Promise<number>;
}
```

### å®ç°è‡ªå®šä¹‰é€‚é…å™¨

```typescript
import { IDatabaseAdapter } from './adapters/IDatabaseAdapter';
import { Context } from '@kit.AbilityKit';
import { relationalStore } from '@kit.ArkData';
import { Class } from './orm';

class MySQLAdapter implements IDatabaseAdapter {
  async initialize(ctx: Context): Promise<void> {
    // åˆå§‹åŒ– MySQL è¿æ¥
    // ...
  }
  
  async queryAll<T extends ESObject>(
    ctx: Context,
    tableName: string,
    modelClass?: Class
  ): Promise<T[]> {
    // å®ç° MySQL æŸ¥è¯¢é€»è¾‘
    // ...
  }
  
  // ... å®ç°å…¶ä»–æ–¹æ³•
}

// ä½¿ç”¨è‡ªå®šä¹‰é€‚é…å™¨
import { DatabaseAdapterFactory } from './database';
DatabaseAdapterFactory.setAdapter(new MySQLAdapter());
```

---

## ğŸ­ DatabaseAdapterFactory æ¥å£æ–‡æ¡£

`DatabaseAdapterFactory` è´Ÿè´£ç®¡ç†æ•°æ®åº“é€‚é…å™¨å®ä¾‹ã€‚

### æ–¹æ³•åˆ—è¡¨

#### initialize - åˆå§‹åŒ–é€‚é…å™¨ï¼ˆå¸¦é…ç½®ï¼‰

```typescript
static initialize(config?: SQLiteAdapterConfig): void
```

**åŠŸèƒ½ï¼š** åˆå§‹åŒ– SQLite é€‚é…å™¨ï¼Œæ”¯æŒè‡ªåŠ¨è¿ç§»æ¨¡å‹

**å‚æ•°ï¼š**
- `config`ï¼ˆå¯é€‰ï¼‰ï¼šSQLite é€‚é…å™¨é…ç½®
  ```typescript
  interface SQLiteAdapterConfig {
    dbName?: string;      // æ•°æ®åº“æ–‡ä»¶åï¼ˆé»˜è®¤ï¼š'article.db'ï¼‰
    models?: Class[];      // éœ€è¦è‡ªåŠ¨è¿ç§»çš„æ¨¡å‹ç±»æ•°ç»„
  }
  ```

**ç¤ºä¾‹ï¼š**
```typescript
import { DatabaseAdapterFactory } from './database';
import { User, Product } from './models';

// åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–
DatabaseAdapterFactory.initialize({
  dbName: 'my_app.db',
  models: [User, Product]  // è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„
});
```

---

#### getAdapter - è·å–é€‚é…å™¨å®ä¾‹

```typescript
static getAdapter(): IDatabaseAdapter
```

**åŠŸèƒ½ï¼š** è·å–å½“å‰ä½¿ç”¨çš„æ•°æ®åº“é€‚é…å™¨å®ä¾‹

**è¿”å›å€¼ï¼š** `IDatabaseAdapter` å®ä¾‹

**è¯´æ˜ï¼š**
- å¦‚æœæœªåˆå§‹åŒ–ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºé»˜è®¤çš„ `SQLiteAdapter`ï¼ˆæ— è‡ªåŠ¨è¿ç§»ï¼‰
- å•ä¾‹æ¨¡å¼ï¼Œå…¨å±€åªæœ‰ä¸€ä¸ªå®ä¾‹

**ç¤ºä¾‹ï¼š**
```typescript
const adapter = DatabaseAdapterFactory.getAdapter();
await adapter.initialize(ctx);
```

---

#### setAdapter - è®¾ç½®é€‚é…å™¨å®ä¾‹

```typescript
static setAdapter(adapter: IDatabaseAdapter): void
```

**åŠŸèƒ½ï¼š** åˆ‡æ¢æ•°æ®åº“é€‚é…å™¨ï¼ˆç”¨äºåˆ‡æ¢æ•°æ®åº“ç±»å‹ï¼‰

**å‚æ•°ï¼š**
- `adapter`ï¼šæ–°çš„é€‚é…å™¨å®ä¾‹

**ç¤ºä¾‹ï¼š**
```typescript
import { MySQLAdapter } from './adapters/MySQLAdapter';

// åˆ‡æ¢åˆ° MySQL
DatabaseAdapterFactory.setAdapter(new MySQLAdapter());

// ä¹‹åæ‰€æœ‰ DatabaseHelper çš„è°ƒç”¨éƒ½ä¼šä½¿ç”¨ MySQL
const data = await DatabaseHelper.queryAll(ctx, 'users');
```

---

#### reset - é‡ç½®é€‚é…å™¨

```typescript
static reset(): void
```

**åŠŸèƒ½ï¼š** é‡ç½®é€‚é…å™¨å®ä¾‹ï¼ˆä¸»è¦ç”¨äºæµ‹è¯•ï¼‰

**ç¤ºä¾‹ï¼š**
```typescript
// æµ‹è¯•åœºæ™¯
DatabaseAdapterFactory.reset();
DatabaseAdapterFactory.initialize({ dbName: 'test.db' });
```

---

## ğŸ“ å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåŸºæœ¬ CRUD æ“ä½œ

```typescript
import { Context } from '@kit.AbilityKit';
import { DatabaseHelper } from './database';

export class UserService {
  // æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
  static async getAllUsers(ctx: Context) {
    return await DatabaseHelper.queryAll(ctx, 'users');
  }
  
  // åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·
  static async getUsersByPage(ctx: Context, page: number, size: number) {
    return await DatabaseHelper.queryPage(ctx, 'users', page, size);
  }
  
  // æ·»åŠ ç”¨æˆ·
  static async addUser(ctx: Context, name: string, email: string): Promise<number> {
    return await DatabaseHelper.insert(ctx, 'users', {
      name: name,
      email: email,
      created_at: new Date().toISOString()
    });
  }
  
  // æ›´æ–°ç”¨æˆ·
  static async updateUser(ctx: Context, id: number, name: string): Promise<number> {
    return await DatabaseHelper.update(ctx, 'users', id, {
      name: name,
      updated_at: new Date().toISOString()
    });
  }
  
  // åˆ é™¤ç”¨æˆ·
  static async deleteUser(ctx: Context, id: number): Promise<number> {
    return await DatabaseHelper.delete(ctx, 'users', id);
  }
  
  // ç»Ÿè®¡ç”¨æˆ·æ•°
  static async getUserCount(ctx: Context): Promise<number> {
    return await DatabaseHelper.count(ctx, 'users');
  }
}
```

### ç¤ºä¾‹ 2ï¼šå¸¦æ¨¡å‹ç±»çš„ä½¿ç”¨

```typescript
import { Context } from '@kit.AbilityKit';
import { DatabaseHelper } from './database';
import { ProcessingHistory } from './models/ProcessingHistory';

export class HistoryService {
  // æŸ¥è¯¢æ‰€æœ‰å†å²è®°å½•ï¼ˆè¿”å›æ¨¡å‹å®ä¾‹ï¼‰
  static async getAllHistory(ctx: Context): Promise<ProcessingHistory[]> {
    return await DatabaseHelper.queryAll<ProcessingHistory>(
      ctx,
      'processing_history',
      ProcessingHistory
    );
  }
  
  // åˆ†é¡µæŸ¥è¯¢
  static async getHistoryPage(
    ctx: Context,
    page: number,
    size: number
  ): Promise<ProcessingHistory[]> {
    return await DatabaseHelper.queryPage<ProcessingHistory>(
      ctx,
      'processing_history',
      page,
      size,
      ProcessingHistory
    );
  }
  
  // æ·»åŠ å†å²è®°å½•
  static async addHistory(
    ctx: Context,
    data: {
      customerName: string;
      fruitName: string;
      weight: number;
      count: number;
    }
  ): Promise<number> {
    return await DatabaseHelper.insert(ctx, 'processing_history', {
      customer_name: data.customerName,
      fruit_name: data.fruitName,
      weight: data.weight,
      count: data.count,
      status: 'å¾…å¼€å§‹',
      start_time: new Date().toISOString()
    });
  }
}
```

### ç¤ºä¾‹ 3ï¼šåº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–

```typescript
// EntryAbility.ets
import { UIAbility } from '@kit.AbilityKit';
import { DatabaseAdapterFactory } from './database';
import { ProcessingHistory } from './database/models/ProcessingHistory';

export default class EntryAbility extends UIAbility {
  onCreate(want, launchParam) {
    // åˆå§‹åŒ–æ•°æ®åº“é€‚é…å™¨ï¼ˆè‡ªåŠ¨è¿ç§»æ¨¡å‹ï¼‰
    DatabaseAdapterFactory.initialize({
      dbName: 'my_app.db',
      models: [ProcessingHistory]  // è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„
    });
    
    console.log('æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ');
  }
}
```

---

## âš ï¸ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯åŠå¤„ç†

#### 1. æ•°æ®åº“æœªåˆå§‹åŒ–

**é”™è¯¯ä¿¡æ¯ï¼š** `Database not initialized`

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// ç¡®ä¿åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–
DatabaseAdapterFactory.initialize({
  dbName: 'my_app.db',
  models: [YourModel]
});
```

#### 2. è¡¨ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯ï¼š** `Table 'xxx' does not exist`

**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨æ¨¡å‹è‡ªåŠ¨è¿ç§»ï¼šåœ¨ `initialize` ä¸­ä¼ å…¥ `models` å‚æ•°
- æˆ–æ‰‹åŠ¨åˆ›å»ºè¡¨ï¼šä½¿ç”¨ `executeSql` æ‰§è¡Œ `CREATE TABLE` è¯­å¥

#### 3. Context å‚æ•°é”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼š** `Context is required`

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// åœ¨ UIAbility ä¸­
const ctx = this.context;

// åœ¨ç»„ä»¶ä¸­
import { getContext } from '@kit.ArkUI';
const ctx = getContext(this);
```

#### 4. SQL æ³¨å…¥é£é™©

**è­¦å‘Šï¼š** ä½¿ç”¨ `querySql` å’Œ `executeSql` æ—¶éœ€è¦æ³¨æ„

**è§£å†³æ–¹æ¡ˆï¼š**
- ä¼˜å…ˆä½¿ç”¨å°è£…æ–¹æ³•ï¼ˆ`queryAll`ã€`insert` ç­‰ï¼‰
- å¦‚æœå¿…é¡»ä½¿ç”¨ SQLï¼Œç¡®ä¿å‚æ•°ç»è¿‡éªŒè¯
- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆå¦‚æœé€‚é…å™¨æ”¯æŒï¼‰

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. åˆå§‹åŒ–æ—¶æœº

âœ… **æ¨èï¼š** åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼ˆ`EntryAbility.onCreate`ï¼‰åˆå§‹åŒ–
```typescript
DatabaseAdapterFactory.initialize({
  dbName: 'my_app.db',
  models: [User, Product]
});
```

âŒ **ä¸æ¨èï¼š** åœ¨æ¯æ¬¡æ“ä½œå‰åˆå§‹åŒ–
```typescript
// æ¯æ¬¡è°ƒç”¨éƒ½ä¼šæ£€æŸ¥ï¼Œä½†ä¸éœ€è¦é‡å¤åˆå§‹åŒ–
await DatabaseHelper.queryAll(ctx, 'users');
```

### 2. åˆ†é¡µæŸ¥è¯¢

âœ… **æ¨èï¼š** å¤§æ•°æ®é‡ä½¿ç”¨åˆ†é¡µ
```typescript
const pageData = await DatabaseHelper.queryPage(ctx, 'users', 1, 50);
```

âŒ **ä¸æ¨èï¼š** ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰æ•°æ®
```typescript
const allData = await DatabaseHelper.queryAll(ctx, 'users');  // å¦‚æœæ•°æ®é‡å¾ˆå¤§
```

### 3. æ‰¹é‡æ“ä½œ

âœ… **æ¨èï¼š** æ‰¹é‡æ’å…¥ä½¿ç”¨ `batchInsert`
```typescript
await DatabaseHelper.batchInsert(ctx, 'users', userList);
```

âŒ **ä¸æ¨èï¼š** å¾ªç¯è°ƒç”¨ `insert`
```typescript
for (const user of userList) {
  await DatabaseHelper.insert(ctx, 'users', user);  // æ€§èƒ½å·®
}
```

### 4. ç±»å‹å®‰å…¨

âœ… **æ¨èï¼š** ä½¿ç”¨æ³›å‹æŒ‡å®šè¿”å›ç±»å‹
```typescript
const users = await DatabaseHelper.queryAll<UserData>(ctx, 'users');
```

âŒ **ä¸æ¨èï¼š** ä¸æŒ‡å®šç±»å‹
```typescript
const users = await DatabaseHelper.queryAll(ctx, 'users');  // ç±»å‹ä¸º any[]
```

### 5. é”™è¯¯å¤„ç†

âœ… **æ¨èï¼š** ä½¿ç”¨ try-catch å¤„ç†é”™è¯¯
```typescript
try {
  const id = await DatabaseHelper.insert(ctx, 'users', data);
} catch (error) {
  console.error('æ’å…¥å¤±è´¥:', error);
}
```

---

## ğŸ“¦ ç›¸å…³æ–‡ä»¶

- **DatabaseHelperï¼š** `entry/src/main/ets/database/DatabaseHelper.ets`
- **IDatabaseAdapterï¼š** `entry/src/main/ets/database/adapters/IDatabaseAdapter.ets`
- **SQLiteAdapterï¼š** `entry/src/main/ets/database/adapters/SQLiteAdapter.ets`
- **DatabaseAdapterFactoryï¼š** `entry/src/main/ets/database/adapters/DatabaseAdapterFactory.ets`
- **æ¨¡å—å¯¼å‡ºï¼š** `entry/src/main/ets/database/index.ets`
- **ä½¿ç”¨æ–‡æ¡£ï¼š** `entry/src/main/ets/database/README.md`

---

## ğŸ” æ¥å£é€ŸæŸ¥è¡¨

| æ¥å£ | åŠŸèƒ½ | è¿”å›ç±»å‹ |
|------|------|----------|
| `queryAll` | æŸ¥è¯¢æ‰€æœ‰è®°å½• | `Promise<T[]>` |
| `queryPage` | åˆ†é¡µæŸ¥è¯¢ | `Promise<T[]>` |
| `count` | ç»Ÿè®¡æ€»æ•° | `Promise<number>` |
| `insert` | æ’å…¥å•æ¡ | `Promise<number>` (ID) |
| `batchInsert` | æ‰¹é‡æ’å…¥ | `Promise<number>` (count) |
| `update` | æ›´æ–°è®°å½• | `Promise<number>` (affected) |
| `delete` | åˆ é™¤è®°å½• | `Promise<number>` (affected) |
| `querySql` | SQL æŸ¥è¯¢ | `Promise<T[]>` |
| `executeSql` | SQL æ›´æ–° | `Promise<number>` (affected) |

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [HarmonyOS æ•°æ®åº“å¼€å‘æŒ‡å—](https://developer.harmonyos.com/cn/docs/documentation/doc-guides/data-persistence-overview-0000001504728577)
- [é¡¹ç›®æ•°æ®åº“æ¨¡å— README](./README.md)
- [HTTP é€šç”¨æ ¼å¼è§„èŒƒ](../utils/network/http/docs/HTTPé€šç”¨æ ¼å¼è§„èŒƒ.md)

