/**
 * æ¶²ä½“å¡ç‰‡åŒºåŸŸç»„ä»¶
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - æ˜¾ç¤ºå¤šä¸ªæ¶²ä½“å¡ç‰‡çš„æ»šåŠ¨åŒºåŸŸ
 * - æ”¯æŒå‚ç›´æ»šåŠ¨æŸ¥çœ‹æ›´å¤šå¡ç‰‡
 * - ä½¿ç”¨Flexå¸ƒå±€å®ç°å¡ç‰‡ç½‘æ ¼æ’åˆ—
 * - æ”¯æŒä¸»é¢˜é…ç½®å’Œæ ·å¼å®šåˆ¶
 * 
 * ç»„ä»¶ç‰¹ç‚¹ï¼š
 * - å“åº”å¼å¸ƒå±€ï¼šè‡ªåŠ¨æ¢è¡Œæ˜¾ç¤ºå¡ç‰‡
 * - æ€§èƒ½ä¼˜åŒ–ï¼šé™åˆ¶å¯è§å¡ç‰‡æ•°é‡ï¼Œæå‡æ»šåŠ¨æ€§èƒ½
 * - ä¸»é¢˜æ”¯æŒï¼šä½¿ç”¨ä¸»é¢˜ç®¡ç†å™¨çš„é¢œè‰²é…ç½®
 * - æ»šåŠ¨ä¼˜åŒ–ï¼šé…ç½®æ»šåŠ¨æ¡å’Œæ»šåŠ¨æ•ˆæœ
 * 
 * å¸ƒå±€è¯´æ˜ï¼š
 * - å¡ç‰‡æ’åˆ—ï¼šæ°´å¹³æ’åˆ—ï¼Œè‡ªåŠ¨æ¢è¡Œ
 * - å¡ç‰‡é—´è·ï¼šå³è¾¹è·6pxï¼Œä¸‹è¾¹è·6px
 * - åŒºåŸŸé«˜åº¦ï¼šå çˆ¶å®¹å™¨çš„30%
 * - æ»šåŠ¨æ–¹å‘ï¼šå‚ç›´æ»šåŠ¨
 * 
 * æ€§èƒ½ä¼˜åŒ–ï¼š
 * - å¯è§å¡ç‰‡æ•°é‡ï¼šé™åˆ¶ä¸º20ä¸ªï¼Œå‡å°‘æ¸²æŸ“å¼€é”€
 * - æ»šåŠ¨æ‘©æ“¦ï¼šè®¾ç½®ä¸º0.6ï¼Œæå‡æ»šåŠ¨æµç•…åº¦
 * - æ»šåŠ¨æ¡ï¼šè‡ªåŠ¨æ˜¾ç¤ºï¼Œå®½åº¦6px
 * 
 * ä½¿ç”¨æ–¹å¼ï¼š
 * ```typescript
 * LiquidCardsArea()
 * ```
 * 
 * æ ·å¼é…ç½®ï¼š
 * - èƒŒæ™¯è‰²ï¼šä½¿ç”¨ä¸»é¢˜çš„æ§åˆ¶èƒŒæ™¯è‰²
 * - è¾¹æ¡†ï¼š1pxè¾¹æ¡†ï¼Œä½¿ç”¨ä¸»é¢˜è¾¹æ¡†è‰²
 * - åœ†è§’ï¼š10px
 * - å†…è¾¹è·ï¼šå·¦å³20pxï¼Œä¸Šä¸‹0pxå’Œ4px
 */

import { OmniThemeManager, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { ThreeLayerCard, ThreeLayerCardData } from '../../components/cards/ThreeLayerCard'
import { StorageKeys } from '../../utils/constants/StorageKeys'
import { GRID_DRAG_ACTIVE_KEY } from '../../components/layout/DraggableGridTable'
import { getCurrentCellDragData, CellDragData, CELL_DRAG_ACTIVE_KEY } from '../../components/ui/SimpleDraggableCell'
import { GlobalCardDataManager } from '../../utils/GlobalCardDataManager'
import { CardDataManager } from '../../utils/card/CardDataManager'
import { HOME_SELECTED_FSM } from '../../constants/TopBarKeys'
import { HomeDataManager } from './core/HomeDataManager'
import { HomeContent } from './HomeContent'

// ç§»é™¤æºæ•°æ®æ¥å£
interface RemoveSourceData {
  sourceCardId: string
  sourceValue: number
}


@Component
export struct LiquidCardsArea {
  // æ‹–æ‹½æ•°æ®çŠ¶æ€
  @State private dragData: CellDragData | null = null
  // æ¯å¼ å¡ç‰‡çš„æ•°æ®ï¼ˆç´¢å¼•ä»0å¼€å§‹ï¼Œå¯¹åº”UIé‡Œçš„1..Nï¼‰
  @State private cardDataList: ThreeLayerCardData[] = []
  @State private isDragging: boolean = false
  // ç›‘å¬å¼ºåˆ¶ç§»é™¤ä¿¡å·
  @StorageLink(StorageKeys.FORCE_REMOVE_SOURCE) private forceRemoveSource: RemoveSourceData | null = null
  @State private hoverIndex: number = -1
  @StorageLink(GRID_DRAG_ACTIVE_KEY) private gridDragActive: boolean = false
  // FSMçŠ¶æ€ç›‘å¬
  @StorageLink(HOME_SELECTED_FSM) @Watch('onFSMChange') private selectedFSM: 'FSM1' | 'FSM2' = 'FSM1'
  // ç®€åŒ–ï¼šä¸è®°å½•å‡ ä½•ï¼Œç›´æ¥åœ¨å¡ç‰‡è‡ªèº«æ¥æ”¶æŠ¬æ‰‹æŠ•æ”¾
  
  // å…¨å±€æ•°æ®ç®¡ç†å™¨å®ä¾‹
  private globalDataManager: GlobalCardDataManager = GlobalCardDataManager.getInstance()
  
  // æ¨¡å—åŒ–çš„å¡ç‰‡æ•°æ®ç®¡ç†å™¨
  private cardDataManager: CardDataManager = CardDataManager.getInstance()
  
  // æ‹–æ‹½å›è°ƒï¼ˆé¢„ç•™æ‰©å±•ä½ï¼‰
  // onDataDropped?: (data: CellDragData) => void
  // onDataRemoved?: () => void
  /**
   * è·å–å½“å‰ä¸»é¢˜é…ç½®
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - ä»ä¸»é¢˜ç®¡ç†å™¨è·å–å½“å‰ä¸»é¢˜æ ·å¼
   * - ç”¨äºæ¶²ä½“å¡ç‰‡çš„é¢œè‰²é…ç½®
   * - æ”¯æŒä¸»é¢˜åˆ‡æ¢æ—¶çš„æ ·å¼æ›´æ–°
   * 
   * @returns å½“å‰ä¸»é¢˜çš„æ‰©å±•æ ·å¼å¯¹è±¡
   */
  private getCurrentTheme(): ExtendedOmniThemeStyle {
    return OmniThemeManager.getInstance().getCurrentTheme()
  }

  /**
   * ç”Ÿæˆæ•°å­—åºåˆ—
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - ç”Ÿæˆä»æŒ‡å®šå¼€å§‹æ•°å­—åˆ°æŒ‡å®šé•¿åº¦çš„æ•°å­—åºåˆ—
   * - ç”¨äºæ¶²ä½“å¡ç‰‡çš„ç´¢å¼•ç”Ÿæˆ
   * - æ”¯æŒè‡ªå®šä¹‰èµ·å§‹æ•°å­—å’Œæ•°é‡
   * 
   * @param start èµ·å§‹æ•°å­—
   * @param count åºåˆ—é•¿åº¦
   * @returns æ•°å­—åºåˆ—æ•°ç»„
   * 
   * ä½¿ç”¨ç¤ºä¾‹ï¼š
   * ```typescript
   * const numbers = this.buildNumberRange(1, 5)
   * // è¿”å› [1, 2, 3, 4, 5]
   * ```
   */
  private buildNumberRange(start: number, count: number): number[] {
    const result: number[] = []
    for (let i = 0; i < count; i++) {
      result.push(start + i)
    }
    return result
  }

  /**
   * è·å–å¯è§å¡ç‰‡æ•°é‡ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ ¹æ®å±å¹•é«˜åº¦åŠ¨æ€è®¡ç®—å¯è§å¡ç‰‡æ•°é‡
   * - å‡å°‘æ¸²æŸ“å¼€é”€ï¼Œæå‡æ»šåŠ¨æ€§èƒ½
   * - é¿å…æ¸²æŸ“è¿‡å¤šå¡ç‰‡å¯¼è‡´çš„æ€§èƒ½é—®é¢˜
   * 
   * @returns å¯è§å¡ç‰‡æ•°é‡
   * 
   * æ€§èƒ½ä¼˜åŒ–è¯´æ˜ï¼š
   * - é™åˆ¶å¯è§å¡ç‰‡æ•°é‡ä¸º20ä¸ª
   * - å‡å°‘å†…å­˜å ç”¨å’Œæ¸²æŸ“æ—¶é—´
   * - æå‡æ»šåŠ¨æµç•…åº¦
   */
  private getVisibleCardCount(): number {
    // æ ¹æ®å±å¹•é«˜åº¦åŠ¨æ€è®¡ç®—å¯è§å¡ç‰‡æ•°é‡ï¼Œå‡å°‘æ¸²æŸ“å¼€é”€
    return 20 // å‡å°‘åˆ°20ä¸ªå¡ç‰‡ï¼Œæå‡æ»šåŠ¨æ€§èƒ½
  }

  /**
   * è·å–æ³¢æµªå›¾æ•°é‡ï¼ˆæ ¹æ®FSMçŠ¶æ€ï¼‰
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - FSM1ï¼šæ˜¾ç¤º3ä¸ªæ³¢æµªå›¾
   * - FSM2ï¼šæ˜¾ç¤º5ä¸ªæ³¢æµªå›¾
   * 
   * @returns æ³¢æµªå›¾æ•°é‡
   */
  private getWaveCount(): number {
    return this.selectedFSM === 'FSM1' ? 3 : 5
  }

  /**
   * åˆå§‹åŒ–å¡ç‰‡æ•°æ®
   */
  private initializeCardData(): void {
    console.log('å¼€å§‹åˆå§‹åŒ–å¡ç‰‡æ•°æ®...')
    
    // ä½¿ç”¨å…¨å±€æ•°æ®ç®¡ç†å™¨
    this.cardDataList = this.globalDataManager.initializeCardData()
    console.log('ä»å…¨å±€æ•°æ®ç®¡ç†å™¨è·å–æ•°æ®:', this.cardDataList.length, 'ä¸ªå¡ç‰‡')
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰å¡ç‰‡çš„ç¬¬ä¸‰å±‚æ•°æ®
   */
  public clearAllCardData(): void {
    console.log('LiquidCardsArea: å¼€å§‹æ¸…ç©ºæ‰€æœ‰å¡ç‰‡æ•°æ®...')
    
    // ä½¿ç”¨å…¨å±€æ•°æ®ç®¡ç†å™¨æ¸…ç©ºæ•°æ®
    this.globalDataManager.clearAllCardData()
    
    // æ›´æ–°æœ¬åœ°çŠ¶æ€
    this.cardDataList = this.globalDataManager.getCardDataList()
    
    // åŒæ—¶æ¸…ç©ºç­‰çº§ç»Ÿè®¡è¡¨çš„å‡ºå£ä¿¡æ¯
    this.clearStatisticsTableExits()
    
    console.log('LiquidCardsArea: æ‰€æœ‰å¡ç‰‡æ•°æ®å’Œç­‰çº§ç»Ÿè®¡è¡¨å‡ºå£ä¿¡æ¯å·²æ¸…ç©º')
  }

  /**
   * æ¸…ç©ºç­‰çº§ç»Ÿè®¡è¡¨çš„å‡ºå£ä¿¡æ¯
   */
  private clearStatisticsTableExits(): void {
    // é€šè¿‡AppStorageè·å–HomeDataManagerå®ä¾‹
    const homeDataManager = AppStorage.get('HOME_DATA_MANAGER') as HomeDataManager | null
    if (homeDataManager) {
      homeDataManager.clearStatisticsTableExits()
      
      // é€šè¿‡AppStorageè·å–HomeContentå®ä¾‹æ¥è§¦å‘UIåˆ·æ–°
      const homeContentRef = AppStorage.get('HOME_CONTENT_REF') as HomeContent | null
      if (homeContentRef) {
        homeContentRef.refreshStatisticsTable()
        console.log('LiquidCardsArea: ç­‰çº§ç»Ÿè®¡è¡¨å‡ºå£ä¿¡æ¯å·²æ¸…ç©ºï¼ŒUIå·²åˆ·æ–°')
      } else {
        console.warn('LiquidCardsArea: æ— æ³•è·å–HomeContentå®ä¾‹ï¼Œæ•°æ®å·²æ¸…ç©ºä½†UIå¯èƒ½æœªåˆ·æ–°')
      }
    } else {
      console.warn('LiquidCardsArea: æ— æ³•è·å–HomeDataManagerå®ä¾‹ï¼Œè·³è¿‡æ¸…ç©ºç­‰çº§ç»Ÿè®¡è¡¨å‡ºå£ä¿¡æ¯')
    }
  }

  /**
   * ç»„ä»¶å‡ºç°æ—¶æ³¨å†Œåˆ°AppStorage
   */
  aboutToAppear(): void {
    // å°†å½“å‰å®ä¾‹æ³¨å†Œåˆ°AppStorageï¼Œä¾›å…¶ä»–ç»„ä»¶è°ƒç”¨
    AppStorage.setOrCreate('LIQUID_CARDS_AREA_REF', this)
    // åˆå§‹åŒ–å¡ç‰‡æ•°æ®
    this.initializeCardData()
  }

  aboutToDisappear(): void {
    // ç¦»å¼€æ—¶é‡Šæ”¾ä¿å­˜çš„ç»„ä»¶å®ä¾‹å¼•ç”¨ï¼Œé¿å…é˜»æ­¢GC
    AppStorage.setOrCreate('LIQUID_CARDS_AREA_REF', null)
  }

  /**
   * ç›‘å¬FSMçŠ¶æ€å˜åŒ–
   */
  onFSMChange(): void {
    console.log(`LiquidCardsArea: FSMçŠ¶æ€å˜åŒ–åˆ° ${this.selectedFSM}`)
    this.globalDataManager.setFSM(this.selectedFSM)
    this.cardDataList = this.globalDataManager.getCardDataList()
    console.log(`LiquidCardsArea: å·²åˆ‡æ¢åˆ° ${this.selectedFSM} çš„å¡ç‰‡æ•°æ®ï¼Œå…± ${this.cardDataList.length} ä¸ªå¡ç‰‡`)
  }

  /**
   * ç›‘å¬å¼ºåˆ¶ç§»é™¤ä¿¡å·
   */
  aboutToUpdate(): void {
    // ç›‘å¬å¼ºåˆ¶ç§»é™¤ä¿¡å·
    if (this.forceRemoveSource && this.forceRemoveSource.sourceCardId && this.forceRemoveSource.sourceValue) {
      console.log('ç›‘å¬åˆ°å¼ºåˆ¶ç§»é™¤ä¿¡å·:', this.forceRemoveSource)
      this.performRemoveSourceData(this.forceRemoveSource)
      // æ¸…é™¤ä¿¡å·
      AppStorage.set(StorageKeys.FORCE_REMOVE_SOURCE, null)
    }
  }



  /**
   * å¤„ç†å¡ç‰‡æ‹–æ‹½æŠ•æ”¾
   */
  private handleCardDrop(cardIndex: number, data: ThreeLayerCardData): void {
    console.log(`handleCardDrop - å¡ç‰‡${cardIndex + 1} æ¥æ”¶åˆ°æ•°æ®:`, JSON.stringify(data.thirdLayer.chartData))
    console.log(`ğŸ” handleCardDrop - æ¥æ”¶åˆ°çš„ID:`, data.id, ' æœŸæœ›çš„ID: card_${cardIndex}')
    
    // ä½¿ç”¨æ¨¡å—åŒ–çš„å¡ç‰‡æ•°æ®ç®¡ç†å™¨ä¿®æ­£ID
    const correctedData = this.cardDataManager.correctCardId(data, cardIndex)
    
    // éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
    if (!this.cardDataManager.validateCardData(correctedData)) {
      console.error('âŒ å¡ç‰‡æ•°æ®éªŒè¯å¤±è´¥ï¼Œè·³è¿‡æ›´æ–°')
      return
    }
    
    // æ›´æ–°å…¨å±€æ•°æ®ç®¡ç†å™¨
    this.globalDataManager.updateCardData(cardIndex, correctedData)
    
    // æ›´æ–°æœ¬åœ°çŠ¶æ€
    this.cardDataList = this.globalDataManager.getCardDataList()
    console.log(`å¡ç‰‡${cardIndex + 1} å·²æ›´æ–°ç¬¬ä¸‰å±‚æ•°æ®:`, correctedData.thirdLayer)
    console.log('æ›´æ–°åçš„cardDataList:', JSON.stringify(this.cardDataList[cardIndex].thirdLayer.chartData))
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç§»é™¤æ“ä½œéœ€è¦å¤„ç†
    this.handleRemoveSourceData()
  }

  /**
   * å¤„ç†ç§»é™¤æºå¡ç‰‡æ•°æ®
   */
  private handleRemoveSourceData(): void {
    const removeData = AppStorage.get(StorageKeys.REMOVE_SOURCE_DATA) as RemoveSourceData | null
    if (removeData && removeData.sourceCardId && removeData.sourceValue) {
      console.log('å¤„ç†ç§»é™¤æºå¡ç‰‡æ•°æ®:', removeData)
      this.performRemoveSourceData(removeData)
      // æ¸…é™¤ç§»é™¤æ“ä½œæ ‡è®°
      AppStorage.set(StorageKeys.REMOVE_SOURCE_DATA, null)
    }
  }

  /**
   * æ‰§è¡Œç§»é™¤æºå¡ç‰‡æ•°æ®çš„å…·ä½“æ“ä½œ
   */
  private performRemoveSourceData(removeData: RemoveSourceData): void {
    // éªŒè¯å¡ç‰‡IDæœ‰æ•ˆæ€§
    if (!this.cardDataManager.isValidCardId(removeData.sourceCardId)) {
      console.error('âŒ æ— æ•ˆçš„å¡ç‰‡ID:', removeData.sourceCardId)
      return
    }
    
    // ä½¿ç”¨å…¨å±€æ•°æ®ç®¡ç†å™¨ç§»é™¤æ•°æ®
    this.globalDataManager.removeDataFromCard(removeData.sourceCardId, removeData.sourceValue)
    
    // æ›´æ–°æœ¬åœ°çŠ¶æ€
    this.cardDataList = this.globalDataManager.getCardDataList()
    
    // ä½¿ç”¨æ¨¡å—åŒ–ç®¡ç†å™¨è·å–å¡ç‰‡æ‘˜è¦ä¿¡æ¯
    const cardSummary = this.cardDataManager.getCardDataSummary(
      this.cardDataList[this.cardDataManager.parseCardIndex(removeData.sourceCardId)]
    )
    console.log(`å·²ä»${cardSummary}åˆ é™¤å€¼${removeData.sourceValue}çš„æ•°æ®`)
  }

  /**
   * ç»„ä»¶æ„å»ºæ–¹æ³•
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ„å»ºæ¶²ä½“å¡ç‰‡åŒºåŸŸçš„UIç»“æ„
   * - ä½¿ç”¨Scrollå’ŒFlexå¸ƒå±€å®ç°å¡ç‰‡ç½‘æ ¼æ’åˆ—
   * - é…ç½®æ»šåŠ¨æ•ˆæœå’Œæ ·å¼
   * 
   * å¸ƒå±€è¯´æ˜ï¼š
   * - ä½¿ç”¨Scrollç»„ä»¶å®ç°å‚ç›´æ»šåŠ¨
   * - ä½¿ç”¨Flexå¸ƒå±€å®ç°å¡ç‰‡ç½‘æ ¼æ’åˆ—
   * - å¡ç‰‡è‡ªåŠ¨æ¢è¡Œï¼Œå·¦å¯¹é½æ’åˆ—
   * - åŒºåŸŸé«˜åº¦å çˆ¶å®¹å™¨çš„30%
   * 
   * æ»šåŠ¨é…ç½®ï¼š
   * - æ»šåŠ¨æ–¹å‘ï¼šå‚ç›´æ»šåŠ¨
   * - æ»šåŠ¨æ¡ï¼šè‡ªåŠ¨æ˜¾ç¤ºï¼Œå®½åº¦6px
   * - æ»šåŠ¨æ•ˆæœï¼šå¼¹ç°§æ•ˆæœ
   * - æ»šåŠ¨æ‘©æ“¦ï¼š0.6ï¼Œæå‡æµç•…åº¦
   * 
   * æ ·å¼é…ç½®ï¼š
   * - èƒŒæ™¯è‰²ï¼šä½¿ç”¨ä¸»é¢˜çš„æ§åˆ¶èƒŒæ™¯è‰²
   * - è¾¹æ¡†ï¼š1pxè¾¹æ¡†ï¼Œä½¿ç”¨ä¸»é¢˜è¾¹æ¡†è‰²
   * - åœ†è§’ï¼š10px
   * - å†…è¾¹è·ï¼šå·¦å³20pxï¼Œä¸Šä¸‹0pxå’Œ4px
   */
  build() {
    Scroll() {
      Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start, alignItems: ItemAlign.Start }) {
        ForEach(this.cardDataList, (cardData: ThreeLayerCardData, idx: number) => {
          // ä½¿ç”¨æ–°çš„ä¸‰å±‚å¡ç‰‡
          ThreeLayerCard({
            cardData: cardData,
            cardWidth: 120,
            cardHeight: 160,
            mainColor: this.getCurrentTheme().primary,
            enableWave: idx < this.getWaveCount() && (!cardData.thirdLayer.chartData || cardData.thirdLayer.chartData.length === 0),
            onCardDrop: (data: ThreeLayerCardData) => {
              this.handleCardDrop(idx, data)
            }
          })
          .margin({ right: 6, bottom: 6 })
        })
      }
      .width('100%')
    }
    .width('100%')
    .height('36%') // æ¶²ä½“å¡ç‰‡åŒºåŸŸå 36%
    // æ‹–æ‹½æ¿€æ´»æ—¶ç¦ç”¨æ»šåŠ¨ï¼Œé¿å…æŠ¢å onDropäº‹ä»¶
    .enabled(!this.gridDragActive)
    .scrollable(ScrollDirection.Vertical)
    .scrollBar(BarState.Auto)
    .edgeEffect(EdgeEffect.Spring)
    .scrollBarColor(this.getCurrentTheme().borderColor)
    .scrollBarWidth(6)
    .friction(0.6) // è¿›ä¸€æ­¥å‡å°‘æ‘©æ“¦ç³»æ•°ï¼Œæå‡æµç•…åº¦
    .padding({ left: 20, right: 20, top: 0, bottom: 4 })
    .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
    .border({ width: 1, color: this.getCurrentTheme().borderColor })
    .borderRadius(10)
    .onAppear(() => {
      this.initializeCardData()
    })
  }

}
