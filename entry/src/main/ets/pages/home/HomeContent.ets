 /**
 * ä¸»é¡µå†…å®¹ç»„ä»¶
 * åŠŸèƒ½ï¼šæ˜¾ç¤ºä¸»é¡µç›¸å…³çš„å†…å®¹å’ŒåŠŸèƒ½
 * ç”¨é€”ï¼šåœ¨Homeé¡µé¢ä¸­ä½œä¸ºä¸»é¡µå†…å®¹æ˜¾ç¤º
 */

import { OmniThemeManager, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { IBestSwitch } from '@ibestservices/ibest-ui'
import { SwitchControl } from '../../components/ui/SwitchControl'
import { TableRow } from '../../components/layout/LevelTable'
import { DataTablesTabBar } from './DataTablesTabBar'
import { DragData } from '../../components/layout/DraggableGridTable'
import { TOP_PRODUCTION_TON_H, TOP_SUM_WEIGHT_TON, TOP_SUM_COUNTS, TOP_AVG_G, TOP_USER_NAME, TOP_STATUS_TEXT, TOP_ALERT_HIDE, HOME_SELECTED_FSM, HOME_SETTING1_ENABLED, HOME_SETTING2_ENABLED, HOME_SETTING3_ENABLED, HOME_SETTING4_ENABLED, HOME_SELECTED_BUTTON } from '../../constants/TopBarKeys'
// å¯¼å…¥æ–°çš„ç»„ä»¶
import { SortingInfoCard } from './SortingInfoCard'
import { LiquidCardsArea } from './LiquidCardsArea'
import { StorageKeys } from '../../utils/constants/StorageKeys'
import { getCurrentCellDragData, CELL_DRAG_ACTIVE_KEY } from '../../components/ui/SimpleDraggableCell'
import { OutletDialog } from './OutletDialog'
import { HomeDataManager } from './core/HomeDataManager'
import { HomeEventHandler } from './core/HomeEventHandler'
import { HomeStateManager } from './core/HomeStateManager'
import { HomeState, DEFAULT_HOME_STATE } from './core/HomeState'
import { DEFAULT_TOP_BAR_DATA, DEFAULT_SORTING_INFO, DEFAULT_SETTINGS, DEFAULT_SELECTED_BUTTON, DEFAULT_SELECTED_FSM } from './HomeConstants'

// ç¡®ä¿å…¨å±€AppStorageé”®åœ¨ç»„ä»¶æ„å»ºå‰å·²å­˜åœ¨ï¼ˆä¾› SortingInfoCard @StorageLink ä½¿ç”¨ï¼‰
// æ¨¡å—åŠ è½½æ—¶å³åˆå§‹åŒ–ï¼Œé¿å…é¦–å¸§ä¸ºç©ºå¯¼è‡´ä¸è”åŠ¨
(() => {
  try {
    AppStorage.setOrCreate('START_TIME', '--:--:--')
    AppStorage.setOrCreate('PROGRAM_NAME', 'æœªé€‰æ‹©')
    AppStorage.setOrCreate('SORT_SPEED', '0 ä»¶/åˆ†é’Ÿ')
    AppStorage.setOrCreate('REALTIME_OUTPUT', '0 ä»¶/åˆ†é’Ÿ')
    AppStorage.setOrCreate('BATCH_COUNT', '0 ä»¶')
    AppStorage.setOrCreate('AVG_WEIGHT', '0.00 kg')
    AppStorage.setOrCreate('BATCH_WEIGHT', '0.00 kg')
    AppStorage.setOrCreate('EFFICIENCY', '0%')
    AppStorage.setOrCreate('INTERVAL_SPEED', '0 ms')
  } catch (e) {
    console.error('åˆå§‹åŒ–å…¨å±€åˆ†é€‰ä¿¡æ¯é”®å¤±è´¥:', e)
  }
})()

// [TODO æé†’ - é‡è¦]
// SwitchWrapper ä¸ IBestSwitch çš„åŒå‘ç»‘å®šæ³¨æ„ï¼š
// å½“å‰ SwitchWrapper ä½¿ç”¨ @Prop isEnabledï¼Œå¹¶åœ¨ IBestSwitch.value ä¸Šä¼ å…¥ $isEnabledã€‚
// åœ¨ ArkTS ä¸­ï¼Œ$ è¯­æ³•è¦æ±‚å¼•ç”¨çš„æ˜¯ @State/@Linkï¼›@Prop ä¸ºåªè¯»ï¼Œå¯èƒ½å¯¼è‡´ç»‘å®šæ— æ•ˆæˆ–äº§ç”Ÿä¸å¯é¢„æœŸè¡Œä¸ºã€‚
// åç»­ä¿®å¤å¯é€‰æ–¹æ¡ˆï¼š
// A) å°† SwitchWrapper çš„ isEnabled æ”¹ä¸º @Linkï¼›çˆ¶ç»„ä»¶ä¼ å…¥ $settingXEnabledï¼›å†…éƒ¨ç»§ç»­ä½¿ç”¨ value: $isEnabledï¼›
// B) åœ¨ SwitchWrapper å†…ä½¿ç”¨ @State localEnabled è‡ªç®¡ç†ï¼Œå¹¶åœ¨ onBeforeChange åŒæ­¥ä¸å›è°ƒ onToggle é€šçŸ¥çˆ¶å±‚ï¼›
// æš‚ä»…è®°å½•æé†’ï¼Œå¾…ç¨åæŒ‰ç¡®å®šæ–¹æ¡ˆç»Ÿä¸€ä¿®æ”¹ã€‚
// IBestSwitch åŒ…è£…ï¼Œè§£å†³ value ä¸º @Link çš„ç»‘å®šéœ€æ±‚
@Component
struct SwitchWrapper {
  @Prop isEnabled: boolean = false
  onToggle: () => void = () => {}

  build() {
    IBestSwitch({
      value: $isEnabled, // åŒå‘ç»‘å®šåˆ°æœ¬åœ° isEnabled
      switchSize: 24,
      activeColor: '#EA7A10',
      inactiveColor: '#E0E0E0',
      onBeforeChange: (_next: boolean) => {
        // ç›´æ¥æ‰§è¡Œåˆ‡æ¢ï¼Œå‡å°‘Promiseå¼€é”€
        this.onToggle()
        return Promise.resolve(true)
      }
    })
  }
}

@Component
export struct HomeContent {
  // æ•°æ®ç®¡ç†å™¨
  private dataManager = new HomeDataManager()
  // äº‹ä»¶å¤„ç†å™¨
  private eventHandler = new HomeEventHandler()
  // çŠ¶æ€ç®¡ç†å™¨
  private stateManager = new HomeStateManager()
  // çŠ¶æ€ç®¡ç†ï¼ˆç§»é™¤æœªä½¿ç”¨çš„ HomeState å®ä¾‹ï¼Œæ”¹ç”± DEFAULT_HOME_STATE ä½œåˆå§‹åŒ–æ¥æºï¼‰

  // ==================== çŠ¶æ€å˜é‡ï¼ˆç”¨äºUIç»‘å®šï¼‰ ====================
  // è¿™äº› @State å˜é‡ä¸çŠ¶æ€ç®¡ç†å™¨åŒæ­¥ï¼Œç¡®ä¿UIèƒ½æ­£ç¡®å“åº”çŠ¶æ€å˜åŒ–
  
  @StorageLink(HOME_SELECTED_FSM) private selectedFSM: 'FSM1' | 'FSM2' = DEFAULT_HOME_STATE.selectedFSM
  @StorageLink(HOME_SETTING1_ENABLED) private setting1Enabled: boolean = DEFAULT_HOME_STATE.setting1Enabled
  @StorageLink(HOME_SETTING2_ENABLED) private setting2Enabled: boolean = DEFAULT_HOME_STATE.setting2Enabled
  @StorageLink(HOME_SETTING3_ENABLED) private setting3Enabled: boolean = DEFAULT_HOME_STATE.setting3Enabled
  @StorageLink(HOME_SETTING4_ENABLED) private setting4Enabled: boolean = DEFAULT_HOME_STATE.setting4Enabled
  @StorageLink(HOME_SELECTED_BUTTON) private selectedButton: string = DEFAULT_HOME_STATE.selectedButton
  @State private showOutletDialog: boolean = DEFAULT_HOME_STATE.showOutletDialog
  @State private currentOutletIndex: number = DEFAULT_HOME_STATE.currentOutletIndex
  @State private topProduction: string = DEFAULT_HOME_STATE.topProduction
  @State private topSumWeightTon: string = DEFAULT_HOME_STATE.topSumWeightTon
  @State private topSumCounts: string = DEFAULT_HOME_STATE.topSumCounts
  @State private topAvgG: string = DEFAULT_HOME_STATE.topAvgG
  @State private sortSpeed: string = DEFAULT_HOME_STATE.sortSpeed
  @State private batchWeight: string = DEFAULT_HOME_STATE.batchWeight
  @State private batchCount: string = DEFAULT_HOME_STATE.batchCount
  @State private startTime: string = DEFAULT_HOME_STATE.startTime
  @State private programName: string = DEFAULT_HOME_STATE.programName
  @State private efficiency: string = DEFAULT_HOME_STATE.efficiency
  @State private avgWeight: string = DEFAULT_HOME_STATE.avgWeight
  @State private realTimeOutput: string = DEFAULT_HOME_STATE.realTimeOutput
  @State private intervalSpeed: string = DEFAULT_HOME_STATE.intervalSpeed
  // æ¨¡æ‹Ÿå®æ—¶æ•°æ®å®šæ—¶å™¨
  private mockSortingInfoTimerId?: number
  
  // æ—¶é—´æ›´æ–°å®šæ—¶å™¨
  private timeUpdateTimerId?: number
  // ==================== æ‹–æ‹½æµ®å±‚é¢„è§ˆçŠ¶æ€ ====================
  @State private dragOverlayActive: boolean = false
  @State private dragOverlayX: number = 0
  @State private dragOverlayY: number = 0
  @State private dragOverlayText: string = ''
  // ç­‰çº§ç»Ÿè®¡æ›´æ–°äº‹ä»¶ç›‘å¬ï¼ˆç®€åŒ–è´Ÿè½½ï¼‰
  @StorageLink(StorageKeys.LEVEL_STAT_UPDATE) private levelStatUpdate: Record<string, number | string> | null = null
  // æ‰¹é‡è¿½åŠ ï¼ˆå¤šé€‰ä»…æ·»åŠ ï¼‰
  @StorageLink(StorageKeys.LEVEL_STAT_UPDATE_BATCH) private levelStatUpdateBatch: Record<string, number | string | string[]> | null = null
  @StorageLink(StorageKeys.LEVEL_STAT_REMOVE) private levelStatRemove: Record<string, number | string> | null = null
  @State private statsVersion: number = 0
  @State private tablesRefreshKey: number = 0
  


  // ç”Ÿæˆä» start å¼€å§‹ã€é•¿åº¦ä¸º count çš„æ•°å­—åºåˆ—ï¼ˆç±»å‹å®‰å…¨ï¼‰
  private buildNumberRange(start: number, count: number): number[] {
    const result: number[] = []
    for (let i = 0; i < count; i++) {
      result.push(start + i)
    }
    return result
  }

  

  /**
   * è·å–æŒ‡å®šè¡¨æ ¼çš„æ•°æ®
   * @param tableName è¡¨æ ¼åå­—
   * @returns è¡¨æ ¼æ•°æ®
   */
  private getTableData(tableName: string): TableRow[] {
    return this.dataManager.getTableData(tableName)
  }

  // åˆ†é€‰ä¿¡æ¯ï¼ˆå ä½æ•°æ®ï¼‰
  // åç»­æ¥å…¥çœŸå®æ•°æ®å»ºè®®ï¼š
  // 1) æ•°æ®æ¥æºï¼š
  //    - è®¾å¤‡/æœåŠ¡å±‚ï¼ˆæœ¬åœ°ServiceAbility/åˆ†é€‰æœºSDKï¼‰ã€
  //    - åç«¯æ¥å£ï¼ˆHTTP/WebSocket/MQTTï¼‰ã€
  //    - æœ¬åœ°ç¼“å­˜ï¼ˆé¦–å±å ä½ï¼‰ã€‚
  // 2) è®¢é˜…æ—¶æœºï¼š
  //    - aboutToAppear() ä¸­å‘èµ·è®¢é˜…/è½®è¯¢/è¿æ¥ï¼›
  //    - aboutToDisappear() ä¸­å–æ¶ˆè®¢é˜…/å…³é—­è¿æ¥ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚
  // 3) æ›´æ–°æ–¹å¼ï¼š
  //    - æ”¶åˆ°æ–°æ•°æ®åç›´æ¥èµ‹å€¼åˆ°ä»¥ä¸‹ @State å­—æ®µï¼ŒUIä¼šè‡ªåŠ¨åˆ·æ–°ï¼›
  //    - æ³¨æ„åœ¨UIçº¿ç¨‹æ›´æ–°ï¼›å¦‚æœ‰è€—æ—¶è®¡ç®—ï¼Œè¯·åœ¨åå°å®Œæˆåå†setã€‚
  // 4) æ ¼å¼åŒ–ï¼š
  //    - é€Ÿåº¦: å°†åŸå§‹æ•°å€¼æ ¼å¼åŒ–ä¸º `${value} ä»¶/åˆ†é’Ÿ`ï¼›
  //    - é‡é‡: ä½¿ç”¨å›ºå®šå°æ•°ä½ï¼Œå¦‚ `${kg.toFixed(2)} kg`ï¼›
  //    - ä¸ªæ•°: `${count} ä»¶`ï¼›
  //    - æ—¶é—´: å°†æ—¶é—´æˆ³æ ¼å¼åŒ–ä¸º `HH:mm:ss`ï¼›
  //    - ç¨‹åº: å–å½“å‰æ­£åœ¨è¿è¡Œçš„ç¨‹åºåï¼›
  //    - æ•ˆç‡: ç™¾åˆ†æ¯” `${(ratio*100).toFixed(0)}%`ã€‚

  // è·å–å½“å‰ä¸»é¢˜é…ç½®çš„æ–¹æ³•
  getCurrentTheme(): ExtendedOmniThemeStyle {
    return OmniThemeManager.getInstance().getCurrentTheme()
  }

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºæœ€åä¸€ä¸ªå¼€å¯çš„è®¾ç½®
   * @param currentIndex å½“å‰è®¾ç½®çš„ç´¢å¼•
   * @returns æ˜¯å¦ä¸ºæœ€åä¸€ä¸ªå¼€å¯çš„è®¾ç½®
   */
  private isLastEnabledSetting(currentIndex: number): boolean {
    const settings = [this.setting1Enabled, this.setting2Enabled, this.setting3Enabled, this.setting4Enabled]
    const enabledCount = settings.filter(enabled => enabled).length
    
    // å¦‚æœåªæœ‰ä¸€ä¸ªè®¾ç½®å¼€å¯ï¼Œä¸”å½“å‰è®¾ç½®æ˜¯å¼€å¯çš„ï¼Œåˆ™ä¸èƒ½å…³é—­
    return enabledCount === 1 && settings[currentIndex]
  }

  // åˆ‡æ¢FSMçŠ¶æ€
  private switchFSM(fsm: 'FSM1' | 'FSM2'): void {
    this.selectedFSM = fsm
    this.stateManager.updateSelectedFSM(fsm)
    this.eventHandler.switchFSM(fsm)
    
    // æ›´æ–°æ•°æ®ç®¡ç†å™¨çš„FSMçŠ¶æ€
    this.dataManager.setFSM(fsm)
    
    // æ›´æ–°é¡¶éƒ¨çŠ¶æ€æ 
    this.updateTopBarForFSM()
    
    console.log(`ä¸»é¡µåˆ‡æ¢åˆ°${fsm}ï¼Œæ•°æ®å·²æ›´æ–°`)
  }

  // è®¾ç½®å¼€å…³æ˜ å°„è¡¨
  private settingMap: Record<string, () => boolean> = {
    'è®¾ç½®1': () => this.setting1Enabled,
    'è®¾ç½®2': () => this.setting2Enabled,
    'è®¾ç½®3': () => this.setting3Enabled,
    'è®¾ç½®4': () => this.setting4Enabled
  }

  // è®¾ç½®çŠ¶æ€æ›´æ–°æ˜ å°„è¡¨
  private settingUpdateMap: Record<string, (value: boolean) => void> = {
    'è®¾ç½®1': (value: boolean) => { 
      this.setting1Enabled = value
      this.stateManager.updateSetting1Enabled(value)
    },
    'è®¾ç½®2': (value: boolean) => { 
      this.setting2Enabled = value
      this.stateManager.updateSetting2Enabled(value)
    },
    'è®¾ç½®3': (value: boolean) => { 
      this.setting3Enabled = value
      this.stateManager.updateSetting3Enabled(value)
    },
    'è®¾ç½®4': (value: boolean) => { 
      this.setting4Enabled = value
      this.stateManager.updateSetting4Enabled(value)
    }
  }

  // åˆ‡æ¢è®¾ç½®å¼€å…³ï¼ˆäº’æ–¥æ¨¡å¼ - åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªå¼€å¯ï¼‰
  private toggleSetting(setting: 'è®¾ç½®1' | 'è®¾ç½®2' | 'è®¾ç½®3' | 'è®¾ç½®4'): void {
    // å¦‚æœå½“å‰å¼€å…³æ˜¯å¼€å¯çŠ¶æ€ï¼Œåˆ™å…³é—­å®ƒ
    if (this.settingMap[setting]()) {
      this.settingUpdateMap[setting](false)
    } else {
      // å¦‚æœå½“å‰å¼€å…³æ˜¯å…³é—­çŠ¶æ€ï¼Œåˆ™å…ˆå…³é—­æ‰€æœ‰å¼€å…³ï¼Œå†å¼€å¯å½“å‰å¼€å…³
      this.setting1Enabled = false
      this.setting2Enabled = false
      this.setting3Enabled = false
      this.setting4Enabled = false
      this.stateManager.updateSetting1Enabled(false)
      this.stateManager.updateSetting2Enabled(false)
      this.stateManager.updateSetting3Enabled(false)
      this.stateManager.updateSetting4Enabled(false)

      // å¼€å¯å½“å‰é€‰ä¸­çš„å¼€å…³
      this.settingUpdateMap[setting](true)
    }

    // è°ƒç”¨äº‹ä»¶å¤„ç†å™¨
    this.eventHandler.toggleSetting(setting)
  }

  // é€‰æ‹©åŠŸèƒ½æŒ‰é’®
  private selectButton(buttonName: string): void {
    this.selectedButton = buttonName
    this.stateManager.updateSelectedButton(buttonName)
    this.eventHandler.selectButton(buttonName)
  }

  // æ·»åŠ æ•°æ®åˆ°è¡¨æ ¼çš„å°è£…å‡½æ•°
  private addDataToTables(): void {
    // ä½¿ç”¨æ•°æ®ç®¡ç†å™¨åˆå§‹åŒ–æ•°æ®
    this.dataManager.initializeAllTableData()  //åˆå§‹åŒ–æ•°æ®
  }

  // å¤„ç†ç­‰çº§ç»Ÿè®¡æ›´æ–°ï¼šä¸ºæŒ‡å®šç­‰çº§è¿½åŠ å‡ºå£ç¼–å·ï¼ˆå»é‡ï¼‰
  private applyLevelStatUpdate(levelName: string, exitNum: number): void {
    console.log(`ğŸ”„ å¼€å§‹å¤„ç†ç­‰çº§ç»Ÿè®¡æ›´æ–°: ç­‰çº§=${levelName}, å‡ºå£=${exitNum}`)
    const tableName = 'ç­‰çº§ç»Ÿè®¡è¡¨'
    const rows: TableRow[] = this.dataManager.getTableData(tableName)
    console.log(`ğŸ“Š å½“å‰ç­‰çº§ç»Ÿè®¡è¡¨æ•°æ®:`, rows)
    const idx: number = rows.findIndex((r: TableRow) => String(r && r[0]) === levelName)
    console.log(`ğŸ” æŸ¥æ‰¾ç­‰çº§è¡Œç´¢å¼•: ${idx}`)
    if (idx < 0) {
      console.warn(`âŒ æœªåœ¨${tableName}ä¸­æ‰¾åˆ°ç­‰çº§è¡Œ:`, levelName)
      return
    }
    const updatedRow: TableRow = [...rows[idx]]
    console.log(`ğŸ“ åŸå§‹è¡Œæ•°æ®:`, updatedRow)
    const exitColIndex = 2 // ç­‰çº§å‡ºå£
    const currentVal: string = String(updatedRow[exitColIndex] || '').trim()
    console.log(`ğŸ“‹ å½“å‰å‡ºå£å€¼: "${currentVal}"`)
    const entry = `å‡ºå£${exitNum}`
    let nextVal: string
    if (!currentVal) {
      nextVal = entry
    } else if (currentVal.indexOf(entry) >= 0) {
      nextVal = currentVal
    } else {
      nextVal = `${currentVal}ã€${entry}`
    }
    console.log(`ğŸ†• æ–°å‡ºå£å€¼: "${nextVal}"`)
    updatedRow[exitColIndex] = nextVal

    const newRows: TableRow[] = [...rows]
    newRows[idx] = updatedRow
    console.log(`ğŸ’¾ æ›´æ–°åçš„å®Œæ•´æ•°æ®:`, newRows)
    this.dataManager.clearTableData(tableName)
    this.dataManager.addTableData(tableName, newRows)
    this.statsVersion++
    console.log(`âœ… ç­‰çº§ç»Ÿè®¡å·²æ›´æ–°: ç­‰çº§=${levelName}, æ–°å‡ºå£åˆ—=${nextVal}`)
  }

  // å¤„ç†ç­‰çº§ç»Ÿè®¡ç§»é™¤ï¼šä¸ºæŒ‡å®šç­‰çº§ç§»é™¤æŸä¸ªå‡ºå£ç¼–å·
  private applyLevelStatRemove(levelName: string, exitNum: number): void {
    const tableName = 'ç­‰çº§ç»Ÿè®¡è¡¨'
    const rows: TableRow[] = this.dataManager.getTableData(tableName)
    const idx: number = rows.findIndex((r: TableRow) => String(r && r[0]) === levelName)
    if (idx < 0) {
      console.warn(`æœªåœ¨${tableName}ä¸­æ‰¾åˆ°ç­‰çº§è¡Œ:`, levelName)
      return
    }
    const updatedRow: TableRow = [...rows[idx]]
    const exitColIndex = 2 // ç­‰çº§å‡ºå£
    const currentVal: string = String(updatedRow[exitColIndex] || '').trim()
    const entry = `å‡ºå£${exitNum}`
    if (!currentVal) { return }
    const items = currentVal.split('ã€').map(s => s.trim()).filter(Boolean)
    const nextItems = items.filter(s => s !== entry)
    const nextVal = nextItems.join('ã€')
    updatedRow[exitColIndex] = nextVal

    const newRows: TableRow[] = [...rows]
    newRows[idx] = updatedRow
    this.dataManager.clearTableData(tableName)
    this.dataManager.addTableData(tableName, newRows)
    this.statsVersion++
    console.log(`ğŸ—‘ï¸ ç­‰çº§ç»Ÿè®¡å·²ç§»é™¤: ç­‰çº§=${levelName}, ç§»é™¤å‡ºå£=${exitNum}, æ–°å‡ºå£åˆ—=${nextVal}`)
  }


  // å¤„ç†å‡ºå£æŒ‰é’®ç‚¹å‡»
  private handleOutletClick(outletNumber: number): void {
    this.currentOutletIndex = outletNumber
    this.showOutletDialog = true
    this.stateManager.updateCurrentOutletIndex(outletNumber)
    this.stateManager.updateShowOutletDialog(true)
    this.eventHandler.handleOutletClick(outletNumber)
  }

  // åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªå‡ºå£
  private switchToPreviousOutlet(): void {
    const newIndex = this.currentOutletIndex > 1 ? this.currentOutletIndex - 1 : 9
    this.currentOutletIndex = newIndex
    this.stateManager.updateCurrentOutletIndex(newIndex)
    this.eventHandler.handleOutletPrevious()
  }

  // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå‡ºå£
  private switchToNextOutlet(): void {
    const newIndex = this.currentOutletIndex < 9 ? this.currentOutletIndex + 1 : 1
    this.currentOutletIndex = newIndex
    this.stateManager.updateCurrentOutletIndex(newIndex)
    this.eventHandler.handleOutletNext()
  }

  // ç¡®è®¤å‡ºå£è®¾ç½®
  private confirmOutletSetting(): void {
    this.showOutletDialog = false
    this.stateManager.updateShowOutletDialog(false)
    this.eventHandler.handleOutletConfirm()
  }

  // å–æ¶ˆå‡ºå£è®¾ç½®
  private cancelOutletSetting(): void {
    this.showOutletDialog = false
    this.stateManager.updateShowOutletDialog(false)
    this.eventHandler.handleOutletCancel()
  }



  // å°†åŸæ¥çš„buildæ–¹æ³•å†…å®¹æå–ä¸ºå•ç‹¬çš„æ–¹æ³•
  @Builder
  private buildMainContent() {
    Column() {
      // è®¾ç½®å¼€å…³åŒºåŸŸï¼ˆFSMåˆ‡æ¢å·²ç§»è‡³é¡¶éƒ¨çŠ¶æ€æ ï¼‰
      Row() {
        SwitchControl({ 
          label: 'è®¾ç½®1', 
          isEnabled: $setting1Enabled, 
          isLastEnabled: this.isLastEnabledSetting(0),
          onToggle: () => { this.toggleSetting('è®¾ç½®1') } 
        })
        SwitchControl({ 
          label: 'è®¾ç½®2', 
          isEnabled: $setting2Enabled, 
          isLastEnabled: this.isLastEnabledSetting(1),
          onToggle: () => { this.toggleSetting('è®¾ç½®2') } 
        })
        SwitchControl({ 
          label: 'è®¾ç½®3', 
          isEnabled: $setting3Enabled, 
          isLastEnabled: this.isLastEnabledSetting(2),
          onToggle: () => { this.toggleSetting('è®¾ç½®3') } 
        })
        SwitchControl({ 
          label: 'è®¾ç½®4', 
          isEnabled: $setting4Enabled, 
          isLastEnabled: this.isLastEnabledSetting(3),
          onToggle: () => { this.toggleSetting('è®¾ç½®4') } 
        })
      }
      .justifyContent(FlexAlign.End)
      .alignItems(VerticalAlign.Center)
      .padding({ top: 0, left: 0, right: 20, bottom: '1%' })
      // ä¸»é¡µä¿¡æ¯å¡ç‰‡ï¼šåˆ†é€‰é€Ÿåº¦ | æœ¬æ‰¹é‡é‡ | æœ¬æ‰¹ä¸ªæ•° | å¼€å§‹æ—¶é—´ | åˆ†é€‰ç¨‹åº | åˆ†é€‰æ•ˆç‡ | å¹³å‡é‡é‡ | å®æ—¶äº§é‡ | é—´éš”é€Ÿåº¦
      SortingInfoCard()
      .margin({ bottom: '1%' })

      // æ¶²ä½“å¡ç‰‡åŒºåŸŸï¼šå•å®¹å™¨è‡ªåŠ¨æ¢è¡Œï¼Œå›ºå®šæ˜¾ç¤ºä¸¤æ’é«˜åº¦ï¼Œæ”¯æŒçºµå‘æ»šåŠ¨æŸ¥çœ‹æ›´å¤š
      LiquidCardsArea()
      .margin({ bottom: '0.5%' })

      // æ•°æ®è¡¨æ ¼TabBarç»„ä»¶ - æ›¿æ¢åŸæœ‰çš„FunctionButtonså’ŒDataTablesCard
      DataTablesTabBar({
        levelTableData: this.getTableData('ç­‰çº§è¡¨'),
        containerTableData: this.getTableData('å®¹å™¨è¡¨'),
        statisticsTableData: this.getTableData('ç­‰çº§ç»Ÿè®¡è¡¨'),
        dynamicPackingTableData: this.getTableData('åŠ¨æ€è£…ç®±'),
        finishedProductsTableData: this.getTableData('æˆå“'),
        levelTableDragData: [],
        containerTableDragData: [],
        statisticsTableDragData: [],
        dynamicPackingTableDragData: [],
        finishedProductsTableDragData: [],
        refreshKey: this.tablesRefreshKey,
        onRowDragStart: (dragData: DragData) => {
          console.log('ä¸»é¡µæ¥æ”¶åˆ°æ‹–æ‹½å¼€å§‹:', dragData)
        },
        onRowDragEnd: () => {
          console.log('ä¸»é¡µæ¥æ”¶åˆ°æ‹–æ‹½ç»“æŸ')
        }
      })
      .width('100%')
      .height('50%') // è¡¨æ ¼åŒºåŸŸå 50%
      .margin({ bottom: 0 })



      
    }
    .width('100%')
    .height('100%')
    .alignItems(HorizontalAlign.Start)
    .justifyContent(FlexAlign.Start)
  }

  build() {
    Stack() {
      // ä¸»è¦å†…å®¹
      this.buildMainContent()
      // ä¾¦å¬ç­‰çº§ç»Ÿè®¡æ›´æ–°äº‹ä»¶ï¼ˆUIè¯­æ³•åŒ…è£¹ï¼Œé€»è¾‘åœ¨å›è°ƒå†…ï¼‰
      if (this.levelStatUpdate && typeof this.levelStatUpdate['levelName'] === 'string' && typeof this.levelStatUpdate['exit'] !== 'undefined') {
        Blank()
          .onAppear(() => {
            console.log(`ğŸ¯ æ£€æµ‹åˆ°ç­‰çº§ç»Ÿè®¡æ›´æ–°äº‹ä»¶:`, this.levelStatUpdate)
            const ln = String(this.levelStatUpdate!['levelName'])
            const ex = Number(this.levelStatUpdate!['exit'])
            console.log(`ğŸ¯ è§£æäº‹ä»¶å‚æ•°: ç­‰çº§=${ln}, å‡ºå£=${ex}`)
            AppStorage.set(StorageKeys.LEVEL_STAT_UPDATE, null)
            this.applyLevelStatUpdate(ln, ex)
            this.tablesRefreshKey++
          })
      }
      if (this.levelStatUpdateBatch && Array.isArray(this.levelStatUpdateBatch['levelNames']) && typeof this.levelStatUpdateBatch['exit'] !== 'undefined') {
        Blank()
          .onAppear(() => {
            const arrRaw = this.levelStatUpdateBatch!['levelNames']
            const arr: string[] = Array.isArray(arrRaw) ? (arrRaw as string[]) : []
            const ex = Number(this.levelStatUpdateBatch!['exit'])
            AppStorage.set(StorageKeys.LEVEL_STAT_UPDATE_BATCH, null)
            arr.forEach((ln) => {
              if (ln && ln.length > 0) {
                this.applyLevelStatUpdate(ln, ex)
              }
            })
            this.tablesRefreshKey++
          })
      }
      
      if (this.levelStatRemove && typeof this.levelStatRemove['levelName'] === 'string' && typeof this.levelStatRemove['exit'] !== 'undefined') {
        Blank()
          .onAppear(() => {
            const ln = String(this.levelStatRemove!['levelName'])
            const ex = Number(this.levelStatRemove!['exit'])
            AppStorage.set(StorageKeys.LEVEL_STAT_REMOVE, null)
            this.applyLevelStatRemove(ln, ex)
            this.tablesRefreshKey++
          })
      }
      
        // å‡ºå£è®¾ç½®å¯¹è¯æ¡† - æ”¾åœ¨Stackçš„æœ€ä¸Šå±‚
        OutletDialog({
          isVisible: this.showOutletDialog,
          currentOutletIndex: this.currentOutletIndex,
          onPrevious: () => {
            this.switchToPreviousOutlet()
          },
          onNext: () => {
            this.switchToNextOutlet()
          },
          onConfirm: () => {
            this.confirmOutletSetting()
          },
          onCancel: () => {
            this.cancelOutletSetting()
          }
        })
      // æ‹–æ‹½é¢„è§ˆæµ®å±‚ï¼ˆè·ŸéšæŒ‡é’ˆï¼‰
      if (this.dragOverlayActive) {
        // åŠé€æ˜æ ‡ç­¾ï¼Œæ˜¾ç¤ºè¢«æ‹–æ‹½çš„å•å…ƒæ ¼å†…å®¹
        Text(this.dragOverlayText || '')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.Black)
          .backgroundColor('#FFFFFFB0')
          .borderRadius(8)
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .opacity(0.92)
          .position({ x: this.dragOverlayX - 20, y: this.dragOverlayY - 20 })
          .enabled(false)
          .zIndex(9999)
      }
    }
    .width('100%')
    .height('100%')
    // ç»Ÿä¸€è·Ÿè¸ªè§¦æ‘¸åæ ‡ä¸æ‹–æ‹½æ¿€æ´»çŠ¶æ€
    .onTouch((event?: TouchEvent) => {
      if (!event) { return }
      const t = event.touches && event.touches.length > 0 ? event.touches[0] : undefined
      // åŒæ­¥æ‹–æ‹½æ¿€æ´»çŠ¶æ€
      const active = (AppStorage.get(CELL_DRAG_ACTIVE_KEY) as boolean) === true
      if (!active) {
        // æœªå¤„äºæ‹–æ‹½æ¿€æ´»ï¼Œå¼ºåˆ¶éšè—å¹¶æ¸…ç©ºæµ®å±‚æ–‡æœ¬ï¼Œé¿å…æ®‹ç•™
        if (this.dragOverlayActive || this.dragOverlayText) {
          this.dragOverlayActive = false
          this.dragOverlayText = ''
        }
      } else {
        // æ¿€æ´»æ—¶é¦–æ¬¡æ˜¾ç¤ºæ—¶åŒæ­¥å½“å‰æ‹–æ‹½æ–‡æœ¬
        if (!this.dragOverlayActive) {
          const d = getCurrentCellDragData()
          this.dragOverlayText = d ? String(d.value ?? '') : ''
        }
        this.dragOverlayActive = true
      }
      // åæ ‡è·Ÿè¸ªï¼ˆä½¿ç”¨å±å¹•åæ ‡ï¼Œé€‚é… Stack é¡¶å±‚ï¼‰
      if (t) {
        // ä½¿ç”¨ç›¸å¯¹äºå½“å‰ Stack çš„æœ¬åœ°åæ ‡ï¼Œé¿å…å±å¹•åæ ‡å¯¼è‡´çš„åç§»
        this.dragOverlayX = t.x
        this.dragOverlayY = t.y
      }
      // æŠ¬æ‰‹æ—¶è‹¥æœªè¢«ç›®æ ‡æ¥æ”¶ï¼Œä¹Ÿéšè—æµ®å±‚
      if (event.type === TouchType.Up) {
        this.dragOverlayActive = false
        this.dragOverlayText = ''
      }
    })
  }

  aboutToAppear() {
    // æ ¹æ®FSMçŠ¶æ€åˆå§‹åŒ–é¡¶éƒ¨çŠ¶æ€æ å››é¡¹æŒ‡æ ‡
    this.updateTopBarForFSM()
    // åˆå§‹åŒ–ç”¨æˆ·ä¸çŠ¶æ€
    AppStorage.setOrCreate(TOP_USER_NAME, 'ç®¡ç†å‘˜')
    AppStorage.setOrCreate(TOP_STATUS_TEXT, '')
    AppStorage.setOrCreate(TOP_ALERT_HIDE, false)

    // åˆå§‹åŒ–ä¸»é¡µçŠ¶æ€ï¼ˆæ–°å¢çš„@StorageLinkå˜é‡ï¼‰
    AppStorage.setOrCreate(HOME_SELECTED_FSM, this.selectedFSM)
    AppStorage.setOrCreate(HOME_SETTING1_ENABLED, this.setting1Enabled)
    AppStorage.setOrCreate(HOME_SETTING2_ENABLED, this.setting2Enabled)
    AppStorage.setOrCreate(HOME_SETTING3_ENABLED, this.setting3Enabled)
    AppStorage.setOrCreate(HOME_SETTING4_ENABLED, this.setting4Enabled)
    AppStorage.setOrCreate(HOME_SELECTED_BUTTON, this.selectedButton)

    // åˆå§‹åŒ–è¡¨æ ¼æ•°æ®
    this.addDataToTables()

    // è®¾ç½®å¼€å§‹æ—¶é—´ä¸ºå½“å‰æ—¶é—´ï¼ˆä»…é¦–æ¬¡è¿›å…¥æ—¶ï¼‰
    const now = new Date()
    const hh = String(now.getHours()).padStart(2, '0')
    const mm = String(now.getMinutes()).padStart(2, '0')
    const ss = String(now.getSeconds()).padStart(2, '0')
    this.startTime = `${hh}:${mm}:${ss}`
    AppStorage.setOrCreate('START_TIME', this.startTime)
    AppStorage.setOrCreate('PROGRAM_NAME', this.programName)
    AppStorage.setOrCreate('SORT_SPEED', this.sortSpeed)
    AppStorage.setOrCreate('REALTIME_OUTPUT', this.realTimeOutput)
    AppStorage.setOrCreate('BATCH_COUNT', this.batchCount)
    AppStorage.setOrCreate('AVG_WEIGHT', this.avgWeight)
    AppStorage.setOrCreate('BATCH_WEIGHT', this.batchWeight)
    AppStorage.setOrCreate('EFFICIENCY', this.efficiency)
    AppStorage.setOrCreate('INTERVAL_SPEED', this.intervalSpeed)

    // å¯åŠ¨æ—¶é—´æ›´æ–°å®šæ—¶å™¨ï¼ˆæ¯ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
    if (!this.timeUpdateTimerId) {
      console.log('[æ—¶é—´æ›´æ–°] å¯åŠ¨å®šæ—¶å™¨')
      this.timeUpdateTimerId = setInterval(() => {
        // æ›´æ–°å¼€å§‹æ—¶é—´ï¼ˆæ˜¾ç¤ºå½“å‰æ—¶é—´ï¼‰
        const now = new Date()
        const hh = String(now.getHours()).padStart(2, '0')
        const mm = String(now.getMinutes()).padStart(2, '0')
        const ss = String(now.getSeconds()).padStart(2, '0')
        this.startTime = `${hh}:${mm}:${ss}`
        AppStorage.setOrCreate('START_TIME', this.startTime)
        console.log('[æ—¶é—´æ›´æ–°] å½“å‰æ—¶é—´:', this.startTime)
      }, 1000) as number
    }

    // å¯åŠ¨æ¨¡æ‹Ÿå®æ—¶æ›´æ–°ï¼ˆæ¯3ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰
    if (!this.mockSortingInfoTimerId) {
      console.log('[æ¨¡æ‹Ÿåˆ†é€‰ä¿¡æ¯] å¯åŠ¨å®šæ—¶å™¨')
      this.mockSortingInfoTimerId = setInterval(() => {
        // é€Ÿåº¦ï¼ˆä»¶/åˆ†é’Ÿï¼‰- å˜åŒ–å¹…åº¦å‡å°
        const speed = Math.max(0, Math.round(70 + Math.random() * 20))
        this.sortSpeed = `${speed} ä»¶/åˆ†é’Ÿ`
        AppStorage.setOrCreate('SORT_SPEED', this.sortSpeed)

        // å®æ—¶äº§é‡ï¼ˆä»¶/åˆ†é’Ÿï¼‰- å˜åŒ–å¹…åº¦å‡å°
        const rto = Math.max(0, Math.round(60 + Math.random() * 20))
        this.realTimeOutput = `${rto} ä»¶/åˆ†é’Ÿ`
        AppStorage.setOrCreate('REALTIME_OUTPUT', this.realTimeOutput)

        // æœ¬æ‰¹ä¸ªæ•°ï¼ˆç´¯åŠ ï¼‰- å˜åŒ–å¹…åº¦å‡å°
        const currentCountNum = Number((this.batchCount || '0').toString().replace(/[^0-9]/g, ''))
        const nextCount = currentCountNum + Math.max(1, Math.round(Math.random() * 2))
        this.batchCount = `${nextCount} ä»¶`
        AppStorage.setOrCreate('BATCH_COUNT', this.batchCount)

        // å¹³å‡é‡é‡ï¼ˆgï¼‰- å˜åŒ–å¹…åº¦å‡å°
        const avg = (120 + Math.random() * 20) // g
        this.avgWeight = `${(avg / 1000).toFixed(2)} kg`
        AppStorage.setOrCreate('AVG_WEIGHT', this.avgWeight)

        // æœ¬æ‰¹é‡é‡ï¼ˆkgï¼ŒæŒ‰ä»¶æ•°ä¸å‡é‡ä¼°ç®—ï¼‰
        const avgKg = Number(((avg) / 1000).toFixed(2))
        const kg = nextCount * avgKg
        this.batchWeight = `${kg.toFixed(2)} kg`
        AppStorage.setOrCreate('BATCH_WEIGHT', this.batchWeight)

        // æ•ˆç‡ï¼ˆ%ï¼‰- å˜åŒ–å¹…åº¦å‡å°
        const eff = 85 + Math.random() * 10
        this.efficiency = `${eff.toFixed(0)}%`
        AppStorage.setOrCreate('EFFICIENCY', this.efficiency)

        // é—´éš”é€Ÿåº¦ï¼ˆmsï¼‰- å˜åŒ–å¹…åº¦å‡å°
        const intervalMs = 800 + Math.random() * 400
        this.intervalSpeed = `${Math.round(intervalMs)} ms`
        AppStorage.setOrCreate('INTERVAL_SPEED', this.intervalSpeed)
        // è°ƒè¯•æ—¥å¿—ï¼šè§‚å¯Ÿ9é¡¹æ˜¯å¦åœ¨å˜åŒ–
        console.log('[æ¨¡æ‹Ÿåˆ†é€‰ä¿¡æ¯] é€Ÿåº¦=', this.sortSpeed,
          ' é‡é‡=', this.batchWeight,
          ' ä¸ªæ•°=', this.batchCount,
          ' å‡é‡=', this.avgWeight,
          ' äº§é‡=', this.realTimeOutput,
          ' æ•ˆç‡=', this.efficiency,
          ' é—´éš”=', this.intervalSpeed)
      }, 3000) as number
      // ç«‹å³åˆ·æ–°ä¸€æ¬¡ï¼Œé¿å…é¦–ç§’ç©ºçª—
      {
        const speed = Math.max(0, Math.round(50 + Math.random() * 60))
        this.sortSpeed = `${speed} ä»¶/åˆ†é’Ÿ`
        AppStorage.setOrCreate('SORT_SPEED', this.sortSpeed)
        const rto = Math.max(0, Math.round(40 + Math.random() * 50))
        this.realTimeOutput = `${rto} ä»¶/åˆ†é’Ÿ`
        AppStorage.setOrCreate('REALTIME_OUTPUT', this.realTimeOutput)
        const currentCountNum = Number((this.batchCount || '0').toString().replace(/[^0-9]/g, ''))
        const nextCount = currentCountNum + Math.max(1, Math.round(Math.random() * 5))
        this.batchCount = `${nextCount} ä»¶`
        AppStorage.setOrCreate('BATCH_COUNT', this.batchCount)
        const avg = (100 + Math.random() * 50)
        this.avgWeight = `${(avg / 1000).toFixed(2)} kg`
        AppStorage.setOrCreate('AVG_WEIGHT', this.avgWeight)
        const avgKg = Number(((avg) / 1000).toFixed(2))
        const kg = nextCount * avgKg
        this.batchWeight = `${kg.toFixed(2)} kg`
        AppStorage.setOrCreate('BATCH_WEIGHT', this.batchWeight)
        const eff = 80 + Math.random() * 18
        this.efficiency = `${eff.toFixed(0)}%`
        AppStorage.setOrCreate('EFFICIENCY', this.efficiency)
        const intervalMs = 500 + Math.random() * 1200
        this.intervalSpeed = `${Math.round(intervalMs)} ms`
        AppStorage.setOrCreate('INTERVAL_SPEED', this.intervalSpeed)
        console.log('[æ¨¡æ‹Ÿåˆ†é€‰ä¿¡æ¯][é¦–åˆ·] é€Ÿåº¦=', this.sortSpeed,
          ' é‡é‡=', this.batchWeight,
          ' ä¸ªæ•°=', this.batchCount,
          ' å‡é‡=', this.avgWeight,
          ' äº§é‡=', this.realTimeOutput,
          ' æ•ˆç‡=', this.efficiency,
          ' é—´éš”=', this.intervalSpeed)
      }
    }
  }

  // æ ¹æ®FSMçŠ¶æ€æ›´æ–°é¡¶éƒ¨çŠ¶æ€æ 
  private updateTopBarForFSM(): void {
    let productionTonH: string, sumWeightTon: string, sumCounts: string, avgG: string
    
    if (this.selectedFSM === 'FSM1') {
      // FSM1çš„é¡¶éƒ¨çŠ¶æ€æ æ•°æ®ï¼ˆå»æ‰å•ä½ï¼‰
      productionTonH = '2.5'
      sumWeightTon = '1250.5'
      sumCounts = '156'
      avgG = '8.0'
    } else {
      // FSM2çš„é¡¶éƒ¨çŠ¶æ€æ æ•°æ®ï¼ˆå»æ‰å•ä½ï¼‰
      productionTonH = '3.8'
      sumWeightTon = '1580.3'
      sumCounts = '189'
      avgG = '8.4'
    }
    
    this.updateTopBar(productionTonH, sumWeightTon, sumCounts, avgG)
    console.log(`é¡¶éƒ¨çŠ¶æ€æ å·²æ›´æ–°ä¸º${this.selectedFSM}æ•°æ®`)
  }

  // ç¤ºä¾‹ï¼šå½“ä½ æ›´æ–°æœ¬åœ°çŠ¶æ€æ—¶ï¼ŒåŒæ­¥å†™å›å…¨å±€ï¼Œé¡¶éƒ¨æ ä¼šè‡ªåŠ¨åˆ·æ–°
  private updateTopBar(productionTonH: string, sumWeightTon: string, sumCounts: string, avgG: string) {
    this.topProduction = productionTonH
    this.topSumWeightTon = sumWeightTon
    this.topSumCounts = sumCounts
    this.topAvgG = avgG
    this.stateManager.updateTopProduction(productionTonH)
    this.stateManager.updateTopSumWeightTon(sumWeightTon)
    this.stateManager.updateTopSumCounts(sumCounts)
    this.stateManager.updateTopAvgG(avgG)

    AppStorage.set(TOP_PRODUCTION_TON_H, productionTonH)
    AppStorage.set(TOP_SUM_WEIGHT_TON, sumWeightTon)
    AppStorage.set(TOP_SUM_COUNTS, sumCounts)
    AppStorage.set(TOP_AVG_G, avgG)
  }
}

