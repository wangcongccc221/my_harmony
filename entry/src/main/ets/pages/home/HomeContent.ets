 /**
 * ä¸»é¡µå†…å®¹ç»„ä»¶
 * åŠŸèƒ½ï¼šæ˜¾ç¤ºä¸»é¡µç›¸å…³çš„å†…å®¹å’ŒåŠŸèƒ½
 * ç”¨é€”ï¼šåœ¨Homeé¡µé¢ä¸­ä½œä¸ºä¸»é¡µå†…å®¹æ˜¾ç¤º
 */

import { OmniThemeManager, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { KeyCode } from '@kit.InputKit';
import { IBestSwitch } from '@ibestservices/ibest-ui'
import { SwitchControl } from '../../components/ui/forms/SwitchControl'
import { TableRow } from '../../components/layout/LevelTable'
import { DataTablesTabBar } from './DataTablesTabBar'
import { DragData } from '../../components/layout/DraggableGridTable'
import { TOP_PRODUCTION_TON_H, TOP_SUM_WEIGHT_TON, TOP_SUM_COUNTS, TOP_AVG_G, TOP_USER_NAME, TOP_STATUS_TEXT, TOP_ALERT_HIDE, HOME_SELECTED_FSM, HOME_SETTING1_ENABLED, HOME_SETTING2_ENABLED, HOME_SETTING3_ENABLED, HOME_SETTING4_ENABLED, HOME_SELECTED_BUTTON } from '../../constants/TopBarKeys'
// å¯¼å…¥æ–°çš„ç»„ä»¶
import { SortingInfoCard } from './SortingInfoCard'
import { LiquidCardsArea } from './LiquidCardsArea'
import { StorageKeys } from '../../utils/constants/StorageKeys'
import { getCurrentCellDragData, CELL_DRAG_ACTIVE_KEY } from '../../components/ui/tables/SimpleDraggableCell'
import { OutletDialog } from './OutletDialog'
import { HomeDataManager } from './core/HomeDataManager'
import { HomeEventHandler } from './core/HomeEventHandler'
import { HomeStateManager } from './core/HomeStateManager'
import { HomeState, DEFAULT_HOME_STATE } from './core/HomeState'
import { DEFAULT_TOP_BAR_DATA, DEFAULT_SORTING_INFO, DEFAULT_SETTINGS, DEFAULT_SELECTED_BUTTON, DEFAULT_SELECTED_FSM } from './HomeConstants'
import { CardDetailDialog } from '../../components/dialogs/CardDetailDialog'
import { ThreeLayerCardData } from '../../components/ThreeLayerCard/types'

// æ—¥å¿—æ€»å¼€å…³ï¼ˆå‡å°‘é¢‘ç¹æ—¥å¿—å¯¼è‡´çš„å†…å­˜ä¸å¡é¡¿ï¼‰
const LOG_TIME_ENABLED: boolean = false
const LOG_SORT_ENABLED: boolean = false

// å…¨å±€é”®ç›˜çŠ¶æ€ï¼šä¸»é¡µæ˜¯å¦æŒ‰ä¸‹å·¦ Ctrlï¼ˆä¾›ç­‰çº§è¡¨ç­‰ç»„ä»¶ä½¿ç”¨ï¼‰
const HOME_CTRL_PRESSED = 'HOME_CTRL_PRESSED'

// FSMè®¾ç½®çŠ¶æ€æ¥å£
interface FSMSettings {
  setting1: boolean
  setting2: boolean
  setting3: boolean
  setting4: boolean
}

// ç›¸å…³å…¨å±€é”®çš„åˆå§‹åŒ–å·²å‰ç§»åˆ° aboutToAppearï¼Œé¿å…æ¨¡å—çº§ IIFE é€ æˆä¸å¿…è¦çš„å¼€é”€

// [TODO æé†’ - é‡è¦]
// SwitchWrapper ä¸ IBestSwitch çš„åŒå‘ç»‘å®šæ³¨æ„ï¼š
// å½“å‰ SwitchWrapper ä½¿ç”¨ @Prop isEnabledï¼Œå¹¶åœ¨ IBestSwitch.value ä¸Šä¼ å…¥ $isEnabledã€‚
// åœ¨ ArkTS ä¸­ï¼Œ$ è¯­æ³•è¦æ±‚å¼•ç”¨çš„æ˜¯ @State/@Linkï¼›@Prop ä¸ºåªè¯»ï¼Œå¯èƒ½å¯¼è‡´ç»‘å®šæ— æ•ˆæˆ–äº§ç”Ÿä¸å¯é¢„æœŸè¡Œä¸ºã€‚
// åç»­ä¿®å¤å¯é€‰æ–¹æ¡ˆï¼š
// A) å°† SwitchWrapper çš„ isEnabled æ”¹ä¸º @Linkï¼›çˆ¶ç»„ä»¶ä¼ å…¥ $settingXEnabledï¼›å†…éƒ¨ç»§ç»­ä½¿ç”¨ value: $isEnabledï¼›
// B) åœ¨ SwitchWrapper å†…ä½¿ç”¨ @State localEnabled è‡ªç®¡ç†ï¼Œå¹¶åœ¨ onBeforeChange åŒæ­¥ä¸å›è°ƒ onToggle é€šçŸ¥çˆ¶å±‚ï¼›
// æš‚ä»…è®°å½•æé†’ï¼Œå¾…ç¨åæŒ‰ç¡®å®šæ–¹æ¡ˆç»Ÿä¸€ä¿®æ”¹ã€‚
// IBestSwitch åŒ…è£…ï¼Œè§£å†³ value ä¸º @Link çš„ç»‘å®šéœ€æ±‚
@Component
struct SwitchWrapper {
  @Prop isEnabled: boolean = false
  onToggle: () => void = () => {}

  build() {
    IBestSwitch({
      value: $isEnabled, // åŒå‘ç»‘å®šåˆ°æœ¬åœ° isEnabled
      switchSize: 24,
      activeColor: '#EA7A10',
      inactiveColor: '#E0E0E0',
      onBeforeChange: (_next: boolean) => {
        // ç›´æ¥æ‰§è¡Œåˆ‡æ¢ï¼Œå‡å°‘Promiseå¼€é”€
        this.onToggle()
        return Promise.resolve(true)
      }
    })
  }
}

@Component
export struct HomeContent {
  // æ•°æ®ç®¡ç†å™¨
  private dataManager = HomeDataManager.getInstance()
  // äº‹ä»¶å¤„ç†å™¨
  private eventHandler = new HomeEventHandler()
  // çŠ¶æ€ç®¡ç†å™¨
  private stateManager = new HomeStateManager()
  // çŠ¶æ€ç®¡ç†ï¼ˆç§»é™¤æœªä½¿ç”¨çš„ HomeState å®ä¾‹ï¼Œæ”¹ç”± DEFAULT_HOME_STATE ä½œåˆå§‹åŒ–æ¥æºï¼‰

  // ==================== çŠ¶æ€å˜é‡ï¼ˆç”¨äºUIç»‘å®šï¼‰ ====================
  // è¿™äº› @State å˜é‡ä¸çŠ¶æ€ç®¡ç†å™¨åŒæ­¥ï¼Œç¡®ä¿UIèƒ½æ­£ç¡®å“åº”çŠ¶æ€å˜åŒ–
  
  @StorageLink(HOME_SELECTED_FSM) @Watch('onFSMChange') private selectedFSM: 'FSM1' | 'FSM2' = DEFAULT_HOME_STATE.selectedFSM
  @StorageLink(HOME_SETTING1_ENABLED) private setting1Enabled: boolean = DEFAULT_HOME_STATE.setting1Enabled
  @StorageLink(HOME_SETTING2_ENABLED) private setting2Enabled: boolean = DEFAULT_HOME_STATE.setting2Enabled
  @StorageLink(HOME_SETTING3_ENABLED) private setting3Enabled: boolean = DEFAULT_HOME_STATE.setting3Enabled
  @StorageLink(HOME_SETTING4_ENABLED) private setting4Enabled: boolean = DEFAULT_HOME_STATE.setting4Enabled
  @StorageLink(HOME_SELECTED_BUTTON) private selectedButton: string = DEFAULT_HOME_STATE.selectedButton
  @State private showOutletDialog: boolean = DEFAULT_HOME_STATE.showOutletDialog
  @State private currentOutletIndex: number = DEFAULT_HOME_STATE.currentOutletIndex
  // å¡ç‰‡è¯¦æƒ…å¯¹è¯æ¡†çŠ¶æ€
  @State private showCardDialog: boolean = false
  @State private selectedCardIndex: number = -1
  @State private selectedCardData: ThreeLayerCardData | null = null
  @State private topProduction: string = DEFAULT_HOME_STATE.topProduction
  @State private topSumWeightTon: string = DEFAULT_HOME_STATE.topSumWeightTon
  @State private topSumCounts: string = DEFAULT_HOME_STATE.topSumCounts
  @State private topAvgG: string = DEFAULT_HOME_STATE.topAvgG
  @State private sortSpeed: string = DEFAULT_HOME_STATE.sortSpeed
  @State private batchWeight: string = DEFAULT_HOME_STATE.batchWeight
  @State private batchCount: string = DEFAULT_HOME_STATE.batchCount
  @State private startTime: string = DEFAULT_HOME_STATE.startTime
  @State private programName: string = DEFAULT_HOME_STATE.programName
  @State private efficiency: string = DEFAULT_HOME_STATE.efficiency
  @State private avgWeight: string = DEFAULT_HOME_STATE.avgWeight
  @State private realTimeOutput: string = DEFAULT_HOME_STATE.realTimeOutput
  @State private intervalSpeed: string = DEFAULT_HOME_STATE.intervalSpeed
  // æ¨¡æ‹Ÿå®æ—¶æ•°æ®å®šæ—¶å™¨
  private mockSortingInfoTimerId?: number
  
  // æ—¶é—´æ›´æ–°å®šæ—¶å™¨
  private timeUpdateTimerId?: number
  // ==================== æ‹–æ‹½æµ®å±‚é¢„è§ˆçŠ¶æ€ ====================
  @State private dragOverlayActive: boolean = false
  @State private dragOverlayX: number = 0
  @State private dragOverlayY: number = 0
  @State private dragOverlayText: string = ''
  // ç­‰çº§ç»Ÿè®¡æ›´æ–°äº‹ä»¶ç›‘å¬ï¼ˆç®€åŒ–è´Ÿè½½ï¼‰
  @StorageLink(StorageKeys.LEVEL_STAT_UPDATE) private levelStatUpdate: Record<string, number | string> | null = null
  // æ‰¹é‡è¿½åŠ ï¼ˆå¤šé€‰ä»…æ·»åŠ ï¼‰
  @StorageLink(StorageKeys.LEVEL_STAT_UPDATE_BATCH) private levelStatUpdateBatch: Record<string, number | string | string[]> | null = null
  @StorageLink(StorageKeys.LEVEL_STAT_REMOVE) private levelStatRemove: Record<string, number | string> | null = null
  @State private statsVersion: number = 0
  @State private tablesRefreshKey: number = 0
  @State private settingsRenderKey: number = 0
  
  // FSMè®¾ç½®çŠ¶æ€å­˜å‚¨ï¼ˆæ¯ä¸ªFSMç‹¬ç«‹ä¿å­˜è®¾ç½®çŠ¶æ€ï¼‰
  @State private fsm1Settings: FSMSettings = {
    setting1: false,
    setting2: false,
    setting3: false,
    setting4: false
  }
  @State private fsm2Settings: FSMSettings = {
    setting1: false,
    setting2: false,
    setting3: false,
    setting4: false
  }
  // è®°å½•ä¸Šä¸€ä¸ªFSMçŠ¶æ€ï¼Œç”¨äºä¿å­˜è®¾ç½®çŠ¶æ€
  private previousFSM: 'FSM1' | 'FSM2' = 'FSM1'

  // ç”Ÿæˆä» start å¼€å§‹ã€é•¿åº¦ä¸º count çš„æ•°å­—åºåˆ—ï¼ˆç±»å‹å®‰å…¨ï¼‰
  private buildNumberRange(start: number, count: number): number[] {
    const result: number[] = []
    for (let i = 0; i < count; i++) {
      result.push(start + i)
    }
    return result
  }

  

  /**
   * è·å–æŒ‡å®šè¡¨æ ¼çš„æ•°æ®
   * @param tableName è¡¨æ ¼åå­—
   * @returns è¡¨æ ¼æ•°æ®
   */
  private getTableData(tableName: string): TableRow[] {
    const data = this.dataManager.getTableData(tableName)
    console.log(`HomeContent è·å–è¡¨æ ¼æ•°æ® ${tableName}:`, data, `å½“å‰FSM: ${this.dataManager.getCurrentFSM()}`)
    return data
  }

  /**
   * è§¦å‘ç­‰çº§ç»Ÿè®¡è¡¨åˆ·æ–°
   */
  public refreshStatisticsTable(): void {
    this.statsVersion++
    this.tablesRefreshKey++
    console.log('HomeContent: ç­‰çº§ç»Ÿè®¡è¡¨åˆ·æ–°å·²è§¦å‘')
  }


  // åˆ†é€‰ä¿¡æ¯ï¼ˆå ä½æ•°æ®ï¼‰
  // åç»­æ¥å…¥çœŸå®æ•°æ®å»ºè®®ï¼š
  // 1) æ•°æ®æ¥æºï¼š
  //    - è®¾å¤‡/æœåŠ¡å±‚ï¼ˆæœ¬åœ°ServiceAbility/åˆ†é€‰æœºSDKï¼‰ã€
  //    - åç«¯æ¥å£ï¼ˆHTTP/WebSocket/MQTTï¼‰ã€
  //    - æœ¬åœ°ç¼“å­˜ï¼ˆé¦–å±å ä½ï¼‰ã€‚
  // 2) è®¢é˜…æ—¶æœºï¼š
  //    - aboutToAppear() ä¸­å‘èµ·è®¢é˜…/è½®è¯¢/è¿æ¥ï¼›
  //    - aboutToDisappear() ä¸­å–æ¶ˆè®¢é˜…/å…³é—­è¿æ¥ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚
  // 3) æ›´æ–°æ–¹å¼ï¼š
  //    - æ”¶åˆ°æ–°æ•°æ®åç›´æ¥èµ‹å€¼åˆ°ä»¥ä¸‹ @State å­—æ®µï¼ŒUIä¼šè‡ªåŠ¨åˆ·æ–°ï¼›
  //    - æ³¨æ„åœ¨UIçº¿ç¨‹æ›´æ–°ï¼›å¦‚æœ‰è€—æ—¶è®¡ç®—ï¼Œè¯·åœ¨åå°å®Œæˆåå†setã€‚
  // 4) æ ¼å¼åŒ–ï¼š
  //    - é€Ÿåº¦: å°†åŸå§‹æ•°å€¼æ ¼å¼åŒ–ä¸º `${value} ä»¶/åˆ†é’Ÿ`ï¼›
  //    - é‡é‡: ä½¿ç”¨å›ºå®šå°æ•°ä½ï¼Œå¦‚ `${kg.toFixed(2)} kg`ï¼›
  //    - ä¸ªæ•°: `${count} ä»¶`ï¼›
  //    - æ—¶é—´: å°†æ—¶é—´æˆ³æ ¼å¼åŒ–ä¸º `HH:mm:ss`ï¼›
  //    - ç¨‹åº: å–å½“å‰æ­£åœ¨è¿è¡Œçš„ç¨‹åºåï¼›
  //    - æ•ˆç‡: ç™¾åˆ†æ¯” `${(ratio*100).toFixed(0)}%`ã€‚

  // è·å–å½“å‰ä¸»é¢˜é…ç½®çš„æ–¹æ³•
  getCurrentTheme(): ExtendedOmniThemeStyle {
    return OmniThemeManager.getInstance().getCurrentTheme()
  }

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºæœ€åä¸€ä¸ªå¼€å¯çš„è®¾ç½®
   * @param currentIndex å½“å‰è®¾ç½®çš„ç´¢å¼•
   * @returns æ˜¯å¦ä¸ºæœ€åä¸€ä¸ªå¼€å¯çš„è®¾ç½®
   */
  private isLastEnabledSetting(currentIndex: number): boolean {
    const settings = [this.setting1Enabled, this.setting2Enabled, this.setting3Enabled, this.setting4Enabled]
    const enabledCount = settings.filter(enabled => enabled).length
    
    // å¦‚æœåªæœ‰ä¸€ä¸ªè®¾ç½®å¼€å¯ï¼Œä¸”å½“å‰è®¾ç½®æ˜¯å¼€å¯çš„ï¼Œåˆ™ä¸èƒ½å…³é—­
    return enabledCount === 1 && settings[currentIndex]
  }

  /**
   * ç›‘å¬FSMçŠ¶æ€å˜åŒ–
   */
  onFSMChange(): void {
    console.log(`HomeContent: FSMçŠ¶æ€å˜åŒ–: ${this.previousFSM} -> ${this.selectedFSM}`)
    
    // ä¿å­˜ä¸Šä¸€ä¸ªFSMçš„è®¾ç½®çŠ¶æ€ï¼ˆåœ¨æ¢å¤æ–°FSMä¹‹å‰ï¼‰
    const currentSettings: FSMSettings = {
      setting1: this.setting1Enabled,
      setting2: this.setting2Enabled,
      setting3: this.setting3Enabled,
      setting4: this.setting4Enabled
    }
    
    // ä¿å­˜ä¸Šä¸€ä¸ªFSMçš„è®¾ç½®çŠ¶æ€
    if (this.previousFSM === 'FSM1') {
      this.fsm1Settings = currentSettings
      console.log(`ğŸ’¾ ä¿å­˜FSM1çš„è®¾ç½®çŠ¶æ€:`, currentSettings)
    } else {
      this.fsm2Settings = currentSettings
      console.log(`ğŸ’¾ ä¿å­˜FSM2çš„è®¾ç½®çŠ¶æ€:`, currentSettings)
    }
    
    // æ¢å¤ç›®æ ‡FSMçš„è®¾ç½®çŠ¶æ€
    let targetSettings = this.selectedFSM === 'FSM1' ? this.fsm1Settings : this.fsm2Settings
    console.log(`ğŸ” æ¢å¤${this.selectedFSM}çš„è®¾ç½®çŠ¶æ€:`, targetSettings)
    
    // æ£€æŸ¥ç›®æ ‡FSMæ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡ï¼ˆå¦‚æœæ‰€æœ‰è®¾ç½®éƒ½æ˜¯falseï¼Œè¯´æ˜æœªåˆå§‹åŒ–ï¼‰
    const isUninitialized = !targetSettings.setting1 && !targetSettings.setting2 && 
                           !targetSettings.setting3 && !targetSettings.setting4
    
    // å¦‚æœæœªåˆå§‹åŒ–ï¼Œæ ¹æ®FSMè®¾ç½®é»˜è®¤å€¼ï¼šFSM1é»˜è®¤"è®¾ç½®1"ï¼ŒFSM2é»˜è®¤"è®¾ç½®3"
    if (isUninitialized) {
      if (this.selectedFSM === 'FSM1') {
        targetSettings = {
          setting1: true,
          setting2: false,
          setting3: false,
          setting4: false
        }
        this.fsm1Settings = targetSettings
        console.log(`ğŸ¯ ${this.selectedFSM}æœªåˆå§‹åŒ–ï¼Œé»˜è®¤å¼€å¯è®¾ç½®1`)
      } else {
        targetSettings = {
          setting1: false,
          setting2: false,
          setting3: true,
          setting4: false
        }
        this.fsm2Settings = targetSettings
        console.log(`ğŸ¯ ${this.selectedFSM}æœªåˆå§‹åŒ–ï¼Œé»˜è®¤å¼€å¯è®¾ç½®3`)
      }
    }
    
    // åº”ç”¨ç›®æ ‡FSMçš„è®¾ç½®çŠ¶æ€
    this.setting1Enabled = targetSettings.setting1
    this.setting2Enabled = targetSettings.setting2
    this.setting3Enabled = targetSettings.setting3
    this.setting4Enabled = targetSettings.setting4
    
    // åŒæ­¥åˆ°çŠ¶æ€ç®¡ç†å™¨
    this.stateManager.updateSetting1Enabled(targetSettings.setting1)
    this.stateManager.updateSetting2Enabled(targetSettings.setting2)
    this.stateManager.updateSetting3Enabled(targetSettings.setting3)
    this.stateManager.updateSetting4Enabled(targetSettings.setting4)
    
    // æ›´æ–°previousFSMä¸ºå½“å‰FSMï¼Œä¸ºä¸‹æ¬¡åˆ‡æ¢åšå‡†å¤‡
    this.previousFSM = this.selectedFSM
    
    // æ›´æ–°æ•°æ®ç®¡ç†å™¨çš„FSMçŠ¶æ€
    this.dataManager.setFSM(this.selectedFSM)
    // æ›´æ–°é¡¶éƒ¨çŠ¶æ€æ 
    this.updateTopBarForFSM()
    // åˆ·æ–°è¡¨æ ¼æ•°æ®
    this.tablesRefreshKey++
  }

  // åˆ‡æ¢FSMçŠ¶æ€
  private switchFSM(fsm: 'FSM1' | 'FSM2'): void {
    this.selectedFSM = fsm
    this.stateManager.updateSelectedFSM(fsm)
    this.eventHandler.switchFSM(fsm)
    
    // æ›´æ–°æ•°æ®ç®¡ç†å™¨çš„FSMçŠ¶æ€
    this.dataManager.setFSM(fsm)
    
    // æ›´æ–°é¡¶éƒ¨çŠ¶æ€æ 
    this.updateTopBarForFSM()
    
    // åˆ·æ–°è¡¨æ ¼æ•°æ®
    this.tablesRefreshKey++
  }

  // è®¾ç½®å¼€å…³æ˜ å°„è¡¨
  private settingMap: Record<string, () => boolean> = {
    'è®¾ç½®1': () => this.setting1Enabled,
    'è®¾ç½®2': () => this.setting2Enabled,
    'è®¾ç½®3': () => this.setting3Enabled,
    'è®¾ç½®4': () => this.setting4Enabled
  }

  // è®¾ç½®çŠ¶æ€æ›´æ–°æ˜ å°„è¡¨
  private settingUpdateMap: Record<string, (value: boolean) => void> = {
    'è®¾ç½®1': (value: boolean) => { 
      this.setting1Enabled = value
      this.stateManager.updateSetting1Enabled(value)
    },
    'è®¾ç½®2': (value: boolean) => { 
      this.setting2Enabled = value
      this.stateManager.updateSetting2Enabled(value)
    },
    'è®¾ç½®3': (value: boolean) => { 
      this.setting3Enabled = value
      this.stateManager.updateSetting3Enabled(value)
    },
    'è®¾ç½®4': (value: boolean) => { 
      this.setting4Enabled = value
      this.stateManager.updateSetting4Enabled(value)
    }
  }

  // å¤„ç†è®¾ç½®çŠ¶æ€å˜æ›´ï¼ˆäº’æ–¥é€»è¾‘ï¼šå½“æŸä¸ªå¼€å¯æ—¶ï¼Œå…³é—­å…¶ä»–æ‰€æœ‰ï¼‰
  private handleSettingChange(activeSetting: 'è®¾ç½®1' | 'è®¾ç½®2' | 'è®¾ç½®3' | 'è®¾ç½®4'): void {
    // æ£€æŸ¥å½“å‰è¿™ä¸ªè®¾ç½®æ˜¯å¦åˆšåˆšå˜æˆäº†"å¼€å¯"çŠ¶æ€
    // æ³¨æ„ï¼šç”±äºæ˜¯ @Link åŒå‘ç»‘å®šï¼ŒSwitchControl å†…éƒ¨å·²ç»ä¿®æ”¹äº† settingXEnabled çš„å€¼
    if (this.settingMap[activeSetting]()) {
      // å¦‚æœå®ƒç°åœ¨æ˜¯å¼€å¯çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æŠŠå…¶ä»–æ‰€æœ‰çš„éƒ½å…³æ‰
      const allSettings: ('è®¾ç½®1' | 'è®¾ç½®2' | 'è®¾ç½®3' | 'è®¾ç½®4')[] = ['è®¾ç½®1', 'è®¾ç½®2', 'è®¾ç½®3', 'è®¾ç½®4']
      allSettings.forEach(setting => {
        if (setting !== activeSetting) {
          // å…³é—­å…¶ä»–è®¾ç½®
          this.settingUpdateMap[setting](false)
        }
      })
      
      // è°ƒç”¨äº‹ä»¶å¤„ç†å™¨é€šçŸ¥ä¸šåŠ¡å±‚
      this.eventHandler.toggleSetting(activeSetting)
    }
    // å¦‚æœæ˜¯å˜æˆäº†"å…³é—­"çŠ¶æ€ï¼Œæˆ‘ä»¬ä¸éœ€è¦åšä»»ä½•äº‹ï¼Œ
    // å› ä¸º SwitchControl å†…éƒ¨çš„ isLastEnabled é€»è¾‘å·²ç»ä¿è¯äº†"æœ€åä¸€ä¸ªä¸èƒ½å…³é—­"ã€‚
    // åªæœ‰å½“æœ‰ >=2 ä¸ªå¼€å¯æ—¶æ‰èƒ½å…³é—­å…¶ä¸­ä¸€ä¸ªï¼Œè¿™æ—¶å€™ä¹Ÿæ— éœ€è”åŠ¨å…¶ä»–ã€‚
  }

  // é€‰æ‹©åŠŸèƒ½æŒ‰é’®
  private selectButton(buttonName: string): void {
    this.selectedButton = buttonName
    this.stateManager.updateSelectedButton(buttonName)
    this.eventHandler.selectButton(buttonName)
  }

  // æ·»åŠ æ•°æ®åˆ°è¡¨æ ¼çš„å°è£…å‡½æ•°
  private addDataToTables(): void {
    // ä½¿ç”¨æ•°æ®ç®¡ç†å™¨åˆå§‹åŒ–æ•°æ®
    this.dataManager.initializeAllTableData()  //åˆå§‹åŒ–æ•°æ®
  }

  // å¤„ç†ç­‰çº§ç»Ÿè®¡æ›´æ–°ï¼šä¸ºæŒ‡å®šç­‰çº§è¿½åŠ å‡ºå£ç¼–å·ï¼ˆå»é‡ï¼‰
  private applyLevelStatUpdate(levelName: string, exitNum: number): void {
    const tableName = 'ç­‰çº§ç»Ÿè®¡è¡¨'
    const rows: TableRow[] = this.dataManager.getTableData(tableName)
    const idx: number = rows.findIndex((r: TableRow) => String(r && r[0]) === levelName)
    if (idx < 0) {
      console.warn(`æœªåœ¨${tableName}ä¸­æ‰¾åˆ°ç­‰çº§è¡Œ:`, levelName)
      return
    }
    const updatedRow: TableRow = [...rows[idx]]
    const exitColIndex = 2 // ç­‰çº§å‡ºå£
    const currentVal: string = String(updatedRow[exitColIndex] || '').trim()
    const entry = `å‡ºå£${exitNum}`
    let nextVal: string
    if (!currentVal) {
      nextVal = entry
    } else if (currentVal.indexOf(entry) >= 0) {
      nextVal = currentVal
    } else {
      nextVal = `${currentVal}ã€${entry}`
    }
    updatedRow[exitColIndex] = nextVal

    const newRows: TableRow[] = [...rows]
    newRows[idx] = updatedRow
    
    // ä½¿ç”¨FSMç‰¹å®šçš„é”®åæ›´æ–°æ•°æ®
    this.dataManager.updateFSMTableData(tableName, newRows)
    this.statsVersion++
  }

  // å¤„ç†ç­‰çº§ç»Ÿè®¡ç§»é™¤ï¼šä¸ºæŒ‡å®šç­‰çº§ç§»é™¤æŸä¸ªå‡ºå£ç¼–å·
  private applyLevelStatRemove(levelName: string, exitNum: number): void {
    const tableName = 'ç­‰çº§ç»Ÿè®¡è¡¨'
    const rows: TableRow[] = this.dataManager.getTableData(tableName)
    const idx: number = rows.findIndex((r: TableRow) => String(r && r[0]) === levelName)
    if (idx < 0) {
      console.warn(`æœªåœ¨${tableName}ä¸­æ‰¾åˆ°ç­‰çº§è¡Œ:`, levelName)
      return
    }
    const updatedRow: TableRow = [...rows[idx]]
    const exitColIndex = 2 // ç­‰çº§å‡ºå£
    const currentVal: string = String(updatedRow[exitColIndex] || '').trim()
    const entry = `å‡ºå£${exitNum}`
    if (!currentVal) { return }
    const items = currentVal.split('ã€').map(s => s.trim()).filter(Boolean)
    const nextItems = items.filter(s => s !== entry)
    const nextVal = nextItems.join('ã€')
    updatedRow[exitColIndex] = nextVal

    const newRows: TableRow[] = [...rows]
    newRows[idx] = updatedRow
    
    // ä½¿ç”¨FSMç‰¹å®šçš„é”®åæ›´æ–°æ•°æ®
    this.dataManager.updateFSMTableData(tableName, newRows)
    this.statsVersion++
  }


  // å¤„ç†å‡ºå£æŒ‰é’®ç‚¹å‡»
  private handleOutletClick(outletNumber: number): void {
    this.currentOutletIndex = outletNumber
    this.showOutletDialog = true
    this.stateManager.updateCurrentOutletIndex(outletNumber)
    this.stateManager.updateShowOutletDialog(true)
    this.eventHandler.handleOutletClick(outletNumber)
  }

  // åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªå‡ºå£
  private switchToPreviousOutlet(): void {
    const newIndex = this.currentOutletIndex > 1 ? this.currentOutletIndex - 1 : 9
    this.currentOutletIndex = newIndex
    this.stateManager.updateCurrentOutletIndex(newIndex)
    this.eventHandler.handleOutletPrevious()
  }

  // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå‡ºå£
  private switchToNextOutlet(): void {
    const newIndex = this.currentOutletIndex < 9 ? this.currentOutletIndex + 1 : 1
    this.currentOutletIndex = newIndex
    this.stateManager.updateCurrentOutletIndex(newIndex)
    this.eventHandler.handleOutletNext()
  }

  // ç¡®è®¤å‡ºå£è®¾ç½®
  private confirmOutletSetting(): void {
    this.showOutletDialog = false
    this.stateManager.updateShowOutletDialog(false)
    this.eventHandler.handleOutletConfirm()
  }

  // å–æ¶ˆå‡ºå£è®¾ç½®
  private cancelOutletSetting(): void {
    this.showOutletDialog = false
    this.stateManager.updateShowOutletDialog(false)
    this.eventHandler.handleOutletCancel()
  }

  // å¤„ç†å¡ç‰‡ç‚¹å‡»
  private handleCardClick(cardIndex: number, cardData: ThreeLayerCardData): void {
    console.log(`å¡ç‰‡è¢«ç‚¹å‡»: index=${cardIndex}`)
    this.currentOutletIndex = cardIndex + 1
    this.stateManager.updateCurrentOutletIndex(this.currentOutletIndex)
    this.showOutletDialog = true
    this.stateManager.updateShowOutletDialog(true)
    
    // ä¹Ÿå¯ä»¥ä¿ç•™é€‰ä¸­æ•°æ®ä¾›åç»­ä½¿ç”¨
    this.selectedCardIndex = cardIndex
    this.selectedCardData = cardData
  }

  // å…³é—­å¡ç‰‡è¯¦æƒ…å¯¹è¯æ¡†
  private closeCardDialog(): void {
    this.showCardDialog = false
    this.selectedCardIndex = -1
    this.selectedCardData = null
  }



  // å°†åŸæ¥çš„buildæ–¹æ³•å†…å®¹æå–ä¸ºå•ç‹¬çš„æ–¹æ³•
  @Builder
  private buildMainContent() {
    Column() {
      // è®¾ç½®å¼€å…³åŒºåŸŸï¼ˆFSMåˆ‡æ¢å·²ç§»è‡³é¡¶éƒ¨çŠ¶æ€æ ï¼‰
      Row() {
        SwitchControl({ 
          label: 'è®¾ç½®1', 
          isEnabled: $setting1Enabled, 
          switchSize: 26,
          isLastEnabled: this.isLastEnabledSetting(0),
          onToggle: () => { this.handleSettingChange('è®¾ç½®1') } 
        })
        SwitchControl({ 
          label: 'è®¾ç½®2', 
          isEnabled: $setting2Enabled, 
          switchSize: 26,
          isLastEnabled: this.isLastEnabledSetting(1),
          onToggle: () => { this.handleSettingChange('è®¾ç½®2') } 
        })
        SwitchControl({ 
          label: 'è®¾ç½®3', 
          isEnabled: $setting3Enabled, 
          switchSize: 26,
          isLastEnabled: this.isLastEnabledSetting(2),
          onToggle: () => { this.handleSettingChange('è®¾ç½®3') } 
        })
        SwitchControl({ 
          label: 'è®¾ç½®4', 
          isEnabled: $setting4Enabled, 
          switchSize: 26,
          isLastEnabled: this.isLastEnabledSetting(3),
          onToggle: () => { this.handleSettingChange('è®¾ç½®4') } 
        })
      }
      .key(`settings-${this.settingsRenderKey}`)
      .width('100%')
      .height('auto')
      .justifyContent(FlexAlign.Start)
      .alignItems(VerticalAlign.Center)
      .padding({ top: '1%', left: '0.93%', right: '0.93%', bottom: '1%' })
      .onAppear(() => {
        // ä½¿ç”¨å¤šæ¬¡å»¶è¿Ÿåˆ·æ–°ç¡®ä¿å¸ƒå±€å®Œæˆ
        setTimeout(() => {
          this.settingsRenderKey++
          console.log('[HomeContent] è®¾ç½®åŒºåŸŸå·²æ˜¾ç¤ºï¼Œç¬¬ä¸€æ¬¡åˆ·æ–°')
        }, 50)
        setTimeout(() => {
          this.settingsRenderKey++
          console.log('[HomeContent] è®¾ç½®åŒºåŸŸå·²æ˜¾ç¤ºï¼Œç¬¬äºŒæ¬¡åˆ·æ–°')
        }, 300)
        setTimeout(() => {
          this.settingsRenderKey++
          console.log('[HomeContent] è®¾ç½®åŒºåŸŸå·²æ˜¾ç¤ºï¼Œç¬¬ä¸‰æ¬¡åˆ·æ–°')
        }, 600)
      })
      // ä¸»é¡µä¿¡æ¯å¡ç‰‡ï¼šåˆ†é€‰é€Ÿåº¦ | æœ¬æ‰¹é‡é‡ | æœ¬æ‰¹ä¸ªæ•° | å¼€å§‹æ—¶é—´ | åˆ†é€‰ç¨‹åº | åˆ†é€‰æ•ˆç‡ | å¹³å‡é‡é‡ | å®æ—¶äº§é‡ | é—´éš”é€Ÿåº¦
      Row() {
        Blank().width('1.5%')  // å·¦è¾¹é—´éš™
        SortingInfoCard()
          .layoutWeight(1)  // è‡ªé€‚åº”å®½åº¦ï¼Œå¡«å……å‰©ä½™ç©ºé—´
        Blank().width('1.5%')  // å³è¾¹é—´éš™
      }
      .width('100%')
      .margin({ bottom: '1%' })

      // æ¶²ä½“å¡ç‰‡åŒºåŸŸï¼šå•å®¹å™¨è‡ªåŠ¨æ¢è¡Œï¼Œå›ºå®šæ˜¾ç¤ºä¸¤æ’é«˜åº¦ï¼Œæ”¯æŒçºµå‘æ»šåŠ¨æŸ¥çœ‹æ›´å¤š
      Row() {
        Blank().width('1.5%')  // å·¦è¾¹é—´éš™
        LiquidCardsArea({
          onCardClick: (cardIndex: number, cardData: ThreeLayerCardData) => {
            this.handleCardClick(cardIndex, cardData)
          }
        })
          .layoutWeight(1)  // è‡ªé€‚åº”å®½åº¦ï¼Œå¡«å……å‰©ä½™ç©ºé—´
        Blank().width('1.5%')  // å³è¾¹é—´éš™
      }
      .width('100%')
      .height('32%')  // æ¶²ä½“å¡ç‰‡åŒºåŸŸå ä¸»é¡µçš„32%ï¼ˆæŠ˜ä¸­æ–¹æ¡ˆï¼‰
      .margin({ bottom: '0.5%' })

      // æ•°æ®è¡¨æ ¼TabBarç»„ä»¶ - æ›¿æ¢åŸæœ‰çš„FunctionButtonså’ŒDataTablesCard
      Row() {
        Blank().width('1.5%')  // å·¦è¾¹é—´éš™
        DataTablesTabBar({
          levelTableData: this.getTableData('ç­‰çº§è¡¨'),
        containerTableData: this.getTableData('å®¹å™¨è¡¨'),
        statisticsTableData: this.getTableData('ç­‰çº§ç»Ÿè®¡è¡¨'),
        dynamicPackingTableData: this.getTableData('åŠ¨æ€è£…ç®±'),
        finishedProductsTableData: this.getTableData('æˆå“'),
        levelTableDragData: [],
        containerTableDragData: [],
        statisticsTableDragData: [],
        dynamicPackingTableDragData: [],
        finishedProductsTableDragData: [],
        refreshKey: this.tablesRefreshKey,
        onRowDragStart: (dragData: DragData) => {
          console.log('ä¸»é¡µæ¥æ”¶åˆ°æ‹–æ‹½å¼€å§‹:', dragData)
        },
        onRowDragEnd: () => {
          console.log('ä¸»é¡µæ¥æ”¶åˆ°æ‹–æ‹½ç»“æŸ')
        }
      })
          .layoutWeight(1)  // è‡ªé€‚åº”å®½åº¦ï¼Œå¡«å……å‰©ä½™ç©ºé—´
          .height('53%') // è¡¨æ ¼åŒºåŸŸå 53%
        Blank().width('1.5%')  // å³è¾¹é—´éš™
      }
      .width('100%')
      .margin({ bottom: 0 })



      
    }
    .width('100%')
    .height('100%')
    .alignItems(HorizontalAlign.Start)
    .justifyContent(FlexAlign.Start)
  }

  build() {
    Stack() {
      // ä¸»è¦å†…å®¹
      this.buildMainContent()
      
      // ä¾¦å¬FSMåˆ‡æ¢äº‹ä»¶ï¼ˆä¼˜åŒ–ï¼šå‡å°‘é‡å¤ç›‘å¬ï¼Œä½¿ç”¨é˜²æŠ–æœºåˆ¶é¿å…å¾ªç¯è§¦å‘ï¼‰
      if (this.selectedFSM) {
        Blank()
          .key(`fsm-${this.selectedFSM}`) // ä½¿ç”¨keyé¿å…é‡å¤è§¦å‘
          .onAppear(() => {
            // ä½¿ç”¨å¼‚æ­¥å»¶è¿Ÿï¼Œé¿å…åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­åŒæ­¥æ›´æ–°å¯¼è‡´å¾ªç¯
            Promise.resolve().then(() => {
              this.dataManager.setFSM(this.selectedFSM)
              this.updateTopBarForFSM()
              this.tablesRefreshKey++
            })
          })
      }
      
      // ä¾¦å¬ç­‰çº§ç»Ÿè®¡æ›´æ–°äº‹ä»¶ï¼ˆUIè¯­æ³•åŒ…è£¹ï¼Œé€»è¾‘åœ¨å›è°ƒå†…ï¼Œæ·»åŠ é˜²é‡å¤è§¦å‘æœºåˆ¶ï¼‰
      if (this.levelStatUpdate && typeof this.levelStatUpdate['levelName'] === 'string' && typeof this.levelStatUpdate['exit'] !== 'undefined') {
        Blank()
          .key(`stat-update-${this.levelStatUpdate['levelName']}-${this.levelStatUpdate['exit']}`) // ä½¿ç”¨keyé¿å…é‡å¤è§¦å‘
          .onAppear(() => {
            // å…ˆæ¸…é™¤AppStorageï¼Œé¿å…é‡å¤è§¦å‘
            const ln = String(this.levelStatUpdate!['levelName'])
            const ex = Number(this.levelStatUpdate!['exit'])
            AppStorage.set(StorageKeys.LEVEL_STAT_UPDATE, null)
            // ä½¿ç”¨å¼‚æ­¥å»¶è¿Ÿï¼Œé¿å…åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­åŒæ­¥æ›´æ–°å¯¼è‡´å¾ªç¯
            Promise.resolve().then(() => {
              console.log(`ğŸ¯ æ£€æµ‹åˆ°ç­‰çº§ç»Ÿè®¡æ›´æ–°äº‹ä»¶:`, { levelName: ln, exit: ex })
              this.applyLevelStatUpdate(ln, ex)
              this.tablesRefreshKey++
            })
          })
      }
      if (this.levelStatUpdateBatch && Array.isArray(this.levelStatUpdateBatch['levelNames']) && typeof this.levelStatUpdateBatch['exit'] !== 'undefined') {
        Blank()
          .key(`stat-batch-${JSON.stringify(this.levelStatUpdateBatch['levelNames'])}-${this.levelStatUpdateBatch['exit']}`) // ä½¿ç”¨keyé¿å…é‡å¤è§¦å‘
          .onAppear(() => {
            // å…ˆæ¸…é™¤AppStorageï¼Œé¿å…é‡å¤è§¦å‘
            const arrRaw = this.levelStatUpdateBatch!['levelNames']
            const arr: string[] = Array.isArray(arrRaw) ? (arrRaw as string[]) : []
            const ex = Number(this.levelStatUpdateBatch!['exit'])
            AppStorage.set(StorageKeys.LEVEL_STAT_UPDATE_BATCH, null)
            // ä½¿ç”¨å¼‚æ­¥å»¶è¿Ÿï¼Œé¿å…åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­åŒæ­¥æ›´æ–°å¯¼è‡´å¾ªç¯
            Promise.resolve().then(() => {
              arr.forEach((ln) => {
                if (ln && ln.length > 0) {
                  this.applyLevelStatUpdate(ln, ex)
                }
              })
              this.tablesRefreshKey++
            })
          })
      }
      
      if (this.levelStatRemove && typeof this.levelStatRemove['levelName'] === 'string' && typeof this.levelStatRemove['exit'] !== 'undefined') {
        Blank()
          .key(`stat-remove-${this.levelStatRemove['levelName']}-${this.levelStatRemove['exit']}`) // ä½¿ç”¨keyé¿å…é‡å¤è§¦å‘
          .onAppear(() => {
            // å…ˆæ¸…é™¤AppStorageï¼Œé¿å…é‡å¤è§¦å‘
            const ln = String(this.levelStatRemove!['levelName'])
            const ex = Number(this.levelStatRemove!['exit'])
            AppStorage.set(StorageKeys.LEVEL_STAT_REMOVE, null)
            // ä½¿ç”¨å¼‚æ­¥å»¶è¿Ÿï¼Œé¿å…åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­åŒæ­¥æ›´æ–°å¯¼è‡´å¾ªç¯
            Promise.resolve().then(() => {
              this.applyLevelStatRemove(ln, ex)
              this.tablesRefreshKey++
            })
          })
      }
      
        // å‡ºå£è®¾ç½®å¯¹è¯æ¡† - æ”¾åœ¨Stackçš„æœ€ä¸Šå±‚
        OutletDialog({
          isVisible: this.showOutletDialog,
          currentOutletIndex: this.currentOutletIndex,
          levelTableData: this.getTableData('ç­‰çº§è¡¨'),
          onPrevious: () => {
            this.switchToPreviousOutlet()
          },
          onNext: () => {
            this.switchToNextOutlet()
          },
          onConfirm: () => {
            this.confirmOutletSetting()
          },
          onCancel: () => {
            this.cancelOutletSetting()
          }
        })
        
        // å¡ç‰‡è¯¦æƒ…å¯¹è¯æ¡† - æ”¾åœ¨Stackçš„æœ€ä¸Šå±‚ï¼Œæ˜¾ç¤ºåœ¨æ•´ä¸ªé¡µé¢ä¸­é—´
        if (this.showCardDialog && this.selectedCardIndex >= 0 && this.selectedCardData) {
          CardDetailDialog({
            isVisible: this.showCardDialog,
            cardNumber: this.selectedCardIndex + 1,
            cardData: this.selectedCardData,
            onConfirm: () => {
              this.closeCardDialog()
            },
            onCancel: () => {
              this.closeCardDialog()
            }
          })
        }
      // æ‹–æ‹½é¢„è§ˆæµ®å±‚ï¼ˆè·ŸéšæŒ‡é’ˆï¼‰
      if (this.dragOverlayActive) {
        // åŠé€æ˜æ ‡ç­¾ï¼Œæ˜¾ç¤ºè¢«æ‹–æ‹½çš„å•å…ƒæ ¼å†…å®¹
        Text(this.dragOverlayText || '')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor(Color.Black)
          .backgroundColor('#FFFFFFB0')
          .borderRadius(8)
          .padding({ left: '0.37%', right: '0.37%', top: '0.28%', bottom: '0.28%' })
          .opacity(0.92)
          .position({ x: this.dragOverlayX - 20, y: this.dragOverlayY - 20 })
          .enabled(false)
          .zIndex(9999)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.getCurrentTheme().backgroundColor)  // ä¸»é¡µèƒŒæ™¯é¢œè‰²ï¼ˆå¡ç‰‡ä¹‹å¤–çš„åŒºåŸŸï¼‰
    .focusable(true)
    .defaultFocus(true) // è®©ä¸»é¡µæ•´ä½“é»˜è®¤è·å¾—é”®ç›˜ç„¦ç‚¹
    .onAppear(() => {
      // Stack å‡ºç°æ—¶è§¦å‘è®¾ç½®åŒºåŸŸåˆ·æ–°ï¼Œç¡®ä¿å¸ƒå±€æ­£ç¡®è®¡ç®—
      Promise.resolve().then(() => {
        setTimeout(() => {
          this.settingsRenderKey++
          console.log('[HomeContent] Stackå·²æ˜¾ç¤ºï¼Œåˆ·æ–°è®¾ç½®åŒºåŸŸ')
        }, 100)
        setTimeout(() => {
          this.settingsRenderKey++
          console.log('[HomeContent] Stackå·²æ˜¾ç¤ºï¼Œå†æ¬¡åˆ·æ–°è®¾ç½®åŒºåŸŸ')
        }, 500)
      })
    })
    .onKeyEvent((event) => {
      // ä¸»é¡µç›‘å¬å·¦ Ctrlï¼Œå†™å…¥å…¨å±€å¤šé€‰çŠ¶æ€
      if (event.keyCode === KeyCode.KEYCODE_CTRL_LEFT) {
        if (event.type === KeyType.Down) {
          AppStorage.setOrCreate('HOME_CTRL_PRESSED', true);

        } else if (event.type === KeyType.Up) {
          AppStorage.setOrCreate('HOME_CTRL_PRESSED', false);

        }
      }
      return false;
    })
    // ç»Ÿä¸€è·Ÿè¸ªè§¦æ‘¸åæ ‡ä¸æ‹–æ‹½æ¿€æ´»çŠ¶æ€
    .onTouch((event?: TouchEvent) => {
      if (!event) { return }
      const t = event.touches && event.touches.length > 0 ? event.touches[0] : undefined
      
      // ä¼˜åŒ–ï¼šå‡å°‘ AppStorage è¯»å–é¢‘ç‡ï¼Œä½¿ç”¨ç¼“å­˜æˆ–å»¶è¿Ÿè¯»å–
      // åªåœ¨å¿…è¦æ—¶è¯»å– AppStorageï¼Œé¿å…æ¯æ¬¡è§¦æ‘¸éƒ½è¯»å–ï¼ˆé•¿æ—¶é—´è¿è¡Œåå¯èƒ½ç´¯ç§¯æ€§èƒ½é—®é¢˜ï¼‰
      if (event.type === TouchType.Down || event.type === TouchType.Move) {
        // ä½¿ç”¨å¼‚æ­¥å»¶è¿Ÿè¯»å–ï¼Œé¿å…é˜»å¡è§¦æ‘¸äº‹ä»¶å¤„ç†
        Promise.resolve().then(() => {
          const active = (AppStorage.get(CELL_DRAG_ACTIVE_KEY) as boolean) === true
          if (!active) {
            // æœªå¤„äºæ‹–æ‹½æ¿€æ´»ï¼Œå¼ºåˆ¶éšè—å¹¶æ¸…ç©ºæµ®å±‚æ–‡æœ¬ï¼Œé¿å…æ®‹ç•™
            if (this.dragOverlayActive || this.dragOverlayText) {
              this.dragOverlayActive = false
              this.dragOverlayText = ''
            }
          } else {
            // æ¿€æ´»æ—¶é¦–æ¬¡æ˜¾ç¤ºæ—¶åŒæ­¥å½“å‰æ‹–æ‹½æ–‡æœ¬
            if (!this.dragOverlayActive) {
              const d = getCurrentCellDragData()
              this.dragOverlayText = d ? String(d.value ?? '') : ''
            }
            this.dragOverlayActive = true
          }
        })
      }
      
      // åæ ‡è·Ÿè¸ªï¼ˆä½¿ç”¨å±å¹•åæ ‡ï¼Œé€‚é… Stack é¡¶å±‚ï¼‰
      if (t) {
        // ä½¿ç”¨ç›¸å¯¹äºå½“å‰ Stack çš„æœ¬åœ°åæ ‡ï¼Œé¿å…å±å¹•åæ ‡å¯¼è‡´çš„åç§»
        this.dragOverlayX = t.x
        this.dragOverlayY = t.y
      }
      // æŠ¬æ‰‹æ—¶è‹¥æœªè¢«ç›®æ ‡æ¥æ”¶ï¼Œä¹Ÿéšè—æµ®å±‚
      if (event.type === TouchType.Up) {
        this.dragOverlayActive = false
        this.dragOverlayText = ''
      }
    })
  }

  aboutToAppear() {
    // åˆå§‹åŒ–previousFSMä¸ºå½“å‰FSM
    this.previousFSM = this.selectedFSM
    
    // æ£€æŸ¥å½“å‰FSMæ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤å¼€å¯"è®¾ç½®1"
    const currentFSMSettings = this.selectedFSM === 'FSM1' ? this.fsm1Settings : this.fsm2Settings
    const isUninitialized = !currentFSMSettings.setting1 && !currentFSMSettings.setting2 && 
                           !currentFSMSettings.setting3 && !currentFSMSettings.setting4
    
    if (isUninitialized) {
      let defaultSettings: FSMSettings
      if (this.selectedFSM === 'FSM1') {
        // FSM1é»˜è®¤å¼€å¯"è®¾ç½®1"
        defaultSettings = {
          setting1: true,
          setting2: false,
          setting3: false,
          setting4: false
        }
        this.fsm1Settings = defaultSettings
        console.log(`ğŸ¯ é¦–æ¬¡åŠ è½½${this.selectedFSM}ï¼Œé»˜è®¤å¼€å¯è®¾ç½®1`)
      } else {
        // FSM2é»˜è®¤å¼€å¯"è®¾ç½®3"
        defaultSettings = {
          setting1: false,
          setting2: false,
          setting3: true,
          setting4: false
        }
        this.fsm2Settings = defaultSettings
        console.log(`ğŸ¯ é¦–æ¬¡åŠ è½½${this.selectedFSM}ï¼Œé»˜è®¤å¼€å¯è®¾ç½®3`)
      }
      // åº”ç”¨é»˜è®¤è®¾ç½®
      this.setting1Enabled = defaultSettings.setting1
      this.setting2Enabled = defaultSettings.setting2
      this.setting3Enabled = defaultSettings.setting3
      this.setting4Enabled = defaultSettings.setting4
      // åŒæ­¥åˆ°çŠ¶æ€ç®¡ç†å™¨
      this.stateManager.updateSetting1Enabled(defaultSettings.setting1)
      this.stateManager.updateSetting2Enabled(defaultSettings.setting2)
      this.stateManager.updateSetting3Enabled(defaultSettings.setting3)
      this.stateManager.updateSetting4Enabled(defaultSettings.setting4)
    }
    
    // æ ¹æ®FSMçŠ¶æ€åˆå§‹åŒ–é¡¶éƒ¨çŠ¶æ€æ å››é¡¹æŒ‡æ ‡
    this.updateTopBarForFSM()
    // åˆå§‹åŒ–ç”¨æˆ·ä¸çŠ¶æ€
    AppStorage.setOrCreate(TOP_USER_NAME, 'ç®¡ç†å‘˜')
    AppStorage.setOrCreate(TOP_STATUS_TEXT, '')
    AppStorage.setOrCreate(TOP_ALERT_HIDE, false)

    // åˆå§‹åŒ–ä¸»é¡µçŠ¶æ€ï¼ˆæ–°å¢çš„@StorageLinkå˜é‡ï¼‰
    AppStorage.setOrCreate(HOME_SELECTED_FSM, this.selectedFSM)
    // ç¡®ä¿è®¾ç½®çŠ¶æ€æ­£ç¡®åŒæ­¥åˆ° AppStorageï¼ˆåœ¨åˆå§‹åŒ–ä¹‹åç«‹å³åŒæ­¥ï¼‰
    AppStorage.setOrCreate(HOME_SETTING1_ENABLED, this.setting1Enabled)
    AppStorage.setOrCreate(HOME_SETTING2_ENABLED, this.setting2Enabled)
    AppStorage.setOrCreate(HOME_SETTING3_ENABLED, this.setting3Enabled)
    AppStorage.setOrCreate(HOME_SETTING4_ENABLED, this.setting4Enabled)
    AppStorage.setOrCreate(HOME_SELECTED_BUTTON, this.selectedButton)
    
    // æ³¨å†ŒHomeDataManageråˆ°AppStorageï¼Œä¾›å…¶ä»–ç»„ä»¶ä½¿ç”¨
    AppStorage.setOrCreate('HOME_DATA_MANAGER', this.dataManager)
    // æ³¨å†ŒHomeContentå®ä¾‹åˆ°AppStorageï¼Œä¾›å…¶ä»–ç»„ä»¶ä½¿ç”¨
    AppStorage.setOrCreate('HOME_CONTENT_REF', this)
    
    // ä½¿ç”¨å¼‚æ­¥å»¶è¿Ÿç¡®ä¿é¦–æ¬¡æ¸²æŸ“æ—¶å¸ƒå±€æ­£ç¡®è®¡ç®—
    Promise.resolve().then(() => {
      // å¼ºåˆ¶åŒæ­¥è®¾ç½®çŠ¶æ€ï¼Œç¡®ä¿é¦–æ¬¡æ¸²æŸ“æ—¶èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤º
      AppStorage.set(HOME_SETTING1_ENABLED, this.setting1Enabled)
      AppStorage.set(HOME_SETTING2_ENABLED, this.setting2Enabled)
      AppStorage.set(HOME_SETTING3_ENABLED, this.setting3Enabled)
      AppStorage.set(HOME_SETTING4_ENABLED, this.setting4Enabled)
      // å»¶è¿Ÿåˆ·æ–°è®¾ç½®åŒºåŸŸå¸ƒå±€ï¼Œç¡®ä¿é¦–æ¬¡æ¸²æŸ“æ—¶å®Œæ•´æ˜¾ç¤º
      setTimeout(() => {
        this.settingsRenderKey++
        console.log('[HomeContent] aboutToAppear: ç¬¬ä¸€æ¬¡åˆ·æ–°è®¾ç½®åŒºåŸŸ')
      }, 100)
      setTimeout(() => {
        this.settingsRenderKey++
        console.log('[HomeContent] aboutToAppear: ç¬¬äºŒæ¬¡åˆ·æ–°è®¾ç½®åŒºåŸŸ')
      }, 400)
      setTimeout(() => {
        this.settingsRenderKey++
        console.log('[HomeContent] aboutToAppear: ç¬¬ä¸‰æ¬¡åˆ·æ–°è®¾ç½®åŒºåŸŸ')
      }, 800)
    })

    // åˆå§‹åŒ–è¡¨æ ¼æ•°æ®
    this.addDataToTables()

    // è®¾ç½®å¼€å§‹æ—¶é—´ä¸ºå½“å‰æ—¶é—´ï¼ˆä»…é¦–æ¬¡è¿›å…¥æ—¶ï¼‰
    const now = new Date()
    const hh = String(now.getHours()).padStart(2, '0')
    const mm = String(now.getMinutes()).padStart(2, '0')
    const ss = String(now.getSeconds()).padStart(2, '0')
    this.startTime = `${hh}:${mm}:${ss}`
    AppStorage.setOrCreate('START_TIME', this.startTime)
    AppStorage.setOrCreate('PROGRAM_NAME', this.programName)
    AppStorage.setOrCreate('SORT_SPEED', this.sortSpeed)
    AppStorage.setOrCreate('REALTIME_OUTPUT', this.realTimeOutput)
    AppStorage.setOrCreate('BATCH_COUNT', this.batchCount)
    AppStorage.setOrCreate('AVG_WEIGHT', this.avgWeight)
    AppStorage.setOrCreate('BATCH_WEIGHT', this.batchWeight)
    AppStorage.setOrCreate('EFFICIENCY', this.efficiency)
    AppStorage.setOrCreate('INTERVAL_SPEED', this.intervalSpeed)

    // å®¢æˆ·ä¿¡æ¯å±•ç¤ºï¼ˆé¡¶éƒ¨çŠ¶æ€æ ä½¿ç”¨ï¼‰
    // è‹¥æ— æœ‰æ•ˆç½‘ç»œå›¾ç‰‡é“¾æ¥ï¼Œç½®ç©ºä»¥æ˜¾ç¤ºé»˜è®¤å ä½å›¾
    AppStorage.setOrCreate('CUSTOMER_LOGO_URL', '')
    AppStorage.setOrCreate('FARM_NAME', 'ä¸€å·å†œåœº')
    AppStorage.setOrCreate('FRUIT_TYPE', 'èµ£å—è„æ©™')

    // å¯åŠ¨æ—¶é—´æ›´æ–°å®šæ—¶å™¨ï¼ˆæ¯5ç§’æ›´æ–°ä¸€æ¬¡ï¼Œå‡å°‘AppStorageæ›´æ–°é¢‘ç‡ï¼Œé¿å…è§¦å‘å¤§é‡ç›‘å¬å™¨ï¼‰
    if (!this.timeUpdateTimerId) {
      if (LOG_TIME_ENABLED) { console.log('[æ—¶é—´æ›´æ–°] å¯åŠ¨å®šæ—¶å™¨ (5sé—´éš”)') }
      this.timeUpdateTimerId = setInterval(() => {
        // å¼‚æ­¥æ›´æ–°ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
        Promise.resolve().then(() => {
          // æ›´æ–°å¼€å§‹æ—¶é—´ï¼ˆæ˜¾ç¤ºå½“å‰æ—¶é—´ï¼‰
          const now = new Date()
          const hh = String(now.getHours()).padStart(2, '0')
          const mm = String(now.getMinutes()).padStart(2, '0')
          const ss = String(now.getSeconds()).padStart(2, '0')
          const newTime = `${hh}:${mm}:${ss}`
          // åªåœ¨æ—¶é—´çœŸæ­£å˜åŒ–æ—¶æ‰æ›´æ–°AppStorageï¼ˆå‡å°‘ä¸å¿…è¦çš„æ›´æ–°ï¼‰
          if (this.startTime !== newTime) {
            this.startTime = newTime
            AppStorage.setOrCreate('START_TIME', this.startTime)
            if (LOG_TIME_ENABLED) { console.log('[æ—¶é—´æ›´æ–°] å½“å‰æ—¶é—´:', this.startTime) }
          }
        }).catch(() => {
          // é™é»˜å¤„ç†é”™è¯¯
        })
      }, 5000) as number // æ”¹ä¸º5ç§’æ›´æ–°ä¸€æ¬¡ï¼Œå‡å°‘é¢‘ç‡
    }

    // å¯åŠ¨æ¨¡æ‹Ÿå®æ—¶æ›´æ–°ï¼ˆæ¯60ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰
    if (!this.mockSortingInfoTimerId) {
      if (LOG_SORT_ENABLED) { console.log('[æ¨¡æ‹Ÿåˆ†é€‰ä¿¡æ¯] å¯åŠ¨å®šæ—¶å™¨ (60s)') }
      this.mockSortingInfoTimerId = setInterval(() => {
        // å¼‚æ­¥æ‰¹é‡æ›´æ–°ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
        Promise.resolve().then(() => {
          // é€Ÿåº¦ï¼ˆä»¶/åˆ†é’Ÿï¼‰- å˜åŒ–å¹…åº¦å‡å°
          const speed = Math.max(0, Math.round(70 + Math.random() * 20))
          this.sortSpeed = `${speed} ä»¶/åˆ†é’Ÿ`
          AppStorage.setOrCreate('SORT_SPEED', this.sortSpeed)

          // å®æ—¶äº§é‡ï¼ˆä»¶/åˆ†é’Ÿï¼‰- å˜åŒ–å¹…åº¦å‡å°
          const rto = Math.max(0, Math.round(60 + Math.random() * 20))
          this.realTimeOutput = `${rto} ä»¶/åˆ†é’Ÿ`
          AppStorage.setOrCreate('REALTIME_OUTPUT', this.realTimeOutput)

          // æœ¬æ‰¹ä¸ªæ•°ï¼ˆç´¯åŠ ï¼‰- å˜åŒ–å¹…åº¦å‡å°
          const currentCountNum = Number((this.batchCount || '0').toString().replace(/[^0-9]/g, ''))
          const nextCount = currentCountNum + Math.max(1, Math.round(Math.random() * 2))
          this.batchCount = `${nextCount} ä»¶`
          AppStorage.setOrCreate('BATCH_COUNT', this.batchCount)

          // å¹³å‡é‡é‡ï¼ˆgï¼‰- å˜åŒ–å¹…åº¦å‡å°
          const avg = (120 + Math.random() * 20) // g
          this.avgWeight = `${(avg / 1000).toFixed(2)} kg`
          AppStorage.setOrCreate('AVG_WEIGHT', this.avgWeight)

          // æœ¬æ‰¹é‡é‡ï¼ˆkgï¼ŒæŒ‰ä»¶æ•°ä¸å‡é‡ä¼°ç®—ï¼‰
          const avgKg = Number(((avg) / 1000).toFixed(2))
          const kg = nextCount * avgKg
          this.batchWeight = `${kg.toFixed(2)} kg`
          AppStorage.setOrCreate('BATCH_WEIGHT', this.batchWeight)

          // æ•ˆç‡ï¼ˆ%ï¼‰- å˜åŒ–å¹…åº¦å‡å°
          const eff = 85 + Math.random() * 10
          this.efficiency = `${eff.toFixed(0)}%`
          AppStorage.setOrCreate('EFFICIENCY', this.efficiency)

          // é—´éš”é€Ÿåº¦ï¼ˆmsï¼‰- å˜åŒ–å¹…åº¦å‡å°
          const intervalMs = 800 + Math.random() * 400
          this.intervalSpeed = `${Math.round(intervalMs)} ms`
          AppStorage.setOrCreate('INTERVAL_SPEED', this.intervalSpeed)
          // è°ƒè¯•æ—¥å¿—ï¼ˆå¯å…³é—­ï¼‰
          if (LOG_SORT_ENABLED) {
            console.log('[æ¨¡æ‹Ÿåˆ†é€‰ä¿¡æ¯] é€Ÿåº¦=', this.sortSpeed,
              ' é‡é‡=', this.batchWeight,
              ' ä¸ªæ•°=', this.batchCount,
              ' å‡é‡=', this.avgWeight,
              ' äº§é‡=', this.realTimeOutput,
              ' æ•ˆç‡=', this.efficiency,
              ' é—´éš”=', this.intervalSpeed)
          }
        }).catch(() => {
          // é™é»˜å¤„ç†é”™è¯¯ï¼Œé¿å…å½±å“å®šæ—¶å™¨
        })
      }, 60000) as number
      // ç«‹å³åˆ·æ–°ä¸€æ¬¡ï¼Œé¿å…é¦–ç§’ç©ºçª—
      {
        const speed = Math.max(0, Math.round(50 + Math.random() * 60))
        this.sortSpeed = `${speed} ä»¶/åˆ†é’Ÿ`
        AppStorage.setOrCreate('SORT_SPEED', this.sortSpeed)
        const rto = Math.max(0, Math.round(40 + Math.random() * 50))
        this.realTimeOutput = `${rto} ä»¶/åˆ†é’Ÿ`
        AppStorage.setOrCreate('REALTIME_OUTPUT', this.realTimeOutput)
        const currentCountNum = Number((this.batchCount || '0').toString().replace(/[^0-9]/g, ''))
        const nextCount = currentCountNum + Math.max(1, Math.round(Math.random() * 5))
        this.batchCount = `${nextCount} ä»¶`
        AppStorage.setOrCreate('BATCH_COUNT', this.batchCount)
        const avg = (100 + Math.random() * 50)
        this.avgWeight = `${(avg / 1000).toFixed(2)} kg`
        AppStorage.setOrCreate('AVG_WEIGHT', this.avgWeight)
        const avgKg = Number(((avg) / 1000).toFixed(2))
        const kg = nextCount * avgKg
        this.batchWeight = `${kg.toFixed(2)} kg`
        AppStorage.setOrCreate('BATCH_WEIGHT', this.batchWeight)
        const eff = 80 + Math.random() * 18
        this.efficiency = `${eff.toFixed(0)}%`
        AppStorage.setOrCreate('EFFICIENCY', this.efficiency)
        const intervalMs = 500 + Math.random() * 1200
        this.intervalSpeed = `${Math.round(intervalMs)} ms`
        AppStorage.setOrCreate('INTERVAL_SPEED', this.intervalSpeed)
        if (LOG_SORT_ENABLED) {
          console.log('[æ¨¡æ‹Ÿåˆ†é€‰ä¿¡æ¯][é¦–åˆ·] é€Ÿåº¦=', this.sortSpeed,
            ' é‡é‡=', this.batchWeight,
            ' ä¸ªæ•°=', this.batchCount,
            ' å‡é‡=', this.avgWeight,
            ' äº§é‡=', this.realTimeOutput,
            ' æ•ˆç‡=', this.efficiency,
            ' é—´éš”=', this.intervalSpeed)
        }
      }
    }
  }

  aboutToDisappear() {
    // æ¸…ç†å®šæ—¶å™¨ï¼Œé¿å…é¡µé¢ç¦»å¼€åç»§ç»­è§¦å‘å¯¼è‡´å†…å­˜æ³„æ¼
    if (this.timeUpdateTimerId) {
      clearInterval(this.timeUpdateTimerId)
      this.timeUpdateTimerId = undefined
    }
    if (this.mockSortingInfoTimerId) {
      clearInterval(this.mockSortingInfoTimerId)
      this.mockSortingInfoTimerId = undefined
    }
    // é‡Šæ”¾é€šè¿‡AppStorageä¿å­˜çš„é¡µé¢å®ä¾‹å¼•ç”¨ï¼Œé¿å…é˜»æ­¢GC
    AppStorage.setOrCreate('HOME_CONTENT_REF', null)
  }

  // æ ¹æ®FSMçŠ¶æ€æ›´æ–°é¡¶éƒ¨çŠ¶æ€æ 
  private updateTopBarForFSM(): void {
    let productionTonH: string, sumWeightTon: string, sumCounts: string, avgG: string
    
    if (this.selectedFSM === 'FSM1') {
      // FSM1çš„é¡¶éƒ¨çŠ¶æ€æ æ•°æ®ï¼ˆå»æ‰å•ä½ï¼‰
      productionTonH = '2.5'
      sumWeightTon = '1250.5'
      sumCounts = '156'
      avgG = '8.0'
    } else {
      // FSM2çš„é¡¶éƒ¨çŠ¶æ€æ æ•°æ®ï¼ˆå»æ‰å•ä½ï¼‰
      productionTonH = '3.8'
      sumWeightTon = '1580.3'
      sumCounts = '189'
      avgG = '8.4'
    }
    
    this.updateTopBar(productionTonH, sumWeightTon, sumCounts, avgG)
  }

  // ç¤ºä¾‹ï¼šå½“ä½ æ›´æ–°æœ¬åœ°çŠ¶æ€æ—¶ï¼ŒåŒæ­¥å†™å›å…¨å±€ï¼Œé¡¶éƒ¨æ ä¼šè‡ªåŠ¨åˆ·æ–°
  private updateTopBar(productionTonH: string, sumWeightTon: string, sumCounts: string, avgG: string) {
    this.topProduction = productionTonH
    this.topSumWeightTon = sumWeightTon
    this.topSumCounts = sumCounts
    this.topAvgG = avgG
    this.stateManager.updateTopProduction(productionTonH)
    this.stateManager.updateTopSumWeightTon(sumWeightTon)
    this.stateManager.updateTopSumCounts(sumCounts)
    this.stateManager.updateTopAvgG(avgG)

    AppStorage.set(TOP_PRODUCTION_TON_H, productionTonH)
    AppStorage.set(TOP_SUM_WEIGHT_TON, sumWeightTon)
    AppStorage.set(TOP_SUM_COUNTS, sumCounts)
    AppStorage.set(TOP_AVG_G, avgG)
  }
}

