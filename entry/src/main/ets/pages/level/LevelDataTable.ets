/**
 * ç­‰çº§é¡µé¢å³ä¾§æ•°æ®è¡¨æ ¼ç»„ä»¶
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - æ˜¾ç¤ºç­‰çº§è¡¨æ ¼å’Œæ•°æ®ç»Ÿè®¡è¡¨æ ¼
 * - åœ¨Levelé¡µé¢ä¸­ä½œä¸ºå³ä¾§æ•°æ®å±•ç¤ºåŒºåŸŸæ˜¾ç¤º
 * - æä¾›è¡¨æ ¼æ•°æ®çš„å±•ç¤ºå’Œç®¡ç†åŠŸèƒ½
 * - æ”¯æŒè¡¨æ ¼æ•°é‡çš„åŠ¨æ€è°ƒæ•´
 * 
 * åŒ…å«å†…å®¹ï¼š
 * - ç­‰çº§è¡¨æ ¼ï¼šæ˜¾ç¤ºç­‰çº§åç§°ã€æœ€å°é‡é‡ã€åŒ…è£…é‡é‡ç­‰ä¿¡æ¯
 * - ç»Ÿè®¡è¡¨æ ¼ï¼šæ˜¾ç¤ºåº•éƒ¨1å’Œåº•éƒ¨2çš„è®¡æ•°ã€å¹³å‡å€¼ã€è®¾å®šå€¼ç­‰æ•°æ®
 * - è¡¨æ ¼æ•°é‡é€‰æ‹©ï¼šæ”¯æŒ3-6è¡Œçš„è¡¨æ ¼æ•°é‡é…ç½®
 * - æ•°æ®æ“ä½œï¼šç”Ÿæˆéšæœºæ•°æ®ã€æ¸…ç©ºæ•°æ®ç­‰åŠŸèƒ½
 * 
 * ç»„ä»¶ç‰¹ç‚¹ï¼š
 * - å“åº”å¼è®¾è®¡ï¼šæ”¯æŒä¸»é¢˜åˆ‡æ¢å’Œæ ·å¼æ›´æ–°
 * - æ•°æ®é©±åŠ¨ï¼šæ ¹æ®ä¼ å…¥çš„æ•°æ®åŠ¨æ€æ˜¾ç¤ºè¡¨æ ¼å†…å®¹
 * - äº¤äº’å‹å¥½ï¼šæä¾›ç›´è§‚çš„æ•°æ®æ“ä½œç•Œé¢
 * - ç±»å‹å®‰å…¨ï¼šä½¿ç”¨TypeScriptæ¥å£ç¡®ä¿ç±»å‹å®‰å…¨
 * 
 * ä½¿ç”¨æ–¹å¼ï¼š
 * ```typescript
 * LevelDataTable({
 *   levelData: this.levelData,
 *   statisticsData: this.statisticsData,
 *   tableCount: this.tableCount,
 *   onTableCountChange: (count: string) => { this.handleTableCountChange(count) },
 *   onGenerateRandomData: () => { this.handleGenerateRandomData() },
 *   onClearData: () => { this.handleClearData() }
 * })
 * ```
 * 
 * å¸ƒå±€è¯´æ˜ï¼š
 * - ä½¿ç”¨Columnå¸ƒå±€å‚ç›´æ’åˆ—å„ä¸ªè¡¨æ ¼
 * - æ¯ä¸ªè¡¨æ ¼ä½¿ç”¨ç‹¬ç«‹çš„å¡ç‰‡å®¹å™¨
 * - æ”¯æŒæ»šåŠ¨æ˜¾ç¤ºï¼Œé€‚åº”ä¸åŒå±å¹•å°ºå¯¸
 * - å³ä¾§é¢æ¿å®½åº¦ï¼š75%
 */

import { BaseComponentHelper } from '../../components/common/BaseComponent'
import { OmniThemeManager, OmniThemeType, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { OMNI_THEME_KEY, OMNI_THEME_TYPE_KEY, OMNI_THEME_VERSION_KEY, useOmniTheme } from '../../utils/theme/useOmniTheme'
import { LevelData, StatisticsData, TABLE_COUNT_OPTIONS, DEFAULT_LEVEL_DATA } from './LevelConstants'

/**
 * ç»Ÿè®¡è¡¨æ ¼æ•°æ®é¡¹æ¥å£
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - å®šä¹‰ç»Ÿè®¡è¡¨æ ¼ä¸­æ¯ä¸ªå•å…ƒæ ¼çš„æ•°æ®ç»“æ„
 * - ç”¨äºGridç»„ä»¶çš„è¡¨æ ¼æ˜¾ç¤º
 * - æ”¯æŒ9åˆ—æ•°æ®ï¼ˆ1åˆ—é¡¹ç›®åç§° + 8åˆ—æ•°å€¼ï¼‰
 */
interface StatisticsTableItem {
  /** æ•°æ®é¡¹çš„å”¯ä¸€æ ‡è¯† */
  id: number
  /** é¡¹ç›®åç§° */
  itemName: string
  /** 8åˆ—æ•°æ®å€¼ */
  values: number[]
}

/**
 * Selecté€‰é¡¹æ¥å£
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - å®šä¹‰Selectç»„ä»¶çš„é€‰é¡¹æ•°æ®ç»“æ„
 * - ç”¨äºä¸‹æ‹‰é€‰æ‹©æ¡†çš„é€‰é¡¹é…ç½®
 * - ç¡®ä¿é€‰é¡¹æ•°æ®çš„ç±»å‹å®‰å…¨
 * 
 * å±æ€§è¯´æ˜ï¼š
 * - value: é€‰é¡¹çš„å€¼ï¼Œç”¨äºå†…éƒ¨é€»è¾‘å¤„ç†
 */
interface SelectOption {
  /** é€‰é¡¹çš„å€¼ï¼ˆç”¨äºå†…éƒ¨é€»è¾‘ï¼‰ */
  value: string
}

/**
 * Gridè¡¨æ ¼æ•°æ®é¡¹æ¥å£
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - å®šä¹‰Gridè¡¨æ ¼ä¸­æ¯ä¸ªæ•°æ®é¡¹çš„ç»“æ„
 * - åŒ…å«ç­‰çº§ã€é‡é‡ã€çŠ¶æ€ç­‰ä¿¡æ¯
 * - ç”¨äºGridè¡¨æ ¼çš„æ•°æ®å±•ç¤º
 * 
 * å±æ€§è¯´æ˜ï¼š
 * - id: æ•°æ®é¡¹çš„å”¯ä¸€æ ‡è¯†
 * - level: ç­‰çº§ç¼–å·
 * - weight: é‡é‡ä¿¡æ¯
 * - status: çŠ¶æ€ä¿¡æ¯
 */
interface GridTableItem {
  /** æ•°æ®é¡¹çš„å”¯ä¸€æ ‡è¯† */
  id: number
  /** ç­‰çº§ç¼–å· */
  level: string
  /** é‡é‡ä¿¡æ¯ */
  weight: string
  /** çŠ¶æ€ä¿¡æ¯ */
  status: string
}

/**
 * ç­‰çº§è¡¨æ ¼æ•°æ®é¡¹æ¥å£
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - å®šä¹‰ç­‰çº§è¡¨æ ¼ä¸­æ¯ä¸ªæ•°æ®é¡¹çš„ç»“æ„
 * - åŒ…å«ç­‰çº§åç§°ã€æœ€å°é‡é‡ã€è£…ç®±é‡ç­‰ä¿¡æ¯
 * - ç”¨äºList+ListItemè¡¨æ ¼çš„æ•°æ®å±•ç¤º
 * 
 * å±æ€§è¯´æ˜ï¼š
 * - id: æ•°æ®é¡¹çš„å”¯ä¸€æ ‡è¯†
 * - levelName: ç­‰çº§åç§°ï¼ˆå¯ç¼–è¾‘ï¼‰
 * - minWeight: æœ€å°é‡é‡ï¼ˆå…‹ï¼‰
 * - packingWeight: è£…ç®±é‡ï¼ˆå…‹ï¼‰
 */
interface LevelTableData {
  /** æ•°æ®é¡¹çš„å”¯ä¸€æ ‡è¯† */
  id: number
  /** ç­‰çº§åç§°ï¼ˆå¯ç¼–è¾‘ï¼‰ */
  levelName: string
  /** æœ€å°é‡é‡ï¼ˆå…‹ï¼‰ */
  minWeight: number
  /** è£…ç®±é‡ï¼ˆå…‹ï¼‰ */
  packingWeight: number
}

/**
 * ç­‰çº§é¡µé¢å³ä¾§æ•°æ®è¡¨æ ¼ç»„ä»¶ç»“æ„ä½“
 * 
 * å±æ€§è¯´æ˜ï¼š
 * - levelData: ç­‰çº§æ•°æ®æ•°ç»„ï¼Œé»˜è®¤ç©ºæ•°ç»„
 * - statisticsData: ç»Ÿè®¡æ•°æ®å¯¹è±¡
 * - tableCount: è¡¨æ ¼æ•°é‡ï¼Œé»˜è®¤ç¬¬ä¸€ä¸ªé€‰é¡¹
 * - onTableCountChange: è¡¨æ ¼æ•°é‡å˜åŒ–å›è°ƒå‡½æ•°
 * - onGenerateRandomData: ç”Ÿæˆéšæœºæ•°æ®å›è°ƒå‡½æ•°
 * - onClearData: æ¸…ç©ºæ•°æ®å›è°ƒå‡½æ•°
 * - consumedTheme: å½“å‰ä¸»é¢˜æ ·å¼
 * - consumedThemeType: å½“å‰ä¸»é¢˜ç±»å‹
 * - themeVersion: ä¸»é¢˜ç‰ˆæœ¬å·
 * - baseComponentHelper: åŸºç¡€ç»„ä»¶åŠ©æ‰‹
 * - headerIndices: è¡¨å¤´ç´¢å¼•æ•°ç»„
 * 
 * æ–¹æ³•è¯´æ˜ï¼š
 * - getCurrentTheme(): è·å–å½“å‰ä¸»é¢˜é…ç½®
 * - build(): æ„å»ºæ•°æ®è¡¨æ ¼çš„UIç»“æ„
 */
@Component
export struct LevelDataTable {
  // ==================== æ•°æ®å±æ€§ ====================
  /**
   * ç­‰çº§æ•°æ®æ•°ç»„
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨ç­‰çº§è¡¨æ ¼çš„æ•°æ®
   * - é»˜è®¤å€¼ä¸ºç©ºæ•°ç»„
   * - ä»çˆ¶ç»„ä»¶ä¼ å…¥ï¼Œæ”¯æŒåŠ¨æ€æ›´æ–°
   */
  @Prop levelData: LevelData[] = []
  
  /**
   * ç»Ÿè®¡æ•°æ®å¯¹è±¡
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨ç»Ÿè®¡è¡¨æ ¼çš„æ•°æ®
   * - åŒ…å«åº•éƒ¨1å’Œåº•éƒ¨2çš„å„ç§æ•°æ®
   * - ä»çˆ¶ç»„ä»¶ä¼ å…¥ï¼Œæ”¯æŒåŠ¨æ€æ›´æ–°
   */
  @Prop @Watch('onExternalStatsChange') statisticsData: StatisticsData
  
  /**
   * è¡¨æ ¼æ•°é‡
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ§åˆ¶è¡¨æ ¼æ˜¾ç¤ºçš„è¡Œæ•°
   * - é»˜è®¤å€¼ä¸ºç¬¬ä¸€ä¸ªé€‰é¡¹
   * - æ”¯æŒ3-6è¡Œçš„è¡¨æ ¼æ•°é‡é…ç½®
   */
  @Prop tableCount: string = TABLE_COUNT_OPTIONS[0].value
  /** çˆ¶ç»„ä»¶ä¼ å…¥çš„åˆ·æ–°é©±åŠ¨é”®ï¼ˆæ•°å€¼å˜åŒ–å³è§¦å‘åˆ·æ–°ï¼‰ */
  @Prop @Watch('onExternalStatsChange') refreshKey: number = 0
  /**
   * ç»Ÿè®¡è¡¨ç¼–è¾‘å›è°ƒï¼šçˆ¶ç»„ä»¶æ¥æ”¶å•å…ƒæ ¼ç¼–è¾‘å¹¶å¤„ç†è”åŠ¨
   * row: 'bottom1' | 'bottom2'
   * field: 'count' | 'avg' | 'set'
   * colIndex: 0..7 å¯¹åº”8åˆ—
   * value: æ–°å€¼ï¼ˆæ•°å­—ï¼‰
   */
  onEditStat?: (row: 'bottom1' | 'bottom2', field: 'count' | 'avg' | 'set', colIndex: number, value: number) => void

  /**
   * ç­‰çº§æ•°é‡ç´¢å¼•
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ§åˆ¶å“è´¨è¡¨æ ¼æ˜¾ç¤ºçš„ç­‰çº§æ•°é‡
   * - é»˜è®¤å€¼ä¸º0ï¼ˆä¸æ˜¾ç¤ºï¼‰
   * - æ”¯æŒ0-16ä¸ªç­‰çº§çš„é€‰æ‹©
   */

  // ==================== ç­‰çº§è¡¨æ ¼ç›¸å…³ ====================
  
  /**
   * ç­‰çº§æ•°é‡ç´¢å¼•
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ§åˆ¶ç­‰çº§è¡¨æ ¼æ˜¾ç¤ºçš„ç­‰çº§æ•°é‡
   * - é»˜è®¤å€¼ä¸º0ï¼ˆ2ä¸ªç­‰çº§ï¼‰
   * - æ”¯æŒ2-7ä¸ªç­‰çº§çš„é€‰æ‹©
   */
  @State private levelCountIndex: number = 0

  /**
   * ç­‰çº§è¡¨æ ¼æ•°æ®
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨ç­‰çº§è¡¨æ ¼è¦æ˜¾ç¤ºçš„æ•°æ®
   * - åŒ…å«ç­‰çº§åç§°ã€æœ€å°é‡é‡ã€è£…ç®±é‡ç­‰ä¿¡æ¯
   * - æ”¯æŒåŠ¨æ€æ›´æ–°å’Œç¼–è¾‘
   */
  @State private levelTableData: LevelTableData[] = []

  /**
   * ç­‰çº§åç§°è¾“å…¥æ•°ç»„
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨ç­‰çº§åç§°çš„è¾“å…¥å€¼
   * - ç”¨äºTextInputçš„å—æ§ç»„ä»¶
   * - æ”¯æŒå®æ—¶ç¼–è¾‘å’ŒéªŒè¯
   */
  @State private levelNameInputs: string[] = []

  /**
   * æœ€å°é‡é‡è¾“å…¥æ•°ç»„ï¼ˆå—æ§è¾“å…¥ï¼‰
   */
  @State private minWeightInputs: string[] = []

  /**
   * è£…ç®±é‡è¾“å…¥æ•°ç»„ï¼ˆå—æ§è¾“å…¥ï¼‰
   */
  @State private packingWeightInputs: string[] = []

  /**
   * æ§åˆ¶æ¯è¡Œæ˜¯å¦æ˜¾ç¤º+/-æŒ‰é’®
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ§åˆ¶æ¯è¡Œæ˜¯å¦æ˜¾ç¤ºæ·»åŠ /åˆ é™¤æŒ‰é’®
   * - å½“ç”¨æˆ·ç‚¹å‡»æœ€å°é‡é‡åˆ—æ—¶æ˜¾ç¤ºæŒ‰é’®
   * - æ”¯æŒåŠ¨æ€åˆ‡æ¢æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
   */
  @State private showAddRemoveButtons: boolean[] = []

  /**
   * å½“å‰é€‰ä¸­çš„è¡Œç´¢å¼•
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - è®°å½•å½“å‰ç”¨æˆ·é€‰ä¸­çš„è¡Œç´¢å¼•
   * - ç”¨äºæ§åˆ¶æŒ‰é’®çš„æ˜¾ç¤ºå’Œéšè—
   * - æ”¯æŒå•é€‰æ¨¡å¼
   */
  @State private selectedRowIndex: number = -1
  @State private forceRefresh: number = 0 // å¼ºåˆ¶åˆ·æ–°UI

  // ==================== Gridè¡¨æ ¼ç›¸å…³ ====================
  
  /**
   * Gridè¡¨æ ¼æ•°æ®
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨Gridè¡¨æ ¼è¦æ˜¾ç¤ºçš„æ•°æ®
   * - åŒ…å«ç­‰çº§ã€é‡é‡ã€çŠ¶æ€ç­‰ä¿¡æ¯
   * - æ”¯æŒåŠ¨æ€æ›´æ–°
   */
  @State private gridTableData: GridTableItem[] = [
    { id: 1, level: '1', weight: '100g', status: 'æ­£å¸¸' },
    { id: 2, level: '2', weight: '95g', status: 'æ­£å¸¸' },
    { id: 3, level: '3', weight: '90g', status: 'æ­£å¸¸' },
    { id: 4, level: '4', weight: '85g', status: 'æ­£å¸¸' },
    { id: 5, level: '5', weight: '80g', status: 'æ­£å¸¸' },
    { id: 6, level: '6', weight: '75g', status: 'æ­£å¸¸' },
    { id: 7, level: '7', weight: '70g', status: 'æ­£å¸¸' },
    { id: 8, level: '8', weight: '65g', status: 'æ­£å¸¸' },
    { id: 9, level: '9', weight: '60g', status: 'æ­£å¸¸' },
    { id: 10, level: '10', weight: '55g', status: 'æ­£å¸¸' },
    { id: 11, level: '11', weight: '50g', status: 'æ­£å¸¸' },
    { id: 12, level: '12', weight: '45g', status: 'æ­£å¸¸' },
    { id: 13, level: '13', weight: '40g', status: 'æ­£å¸¸' },
    { id: 14, level: '14', weight: '35g', status: 'æ­£å¸¸' },
    { id: 15, level: '15', weight: '30g', status: 'æ­£å¸¸' },
    { id: 16, level: '16', weight: '25g', status: 'æ­£å¸¸' }
  ]

  /**
   * ç»Ÿè®¡è¡¨æ ¼æ•°æ®
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨ç»Ÿè®¡è¡¨æ ¼è¦æ˜¾ç¤ºçš„æ•°æ®
   * - åŒ…å«6è¡Œæ•°æ®ï¼šè£…ç®±æ•°é‡ã€å¹³å‡é‡é‡ã€è®¾ç½®é‡é‡ï¼ˆåº•éƒ¨1å’Œåº•éƒ¨2å„3è¡Œï¼‰
   * - æ”¯æŒåŠ¨æ€æ›´æ–°
   */
  @State private statisticsTableData: StatisticsTableItem[] = []
  @State private statsRefreshTick: number = 0
  // è¾“å…¥ç¼“å†²ï¼Œé¿å… onChange ç›´æ¥è§¦å‘çˆ¶çº§é‡å»ºå¯¼è‡´ç„¦ç‚¹è·³åŠ¨
  @State private bufB1Counts: number[] = []
  @State private bufB1Avgs: number[] = []
  @State private bufB1Sets: number[] = []
  @State private bufB2Counts: number[] = []
  @State private bufB2Avgs: number[] = []
  @State private bufB2Sets: number[] = []


  // ==================== ç”Ÿå‘½å‘¨æœŸæ–¹æ³• ====================
  /**
   * ç»„ä»¶å³å°†å‡ºç°æ—¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - åˆå§‹åŒ–ç»Ÿè®¡è¡¨æ ¼æ•°æ®
   * - å°†statisticsDataè½¬æ¢ä¸ºGridè¡¨æ ¼æ ¼å¼
   */
  aboutToAppear(): void {
    this.initializeStatisticsData()
    this.initializeLevelData()
  }

  /**
   * ç»„ä»¶æ›´æ–°æ—¶åŒæ­¥æœ€æ–°çš„ç»Ÿè®¡æ•°æ®åˆ°å†…è¡¨
   * - å½“çˆ¶ç»„ä»¶ä¼ å…¥çš„ statisticsData å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé‡å»º statisticsTableData
   */
  aboutToUpdate(): void {
    this.initializeStatisticsData()
    this.statsRefreshTick++
    console.log('ã€ç­‰çº§é¡µé¢ã€‘è¡¨æ ¼æ›´æ–°ï¼šå·²é‡å»ºç»Ÿè®¡æ•°æ®', JSON.stringify(this.statisticsTableData))
  }

  /**
   * å¤–éƒ¨ç»Ÿè®¡æ•°æ®æˆ–åˆ·æ–°é”®å˜åŒ–æ—¶çš„å›è°ƒ
   */
  private onExternalStatsChange(): void {
    this.initializeStatisticsData()
    this.statsRefreshTick++
    console.log('ã€ç­‰çº§é¡µé¢ã€‘æ”¶åˆ°å¤–éƒ¨ç»Ÿè®¡å˜åŒ–ï¼šå·²é‡å»ºç»Ÿè®¡æ•°æ®', JSON.stringify(this.statisticsTableData))
  }

  /**
   * åˆå§‹åŒ–ç­‰çº§è¡¨æ ¼æ•°æ®
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ ¹æ®ç­‰çº§æ•°é‡åˆ›å»ºç­‰çº§è¡¨æ ¼æ•°æ®
   * - åˆå§‹åŒ–ç­‰çº§åç§°è¾“å…¥æ•°ç»„
   * - è®¾ç½®é»˜è®¤çš„ç­‰çº§åç§°ã€æœ€å°é‡é‡ã€è£…ç®±é‡
   */
  private initializeLevelData(): void {
    // ä¼˜å…ˆä½¿ç”¨çˆ¶ç»„ä»¶ä¼ å…¥æ•°æ®é•¿åº¦ï¼›è‹¥çˆ¶ç»„ä»¶æœªä¼ å…¥ï¼Œåˆ™ä½¿ç”¨æœ¬å¡ç‰‡é€‰æ‹©çš„æ•°é‡ï¼ˆç´¢å¼•å³æ•°é‡ï¼š0-10ï¼‰
    const propCount = Array.isArray(this.levelData) ? this.levelData.length : 0
    const levelCount = propCount > 0 ? propCount : this.levelCountIndex

    if (levelCount <= 0) {
      this.levelTableData = []
      this.levelNameInputs = []
      return
    }

    this.levelTableData = []
    this.levelNameInputs = []
    this.minWeightInputs = []
    this.packingWeightInputs = []

    for (let i = 0; i < levelCount; i++) {
      // è‹¥çˆ¶ç»„ä»¶æœªæä¾›å…·ä½“å­—æ®µï¼Œè¿™é‡Œå…ˆç”¨å ä½ç”Ÿæˆåç§°ï¼ˆ1..Nï¼‰ï¼Œé¿å…ç©ºç™½
      this.levelTableData.push({
        id: i + 1,
        levelName: `${i + 1}`,
        minWeight: 100 - i * 5,
        packingWeight: 500 + i * 50
      })
      this.levelNameInputs.push(`${i + 1}`)
      this.minWeightInputs.push(`${100 - i * 5}`)
      this.packingWeightInputs.push(`${500 + i * 50}`)
      this.showAddRemoveButtons.push(false) // åˆå§‹åŒ–æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
    }
  }

  /**
   * å¤„ç†æœ€å°é‡é‡åˆ—ç‚¹å‡»äº‹ä»¶
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å½“ç”¨æˆ·ç‚¹å‡»æœ€å°é‡é‡åˆ—æ—¶æ˜¾ç¤º+/-æŒ‰é’®
   * - éšè—å…¶ä»–è¡Œçš„æŒ‰é’®ï¼Œåªæ˜¾ç¤ºå½“å‰è¡Œçš„æŒ‰é’®
   * - æ”¯æŒåˆ‡æ¢æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
   * 
   * @param index è¡Œç´¢å¼•
   */
  private handleMinWeightClick(index: number): void {
    // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰é€‰ä¸­çš„è¡Œï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œï¼ˆä¿æŒæŒ‰é’®æ˜¾ç¤ºï¼‰
    if (this.selectedRowIndex === index) {
      return // ç‚¹å‡»åŒä¸€è¡Œæ—¶ä¿æŒæŒ‰é’®æ˜¾ç¤ºï¼Œä¸åšä»»ä½•æ“ä½œ
    } else {
      // éšè—æ‰€æœ‰æŒ‰é’®ï¼Œç„¶åæ˜¾ç¤ºå½“å‰è¡Œçš„æŒ‰é’®
      this.showAddRemoveButtons = this.showAddRemoveButtons.map(() => false)
      this.showAddRemoveButtons[index] = true
      this.selectedRowIndex = index
    }
  }

  /**
   * æ·»åŠ æ–°è¡Œ
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - åœ¨æŒ‡å®šä½ç½®åæ·»åŠ æ–°çš„ç­‰çº§è¡Œ
   * - è‡ªåŠ¨ç”Ÿæˆæ–°çš„ç­‰çº§åç§°å’Œé»˜è®¤å€¼
   * - æ›´æ–°æ‰€æœ‰ç›¸å…³çš„æ•°ç»„
   * - æ’å…¥åé‡æ–°æ’åºæ‰€æœ‰ç­‰çº§åç§°ï¼Œç¡®ä¿è¿ç»­æ€§
   * 
   * @param index æ’å…¥ä½ç½®ï¼ˆåœ¨æŒ‡å®šè¡Œåæ’å…¥ï¼‰
   */
  private addNewRow(index: number): void {
    const newId = Math.max(...this.levelTableData.map(item => item.id)) + 1
    const newMinWeight = 100 - (this.levelTableData.length * 5)
    const newPackingWeight = 500 + (this.levelTableData.length * 50)
    
    // åœ¨æŒ‡å®šä½ç½®åæ’å…¥æ–°è¡Œ
    const insertIndex = index + 1
    this.levelTableData.splice(insertIndex, 0, {
      id: newId,
      levelName: '0', // ä¸´æ—¶åç§°ï¼Œç¨åä¼šé‡æ–°æ’åº
      minWeight: newMinWeight,
      packingWeight: newPackingWeight
    })
    
    // æ›´æ–°è¾“å…¥æ•°ç»„
    this.levelNameInputs.splice(insertIndex, 0, '0') // ä¸´æ—¶åç§°
    this.minWeightInputs.splice(insertIndex, 0, `${newMinWeight}`)
    this.packingWeightInputs.splice(insertIndex, 0, `${newPackingWeight}`)
    this.showAddRemoveButtons.splice(insertIndex, 0, false)
    
    // é‡æ–°æ’åºæ‰€æœ‰ç­‰çº§åç§°ï¼Œç¡®ä¿è¿ç»­æ€§ï¼ˆ1, 2, 3, 4...ï¼‰
    for (let i = 0; i < this.levelTableData.length; i++) {
      const newLevelName = `${i + 1}`
      this.levelTableData[i].levelName = newLevelName
      this.levelNameInputs[i] = newLevelName
    }
    
    // æ›´æ–°ç­‰çº§æ•°é‡é€‰æ‹©å™¨ - ç›´æ¥ä½¿ç”¨è¡Œæ•°ä½œä¸ºç´¢å¼•
    this.levelCountIndex = this.levelTableData.length
    
    // å¼ºåˆ¶åˆ·æ–°UI - é‡æ–°åˆ›å»ºæ•°ç»„å¼•ç”¨ä»¥è§¦å‘UIæ›´æ–°
    // å…ˆæ¸…ç©ºæ•°ç»„ï¼Œå†é‡æ–°èµ‹å€¼ï¼Œç¡®ä¿UIå®Œå…¨åˆ·æ–°
    const tempLevelTableData = [...this.levelTableData]
    const tempLevelNameInputs = [...this.levelNameInputs]
    const tempMinWeightInputs = [...this.minWeightInputs]
    const tempPackingWeightInputs = [...this.packingWeightInputs]
    const tempShowAddRemoveButtons = [...this.showAddRemoveButtons]
    
    // æ¸…ç©ºåŸæ•°ç»„
    this.levelTableData = []
    this.levelNameInputs = []
    this.minWeightInputs = []
    this.packingWeightInputs = []
    this.showAddRemoveButtons = []
    
    // é‡æ–°èµ‹å€¼
    this.levelTableData = tempLevelTableData
    this.levelNameInputs = tempLevelNameInputs
    this.minWeightInputs = tempMinWeightInputs
    this.packingWeightInputs = tempPackingWeightInputs
    this.showAddRemoveButtons = tempShowAddRemoveButtons
    
    // å¼ºåˆ¶åˆ·æ–°UI
    this.forceRefresh++
    
    // ä¿æŒå½“å‰è¡Œçš„æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€ï¼Œä¸éšè—æŒ‰é’®
    // è¿™æ ·ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ·»åŠ æˆåŠŸï¼Œå¹¶ä¸”å¯ä»¥ç»§ç»­æ“ä½œ
    
    console.log(`åœ¨ä½ç½®${insertIndex}æ·»åŠ äº†æ–°è¡Œï¼Œç­‰çº§åç§°å·²é‡æ–°æ’åº:`, this.levelTableData.map(item => item.levelName))
  }

  /**
   * åˆ é™¤æŒ‡å®šè¡Œ
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - åˆ é™¤æŒ‡å®šç´¢å¼•çš„ç­‰çº§è¡Œ
   * - æ›´æ–°æ‰€æœ‰ç›¸å…³çš„æ•°ç»„
   * - ç¡®ä¿è‡³å°‘ä¿ç•™ä¸€è¡Œæ•°æ®
   * - åˆ é™¤åé‡æ–°æ’åºæ‰€æœ‰ç­‰çº§åç§°ï¼Œç¡®ä¿è¿ç»­æ€§
   * 
   * @param index è¦åˆ é™¤çš„è¡Œç´¢å¼•
   */
  private removeRow(index: number): void {
    // ç¡®ä¿è‡³å°‘ä¿ç•™ä¸€è¡Œ
    if (this.levelTableData.length <= 1) {
      console.log('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡Œæ•°æ®')
      return
    }
    
    // åˆ é™¤æŒ‡å®šè¡Œ
    this.levelTableData.splice(index, 1)
    this.levelNameInputs.splice(index, 1)
    this.minWeightInputs.splice(index, 1)
    this.packingWeightInputs.splice(index, 1)
    this.showAddRemoveButtons.splice(index, 1)
    
    // é‡æ–°æ’åºæ‰€æœ‰ç­‰çº§åç§°ï¼Œç¡®ä¿è¿ç»­æ€§ï¼ˆ1, 2, 3, 4...ï¼‰
    for (let i = 0; i < this.levelTableData.length; i++) {
      const newLevelName = `${i + 1}`
      this.levelTableData[i].levelName = newLevelName
      this.levelNameInputs[i] = newLevelName
    }
    
    // æ›´æ–°ç­‰çº§æ•°é‡é€‰æ‹©å™¨
    this.levelCountIndex = this.levelTableData.length
    
    // ä¿æŒæŒ‰é’®æ˜¾ç¤ºçŠ¶æ€ï¼Œè®©ç”¨æˆ·å¯ä»¥ç»§ç»­æ“ä½œ
    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­è¡Œï¼Œåˆ™æ¸…é™¤é€‰ä¸­çŠ¶æ€
    if (this.selectedRowIndex === index) {
      this.selectedRowIndex = -1
      this.showAddRemoveButtons = this.showAddRemoveButtons.map(() => false)
    } else if (this.selectedRowIndex > index) {
      // å¦‚æœåˆ é™¤çš„è¡Œåœ¨å½“å‰é€‰ä¸­è¡Œä¹‹å‰ï¼Œéœ€è¦è°ƒæ•´é€‰ä¸­ç´¢å¼•
      this.selectedRowIndex = this.selectedRowIndex - 1
    }
    
    console.log(`åˆ é™¤äº†ä½ç½®${index}çš„è¡Œï¼Œç­‰çº§åç§°å·²é‡æ–°æ’åº:`, this.levelTableData.map(item => item.levelName))
  }

  /**
   * æ„å»ºç­‰çº§è¡¨æ ¼è¡¨å¤´
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ„å»ºå›ºå®šè¡¨å¤´ï¼šç­‰çº§åç§°|æœ€å°é‡é‡ï¼ˆå…‹ï¼‰|è£…ç®±é‡ï¼ˆå…‹ï¼‰
   * - è¡¨å¤´å›ºå®šä¸æ»šåŠ¨
   */
  @Builder
  buildLevelTableHeader() {
    Row() {
      // ç­‰çº§åç§°åˆ—
      Text('ç­‰çº§åç§°')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .width('20%')
        .textAlign(TextAlign.Center)
        .padding({ top: 4, bottom: 4 })

      Divider().vertical(true).height(30).color(this.getCurrentTheme().borderColor)

      // æœ€å°é‡é‡åˆ—
      Text('æœ€å°é‡é‡ï¼ˆå…‹ï¼‰')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .width('40%')
        .textAlign(TextAlign.Center)
        .padding({ top: 4, bottom: 4 })

      Divider().vertical(true).height(30).color(this.getCurrentTheme().borderColor)

      // è£…ç®±é‡åˆ—
      Text('è£…ç®±é‡ï¼ˆå…‹ï¼‰')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .width('40%')
        .textAlign(TextAlign.Center)
        .padding({ top: 4, bottom: 4 })
    }
    .width('100%')
    .height(40)
    .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })
    .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
  }

  /**
   * æ„å»ºç­‰çº§è¡¨æ ¼æ•°æ®è¡Œ
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ„å»ºæ•°æ®è¡Œï¼šç­‰çº§åç§°ï¼ˆå¯ç¼–è¾‘ï¼‰|æœ€å°é‡é‡|è£…ç®±é‡
   * - æ”¯æŒç­‰çº§åç§°çš„å®æ—¶ç¼–è¾‘
   */
  @Builder
  buildLevelListItem(data: LevelTableData, index: number) {
    Row() {
      // ç­‰çº§åç§°åˆ—ï¼ˆåªè¯»æ˜¾ç¤ºï¼‰
      Text(`${this.levelNameInputs[index] || data.levelName}`)
        .fontSize(16)
        .fontColor(this.getCurrentTheme().textColor)
        .width('20%')
        .textAlign(TextAlign.Center)
        .padding({ left: 4, right: 4, top: 6, bottom: 6 })
        .id(`levelName_${data.id}_${index}_${this.forceRefresh}`) // æ·»åŠ å¼ºåˆ¶åˆ·æ–°ID

      Divider().vertical(true).height(80).color(this.getCurrentTheme().borderColor) //ä¿®æ”¹ç¬¬ä¸€ä¸ªåˆ†å‰²çº¿çš„é«˜åº¦

      // æœ€å°é‡é‡åˆ—ï¼ˆå¯ç¼–è¾‘ï¼Œå¸¦+/-æŒ‰é’®ï¼‰
      Row() {
        TextInput({ text: this.minWeightInputs[index] ?? `${data.minWeight}` })
          .fontSize(16)
          .fontColor(this.getCurrentTheme().textColor)
          .backgroundColor(this.getCurrentTheme().surfaceColor)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .padding({ left: 4, right: 4, top: 6, bottom: 6 })
          .border({ width: 0 })
          .type(InputType.Number)
          .onChange((value: string) => {
            const numericStr = value.replace(/[^0-9.\-]/g, '')
            this.minWeightInputs[index] = numericStr
            const parsed = Number(numericStr)
            if (!isNaN(parsed)) {
              this.levelTableData[index].minWeight = parsed
            }
          })
          .onClick(() => {
            this.handleMinWeightClick(index)
          })
          .onBlur(() => {
            // å¤±å»ç„¦ç‚¹æ—¶éšè—æŒ‰é’®
            this.showAddRemoveButtons = this.showAddRemoveButtons.map(() => false)
            this.selectedRowIndex = -1
          })

        // +/- æŒ‰é’®åŒºåŸŸ
        if (this.showAddRemoveButtons[index]) {
          Row() {
            // + æŒ‰é’®
            Button() {
              Text('+')
                .fontSize(14)
                .fontColor(this.getCurrentTheme().textColor)
            }
            .width(24)
            .height(24)
            .backgroundColor(this.getCurrentTheme().primary)
            .borderRadius(12)
            .onClick(() => {
              this.addNewRow(index)
            })

            // - æŒ‰é’®
            Button() {
              Text('-')
                .fontSize(14)
                .fontColor(this.getCurrentTheme().textColor)
            }
            .width(24)
            .height(24)
            .backgroundColor('#FF5722')
            .borderRadius(12)
            .margin({ left: 4 })
            .onClick(() => {
              this.removeRow(index)
            })
          }
          .margin({ left: 8 })
        }
      }
      .width('40%')
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      Divider().vertical(true).height(80).color(this.getCurrentTheme().borderColor) //ä¿®æ”¹ç¬¬äºŒä¸ªåˆ†å‰²çº¿çš„é«˜åº¦

      // è£…ç®±é‡åˆ—ï¼ˆå¯ç¼–è¾‘ï¼‰
      TextInput({ text: this.packingWeightInputs[index] ?? `${data.packingWeight}` })
        .fontSize(16)
        .fontColor(this.getCurrentTheme().textColor)
        .backgroundColor(this.getCurrentTheme().surfaceColor)
        .width('40%')
        .textAlign(TextAlign.Center)
        .padding({ left: 4, right: 4, top: 6, bottom: 6 })
        .border({ width: 0 })
        .type(InputType.Number)
        .onChange((value: string) => {
          const numericStr = value.replace(/[^0-9.\-]/g, '')
          this.packingWeightInputs[index] = numericStr
          const parsed = Number(numericStr)
          if (!isNaN(parsed)) {
            this.levelTableData[index].packingWeight = parsed
          }
        })
    }
    .width('100%')
    .height(50)  //ä¿®æ”¹è¡¨æ ¼æ¯ä¸€è¡Œçš„è¡Œé«˜
    .padding(0)
    .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })
  }

  /**
   * åˆå§‹åŒ–ç»Ÿè®¡è¡¨æ ¼æ•°æ®
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å°†statisticsDataè½¬æ¢ä¸ºStatisticsTableItemæ ¼å¼
   * - åˆ›å»º6è¡Œæ•°æ®ï¼šåº•éƒ¨1å’Œåº•éƒ¨2çš„å„3è¡Œæ•°æ®
   */
  private initializeStatisticsData(): void {
    const b1Counts = this.statisticsData.bottom1Counts || []
    const b1Sets = this.statisticsData.bottom1Sets || []
    const b1AvgsComputed = b1Counts.map((cnt, i) => {
      const setVal = b1Sets[i] ?? 0
      return cnt > 0 ? Math.round(setVal / cnt) : (this.statisticsData.bottom1Avgs?.[i] ?? 0)
    })

    const b2Counts = this.statisticsData.bottom2Counts || []
    const b2Sets = this.statisticsData.bottom2Sets || []
    const b2AvgsComputed = b2Counts.map((cnt, i) => {
      const setVal = b2Sets[i] ?? 0
      return cnt > 0 ? Math.round(setVal / cnt) : (this.statisticsData.bottom2Avgs?.[i] ?? 0)
    })

    this.statisticsTableData = [
      { id: 1, itemName: 'è£…ç®±æ•°é‡', values: b1Counts },
      { id: 2, itemName: 'å¹³å‡é‡é‡', values: b1AvgsComputed },
      { id: 3, itemName: 'è®¾ç½®é‡é‡', values: b1Sets },
      { id: 4, itemName: 'è£…ç®±æ•°é‡', values: b2Counts },
      { id: 5, itemName: 'å¹³å‡é‡é‡', values: b2AvgsComputed },
      { id: 6, itemName: 'è®¾ç½®é‡é‡', values: b2Sets }
    ]

    // åŒæ­¥ç¼“å†²
    this.bufB1Counts = b1Counts.slice()
    this.bufB1Avgs = b1AvgsComputed.slice()
    this.bufB1Sets = b1Sets.slice()
    this.bufB2Counts = b2Counts.slice()
    this.bufB2Avgs = b2AvgsComputed.slice()
    this.bufB2Sets = b2Sets.slice()
  }

  // ==================== äº‹ä»¶å›è°ƒå‡½æ•° ====================
  /**
   * è¡¨æ ¼æ•°é‡å˜åŒ–å›è°ƒå‡½æ•°
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å½“ç”¨æˆ·é€‰æ‹©è¡¨æ ¼æ•°é‡æ—¶è§¦å‘
   * - ä¼ é€’é€‰ä¸­çš„è¡¨æ ¼æ•°é‡ç»™çˆ¶ç»„ä»¶
   * - ç”¨äºå¤„ç†è¡¨æ ¼æ•°é‡å˜åŒ–é€»è¾‘
   */
  onTableCountChange?: (count: string) => void
  

  // ==================== ä¸»é¢˜ç›¸å…³å±æ€§ ====================
  /**
   * å½“å‰ä¸»é¢˜æ ·å¼
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨å½“å‰ä¸»é¢˜çš„æ ·å¼é…ç½®
   * - ä½¿ç”¨@StorageLinkå®ç°ä¸»é¢˜å“åº”å¼æ›´æ–°
   * - é»˜è®¤å€¼ä¸ºå½“å‰ä¸»é¢˜ç®¡ç†å™¨çš„ä¸»é¢˜
   */
  @StorageLink(OMNI_THEME_KEY) consumedTheme: ExtendedOmniThemeStyle = OmniThemeManager.getInstance().getCurrentTheme()
  
  /**
   * å½“å‰ä¸»é¢˜ç±»å‹
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨å½“å‰ä¸»é¢˜çš„ç±»å‹
   * - ä½¿ç”¨@StorageLinkå®ç°ä¸»é¢˜å“åº”å¼æ›´æ–°
   * - é»˜è®¤å€¼ä¸ºå½“å‰ä¸»é¢˜ç®¡ç†å™¨çš„ä¸»é¢˜ç±»å‹
   */
  @StorageLink(OMNI_THEME_TYPE_KEY) consumedThemeType: OmniThemeType = OmniThemeManager.getInstance().getCurrentThemeType()
  
  /**
   * ä¸»é¢˜ç‰ˆæœ¬å·
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨ä¸»é¢˜çš„ç‰ˆæœ¬å·
   * - ç”¨äºä¸»é¢˜æ›´æ–°æ—¶çš„ç‰ˆæœ¬æ§åˆ¶
   * - é»˜è®¤å€¼ä¸º0
   */
  @StorageLink(OMNI_THEME_VERSION_KEY) themeVersion: number = 0
  
  /**
   * åŸºç¡€ç»„ä»¶åŠ©æ‰‹
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æä¾›åŸºç¡€ç»„ä»¶çš„é€šç”¨åŠŸèƒ½
   * - ç”¨äºä¸»é¢˜ç®¡ç†å’Œæ ·å¼é…ç½®
   * - å®ä¾‹åŒ–BaseComponentHelper
   */
  private baseComponentHelper = new BaseComponentHelper()
  
  /**
   * è¡¨å¤´ç´¢å¼•æ•°ç»„
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å®šä¹‰è¡¨æ ¼è¡¨å¤´çš„ç´¢å¼•
   * - ç”¨äºè¡¨æ ¼æ•°æ®çš„æ˜¾ç¤ºå’Œæ’åº
   * - åŒ…å«0-7çš„ç´¢å¼•å€¼
   */
  private readonly headerIndices: number[] = [0, 1, 2, 3, 4, 5, 6, 7]


  /**
   * è·å–å½“å‰ä¸»é¢˜é…ç½®
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - ä»åŸºç¡€ç»„ä»¶åŠ©æ‰‹è·å–å½“å‰ä¸»é¢˜æ ·å¼
   * - ç”¨äºç»„ä»¶æ ·å¼é…ç½®
   * - æ”¯æŒä¸»é¢˜åˆ‡æ¢æ—¶çš„æ ·å¼æ›´æ–°
   * 
   * @returns å½“å‰ä¸»é¢˜çš„æ‰©å±•æ ·å¼å¯¹è±¡
   */
  getCurrentTheme(): ExtendedOmniThemeStyle {
    return this.baseComponentHelper.getCurrentTheme(this.consumedTheme)
  }

  /**
   * æ„å»ºGridè¡¨æ ¼å•å…ƒæ ¼
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ„å»ºGridè¡¨æ ¼ä¸­çš„å•ä¸ªå•å…ƒæ ¼
   * - æ ¹æ®ä½ç½®æ˜¾ç¤ºä¸åŒçš„å†…å®¹ï¼ˆè¡¨å¤´æˆ–æ•°æ®ï¼‰
   * - æ”¯æŒä¸»é¢˜é€‚é…å’Œæ ·å¼é…ç½®
   * 
   * @param item æ•°æ®é¡¹
   * @param index ç´¢å¼•ä½ç½®
   * @param isHeader æ˜¯å¦ä¸ºè¡¨å¤´
   * @returns Gridå•å…ƒæ ¼ç»„ä»¶
   */
  @Builder
  private buildGridCell(item: GridTableItem | null, index: number, isHeader: boolean = false) {
    Column() {
      if (isHeader) {
        // è¡¨å¤´å•å…ƒæ ¼
        Text(this.getHeaderText(index))
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getCurrentTheme().textColor)
          .textAlign(TextAlign.Center)
      } else if (item) {
        // æ•°æ®å•å…ƒæ ¼
        Text(this.getCellText(item, index))
          .fontSize(14)
          .fontColor(this.getCurrentTheme().textColor)
          .textAlign(TextAlign.Center)
      }
    }
    .width('100%')
    .height(40)
    .backgroundColor(isHeader ? 
      (this.getCurrentTheme().primary + '20') : 
      this.getCurrentTheme().surfaceColor)
    .border({ width: 1, color: this.getCurrentTheme().borderColor })
    .justifyContent(FlexAlign.Center)
  }

  /**
   * è·å–è¡¨å¤´æ–‡æœ¬
   * 
   * @param index åˆ—ç´¢å¼•
   * @returns è¡¨å¤´æ–‡æœ¬
   */
  private getHeaderText(index: number): string {
    const headers = ['ç­‰çº§', 'é‡é‡', 'çŠ¶æ€']
    return headers[index] || ''
  }

  /**
   * è·å–å•å…ƒæ ¼æ–‡æœ¬
   * 
   * @param item æ•°æ®é¡¹
   * @param index åˆ—ç´¢å¼•
   * @returns å•å…ƒæ ¼æ–‡æœ¬
   */
  private getCellText(item: GridTableItem, index: number): string {
    switch (index) {
      case 0: return item.level
      case 1: return item.weight
      case 2: return item.status
      default: return ''
    }
  }

  /**
   * æ„å»ºç»Ÿè®¡è¡¨æ ¼å•å…ƒæ ¼
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - åˆ›å»ºç»Ÿè®¡è¡¨æ ¼çš„å•å…ƒæ ¼å†…å®¹
   * - æ”¯æŒè¡¨å¤´å’Œæ•°æ®å•å…ƒæ ¼
   * - 9åˆ—å¸ƒå±€ï¼š1åˆ—é¡¹ç›®åç§° + 8åˆ—æ•°æ®
   * 
   * @param item ç»Ÿè®¡è¡¨æ ¼æ•°æ®é¡¹
   * @param index åˆ—ç´¢å¼•
   * @param isHeader æ˜¯å¦ä¸ºè¡¨å¤´
   */
  @Builder
  private buildStatisticsCell(item: StatisticsTableItem | null, index: number, isHeader: boolean = false) {
    Column() {
      if (isHeader) {
        // è¡¨å¤´å•å…ƒæ ¼
        Text(this.getStatisticsHeaderText(index))
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getCurrentTheme().textColor)
          .textAlign(TextAlign.Center)
      } else if (item) {
        // æ•°æ®å•å…ƒæ ¼ï¼ˆç¬¬0åˆ—ä¸ºé¡¹ç›®ååªè¯»ï¼Œå…¶ä½™åˆ—å¯ç¼–è¾‘æ•°å€¼ï¼‰
        if (index === 0) {
          Text(item.itemName)
            .fontSize(14)
            .fontColor(this.getCurrentTheme().textColor)
            .textAlign(TextAlign.Center)
        } else {
          TextInput({ text: ((index - 1) < item.values.length ? `${item.values[index - 1]}` : '') })
            .type(InputType.Number)
            .fontSize(14)
            .fontColor(this.getCurrentTheme().textColor)
            .backgroundColor(this.getCurrentTheme().surfaceColor)
            .textAlign(TextAlign.Center)
            .border({ width: 0 })
            // è¾“å…¥è¿‡ç¨‹ä¸­ä»…æ›´æ–°ç¼“å†²ï¼Œé¿å…çˆ¶ç»„ä»¶é‡å»ºå¯¼è‡´ç„¦ç‚¹è·³åŠ¨
            .onChange((raw: string) => {
              const numeric = raw.replace(/[^0-9.\-]/g, '')
              const parsed = Number(numeric)
              if (isNaN(parsed)) { return }
              const vi = index - 1
              switch (item.id) {
                case 1: this.bufB1Counts[vi] = Math.max(0, Math.floor(parsed)); break
                case 2: this.bufB1Avgs[vi] = Math.max(0, Math.round(parsed)); break
                case 3: this.bufB1Sets[vi] = Math.max(0, Math.floor(parsed)); break
                case 4: this.bufB2Counts[vi] = Math.max(0, Math.floor(parsed)); break
                case 5: this.bufB2Avgs[vi] = Math.max(0, Math.round(parsed)); break
                case 6: this.bufB2Sets[vi] = Math.max(0, Math.floor(parsed)); break
              }
            })
            // ä»…åœ¨å›è½¦æäº¤æ—¶æŠŠç¼“å†²å†™å›çˆ¶ç»„ä»¶
            .onSubmit((enterKey: EnterKeyType) => {
              const vi = index - 1
              let row: 'bottom1' | 'bottom2' = 'bottom1'
              let field: 'count' | 'avg' | 'set' = 'count'
              let value = 0
              switch (item.id) {
                case 1: row = 'bottom1'; field = 'count'; value = this.bufB1Counts[vi] || 0; break
                case 2: row = 'bottom1'; field = 'avg'; value = this.bufB1Avgs[vi] || 0; break
                case 3: row = 'bottom1'; field = 'set'; value = this.bufB1Sets[vi] || 0; break
                case 4: row = 'bottom2'; field = 'count'; value = this.bufB2Counts[vi] || 0; break
                case 5: row = 'bottom2'; field = 'avg'; value = this.bufB2Avgs[vi] || 0; break
                case 6: row = 'bottom2'; field = 'set'; value = this.bufB2Sets[vi] || 0; break
              }
              if (this.onEditStat) { this.onEditStat(row, field, vi, value) }
            })
        }
      }
    }
    .width('100%')
    .height(40)
    .backgroundColor(isHeader ?
      (this.getCurrentTheme().primary + '20') :
      (index % 2 === 0 ? this.getCurrentTheme().backgroundColor : this.getCurrentTheme().surfaceColor))
    .border({ width: 1, color: this.getCurrentTheme().borderColor })
    .justifyContent(FlexAlign.Center)
  }

  /**
   * è·å–ç»Ÿè®¡è¡¨æ ¼è¡¨å¤´æ–‡æœ¬
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - è¿”å›æŒ‡å®šåˆ—ç´¢å¼•çš„è¡¨å¤´æ–‡æœ¬
   * - ç¬¬0åˆ—æ˜¾ç¤º"é¡¹"ï¼Œç¬¬1-8åˆ—æ˜¾ç¤ºæ•°å­—ç´¢å¼•
   * 
   * @param index åˆ—ç´¢å¼•
   * @returns è¡¨å¤´æ–‡æœ¬
   */
  private getStatisticsHeaderText(index: number): string {
    if (index === 0) {
      return 'é¡¹'
    } else {
      return `${index - 1}`
    }
  }

  /**
   * è·å–ç»Ÿè®¡è¡¨æ ¼å•å…ƒæ ¼æ–‡æœ¬
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - è¿”å›æŒ‡å®šæ•°æ®é¡¹å’Œåˆ—ç´¢å¼•çš„å•å…ƒæ ¼æ–‡æœ¬
   * - ç¬¬0åˆ—æ˜¾ç¤ºé¡¹ç›®åç§°ï¼Œç¬¬1-8åˆ—æ˜¾ç¤ºå¯¹åº”çš„æ•°å€¼
   * 
   * @param item ç»Ÿè®¡è¡¨æ ¼æ•°æ®é¡¹
   * @param index åˆ—ç´¢å¼•
   * @returns å•å…ƒæ ¼æ–‡æœ¬
   */
  private getStatisticsCellText(item: StatisticsTableItem, index: number): string {
    if (index === 0) {
      return item.itemName
    } else {
      const valueIndex = index - 1
      return valueIndex < item.values.length ? `${item.values[valueIndex]}` : ''
    }
  }





  build() {
    Column() {

      // å³ä¾§ä¸Šæ–¹å¡ç‰‡ï¼šå æ¯”55%
      Column() {
        // æ§åˆ¶é¢æ¿ï¼šç­‰çº§æ•°é‡é€‰æ‹©
        Column() {
          Row() {
            // ç­‰çº§æ•°é‡æ ‡ç­¾
            Text('ç­‰çº§æ•°é‡:')
              .fontSize(24)
              .fontColor(this.getCurrentTheme().textColor)
              .margin({ right: 8 })

            // ç­‰çº§æ•°é‡é€‰æ‹©å™¨
            Select([
              { value: '0' }, { value: '1' }, { value: '2' }, { value: '3' }, { value: '4' },
              { value: '5' }, { value: '6' }, { value: '7' }, { value: '8' }, { value: '9' }, { value: '10' }
            ])
              .selected(this.levelCountIndex)
              .value(this.levelCountIndex.toString())
              .font({ size: 22 })
              .fontColor(this.getCurrentTheme().textColor)
              .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
              .border({ width: 1, color: this.getCurrentTheme().borderColor })
              .borderRadius(6)
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .width('40%')
              .onSelect((index: number) => {
                this.levelCountIndex = index
                this.initializeLevelData()
                console.log('ç­‰çº§æ•°é‡é€‰æ‹©:', index)
              })
              .onAxisEvent((event?: AxisEvent) => {
                if (event) {
                  const verticalValue = event.getVerticalAxisValue()
                  const horizontalValue = event.getHorizontalAxisValue()
                  
                  console.log('ğŸ¡ ç­‰çº§é¡µé¢æ»šè½®äº‹ä»¶è§¦å‘ - å‚ç›´å€¼:', verticalValue, 'æ°´å¹³å€¼:', horizontalValue)
                  
                  // å¤„ç†å‚ç›´æ»šè½®äº‹ä»¶
                  if (Math.abs(verticalValue) > Math.abs(horizontalValue)) {
                    console.log('âœ… è¿›å…¥ç­‰çº§é¡µé¢å‚ç›´æ»šè½®å¤„ç†é€»è¾‘')
                    
                    // åŸºäºå½“å‰ç­‰çº§æ•°é‡è¿›è¡Œå¢å‡
                    const currentCount = this.levelCountIndex
                    let newCount = currentCount
                    
                    if (verticalValue > 0) {
                      // å‘ä¸Šæ»šåŠ¨ï¼Œç­‰çº§æ•°é‡ +1ï¼ˆå¢åŠ ï¼‰
                      newCount = Math.min(currentCount + 1, 10)
                      console.log(`â¬†ï¸ ç­‰çº§é¡µé¢å‘ä¸Šæ»šåŠ¨ï¼Œä» ${currentCount} åˆ° ${newCount}`)
                    } else if (verticalValue < 0) {
                      // å‘ä¸‹æ»šåŠ¨ï¼Œç­‰çº§æ•°é‡ -1ï¼ˆå‡å°‘ï¼‰
                      newCount = Math.max(currentCount - 1, 0)
                      console.log(`â¬‡ï¸ ç­‰çº§é¡µé¢å‘ä¸‹æ»šåŠ¨ï¼Œä» ${currentCount} åˆ° ${newCount}`)
                    }
                    
                    if (newCount !== currentCount) {
                      this.levelCountIndex = newCount
                      this.initializeLevelData()
                      console.log(`âœ… ç­‰çº§é¡µé¢ç­‰çº§æ•°é‡å·²æ›´æ–°ä¸º: ${newCount}`)
                    }
                  }
                }
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.Start)
        }
        .width('100%')
        .padding(16)
        .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
        .border({ width: 1, color: this.getCurrentTheme().borderColor })
        .borderRadius(12)
        .shadow({ radius: 8, color: 'rgba(0,0,0,0.15)', offsetY: 2 })
        .margin({ bottom: 16 })
        
        // ç­‰çº§è¡¨æ ¼ï¼šä½¿ç”¨List+ListItemå®ç°
        Column() {
          // å›ºå®šè¡¨å¤´
          this.buildLevelTableHeader()

          // å¯æ»šåŠ¨æ•°æ®åŒºåŸŸ - ä½¿ç”¨Listç»„ä»¶
          List() {
            ForEach(this.levelTableData, (data: LevelTableData, index: number) => {
              ListItem() {
                this.buildLevelListItem(data, index)
              }
            }, (data: LevelTableData, index: number) => `${index}`)
          }
          .width('100%')
          .layoutWeight(1)
          .scrollBar(BarState.Auto)
          .edgeEffect(EdgeEffect.Spring)
          .friction(100)
          .divider({
            strokeWidth: 1,
            color: this.getCurrentTheme().borderColor,
            startMargin: 0,
            endMargin: 0
          })
        }
        .onClick(() => {
          // ç‚¹å‡»è¡¨æ ¼å¤–éƒ¨åŒºåŸŸæ—¶éšè—æ‰€æœ‰+/-æŒ‰é’®
          this.showAddRemoveButtons = this.showAddRemoveButtons.map(() => false)
          this.selectedRowIndex = -1
        })
        .width('100%')
        .layoutWeight(1)
        .border({ width: 1, color: this.getCurrentTheme().borderColor })
        .borderRadius(8)
        .backgroundColor(this.getCurrentTheme().surfaceColor)
      }
      .width('100%')
      .height('70%')
      .padding(16)
      .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
      .border({ width: 1, color: this.getCurrentTheme().borderColor })
      .borderRadius(10)
      .shadow({ radius: 10, color: 'rgba(0,0,0,0.08)', offsetY: 2 })
      .margin({ bottom: 16 })

      // ç»Ÿè®¡è¡¨æ ¼å¡ç‰‡ï¼šä½¿ç”¨Gridç»„ä»¶å®ç°çš„è¡¨æ ¼
      Column() {

        // è¡¨æ ¼å®¹å™¨ï¼šè¡¨å¤´å›ºå®š + æ•°æ®æ»šåŠ¨
        Column() {
          // å›ºå®šè¡¨å¤´
          Grid() {
            ForEach([0, 1, 2, 3, 4, 5, 6, 7, 8], (colIndex: number) => {
              GridItem() {
                this.buildStatisticsCell(null, colIndex, true)
              }
            })
          }
          .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr') // 9åˆ—ç­‰å®½
          .columnsGap(1)
          .rowsGap(1)
          .width('100%')
          .height(40) // è¡¨å¤´å›ºå®šé«˜åº¦
          .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })

          // å¯æ»šåŠ¨çš„æ•°æ®åŒºåŸŸ
          Scroll() {
            Grid() {
              // æ•°æ®è¡Œ
              ForEach(this.statisticsTableData, (item: StatisticsTableItem) => {
                ForEach([0, 1, 2, 3, 4, 5, 6, 7, 8], (colIndex: number) => {
                  GridItem() {
                    this.buildStatisticsCell(item, colIndex, false)
                  }
                })
              })
            }
            .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr') // 9åˆ—ç­‰å®½
            .columnsGap(1)
            .rowsGap(1)
            .width('100%')
            .height(this.statisticsTableData.length * 40) // æ•°æ®åŒºåŸŸé«˜åº¦ï¼šæ•°æ®è¡Œæ•° Ã— æ¯è¡Œé«˜åº¦
          }
          .width('100%')
          .height(240) // æ•°æ®åŒºåŸŸå›ºå®šé«˜åº¦ï¼šæ€»é«˜åº¦280 - è¡¨å¤´40 = 240
          .scrollable(ScrollDirection.Vertical)
          .scrollBar(BarState.Auto)
        }
        .width('100%')
        .height(280) // æ€»å®¹å™¨é«˜åº¦
        .border({ width: 1, color: this.getCurrentTheme().borderColor })
        .borderRadius(8)
      }
      .width('100%')
      .height('30%')
      .padding(16)
      .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
      .border({ width: 1, color: this.getCurrentTheme().borderColor })
      .borderRadius(10)
      .shadow({ radius: 10, color: 'rgba(0,0,0,0.08)', offsetY: 2 })
      .margin({ bottom: 16 })

      .padding({ top: 8 })
      .backgroundColor('rgba(0,0,0,0)')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }



}
