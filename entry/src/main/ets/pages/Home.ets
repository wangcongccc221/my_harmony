import { HomeContent } from './home/HomeContent'
import { LevelContent } from './level/LevelContent'
import { QualityContent } from './quality/QualityContent'
import { HistoryContent } from './history/HistoryContent'
import { EndProcessingContent } from './endprocessing/EndProcessingContent'
import { LiquidCardsArea } from './home/LiquidCardsArea'
// import { ThemeSelector } from '../components/ThemeSelector'
import { ArrowToggleButton } from '../components/ui/buttons/ArrowToggleButton'
import { NavButton } from '../components/ui/buttons/NavButton'
import { LeftNavigationTabBar } from '../components/layout/LeftNavigationTabBar'
import { FruitInfoDialog } from '../components/feedback/FruitInfoDialog'
import { RealtimeStatsDialog } from '../components/feedback/RealtimeStatsDialog'
import { LoadProgramDialog } from '../components/dialogs/LoadProgramDialog'
import { SaveProgramDialog } from '../components/dialogs/SaveProgramDialog'
import { SortingStatusDialog } from '../components/dialogs/SortingStatusDialog'
import { FloatingWindow } from '../components/ui/layout/FloatingWindow'
import { EngineeringSettingsDialog } from '../components/dialogs/EngineeringSettingsDialog'
import { getCurrentTheme as resolveTheme } from '../utils/theme/ThemeUtils'
import { NavigationUtils } from '../utils/helpers/NavigationUtils'
import { OmniThemeManager, OmniThemeType, ExtendedOmniThemeStyle } from '../utils/theme/OmniThemeManager'
import { useOmniTheme, OMNI_THEME_KEY, OMNI_THEME_TYPE_KEY, OMNI_THEME_VERSION_KEY } from '../utils/theme/useOmniTheme'
import { OmniUIInit } from '../utils/helpers/OmniUIInit'
import { OmniUIUtils } from '../utils/helpers/OmniUIUtils'
// å¯¼å…¥ IBest-UI ç»„ä»¶
import { IBestButton, IBestIcon, IBestTag, IBestInit, IBestAvatar, IBestAvatarGroup } from '@ibestservices/ibest-ui'
import { I18nManager, t, I18N_LANGUAGE_KEY, I18N_VERSION_KEY } from '../utils/i18n/I18nManager'
import GlobalStore from '../database/orm/model/GlobalStore'
import { window } from '@kit.ArkUI'
import { fileIo as fs } from '@kit.CoreFileKit'
import { buffer } from '@kit.ArkTS'
import { RectButton } from '../components/ui/buttons/RectButton'
import { TopStatusBar } from '../components/layout/TopStatusBar'
import { BottomControlBar } from '../components/layout/BottomControlBar'
import { KeyCode } from '@kit.InputKit';
// ç§»é™¤ BottomBar é›†æˆ


// å¯¼èˆªæŒ‰é’®é…ç½®æ¥å£
interface NavigationButton {
  text: string // å±•ç¤ºæ–‡å­—ï¼ˆä¸­æ–‡ï¼‰
  pageName: string // è‹±æ–‡é¡µé¢é”®ï¼ˆç”¨äºè·¯ç”±/æ¯”è¾ƒï¼‰
}

// é¡µé¢å¤„ç†ç­–ç•¥ç±»å‹
type PageHandler = () => void

// é¡µé¢å†…å®¹æ¸²æŸ“å™¨ç±»å‹
type PageRenderer = () => void

interface FruitInfo {
  name: string
  type: string
  weight: number
  color: string
  ripeness: string
  origin: string
  harvestDate: string
  quality: string
}

interface ProgramInfo {
  id: string
  name: string
  description: string
  version: string
  createDate: string
  lastModified: string
}

// ä¿å­˜ç”¨æˆ·é…ç½®ä¿¡æ¯æ¥å£ï¼ˆä»…ä¿ç•™åç§°ã€æè¿°ã€æ ‡ç­¾ï¼‰
interface SaveProgramInfo {
  name: string
  description: string
  tags: string
}

// ç¿»è¯‘é¡¹æ¥å£
interface TranslationItem {
  key: string  // æ˜¾ç¤ºæ–‡æœ¬ï¼ˆå½“å‰è¯­è¨€çš„ç¿»è¯‘æˆ–ä¸­æ–‡é”®ï¼‰
  originalKey: string  // åŸå§‹ä¸­æ–‡é”®ï¼ˆç”¨äºä¿å­˜ï¼‰
  value: string  // ç”¨æˆ·ç¼–è¾‘çš„ç¿»è¯‘æ–‡æœ¬
}

// ç¿»è¯‘è®°å½•ç±»å‹
type TranslationRecord = Record<string, string>

@Entry
@Component
struct Page {
  @State currentPage: string = 'home'
  @StorageLink('HOME_SELECTED_FSM') selectedFSM: 'FSM1' | 'FSM2' = 'FSM1'
  @State showThemeSelector: boolean = false  // æ§åˆ¶ä¸»é¢˜é€‰æ‹©å™¨æ˜¾ç¤º
  @State sideBarStatus: boolean = true  // æ§åˆ¶ä¾§è¾¹æ å±•å¼€/æ”¶ç¼©çŠ¶æ€
  @State showFruitInfoDialog: boolean = false  // æ§åˆ¶æ°´æœä¿¡æ¯å¯¹è¯æ¡†æ˜¾ç¤º
  @State showRealtimeDialog: boolean = false   // æ§åˆ¶å®æ—¶ç»Ÿè®¡å¯¹è¯æ¡†æ˜¾ç¤º
  @State showLoadProgramDialog: boolean = false  // æ§åˆ¶è½½å…¥ç¨‹åºå¯¹è¯æ¡†æ˜¾ç¤º
  @State showSaveProgramDialog: boolean = false  // æ§åˆ¶ä¿å­˜ç¨‹åºå¯¹è¯æ¡†æ˜¾ç¤º
  @State showSortingStatusDialog: boolean = false  // æ§åˆ¶åˆ†é€‰çŠ¶æ€å¯¹è¯æ¡†æ˜¾ç¤º
  @StorageLink(OMNI_THEME_KEY) @Watch('onThemeChange') consumedTheme: ExtendedOmniThemeStyle = OmniThemeManager.getInstance().getCurrentTheme()
  @StorageLink(OMNI_THEME_TYPE_KEY) @Watch('onThemeChange') consumedThemeType: OmniThemeType = OmniThemeManager.getInstance().getCurrentThemeType()
  @StorageLink(OMNI_THEME_VERSION_KEY) @Watch('onThemeChange') themeVersion: number = 0
  @StorageLink(I18N_VERSION_KEY) i18nVersion: number = 0  // ç›‘å¬è¯­è¨€å˜åŒ–ï¼Œè§¦å‘ UI æ›´æ–°
  
  // FSMä¸»é¢˜ä¿å­˜çŠ¶æ€
  @State fsm1Theme: OmniThemeType = OmniThemeType.PROFESSIONAL_BLUE
  @State fsm2Theme: OmniThemeType = OmniThemeType.WARM_AMBER
  private omniThemeManager = OmniThemeManager.getInstance()  // Omni-UI ä¸»é¢˜ç®¡ç†å™¨å®ä¾‹
  private omniUIInit = OmniUIInit.getInstance()  // Omni-UI åˆå§‹åŒ–å®ä¾‹
  private omniUIUtils = OmniUIUtils.getInstance()  // Omni-UI å·¥å…·å®ä¾‹
  // é€šç”¨å¿«æ·å¯¹è¯æ¡†çŠ¶æ€
  @State quickDialogVisible: boolean = false
  @State quickDialogTitle: string = ''
  @State quickDialogContent: string = ''
  private quickDialogConfirm?: () => void
  @State private quickDialogIndex: number = -1
  private bottomButtonsCount: number = 10
  // æ‰“å°æŒ‰é’®æ‚¬åœçŠ¶æ€
  @State showPrintSubButtons: boolean = false
  // é¡¶éƒ¨ä¸ªäººä¿¡æ¯ - å…¨å±å±…ä¸­ç¼–è¾‘å¼¹çª—å…¨å±€çŠ¶æ€
  @StorageLink('EDIT_USER_LABEL_VISIBLE') private editUserLabelVisible: boolean = false
  @State private tempUserLabel: string = 'å§“å'
  @State private selectedAvatarUrl: string = ''
  
  // å¯é€‰å¤´åƒåˆ—è¡¨
  private avatarOptions: string[] = [
    'https://img1.baidu.com/it/u=700838104,4078529388&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500',
    'https://img0.baidu.com/it/u=447148445,3812237851&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500',
    'https://img0.baidu.com/it/u=1596600438,2136408442&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500',
    'https://img0.baidu.com/it/u=2816983398,655618517&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500',
    'https://pics4.baidu.com/feed/1ad5ad6eddc451da34d4638413f67668d016325c.jpeg',
    'https://img0.baidu.com/it/u=2397297586,1192210697&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500',
    'https://img0.baidu.com/it/u=781626259,587761743&fm=253&fmt=auto&app=138&f=JPEG?w=300&h=300',
    'https://img0.baidu.com/it/u=3731477373,291511913&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500'
  ]
  
  // æ‚¬æµ®çª—ç›¸å…³çŠ¶æ€
  @State showFloatingWindow: boolean = false
  @State floatingWindowTitle: string = ''
  @State floatingWindowContent: string = ''
  @State selectedFloatingTab: string = 'export'
  
  // ä¸»é¢˜é€‰æ‹©å™¨çŠ¶æ€
  @State selectedTheme: OmniThemeType = OmniThemeType.BLUE
  
  // å·¥ç¨‹è®¾ç½®å¯¹è¯æ¡†çŠ¶æ€
  @State showEngineeringSettingsDialog: boolean = false
  
  // è¯­è¨€é€‰æ‹©å™¨çŠ¶æ€
  @State showLanguageSelector: boolean = false
  @State currentLanguage: string = 'ä¸­æ–‡'
  @State availableLanguages: string[] = []
  @State selectedLanguageTemp: string = 'ä¸­æ–‡'  // ä¸´æ—¶é€‰ä¸­çš„è¯­è¨€ï¼ˆç”¨äºç¡®è®¤ï¼‰
  
  // ç¿»è¯‘ç¼–è¾‘å™¨çŠ¶æ€
  @State showTranslationEditor: boolean = false
  @State translationFilter: string = ''
  @State newTranslationKey: string = ''
  @State newTranslationValue: string = ''
  @State translations: TranslationItem[] = []
  @State showLanguageNameDialog: boolean = false
  @State languageNameInput: string = ''
  
  
  
  // é¡µé¢åˆå§‹åŒ–æ—¶åˆå§‹åŒ– Omni-UI å’Œ IBest-UI
  aboutToAppear() {
    this.omniUIInit.init()
    this.omniThemeManager.init()
    // åˆå§‹åŒ– Ctrl å¤šé€‰çŠ¶æ€
    AppStorage.setOrCreate('HOME_CTRL_PRESSED', false)
  }
  
  
  
  // è·å–å½“å‰ä¸»é¢˜é…ç½®çš„æ–¹æ³•
  getCurrentTheme(): ExtendedOmniThemeStyle {
    // å¼•ç”¨ themeVersionï¼Œç¡®ä¿ä¸»é¢˜ç‰ˆæœ¬å˜åŒ–è§¦å‘æœ¬ç»„ä»¶é‡å»º
    const __version: number = this.themeVersion
    return resolveTheme(this.consumedTheme)
  }

  // ç›‘å¬ä¸»é¢˜å˜åŒ–
  onThemeChange(): void {
    console.log('Home: ä¸»é¢˜å·²å˜åŒ–ï¼Œé‡æ–°æ¸²æŸ“')
  }

  // å°†é¡µé¢é”®æ˜ å°„ä¸ºå±•ç¤ºæ ‡é¢˜ï¼ˆä¾èµ– i18nVersion ç¡®ä¿è¯­è¨€å˜åŒ–æ—¶é‡æ–°è®¡ç®—ï¼‰
  private getPageTitle(pageKey: string): string {
    // å¼•ç”¨ i18nVersion ç¡®ä¿è¯­è¨€å˜åŒ–æ—¶é‡æ–°è®¡ç®—
    const _version = this.i18nVersion
    const map: Record<string, string> = {
      'home': t('ä¸»é¡µ', 'ä¸»é¡µ'),
      'quality': t('å“è´¨', 'å“è´¨'),
      'level': t('ç­‰çº§', 'ç­‰çº§'),
      'fruit': t('æ°´æœä¿¡æ¯', 'æ°´æœä¿¡æ¯'),
      'load': t('è½½å…¥ç¨‹åº', 'è½½å…¥ç¨‹åº'),
      'save': t('ä¿å­˜ç¨‹åº', 'ä¿å­˜ç¨‹åº'),
      'history': t('å†å²åŠ å·¥', 'å†å²åŠ å·¥'),
      'realtime': t('å®æ—¶ç»Ÿè®¡', 'å®æ—¶ç»Ÿè®¡'),
      'end': t('ç»“æŸåŠ å·¥', 'ç»“æŸåŠ å·¥'),
      'print': t('æ‰“å°', 'æ‰“å°'),
      'more': t('æ›´å¤š', 'æ›´å¤š')
    }
    return map[pageKey] || pageKey
  }

  // é¡µé¢å¤„ç†ç­–ç•¥æ˜ å°„ï¼ˆæŒ‰è‹±æ–‡ pageKeyï¼‰
  private getPageHandlers(): Record<string, PageHandler> {
    return {
      'fruit': (): void => this.showFruitInfo(),
      'realtime': (): void => this.showRealtimeStats(),
      'load': (): void => this.showLoadProgram(),
      'save': (): void => this.showSaveProgram(),
      'print': (): void => this.handlePrintClick(),
      'quality': (): void => { this.currentPage = 'quality' },
      'level': (): void => { this.currentPage = 'level' },
      'history': (): void => { this.currentPage = 'history' },
      'end': (): void => { this.currentPage = 'end' },
      'more': (): void => this.displayFloatingWindow('æ›´å¤šè®¾ç½®', 'è¿™é‡Œæ˜¯æ›´å¤šè®¾ç½®å’Œç³»ç»Ÿé…ç½®ã€‚\n\nâ€¢ ç³»ç»Ÿè®¾ç½®\nâ€¢ ç”¨æˆ·ç®¡ç†\nâ€¢ æ•°æ®å¤‡ä»½\nâ€¢ ç³»ç»Ÿç»´æŠ¤'),
      // é»˜è®¤å¤„ç†ï¼šæ­£å¸¸é¡µé¢åˆ‡æ¢
      'default': (): void => { this.currentPage = this.currentPage }
    }
  }

  // é¡µé¢åˆ‡æ¢å¤„ç†æ–¹æ³•
  private handlePageChange(pageName: string): void {
    const handlers = this.getPageHandlers()
    const handler = handlers[pageName] || handlers['default']
    
    if (handler === handlers['default']) {
      // å¯¹äºé»˜è®¤å¤„ç†ï¼Œéœ€è¦è®¾ç½®æ­£ç¡®çš„é¡µé¢åç§°
      this.currentPage = pageName
    } else {
      handler()
    }
  }

  // æ°´æœä¿¡æ¯åŠŸèƒ½å°è£…
  private showFruitInfo(): void {
    this.showFruitInfoDialog = true
  }

  // å®æ—¶ç»Ÿè®¡å¼¹çª—åŠŸèƒ½å°è£…ï¼ˆä¸æ°´æœä¿¡æ¯åŒé£æ ¼ï¼‰
  private showRealtimeStats(): void {
    this.showRealtimeDialog = true
  }

  // å¤„ç†æ°´æœä¿¡æ¯å¯¹è¯æ¡†ç¡®è®¤
  private handleFruitInfoConfirm(fruitInfo: FruitInfo): void {
    this.omniUIUtils.showInfo(`å·²ç¡®è®¤æ°´æœä¿¡æ¯ï¼š${fruitInfo.name}`)
    this.showFruitInfoDialog = false
  }

  // å¤„ç†æ°´æœä¿¡æ¯å¯¹è¯æ¡†å–æ¶ˆ
  private handleFruitInfoCancel(): void {
    this.omniUIUtils.showInfo('å·²å–æ¶ˆæŸ¥çœ‹æ°´æœä¿¡æ¯')
    this.showFruitInfoDialog = false
  }

  // è½½å…¥ç¨‹åºåŠŸèƒ½å°è£…
  private showLoadProgram(): void {
    this.showLoadProgramDialog = true
  }

  // å¤„ç†è½½å…¥ç¨‹åºå¯¹è¯æ¡†ç¡®è®¤
  private handleLoadProgramConfirm(programInfo: ProgramInfo): void {
    this.omniUIUtils.showInfo(`å·²è½½å…¥ç¨‹åºï¼š${programInfo.name} (${programInfo.version})`)
    this.showLoadProgramDialog = false
  }

  // å¤„ç†è½½å…¥ç¨‹åºå¯¹è¯æ¡†å–æ¶ˆ
  private handleLoadProgramCancel(): void {
    this.omniUIUtils.showInfo('å·²å–æ¶ˆè½½å…¥ç¨‹åº')
    this.showLoadProgramDialog = false
  }

  // ä¿å­˜ç¨‹åºåŠŸèƒ½å°è£…
  private showSaveProgram(): void {
    this.showSaveProgramDialog = true
  }

  // å¤„ç†ä¿å­˜ç¨‹åºå¯¹è¯æ¡†ç¡®è®¤
  private handleSaveProgramConfirm(saveProgramInfo: SaveProgramInfo): void {
    // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„ä¿å­˜é€»è¾‘ï¼Œæ¯”å¦‚ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    console.log('ä¿å­˜ç¨‹åºä¿¡æ¯:', saveProgramInfo)
    this.omniUIUtils.showSuccess(`ç¨‹åº "${saveProgramInfo.name}" å·²ä¿å­˜åˆ°æœ¬åœ°`)
    this.showSaveProgramDialog = false
  }

  // å¤„ç†ä¿å­˜ç¨‹åºå¯¹è¯æ¡†å–æ¶ˆ
  private handleSaveProgramCancel(): void {
    this.omniUIUtils.showInfo('å·²å–æ¶ˆä¿å­˜ç¨‹åº')
    this.showSaveProgramDialog = false
  }

  // åˆ†é€‰çŠ¶æ€åŠŸèƒ½å°è£…
  private showSortingStatus(): void {
    this.showSortingStatusDialog = true
  }

  // å¤„ç†åˆ†é€‰çŠ¶æ€å¯¹è¯æ¡†ç¡®è®¤
  private handleSortingStatusConfirm(isNormal: boolean): void {
    const statusText = isNormal ? 'æ­£å¸¸åˆ†é€‰' : 'å¼‚å¸¸åˆ†é€‰'
    this.omniUIUtils.showInfo(`åˆ†é€‰çŠ¶æ€å·²è®¾ç½®ä¸ºï¼š${statusText}`)
    this.showSortingStatusDialog = false
  }

  // å¤„ç†åˆ†é€‰çŠ¶æ€å¯¹è¯æ¡†å–æ¶ˆ
  private handleSortingStatusCancel(): void {
    this.omniUIUtils.showInfo('å·²å–æ¶ˆåˆ†é€‰çŠ¶æ€è®¾ç½®')
    this.showSortingStatusDialog = false
  }

  // å¤„ç†æ‰“å°æŒ‰é’®ç‚¹å‡»æ˜¾ç¤ºå­æŒ‰é’®
  private handlePrintClick(): void {
    this.showPrintSubButtons = !this.showPrintSubButtons
  }

  // å¤„ç†æ‰“å°å­æŒ‰é’®ç‚¹å‡»
  private handlePrintSubButtonClick(subButtonName: string): void {
    this.omniUIUtils.showInfo(`å·²ç‚¹å‡»${subButtonName}`)
    // ç‚¹å‡»å­æŒ‰é’®åä¸è‡ªåŠ¨éšè—ï¼Œä¿æŒå­æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
  }

  // å¤„ç†æ‚¬æµ®çª—æ˜¾ç¤º
  private displayFloatingWindow(title: string, content: string): void {
    this.floatingWindowTitle = title
    this.floatingWindowContent = content
    this.showFloatingWindow = true
  }

  // å¤„ç†æ‚¬æµ®çª—å…³é—­
  private handleFloatingWindowClose(): void {
    this.showFloatingWindow = false
    this.floatingWindowTitle = ''
    this.floatingWindowContent = ''
  }

  // å¤„ç†ä¸»é¢˜åˆ‡æ¢
  private handleThemeChange(theme: OmniThemeType): void {
    const hook = useOmniTheme()
    hook.setTheme(theme)
    const themeName = this.omniThemeManager.getThemeName(theme)
    this.omniUIUtils.showSuccess(`å·²åˆ‡æ¢åˆ°${themeName}`)
    this.showThemeSelector = false
  }

  // å¤„ç†å·¥ç¨‹è®¾ç½®
  private showEngineeringSettings(): void {
    this.showEngineeringSettingsDialog = true
  }

  private handleEngineeringSettingsConfirm(): void {
    this.omniUIUtils.showSuccess('å·¥ç¨‹è®¾ç½®å·²ä¿å­˜')
    this.showEngineeringSettingsDialog = false
  }

  private handleEngineeringSettingsCancel(): void {
    this.omniUIUtils.showInfo('å·²å–æ¶ˆå·¥ç¨‹è®¾ç½®')
    this.showEngineeringSettingsDialog = false
  }

  // è¯­è¨€é€‰æ‹©ç›¸å…³æ–¹æ³•
  private async openLanguageSelector(): Promise<void> {
    console.log('[Home] Opening language selector')
    await this.refreshAvailableLanguages()
    this.selectedLanguageTemp = this.currentLanguage  // åˆå§‹åŒ–ä¸´æ—¶é€‰ä¸­ä¸ºå½“å‰è¯­è¨€
    this.showLanguageSelector = true
  }

  private async refreshAvailableLanguages(): Promise<void> {
    console.log('[Home] Refreshing available languages')
    try {
      const mgr = I18nManager.getInstance()
      if (!mgr.isInitialized() && GlobalStore.context) {
        await mgr.init(GlobalStore.context)
      }
      const languages = mgr.listLanguageFiles()
      this.availableLanguages = languages
      console.log(`[Home] Available languages: ${JSON.stringify(languages)}`)
    } catch (e) {
      console.error('[Home] Failed to refresh languages:', e)
      this.availableLanguages = []
    }
  }

  private selectLanguageTemp(lang: string): void {
    // ä¸´æ—¶é€‰ä¸­è¯­è¨€ï¼ˆä¸ç«‹å³åˆ‡æ¢ï¼‰
    this.selectedLanguageTemp = lang
    console.log(`[Home] Temporarily selected language: ${lang}`)
  }

  private async confirmLanguageSelection(): Promise<void> {
    // ç¡®è®¤é€‰æ‹©è¯­è¨€
    const lang = this.selectedLanguageTemp
    console.log(`[Home] Confirming language selection: ${lang}`)
    this.currentLanguage = lang
    
    try {
      const mgr = I18nManager.getInstance()
      await mgr.setLanguage(lang)
      this.omniUIUtils.showSuccess(`å·²åˆ‡æ¢åˆ°ï¼š${lang}`)
    } catch (e) {
      console.error(`[Home] Failed to set language ${lang}:`, e)
      this.omniUIUtils.showError(`åˆ‡æ¢è¯­è¨€å¤±è´¥: ${JSON.stringify(e)}`)
    }
    
    this.showLanguageSelector = false
  }

  private cancelLanguageSelection(): void {
    // å–æ¶ˆé€‰æ‹©ï¼Œæ¢å¤åŸçŠ¶æ€
    this.selectedLanguageTemp = this.currentLanguage
    this.showLanguageSelector = false
    console.log('[Home] Language selection cancelled')
  }

  // ç¿»è¯‘ç¼–è¾‘ç›¸å…³æ–¹æ³•
  private async openTranslationEditor(): Promise<void> {
    console.log('[Home] openTranslationEditor: start')
    try {
      if (!GlobalStore.context) {
        console.error('[Home] GlobalStore.context is not available')
        this.omniUIUtils.showError('ç¿»è¯‘åˆå§‹åŒ–å¤±è´¥ï¼šä¸Šä¸‹æ–‡æœªå°±ç»ª')
        return
      }
      const mgr = I18nManager.getInstance()
      if (!mgr.isInitialized()) {
        console.log('[Home] I18nManager not initialized, initializing...')
        await mgr.init(GlobalStore.context)
      }

      // è·å–å½“å‰è¯­è¨€
      const currentLang = mgr.getCurrentLanguage()
      console.log(`[Home] Current language: ${currentLang}`)

      // ä»é»˜è®¤æ¨¡æ¿æ–‡ä»¶åŠ è½½æ‰€æœ‰å­—æ®µï¼ˆä¸­æ–‡é”®ï¼‰
      const appCtx = GlobalStore.context.getApplicationContext?.() ?? GlobalStore.context
      const filesDir = appCtx.filesDir
      const defaultTemplatePath = `${filesDir}/i18n/translations.default.json`
      console.log(`[Home] Loading default template from: ${defaultTemplatePath}`)

      let content: string | undefined = undefined

      // ä¼˜å…ˆè¯»å–æ²™ç®±æ–‡ä»¶
      try {
        const stat = fs.statSync(defaultTemplatePath)
        if (stat.size > 0) {
          const file = fs.openSync(defaultTemplatePath, fs.OpenMode.READ_ONLY)
          const dataBuffer = new ArrayBuffer(stat.size)
          fs.readSync(file.fd, dataBuffer)
          fs.closeSync(file.fd)
          const u8 = new Uint8Array(dataBuffer)
          const buf = buffer.from(u8.buffer)
          content = buf.toString('utf-8')
          console.log(`[Home] Sandbox template size: ${stat.size} bytes`)
        } else {
          console.warn('[Home] Sandbox template empty, fallback to rawfile')
        }
      } catch (e) {
        console.warn(`[Home] Sandbox template missing, fallback to rawfile: ${JSON.stringify(e)}`)
      }

      // å¦‚æœæ²™ç®±ä¸å­˜åœ¨/ä¸ºç©ºï¼Œè¯»å– rawfile å¹¶å†™å›æ²™ç®±
      if (!content) {
        try {
          const rawBytes: Uint8Array = appCtx.resourceManager.getRawFileContentSync('file/translations.default.json')
          const rawBuf = buffer.from(rawBytes.buffer)
          content = rawBuf.toString('utf-8')
          console.log('[Home] Loaded template from rawfile')
          // åŒæ­¥åˆ°æ²™ç®±ï¼Œä¾¿äºåç»­ç¼–è¾‘
          const bufToSave = buffer.from(content, 'utf-8')
          const f = fs.openSync(defaultTemplatePath, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE | fs.OpenMode.TRUNC)
          fs.writeSync(f.fd, bufToSave.buffer)
          fs.closeSync(f.fd)
          console.log('[Home] Synced rawfile template to sandbox')
        } catch (e) {
          console.error(`[Home] Failed to load template from rawfile: ${JSON.stringify(e)}`)
        }
      }

      // åŠ è½½å½“å‰è¯­è¨€çš„ç¿»è¯‘ï¼ˆä½œä¸ºåŸå§‹æ–‡æœ¬ï¼‰
      let currentLangTranslations = new Map<string, string>()
      if (currentLang !== 'ä¸­æ–‡') {
        const currentLangPath = `${filesDir}/i18n/${currentLang}.json`
        console.log(`[Home] Loading current language translations from: ${currentLangPath}`)
        try {
          if (fs.statSync(currentLangPath).size > 0) {
            const file = fs.openSync(currentLangPath, fs.OpenMode.READ_ONLY)
            const stat = fs.statSync(currentLangPath)
            const dataBuffer = new ArrayBuffer(stat.size)
            fs.readSync(file.fd, dataBuffer)
            fs.closeSync(file.fd)
            const u8 = new Uint8Array(dataBuffer)
            const buf = buffer.from(u8.buffer)
            const langContent = buf.toString('utf-8')
            // ä½¿ç”¨ JSON.parse çš„ reviver å‡½æ•°è§£æ JSON åˆ° Map
            JSON.parse(langContent, (key: string, value: string | number | boolean | null): string | number | boolean | null => {
              if (key !== '' && value !== undefined && value !== null) {
                currentLangTranslations.set(key, String(value))
              }
              return value
            })
            console.log(`[Home] Loaded ${currentLangTranslations.size} translations from current language`)
          }
        } catch (e) {
          console.warn(`[Home] Failed to load current language translations: ${JSON.stringify(e)}`)
        }
      }

      let arr: TranslationItem[] = []
      if (content) {
        try {
          // å…ˆè§£æä¸º Map ä»¥ä¾¿è®¿é—®å€¼
          const templateMap = new Map<string, string>()
          JSON.parse(content, (key: string, value: string | number | boolean | null): string | number | boolean | null => {
            if (key !== '' && value !== undefined && value !== null) {
              templateMap.set(key, String(value))
            }
            return value
          })
          
          // éå† Map æ„å»º TranslationItem æ•°ç»„
          templateMap.forEach((val: string, k: string) => {
            // å¦‚æœå½“å‰è¯­è¨€ä¸æ˜¯ä¸­æ–‡ï¼Œä½¿ç”¨å½“å‰è¯­è¨€çš„ç¿»è¯‘ä½œä¸ºæ˜¾ç¤ºæ–‡æœ¬ï¼›å¦åˆ™ä½¿ç”¨ä¸­æ–‡é”®
            const displayText = currentLang !== 'ä¸­æ–‡' && currentLangTranslations.has(k) 
              ? currentLangTranslations.get(k) ?? k 
              : k
            const item: TranslationItem = { key: displayText, originalKey: k, value: val }
            arr.push(item)
          })
          console.log(`[Home] Loaded ${arr.length} template entries`)
        } catch (e) {
          console.error(`[Home] Failed to parse template content: ${JSON.stringify(e)}`)
        }
      } else {
        console.warn('[Home] No template content available, using empty list')
      }

      this.translations = arr
      console.log(`[Home] openTranslationEditor: loaded ${this.translations.length} items`)
      this.showTranslationEditor = true
    } catch (e) {
      console.error('[Home] openTranslationEditor failed', e)
      this.omniUIUtils.showError(`ç¿»è¯‘åŠ è½½å¤±è´¥: ${JSON.stringify(e)}`)
    }
  }

  private updateTranslationKey(index: number, value: string): void {
    if (index < 0 || index >= this.translations.length) return
    const next: TranslationItem[] = [...this.translations]
    const updated: TranslationItem = { key: value, originalKey: next[index].originalKey, value: next[index].value }
    next[index] = updated
    this.translations = next
  }

  private updateTranslationValue(index: number, value: string): void {
    if (index < 0 || index >= this.translations.length) return
    const next: TranslationItem[] = [...this.translations]
    const updated: TranslationItem = { key: next[index].key, originalKey: next[index].originalKey, value }
    next[index] = updated
    this.translations = next
  }

  private removeTranslation(index: number): void {
    if (index < 0 || index >= this.translations.length) return
    const next: TranslationItem[] = [...this.translations]
    next.splice(index, 1)
    this.translations = next
  }

  private addTranslation(): void {
    if (!this.newTranslationKey || this.newTranslationKey.trim().length === 0) {
      this.omniUIUtils.showInfo('è¯·è¾“å…¥ç¿»è¯‘é”®')
      return
    }
    const next: TranslationItem[] = [...this.translations]
    const item: TranslationItem = { 
      key: this.newTranslationKey.trim(), 
      originalKey: this.newTranslationKey.trim(),  // æ–°æ·»åŠ çš„é¡¹ï¼ŒoriginalKey å’Œ key ç›¸åŒ
      value: this.newTranslationValue ?? '' 
    }
    next.push(item)
    this.translations = next
    this.newTranslationKey = ''
    this.newTranslationValue = ''
  }

  private filteredTranslations(): TranslationItem[] {
    if (!this.translationFilter || this.translationFilter.trim().length === 0) {
      return this.translations
    }
    const keyword = this.translationFilter.trim().toLowerCase()
    return this.translations.filter((item) => {
      return item.key.toLowerCase().includes(keyword) || 
             item.originalKey.toLowerCase().includes(keyword) || 
             (item.value ?? '').toLowerCase().includes(keyword)
    })
  }

  private async saveTranslations(): Promise<void> {
    console.log('[Home] saveTranslations: opening language name dialog')
    this.languageNameInput = ''
    this.showLanguageNameDialog = true
  }

  private async confirmSaveLanguage(): Promise<void> {
    const langName = this.languageNameInput.trim()
    if (!langName || langName.length === 0) {
      this.omniUIUtils.showInfo('è¯·è¾“å…¥è¯­è¨€åç§°')
      return
    }

    // æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åˆæ³•
    if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(langName)) {
      this.omniUIUtils.showError('è¯­è¨€åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­æ–‡')
      return
    }

    console.log(`[Home] Saving translations as language: ${langName}`)
    this.showLanguageNameDialog = false

    try {
      const mgr = I18nManager.getInstance()
      const map = new Map<string, string>()
      this.translations.forEach((item) => {
        // ä½¿ç”¨ originalKey ä½œä¸ºä¿å­˜çš„é”®ï¼ˆåŸå§‹ä¸­æ–‡é”®ï¼‰
        if (item.originalKey && item.originalKey.trim().length > 0) {
          map.set(item.originalKey.trim(), item.value ?? '')
        }
      })
      console.log(`[Home] Prepared ${map.size} translations to save`)
      
      await mgr.saveLanguage(langName, map)
      this.omniUIUtils.showSuccess(`ç¿»è¯‘å·²ä¿å­˜ä¸ºï¼š${langName}`)
      this.showTranslationEditor = false
      
      // åˆ·æ–°å¯ç”¨è¯­è¨€åˆ—è¡¨
      await this.refreshAvailableLanguages()
    } catch (e) {
      console.error('[Home] saveTranslations failed', e)
      this.omniUIUtils.showError(`ä¿å­˜å¤±è´¥: ${JSON.stringify(e)}`)
    }
  }

  // å¤„ç†å‡ºå£æ¸…ç©ºåŠŸèƒ½
  private handleExportClear(): void {
    console.log('å¼€å§‹æ¸…ç©ºæ¶²ä½“å¡ç‰‡æ•°æ®...')
    
    // ä»AppStorageè·å–LiquidCardsAreaå¼•ç”¨
    const liquidCardsAreaRef: LiquidCardsArea | null = AppStorage.get('LIQUID_CARDS_AREA_REF') as LiquidCardsArea | null
    if (liquidCardsAreaRef) {
      liquidCardsAreaRef.clearAllCardData()
      this.omniUIUtils.showSuccess('æ¸…ç©ºæˆåŠŸï¼')//æç¤ºå¼¹çª—
      // æ˜¾ç¤ºç³»ç»Ÿå¯¹è¯æ¡†ï¼Œç¡®ä¿ç”¨æˆ·å¯è§
      AlertDialog.show({
        title: 'æç¤º',
        message: 'æ¸…ç©ºæˆåŠŸï¼',
        confirm: { value: 'ç¡®å®š', action: () => {} }
      })
    } else {
      console.error('æ¶²ä½“å¡ç‰‡åŒºåŸŸå¼•ç”¨ä¸ºç©ºï¼Œæ— æ³•æ¸…ç©ºæ•°æ®')
      this.omniUIUtils.showError('æ¸…ç©ºå¤±è´¥ï¼šæ¶²ä½“å¡ç‰‡åŒºåŸŸæœªåˆå§‹åŒ–')
    }
  }

  // æ„å»ºæ‚¬æµ®çª—TabæŒ‰é’®
  @Builder
  private buildFloatingTabButton(title: string, tabKey: string): void {
    Button(title)
      .fontSize(14)
      .fontWeight(this.selectedFloatingTab === tabKey ? FontWeight.Bold : FontWeight.Normal)
      .fontColor(this.selectedFloatingTab === tabKey ? this.getCurrentTheme().primary : this.getCurrentTheme().textColor)
      .backgroundColor(this.selectedFloatingTab === tabKey ? this.getCurrentTheme().primary + '20' : Color.Transparent)
      .borderRadius(6)
      .padding({ left: 12, right: 12, top: 8, bottom: 8 })
      .layoutWeight(1)
      .margin({ left: 4, right: 4 })
      .onClick(() => {
        this.selectedFloatingTab = tabKey
      })
  }

  // æ„å»ºå‡ºå£Tabå†…å®¹
  @Builder
  private buildExportTabContent(): void {
    Text('å‡ºå£ç®¡ç†')
      .fontSize(18)
      .fontWeight(FontWeight.Bold)
      .fontColor(this.getCurrentTheme().textColor)
      .margin({ bottom: 16 })
      .alignSelf(ItemAlign.Start)

    // æŒ‰é’®ç½‘æ ¼ - 4åˆ—å¸ƒå±€
    Grid() {
      GridItem() { this.buildFloatingButton('ğŸ—‘ï¸', 'å‡ºå£æ¸…ç©º') }
      GridItem() { this.buildFloatingButton('âš¡', 'ç”µç£é˜€æµ‹è¯•') }
      GridItem() { this.buildFloatingButton('ğŸ”§', 'ç”µæœºä½¿èƒ½') }
      GridItem() { this.buildFloatingButton('ğŸ”„', 'å¤ä½æœæ¯') }
      GridItem() { this.buildFloatingButton('ğŸ§ª', 'æµ‹è¯•æœæ¯') }
      GridItem() { this.buildFloatingButton('ğŸ“¦', 'çº¸ç®±è§„æ ¼') }
      GridItem() { this.buildFloatingButton('ğŸ“º', 'å‡ºå£å±æ˜¾ç¤º') }
      GridItem() { this.buildFloatingButton('âš™ï¸', 'å‡ºå£å±è®¾ç½®') }
    }
    .columnsTemplate('1fr 1fr 1fr 1fr')
    .rowsGap(16)
    .columnsGap(16)
    .width('100%')
  }

  // æ„å»ºè®¾ç½®Tabå†…å®¹
  @Builder
  private buildSettingsTabContent(): void {
    Text(t('ç³»ç»Ÿè®¾ç½®', 'ç³»ç»Ÿè®¾ç½®'))
      .fontSize(18)
      .fontWeight(FontWeight.Bold)
      .fontColor(this.getCurrentTheme().textColor)
      .margin({ bottom: 16 })
      .alignSelf(ItemAlign.Start)

    // æŒ‰é’®ç½‘æ ¼ - 4åˆ—å¸ƒå±€
    Grid() {
      GridItem() { this.buildFloatingButton('âš™ï¸', 'å·¥ç¨‹è®¾ç½®') }
      GridItem() { this.buildFloatingButton('ğŸ“±', 'è®¾å¤‡ä¿¡æ¯') }
      GridItem() { this.buildFloatingButton('ğŸ—‘ï¸', 'æ•°æ®æ¸…é›¶') }
      GridItem() { this.buildFloatingButton('ğŸ”§', 'é…ç½®è®¾ç½®') }
      GridItem() { this.buildFloatingButton('ğŸ‘¨', 'ç”¨æˆ·è®¾ç½®') }
      GridItem() { this.buildFloatingButton('â¬‡ï¸', 'ä¸‹è½½é…ç½®') }
      GridItem() { this.buildFloatingButton('âš ï¸', 'æ•…éšœä¿¡æ¯') }
      GridItem() { this.buildFloatingButton('ğŸ”Œ', 'ç”µå™¨æ•…éšœè®¾ç½®') }
      GridItem() { this.buildFloatingButton('ğŸ·ï¸', 'è´´æ ‡è®¾ç½®') }
      GridItem() { this.buildFloatingButton('ğŸ› ï¸', 'ç³»ç»Ÿæ•…éšœè®¾ç½®') }
      GridItem() { this.buildFloatingButton('ğŸ”„', 'å¤ä½æ‰æœæ¯') }
      GridItem() { this.buildFloatingButton('ğŸ¨', 'ä¸»é¢˜åˆ‡æ¢') }
    }
    .columnsTemplate('1fr 1fr 1fr 1fr')
    .rowsGap(16)
    .columnsGap(16)
    .width('100%')
  }

  // æ„å»ºå¸®åŠ©Tabå†…å®¹
  @Builder
  private buildHelpTabContent(): void {
    Text('å¸®åŠ©æ”¯æŒ')
      .fontSize(18)
      .fontWeight(FontWeight.Bold)
      .fontColor(this.getCurrentTheme().textColor)
      .margin({ bottom: 16 })
      .alignSelf(ItemAlign.Start)

    // æŒ‰é’®ç½‘æ ¼ - 4åˆ—å¸ƒå±€
    Grid() {
      GridItem() { this.buildFloatingButton('ğŸ“–', 'ç”¨æˆ·æ‰‹å†Œ') }
      GridItem() { this.buildFloatingButton('ğŸ”„', 'æ£€æŸ¥æ–°ç‰ˆæœ¬') }
      GridItem() { this.buildFloatingButton('ğŸ’¾', 'å¤‡ä»½è®¾ç½®') }
      GridItem() { this.buildFloatingButton('ğŸ“¥', 'æ¢å¤è®¾ç½®') }
      GridItem() { this.buildFloatingButton('ğŸ”Œ', 'å…³é—­IPM') }
      GridItem() { this.buildFloatingButton('ğŸ“‹', 'åˆ†é€‰æ—¥å¿—') }
      GridItem() { this.buildFloatingButton('â„¹ï¸', 'å…³äº') }
      GridItem() { this.buildFloatingButton('ğŸŒ', 'è¯­è¨€') }
      GridItem() { this.buildFloatingButton('âœï¸', 'ç¿»è¯‘ç®¡ç†') }
      GridItem() { this.buildFloatingButton('ğŸšª', 'é€€å‡º') }
      GridItem() { this.buildFloatingButton('ğŸ‘¨', 'ç”¨æˆ·åˆ‡æ¢') }
    }
    .columnsTemplate('1fr 1fr 1fr 1fr')
    .rowsGap(16)
    .columnsGap(16)
    .width('100%')
  }

  // æ„å»ºä¸»é¢˜é€‰æ‹©å™¨
  @Builder
  private buildThemeSelector(): void {
    Stack() {
      // èƒŒæ™¯é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showThemeSelector = false
        })
      
      // ä¸»é¢˜é€‰æ‹©å™¨å†…å®¹
      Column() {
        // æ ‡é¢˜
        Text('é€‰æ‹©ä¸»é¢˜')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getCurrentTheme().textColor)
          .margin({ bottom: 20 })
        
        // ä¸»é¢˜é€‰é¡¹
        Column() {
          this.buildThemeOption(OmniThemeType.BLUE, 'ğŸ”µ è“è‰²ä¸»é¢˜', '#1976D2')
          this.buildThemeOption(OmniThemeType.GREEN, 'ğŸŸ¢ ç»¿è‰²ä¸»é¢˜', '#388E3C')
          this.buildThemeOption(OmniThemeType.PURPLE, 'ğŸŸ£ ç´«è‰²ä¸»é¢˜', '#7B1FA2')
          this.buildThemeOption(OmniThemeType.ORANGE, 'ğŸŸ  æ©™è‰²ä¸»é¢˜', '#F57C00')
          this.buildThemeOption(OmniThemeType.PINK, 'ğŸŒ¸ ç²‰è‰²ä¸»é¢˜', '#C2185B')
          this.buildThemeOption(OmniThemeType.TEAL, 'ğŸŒŠ é’è‰²ä¸»é¢˜', '#00796B')
          this.buildThemeOption(OmniThemeType.DEEP_BLUE, 'ğŸ’™ å†·é™æ·±è“', '#1565C0')
          this.buildThemeOption(OmniThemeType.WARM_AMBER, 'ğŸ§¡ æš–è‰²è´¨æ„Ÿ', '#FF8F00')
          this.buildThemeOption(OmniThemeType.MINIMAL, 'âš« æç®€é»‘ç™½', '#424242')
          this.buildThemeOption(OmniThemeType.FRESH_GREEN, 'ğŸŒ¿ æ¸…æ–°ç»¿æ„', '#4CAF50')
          this.buildThemeOption(OmniThemeType.ELEGANT_PURPLE, 'ğŸ’œ ä¼˜é›…ç´«è°ƒ', '#9C27B0')
          this.buildThemeOption(OmniThemeType.PROFESSIONAL_BLUE, 'ğŸ¯ ä¸“ä¸šè“è‰²', '#1976D2')
        }
        .width('100%')
        .margin({ top: 12, bottom: 12 })
      }
      .width(350)
      .padding(20)
      .backgroundColor(this.getCurrentTheme().surfaceColor + 'E6') // æ·»åŠ 90%é€æ˜åº¦
      .borderRadius(12)
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.15)',
        offsetX: 0,
        offsetY: 8
      })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(2000)
  }

  // æ„å»ºä¸»é¢˜é€‰é¡¹
  @Builder
  private buildThemeOption(theme: OmniThemeType, name: string, color: string): void {
    Row() {
      // é¢œè‰²æŒ‡ç¤ºå™¨
      Column()
        .width(20)
        .height(20)
        .backgroundColor(color)
        .borderRadius(10)
        .margin({ right: 12 })
      
      // ä¸»é¢˜åç§°
      Text(name)
        .fontSize(16)
        .fontColor(this.getCurrentTheme().textColor)
        .layoutWeight(1)
      
      // é€‰ä¸­æŒ‡ç¤ºå™¨
      if (this.selectedTheme === theme) {
        Text('âœ“')
          .fontSize(16)
          .fontColor(this.getCurrentTheme().textColor)
          .fontWeight(FontWeight.Bold)
      }
    }
    .width('100%')
    .height(50)
    .padding({ left: 16, right: 16 })
    .backgroundColor(this.selectedTheme === theme ? this.getCurrentTheme().textColor + '20' : Color.Transparent)
    .borderRadius(8)
    .border({ 
      width: this.selectedTheme === theme ? 2 : 1, 
      color: this.selectedTheme === theme ? this.getCurrentTheme().textColor : this.getCurrentTheme().borderColor 
    })
    .onClick(() => {
      this.handleThemeChange(theme)
    })
  }

  // è¯­è¨€é€‰æ‹©å¼¹çª—
  @Builder
  private buildLanguageSelectorDialog(): void {
    Stack() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showLanguageSelector = false
        })

      // å†…å®¹
      Column() {
        // æ ‡é¢˜
        Row() {
          Text('ğŸŒ é€‰æ‹©è¯­è¨€')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getCurrentTheme().textColor)
            .layoutWeight(1)

          Button() {
            Text('Ã—')
              .fontSize(28)
              .fontColor(this.getCurrentTheme().textColor)
          }
          .width(32)
          .height(32)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showLanguageSelector = false
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 12 })
        .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })

        // è¯´æ˜
        Text('é€‰æ‹©ç•Œé¢æ˜¾ç¤ºè¯­è¨€ã€‚é€‰æ‹©"è‡ªå®šä¹‰"åï¼Œå¯é€šè¿‡"ç¿»è¯‘ç®¡ç†"ç¼–è¾‘ç¿»è¯‘å†…å®¹ã€‚')
          .fontSize(14)
          .fontColor(this.getCurrentTheme().subTextColor)
          .padding({ left: 20, right: 20, top: 12, bottom: 12 })

        // è¯­è¨€é€‰é¡¹
        Scroll() {
          Column() {
            // ä¸­æ–‡é€‰é¡¹ï¼ˆå›ºå®šï¼‰
            this.buildLanguageOption('ğŸ‡¨ğŸ‡³', 'ä¸­æ–‡', 'ä½¿ç”¨åŸå§‹ä¸­æ–‡ç•Œé¢', 'ä¸­æ–‡')
            
            // åŠ¨æ€æ˜¾ç¤ºæ‰«æåˆ°çš„è¯­è¨€æ–‡ä»¶
            ForEach(this.availableLanguages, (lang: string) => {
              this.buildLanguageOption('ğŸ“„', lang, `ä½¿ç”¨ ${lang} ç¿»è¯‘`, lang)
            }, (lang: string) => lang)
          }
          .width('100%')
          .padding({ left: 20, right: 20, bottom: 20 })
        }
        .width('100%')
        .height(300)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)

        // åº•éƒ¨æŒ‰é’®
        Row() {
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .height(44)
            .borderRadius(10)
            .border({ width: 1, color: this.getCurrentTheme().borderColor })
            .backgroundColor(this.getCurrentTheme().backgroundColor)
            .fontColor(this.getCurrentTheme().textColor)
            .onClick(() => this.cancelLanguageSelection())

          Button('ç¡®è®¤')
            .layoutWeight(1)
            .height(44)
            .margin({ left: 12 })
            .borderRadius(10)
            .backgroundColor(this.getCurrentTheme().primary)
            .fontColor(Color.White)
            .onClick(() => this.confirmLanguageSelection())
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 12, bottom: 16 })
      }
      .width('85%')
      .constraintSize({ maxWidth: 400 })
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(12)
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.1)',
        offsetX: 0,
        offsetY: 4
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
    .position({ x: 0, y: 0 })
    .zIndex(4000)
  }

  // æ„å»ºè¯­è¨€é€‰é¡¹
  @Builder
  private buildLanguageOption(icon: string, lang: string, desc: string, langValue: string): void {
    Row() {
      Text(icon)
        .fontSize(28)
        .margin({ right: 12 })

      Column() {
        Text(lang)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.getCurrentTheme().textColor)
        Text(desc)
          .fontSize(13)
          .fontColor(this.getCurrentTheme().subTextColor)
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      if (this.selectedLanguageTemp === langValue) {
        Text('âœ“')
          .fontSize(20)
          .fontColor(this.getCurrentTheme().primary)
          .fontWeight(FontWeight.Bold)
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 14, bottom: 14 })
    .backgroundColor(this.selectedLanguageTemp === langValue ? this.getCurrentTheme().primary + '15' : Color.Transparent)
    .borderRadius(10)
    .border({ 
      width: this.selectedLanguageTemp === langValue ? 2 : 1, 
      color: this.selectedLanguageTemp === langValue ? this.getCurrentTheme().primary : this.getCurrentTheme().borderColor 
    })
    .margin({ bottom: 10 })
    .onClick(() => {
      this.selectLanguageTemp(langValue)
    })
  }

  // ç¿»è¯‘ç¼–è¾‘å¼¹çª—
  @Builder
  private buildTranslationEditorDialog(): void {
    Stack() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showTranslationEditor = false
        })

      // å†…å®¹
      Column() {
        Row() {
          Text('âœï¸ ç¿»è¯‘ç®¡ç†')
            .fontSize(26)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getCurrentTheme().textColor)
            .layoutWeight(1)

          Button() {
            Text('Ã—')
              .fontSize(28)
              .fontColor(this.getCurrentTheme().textColor)
          }
          .width(32)
          .height(32)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showTranslationEditor = false
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 12 })
        .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })

        // ä½¿ç”¨è¯´æ˜
        Text('åœ¨å³ä¾§"ç¿»è¯‘æ–‡æœ¬"åˆ—å¡«å†™æ‚¨çš„ç¿»è¯‘ï¼Œç•™ç©ºåˆ™æ˜¾ç¤ºåŸå§‹ä¸­æ–‡ã€‚')
          .fontSize(14)
          .fontColor(this.getCurrentTheme().subTextColor)
          .padding({ left: 20, right: 20, top: 12, bottom: 8 })

        // æœç´¢
        Row() {
          Text('ğŸ”')
            .fontSize(20)
            .margin({ right: 8 })
          TextInput({ placeholder: 'æœç´¢...', text: this.translationFilter })
            .layoutWeight(1)
            .height(36)
            .onChange((v: string) => { this.translationFilter = v })
        }
        .width('100%')
        .padding({ left: 20, right: 20, bottom: 8 })

        // åˆ—è¡¨æ ‡é¢˜
        Row() {
          Text('åŸå§‹æ–‡æœ¬')
            .fontSize(15)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getCurrentTheme().textColor)
            .layoutWeight(1)
            .padding({ left: 12 })
          Text('ç¿»è¯‘æ–‡æœ¬')
            .fontSize(15)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getCurrentTheme().textColor)
            .layoutWeight(1)
            .padding({ left: 12 })
        }
        .width('100%')
        .padding({ left: 8, right: 8, top: 8, bottom: 8 })
        .backgroundColor(this.getCurrentTheme().primary + '20')

        // åˆ—è¡¨
        Scroll() {
          Column() {
            ForEach(this.filteredTranslations(), (item: TranslationItem, index: number) => {
              Row() {
                // åŸå§‹æ–‡æœ¬ï¼ˆåªè¯»ï¼‰
                Text(item.key)
                  .fontSize(15)
                  .fontColor(this.getCurrentTheme().textColor)
                  .layoutWeight(1)
                  .padding({ left: 12, right: 8 })
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })

                // ç¿»è¯‘æ–‡æœ¬ï¼ˆå¯ç¼–è¾‘ï¼‰
                TextInput({ text: item.value, placeholder: 'è¾“å…¥ç¿»è¯‘...' })
                  .layoutWeight(1)
                  .height(36)
                  .fontSize(14)
                  .backgroundColor(this.getCurrentTheme().backgroundColor)
                  .onChange((v: string) => this.updateTranslationValue(index, v))
              }
              .width('100%')
              .padding({ left: 8, right: 16, top: 8, bottom: 8 })
              .backgroundColor(index % 2 === 0 ? this.getCurrentTheme().surfaceColor : this.getCurrentTheme().backgroundColor)
            }, (item: TranslationItem) => item.key)
          }
          .width('100%')
          .padding({ bottom: 12 })
        }
        .width('100%')
        .height(400)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)

        // åº•éƒ¨æŒ‰é’®
        Row() {
          Button(t('å–æ¶ˆ', 'å–æ¶ˆ'))
            .layoutWeight(1)
            .height(46)
            .borderRadius(10)
            .border({ width: 1, color: this.getCurrentTheme().borderColor })
            .backgroundColor(this.getCurrentTheme().backgroundColor)
            .fontColor(this.getCurrentTheme().textColor)
            .onClick(() => { this.showTranslationEditor = false })

          Button(t('ä¿å­˜', 'ä¿å­˜'))
            .layoutWeight(1)
            .height(46)
            .margin({ left: 12 })
            .borderRadius(10)
            .backgroundColor(this.getCurrentTheme().primary)
            .fontColor(Color.White)
            .onClick(() => this.saveTranslations())
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 12, bottom: 16 })
      }
      .width('90%')
      .constraintSize({ maxWidth: 600, maxHeight: 800 })
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(12)
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.1)',
        offsetX: 0,
        offsetY: 4
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
    .position({ x: 0, y: 0 })
    .zIndex(4000)
  }

  // è¯­è¨€åç§°è¾“å…¥å¯¹è¯æ¡†
  @Builder
  private buildLanguageNameDialog(): void {
    Stack() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showLanguageNameDialog = false
        })

      // å†…å®¹
      Column() {
        // æ ‡é¢˜
        Row() {
          Text('ğŸ’¾ ä¿å­˜ç¿»è¯‘')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getCurrentTheme().textColor)
            .layoutWeight(1)

          Button() {
            Text('Ã—')
              .fontSize(28)
              .fontColor(this.getCurrentTheme().textColor)
          }
          .width(32)
          .height(32)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showLanguageNameDialog = false
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 12 })
        .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })

        // è¯´æ˜
        Text('è¯·è¾“å…¥è¯­è¨€åç§°ï¼ˆå¦‚ï¼šEnglishã€æ—¥æœ¬èªã€EspaÃ±olï¼‰')
          .fontSize(14)
          .fontColor(this.getCurrentTheme().subTextColor)
          .padding({ left: 20, right: 20, top: 16, bottom: 8 })

        // è¾“å…¥æ¡†
        TextInput({ 
          text: this.languageNameInput, 
          placeholder: 'ä¾‹å¦‚ï¼šEnglish' 
        })
          .width('100%')
          .height(44)
          .fontSize(16)
          .margin({ left: 20, right: 20, top: 8, bottom: 20 })
          .backgroundColor(this.getCurrentTheme().backgroundColor)
          .onChange((v: string) => {
            this.languageNameInput = v
          })

        // åº•éƒ¨æŒ‰é’®
        Row() {
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .height(44)
            .borderRadius(10)
            .border({ width: 1, color: this.getCurrentTheme().borderColor })
            .backgroundColor(this.getCurrentTheme().backgroundColor)
            .fontColor(this.getCurrentTheme().textColor)
            .onClick(() => {
              this.showLanguageNameDialog = false
            })

          Button('ä¿å­˜')
            .layoutWeight(1)
            .height(44)
            .margin({ left: 12 })
            .borderRadius(10)
            .backgroundColor(this.getCurrentTheme().primary)
            .fontColor(Color.White)
            .onClick(() => this.confirmSaveLanguage())
        }
        .width('100%')
        .padding({ left: 20, right: 20, bottom: 16 })
      }
      .width('85%')
      .constraintSize({ maxWidth: 400 })
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(12)
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.1)',
        offsetX: 0,
        offsetY: 4
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
    .position({ x: 0, y: 0 })
    .zIndex(5000)
  }

  // æ„å»ºæ‚¬æµ®çª—æŒ‰é’®
  @Builder
  private buildFloatingButton(icon: string, title: string): void {
    Button() {
      Column() {
        Text(icon)
          .fontSize(32)
          .margin({ bottom: 8 })
        
        Text(title)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.getCurrentTheme().textColor)
          .textAlign(TextAlign.Center)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height(120)
    .backgroundColor(this.getCurrentTheme().surfaceColor)
    .border({ width: 1, color: this.getCurrentTheme().borderColor })
    .borderRadius(8)
    .onClick(() => {
      console.log('æ‚¬æµ®çª—æŒ‰é’®è¢«ç‚¹å‡»:', title)
      if (title === 'ä¸»é¢˜åˆ‡æ¢') {
        this.selectedTheme = this.consumedThemeType // åˆå§‹åŒ–é€‰ä¸­ä¸»é¢˜ä¸ºå½“å‰ä¸»é¢˜
        this.showThemeSelector = true
      } else if (title === 'å·¥ç¨‹è®¾ç½®') {
        this.showEngineeringSettings()
      } else if (title === 'å‡ºå£æ¸…ç©º') {
        this.handleExportClear()
      } else if (title === 'è¯­è¨€') {
        this.openLanguageSelector()
      } else if (title === 'ç¿»è¯‘ç®¡ç†') {
        this.openTranslationEditor()
      } else {
        this.omniUIUtils.showInfo(`å·²ç‚¹å‡»${title}`)
      }
    })
  }



  // åˆ›å»ºå¯¼èˆªæŒ‰é’®é…ç½®ï¼ˆä¾èµ– i18nVersion ç¡®ä¿è¯­è¨€å˜åŒ–æ—¶é‡æ–°è®¡ç®—ï¼‰
  private getNavigationButtons(): NavigationButton[] {
    // å¼•ç”¨ i18nVersion ç¡®ä¿è¯­è¨€å˜åŒ–æ—¶é‡æ–°è®¡ç®—
    const _version = this.i18nVersion
    return [
      { text: t('ä¸»é¡µ', 'ä¸»é¡µ'), pageName: 'home' },
      { text: t('å“è´¨', 'å“è´¨'), pageName: 'quality' },
      { text: t('ç­‰çº§', 'ç­‰çº§'), pageName: 'level' },
      { text: t('æ°´æœä¿¡æ¯', 'æ°´æœä¿¡æ¯'), pageName: 'fruit' },
      { text: t('è½½å…¥ç¨‹åº', 'è½½å…¥ç¨‹åº'), pageName: 'load' },
      { text: t('ä¿å­˜ç¨‹åº', 'ä¿å­˜ç¨‹åº'), pageName: 'save' },
      { text: t('å†å²åŠ å·¥', 'å†å²åŠ å·¥'), pageName: 'history' },
      { text: t('å®æ—¶ç»Ÿè®¡', 'å®æ—¶ç»Ÿè®¡'), pageName: 'realtime' },
      { text: t('ç»“æŸåŠ å·¥', 'ç»“æŸåŠ å·¥'), pageName: 'end' },
      { text: t('æ‰“å°', 'æ‰“å°'), pageName: 'print' },
      { text: t('æ›´å¤š', 'æ›´å¤š'), pageName: 'more' }
    ]
  }

  // ==================== é¡µé¢æ‡’åŠ è½½ï¼šä¸ºæ¯ä¸ªé¡µé¢åˆ›å»ºç‹¬ç«‹çš„ Builder ====================
  // è¿™æ ·åªæœ‰åœ¨åˆ‡æ¢åˆ°å¯¹åº”é¡µé¢æ—¶æ‰ä¼šåˆ›å»ºç»„ä»¶ï¼Œå®ç°çœŸæ­£çš„æ‡’åŠ è½½

  @Builder
  private buildHomePage(): void {
    HomeContent()
  }

  @Builder
  private buildLevelPage(): void {
    LevelContent()
  }

  @Builder
  private buildQualityPage(): void {
    QualityContent()
  }

  @Builder
  private buildRealtimePage(): void {
    // å®æ—¶ç»Ÿè®¡å ä½é¡µé¢ï¼ˆåç»­å¯æ›¿æ¢ä¸ºçœŸå®ç»„ä»¶ï¼‰
    Column() {
      Text(t('å®æ—¶ç»Ÿè®¡', 'å®æ—¶ç»Ÿè®¡'))
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.getCurrentTheme().primary)
        .margin({ top: 20 })
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  private buildHistoryPage(): void {
    HistoryContent()
  }

  @Builder
  private buildEndPage(): void {
    EndProcessingContent()
  }

  // æ¸²æŸ“é¡µé¢å†…å®¹ï¼ˆæ‡’åŠ è½½ï¼šåªåˆ›å»ºå½“å‰é¡µé¢çš„ç»„ä»¶ï¼‰
  @Builder
  private renderPageContent(): void {
    if (this.currentPage === 'home') {
      this.buildHomePage()  // å»¶è¿Ÿåˆ›å»ºï¼šåªæœ‰åˆ‡æ¢åˆ° home æ—¶æ‰åˆ›å»º
    } else if (this.currentPage === 'level') {
      this.buildLevelPage()  // å»¶è¿Ÿåˆ›å»ºï¼šåªæœ‰åˆ‡æ¢åˆ° level æ—¶æ‰åˆ›å»º
    } else if (this.currentPage === 'quality') {
      this.buildQualityPage()  // å»¶è¿Ÿåˆ›å»ºï¼šåªæœ‰åˆ‡æ¢åˆ° quality æ—¶æ‰åˆ›å»º
    } else if (this.currentPage === 'realtime') {
      this.buildRealtimePage()  // å»¶è¿Ÿåˆ›å»ºï¼šåªæœ‰åˆ‡æ¢åˆ° realtime æ—¶æ‰åˆ›å»º
    } else if (this.currentPage === 'history') {
      this.buildHistoryPage()  // å»¶è¿Ÿåˆ›å»ºï¼šåªæœ‰åˆ‡æ¢åˆ° history æ—¶æ‰åˆ›å»º
    } else if (this.currentPage === 'end') {
      this.buildEndPage()  // å»¶è¿Ÿåˆ›å»ºï¼šåªæœ‰åˆ‡æ¢åˆ° end æ—¶æ‰åˆ›å»º
    } else {
      // é»˜è®¤é¡µé¢å†…å®¹
      this.renderDefaultPage()
    }
  }

  // æ¸²æŸ“é»˜è®¤é¡µé¢å†…å®¹
  @Builder
  private renderDefaultPage(): void {
    Column() {
      Text(`${this.getPageTitle(this.currentPage)}é¡µé¢`)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .margin({ top: 50 })
      Text(`è¿™é‡Œå°†æ˜¾ç¤º${this.getPageTitle(this.currentPage)}åŠŸèƒ½`)
        .fontSize(16)
        .fontColor(this.getCurrentTheme().subTextColor)
        .margin({ top: 20 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // è·å–å½“å‰ä¸»é¢˜çš„ä¸»è‰²è°ƒï¼ˆåŸºäºé¡µé¢çŠ¶æ€ï¼‰
  getThemePrimaryColor(): string {
    const themeConfigs = this.omniThemeManager.getAllThemes()
    const themeType = this.consumedThemeType ?? this.omniThemeManager.getCurrentThemeType()
    const primaryColor = themeConfigs[themeType]?.primary
    return typeof primaryColor === 'string' ? primaryColor : '#007AFF'
  }

  // æ ¹æ®å½“å‰é¡µé¢è·å–å·¦ä¾§å¯¼èˆªèƒŒæ™¯è‰²ï¼ˆæœªé…ç½®åˆ™å›é€€åˆ°é€šç”¨ navBgï¼‰
  private getNavBgForCurrentPage(): string | number {
    const theme = this.getCurrentTheme()
    const page = this.currentPage
    if (page === 'home' && theme.navBgHome) return theme.navBgHome
    if (page === 'level' && theme.navBgLevel) return theme.navBgLevel
    if (page === 'quality' && theme.navBgQuality) return theme.navBgQuality
    if (page === 'history' && theme.navBgHistory) return theme.navBgHistory
    if (page === 'more' && theme.navBgMore) return theme.navBgMore
    return theme.navBg ?? theme.surfaceColor
  }

  // ç»Ÿä¸€å¼¹å‡ºå¿«æ·å¯¹è¯æ¡†
  private openQuickDialog(title: string, content: string, onConfirm?: () => void): void {
    this.quickDialogTitle = title
    this.quickDialogContent = content
    this.quickDialogConfirm = onConfirm
    this.quickDialogVisible = true
  }

  // æ ¹æ®ç´¢å¼•å¼¹å‡ºå¿«æ·å¯¹è¯æ¡†ï¼ˆç”¨äºåº•éƒ¨æŒ‰é’®1~10ï¼‰
  private openQuickDialogForIndex(index: number, onConfirm?: () => void): void {
    this.quickDialogIndex = index
    const title = `${index}å·å‡ºå£`
    const content = `ä½ ç‚¹å‡»äº†åº•éƒ¨æŒ‰é’® ${index}`
    this.openQuickDialog(title, content, onConfirm)
  }

  // åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ª
  private navigateQuickDialog(delta: number): void {
    if (!this.quickDialogVisible || this.quickDialogIndex < 1) {
      return
    }
    const count = this.bottomButtonsCount
    let nextIndex = ((this.quickDialogIndex - 1 + delta) % count + count) % count + 1
    this.openQuickDialogForIndex(nextIndex)
  }

  // æ„å»ºæ‰“å°å­æŒ‰é’®ï¼ˆå‘ä¸‹å±•å¼€ï¼Œå¸¦ç¼©è¿›ï¼‰
  @Builder
  private buildPrintSubButtons() {
    if (this.showPrintSubButtons) {
      Column() {
        // å­æŒ‰é’®1ï¼šæ‰“å°æŠ¥å‘Š
        Button('æ‰“å°æŠ¥å‘Š')
          .width('70%')
          .height(36)
          .margin({ bottom: 4, left: 20, right: 20 })
          .fontSize(12)
          .fontWeight(FontWeight.Bolder)
          .fontColor(this.getCurrentTheme().textColor)
          .backgroundColor(this.getCurrentTheme().surfaceColor)
          .border({ 
            width: 1, 
            color: this.getCurrentTheme().borderColor 
          })
          .borderRadius(0)
          .onClick(() => {
            this.handlePrintSubButtonClick('æ‰“å°æŠ¥å‘Š')
          })

        // å­æŒ‰é’®2ï¼šæ‰“å°æ ‡ç­¾
        Button('æ‰“å°æ ‡ç­¾')
          .width('70%')
          .height(36)
          .margin({ left: 20, right: 20 })
          .fontSize(12)
          .fontWeight(FontWeight.Bolder)
          .fontColor(this.getCurrentTheme().textColor)
          .backgroundColor(this.getCurrentTheme().surfaceColor)
          .border({ 
            width: 1, 
            color: this.getCurrentTheme().borderColor 
          })
          .borderRadius(0)
          .onClick(() => {
            this.handlePrintSubButtonClick('æ‰“å°æ ‡ç­¾')
          })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      .margin({ top: 4 })
    }
  }


  // æ¸²æŸ“å¿«æ·å¯¹è¯æ¡†
  @Builder
  private renderQuickDialog() {
    Stack() {
      Column() {
        Row() {
          Text(this.quickDialogTitle || 'æç¤º')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getCurrentTheme().textColor)
            .layoutWeight(1)
          
          // å³ä¸Šè§’ï¼šä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªæŒ‰é’®
          Row() {
            Button('ä¸Šä¸€ä¸ª')
              .fontSize(12)
              .fontColor(this.getCurrentTheme().textColor)
              .backgroundColor(this.getCurrentTheme().backgroundColor)
              .border({ width: 1, color: this.getCurrentTheme().borderColor })
              .borderRadius(6)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .onClick(() => { this.navigateQuickDialog(-1) })

            Button('ä¸‹ä¸€ä¸ª')
              .fontSize(12)
              .fontColor(this.getCurrentTheme().textColor)
              .backgroundColor(this.getCurrentTheme().backgroundColor)
              .border({ width: 1, color: this.getCurrentTheme().borderColor })
              .borderRadius(6)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .margin({ left: 8 })
              .onClick(() => { this.navigateQuickDialog(1) })
          }
          .alignItems(VerticalAlign.Center)
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 15, bottom: 15 })
        .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })

        // å†…å®¹åŒºåŸŸæš‚æ—¶ç•™ç©º
        Blank()
          .height(60)

        // å³ä¸‹è§’ï¼šç¡®è®¤/å–æ¶ˆæŒ‰é’®
        Row() {
          Blank()
          
          Row() {
            Button('å–æ¶ˆ')
              .fontSize(14)
              .fontColor(this.getCurrentTheme().textColor)
              .backgroundColor(this.getCurrentTheme().backgroundColor)
              .border({ width: 1, color: this.getCurrentTheme().borderColor })
              .borderRadius(8)
              .padding({ left: 20, right: 20, top: 10, bottom: 10 })
              .onClick(() => { this.quickDialogVisible = false })

            Button('ç¡®è®¤')
              .fontSize(14)
              .fontColor(Color.White)
              .backgroundColor(this.getThemePrimaryColor())
              .borderRadius(8)
              .padding({ left: 20, right: 20, top: 10, bottom: 10 })
              .margin({ left: 10 })
              .onClick(() => {
                if (this.quickDialogConfirm) {
                  this.quickDialogConfirm()
                } else {
                  this.omniUIUtils.showSuccess('å·²ç¡®è®¤')
                }
                this.quickDialogVisible = false
              })
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.End)
        .alignItems(VerticalAlign.Center)
        .padding({ left: 20, right: 20, top: 0, bottom: 20 })
      }
      .width('80%')
      .constraintSize({ maxWidth: 500 })
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(12)
      .shadow({ radius: 20, color: 'rgba(0, 0, 0, 0.1)', offsetX: 0, offsetY: 4 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0, 0, 0, 0.5)')
    .alignContent(Alignment.Center)
    .onClick(() => { this.quickDialogVisible = false })
    .visibility(this.quickDialogVisible ? Visibility.Visible : Visibility.None)
  }

  @Builder
  renderPage() {
    Stack() {
      Column() {
      
      Row() {
        // å·¦ä¾§ç«–å‘å¯¼èˆªï¼ˆè‡ªå®šä¹‰å±•å¼€/æ”¶ç¼©ï¼‰
        Stack() {
          // å¯¼èˆªæŒ‰é’®å†…å®¹
          if (this.sideBarStatus) {
            LeftNavigationTabBar({
              currentPage: this.currentPage,
              showPrintSubButtons: this.showPrintSubButtons,
              onPageChange: (pageKey: string) => {
                this.handlePageChange(pageKey)
                // åªæœ‰éæ°´æœä¿¡æ¯é¡µé¢æ‰æ˜¾ç¤ºåˆ‡æ¢æ¶ˆæ¯
                if (pageKey !== 'fruit' && pageKey !== 'realtime') {
                  this.omniUIUtils.showInfo(`å·²åˆ‡æ¢åˆ°${this.getPageTitle(pageKey)}é¡µé¢`)
                }
              },
              onPrintSubButtonClick: (subButtonName: string) => {
                this.handlePrintSubButtonClick(subButtonName)
              }
            })
          }

          // ç®­å¤´æŒ‰é’® - è´´åœ¨å³è¾¹è¾¹ç¼˜ï¼Œå‚ç›´å±…ä¸­ï¼Œæ›´çªå‡º
          ArrowToggleButton({
            isExpanded: this.sideBarStatus,
            onToggle: () => {
              this.sideBarStatus = !this.sideBarStatus
            }
          })
          .position({ x: this.sideBarStatus ? 120 : 5, y: '50%' })
          .translate({ y: -20 })
          .zIndex(10) // ç¡®ä¿åœ¨æœ€ä¸Šå±‚
        }
        .width(this.sideBarStatus ? 150 : 50)
        .height('100%')
        // .padding({ left: 8, right: 8, top: 8, bottom: 8 })
        .backgroundColor(this.sideBarStatus ? this.getNavBgForCurrentPage() : this.getCurrentTheme().backgroundColor)

        // å³ä¾§å†…å®¹
        Column() {
          this.renderPageContent()
        }
        .width('100%')
        .height('100%')
        .backgroundColor(this.getCurrentTheme().pageBg ?? this.getCurrentTheme().surfaceColor)
        .padding({ bottom: 12 })
        .layoutWeight(1)

      }
      .width('100%')
      .height('100%')
      .layoutWeight(1)

      //ï¼ˆå·²æŒ‰éœ€ç§»é™¤åº•éƒ¨ä»»åŠ¡æ ï¼‰
      }
      .height('100%')
      .width('100%')
      
      // ç§»é™¤åº•éƒ¨æ 
      
      // ä¸»é¢˜é€‰æ‹©å™¨å¼¹çª—
      // if (this.showThemeSelector) {
      //   ThemeSelector({
      //     onThemeSelected: (theme: OmniThemeType) => {
      //       const hook = useOmniTheme()
      //       hook.setTheme(theme)
      //       this.showThemeSelector = false
      //       const themeName = this.omniThemeManager.getThemeName(theme)
      //       this.omniUIUtils.showSuccess(`å·²åˆ‡æ¢åˆ°${themeName}`)
      //     },
      //     onCancel: () => {
      //       this.showThemeSelector = false
      //     }
      //   })
      // }

      // æ°´æœä¿¡æ¯å¯¹è¯æ¡†
      if (this.showFruitInfoDialog) {
        FruitInfoDialog({
          isVisible: this.showFruitInfoDialog,
          onConfirm: (fruitInfo: FruitInfo) => {
            this.handleFruitInfoConfirm(fruitInfo)
          },
          onCancel: () => {
            this.handleFruitInfoCancel()
          }
        })
      }

      // è½½å…¥ç¨‹åºå¯¹è¯æ¡†
      if (this.showLoadProgramDialog) {
        LoadProgramDialog({
          isVisible: this.showLoadProgramDialog,
          onConfirm: (programInfo: ProgramInfo) => {
            this.handleLoadProgramConfirm(programInfo)
          },
          onCancel: () => {
            this.handleLoadProgramCancel()
          }
        })
      }

      // å®æ—¶ç»Ÿè®¡å¯¹è¯æ¡†ï¼ˆä¸æ°´æœä¿¡æ¯åŒé£æ ¼ï¼šç»Ÿä¸€ä¸ºç‹¬ç«‹å¼¹çª—ç»„ä»¶ï¼‰
      if (this.showRealtimeDialog) {
        RealtimeStatsDialog({
          isVisible: this.showRealtimeDialog,
          onConfirm: (_stats) => {
            this.omniUIUtils.showInfo('å·²ç¡®è®¤å®æ—¶ç»Ÿè®¡')
            this.showRealtimeDialog = false
          },
          onCancel: () => {
            this.omniUIUtils.showInfo('å·²å–æ¶ˆæŸ¥çœ‹å®æ—¶ç»Ÿè®¡')
            this.showRealtimeDialog = false
          }
        })
      }

      // ä¿å­˜ç¨‹åºå¯¹è¯æ¡†
      if (this.showSaveProgramDialog) {
        SaveProgramDialog({
          isVisible: this.showSaveProgramDialog,
          onConfirm: (saveProgramInfo: SaveProgramInfo) => {
            this.handleSaveProgramConfirm(saveProgramInfo)
          },
          onCancel: () => {
            this.handleSaveProgramCancel()
          }
        })
      }

      // åˆ†é€‰çŠ¶æ€å¯¹è¯æ¡† - æ‚¬æµ®åœ¨åº•éƒ¨æ§åˆ¶æ ä¸Šæ–¹
      if (this.showSortingStatusDialog) {
        Stack() {
          SortingStatusDialog({
            isVisible: this.showSortingStatusDialog,
            onConfirm: (isNormal: boolean) => {
              this.handleSortingStatusConfirm(isNormal)
            },
            onCancel: () => {
              this.handleSortingStatusCancel()
            }
          })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .onClick(() => {
          // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­å¼¹çª—
          this.showSortingStatusDialog = false
        })
      }

      // é€šç”¨å¿«æ·å¯¹è¯æ¡†
      this.renderQuickDialog()

      // å…¨å±å±…ä¸­ï¼šä¸ªäººä¿¡æ¯ç¼–è¾‘å¼¹çª—ï¼ˆç”±é¡µé¢æ ¹éƒ¨æ¸²æŸ“ï¼Œè¦†ç›–å…¨å±ï¼‰
      if (this.editUserLabelVisible) {
        Stack() {
          Scroll() {
            Column() {
            // æ ‡é¢˜
            Row() {
              Text('ä¿®æ”¹ä¸ªäººä¿¡æ¯')
                .fontSize(22)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.getCurrentTheme().textColor)
            }
            .width('100%')
            .padding({ left: 20, right: 20, top: 16, bottom: 10 })
            .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })

            // ä¸ªäººä¿¡æ¯è®¾ç½®åŒºåŸŸ
            Column() {
              // å½“å‰å¤´åƒå’Œå§“åé¢„è§ˆ
              Row() {
                Text('å½“å‰è®¾ç½®ï¼š')
                  .fontSize(20)
                  .fontColor(this.getCurrentTheme().textColor)
                  .margin({ right: 12 })
                
                IBestAvatar({
                  src: this.selectedAvatarUrl || this.avatarOptions[0],
                  defaultAvatar: $r('app.media.default_avatar'),
                  avatarSize: 60,
                  shape: 'circle'
                })
                
                Text(this.tempUserLabel)
                  .fontSize(20)
                  .fontColor(this.getCurrentTheme().textColor)
                  .margin({ left: 12 })
              }
              .width('100%')
              .alignItems(VerticalAlign.Center)
              .margin({ bottom: 20 })

              // å¤´åƒé€‰æ‹©
              Column() {
                Text('é€‰æ‹©å¤´åƒï¼š')
                  .fontSize(20)
                  .fontColor(this.getCurrentTheme().textColor)
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 12 })
                
                // å¤´åƒç½‘æ ¼
                Grid() {
                  ForEach(this.avatarOptions, (avatarUrl: string, index: number) => {
                    GridItem() {
                      IBestAvatar({
                        src: avatarUrl,
                        defaultAvatar: $r('app.media.default_avatar'),
                        avatarSize: 60,
                        shape: 'circle',
                        onAvatarClick: () => {
                          console.log('é€‰æ‹©å¤´åƒ:', avatarUrl)
                          this.selectedAvatarUrl = avatarUrl
                        }
                      })
                      .border({
                        width: this.selectedAvatarUrl === avatarUrl ? 3 : 1,
                        color: this.selectedAvatarUrl === avatarUrl ? '#EA7A10' : this.getCurrentTheme().borderColor
                      })
                      .borderRadius(8)
                      .padding(4)
                    }
                  })
                }
                .columnsTemplate('1fr 1fr 1fr 1fr')
                .rowsGap(12)
                .columnsGap(12)
                .width('100%')
              }
              .width('100%')
              .alignItems(HorizontalAlign.Start)
              .margin({ bottom: 20 })

              // å§“åè¾“å…¥æ¡†
              Row() {
                Text('å§“åè®¾ç½®ï¼š')
                  .fontSize(20)
                  .fontColor(this.getCurrentTheme().textColor)
                  .margin({ right: 12 })
                
                TextInput({ 
                  text: this.tempUserLabel, 
                  placeholder: 'è¯·è¾“å…¥æ˜¾ç¤ºæ ‡ç­¾' 
                })
                  .fontSize(18)
                  .fontColor(this.getCurrentTheme().textColor)
                  .backgroundColor(this.getCurrentTheme().backgroundColor)
                  .border({ width: 1, color: this.getCurrentTheme().borderColor })
                  .borderRadius(8)
                  .padding({ left: 12, right: 12, top: 12, bottom: 12 })
                  .layoutWeight(1)
                  .onChange((v: string) => { this.tempUserLabel = v })
              }
              .width('100%')
              .alignItems(VerticalAlign.Center)
            }
            .width('100%')
            .padding({ left: 20, right: 20, top: 16, bottom: 16 })
            .alignItems(HorizontalAlign.Start)

            // åº•éƒ¨æ“ä½œæŒ‰é’®
            Row() {
              Button('å–æ¶ˆ')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor(this.getCurrentTheme().textColor)
                .backgroundColor(this.getCurrentTheme().backgroundColor)
                .border({ width: 2, color: this.getCurrentTheme().borderColor })
                .borderRadius(8)
                .padding({ left: 40, right: 40, top: 16, bottom: 16 })
                .layoutWeight(1)
                .onClick(() => { 
                  AppStorage.set('EDIT_USER_LABEL_VISIBLE', false) 
                })

              Button('ç¡®è®¤')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor(Color.White)
                .backgroundColor(this.getThemePrimaryColor())
                .borderRadius(8)
                .padding({ left: 40, right: 40, top: 16, bottom: 16 })
                .layoutWeight(1)
                .margin({ left: 12 })
                .onClick(() => {
                  const text = (this.tempUserLabel || '').trim()
                  if (text.length > 0) {
                    AppStorage.setOrCreate('TOP_USER_LABEL', text)
                  }
                  // ä¿å­˜é€‰ä¸­çš„å¤´åƒ
                  console.log('ä¿å­˜å¤´åƒ:', this.selectedAvatarUrl)
                  AppStorage.setOrCreate('SELECTED_AVATAR_URL', this.selectedAvatarUrl)
                  AppStorage.set('EDIT_USER_LABEL_VISIBLE', false)
                })
            }
            .width('100%')
            .padding({ left: 20, right: 20, top: 20, bottom: 20 })
            .backgroundColor(this.getCurrentTheme().surfaceColor)
            .border({ width: { top: 1 }, color: this.getCurrentTheme().borderColor })
            }
            .width('80%')
            .constraintSize({ maxWidth: 460 })
            .backgroundColor(this.getCurrentTheme().surfaceColor)
            .borderRadius(12)
            .shadow({ radius: 20, color: 'rgba(0, 0, 0, 0.1)', offsetX: 0, offsetY: 4 })
            .onAppear(() => {
              this.tempUserLabel = AppStorage.get('TOP_USER_LABEL') || 'å§“å'
              this.selectedAvatarUrl = AppStorage.get('SELECTED_AVATAR_URL') || this.avatarOptions[0]
              console.log('å¼¹çª—æ‰“å¼€ï¼Œå½“å‰å¤´åƒURL:', this.selectedAvatarUrl)
              console.log('å¤´åƒé€‰é¡¹åˆ—è¡¨:', this.avatarOptions)
            })
          }
          .scrollable(ScrollDirection.Vertical)
          .scrollBar(BarState.Auto)
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .alignContent(Alignment.Center)
      }


    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨çŠ¶æ€æ ï¼ˆå…¨å±€å¯è§ï¼‰
      TopStatusBar({ 
        currentPage: this.currentPage,
        selectedFSM: this.selectedFSM,
        onFSMChange: (fsm: 'FSM1' | 'FSM2') => {
          console.log(`ğŸ”„ FSMåˆ‡æ¢å¼€å§‹: ${this.selectedFSM} -> ${fsm}`)

          // å…ˆä¿å­˜å½“å‰ä¸»é¢˜åˆ°å½“å‰FSMçŠ¶æ€ï¼ˆåœ¨åˆ‡æ¢ä¹‹å‰ï¼‰
          const currentTheme = this.omniThemeManager.getCurrentThemeType()
          
          // ä½¿ç”¨ç»„ä»¶å†…éƒ¨çŠ¶æ€ä¿å­˜ä¸»é¢˜
          if (this.selectedFSM === 'FSM1') {
            this.fsm1Theme = currentTheme
            console.log(`ğŸ’¾ ä¿å­˜å½“å‰FSM1çš„ä¸»é¢˜è®¾ç½®:`, currentTheme, `çŠ¶æ€å˜é‡: fsm1Theme`)
          } else {
            this.fsm2Theme = currentTheme
            console.log(`ğŸ’¾ ä¿å­˜å½“å‰FSM2çš„ä¸»é¢˜è®¾ç½®:`, currentTheme, `çŠ¶æ€å˜é‡: fsm2Theme`)
          }
          
          // ç«‹å³éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ
          const currentThemeValue = this.selectedFSM === 'FSM1' ? this.fsm1Theme : this.fsm2Theme
          console.log(`âœ… éªŒè¯ä¿å­˜ç»“æœ:`, currentThemeValue, `çŠ¶æ€å˜é‡: ${this.selectedFSM === 'FSM1' ? 'fsm1Theme' : 'fsm2Theme'}`)
          
          // æ›´æ–°å…¨å±€FSMçŠ¶æ€
          AppStorage.set('HOME_SELECTED_FSM', fsm)
          console.log(`ğŸ”„ å·²æ›´æ–°FSMçŠ¶æ€ä¸º: ${fsm}`)

          // æ¢å¤ç›®æ ‡FSMçŠ¶æ€çš„ä¸»é¢˜è®¾ç½®
          const targetTheme = fsm === 'FSM1' ? this.fsm1Theme : this.fsm2Theme
          console.log(`ğŸ” æŸ¥æ‰¾ç›®æ ‡${fsm}çš„ä¸»é¢˜è®¾ç½®:`, targetTheme, `çŠ¶æ€å˜é‡: ${fsm === 'FSM1' ? 'fsm1Theme' : 'fsm2Theme'}`)
          
          // æ£€æŸ¥ç»„ä»¶çŠ¶æ€ä¸­æ‰€æœ‰çš„FSMä¸»é¢˜
          console.log(`ğŸ” æ£€æŸ¥ç»„ä»¶çŠ¶æ€ä¸­çš„FSMä¸»é¢˜:`)
          console.log(`  fsm1Theme:`, this.fsm1Theme, `(ç±»å‹: ${typeof this.fsm1Theme})`)
          console.log(`  fsm2Theme:`, this.fsm2Theme, `(ç±»å‹: ${typeof this.fsm2Theme})`)
          
          if (targetTheme) {
            // å¦‚æœç›®æ ‡FSMæœ‰ä¿å­˜çš„ä¸»é¢˜è®¾ç½®ï¼Œåˆ™æ¢å¤
            this.omniThemeManager.setTheme(targetTheme)
            console.log(`âœ… æ¢å¤${fsm}çš„ä¸»é¢˜è®¾ç½®:`, targetTheme)
          } else {
            // å¦‚æœç›®æ ‡FSMæ²¡æœ‰ä¿å­˜çš„ä¸»é¢˜è®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤ä¸»é¢˜
            if (fsm === 'FSM2') {
              this.omniThemeManager.setTheme(OmniThemeType.WARM_AMBER)
              console.log(`ğŸ¨ ä½¿ç”¨${fsm}çš„é»˜è®¤ä¸»é¢˜: WARM_AMBER`)
            } else {
              this.omniThemeManager.setTheme(OmniThemeType.PROFESSIONAL_BLUE)
              console.log(`ğŸ¨ ä½¿ç”¨${fsm}çš„é»˜è®¤ä¸»é¢˜: PROFESSIONAL_BLUE`)
            }
          }

          console.log(`âœ… FSMåˆ‡æ¢å®Œæˆ: ${fsm}`)
        }
      })

      // ä¸»ä½“å†…å®¹åŒºåŸŸï¼ˆå¯ä¼¸ç¼©ï¼Œå æ®ä¸­é—´ç©ºé—´ï¼‰
      Column() {
        if ((this.themeVersion % 2) === 0) {
          this.renderPage()
        } else {
          this.renderPage()
        }
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ bottom: 0 })

      // åº•éƒ¨æ§åˆ¶æ ï¼ˆå…¨å±€å›ºå®šï¼‰
      BottomControlBar({
        onSortingStatusClick: () => {
          this.showSortingStatus()
        },
        onOutletClick: (outletNumber: number) => {
          console.log(`å‡ºå£${outletNumber}è¢«ç‚¹å‡»`)
          // å¯ä»¥åœ¨è¿™é‡Œå¤„ç†å‡ºå£ç‚¹å‡»é€»è¾‘
        },
        onFruitCupClick: (cupNumber: number) => {
          console.log(`æœæ¯${cupNumber}è¢«ç‚¹å‡»`)
          // å¯ä»¥åœ¨è¿™é‡Œå¤„ç†æœæ¯ç‚¹å‡»é€»è¾‘
        },
        onSCMClick: () => {
          console.log('SCMæŒ‰é’®è¢«ç‚¹å‡»')
          // å¯ä»¥åœ¨è¿™é‡Œå¤„ç†SCMç‚¹å‡»é€»è¾‘
        }
      })
      .width('100%')
      .zIndex(100) // ç¡®ä¿åœ¨æœ€ä¸Šå±‚

      // æ‚¬æµ®çª—ç»„ä»¶
      if (this.showFloatingWindow) {
        FloatingWindow({
          isVisible: this.showFloatingWindow,
          title: this.floatingWindowTitle,
          windowWidth: '27.78%',
          windowHeight: '48.61%',
          windowPosition: { x: 120, y: 400 },
          onClose: () => {
            this.handleFloatingWindowClose()
          }
        }) {
          // æ‚¬æµ®çª—å†…å®¹ - 3ä¸ªTabçš„è®¾ç½®é¡µé¢
          Column() {
            // Tabå¯¼èˆªæ 
            Row() {
              this.buildFloatingTabButton('å‡ºå£', 'export')
              this.buildFloatingTabButton('è®¾ç½®', 'settings')
              this.buildFloatingTabButton('å¸®åŠ©', 'help')
            }
            .width('100%')
            .height('3.47%')
            .backgroundColor(this.getCurrentTheme().surfaceColor)
            .borderRadius(8)
            .margin({ bottom: 16 })

            // Tabå†…å®¹åŒºåŸŸ
            if (this.floatingWindowTitle === 'æ›´å¤šè®¾ç½®') {
              if (this.selectedFloatingTab === 'export') {
                this.buildExportTabContent()
              } else if (this.selectedFloatingTab === 'settings') {
                this.buildSettingsTabContent()
              } else if (this.selectedFloatingTab === 'help') {
                this.buildHelpTabContent()
              }
            } else {
              // å…¶ä»–é¡µé¢çš„ç®€å•å†…å®¹
              Text(this.floatingWindowContent)
                .fontSize(14)
                .fontColor(this.getCurrentTheme().textColor)
                .lineHeight(24)
                .padding(16)
                .width('100%')
                .textAlign(TextAlign.Start)
            }
          }
          .width('100%')
          .height('100%')
        }
      }
      
      // ä¸»é¢˜é€‰æ‹©å™¨
      if (this.showThemeSelector) {
        Stack() {
          this.buildThemeSelector()
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(2000) // ä¸»é¢˜é€‰æ‹©å™¨å±‚çº§
      }
      
      // å·¥ç¨‹è®¾ç½®å¯¹è¯æ¡†
      if (this.showEngineeringSettingsDialog) {
        Stack() {
          EngineeringSettingsDialog({
            isVisible: this.showEngineeringSettingsDialog,
            onConfirm: () => {
              this.handleEngineeringSettingsConfirm()
            },
            onCancel: () => {
              this.handleEngineeringSettingsCancel()
            }
          })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(3000) // ç¡®ä¿åœ¨æœ€ä¸Šå±‚
      }
      
      // è¯­è¨€é€‰æ‹©å¼¹çª—
      if (this.showLanguageSelector) {
        this.buildLanguageSelectorDialog()
      }
      
      // ç¿»è¯‘ç¼–è¾‘å¼¹çª—
      if (this.showTranslationEditor) {
        this.buildTranslationEditorDialog()
      }

      // è¯­è¨€åç§°è¾“å…¥å¯¹è¯æ¡†
      if (this.showLanguageNameDialog) {
        this.buildLanguageNameDialog()
      }
    }
    .width('100%')
    .height('100%')
    .focusable(true)
    .defaultFocus(true)
    .onKeyEvent((event) => {
      // åœ¨æœ€å¤–å±‚ Home é¡µé¢ç»Ÿä¸€ç›‘å¬å·¦ Ctrlï¼Œå¹¶å†™å…¥å…¨å±€å¤šé€‰çŠ¶æ€
      if (event.keyCode === KeyCode.KEYCODE_CTRL_LEFT) {
        if (event.type === KeyType.Down) {
          AppStorage.setOrCreate('HOME_CTRL_PRESSED', true);
          3
        } else if (event.type === KeyType.Up) {
          AppStorage.setOrCreate('HOME_CTRL_PRESSED', false);

        }
      }
      return false;
    })
  }
}
