/**
 * æ›´å¤šé¡µé¢å†…å®¹ç»„ä»¶
 * åŠŸèƒ½ï¼šæ˜¾ç¤ºç³»ç»Ÿè®¾ç½®ã€ä¸»é¢˜åˆ‡æ¢ã€æ•°æ®ç®¡ç†ç­‰åŠŸèƒ½
 * ç”¨é€”ï¼šåœ¨Homeé¡µé¢ä¸­ä½œä¸ºæ›´å¤šåŠŸèƒ½é¡µé¢æ˜¾ç¤º
 */

import { MoreTabBar } from './MoreTabBar'
import { OmniThemeManager, ExtendedOmniThemeStyle, OmniThemeType } from '../../utils/theme/OmniThemeManager'
import { getCurrentTheme as resolveTheme } from '../../utils/theme/ThemeUtils'
import { OMNI_THEME_KEY, OMNI_THEME_TYPE_KEY, OMNI_THEME_VERSION_KEY } from '../../utils/theme/useOmniTheme'
import { useOmniTheme } from '../../utils/theme/useOmniTheme'
import { OmniUIUtils } from '../../utils/helpers/OmniUIUtils'
import { EngineeringSettingsDialog } from '../../components/dialogs/EngineeringSettingsDialog'
import { I18nManager, t, I18N_VERSION_KEY, I18N_LANGUAGE_KEY } from '../../utils/i18n/I18nManager'
import GlobalStore from '../../database/orm/model/GlobalStore'
import { fileIo as fs } from '@kit.CoreFileKit'
import { buffer } from '@kit.ArkTS'

// è®¾ç½®é¡¹æ¥å£
interface SettingItem {
  icon: string
  title: string
  subtitle: string
  onClick?: () => void
}

// ç¿»è¯‘é¡¹æ¥å£
interface TranslationItem {
  key: string  // æ˜¾ç¤ºæ–‡æœ¬ï¼ˆå½“å‰è¯­è¨€çš„ç¿»è¯‘æˆ–ä¸­æ–‡é”®ï¼‰
  originalKey: string  // åŸå§‹ä¸­æ–‡é”®ï¼ˆç”¨äºä¿å­˜ï¼‰
  value: string  // ç”¨æˆ·ç¼–è¾‘çš„ç¿»è¯‘æ–‡æœ¬
}

// ç¿»è¯‘è®°å½•ç±»å‹
type TranslationRecord = Record<string, string>

@Component
export struct MoreContent {
  @StorageLink(OMNI_THEME_KEY) @Watch('onThemeChange') consumedTheme: ExtendedOmniThemeStyle = OmniThemeManager.getInstance().getCurrentTheme()
  @StorageLink(OMNI_THEME_TYPE_KEY) @Watch('onThemeChange') consumedThemeType: OmniThemeType = OmniThemeManager.getInstance().getCurrentThemeType()
  @StorageLink(OMNI_THEME_VERSION_KEY) @Watch('onThemeChange') themeVersion: number = 0
  @StorageLink(I18N_VERSION_KEY) i18nVersion: number = 0  // ç›‘å¬è¯­è¨€å˜åŒ–ï¼Œè§¦å‘ UI æ›´æ–°
  private omniThemeManager = OmniThemeManager.getInstance()
  private omniUIUtils = OmniUIUtils.getInstance()
  @State showThemeSelector: boolean = false
  @State selectedTheme: OmniThemeType = OmniThemeType.BLUE
  @State showEngineeringSettingsDialog: boolean = false
  @State showLanguageSelector: boolean = false
  @State currentLanguage: string = 'ä¸­æ–‡'
  @State availableLanguages: string[] = []
  @State selectedLanguageTemp: string = 'ä¸­æ–‡'  // ä¸´æ—¶é€‰ä¸­çš„è¯­è¨€ï¼ˆç”¨äºç¡®è®¤ï¼‰
  @State showTranslationEditor: boolean = false
  @State translationFilter: string = ''
  @State newTranslationKey: string = ''
  @State newTranslationValue: string = ''
  @State translations: TranslationItem[] = []
  @State showLanguageNameDialog: boolean = false
  @State languageNameInput: string = ''

  // è®¾ç½®é¡¹é…ç½®ï¼ˆä¾èµ– i18nVersion ç¡®ä¿è¯­è¨€å˜åŒ–æ—¶é‡æ–°è®¡ç®—ï¼‰
  private getSettingItems(): SettingItem[] {
    const _version = this.i18nVersion
    return [
      { icon: 'âš™ï¸', title: 'å·¥ç¨‹è®¾ç½®', subtitle: 'å·¥ç¨‹å‚æ•°é…ç½®', onClick: () => this.showEngineeringSettings() },
      { icon: 'ğŸ“±', title: 'è®¾å¤‡ä¿¡æ¯', subtitle: 'æŸ¥çœ‹è®¾å¤‡è¯¦ç»†ä¿¡æ¯' },
      { icon: 'ğŸ—‘ï¸', title: 'æ•°æ®æ¸…é›¶', subtitle: 'æ¸…ç©ºæ‰€æœ‰æ•°æ®' },
      { icon: 'ğŸ”§', title: 'é…ç½®è®¾ç½®', subtitle: 'ç³»ç»Ÿé…ç½®ç®¡ç†' },
      { icon: 'ğŸ‘¤', title: 'ç”¨æˆ·è®¾ç½®', subtitle: 'ç”¨æˆ·è´¦æˆ·ç®¡ç†' },
      { icon: 'â¬‡ï¸', title: 'ä¸‹è½½é…ç½®', subtitle: 'ä¸‹è½½é…ç½®æ–‡ä»¶' },
      { icon: 'âš ï¸', title: 'æ•…éšœä¿¡æ¯', subtitle: 'æŸ¥çœ‹æ•…éšœè®°å½•' },
      { icon: 'ğŸ”Œ', title: 'ç”µå™¨æ•…éšœè®¾ç½®', subtitle: 'ç”µå™¨æ•…éšœé…ç½®' },
      { icon: 'ğŸ·ï¸', title: 'è´´æ ‡è®¾ç½®', subtitle: 'æ ‡ç­¾æ‰“å°è®¾ç½®' },
      { icon: 'ğŸ› ï¸', title: 'ç³»ç»Ÿæ•…éšœè®¾ç½®', subtitle: 'ç³»ç»Ÿæ•…éšœé…ç½®' },
      { icon: 'ğŸ”„', title: 'å¤ä½æ‰æœæ¯', subtitle: 'é‡ç½®æ‰æœæ¯çŠ¶æ€' }
    ]
  }

  getCurrentTheme(): ExtendedOmniThemeStyle {
    return resolveTheme(this.consumedTheme)
  }

  // ç›‘å¬ä¸»é¢˜å˜åŒ–
  onThemeChange(): void {
    console.log('MoreContent: ä¸»é¢˜å·²å˜åŒ–ï¼Œé‡æ–°æ¸²æŸ“')
    // å¼ºåˆ¶åˆ·æ–°å¼¹çª—çŠ¶æ€ï¼Œç¡®ä¿å¼¹çª—èƒŒæ™¯è‰²ä¹Ÿèƒ½æ›´æ–°
    if (this.showThemeSelector) {
      this.showThemeSelector = false
      // ä½¿ç”¨setTimeoutç¡®ä¿çŠ¶æ€æ›´æ–°åå†é‡æ–°æ˜¾ç¤ºå¼¹çª—
      setTimeout(() => {
        this.showThemeSelector = true
      }, 10)
    }
  }

  // ä¸»é¢˜åˆ‡æ¢å¤„ç†
  private handleThemeChange(theme: OmniThemeType): void {
    const hook = useOmniTheme()
    hook.setTheme(theme)
    const themeName = this.omniThemeManager.getThemeName(theme)
    this.omniUIUtils.showSuccess(`å·²åˆ‡æ¢åˆ°${themeName}`)
  }

  // å·¥ç¨‹è®¾ç½®å¯¹è¯æ¡†å¤„ç†
  private showEngineeringSettings(): void {
    this.showEngineeringSettingsDialog = true
  }

  private handleEngineeringSettingsConfirm(): void {
    this.omniUIUtils.showSuccess(t('å·¥ç¨‹è®¾ç½®å·²ä¿å­˜', 'å·¥ç¨‹è®¾ç½®å·²ä¿å­˜'))
    this.showEngineeringSettingsDialog = false
  }

  private handleEngineeringSettingsCancel(): void {
    this.omniUIUtils.showInfo(t('å·²å–æ¶ˆå·¥ç¨‹è®¾ç½®', 'å·²å–æ¶ˆå·¥ç¨‹è®¾ç½®'))
    this.showEngineeringSettingsDialog = false
  }
  //

  // è¯­è¨€ç¼–è¾‘å…¥å£
  private async openTranslationEditor(): Promise<void> {
    console.log('[MoreContent] openTranslationEditor: start')
    try {
      if (!GlobalStore.context) {
        console.error('[MoreContent] GlobalStore.context is not available')
        this.omniUIUtils.showError(t('ç¿»è¯‘åˆå§‹åŒ–å¤±è´¥ï¼šä¸Šä¸‹æ–‡æœªå°±ç»ª', 'ç¿»è¯‘åˆå§‹åŒ–å¤±è´¥ï¼šä¸Šä¸‹æ–‡æœªå°±ç»ª'))
        return
      }
      const mgr = I18nManager.getInstance()
      if (!mgr.isInitialized()) {
        console.log('[MoreContent] I18nManager not initialized, initializing...')
        await mgr.init(GlobalStore.context)
      }

      // è·å–å½“å‰è¯­è¨€
      const currentLang = mgr.getCurrentLanguage()
      console.log(`[MoreContent] Current language: ${currentLang}`)

      // ä»é»˜è®¤æ¨¡æ¿æ–‡ä»¶åŠ è½½æ‰€æœ‰å­—æ®µï¼ˆä¸­æ–‡é”®ï¼‰
      const appCtx = GlobalStore.context.getApplicationContext?.() ?? GlobalStore.context
      const filesDir = appCtx.filesDir
      const defaultTemplatePath = `${filesDir}/i18n/translations.default.json`
      console.log(`[MoreContent] Loading default template from: ${defaultTemplatePath}`)

      let content: string | undefined = undefined

      // ä¼˜å…ˆè¯»å–æ²™ç®±æ–‡ä»¶
      try {
        const stat = fs.statSync(defaultTemplatePath)
        if (stat.size > 0) {
          const file = fs.openSync(defaultTemplatePath, fs.OpenMode.READ_ONLY)
          const dataBuffer = new ArrayBuffer(stat.size)
          fs.readSync(file.fd, dataBuffer)
          fs.closeSync(file.fd)
          const u8 = new Uint8Array(dataBuffer)
          const buf = buffer.from(u8.buffer)
          content = buf.toString('utf-8')
          console.log(`[MoreContent] Sandbox template size: ${stat.size} bytes`)
        } else {
          console.warn('[MoreContent] Sandbox template empty, fallback to rawfile')
        }
      } catch (e) {
        console.warn(`[MoreContent] Sandbox template missing, fallback to rawfile: ${JSON.stringify(e)}`)
      }

      // å¦‚æœæ²™ç®±ä¸å­˜åœ¨/ä¸ºç©ºï¼Œè¯»å– rawfile å¹¶å†™å›æ²™ç®±
      if (!content) {
        try {
          const rawBytes: Uint8Array = appCtx.resourceManager.getRawFileContentSync('file/translations.default.json')
          const rawBuf = buffer.from(rawBytes.buffer)
          content = rawBuf.toString('utf-8')
          console.log('[MoreContent] Loaded template from rawfile')
          // åŒæ­¥åˆ°æ²™ç®±ï¼Œä¾¿äºåç»­ç¼–è¾‘
          const bufToSave = buffer.from(content, 'utf-8')
          const f = fs.openSync(defaultTemplatePath, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE | fs.OpenMode.TRUNC)
          fs.writeSync(f.fd, bufToSave.buffer)
          fs.closeSync(f.fd)
          console.log('[MoreContent] Synced rawfile template to sandbox')
        } catch (e) {
          console.error(`[MoreContent] Failed to load template from rawfile: ${JSON.stringify(e)}`)
        }
      }

      // åŠ è½½å½“å‰è¯­è¨€çš„ç¿»è¯‘ï¼ˆä½œä¸ºåŸå§‹æ–‡æœ¬ï¼‰
      let currentLangTranslations = new Map<string, string>()
      if (currentLang !== 'ä¸­æ–‡') {
        const currentLangPath = `${filesDir}/i18n/${currentLang}.json`
        console.log(`[MoreContent] Loading current language translations from: ${currentLangPath}`)
        try {
          if (fs.statSync(currentLangPath).size > 0) {
            const file = fs.openSync(currentLangPath, fs.OpenMode.READ_ONLY)
            const stat = fs.statSync(currentLangPath)
            const dataBuffer = new ArrayBuffer(stat.size)
            fs.readSync(file.fd, dataBuffer)
            fs.closeSync(file.fd)
            const u8 = new Uint8Array(dataBuffer)
            const buf = buffer.from(u8.buffer)
            const langContent = buf.toString('utf-8')
            // ä½¿ç”¨ JSON.parse çš„ reviver å‡½æ•°è§£æ JSON åˆ° Map
            JSON.parse(langContent, (key: string, value: string | number | boolean | null): string | number | boolean | null => {
              if (key !== '' && value !== undefined && value !== null) {
                currentLangTranslations.set(key, String(value))
              }
              return value
            })
            console.log(`[MoreContent] Loaded ${currentLangTranslations.size} translations from current language`)
          }
        } catch (e) {
          console.warn(`[MoreContent] Failed to load current language translations: ${JSON.stringify(e)}`)
        }
      }

      let arr: TranslationItem[] = []
      if (content) {
        try {
          // å…ˆè§£æä¸º Map ä»¥ä¾¿è®¿é—®å€¼
          const templateMap = new Map<string, string>()
          JSON.parse(content, (key: string, value: string | number | boolean | null): string | number | boolean | null => {
            if (key !== '' && value !== undefined && value !== null) {
              templateMap.set(key, String(value))
            }
            return value
          })
          
          // éå† Map æ„å»º TranslationItem æ•°ç»„
          templateMap.forEach((val: string, k: string) => {
            // å¦‚æœå½“å‰è¯­è¨€ä¸æ˜¯ä¸­æ–‡ï¼Œä½¿ç”¨å½“å‰è¯­è¨€çš„ç¿»è¯‘ä½œä¸ºæ˜¾ç¤ºæ–‡æœ¬ï¼›å¦åˆ™ä½¿ç”¨ä¸­æ–‡é”®
            const displayText = currentLang !== 'ä¸­æ–‡' && currentLangTranslations.has(k) 
              ? currentLangTranslations.get(k) ?? k 
              : k
            // å¦‚æœå½“å‰è¯­è¨€ä¸æ˜¯ä¸­æ–‡ï¼Œä½¿ç”¨å½“å‰è¯­è¨€çš„ç¿»è¯‘ä½œä¸ºåˆå§‹å€¼ï¼›å¦åˆ™ä½¿ç”¨ç©ºå­—ç¬¦ä¸²
            const initialValue = currentLang !== 'ä¸­æ–‡' && currentLangTranslations.has(k)
              ? currentLangTranslations.get(k) ?? ''
              : ''
            const item: TranslationItem = { key: displayText, originalKey: k, value: initialValue }
            arr.push(item)
          })
          console.log(`[MoreContent] Loaded ${arr.length} template entries`)
        } catch (e) {
          console.error(`[MoreContent] Failed to parse template content: ${JSON.stringify(e)}`)
        }
      } else {
        console.warn('[MoreContent] No template content available, using empty list')
      }

      this.translations = arr
      console.log(`[MoreContent] openTranslationEditor: loaded ${this.translations.length} items`)
      this.showTranslationEditor = true
    } catch (e) {
      console.error('[MoreContent] openTranslationEditor failed', e)
      this.omniUIUtils.showError(t('ç¿»è¯‘åŠ è½½å¤±è´¥', 'ç¿»è¯‘åŠ è½½å¤±è´¥') + ': ' + JSON.stringify(e))
    }
  }

  private updateTranslationKey(index: number, value: string): void {
    if (index < 0 || index >= this.translations.length) return
    const next: TranslationItem[] = [...this.translations]
    const updated: TranslationItem = { key: value, originalKey: next[index].originalKey, value: next[index].value }
    next[index] = updated
    this.translations = next
  }

  private updateTranslationValue(originalKey: string, value: string): void {
    const index = this.translations.findIndex(item => item.originalKey === originalKey)
    if (index === -1) return
    const next: TranslationItem[] = [...this.translations]
    const updated: TranslationItem = { key: next[index].key, originalKey: next[index].originalKey, value }
    next[index] = updated
    this.translations = next
  }

  private removeTranslation(index: number): void {
    if (index < 0 || index >= this.translations.length) return
    const next: TranslationItem[] = [...this.translations]
    next.splice(index, 1)
    this.translations = next
  }

  private addTranslation(): void {
    if (!this.newTranslationKey || this.newTranslationKey.trim().length === 0) {
      this.omniUIUtils.showInfo(t('è¯·è¾“å…¥ç¿»è¯‘é”®', 'è¯·è¾“å…¥ç¿»è¯‘é”®'))
      return
    }
    const next: TranslationItem[] = [...this.translations]
    const item: TranslationItem = { key: this.newTranslationKey.trim(), value: this.newTranslationValue ?? '' }
    next.push(item)
    this.translations = next
    this.newTranslationKey = ''
    this.newTranslationValue = ''
  }

  private filteredTranslations(): TranslationItem[] {
    if (!this.translationFilter || this.translationFilter.trim().length === 0) {
      return this.translations
    }
    const keyword = this.translationFilter.trim().toLowerCase()
    return this.translations.filter((item) => {
      return item.key.toLowerCase().includes(keyword) || 
             item.originalKey.toLowerCase().includes(keyword) || 
             (item.value ?? '').toLowerCase().includes(keyword)
    })
  }

  private async saveTranslations(): Promise<void> {
    console.log('[MoreContent] saveTranslations: opening language name dialog')
    this.languageNameInput = ''
    this.showLanguageNameDialog = true
  }

  private async confirmSaveLanguage(): Promise<void> {
    const langName = this.languageNameInput.trim()
    if (!langName || langName.length === 0) {
      this.omniUIUtils.showInfo(t('è¯·è¾“å…¥è¯­è¨€åç§°', 'è¯·è¾“å…¥è¯­è¨€åç§°'))
      return
    }

    if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(langName)) {
      this.omniUIUtils.showError('è¯­è¨€åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­æ–‡')
      return
    }

    console.log(`[MoreContent] Saving translations as language: ${langName}`)
    this.showLanguageNameDialog = false

    try {
      const mgr = I18nManager.getInstance()
      const map = new Map<string, string>()
      this.translations.forEach((item) => {
        // ä½¿ç”¨ originalKey ä½œä¸ºä¿å­˜çš„é”®ï¼ˆåŸå§‹ä¸­æ–‡é”®ï¼‰
        if (item.originalKey && item.originalKey.trim().length > 0) {
          map.set(item.originalKey.trim(), item.value ?? '')
        }
      })
      console.log(`[MoreContent] Prepared ${map.size} translations to save`)
      
      await mgr.saveLanguage(langName, map)
      this.omniUIUtils.showSuccess(t('ç¿»è¯‘å·²ä¿å­˜ä¸ºï¼š{0}', 'ç¿»è¯‘å·²ä¿å­˜ä¸ºï¼š{0}').replace('{0}', langName))
      this.showTranslationEditor = false
      
      // åˆ·æ–°å¯ç”¨è¯­è¨€åˆ—è¡¨
      await this.refreshAvailableLanguages()
    } catch (e) {
      console.error('[MoreContent] saveTranslations failed', e)
      this.omniUIUtils.showError(t('ä¿å­˜å¤±è´¥', 'ä¿å­˜å¤±è´¥') + ': ' + JSON.stringify(e))
    }
  }

  private async refreshAvailableLanguages(): Promise<void> {
    console.log('[MoreContent] Refreshing available languages')
    try {
      const mgr = I18nManager.getInstance()
      if (!mgr.isInitialized() && GlobalStore.context) {
        await mgr.init(GlobalStore.context)
      }
      const languages = mgr.listLanguageFiles()
      this.availableLanguages = languages
      console.log(`[MoreContent] Available languages: ${JSON.stringify(languages)}`)
    } catch (e) {
      console.error('[MoreContent] Failed to refresh languages:', e)
      this.availableLanguages = []
    }
  }

  @State private selectedTab: string = 'å‡ºå£'

  build() {
    Stack() {
      Column() {
        // TabBar å¯¼èˆªï¼ˆå°è£…ä¸ºç»„ä»¶ï¼‰
        MoreTabBar({ selectedTab: this.selectedTab, onSwitch: (tab: string) => { this.selectedTab = tab } })

        // å†…å®¹åŒºåŸŸ
        Scroll() {
          Column() {
            if (this.selectedTab === 'å‡ºå£') {
              this.buildExportContent()
            } else if (this.selectedTab === 'è®¾ç½®') {
              this.buildSettingsContent()
            } else if (this.selectedTab === 'å¸®åŠ©') {
              this.buildHelpContent()
            }
          }
          .width('100%')
          .backgroundColor(this.getCurrentTheme().pageBg ?? this.getCurrentTheme().backgroundColor)
        }
        .width('100%')
        .layoutWeight(1)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)
        .scrollBarColor(this.getCurrentTheme().borderColor)
        .scrollBarWidth(6)
      }
      .width('100%')
      .height('100%')
      .backgroundColor(this.getCurrentTheme().pageBg ?? this.getCurrentTheme().backgroundColor)

      // ä¸»é¢˜é€‰æ‹©å™¨å¼¹çª— - ä½¿ç”¨Stackç¡®ä¿åœ¨æœ€ä¸Šå±‚
      if (this.showThemeSelector) {
        this.buildThemeSelectorDialog()
      }

      // å·¥ç¨‹è®¾ç½®å¯¹è¯æ¡†
      if (this.showEngineeringSettingsDialog) {
        EngineeringSettingsDialog({
          isVisible: this.showEngineeringSettingsDialog,
          onConfirm: () => {
            this.handleEngineeringSettingsConfirm()
          },
          onCancel: () => {
            this.handleEngineeringSettingsCancel()
          }
        })
      }

      // è¯­è¨€é€‰æ‹©å¼¹çª—
      if (this.showLanguageSelector) {
        this.buildLanguageSelectorDialog()
      }

      // ç¿»è¯‘ç¼–è¾‘å¼¹çª—
      if (this.showTranslationEditor) {
        this.buildTranslationEditorDialog()
      }

      // è¯­è¨€åç§°è¾“å…¥å¯¹è¯æ¡†
      if (this.showLanguageNameDialog) {
        this.buildLanguageNameDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  // æ„å»ºTabæŒ‰é’®
  @Builder
  buildTabButton(title: string, tabKey: string): void {
    Button(title)
      .fontSize(28)  // å­—ä½“è°ƒå¤§åˆ°28pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
      .fontWeight(this.selectedTab === tabKey ? FontWeight.Bold : FontWeight.Normal)
      .fontColor(this.selectedTab === tabKey ? this.getCurrentTheme().primary : this.getCurrentTheme().textColor)
      .backgroundColor(this.selectedTab === tabKey ? this.getCurrentTheme().primary + '20' : Color.Transparent)
      .borderRadius(10)  // åœ†è§’è°ƒå¤§
      .padding({ left: 30, right: 30, top: 16, bottom: 16 })  // å†…è¾¹è·è°ƒå¾—æ›´å¤§
      .onClick(() => {
        this.selectedTab = tabKey
      })
  }

  // æ„å»ºå‡ºå£å†…å®¹
  @Builder
  buildExportContent(): void {
    Column() {
      Text(t('å‡ºå£ç®¡ç†', 'å‡ºå£ç®¡ç†'))
        .fontSize(32)  // å­—ä½“è°ƒå¤§åˆ°32pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .margin({ left: 16, right: 16, bottom: 20 })
        .alignSelf(ItemAlign.Start)

      // å‡ºå£åŠŸèƒ½åˆ—è¡¨
      Column() {
        this.buildExportItem('ğŸ—‘ï¸', 'å‡ºå£æ¸…ç©º', 'æ¸…ç©ºæ‰€æœ‰å‡ºå£æ•°æ®')
        this.buildExportItem('âš¡', 'ç”µç£é˜€æµ‹è¯•', 'ç”µç£é˜€æµ‹è¯•æ§åˆ¶')
        this.buildExportItem('ğŸ”§', 'ç”µæœºä½¿èƒ½', 'ç”µæœºä½¿èƒ½æ§åˆ¶')
        this.buildExportItem('ğŸ”„', 'å¤ä½æœæ¯', 'å¤ä½æœæ¯çŠ¶æ€')
        this.buildExportItem('ğŸ§ª', 'æµ‹è¯•æœæ¯', 'æµ‹è¯•æœæ¯åŠŸèƒ½')
        this.buildExportItem('ğŸ“¦', 'çº¸ç®±è§„æ ¼', 'çº¸ç®±è§„æ ¼è®¾ç½®')
        this.buildExportItem('ğŸ“º', 'å‡ºå£å±æ˜¾ç¤º', 'å‡ºå£å±æ˜¾ç¤ºæ§åˆ¶')
        this.buildExportItem('âš™ï¸', 'å‡ºå£å±è®¾ç½®', 'å‡ºå£å±å‚æ•°è®¾ç½®')
      }
      .width('100%')
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(12)
      .margin({ left: 16, right: 16, bottom: 20 })
      .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetY: 2 })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  // æ„å»ºè®¾ç½®å†…å®¹
  @Builder
  buildSettingsContent(): void {
    Column() {
      Text(t('ç³»ç»Ÿè®¾ç½®', 'ç³»ç»Ÿè®¾ç½®'))
        .fontSize(32)  // å­—ä½“è°ƒå¤§åˆ°32pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .margin({ left: 16, right: 16, bottom: 20 })
        .alignSelf(ItemAlign.Start)

      // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
      this.buildThemeSwitchButton()

      // è®¾ç½®é¡¹åˆ—è¡¨
      Column() {
        ForEach(this.getSettingItems(), (item: SettingItem) => {
          this.buildSettingItem(item.icon, item.title, item.subtitle, item.onClick)
        })
      }
      .width('100%')
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(12)
      .margin({ left: 16, right: 16, bottom: 20 })
      .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetY: 2 })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  // æ„å»ºå¸®åŠ©åŠŸèƒ½é¡¹
  @Builder
  buildHelpItem(icon: string, title: string, subtitle: string, onClick?: () => void): void {
    Row() {
      // å›¾æ ‡
      Text(icon)
        .fontSize(36)  // å›¾æ ‡å­—ä½“è°ƒå¤§åˆ°36pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
        .margin({ right: 16 })

      // æ–‡å­—å†…å®¹
      Column() {
        Text(t(title, title))
          .fontSize(26)  // æ ‡é¢˜å­—ä½“è°ƒå¤§åˆ°26pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
          .fontWeight(FontWeight.Medium)
          .fontColor(this.getCurrentTheme().textColor)
          .alignSelf(ItemAlign.Start)

        Text(t(subtitle, subtitle))
          .fontSize(22)  // å‰¯æ ‡é¢˜å­—ä½“è°ƒå¤§åˆ°22pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
          .fontColor(this.getCurrentTheme().subTextColor)
          .alignSelf(ItemAlign.Start)
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // å³ç®­å¤´
      Text('>')
        .fontSize(26)  // ç®­å¤´å­—ä½“è°ƒå¤§åˆ°26pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
        .fontColor(this.getCurrentTheme().subTextColor)
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16, bottom: 16 })
    .onClick(() => {
      console.log('Help item clicked:', title)
      if (onClick) {
        onClick()
      }
    })

    // åˆ†å‰²çº¿ï¼ˆæœ€åä¸€é¡¹ä¸æ˜¾ç¤ºï¼‰
    Divider()
      .color(this.getCurrentTheme().borderColor)
      .strokeWidth(0.5)
      .margin({ left: 20, right: 20 })
  }

  // æ„å»ºå‡ºå£åŠŸèƒ½é¡¹
  @Builder
  buildExportItem(icon: string, title: string, subtitle: string): void {
    Row() {
      // å›¾æ ‡
      Text(icon)
        .fontSize(36)  // å›¾æ ‡å­—ä½“è°ƒå¤§åˆ°36pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
        .margin({ right: 16 })

      // æ–‡å­—å†…å®¹
      Column() {
        Text(t(title, title))
          .fontSize(26)  // æ ‡é¢˜å­—ä½“è°ƒå¤§åˆ°26pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
          .fontWeight(FontWeight.Medium)
          .fontColor(this.getCurrentTheme().textColor)
          .alignSelf(ItemAlign.Start)

        Text(t(subtitle, subtitle))
          .fontSize(22)  // å‰¯æ ‡é¢˜å­—ä½“è°ƒå¤§åˆ°22pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
          .fontColor(this.getCurrentTheme().subTextColor)
          .alignSelf(ItemAlign.Start)
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // å³ç®­å¤´
      Text('>')
        .fontSize(26)  // ç®­å¤´å­—ä½“è°ƒå¤§åˆ°26pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
        .fontColor(this.getCurrentTheme().subTextColor)
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16, bottom: 16 })
    .onClick(() => {
      console.log('Export item clicked:', title)
      // è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„åŠŸèƒ½å¤„ç†é€»è¾‘
    })

    // åˆ†å‰²çº¿ï¼ˆæœ€åä¸€é¡¹ä¸æ˜¾ç¤ºï¼‰
    Divider()
      .color(this.getCurrentTheme().borderColor)
      .strokeWidth(0.5)
      .margin({ left: 20, right: 20 })
  }

  // æ„å»ºè®¾ç½®é¡¹
  @Builder
  buildSettingItem(icon: string, title: string, subtitle: string, onClick?: () => void): void {
    Row() {
      // å›¾æ ‡
      Text(icon)
        .fontSize(36)  // å›¾æ ‡å­—ä½“è°ƒå¤§åˆ°36pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
        .margin({ right: 16 })

      // æ–‡å­—å†…å®¹
      Column() {
        Text(t(title, title))
          .fontSize(26)  // æ ‡é¢˜å­—ä½“è°ƒå¤§åˆ°26pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
          .fontWeight(FontWeight.Medium)
          .fontColor(this.getCurrentTheme().textColor)
          .alignSelf(ItemAlign.Start)

        Text(t(subtitle, subtitle))
          .fontSize(22)  // å‰¯æ ‡é¢˜å­—ä½“è°ƒå¤§åˆ°22pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
          .fontColor(this.getCurrentTheme().subTextColor)
          .alignSelf(ItemAlign.Start)
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // å³ç®­å¤´
      Text('>')
        .fontSize(26)  // ç®­å¤´å­—ä½“è°ƒå¤§åˆ°26pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
        .fontColor(this.getCurrentTheme().subTextColor)
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16, bottom: 16 })
    .onClick(() => {
      console.log('Setting item clicked:', title)
      if (onClick) {
        onClick()
      }
    })

    // åˆ†å‰²çº¿ï¼ˆæœ€åä¸€é¡¹ä¸æ˜¾ç¤ºï¼‰
    Divider()
      .color(this.getCurrentTheme().borderColor)
      .strokeWidth(0.5)
      .margin({ left: 20, right: 20 })
  }

  // æ„å»ºä¸»é¢˜åˆ‡æ¢æŒ‰é’®
  @Builder
  buildThemeSwitchButton(): void {
    Column() {
      Text(t('ä¸»é¢˜è®¾ç½®', 'ä¸»é¢˜è®¾ç½®'))
        .fontSize(26)  // å­—ä½“è°ƒå¤§åˆ°26pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
        .fontWeight(FontWeight.Medium)
        .fontColor(this.getCurrentTheme().textColor)
        .alignSelf(ItemAlign.Start)
        .margin({ left: 20, bottom: 12, top: 20 })

      // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
      Button() {
        Row() {
          Text('ğŸ¨')
            .fontSize(36)  // å›¾æ ‡å­—ä½“è°ƒå¤§åˆ°36pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
            .margin({ right: 12 })
          
          Column() {
            Text(t('åˆ‡æ¢ä¸»é¢˜', 'åˆ‡æ¢ä¸»é¢˜'))
              .fontSize(26)  // å­—ä½“è°ƒå¤§åˆ°26pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
              .fontWeight(FontWeight.Medium)
              .fontColor('#FFFFFF')
            Text(t('ç‚¹å‡»é€‰æ‹©ä¸»é¢˜é¢œè‰²', 'ç‚¹å‡»é€‰æ‹©ä¸»é¢˜é¢œè‰²'))
              .fontSize(22)  // å­—ä½“è°ƒå¤§åˆ°22pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
              .fontColor('#FFFFFF')
              .opacity(0.8)
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
      }
      .width('100%')
      .height(60)
      .backgroundColor(this.getCurrentTheme().primary)
      .borderRadius(12)
      .margin({ left: 16, right: 16, bottom: 8 })
      .onClick(() => {
        this.selectedTheme = this.consumedThemeType // åˆå§‹åŒ–é€‰ä¸­ä¸»é¢˜ä¸ºå½“å‰ä¸»é¢˜
        this.showThemeSelector = true
      })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  // æ„å»ºä¸»é¢˜é€‰æ‹©å™¨å¼¹çª—
  @Builder
  buildThemeSelectorDialog(): void {
    Stack() {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showThemeSelector = false
        })
      
      // å¼¹çª—å†…å®¹
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Text(t('é€‰æ‹©ä¸»é¢˜', 'é€‰æ‹©ä¸»é¢˜'))
            .fontSize(30)  // å­—ä½“è°ƒå¤§åˆ°30pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getCurrentTheme().textColor)
            .layoutWeight(1)
          
          // å…³é—­æŒ‰é’®
          Button() {
            Text('Ã—')
              .fontSize(30)  // å…³é—­æŒ‰é’®å­—ä½“è°ƒå¤§åˆ°30pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
              .fontColor(this.getCurrentTheme().textColor)
          }
          .width(30)
          .height(30)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showThemeSelector = false
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 15, bottom: 15 })
        .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })
        
        // ä¸»é¢˜é€‰é¡¹ - å¯æ»šåŠ¨
        Scroll() {
          Column() {
            this.buildThemeOption('ğŸ”µ è“è‰²ä¸»é¢˜', OmniThemeType.BLUE)
            this.buildThemeOption('ğŸŸ¢ ç»¿è‰²ä¸»é¢˜', OmniThemeType.GREEN)
            this.buildThemeOption('ğŸŸ£ ç´«è‰²ä¸»é¢˜', OmniThemeType.PURPLE)
            this.buildThemeOption('ğŸŸ  æ©™è‰²ä¸»é¢˜', OmniThemeType.ORANGE)
            this.buildThemeOption('ğŸŒ¸ ç²‰è‰²ä¸»é¢˜', OmniThemeType.PINK)
            this.buildThemeOption('ğŸŒŠ é’è‰²ä¸»é¢˜', OmniThemeType.TEAL)
            this.buildThemeOption('ğŸ’™ å†·é™æ·±è“', OmniThemeType.DEEP_BLUE)
            this.buildThemeOption('ğŸ§¡ æš–è‰²è´¨æ„Ÿ', OmniThemeType.WARM_AMBER)
            this.buildThemeOption('âš« æç®€é»‘ç™½', OmniThemeType.MINIMAL)
            this.buildThemeOption('ğŸŒ¿ æ¸…æ–°ç»¿æ„', OmniThemeType.FRESH_GREEN)
            this.buildThemeOption('ğŸ’œ ä¼˜é›…ç´«è°ƒ', OmniThemeType.ELEGANT_PURPLE)
            this.buildThemeOption('ğŸ¯ ä¸“ä¸šè“è‰²', OmniThemeType.PROFESSIONAL_BLUE)
          }
          .width('100%')
          .padding(20)
        }
        .width('100%')
        .height(400)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)
        
        // åº•éƒ¨æŒ‰é’®
        Row() {
          Button('å–æ¶ˆ')
            .fontSize(26)  // å­—ä½“è°ƒå¤§åˆ°26pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
            .fontColor(this.getCurrentTheme().textColor)
            .backgroundColor(this.getCurrentTheme().backgroundColor)
            .border({ width: 1, color: this.getCurrentTheme().borderColor })
            .borderRadius(10)  // åœ†è§’è°ƒå¤§
            .padding({ left: 30, right: 30, top: 16, bottom: 16 })  // å†…è¾¹è·è°ƒå¾—æ›´å¤§
            .layoutWeight(1)
            .margin({ right: 10 })
            .onClick(() => {
              this.showThemeSelector = false
            })

          Button('ç¡®è®¤')
            .fontSize(26)  // å­—ä½“è°ƒå¤§åˆ°26pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
            .fontColor(Color.White)
            .backgroundColor(this.getCurrentTheme().primary)
            .borderRadius(10)  // åœ†è§’è°ƒå¤§
            .padding({ left: 30, right: 30, top: 16, bottom: 16 })  // å†…è¾¹è·è°ƒå¾—æ›´å¤§
            .layoutWeight(1)
            .margin({ left: 10 })
            .onClick(() => {
              this.handleThemeChange(this.selectedTheme)
              this.showThemeSelector = false
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20, bottom: 20 })
      }
      .width('85%')
      .constraintSize({ maxWidth: 400, maxHeight: 600 })
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(12)
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.1)',
        offsetX: 0,
        offsetY: 4
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
  }
  
  // æ„å»ºä¸»é¢˜é€‰é¡¹
  @Builder
  buildThemeOption(text: string, theme: OmniThemeType): void {
    Row() {
      Text(text)
        .fontSize(26)  // ä¸»é¢˜é€‰é¡¹å­—ä½“è°ƒå¤§åˆ°26pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
        .fontColor(this.getCurrentTheme().textColor)
        .layoutWeight(1)
      
      // å½“å‰é€‰ä¸­ä¸»é¢˜æ ‡è¯†
      if (this.selectedTheme === theme) {
        Text('âœ“')
          .fontSize(26)  // é€‰ä¸­æ ‡è¯†å­—ä½“è°ƒå¤§åˆ°26pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
          .fontColor(this.getCurrentTheme().primary)
          .fontWeight(FontWeight.Bold)
      }
    }
    .width('100%')
    .padding({ top: 12, bottom: 12, left: 16, right: 16 })
    .backgroundColor(this.selectedTheme === theme ? this.getCurrentTheme().primary + '20' : Color.Transparent)
    .borderRadius(8)
    .margin({ bottom: 8 })
    .onClick(() => {
      this.selectedTheme = theme // åªæ›´æ–°é€‰ä¸­çŠ¶æ€ï¼Œä¸ç«‹å³åº”ç”¨ä¸»é¢˜
    })
  }

  // æ„å»ºå¸®åŠ©å†…å®¹
  @Builder
  buildHelpContent(): void {
    Column() {
      Text(t('å¸®åŠ©æ”¯æŒ', 'å¸®åŠ©æ”¯æŒ'))
        .fontSize(32)  // å­—ä½“è°ƒå¤§åˆ°32pxï¼Œæ›´æœ‰æ°”åŠ¿ï¼
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .margin({ left: 16, right: 16, bottom: 20 })
        .alignSelf(ItemAlign.Start)

      // å¸®åŠ©åŠŸèƒ½åˆ—è¡¨
      Column() {
        this.buildHelpItem('ğŸ“–', 'ç”¨æˆ·æ‰‹å†Œ', 'æŸ¥çœ‹ç³»ç»Ÿä½¿ç”¨è¯´æ˜')
        this.buildHelpItem('ğŸ”„', 'æ£€æŸ¥æ–°ç‰ˆæœ¬', 'æ£€æŸ¥ç³»ç»Ÿæ›´æ–°')
        this.buildHelpItem('ğŸ’¾', 'å¤‡ä»½è®¾ç½®', 'å¤‡ä»½å½“å‰ç³»ç»Ÿè®¾ç½®')
        this.buildHelpItem('ğŸ“¥', 'æ¢å¤è®¾ç½®', 'ä»å¤‡ä»½æ¢å¤è®¾ç½®')
        this.buildHelpItem('ğŸ”Œ', 'å…³é—­IPM', 'å…³é—­IPMæœåŠ¡')
        this.buildHelpItem('ğŸ“‹', 'åˆ†é€‰æ—¥å¿—', 'æŸ¥çœ‹åˆ†é€‰æ“ä½œæ—¥å¿—')
        this.buildHelpItem('â„¹ï¸', 'å…³äº', 'æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯')
        this.buildHelpItem('ğŸŒ', 'è¯­è¨€', 'åˆ‡æ¢ç³»ç»Ÿè¯­è¨€', async () => {
          console.log('[MoreContent] Opening language selector')
          // åŒæ­¥å½“å‰è¯­è¨€ï¼ˆä» AppStorage è¯»å–ï¼‰
          const savedLang = AppStorage.get(I18N_LANGUAGE_KEY) as string
          if (savedLang) {
            this.currentLanguage = savedLang
            console.log(`[MoreContent] Synced language to ${savedLang}`)
          }
          await this.refreshAvailableLanguages()
          this.selectedLanguageTemp = this.currentLanguage  // åˆå§‹åŒ–ä¸´æ—¶é€‰ä¸­ä¸ºå½“å‰è¯­è¨€
          this.showLanguageSelector = true
        })
        this.buildHelpItem('âœï¸', 'ç¿»è¯‘ç®¡ç†', 'ç¼–è¾‘è‡ªå®šä¹‰ç¿»è¯‘', () => {
          this.openTranslationEditor()
        })
        this.buildHelpItem('ğŸšª', 'é€€å‡º', 'é€€å‡ºç³»ç»Ÿ')
        this.buildHelpItem('ğŸ‘¤', 'ç”¨æˆ·åˆ‡æ¢', 'åˆ‡æ¢ç”¨æˆ·è´¦æˆ·')
      }
      .width('100%')
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(12)
      .margin({ left: 16, right: 16, bottom: 20 })
      .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetY: 2 })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
  }

  // è¯­è¨€é€‰æ‹©ç›¸å…³æ–¹æ³•
  private selectLanguageTemp(lang: string): void {
    // ä¸´æ—¶é€‰ä¸­è¯­è¨€ï¼ˆä¸ç«‹å³åˆ‡æ¢ï¼‰
    this.selectedLanguageTemp = lang
    console.log(`[MoreContent] Temporarily selected language: ${lang}`)
  }

  private async confirmLanguageSelection(): Promise<void> {
    // ç¡®è®¤é€‰æ‹©è¯­è¨€
    const lang = this.selectedLanguageTemp
    console.log(`[MoreContent] Confirming language selection: ${lang}`)
    this.currentLanguage = lang
    
    try {
      const mgr = I18nManager.getInstance()
      await mgr.setLanguage(lang)
      this.omniUIUtils.showSuccess(`å·²åˆ‡æ¢åˆ°ï¼š${lang}`)
    } catch (e) {
      console.error(`[MoreContent] Failed to set language ${lang}:`, e)
      this.omniUIUtils.showError(`åˆ‡æ¢è¯­è¨€å¤±è´¥: ${JSON.stringify(e)}`)
    }
    
    this.showLanguageSelector = false
  }

  private cancelLanguageSelection(): void {
    // å–æ¶ˆé€‰æ‹©ï¼Œæ¢å¤åŸçŠ¶æ€
    this.selectedLanguageTemp = this.currentLanguage
    this.showLanguageSelector = false
    console.log('[MoreContent] Language selection cancelled')
  }

  // è¯­è¨€é€‰æ‹©å¼¹çª—
  @Builder
  buildLanguageSelectorDialog(): void {
    Stack() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showLanguageSelector = false
        })

      // å†…å®¹
      Column() {
        // æ ‡é¢˜
        Row() {
          Text('ğŸŒ é€‰æ‹©è¯­è¨€')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getCurrentTheme().textColor)
            .layoutWeight(1)

          Button() {
            Text('Ã—')
              .fontSize(28)
              .fontColor(this.getCurrentTheme().textColor)
          }
          .width(32)
          .height(32)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showLanguageSelector = false
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 12 })
        .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })

        // è¯´æ˜
        Text(t('é€‰æ‹©ç•Œé¢æ˜¾ç¤ºè¯­è¨€ã€‚é€‰æ‹©"è‡ªå®šä¹‰"åï¼Œå¯é€šè¿‡"ç¿»è¯‘ç®¡ç†"ç¼–è¾‘ç¿»è¯‘å†…å®¹ã€‚', 'é€‰æ‹©ç•Œé¢æ˜¾ç¤ºè¯­è¨€ã€‚é€‰æ‹©"è‡ªå®šä¹‰"åï¼Œå¯é€šè¿‡"ç¿»è¯‘ç®¡ç†"ç¼–è¾‘ç¿»è¯‘å†…å®¹ã€‚'))
          .fontSize(14)
          .fontColor(this.getCurrentTheme().subTextColor)
          .padding({ left: 20, right: 20, top: 12, bottom: 12 })

        // è¯­è¨€é€‰é¡¹
        Scroll() {
          Column() {
            // ä¸­æ–‡é€‰é¡¹ï¼ˆå›ºå®šï¼‰
            this.buildLanguageOption('ğŸ‡¨ğŸ‡³', t('ä¸­æ–‡', 'ä¸­æ–‡'), t('ä½¿ç”¨åŸå§‹ä¸­æ–‡ç•Œé¢', 'ä½¿ç”¨åŸå§‹ä¸­æ–‡ç•Œé¢'), 'ä¸­æ–‡')
            
            // åŠ¨æ€æ˜¾ç¤ºæ‰«æåˆ°çš„è¯­è¨€æ–‡ä»¶
            ForEach(this.availableLanguages, (lang: string) => {
              this.buildLanguageOption('ğŸ“„', lang, t('ä½¿ç”¨ {0} ç¿»è¯‘', 'ä½¿ç”¨ {0} ç¿»è¯‘').replace('{0}', lang), lang)
            }, (lang: string) => lang)
          }
          .width('100%')
          .padding({ left: 20, right: 20, bottom: 20 })
        }
        .width('100%')
        .height(300)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)

        // åº•éƒ¨æŒ‰é’®
        Row() {
          Button(t('å–æ¶ˆ', 'å–æ¶ˆ'))
            .layoutWeight(1)
            .height(44)
            .borderRadius(10)
            .border({ width: 1, color: this.getCurrentTheme().borderColor })
            .backgroundColor(this.getCurrentTheme().backgroundColor)
            .fontColor(this.getCurrentTheme().textColor)
            .onClick(() => this.cancelLanguageSelection())

          Button(t('ç¡®è®¤', 'ç¡®è®¤'))
            .layoutWeight(1)
            .height(44)
            .margin({ left: 12 })
            .borderRadius(10)
            .backgroundColor(this.getCurrentTheme().primary)
            .fontColor(Color.White)
            .onClick(() => this.confirmLanguageSelection())
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 12, bottom: 16 })
      }
      .width('85%')
      .constraintSize({ maxWidth: 400 })
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(12)
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.1)',
        offsetX: 0,
        offsetY: 4
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
  }

  // æ„å»ºè¯­è¨€é€‰é¡¹
  @Builder
  buildLanguageOption(icon: string, lang: string, desc: string, langValue: string): void {
    Row() {
      Text(icon)
        .fontSize(28)
        .margin({ right: 12 })

      Column() {
        Text(lang)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.getCurrentTheme().textColor)
        Text(desc)
          .fontSize(13)
          .fontColor(this.getCurrentTheme().subTextColor)
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      if (this.selectedLanguageTemp === langValue) {
        Text('âœ“')
          .fontSize(20)
          .fontColor(this.getCurrentTheme().primary)
          .fontWeight(FontWeight.Bold)
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 14, bottom: 14 })
    .backgroundColor(this.selectedLanguageTemp === langValue ? this.getCurrentTheme().primary + '15' : Color.Transparent)
    .borderRadius(10)
    .border({ 
      width: this.selectedLanguageTemp === langValue ? 2 : 1, 
      color: this.selectedLanguageTemp === langValue ? this.getCurrentTheme().primary : this.getCurrentTheme().borderColor 
    })
    .margin({ bottom: 10 })
    .onClick(() => {
      this.selectLanguageTemp(langValue)
    })
  }

  // ç¿»è¯‘ç¼–è¾‘å¼¹çª—
  @Builder
  buildTranslationEditorDialog(): void {
    Stack() {
      // é®ç½© - Apple Designé£æ ¼ï¼Œæ›´æŸ”å’Œçš„èƒŒæ™¯æ¨¡ç³Š
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.4)') // Apple Designæ ‡å‡†é®ç½©é€æ˜åº¦
        .backgroundBlurStyle(BlurStyle.Regular) // å…¨å±æ¨¡ç³ŠèƒŒæ™¯
        .onClick(() => {
          this.showTranslationEditor = false
        })
        .transition(TransitionEffect.OPACITY.animation({ duration: 300, curve: Curve.EaseOut }))

      // å†…å®¹å¡ç‰‡ - ç±»ä¼¼ iPad çš„ Page Sheet é£æ ¼
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ åŒºåŸŸ
        Row() {
          Button(t('å–æ¶ˆ', 'å–æ¶ˆ'))
            .fontSize(17)
            .fontColor(this.getCurrentTheme().primary)
            .backgroundColor(Color.Transparent)
            .onClick(() => { this.showTranslationEditor = false })
          
          Text(t('ç¿»è¯‘ç®¡ç†', 'ç¿»è¯‘ç®¡ç†'))
            .fontSize(17)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getCurrentTheme().textColor)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
          
          Button(t('ä¿å­˜', 'ä¿å­˜'))
            .fontSize(17)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getCurrentTheme().primary)
            .backgroundColor(Color.Transparent)
            .onClick(() => {
              this.saveTranslations()
            })
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .border({ width: { bottom: 0.5 }, color: this.getCurrentTheme().borderColor }) // ç»†åˆ†å‰²çº¿

        // æœç´¢æ åŒºåŸŸ
        Column() {
          Row() {
            Text('ğŸ”')
              .fontSize(16)
              .fontColor('#8E8E93') // iOS ç³»ç»Ÿç°è‰²
              .margin({ right: 6, left: 8 })
            
            TextInput({ placeholder: t('æœç´¢', 'æœç´¢'), text: this.translationFilter })
              .layoutWeight(1)
              .height('100%')
              .fontSize(17)
              .backgroundColor(Color.Transparent)
              .placeholderColor('#8E8E93')
              .caretColor(this.getCurrentTheme().primary)
              .fontColor(this.getCurrentTheme().textColor)
              .onChange((v: string) => { this.translationFilter = v })
              
            if (this.translationFilter) {
               Button() {
                  // iOS é£æ ¼æ¸…é™¤æŒ‰é’®
                  Stack() {
                    Circle({ width: 18, height: 18 }).fill('#8E8E93')
                    Text('Ã—').fontSize(14).fontColor(Color.White).fontWeight(FontWeight.Bold).margin({ bottom: 1 })
                  }.alignContent(Alignment.Center)
               }
               .width(30)
               .height(30)
               .backgroundColor(Color.Transparent)
               .onClick(() => { this.translationFilter = '' })
            }
          }
          .width('100%')
          .height(36) // iOS æœç´¢æ¡†æ ‡å‡†é«˜åº¦
          .backgroundColor('#1F767680') // æµ…ç°è‰²èƒŒæ™¯
          .borderRadius(10)
        }
        .padding({ left: 16, right: 16, top: 10, bottom: 10 })

        // è¡¨å¤´åŒºåŸŸ - Apple Designé£æ ¼ä¼˜åŒ–ç‰ˆ
        Row() {
          // åŸå§‹è¯­è¨€åˆ—æ ‡é¢˜
          Text(t('åŸå§‹è¯­è¨€', 'åŸå§‹è¯­è¨€'))
            .fontSize(13)
            .fontWeight(FontWeight.Medium)
            .fontColor('#8E8E93') // iOSç³»ç»Ÿç°è‰²
            .layoutWeight(1)
            .padding({ left: 16, right: 12 })
          
          // ä¸­é—´åˆ†éš”çº¿
          Divider()
            .vertical(true)
            .strokeWidth(0.5)
            .color('#C6C6C8')
            .height(20)
            .margin({ left: 4, right: 4 })
          
          // ä¿®æ”¹çš„è¯­è¨€åˆ—æ ‡é¢˜
          Text(t('ä¿®æ”¹çš„è¯­è¨€', 'ä¿®æ”¹çš„è¯­è¨€'))
            .fontSize(13)
            .fontWeight(FontWeight.Medium)
            .fontColor('#8E8E93') // iOSç³»ç»Ÿç°è‰²
            .layoutWeight(1.2)
            .padding({ left: 12, right: 16 })
        }
        .width('100%')
        .height(40) // ç¨å¾®å¢åŠ é«˜åº¦ï¼Œæ›´èˆ’é€‚
        .backgroundColor('#F2F2F7') // iOSæµ…ç°èƒŒæ™¯
        .border({ width: { bottom: 0.5 }, color: '#C6C6C8' }) // åº•éƒ¨ç»†åˆ†å‰²çº¿
        .padding({ top: 6, bottom: 6 }) // å‚ç›´å†…è¾¹è·
        .margin({ bottom: 2 }) // ä¸åˆ—è¡¨çš„é—´è·

        // åˆ—è¡¨
        List() {
            ForEach(this.filteredTranslations(), (item: TranslationItem, index: number) => {
              ListItem() {
                Row() {
                  // åŸå§‹æ–‡æœ¬ï¼ˆåªè¯»ï¼‰
                  Text(item.key)
                    .fontSize(17) // æ ‡å‡†æ­£æ–‡å¤§å°
                    .fontColor(this.getCurrentTheme().textColor)
                    .layoutWeight(1)
                    .padding({ right: 12 })
                    .maxLines(3) // å…è®¸æ›´å¤šè¡Œä»¥æ”¯æŒæ¢è¡Œ
                    .textAlign(TextAlign.Start) // å·¦å¯¹é½ï¼Œæ›´æ˜“è¯»

                  // ä¸­é—´åˆ†éš”çº¿
                  Divider()
                    .vertical(true)
                    .strokeWidth(0.5)
                    .color('#E5E5EA') // æ›´æ·¡çš„åˆ†éš”çº¿
                    .height(28)
                    .margin({ left: 4, right: 4 })

                  // ç¿»è¯‘æ–‡æœ¬ï¼ˆå¯ç¼–è¾‘ï¼‰
                  TextInput({ text: item.value, placeholder: t('è¾“å…¥ç¿»è¯‘', 'è¾“å…¥ç¿»è¯‘') })
                    .layoutWeight(1.2) // ç»™è¾“å…¥æ¡†æ›´å¤šç©ºé—´
                    .height(44)
                    .fontSize(17)
                    .textAlign(TextAlign.Start) // æ”¹ä¸ºå·¦å¯¹é½ï¼Œæ›´ç¬¦åˆè¾“å…¥ä¹ æƒ¯
                    .fontColor(this.getCurrentTheme().textColor) // ä½¿ç”¨æ­£å¸¸æ–‡å­—é¢œè‰²
                    .placeholderColor('#C7C7CC')
                    .backgroundColor('#F9F9F9') // æµ…ç°èƒŒæ™¯ï¼ŒåŒºåˆ†å¯ç¼–è¾‘åŒºåŸŸ
                    .borderRadius(8) // åœ†è§’è¾“å…¥æ¡†
                    .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                    .onChange((v: string) => this.updateTranslationValue(item.originalKey, v))
                }
                .width('100%')
                .padding({ top: 14, bottom: 14, right: 16 }) // å¢åŠ å‚ç›´å†…è¾¹è·ï¼Œæ›´èˆ’é€‚
              }
              .padding({ left: 16 })
            }, (item: TranslationItem) => item.key)
        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Auto)
        .divider({ strokeWidth: 0.5, color: '#C6C6C8', startMargin: 16, endMargin: 0 }) // åˆ—è¡¨åˆ†å‰²çº¿
      }
      .width('85%') // ä¸å·¥ç¨‹è®¾ç½®å¯¹è¯æ¡†å®½åº¦ä¸€è‡´
      .height('90%') // ä¸å·¥ç¨‹è®¾ç½®å¯¹è¯æ¡†é«˜åº¦ä¸€è‡´
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(16) // Apple Designé£æ ¼ï¼Œæ›´å¤§çš„åœ†è§’
      .shadow({
        radius: 30,
        color: 'rgba(0, 0, 0, 0.15)',
        offsetX: 0,
        offsetY: 8
      }) // Apple Designé£æ ¼ï¼Œæ›´æŸ”å’Œçš„é˜´å½±
      .transition(TransitionEffect.move(TransitionEdge.BOTTOM).animation({ duration: 350, curve: Curve.EaseOut })) // æ›´æµç•…çš„åŠ¨ç”»
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
    .position({ x: 0, y: 0 })
    .zIndex(4000)
  }

  // è¯­è¨€åç§°è¾“å…¥å¯¹è¯æ¡†
  @Builder
  buildLanguageNameDialog(): void {
    Stack() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showLanguageNameDialog = false
        })

      // å†…å®¹
      Column() {
        // æ ‡é¢˜
        Row() {
          Text('ğŸ’¾ ä¿å­˜ç¿»è¯‘')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getCurrentTheme().textColor)
            .layoutWeight(1)

          Button() {
            Text('Ã—')
              .fontSize(28)
              .fontColor(this.getCurrentTheme().textColor)
          }
          .width(32)
          .height(32)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showLanguageNameDialog = false
          })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 12 })
        .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })

        // è¯´æ˜
        Text(t('è¯·è¾“å…¥è¯­è¨€åç§°ï¼ˆå¦‚ï¼šEnglishã€æ—¥æœ¬èªã€EspaÃ±olï¼‰', 'è¯·è¾“å…¥è¯­è¨€åç§°ï¼ˆå¦‚ï¼šEnglishã€æ—¥æœ¬èªã€EspaÃ±olï¼‰'))
          .fontSize(14)
          .fontColor(this.getCurrentTheme().subTextColor)
          .padding({ left: 20, right: 20, top: 16, bottom: 8 })

        // è¾“å…¥æ¡†
        TextInput({ 
          text: this.languageNameInput, 
          placeholder: t('è¯·è¾“å…¥è¯­è¨€åç§°ï¼ˆå¦‚ï¼šEnglishã€æ—¥æœ¬èªã€EspaÃ±olï¼‰', 'è¯·è¾“å…¥è¯­è¨€åç§°ï¼ˆå¦‚ï¼šEnglishã€æ—¥æœ¬èªã€EspaÃ±olï¼‰') 
        })
          .width('100%')
          .height(44)
          .fontSize(16)
          .margin({ left: 20, right: 20, top: 8, bottom: 20 })
          .backgroundColor(this.getCurrentTheme().backgroundColor)
          .onChange((v: string) => {
            this.languageNameInput = v
          })

        // åº•éƒ¨æŒ‰é’®
        Row() {
          Button('å–æ¶ˆ')
            .layoutWeight(1)
            .height(44)
            .borderRadius(10)
            .border({ width: 1, color: this.getCurrentTheme().borderColor })
            .backgroundColor(this.getCurrentTheme().backgroundColor)
            .fontColor(this.getCurrentTheme().textColor)
            .onClick(() => {
              this.showLanguageNameDialog = false
            })

          Button('ä¿å­˜')
            .layoutWeight(1)
            .height(44)
            .margin({ left: 12 })
            .borderRadius(10)
            .backgroundColor(this.getCurrentTheme().primary)
            .fontColor(Color.White)
            .onClick(() => this.confirmSaveLanguage())
        }
        .width('100%')
        .padding({ left: 20, right: 20, bottom: 16 })
      }
      .width('85%')
      .constraintSize({ maxWidth: 400 })
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(12)
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.1)',
        offsetX: 0,
        offsetY: 4
      })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
    .position({ x: 0, y: 0 })
    .zIndex(5000)
  }
}