/**
 * å®æ—¶ç»Ÿè®¡é¡µé¢å†…å®¹ç»„ä»¶
 * åŠŸèƒ½ï¼šæ˜¾ç¤ºå¤šç§ç±»å‹çš„å®æ—¶ç»Ÿè®¡å›¾è¡¨
 * ç”¨é€”ï¼šåœ¨Homeé¡µé¢ä¸­ä½œä¸ºå®æ—¶ç»Ÿè®¡é¡µé¢æ˜¾ç¤º
 */

import { BaseComponentHelper } from '../../components/common/BaseComponent'
import { OmniThemeManager, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { McBarChart, Options } from '@mcui/mccharts'
import { ProcessingCurveChart } from '../../components/charts/ProcessingCurveChart'
import { CustomPieChart, PieChartsOptions, PieChartsData } from '../../components/charts/CustomPieChart'

// é¥¼å›¾æ•°æ®ç±»
class PieData implements PieChartsData {
  constructor(public value: number) {}
  getValue(): number {
    return this.value
  }
}

@Component
export struct RealtimeStatsContent {
  @StorageLink('OMNI_THEME_VERSION_KEY') private themeVersion: number = 0
  private baseComponentHelper = new BaseComponentHelper()

  // é¥¼å›¾æ•°æ®çŠ¶æ€
  @State private pieData: PieData[] = [
    new PieData(35), // ä¼˜è´¨
    new PieData(30), // è‰¯å¥½
    new PieData(25), // ä¸€èˆ¬
    new PieData(10)  // è¾ƒå·®
  ]
  
  @State private pieLabels: string[] = ['ä¼˜è´¨', 'è‰¯å¥½', 'ä¸€èˆ¬', 'è¾ƒå·®']
  @State private pieColors: string[] = ['#00B894', '#00CEC9', '#FDCB6E', '#E17055']
  
  // å“è´¨ç»Ÿè®¡æ•°æ®
  @State private qualityData: number[] = [120, 200, 150, 80, 50]
  
  
  // å‡ºå£äº§é‡æ•°æ®
  @State private outletData: number[] = [120, 200, 150, 80, 70, 90, 110, 95]
  
  // å®šæ—¶å™¨
  private pieTimerId: number | null = null
  private qualityTimerId: number | null = null
  private outletTimerId: number | null = null

  getCurrentTheme(): ExtendedOmniThemeStyle {
    return this.baseComponentHelper.getCurrentTheme()
  }

  // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨æ•°æ®
  private initializeAllData() {
    console.log('ğŸš€ åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨æ•°æ®...')
    
    // å¯åŠ¨é¥¼å›¾æ•°æ®æ›´æ–°ï¼ˆæ¯5ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
    if (!this.pieTimerId) {
      this.pieTimerId = setInterval(() => {
        console.log('ğŸ”„ æ›´æ–°é¥¼å›¾æ•°æ®...')
        
        // æ›´æ–°é¥¼å›¾æ•°æ®ï¼ˆæ¨¡æ‹Ÿæ•°æ®å˜åŒ–ï¼‰
        const newPieData = [...this.pieData]
        for (let i = 0; i < newPieData.length; i++) {
          const variation = (Math.random() - 0.5) * 10 // -5 åˆ° +5 çš„éšæœºå˜åŒ–
          newPieData[i] = new PieData(Math.max(5, Math.min(50, newPieData[i].getValue() + variation)))
        }
        this.pieData = newPieData
        console.log('ğŸ“Š é¥¼å›¾æ•°æ®æ›´æ–°:', this.pieData.map(d => d.getValue()))
      }, 5000) as number
    }
    
    // å¯åŠ¨å“è´¨ç»Ÿè®¡æ•°æ®æ›´æ–°ï¼ˆæ¯3ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
    if (!this.qualityTimerId) {
      this.qualityTimerId = setInterval(() => {
        console.log('ğŸ”„ æ›´æ–°å“è´¨ç»Ÿè®¡æ•°æ®...')
        
        // æ›´æ–°å“è´¨ç»Ÿè®¡æ•°æ®
        const newQualityData = [...this.qualityData]
        for (let i = 0; i < newQualityData.length; i++) {
          const variation = (Math.random() - 0.5) * 20 // -10 åˆ° +10 çš„éšæœºå˜åŒ–
          newQualityData[i] = Math.max(50, Math.min(300, newQualityData[i] + variation))
        }
        this.qualityData = newQualityData
        console.log('ğŸ“Š å“è´¨ç»Ÿè®¡æ•°æ®æ›´æ–°:', this.qualityData)
      }, 3000) as number
    }
    
    
    // å¯åŠ¨å‡ºå£äº§é‡æ•°æ®æ›´æ–°ï¼ˆæ¯4ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
    if (!this.outletTimerId) {
      this.outletTimerId = setInterval(() => {
        console.log('ğŸ”„ æ›´æ–°å‡ºå£äº§é‡æ•°æ®...')
        
        // æ›´æ–°å‡ºå£äº§é‡æ•°æ®
        const newOutletData = [...this.outletData]
        for (let i = 0; i < newOutletData.length; i++) {
          const variation = (Math.random() - 0.5) * 30 // -15 åˆ° +15 çš„éšæœºå˜åŒ–
          newOutletData[i] = Math.max(50, Math.min(250, newOutletData[i] + variation))
        }
        this.outletData = newOutletData
        console.log('ğŸ“Š å‡ºå£äº§é‡æ•°æ®æ›´æ–°:', this.outletData)
      }, 4000) as number
    }
  }

  // åœæ­¢æ‰€æœ‰å®šæ—¶å™¨
  private stopAllTimers() {
    if (this.pieTimerId) {
      clearInterval(this.pieTimerId)
      this.pieTimerId = null
    }
    if (this.qualityTimerId) {
      clearInterval(this.qualityTimerId)
      this.qualityTimerId = null
    }
    if (this.outletTimerId) {
      clearInterval(this.outletTimerId)
      this.outletTimerId = null
    }
  }

  // ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ
  aboutToAppear() {
    this.initializeAllData()
  }

  aboutToDisappear() {
    this.stopAllTimers()
  }

  build() {
    Scroll() {
      Column() {
        // é¡µé¢æ ‡é¢˜
        Text('å®æ—¶ç»Ÿè®¡')
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getCurrentTheme().textColor)
          .margin({ top: 20, bottom: 20 })
          .alignSelf(ItemAlign.Center)

        // ç¬¬ä¸€è¡Œï¼šæŠ˜çº¿å›¾ + æŸ±çŠ¶å›¾
        Row() {
          // ä½¿ç”¨å°è£…å¥½çš„åŠ å·¥æ›²çº¿å›¾ç»„ä»¶
          ProcessingCurveChart({
            title: 'åŠ å·¥è¿›åº¦è¶‹åŠ¿',
            chartHeight: 200,
            chartWidth: '100%'
          })
          .width('48%')
          .height(280)
          .padding(16)
          .backgroundColor(this.getCurrentTheme().surfaceColor)
          .borderRadius(12)
          .border({ width: 1, color: this.getCurrentTheme().borderColor })
          .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetY: 2 })

          // å“è´¨ç»Ÿè®¡æŸ±çŠ¶å›¾å¡ç‰‡
          Column() {
            Text('å“è´¨ç»Ÿè®¡')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.getCurrentTheme().textColor)
              .margin({ bottom: 12 })
            
            McBarChart({
              options: new Options({
                title: {
                  show: true,
                  text: 'å“è´¨ç­‰çº§ç»Ÿè®¡',
                  left: 'center',
                  top: 10,
                  textStyle: {
                    fontSize: 16,
                    color: this.getCurrentTheme().textColor
                  }
                },
                xAxis: {
                  type: 'category',
                  data: ['Açº§', 'Bçº§', 'Cçº§', 'Dçº§', 'Eçº§']
                },
                yAxis: {
                  type: 'value',
                  name: 'æ•°é‡(ä¸ª)'
                },
                series: [{
                  name: 'å“è´¨ç»Ÿè®¡',
                  type: 'bar',
                  data: this.qualityData,
                  itemStyle: {
                    color: this.getCurrentTheme().primary
                  }
                }]
              })
            })
            .width('100%')
            .height(200)
          }
          .width('48%')
          .height(280)
          .padding(16)
          .backgroundColor(this.getCurrentTheme().surfaceColor)
          .borderRadius(12)
          .border({ width: 1, color: this.getCurrentTheme().borderColor })
          .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetY: 2 })
          .margin({ left: 16 })
        }
        .width('100%')
        .margin({ bottom: 20 })

        // ç¬¬äºŒè¡Œï¼šå¤–è§‚å“è´¨é¥¼å›¾ + æŠ˜çº¿å›¾
        Row() {
          // è‡ªå®šä¹‰é¥¼å›¾ç»„ä»¶
          Column() {
            Text('å¤–è§‚å“è´¨ç»Ÿè®¡')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.getCurrentTheme().textColor)
              .margin({ bottom: 12 })
            
            CustomPieChart({
              options: new PieChartsOptions({
                radius: 60,
                innerRadius: 0,
                data: this.pieData,
                animate: true,
                duration: 1000,
                labelFn: (data: PieChartsData, index: number) => {
                  return `${this.pieLabels[index]} ${data.getValue()}%`
                },
                labelStyleFn: (data: PieChartsData, index: number) => {
                  return {
                    fontSize: 12,
                    fontColor: this.pieColors[index]
                  }
                },
                colorFn: (data: PieChartsData, index: number) => {
                  return this.pieColors[index]
                },
                leaderLineColorFn: (data: PieChartsData, index: number) => {
                  return this.pieColors[index]
                }
              })
            })
            .width('100%')
            .height(200)
          }
          .width('48%')
          .height(280)
          .padding(16)
          .backgroundColor(this.getCurrentTheme().surfaceColor)
          .borderRadius(12)
          .border({ width: 1, color: this.getCurrentTheme().borderColor })
          .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetY: 2 })

          // æ¸©åº¦ç›‘æ§æŠ˜çº¿å›¾
          ProcessingCurveChart({
            title: 'æ¸©åº¦ç›‘æ§',
            chartHeight: 200,
            chartWidth: '100%'
          })
          .width('48%')
          .height(280)
          .padding(16)
          .backgroundColor(this.getCurrentTheme().surfaceColor)
          .borderRadius(12)
          .border({ width: 1, color: this.getCurrentTheme().borderColor })
          .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetY: 2 })
          .margin({ left: 16 })
        }
        .width('100%')
        .margin({ bottom: 20 })

        // ç¬¬ä¸‰è¡Œï¼šæŸ±çŠ¶å›¾ï¼ˆå…¨å®½ï¼‰
        Column() {
          Text('å‡ºå£äº§é‡å¯¹æ¯”')
            .fontSize(20)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.getCurrentTheme().textColor)
            .margin({ bottom: 12 })
          
          McBarChart({
            options: new Options({
              title: {
                show: true,
                text: 'å„å‡ºå£äº§é‡ç»Ÿè®¡',
                left: 'center',
                top: 10,
                textStyle: {
                  fontSize: 16,
                  color: this.getCurrentTheme().textColor
                }
              },
              xAxis: {
                type: 'category',
                data: ['å‡ºå£1', 'å‡ºå£2', 'å‡ºå£3', 'å‡ºå£4', 'å‡ºå£5', 'å‡ºå£6', 'å‡ºå£7', 'å‡ºå£8']
              },
              yAxis: {
                type: 'value',
                name: 'äº§é‡(kg)'
              },
              series: [{
                name: 'äº§é‡',
                type: 'bar',
                data: this.outletData,
                itemStyle: {
                  color: this.getCurrentTheme().primary
                }
              }]
            })
          })
          .width('100%')
          .height(250)
        }
        .width('100%')
        .height(320)
        .padding(16)
        .backgroundColor(this.getCurrentTheme().surfaceColor)
        .borderRadius(12)
        .border({ width: 1, color: this.getCurrentTheme().borderColor })
        .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetY: 2 })
        .margin({ bottom: 20 })
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 20 })
    }
    .width('100%')
    .height('100%')
    .scrollable(ScrollDirection.Vertical)
    .scrollBar(BarState.Auto)
    .scrollBarColor(this.getCurrentTheme().borderColor)
    .scrollBarWidth(6)
  }
}

