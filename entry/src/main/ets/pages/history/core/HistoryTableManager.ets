/**
 * å†å²è¡¨æ ¼æ•°æ®ç®¡ç†å™¨
 * è´Ÿè´£è¡¨æ ¼æ•°æ®çš„å¢åˆ æ”¹æŸ¥æ“ä½œ
 * å·²æ”¹ä¸ºä»æ•°æ®åº“è¯»å–æ•°æ®
 */

import { GetIBestORM } from '../../../database/orm';
import { DateValidationUtils } from '../../../utils/helpers/DateValidationUtils'
import { ProcessingHistory } from '../../../database/models/ProcessingHistory'
import { ProcessingHistoryData } from '../../../database/types'

// è¡¨æ ¼æ•°æ®æ¥å£å®šä¹‰
export interface HistoryTableData {
  id: number
  customerName: string
  farmName: string
  fruitName: string
  status: 'å·²å®Œæˆ' | 'è¿›è¡Œä¸­' | 'å¾…å¼€å§‹'
  startTime: string
  endTime: string
  weight: number
  count: number
}

// æ·»åŠ æ•°æ®çš„æ¥å£
export interface AddDataParams {
  customerName: string
  farmName: string
  fruitName: string
  status: 'å·²å®Œæˆ' | 'è¿›è¡Œä¸­' | 'å¾…å¼€å§‹'
  startTime: string
  endTime: string
  weight: number
  count: number
}

// æ›´æ–°æ•°æ®çš„æ¥å£
export interface UpdateDataParams {
  customerName?: string
  farmName?: string
  fruitName?: string
  status?: 'å·²å®Œæˆ' | 'è¿›è¡Œä¸­' | 'å¾…å¼€å§‹'
  startTime?: string
  endTime?: string
  weight?: number
  count?: number
}

// ç­›é€‰å‚æ•°æ¥å£
export interface FilterParams {
  startDate?: string
  endDate?: string
  customerName?: string
  farmName?: string
  fruitName?: string
  status?: 'å·²å®Œæˆ' | 'è¿›è¡Œä¸­' | 'å¾…å¼€å§‹'
}

/**
 * å†å²è¡¨æ ¼æ•°æ®ç®¡ç†å™¨
 * ä»æ•°æ®åº“è¯»å–æ•°æ®
 */
export class HistoryTableManager {
  private static instance: HistoryTableManager
  private tableData: HistoryTableData[] = []
  private dataLoaded: boolean = false

  private constructor() {
    // ä¸å†åˆå§‹åŒ–é»˜è®¤æ•°æ®ï¼Œæ”¹ä¸ºä»æ•°æ®åº“åŠ è½½
  }

  public static getInstance(): HistoryTableManager {
    if (!HistoryTableManager.instance) {
      HistoryTableManager.instance = new HistoryTableManager()
    }
    return HistoryTableManager.instance
  }

  /**
   * ä»æ•°æ®åº“åŠ è½½æ•°æ®
   */
  public async loadDataFromDatabase(): Promise<void> {
    try {
      const db = GetIBestORM();
      // æ€§èƒ½ç›‘æ§ï¼šè®°å½•å¼€å§‹æ—¶é—´
      const startTime = Date.now();
      
      // æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼ˆåŒæ­¥æ“ä½œï¼Œä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼‰
      const dbRecords = db.Table("processing_history").Find(ProcessingHistory) as ProcessingHistoryData[];
      
      // æ€§èƒ½ç›‘æ§ï¼šè®°å½•æŸ¥è¯¢è€—æ—¶
      const queryTime = Date.now() - startTime;
      if (queryTime > 100) {
        console.warn(`âš ï¸ æ•°æ®åº“æŸ¥è¯¢è€—æ—¶è¾ƒé•¿: ${queryTime}msï¼ŒæŸ¥è¯¢åˆ° ${dbRecords ? dbRecords.length : 0} æ¡è®°å½•`);
      }
      
      // æ€§èƒ½ç›‘æ§ï¼šè®°å½•æ•°æ®è½¬æ¢å¼€å§‹æ—¶é—´
      const convertStartTime = Date.now();
      
      // æ•°æ®è½¬æ¢ï¼ˆå­—æ®µè¶Šå¤šï¼Œè¿™é‡Œè€—æ—¶è¶Šé•¿ï¼‰
      this.tableData = dbRecords.map((record: ProcessingHistoryData): HistoryTableData => {
        // å¤„ç† ID å­—æ®µï¼šæŸ¥è¯¢è¿”å›çš„æ˜¯ IDï¼ˆå¤§å†™ï¼‰ï¼Œä½†æ¥å£æœŸæœ› idï¼ˆå°å†™ï¼‰
        const recordId = record.ID || record.id || 0;
        const historyData: HistoryTableData = {
          id: recordId,
          customerName: record.CustomerName || '',
          farmName: record.FarmName || '',
          fruitName: record.FruitName || '',
          status: (record.Status as 'å·²å®Œæˆ' | 'è¿›è¡Œä¸­' | 'å¾…å¼€å§‹') || 'å¾…å¼€å§‹',
          startTime: record.StartTime || '',
          endTime: record.EndTime || '',
          weight: record.Weight || 0,
          count: record.Quantity || 0
        }
        return historyData
      })
      
      // æ€§èƒ½ç›‘æ§ï¼šè®°å½•æ€»è€—æ—¶
      const totalTime = Date.now() - startTime;
      const convertTime = Date.now() - convertStartTime;
      
      if (totalTime > 100) {
        console.warn(`âš ï¸ æ•°æ®åŠ è½½æ€»è€—æ—¶: ${totalTime}ms (æŸ¥è¯¢: ${queryTime}ms, è½¬æ¢: ${convertTime}ms), è®°å½•æ•°: ${this.tableData.length}`);
        console.warn(`ğŸ’¡ æç¤º: å¦‚æœå­—æ®µæ•°é‡å¾ˆå¤šï¼Œå»ºè®®ä¼˜åŒ–å­—æ®µæ˜ å°„é€»è¾‘æˆ–ä½¿ç”¨å¼‚æ­¥åŠ è½½`);
      }
      
      this.dataLoaded = true
    } catch (error) {
      console.error('âŒ ä»æ•°æ®åº“åŠ è½½å†å²åŠ å·¥æ•°æ®å¤±è´¥:', error)
      this.tableData = []
      this.dataLoaded = true
    }
  }


  /**
   * æ·»åŠ æ•°æ®ï¼ˆä¿å­˜åˆ°æ•°æ®åº“ï¼‰
   */
  async addData(data: AddDataParams): Promise<void> {
    try {
      const db = GetIBestORM();
      const historyRecord = new ProcessingHistory(
        data.customerName,
        data.farmName,
        data.fruitName,
        data.status,
        data.startTime,
        data.endTime,
        data.weight,
        data.count
      )
      await db.Create(historyRecord)
      await this.loadDataFromDatabase()
    } catch (error) {
      console.error('âŒ æ·»åŠ æ•°æ®åˆ°æ•°æ®åº“å¤±è´¥:', error)
      const err = error as object
      throw new Error(JSON.stringify(err))
    }
  }

  /**
   * åˆ é™¤æ•°æ®ï¼ˆä»æ•°æ®åº“åˆ é™¤ï¼‰
   */
  async deleteData(id: number): Promise<void> {
    try {
      const db = GetIBestORM();
      db.Table("processing_history").Where('id', id).Delete()
      await this.loadDataFromDatabase()
    } catch (error) {
      console.error('âŒ ä»æ•°æ®åº“åˆ é™¤æ•°æ®å¤±è´¥:', error)
      const err = error as object
      throw new Error(JSON.stringify(err))
    }
  }

  /**
   * æ›´æ–°æ•°æ®ï¼ˆä¿å­˜åˆ°æ•°æ®åº“ï¼‰
   */
  async updateData(id: number, newData: UpdateDataParams): Promise<void> {
    try {
      const currentData = this.tableData.find(item => item.id === id)
      if (!currentData) {
        throw new Error(`æœªæ‰¾åˆ°è¦æ›´æ–°çš„æ•°æ®ï¼ŒID: ${id}`)
      }
      const db = GetIBestORM();
      const updatedRecord = new ProcessingHistory(
        newData.customerName !== undefined ? newData.customerName : currentData.customerName,
        newData.farmName !== undefined ? newData.farmName : currentData.farmName,
        newData.fruitName !== undefined ? newData.fruitName : currentData.fruitName,
        newData.status !== undefined ? newData.status : currentData.status,
        newData.startTime !== undefined ? newData.startTime : currentData.startTime,
        newData.endTime !== undefined ? newData.endTime : currentData.endTime,
        newData.weight !== undefined ? newData.weight : currentData.weight,
        newData.count !== undefined ? newData.count : currentData.count
      );
      updatedRecord.ID = id;
      db.Save(updatedRecord);
      await this.loadDataFromDatabase()
    } catch (error) {
      console.error('âŒ æ›´æ–°æ•°æ®åº“æ•°æ®å¤±è´¥:', error)
      const err = error as object
      throw new Error(JSON.stringify(err))
    }
  }

  /**
   * è·å–æ‰€æœ‰æ•°æ®ï¼ˆå¦‚æœæœªåŠ è½½åˆ™å…ˆåŠ è½½ï¼‰
   */
  async getData(): Promise<HistoryTableData[]> {
    if (!this.dataLoaded) {
      await this.loadDataFromDatabase()
    }
    return this.tableData.slice()
  }
  
  /**
   * åŒæ­¥è·å–æ‰€æœ‰æ•°æ®ï¼ˆä¸è§¦å‘åŠ è½½ï¼Œè¿”å›å½“å‰ç¼“å­˜ï¼‰
   */
  getDataSync(): HistoryTableData[] {
    return this.tableData.slice()
  }

  /**
   * æ ¹æ®IDè·å–æ•°æ®
   */
  getDataById(id: number): HistoryTableData | undefined {
    return this.tableData.find(item => item.id === id)
  }

  /**
   * æ¸…ç©ºæ‰€æœ‰æ•°æ®
   */
  clearData(): void {
    this.tableData = []
    console.log('æ¸…ç©ºæ‰€æœ‰æ•°æ®')
  }

  /**
   * æ ¹æ®çŠ¶æ€ç­›é€‰æ•°æ®
   */
  getDataByStatus(status: 'å·²å®Œæˆ' | 'è¿›è¡Œä¸­' | 'å¾…å¼€å§‹'): HistoryTableData[] {
    return this.tableData.filter(item => item.status === status)
  }

  /**
   * æ ¹æ®å®¢æˆ·åç§°ç­›é€‰æ•°æ®
   */
  getDataByCustomer(customerName: string): HistoryTableData[] {
    return this.tableData.filter(item => item.customerName === customerName)
  }

  /**
   * æ ¹æ®å¤šä¸ªæ¡ä»¶ç­›é€‰æ•°æ®
   */
  filterData(filters: FilterParams): HistoryTableData[] {
    let filteredData = [...this.tableData]
    
    // æ—¥æœŸèŒƒå›´ç­›é€‰ï¼šè¦æ±‚è®°å½•çš„å¼€å§‹ä¸ç»“æŸéƒ½è½åœ¨åŒºé—´å†…ï¼ˆä¸¥æ ¼åŒºé—´ï¼‰
    if (filters.startDate || filters.endDate) {
      filteredData = filteredData.filter(item => {
        if (!item.startTime) return false
        
        // ä½¿ç”¨å·¥å…·ç±»æå–å’ŒéªŒè¯æ—¥æœŸéƒ¨åˆ†
        const itemStartDate = DateValidationUtils.extractDatePart(item.startTime)
        if (!DateValidationUtils.isValidDateFormat(itemStartDate)) {
          console.warn('æ— æ•ˆçš„å¼€å§‹æ—¥æœŸæ ¼å¼:', item.startTime)
          return false
        }
        
        // å¤„ç†ç»“æŸæ—¥æœŸï¼šå¦‚æœ endTime å­˜åœ¨ä¸”ä¸æ˜¯ '-'ï¼Œåˆ™ä½¿ç”¨ endTime
        // å¦‚æœ endTime æ˜¯ '-' æˆ–ç©ºï¼Œè¯´æ˜è®°å½•è¿˜åœ¨è¿›è¡Œä¸­ï¼Œä½¿ç”¨ä¸€ä¸ªå¾ˆå¤§çš„æ—¥æœŸ
        let itemEndDate = itemStartDate
        if (item.endTime && item.endTime !== '-' && item.endTime.trim() !== '') {
          const endDateStr = DateValidationUtils.extractDatePart(item.endTime)
          if (DateValidationUtils.isValidDateFormat(endDateStr)) {
            itemEndDate = endDateStr
          } else {
            console.warn('æ— æ•ˆçš„ç»“æŸæ—¥æœŸæ ¼å¼:', item.endTime)
            // å¦‚æœç»“æŸæ—¥æœŸæ ¼å¼æ— æ•ˆï¼Œä½¿ç”¨å¼€å§‹æ—¥æœŸ
            itemEndDate = itemStartDate
          }
        } else {
          // å¦‚æœ endTime æ˜¯ '-'ï¼Œè¡¨ç¤ºè¿˜åœ¨è¿›è¡Œä¸­ï¼Œä½¿ç”¨ä¸€ä¸ªå¾ˆå¤§çš„æ—¥æœŸç¡®ä¿åŒ…å«æ‰€æœ‰æœªæ¥æ—¥æœŸ
          itemEndDate = '9999-12-31'
        }
        
        // æŸ¥è¯¢åŒºé—´ï¼ˆDatePickerHelperè¿”å›çš„æ˜¯ YYYY-MM-DD æ ¼å¼ï¼‰
        let queryStartDate = '1970-01-01'
        if (filters.startDate) {
          const extracted = DateValidationUtils.extractDatePart(filters.startDate)
          if (DateValidationUtils.isValidDateFormat(extracted)) {
            queryStartDate = extracted
          } else {
            console.warn('æ— æ•ˆçš„æŸ¥è¯¢å¼€å§‹æ—¥æœŸæ ¼å¼:', filters.startDate)
            queryStartDate = '1970-01-01'
          }
        }
        
        let queryEndDate = '9999-12-31'
        if (filters.endDate) {
          const extracted = DateValidationUtils.extractDatePart(filters.endDate)
          if (DateValidationUtils.isValidDateFormat(extracted)) {
            queryEndDate = extracted
          } else {
            console.warn('æ— æ•ˆçš„æŸ¥è¯¢ç»“æŸæ—¥æœŸæ ¼å¼:', filters.endDate)
            queryEndDate = '9999-12-31'
          }
        }
        
        // ä¸¥æ ¼åŒºé—´è§„åˆ™ï¼š
        // - å½“ start å’Œ end éƒ½æä¾›æ—¶ï¼šè¦æ±‚ itemStart ä¸ itemEnd éƒ½åœ¨ [queryStartDate, queryEndDate] å†…
        // - ä»…æä¾› start æ—¶ï¼šè¦æ±‚ itemStart ä¸ itemEnd éƒ½ >= queryStartDate
        // - ä»…æä¾› end æ—¶ï¼šè¦æ±‚ itemStart ä¸ itemEnd éƒ½ <= queryEndDate
        const startInRange = itemStartDate >= queryStartDate && itemStartDate <= queryEndDate
        const endInRange = itemEndDate >= queryStartDate && itemEndDate <= queryEndDate

        let shouldShow = false
        const hasQueryStart = !!filters.startDate
        const hasQueryEnd = !!filters.endDate
        if (hasQueryStart && hasQueryEnd) {
          shouldShow = startInRange && endInRange
        } else if (hasQueryStart) {
          shouldShow = itemStartDate >= queryStartDate && itemEndDate >= queryStartDate
        } else if (hasQueryEnd) {
          shouldShow = itemStartDate <= queryEndDate && itemEndDate <= queryEndDate
        }

        if (shouldShow) {
          console.log(`æ—¥æœŸåŒ¹é…(ä¸¥æ ¼åŒºé—´): è®°å½•[${itemStartDate} ~ ${itemEndDate}]`)
        }
        return shouldShow
      })
    }
    
    // å®¢æˆ·åç§°ç­›é€‰ï¼ˆç²¾ç¡®åŒ¹é…ï¼Œå»é™¤å‰åç©ºæ ¼ï¼Œå¤§å°å†™æ•æ„ŸæŒ‰åŸæ ·ã€‚è‹¥éœ€å¿½ç•¥å¤§å°å†™ï¼Œå¯æ”¹ä¸º toLowerCase æ¯”è¾ƒï¼‰
    if (filters.customerName && filters.customerName.trim().length > 0) {
      const target = filters.customerName.trim()
      filteredData = filteredData.filter(item => (item.customerName || '').trim() === target)
    }
    
    // å†œåœºåç§°ç­›é€‰ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
    if (filters.farmName && filters.farmName.trim().length > 0) {
      const target = filters.farmName.trim()
      filteredData = filteredData.filter(item => (item.farmName || '').trim() === target)
    }
    
    // æ°´æœåç§°ç­›é€‰ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
    if (filters.fruitName && filters.fruitName.trim().length > 0) {
      const target = filters.fruitName.trim()
      filteredData = filteredData.filter(item => (item.fruitName || '').trim() === target)
    }
    
    // çŠ¶æ€ç­›é€‰
    if (filters.status) {
      filteredData = filteredData.filter(item => item.status === filters.status)
    }
    
    return filteredData
  }

  /**
   * æ‰¹é‡åˆ é™¤æ•°æ®ï¼ˆæ ¹æ®IDæ•°ç»„ï¼‰
   */
  async deleteBatchData(ids: number[]): Promise<void> {
    try {
      const db = GetIBestORM();
      for (const id of ids) {
        db.Table("processing_history").Where('id', id).Delete()
      }
      await this.loadDataFromDatabase()
    } catch (error) {
      console.error('âŒ æ‰¹é‡åˆ é™¤æ•°æ®å¤±è´¥:', error)
      const err = error as object
      throw new Error(JSON.stringify(err))
    }
  }


  /**
   * è·å–æ•°æ®æ€»æ•°
   */
  getDataCount(): number {
    return this.tableData.length
  }

  /**
   * é‡ç½®ä¸ºåˆå§‹æ•°æ®ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰
   */
  resetToDefault(): void {
    this.clearData()
  }
  
  /**
   * åˆ·æ–°æ•°æ®ï¼ˆä»æ•°æ®åº“é‡æ–°åŠ è½½ï¼‰
   */
  async refreshData(): Promise<void> {
    await this.loadDataFromDatabase()
  }

  /**
   * è·å–æ‰€æœ‰å”¯ä¸€çš„å®¢æˆ·åç§°åˆ—è¡¨
   */
  getUniqueCustomerNames(): string[] {
    const names = new Set<string>()
    this.tableData.forEach(item => {
      if (item.customerName && item.customerName.trim() !== '') {
        names.add(item.customerName)
      }
    })
    return Array.from(names).sort()
  }

  /**
   * è·å–æ‰€æœ‰å”¯ä¸€çš„å†œåœºåç§°åˆ—è¡¨
   */
  getUniqueFarmNames(): string[] {
    const names = new Set<string>()
    this.tableData.forEach(item => {
      if (item.farmName && item.farmName.trim() !== '') {
        names.add(item.farmName)
      }
    })
    return Array.from(names).sort()
  }

  /**
   * è·å–æ‰€æœ‰å”¯ä¸€çš„æ°´æœåç§°åˆ—è¡¨
   */
  getUniqueFruitNames(): string[] {
    const names = new Set<string>()
    this.tableData.forEach(item => {
      if (item.fruitName && item.fruitName.trim() !== '') {
        names.add(item.fruitName)
      }
    })
    return Array.from(names).sort()
  }
}
