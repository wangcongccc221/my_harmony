/**
 * 操作按钮卡片组件
 * 
 * 功能说明：
 * - 提供历史加工相关的操作按钮
 * - 包含7个操作按钮：查询、合并导出、报告、删除、重置、批量导出、等级合并导出
 * - 支持按钮点击事件的处理和回调
 * 
 * 组件特点：
 * - 两行布局：上面4个按钮，下面3个按钮
 * - 按钮样式：统一的主题样式，圆角设计
 * - 事件处理：支持各种操作按钮的点击事件
 * - 主题支持：支持主题切换和样式更新
 * 
 * 使用方式：
 * ```typescript
 * ActionButtonsCard({
 *   onQueryClick: () => { this.handleQuery() },
 *   onMergeExportClick: () => { this.handleMergeExport() },
 *   onReportClick: () => { this.handleReport() },
 *   onDeleteClick: () => { this.handleDelete() },
 *   onResetClick: () => { this.handleReset() },
 *   onBatchExportClick: () => { this.handleBatchExport() },
 *   onLevelMergeExportClick: () => { this.handleLevelMergeExport() }
 * })
 * ```
 */

import { BaseComponentHelper } from '../../components/common/BaseComponent'
import { OmniThemeManager, OmniThemeType, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { OMNI_THEME_KEY, OMNI_THEME_TYPE_KEY, OMNI_THEME_VERSION_KEY } from '../../utils/theme/useOmniTheme'
import { HistoryTableManager, HistoryTableData } from './core/HistoryTableManager'
import fs from '@ohos.file.fs'
import common from '@ohos.app.ability.common'

/**
 * 操作按钮卡片组件结构体
 * 
 * 属性说明：
 * - onQueryClick: 查询按钮点击回调函数
 * - onMergeExportClick: 合并导出按钮点击回调函数
 * - onReportClick: 报告按钮点击回调函数
 * - onDeleteClick: 删除按钮点击回调函数
 * - onResetClick: 重置按钮点击回调函数
 * - onBatchExportClick: 批量导出按钮点击回调函数
 * - onLevelMergeExportClick: 等级合并导出按钮点击回调函数
 * 
 * 方法说明：
 * - getCurrentTheme(): 获取当前主题配置
 * - build(): 构建操作按钮卡片的UI结构
 */
@Component
export struct ActionButtonsCard {
  // ==================== 日期数据属性 ====================
  /** 开始日期字符串 */
  @Prop startDate: string = ''
  /** 结束日期字符串 */
  @Prop endDate: string = ''
  /** 选中的开始日期对象 */
  @Prop selectedStartDate: Date = new Date()
  /** 选中的结束日期对象 */
  @Prop selectedEndDate: Date = new Date()
  
  // ==================== 事件回调函数 ====================
  /** 查询按钮点击回调函数 */
  onQueryClick?: () => void
  /** 合并导出按钮点击回调函数 */
  onMergeExportClick?: () => void
  /** 报告按钮点击回调函数 */
  onReportClick?: () => void
  /** 删除按钮点击回调函数 */
  onDeleteClick?: () => void
  /** 重置按钮点击回调函数 */
  onResetClick?: () => void
  /** 批量导出按钮点击回调函数 */
  onBatchExportClick?: () => void
  /** 等级合并导出按钮点击回调函数 */
  onLevelMergeExportClick?: () => void
  /** 日期错误回调函数 */
  onDateError?: () => void
  /** 导出成功回调函数 */
  onExportSuccess?: (filePath: string, count: number) => void
  /** 获取表格数据的回调函数 */
  onGetTableData?: () => HistoryTableData[]
  /** 获取选中数据的回调函数 */
  onGetSelectedData?: () => HistoryTableData[]

  // ==================== 文件命名对话框状态 ====================
  /** 显示文件命名对话框 */
  @State private showFileNameDialog: boolean = false
  /** 输入的文件名 */
  @State private inputFileName: string = ''
  /** 导出类型：'merge' | 'batch' */
  @State private exportType: string = ''

  // ==================== 主题相关属性 ====================
  /** 当前主题样式 */
  @StorageLink(OMNI_THEME_KEY) consumedTheme: ExtendedOmniThemeStyle = OmniThemeManager.getInstance().getCurrentTheme()
  /** 当前主题类型 */
  @StorageLink(OMNI_THEME_TYPE_KEY) consumedThemeType: OmniThemeType = OmniThemeManager.getInstance().getCurrentThemeType()
  /** 主题版本号 */
  @StorageLink(OMNI_THEME_VERSION_KEY) themeVersion: number = 0
  /** 基础组件助手 */
  private baseComponentHelper = new BaseComponentHelper()
  

  /**
   * 获取当前主题配置
   * 
   * 功能说明：
   * - 从基础组件助手获取当前主题样式
   * - 用于组件样式配置
   * - 支持主题切换时的样式更新
   * 
   * @returns 当前主题样式配置
   */
  private getCurrentTheme(): ExtendedOmniThemeStyle {
    return this.baseComponentHelper.getCurrentTheme()
  }

  /**
   * 处理查询操作
   * 
   * 功能说明：
   * - 执行历史数据查询操作
   * - 调用查询回调函数
   * - 处理查询结果
   */
  private async handleQuery(): Promise<void> {
    console.log('执行查询操作')
    if (this.onQueryClick) {
      this.onQueryClick()
    }
  }

  /**
   * 处理合并导出操作
   * 
   * 功能说明：
   * - 执行历史数据合并导出操作
   * - 生成CSV文件并保存
   * - 显示导出成功对话框
   */
  private async handleMergeExport(): Promise<void> {
    console.log('执行合并导出操作')
    this.exportType = 'merge'
    this.inputFileName = ''
    this.showFileNameDialog = true
  }

  /**
   * 生成历史加工CSV数据
   */
  private generateHistoryCSVData(): string {
    // CSV头部
    let csvContent = '加工时间,结束时间,加工品种,总重量(吨),客户名称,农场名称,水果类型,等级,出口编号\n';
    
    // 获取所有历史加工数据
    const allHistoryData = this.getAllHistoryData();
    
    // 添加所有数据行
    allHistoryData.forEach(row => {
      csvContent += row.join(',') + '\n';
    });
    
    return csvContent;
  }

  /**
   * 生成批量导出CSV数据
   */
  private generateBatchCSVData(selectedData: HistoryTableData[]): string {
    // CSV头部
    let csvContent = '加工时间,结束时间,加工品种,总重量(吨),客户名称,农场名称,水果类型,等级,出口编号\n';
    
    // 添加选中的数据行
    selectedData.forEach(item => {
      csvContent += [
        item.startTime || '',
        item.endTime || '',
        item.fruitName || '',
        item.weight?.toString() || '',
        item.customerName || '',
        item.farmName || '',
        item.fruitName || '',
        item.status || '',
        item.id?.toString() || ''
      ].join(',') + '\n';
    });
    
    return csvContent;
  }

  /**
   * 获取所有历史加工数据
   */
  private getAllHistoryData(): string[][] {
    try {
      let allHistoryData: HistoryTableData[] = [];
      
      // 优先从表格组件获取数据
      if (this.onGetTableData) {
        allHistoryData = this.onGetTableData();
        console.log(`从表格组件获取到 ${allHistoryData.length} 条历史数据`);
      } else {
        // 备用方案：从数据管理器获取
        const historyTableManager = HistoryTableManager.getInstance();
        allHistoryData = historyTableManager.getData();
        console.log(`从数据管理器获取到 ${allHistoryData.length} 条历史数据`);
      }
      
      // 转换为CSV格式的二维数组
      return allHistoryData.map((record: HistoryTableData) => [
        record.startTime || '',
        record.endTime || '',
        record.fruitName || '',
        record.weight?.toString() || '',
        record.customerName || '',
        record.farmName || '',
        record.fruitName || '',
        record.status || '',
        record.id?.toString() || ''
      ]);
    } catch (error) {
      console.error('获取历史数据失败:', error);
      // 如果获取失败，返回空数组
      return [];
    }
  }

  /**
   * 保存到公共目录
   */
  private async saveToPublicDirectory(filePath: string, fileName: string, csvContent: string): Promise<void> {
    try {
      const targetPaths = [
        '/storage/media/100/local/files/Docs/Download/',
        '/storage/emulated/0/Download/',
        '/storage/emulated/0/Documents/',
        '/sdcard/Download/',
        '/sdcard/Documents/'
      ];
      
      let successCount = 0;
      let successPaths: string[] = [];
      
      // 读取原文件内容
      const file = fs.openSync(filePath, fs.OpenMode.READ_ONLY);
      const stat = fs.statSync(filePath);
      const buffer = new ArrayBuffer(stat.size);
      fs.readSync(file.fd, buffer);
      fs.closeSync(file);
      
      // 尝试保存到每个路径
      for (const targetDir of targetPaths) {
        try {
          const targetPath = `${targetDir}${fileName}`;
          const targetFile = fs.openSync(targetPath, fs.OpenMode.CREATE | fs.OpenMode.WRITE_ONLY);
          fs.writeSync(targetFile.fd, buffer);
          fs.closeSync(targetFile);
          successCount++;
          successPaths.push(targetPath);
          console.log(`成功保存到: ${targetPath}`);
        } catch (error) {
          console.warn(`保存到 ${targetDir} 失败:`, error);
        }
      }
      
      if (successCount > 0) {
        console.log(`文件已保存到 ${successCount} 个位置:`, successPaths);
        if (this.onExportSuccess) {
          this.onExportSuccess(successPaths[0], successCount);
        }
      } else {
        console.log('所有公共路径保存失败，文件保存在应用沙箱中');
        if (this.onExportSuccess) {
          this.onExportSuccess(filePath, 1);
        }
      }
    } catch (error) {
      console.error('保存到公共目录失败:', error);
    }
  }

  /**
   * 处理报告操作
   * 
   * 功能说明：
   * - 执行历史数据报告生成操作
   * - 调用报告回调函数
   * - 处理报告结果
   */
  private async handleReport(): Promise<void> {
    console.log('执行报告操作')
    if (this.onReportClick) {
      this.onReportClick()
    }
  }

  /**
   * 处理删除操作
   * 
   * 功能说明：
   * - 执行历史数据删除操作
   * - 调用删除回调函数
   * - 处理删除结果
   */
  private async handleDelete(): Promise<void> {
    console.log('执行删除操作')
    if (this.onDeleteClick) {
      this.onDeleteClick()
    }
  }

  /**
   * 处理重置操作
   * 
   * 功能说明：
   * - 执行历史数据重置操作
   * - 调用重置回调函数
   * - 处理重置结果
   */
  private async handleReset(): Promise<void> {
    console.log('执行重置操作')
    if (this.onResetClick) {
      this.onResetClick()
    }
  }

  /**
   * 处理批量导出操作
   * 
   * 功能说明：
   * - 执行历史数据批量导出操作
   * - 调用批量导出回调函数
   * - 处理批量导出结果
   */
  private async handleBatchExport(): Promise<void> {
    console.log('执行批量导出操作')
    this.exportType = 'batch'
    this.inputFileName = ''
    this.showFileNameDialog = true
  }

  /**
   * 处理文件命名对话框确认
   */
  private async handleFileNameConfirm(): Promise<void> {
    if (!this.inputFileName.trim()) {
      console.log('文件名不能为空')
      return
    }
    
    this.showFileNameDialog = false
    
    try {
      if (this.exportType === 'merge') {
        await this.performMergeExport(this.inputFileName)
      } else if (this.exportType === 'batch') {
        await this.performBatchExport(this.inputFileName)
      }
    } catch (error) {
      console.error('导出失败:', error)
    }
  }

  /**
   * 处理文件命名对话框取消
   */
  private handleFileNameCancel(): void {
    this.showFileNameDialog = false
    this.inputFileName = ''
    this.exportType = ''
  }

  /**
   * 执行合并导出
   */
  private async performMergeExport(fileName: string): Promise<void> {
    try {
      const context = getContext(this) as common.UIAbilityContext;
      const filesDir = context.filesDir;
      const finalFileName = fileName.endsWith('.csv') ? fileName : `${fileName}.csv`;
      const filePath = `${filesDir}/${finalFileName}`;
      const csvContent = this.generateHistoryCSVData();
      const file = fs.openSync(filePath, fs.OpenMode.CREATE | fs.OpenMode.WRITE_ONLY);
      fs.writeSync(file.fd, csvContent);
      fs.closeSync(file);
      console.log('合并导出CSV文件创建成功:', filePath);
      await this.saveToPublicDirectory(filePath, finalFileName, csvContent);
    } catch (error) {
      console.error('合并导出失败:', error);
    }
  }

  /**
   * 执行批量导出
   */
  private async performBatchExport(fileName: string): Promise<void> {
    try {
      // 获取选中的数据
      let selectedData: HistoryTableData[] = []
      if (this.onGetSelectedData) {
        selectedData = this.onGetSelectedData()
      }
      
      if (selectedData.length === 0) {
        console.log('没有选中任何数据')
        return
      }
      
      console.log(`准备导出 ${selectedData.length} 条选中的数据`)
      
      const context = getContext(this) as common.UIAbilityContext;
      const filesDir = context.filesDir;
      const finalFileName = fileName.endsWith('.csv') ? fileName : `${fileName}.csv`;
      const filePath = `${filesDir}/${finalFileName}`;

      const csvContent = this.generateBatchCSVData(selectedData);
      const file = fs.openSync(filePath, fs.OpenMode.CREATE | fs.OpenMode.WRITE_ONLY);
      fs.writeSync(file.fd, csvContent);
      fs.closeSync(file);
      console.log('批量导出CSV文件创建成功:', filePath);
      await this.saveToPublicDirectory(filePath, finalFileName, csvContent);
    } catch (error) {
      console.error('批量导出失败:', error);
    }
  }

  /**
   * 处理等级合并导出操作
   * 
   * 功能说明：
   * - 执行历史数据等级合并导出操作
   * - 调用等级合并导出回调函数
   * - 处理等级合并导出结果
   */
  private async handleLevelMergeExport(): Promise<void> {
    console.log('执行等级合并导出操作')
    if (this.onLevelMergeExportClick) {
      this.onLevelMergeExportClick()
    }
  }

  /**
   * 构建操作按钮卡片的UI结构
   * 
   * 功能说明：
   * - 创建两行布局的按钮组
   * - 上面4个按钮：查询、合并导出、报告、删除
   * - 下面3个按钮：重置、批量导出、等级合并导出
   * - 按钮间有适当间距
   * 
   * 样式说明：
   * - 卡片样式：透明背景，无边框，无阴影（隐形样式）
   * - 按钮样式：主题背景色，白色文字，圆角设计
   * - 按钮尺寸：统一高度40px，自适应宽度
   * - 间距设计：按钮间有适当间距
   */
  build() {
    Stack() {
      Column() {
      // ==================== 上面4个按钮 ====================
      Row() {
        // 查询按钮
        Button('查询')
          .fontSize(16)  // 调大到16px
          .fontColor(Color.White)
          .backgroundColor(this.getCurrentTheme().primary)
          .borderRadius(6)
          .height(40)
          .layoutWeight(1)
          .margin({ right: 4 })
          .onClick(async () => {
            await this.handleQuery()
          })

        // 合并导出按钮
        Button('合并导出')
          .fontSize(16)  // 调大到16px
          .fontColor(Color.White)
          .backgroundColor(this.getCurrentTheme().primary)
          .borderRadius(6)
          .height(40)
          .layoutWeight(1)
          .margin({ left: 2, right: 2 })
          .onClick(async () => {
            await this.handleMergeExport()
          })

        // 报告按钮
        Button('报告')
          .fontSize(16)  // 调大到16px
          .fontColor(Color.White)
          .backgroundColor(this.getCurrentTheme().primary)
          .borderRadius(6)
          .height(40)
          .layoutWeight(1)
          .margin({ left: 2, right: 2 })
          .onClick(async () => {
            await this.handleReport()
          })

        // 删除按钮
        Button('删除')
          .fontSize(16)  // 调大到16px
          .fontColor(Color.White)
          .backgroundColor(this.getCurrentTheme().primary)
          .borderRadius(6)
          .height(40)
          .layoutWeight(1)
            .margin({ left: 2, right: 4 })
          .onClick(async () => {
            await this.handleDelete()
          })
      }
      .width('100%')
        .margin({ bottom: 12 })

      // ==================== 下面3个按钮 ====================
      Row() {
        // 重置按钮
        Button('重置')
          .fontSize(16)  // 调大到16px
          .fontColor(Color.White)
          .backgroundColor(this.getCurrentTheme().primary)
          .borderRadius(6)
          .height(40)
          .layoutWeight(1)
          .margin({ right: 4 })
            .onClick(async () => {
              await this.handleReset()
          })

        // 批量导出按钮
        Button('批量导出')
          .fontSize(16)  // 调大到16px
          .fontColor(Color.White)
          .backgroundColor(this.getCurrentTheme().primary)
          .borderRadius(6)
          .height(40)
          .layoutWeight(1)
          .margin({ left: 2, right: 2 })
          .onClick(async () => {
            await this.handleBatchExport()
          })

        // 等级合并导出按钮
        Button('等级合并导出')
          .fontSize(16)  // 调大到16px
          .fontColor(Color.White)
          .backgroundColor(this.getCurrentTheme().primary)
          .borderRadius(6)
          .height(40)
          .layoutWeight(1)
            .margin({ left: 2, right: 4 })
          .onClick(async () => {
            await this.handleLevelMergeExport()
          })
      }
      .width('100%')
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      }
      .width('100%')
      .height('auto')
      .padding(0)
      .backgroundColor(Color.Transparent)

      // 文件命名对话框
      if (this.showFileNameDialog) {
        this.buildFileNameDialog()
      }
    }
  }

  /**
   * 构建文件命名对话框
   */
  @Builder
  buildFileNameDialog(): void {
    Column() {
      Column() {
        Text('文件命名')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getCurrentTheme().textColor)
          .margin({ bottom: 20 })

        TextInput({ placeholder: '请输入CSV文件名', text: this.inputFileName })
          .onChange((value: string) => {
            this.inputFileName = value
          })
          .width('100%')
          .height(40)
          .backgroundColor(this.getCurrentTheme().surfaceColor)
          .borderRadius(8)
          .padding({ left: 12, right: 12 })
          .margin({ bottom: 20 })

        Row({ space: 12 }) {
          Button('取消')
            .fontSize(16)
            .fontColor(this.getCurrentTheme().textColor)
            .backgroundColor(this.getCurrentTheme().surfaceColor)
            .borderRadius(8)
            .height(40)
            .layoutWeight(1)
            .onClick(() => {
              this.handleFileNameCancel()
            })

          Button('确认')
            .fontSize(16)
            .fontColor(Color.White)
            .backgroundColor(this.getCurrentTheme().primary)
            .borderRadius(8)
            .height(40)
            .layoutWeight(1)
            .onClick(() => {
              this.handleFileNameConfirm()
            })
        }
        .width('100%')
      }
      .width('80%')
      .padding(24)
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(12)
      .shadow({ radius: 8, color: 'rgba(0,0,0,0.2)', offsetY: 4 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0,0,0,0.5)')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }
}
