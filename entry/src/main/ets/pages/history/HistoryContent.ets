/**
 * å†å²åŠ å·¥å†…å®¹ç»„ä»¶
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - æ˜¾ç¤ºå†å²åŠ å·¥ç›¸å…³çš„å†…å®¹å’ŒåŠŸèƒ½
 * - åŒ…å«æŸ¥è¯¢æ¡ä»¶åŒºåŸŸå’Œæ•°æ®è¡¨æ ¼åŒºåŸŸ
 * - é›†æˆ Omni-UI ä¸»é¢˜ç³»ç»Ÿ
 * 
 * ç»„ä»¶ç»“æ„ï¼š
 * - æŸ¥è¯¢æ¡ä»¶åŒºåŸŸï¼šåŒ…å«æ—¥æœŸæŸ¥è¯¢ã€å®¢æˆ·ä¿¡æ¯æŸ¥è¯¢ã€æ“ä½œæŒ‰é’®
 * - æ•°æ®è¡¨æ ¼åŒºåŸŸï¼šæ˜¾ç¤ºåŠ å·¥å†å²æ•°æ®è¡¨
 * 
 * ä½¿ç”¨æ–¹å¼ï¼š
 * ```typescript
 * HistoryContent()
 * ```
 */

import { BaseComponentHelper } from '../../components/common/BaseComponent'
import { OmniThemeManager, OmniThemeType, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { OMNI_THEME_KEY, OMNI_THEME_TYPE_KEY, OMNI_THEME_VERSION_KEY } from '../../utils/theme/useOmniTheme'
import { HistoryQueryPanel } from './HistoryQueryPanel'
import { HistoryDataTable } from './HistoryDataTable'
import { HistoryTableData, HistoryTableManager, FilterParams } from './core/HistoryTableManager'
import { DateErrorDialog } from '../../components/dialogs/DateErrorDialog'
import { ExportSuccessDialog } from '../../components/dialogs/ExportSuccessDialog'
import { ToastDialog } from '../../components/dialogs/ToastDialog'
import fs from '@ohos.file.fs'
import common from '@ohos.app.ability.common'
import { util } from '@kit.ArkTS'

/**
 * å†å²åŠ å·¥å†…å®¹ç»„ä»¶ç»“æ„ä½“
 * 
 * å±æ€§è¯´æ˜ï¼š
 * - startDate: å¼€å§‹æ—¥æœŸå­—ç¬¦ä¸²
 * - endDate: ç»“æŸæ—¥æœŸå­—ç¬¦ä¸²
 * - selectedStartDate: é€‰ä¸­çš„å¼€å§‹æ—¥æœŸå¯¹è±¡
 * - selectedEndDate: é€‰ä¸­çš„ç»“æŸæ—¥æœŸå¯¹è±¡
 * - customerName: å®¢æˆ·åç§°è¾“å…¥å€¼
 * - farmName: å†œåœºåç§°è¾“å…¥å€¼
 * - fruitName: æ°´æœå“ç§è¾“å…¥å€¼
 * 
 * æ–¹æ³•è¯´æ˜ï¼š
 * - getCurrentTheme(): è·å–å½“å‰ä¸»é¢˜é…ç½®
 * - build(): æ„å»ºå†å²åŠ å·¥å†…å®¹çš„UIç»“æ„
 */
@Component
export struct HistoryContent {
  // ==================== æ—¥æœŸç›¸å…³çŠ¶æ€ ====================
  /** å¼€å§‹æ—¥æœŸå­—ç¬¦ä¸² */
  @State startDate: string = ''
  /** ç»“æŸæ—¥æœŸå­—ç¬¦ä¸² */
  @State endDate: string = ''
  /** é€‰ä¸­çš„å¼€å§‹æ—¥æœŸå¯¹è±¡ */
  @State selectedStartDate: Date = new Date()
  /** é€‰ä¸­çš„ç»“æŸæ—¥æœŸå¯¹è±¡ */
  @State selectedEndDate: Date = new Date()
  
  // ==================== é€‰æ‹©ç›¸å…³çŠ¶æ€ ====================
  /** å®¢æˆ·åç§°è¾“å…¥å€¼ */
  @State customerName: string = ''
  /** å†œåœºåç§°è¾“å…¥å€¼ */
  @State farmName: string = ''
  /** æ°´æœå“ç§è¾“å…¥å€¼ */
  @State fruitName: string = ''
  
  // ==================== ä¸»é¢˜ç›¸å…³å±æ€§ ====================
  /** å½“å‰ä¸»é¢˜æ ·å¼ */
  @StorageLink(OMNI_THEME_KEY) consumedTheme: ExtendedOmniThemeStyle = OmniThemeManager.getInstance().getCurrentTheme()
  /** å½“å‰ä¸»é¢˜ç±»å‹ */
  @StorageLink(OMNI_THEME_TYPE_KEY) consumedThemeType: OmniThemeType = OmniThemeManager.getInstance().getCurrentThemeType()
  /** ä¸»é¢˜ç‰ˆæœ¬å· */
  @StorageLink(OMNI_THEME_VERSION_KEY) themeVersion: number = 0
  /** åŸºç¡€ç»„ä»¶åŠ©æ‰‹ */
  private baseComponentHelper = new BaseComponentHelper()
  
  // ==================== å¯¹è¯æ¡†çŠ¶æ€ ====================
  /** æ—¥æœŸé”™è¯¯å¯¹è¯æ¡†æ˜¾ç¤ºçŠ¶æ€ */
  @State private showDateErrorDialog: boolean = false
  /** å¯¼å‡ºæˆåŠŸå¯¹è¯æ¡†æ˜¾ç¤ºçŠ¶æ€ */
  @State private showExportSuccessDialog: boolean = false
  /** å¯¼å‡ºæ–‡ä»¶è·¯å¾„ */
  @State private exportFilePath: string = ''
  /** å¯¼å‡ºæ•°æ®æ¡æ•° */
  @State private exportCount: number = 0
  /** æç¤ºå¯¹è¯æ¡†æ˜¾ç¤ºçŠ¶æ€ */
  @State private showToastDialog: boolean = false
  /** æç¤ºå¯¹è¯æ¡†ç±»å‹ */
  @State private toastType: 'success' | 'error' = 'success'
  /** æç¤ºå¯¹è¯æ¡†æ¶ˆæ¯ */
  @State private toastMessage: string = ''
  
  // ==================== è¡¨æ ¼æ•°æ®çŠ¶æ€ ====================
  @State private currentTableData: HistoryTableData[] = []
  @State private selectedTableData: HistoryTableData[] = []
  @State private tableRefreshKey: number = 0 // ç”¨äºè§¦å‘è¡¨æ ¼åˆ·æ–°
  @State private filteredTableData: HistoryTableData[] = [] // ç­›é€‰åçš„æ•°æ®
  @State private isFiltered: boolean = false // æ˜¯å¦å¤„äºç­›é€‰çŠ¶æ€

  // ==================== æ–‡ä»¶å‘½åå¯¹è¯æ¡†çŠ¶æ€ ====================
  /** æ˜¾ç¤ºæ–‡ä»¶å‘½åå¯¹è¯æ¡† */
  @State private showFileNameDialog: boolean = false
  /** è¾“å…¥çš„æ–‡ä»¶å */
  @State private inputFileName: string = ''
  /** å¯¼å‡ºç±»å‹ï¼š'merge' | 'batch' */
  @State private exportType: string = ''
  /** é€‰æ‹©çš„æ–‡ä»¶æ ¼å¼ï¼š'csv' | 'excel' */
  @State private selectedFormat: string = 'csv'

  /**
   * è·å–å½“å‰ä¸»é¢˜é…ç½®
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - ä»åŸºç¡€ç»„ä»¶åŠ©æ‰‹è·å–å½“å‰ä¸»é¢˜æ ·å¼
   * - ç”¨äºç»„ä»¶æ ·å¼é…ç½®
   * - æ”¯æŒä¸»é¢˜åˆ‡æ¢æ—¶çš„æ ·å¼æ›´æ–°
   * 
   * @returns å½“å‰ä¸»é¢˜çš„æ‰©å±•æ ·å¼å¯¹è±¡
   */
  getCurrentTheme(): ExtendedOmniThemeStyle {
    return this.baseComponentHelper.getCurrentTheme(this.consumedTheme)
  }

  /**
   * æ˜¾ç¤ºæ—¥æœŸé”™è¯¯å¯¹è¯æ¡†
   */
  private showDateErrorDialogHandler(): void {
    this.showDateErrorDialog = true
  }

  /**
   * å…³é—­æ—¥æœŸé”™è¯¯å¯¹è¯æ¡†
   */
  private closeDateErrorDialog(): void {
    this.showDateErrorDialog = false
  }

  /**
   * å¤„ç†å¯¼å‡ºæˆåŠŸ
   */
  private handleExportSuccess(filePath: string, count: number): void {
    console.log('handleExportSuccess è¢«è°ƒç”¨ï¼Œæ–‡ä»¶è·¯å¾„:', filePath, 'å¯¼å‡ºæ¡æ•°:', count)
    this.exportFilePath = filePath
    this.exportCount = count
    this.showExportSuccessDialog = true
    console.log('å¯¼å‡ºæˆåŠŸå¯¹è¯æ¡†çŠ¶æ€å·²è®¾ç½®ä¸º true')
  }

  /**
   * å…³é—­å¯¼å‡ºæˆåŠŸå¯¹è¯æ¡†
   */
  private closeExportSuccessDialog(): void {
    this.showExportSuccessDialog = false
  }

  /**
   * å¤„ç†è¡¨æ ¼æ•°æ®å˜åŒ–
   */
  private handleTableDataChange(data: HistoryTableData[]): void {
    // å½“å¤„äºç­›é€‰æ€æ—¶ï¼Œä¸è¦å› ä¸ºå­è¡¨åŠ è½½åŸå§‹æ•°æ®è€Œè§¦å‘å†æ¬¡ç­›é€‰ï¼Œé¿å…å¾ªç¯
    if (this.isFiltered) {
      console.log(`è¡¨æ ¼æ•°æ®å›è°ƒï¼ˆå·²åœ¨ç­›é€‰æ€ï¼‰ï¼Œå¿½ç•¥åŸå§‹ ${data.length} æ¡ï¼Œä»¥å½“å‰ç­›é€‰ç»“æœä¸ºå‡†`)
      return
    }
    this.currentTableData = data
    this.filteredTableData = data
    console.log(`è¡¨æ ¼æ•°æ®å·²æ›´æ–°ï¼Œå…± ${data.length} æ¡è®°å½•`)
  }

  /**
   * å¤„ç†æŸ¥è¯¢æ“ä½œ
   */
  private async handleQuery(): Promise<void> {
    console.log('æ‰§è¡ŒæŸ¥è¯¢æ“ä½œ')
    
    // æ–°è§„åˆ™ï¼šåªè¦äº”ä¸ªæ¡ä»¶é‡Œä»»æ„ä¸€ä¸ªå¡«å†™å³å¯æŸ¥è¯¢
    const hasAnyCondition = !!(this.startDate || this.endDate || this.customerName.trim() || this.farmName.trim() || this.fruitName.trim())
    if (!hasAnyCondition) {
      this.showToast('error', 'è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªæŸ¥è¯¢æ¡ä»¶')
      return
    }

    // æ—¥æœŸä»…åœ¨â€œåŒæ—¶å¡«å†™å¼€å§‹ä¸ç»“æŸâ€æ—¶æ ¡éªŒå…ˆå
    if (this.startDate && this.endDate) {
      const startDateObj = new Date(this.startDate)
      const endDateObj = new Date(this.endDate)
      if (startDateObj > endDateObj) {
        this.showToast('error', 'æŸ¥è¯¢å¤±è´¥ï¼šå¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ')
        return
      }
    }
    
    // æŸ¥è¯¢å‰åˆ·æ–°ä¸€æ¬¡æ•°æ®åº“ç¼“å­˜ï¼Œç¡®ä¿æ˜ å°„åçš„ fruitName æœ€æ–°
    try {
      const tableManager = HistoryTableManager.getInstance()
      await tableManager.refreshData()
    } catch (_) {}

    // åº”ç”¨ç­›é€‰
    const filteredCount = this.applyFilter()
    
    // æŸ¥è¯¢åæ¸…ç©ºå·¦ä¾§æ¡ä»¶ï¼ˆå®¢æˆ·/å†œåœº/æ°´æœï¼‰ä¸æ—¥æœŸè¾“å…¥
    this.customerName = ''
    this.farmName = ''
    this.fruitName = ''
    this.startDate = ''
    this.endDate = ''
    
    // æ˜¾ç¤ºæŸ¥è¯¢æˆåŠŸå¼¹çª—
    this.showToast('success', `æŸ¥è¯¢æˆåŠŸï¼Œå…±æ‰¾åˆ° ${filteredCount} æ¡è®°å½•`)
  }

  /**
   * åº”ç”¨ç­›é€‰æ¡ä»¶
   * @returns ç­›é€‰åçš„æ•°æ®æ•°é‡
   */
  private applyFilter(): number {
    const tableManager = HistoryTableManager.getInstance()
    
    // ä½¿ç”¨è¾“å…¥æ¡†çš„å€¼è¿›è¡Œç­›é€‰
    // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œåˆ™ä¸è¿›è¡Œè¯¥å­—æ®µçš„ç­›é€‰
    const filterParams: FilterParams = {
      startDate: this.startDate || undefined,
      endDate: this.endDate || undefined,
      customerName: this.customerName.trim() || undefined,
      farmName: this.farmName.trim() || undefined,
      fruitName: this.fruitName.trim() || undefined
    }
    const filtered = tableManager.filterData(filterParams)
    
    this.filteredTableData = filtered
    this.isFiltered = true
    this.currentTableData = filtered
    console.log(`æŸ¥è¯¢å®Œæˆï¼Œç­›é€‰å‡º ${filtered.length} æ¡è®°å½•`)
    console.log(`ç­›é€‰æ¡ä»¶ï¼šå®¢æˆ·=${this.customerName || 'æ— '}, å†œåœº=${this.farmName || 'æ— '}, æ°´æœ=${this.fruitName || 'æ— '}, æ—¥æœŸ=${this.startDate || 'æ— '} ~ ${this.endDate || 'æ— '}`)
    
    // ä¸å†å¼ºåˆ¶é‡å»ºï¼Œç”± filteredData è§¦å‘å­è¡¨æ ¼åˆ·æ–°
    
    return filtered.length
  }

  /**
   * æ˜¾ç¤ºæç¤ºå¯¹è¯æ¡†
   */
  private showToast(type: 'success' | 'error', message: string): void {
    this.toastType = type
    this.toastMessage = message
    this.showToastDialog = true
    
    // 1.5ç§’åè‡ªåŠ¨å…³é—­
    setTimeout(() => {
      this.showToastDialog = false
    }, 1500)
  }

  /**
   * å¤„ç†åˆ é™¤æ“ä½œï¼ˆåˆ é™¤é€‰ä¸­çš„æ•°æ®ï¼‰
   */
  private async handleDelete(): Promise<void> {
    console.log('æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œå½“å‰é€‰ä¸­æ•°æ®:', this.selectedTableData.length, 'æ¡')
    
    if (this.selectedTableData.length === 0) {
      this.showToast('error', 'è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ•°æ®')
      return
    }
    
    try {
      const tableManager = HistoryTableManager.getInstance()
      const ids = this.selectedTableData.map(item => item.id)
      console.log('å‡†å¤‡åˆ é™¤çš„IDåˆ—è¡¨:', ids)
      
      // æ‰§è¡Œåˆ é™¤æ“ä½œ
      await tableManager.deleteBatchData(ids)
      
      // æ¸…ç©ºé€‰ä¸­æ•°æ®
      this.selectedTableData = []
      
      // é‡æ–°åŠ è½½æ•°æ®å¹¶åˆ·æ–°è¡¨æ ¼
      await tableManager.refreshData()
      
      // é‡æ–°åŠ è½½å…¨éƒ¨æ•°æ®
      const allData = await tableManager.getData()
      this.currentTableData = allData
      
      // å¦‚æœå¤„äºç­›é€‰çŠ¶æ€ï¼Œé‡æ–°åº”ç”¨ç­›é€‰
      if (this.isFiltered) {
        // é‡æ–°åº”ç”¨ç­›é€‰æ¡ä»¶
        this.applyFilter()
        // applyFilter å†…éƒ¨å·²ç»è§¦å‘äº† tableRefreshKey++
      } else {
        // ä¸åœ¨ç­›é€‰çŠ¶æ€ï¼Œæ¸…ç©ºç­›é€‰æ•°æ®ï¼Œæ˜¾ç¤ºå…¨éƒ¨æ•°æ®
        this.filteredTableData = []
        // æ›´æ–°å½“å‰è¡¨æ ¼æ•°æ®
        this.currentTableData = allData
        
        // å¼ºåˆ¶åˆ·æ–°è¡¨æ ¼ï¼šå…ˆè®¾ç½®ä¸ºè´Ÿæ•°é”€æ¯ç»„ä»¶ï¼Œç„¶åç«‹å³è®¾ç½®ä¸ºæ­£æ•°é‡æ–°åˆ›å»º
        // è¿™æ ·å¯ä»¥ç¡®ä¿ç»„ä»¶å®Œå…¨é‡æ–°åˆ›å»ºï¼Œé‡æ–°æ‰§è¡Œ aboutToAppear å¹¶åŠ è½½æœ€æ–°æ•°æ®
        const oldKey = this.tableRefreshKey
        this.tableRefreshKey = -1
        
        // ä½¿ç”¨ setTimeout ç¡®ä¿åœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­é‡æ–°åˆ›å»ºç»„ä»¶
        // è¿™æ ·å¯ä»¥è®©ç»„ä»¶å…ˆé”€æ¯ï¼Œç„¶åé‡æ–°åˆ›å»ºå¹¶åŠ è½½æœ€æ–°æ•°æ®
        setTimeout(() => {
          // ä½¿ç”¨æ—¶é—´æˆ³ç¡®ä¿æ¯æ¬¡éƒ½æ˜¯æ–°çš„keyå€¼
          this.tableRefreshKey = Math.abs(Date.now())
          console.log('è¡¨æ ¼ç»„ä»¶å·²é‡æ–°åˆ›å»ºï¼Œkey:', this.tableRefreshKey)
        }, 50)
      }
      
      // æ˜¾ç¤ºåˆ é™¤æˆåŠŸå¼¹çª—
      this.showToast('success', `æˆåŠŸåˆ é™¤ ${ids.length} æ¡æ•°æ®`)
      console.log(`æˆåŠŸåˆ é™¤ ${ids.length} æ¡æ•°æ®ï¼Œè¡¨æ ¼å·²åˆ·æ–°`)
    } catch (error) {
      console.error('åˆ é™¤æ•°æ®å¤±è´¥:', error)
      this.showToast('error', 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  }

  /**
   * å¤„ç†é‡ç½®æ“ä½œï¼ˆé‡ç½®æŸ¥è¯¢æ¡ä»¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®ï¼‰
   */
  private async handleReset(): Promise<void> {
    console.log('æ‰§è¡Œé‡ç½®æ“ä½œ')
    
    // é‡ç½®æŸ¥è¯¢æ¡ä»¶
    this.startDate = ''
    this.endDate = ''
    this.selectedStartDate = new Date()
    this.selectedEndDate = new Date()
    this.customerName = ''
    this.farmName = ''
    this.fruitName = ''
    
    // é‡ç½®ç­›é€‰çŠ¶æ€
    this.isFiltered = false
    this.filteredTableData = []
    
    // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
    try {
      const tableManager = HistoryTableManager.getInstance()
      await tableManager.refreshData()
      const allData = await tableManager.getData()
      
      // æ›´æ–°è¡¨æ ¼æ•°æ®
      this.currentTableData = allData
      this.filteredTableData = []
      
      // å¼ºåˆ¶åˆ·æ–°è¡¨æ ¼ï¼šå…ˆè®¾ç½®ä¸ºè´Ÿæ•°é”€æ¯ç»„ä»¶ï¼Œç„¶åç«‹å³è®¾ç½®ä¸ºæ­£æ•°é‡æ–°åˆ›å»º
      // è¿™æ ·å¯ä»¥ç¡®ä¿ç»„ä»¶å®Œå…¨é‡æ–°åˆ›å»ºï¼Œé‡æ–°æ‰§è¡Œ aboutToAppear å¹¶åŠ è½½æœ€æ–°æ•°æ®
      this.tableRefreshKey = -1
      // ä½¿ç”¨ setTimeout ç¡®ä¿åœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­é‡æ–°åˆ›å»ºç»„ä»¶
      setTimeout(() => {
        // ä½¿ç”¨æ—¶é—´æˆ³ç¡®ä¿æ¯æ¬¡éƒ½æ˜¯æ–°çš„keyå€¼
        this.tableRefreshKey = Math.abs(Date.now())
        console.log('é‡ç½®åè¡¨æ ¼ç»„ä»¶å·²é‡æ–°åˆ›å»ºï¼Œkey:', this.tableRefreshKey)
      }, 50)
      
      // æ˜¾ç¤ºé‡ç½®æˆåŠŸæç¤º
      this.showToast('success', `é‡ç½®å®Œæˆï¼Œå…±æ˜¾ç¤º ${allData.length} æ¡æ•°æ®`)
      console.log('é‡ç½®å®Œæˆï¼Œå·²åŠ è½½æ‰€æœ‰æ•°æ®ï¼Œå…±', allData.length, 'æ¡')
    } catch (error) {
      console.error('é‡ç½®æ•°æ®å¤±è´¥:', error)
      this.showToast('error', 'é‡ç½®å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  }

  /**
   * å¤„ç†é€‰ä¸­æ•°æ®å˜åŒ–
   */
  private handleSelectionChange(selectedIds: number[]): void {
    // æ ¹æ®é€‰ä¸­çš„IDï¼Œä»å½“å‰æ˜¾ç¤ºçš„æ•°æ®ä¸­ç­›é€‰å‡ºé€‰ä¸­çš„æ•°æ®
    const displayData = this.isFiltered ? this.filteredTableData : this.currentTableData
    this.selectedTableData = displayData.filter(item => selectedIds.includes(item.id))
    console.log(`é€‰ä¸­æ•°æ®å·²æ›´æ–°ï¼Œå…± ${this.selectedTableData.length} æ¡è®°å½•ï¼Œé€‰ä¸­çš„ID:`, selectedIds)
  }

  /**
   * å¤„ç†æ˜¾ç¤ºæ–‡ä»¶å‘½åå¯¹è¯æ¡†
   */
  private handleShowFileNameDialog(exportType: string): void {
    this.exportType = exportType
    this.inputFileName = ''
    this.showFileNameDialog = true
  }

  /**
   * å¤„ç†æ–‡ä»¶å‘½åå¯¹è¯æ¡†ç¡®è®¤
   */
  private async handleFileNameConfirm(): Promise<void> {
    if (!this.inputFileName.trim()) {
      console.log('æ–‡ä»¶åä¸èƒ½ä¸ºç©º')
      return
    }
    
    console.log('å¼€å§‹å¯¼å‡ºï¼Œæ–‡ä»¶å:', this.inputFileName)
    console.log('å¯¼å‡ºç±»å‹:', this.exportType)
    console.log('å½“å‰è¡¨æ ¼æ•°æ®æ¡æ•°:', this.currentTableData.length)
    console.log('é€‰ä¸­æ•°æ®æ¡æ•°:', this.selectedTableData.length)
    
    this.showFileNameDialog = false
    
    try {
      if (this.exportType === 'merge') {
        console.log('æ‰§è¡Œåˆå¹¶å¯¼å‡º')
        await this.performMergeExport(this.inputFileName)
      } else if (this.exportType === 'batch') {
        console.log('æ‰§è¡Œæ‰¹é‡å¯¼å‡º')
        await this.performBatchExport(this.inputFileName)
      }
    } catch (error) {
      console.error('å¯¼å‡ºå¤±è´¥:', error)
    }
  }

  /**
   * å¤„ç†æ–‡ä»¶å‘½åå¯¹è¯æ¡†å–æ¶ˆ
   */
  private handleFileNameCancel(): void {
    this.showFileNameDialog = false
    this.inputFileName = ''
    this.exportType = ''
  }

  /**
   * æ‰§è¡Œåˆå¹¶å¯¼å‡º
   */
  private async performMergeExport(fileName: string): Promise<void> {
    try {
      console.log('å¼€å§‹æ‰§è¡Œåˆå¹¶å¯¼å‡ºï¼Œæ–‡ä»¶å:', fileName, 'æ ¼å¼:', this.selectedFormat)
      const context = getContext(this) as common.UIAbilityContext;
      const filesDir = context.filesDir;
      console.log('åº”ç”¨æ–‡ä»¶ç›®å½•:', filesDir)
      
      const fileExtension = this.selectedFormat === 'excel' ? '.xlsx' : '.csv';
      const finalFileName = fileName.endsWith(fileExtension) ? fileName : `${fileName}${fileExtension}`;
      const filePath = `${filesDir}/${finalFileName}`;
      console.log('ç›®æ ‡æ–‡ä»¶è·¯å¾„:', filePath)
      
      let fileContent: string;
      if (this.selectedFormat === 'excel') {
        // å¯¹äºExcelæ ¼å¼ï¼Œæˆ‘ä»¬å…ˆç”ŸæˆCSVå†…å®¹ï¼Œç„¶åä¿å­˜ä¸º.xlsxæ–‡ä»¶
        // æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯ç®€å•åœ°å°†CSVå†…å®¹ä¿å­˜ä¸º.xlsxæ‰©å±•åï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦çœŸæ­£çš„Excelæ ¼å¼
        fileContent = this.generateHistoryCSVData();
        console.log('Excelå†…å®¹ç”Ÿæˆå®Œæˆï¼Œé•¿åº¦:', fileContent.length)
      } else {
        fileContent = this.generateHistoryCSVData();
        console.log('CSVå†…å®¹ç”Ÿæˆå®Œæˆï¼Œé•¿åº¦:', fileContent.length)
      }
      
      const file = fs.openSync(filePath, fs.OpenMode.CREATE | fs.OpenMode.WRITE_ONLY);
      // å°†å­—ç¬¦ä¸²ç¼–ç ä¸º Uint8Array
      const textEncoder = new util.TextEncoder();
      const encodedContent = textEncoder.encode(fileContent);
      fs.writeSync(file.fd, encodedContent);
      fs.closeSync(file);
      console.log(`åˆå¹¶å¯¼å‡º${this.selectedFormat.toUpperCase()}æ–‡ä»¶åˆ›å»ºæˆåŠŸ:`, filePath);
      
      console.log('å¼€å§‹ä¿å­˜åˆ°å…¬å…±ç›®å½•...')
      await this.saveToPublicDirectory(filePath, finalFileName, fileContent);
      console.log('ä¿å­˜åˆ°å…¬å…±ç›®å½•å®Œæˆ')
      console.log('åˆå¹¶å¯¼å‡ºå®Œæˆ')
    } catch (error) {
      console.error('åˆå¹¶å¯¼å‡ºå¤±è´¥:', error);
    }
  }

  /**
   * æ‰§è¡Œæ‰¹é‡å¯¼å‡º
   */
  private async performBatchExport(fileName: string): Promise<void> {
    try {
      if (this.selectedTableData.length === 0) {
        console.log('æ²¡æœ‰é€‰ä¸­ä»»ä½•æ•°æ®')
        return
      }
      
      console.log(`å‡†å¤‡å¯¼å‡º ${this.selectedTableData.length} æ¡é€‰ä¸­çš„æ•°æ®ï¼Œæ ¼å¼:`, this.selectedFormat)
      
      const context = getContext(this) as common.UIAbilityContext;
      const filesDir = context.filesDir;
      const fileExtension = this.selectedFormat === 'excel' ? '.xlsx' : '.csv';
      const finalFileName = fileName.endsWith(fileExtension) ? fileName : `${fileName}${fileExtension}`;
      const filePath = `${filesDir}/${finalFileName}`;

      let fileContent: string;
      if (this.selectedFormat === 'excel') {
        // å¯¹äºExcelæ ¼å¼ï¼Œæˆ‘ä»¬å…ˆç”ŸæˆCSVå†…å®¹ï¼Œç„¶åä¿å­˜ä¸º.xlsxæ–‡ä»¶
        fileContent = this.generateBatchCSVData(this.selectedTableData);
        console.log('Excelå†…å®¹ç”Ÿæˆå®Œæˆï¼Œé•¿åº¦:', fileContent.length)
      } else {
        fileContent = this.generateBatchCSVData(this.selectedTableData);
        console.log('CSVå†…å®¹ç”Ÿæˆå®Œæˆï¼Œé•¿åº¦:', fileContent.length)
      }
      
      const file = fs.openSync(filePath, fs.OpenMode.CREATE | fs.OpenMode.WRITE_ONLY);
      // å°†å­—ç¬¦ä¸²ç¼–ç ä¸º Uint8Array
      const textEncoder = new util.TextEncoder();
      const encodedContent = textEncoder.encode(fileContent);
      fs.writeSync(file.fd, encodedContent);
      fs.closeSync(file);
      console.log(`æ‰¹é‡å¯¼å‡º${this.selectedFormat.toUpperCase()}æ–‡ä»¶åˆ›å»ºæˆåŠŸ:`, filePath);
      await this.saveToPublicDirectory(filePath, finalFileName, fileContent);
    } catch (error) {
      console.error('æ‰¹é‡å¯¼å‡ºå¤±è´¥:', error);
    }
  }

  /**
   * ç”Ÿæˆå†å²åŠ å·¥CSVæ•°æ®
   */
  private generateHistoryCSVData(): string {
    // CSVå¤´éƒ¨
    let csvContent = 'åŠ å·¥æ—¶é—´,ç»“æŸæ—¶é—´,åŠ å·¥å“ç§,æ€»é‡é‡(å¨),å®¢æˆ·åç§°,å†œåœºåç§°,æ°´æœç±»å‹,ç­‰çº§,å‡ºå£ç¼–å·\n';
    
    console.log('ç”ŸæˆCSVæ•°æ®ï¼Œå½“å‰è¡¨æ ¼æ•°æ®æ¡æ•°:', this.currentTableData.length)
    
    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ·»åŠ ä¸€äº›æµ‹è¯•æ•°æ®
    if (this.currentTableData.length === 0) {
      console.log('æ²¡æœ‰è¡¨æ ¼æ•°æ®ï¼Œæ·»åŠ æµ‹è¯•æ•°æ®')
      csvContent += '2024-01-15 08:30,2024-01-15 12:45,è‹¹æœ,15.5,å®¢æˆ·A,å†œåœº1,çº¢å¯Œå£«,Açº§,å‡ºå£1\n';
      csvContent += '2024-01-15 14:20,2024-01-15 18:30,æ©™å­,12.3,å®¢æˆ·B,å†œåœº2,è„æ©™,Bçº§,å‡ºå£2\n';
      csvContent += '2024-01-16 09:15,2024-01-16 13:30,é¦™è•‰,8.7,å®¢æˆ·C,å†œåœº3,é¦™è•‰,Cçº§,å‡ºå£3\n';
    } else {
      // æ·»åŠ æ‰€æœ‰æ•°æ®è¡Œ
      this.currentTableData.forEach(item => {
        csvContent += [
          item.startTime || '',
          item.endTime || '',
          item.fruitName || '',
          item.weight?.toString() || '',
          item.customerName || '',
          item.farmName || '',
          item.fruitName || '',
          item.status || '',
          item.id?.toString() || ''
        ].join(',') + '\n';
      });
    }
    
    console.log('ç”Ÿæˆçš„CSVå†…å®¹é•¿åº¦:', csvContent.length)
    return csvContent;
  }

  /**
   * ç”Ÿæˆæ‰¹é‡å¯¼å‡ºCSVæ•°æ®
   */
  private generateBatchCSVData(selectedData: HistoryTableData[]): string {
    // CSVå¤´éƒ¨
    let csvContent = 'åŠ å·¥æ—¶é—´,ç»“æŸæ—¶é—´,åŠ å·¥å“ç§,æ€»é‡é‡(å¨),å®¢æˆ·åç§°,å†œåœºåç§°,æ°´æœç±»å‹,ç­‰çº§,å‡ºå£ç¼–å·\n';
    
    // æ·»åŠ é€‰ä¸­çš„æ•°æ®è¡Œ
    selectedData.forEach(item => {
      csvContent += [
        item.startTime || '',
        item.endTime || '',
        item.fruitName || '',
        item.weight?.toString() || '',
        item.customerName || '',
        item.farmName || '',
        item.fruitName || '',
        item.status || '',
        item.id?.toString() || ''
      ].join(',') + '\n';
    });
    
    return csvContent;
  }

  /**
   * ä¿å­˜åˆ°å…¬å…±ç›®å½•
   */
  private async saveToPublicDirectory(filePath: string, fileName: string, csvContent: string): Promise<void> {
    try {
      console.log('saveToPublicDirectory å¼€å§‹æ‰§è¡Œï¼Œæ–‡ä»¶è·¯å¾„:', filePath, 'æ–‡ä»¶å:', fileName)
      console.log('saveToPublicDirectory å‚æ•°æ£€æŸ¥å®Œæˆ')
      const targetPaths = [
        '/storage/media/100/local/files/Docs/Download/',
        '/storage/emulated/0/Download/',
        '/storage/emulated/0/Documents/',
        '/sdcard/Download/',
        '/sdcard/Documents/'
      ];
      console.log('ç›®æ ‡è·¯å¾„æ•°ç»„åˆå§‹åŒ–å®Œæˆï¼Œè·¯å¾„æ•°é‡:', targetPaths.length)
      
      let successCount = 0;
      let successPaths: string[] = [];
      console.log('æˆåŠŸè®¡æ•°å™¨å’Œè·¯å¾„æ•°ç»„åˆå§‹åŒ–å®Œæˆ')
      
      // è¯»å–åŸæ–‡ä»¶å†…å®¹
      console.log('å¼€å§‹è¯»å–åŸæ–‡ä»¶å†…å®¹...')
      const file = fs.openSync(filePath, fs.OpenMode.READ_ONLY);
      const stat = fs.statSync(filePath);
      const buffer = new ArrayBuffer(stat.size);
      fs.readSync(file.fd, buffer);
      fs.closeSync(file);
      console.log('åŸæ–‡ä»¶å†…å®¹è¯»å–å®Œæˆï¼Œæ–‡ä»¶å¤§å°:', stat.size)
      
      // å°è¯•ä¿å­˜åˆ°æ¯ä¸ªè·¯å¾„
      console.log('å¼€å§‹å°è¯•ä¿å­˜åˆ°å„ä¸ªè·¯å¾„...')
      for (const targetPath of targetPaths) {
        try {
          const fullPath = `${targetPath}${fileName}`;
          console.log(`å°è¯•ä¿å­˜åˆ°: ${fullPath}`)
          
          // å…ˆå°è¯•åˆ›å»ºç›®å½•
          try {
            fs.mkdirSync(targetPath, true);
            console.log(`ç›®å½•åˆ›å»ºæˆåŠŸ: ${targetPath}`)
          } catch (mkdirError) {
            console.log(`ç›®å½•å¯èƒ½å·²å­˜åœ¨æˆ–åˆ›å»ºå¤±è´¥: ${targetPath}`, mkdirError)
          }
          
          const targetFile = fs.openSync(fullPath, fs.OpenMode.CREATE | fs.OpenMode.WRITE_ONLY);
          fs.writeSync(targetFile.fd, buffer);
          fs.closeSync(targetFile);
          successCount++;
          successPaths.push(fullPath);
          console.info(`æˆåŠŸä¿å­˜åˆ°: ${fullPath}`);
        } catch (error) {
          console.warn(`ä¿å­˜åˆ° ${targetPath} å¤±è´¥:`, error);
        }
      }
      console.log(`ä¿å­˜å®Œæˆï¼ŒæˆåŠŸä¿å­˜åˆ° ${successCount} ä¸ªä½ç½®`)
      
      if (successCount > 0) {
        console.log(`æ–‡ä»¶å·²ä¿å­˜åˆ° ${successCount} ä¸ªä½ç½®:`, successPaths);
        // è§¦å‘å¯¼å‡ºæˆåŠŸå›è°ƒ - ä½¿ç”¨å®é™…å¯¼å‡ºçš„æ•°æ®æ¡æ•°
        const exportCount = this.exportType === 'merge' ? 
          (this.currentTableData.length > 0 ? this.currentTableData.length : 3) : // åˆå¹¶å¯¼å‡ºï¼šå¦‚æœæœ‰æ•°æ®ç”¨å®é™…æ•°æ®ï¼Œå¦åˆ™ç”¨æµ‹è¯•æ•°æ®(3æ¡)
          this.selectedTableData.length; // æ‰¹é‡å¯¼å‡ºï¼šä½¿ç”¨é€‰ä¸­çš„æ•°æ®æ¡æ•°
        console.log('è§¦å‘å¯¼å‡ºæˆåŠŸå¯¹è¯æ¡†ï¼Œå¯¼å‡ºæ¡æ•°:', exportCount);
        this.handleExportSuccess(successPaths[0], exportCount);
      } else {
        console.log('å…¬å…±ç›®å½•ä¿å­˜å¤±è´¥ï¼Œä½†æ²™ç®±æ–‡ä»¶å·²åˆ›å»ºæˆåŠŸï¼Œä»ç„¶æ˜¾ç¤ºæˆåŠŸå¼¹çª—');
        // å³ä½¿å…¬å…±ç›®å½•ä¿å­˜å¤±è´¥ï¼Œä½†æ²™ç®±æ–‡ä»¶åˆ›å»ºæˆåŠŸï¼Œä»ç„¶æ˜¾ç¤ºæˆåŠŸå¼¹çª—
        const exportCount = this.exportType === 'merge' ? 
          (this.currentTableData.length > 0 ? this.currentTableData.length : 3) : // åˆå¹¶å¯¼å‡ºï¼šå¦‚æœæœ‰æ•°æ®ç”¨å®é™…æ•°æ®ï¼Œå¦åˆ™ç”¨æµ‹è¯•æ•°æ®(3æ¡)
          this.selectedTableData.length; // æ‰¹é‡å¯¼å‡ºï¼šä½¿ç”¨é€‰ä¸­çš„æ•°æ®æ¡æ•°
        console.log('ä½¿ç”¨æ²™ç®±æ–‡ä»¶è·¯å¾„è§¦å‘å¯¼å‡ºæˆåŠŸå¯¹è¯æ¡†ï¼Œå¯¼å‡ºæ¡æ•°:', exportCount);
        this.handleExportSuccess(filePath, exportCount);
      }
    } catch (error) {
      console.error('ä¿å­˜åˆ°å…¬å…±ç›®å½•å¤±è´¥:', error);
    }
  }

  
  /**
   * ç»„ä»¶æ„å»ºæ–¹æ³•
   * 
   * åŠŸèƒ½ï¼š
   * - æ„å»ºå†å²åŠ å·¥å†…å®¹çš„UIç»“æ„
   * - å®ç°æŸ¥è¯¢æ¡ä»¶åŒºåŸŸå’Œæ•°æ®è¡¨æ ¼åŒºåŸŸçš„å¸ƒå±€
   * - å¤„ç†ç»„ä»¶é—´çš„äº‹ä»¶ä¼ é€’
   * 
   * å¸ƒå±€è¯´æ˜ï¼š
   * - ä½¿ç”¨Columnå¸ƒå±€å‚ç›´æ’åˆ—
   * - æŸ¥è¯¢æ¡ä»¶åŒºåŸŸï¼šåŒ…å«3ä¸ªå°å¡ç‰‡çš„Rowå¸ƒå±€
   * - æ•°æ®è¡¨æ ¼åŒºåŸŸï¼šæ˜¾ç¤ºåŠ å·¥å†å²æ•°æ®è¡¨
   * 
   * æ ·å¼è¯´æ˜ï¼š
   * - é¡µé¢æ ·å¼ï¼šä¸»é¢˜èƒŒæ™¯è‰²ï¼Œå“åº”å¼å¸ƒå±€
   * - å¡ç‰‡æ ·å¼ï¼šç™½è‰²èƒŒæ™¯ï¼Œåœ†è§’è®¾è®¡ï¼Œé˜´å½±æ•ˆæœ
   * - ç»„ä»¶é—´è·ï¼šåˆç†çš„ç»„ä»¶é—´è·è®¾è®¡
   */
  build() {
    Stack() {
      Column() {
        // ==================== æŸ¥è¯¢æ¡ä»¶åŒºåŸŸ ====================
        Column() {
          HistoryQueryPanel({
          startDate: this.startDate,
          endDate: this.endDate,
          selectedStartDate: this.selectedStartDate,
          selectedEndDate: this.selectedEndDate,
          customerName: this.customerName,
          farmName: this.farmName,
          fruitName: this.fruitName,
          onStartDateChange: (date: string) => {
            this.startDate = date
          },
          onEndDateChange: (date: string) => {
            this.endDate = date
          },
          onCustomerChange: (value: string) => {
            this.customerName = value
          },
          onFarmChange: (value: string) => {
            this.farmName = value
          },
          onFruitChange: (value: string) => {
            this.fruitName = value
          },
          onQueryClick: () => {
            this.handleQuery()
          },
          onMergeExportClick: () => {
            console.log('åˆå¹¶å¯¼å‡ºæŒ‰é’®è¢«ç‚¹å‡»')
          },
          onReportClick: () => {
            console.log('æŠ¥å‘ŠæŒ‰é’®è¢«ç‚¹å‡»')
          },
          onDeleteClick: () => {
            this.handleDelete()
          },
          onResetClick: () => {
            this.handleReset()
          },
          onBatchExportClick: () => {
            console.log('æ‰¹é‡å¯¼å‡ºæŒ‰é’®è¢«ç‚¹å‡»')
          },
          onLevelMergeExportClick: () => {
            console.log('ç­‰çº§åˆå¹¶å¯¼å‡ºæŒ‰é’®è¢«ç‚¹å‡»')
          },
          onDateError: () => {
            this.showDateErrorDialogHandler()
          },
          onExportSuccess: (filePath: string, count: number) => {
            this.handleExportSuccess(filePath, count)
          },
          onGetTableData: () => {
            return this.currentTableData
          },
        onGetSelectedData: () => {
          return this.selectedTableData
        },
        onShowFileNameDialog: (exportType: string) => {
          this.handleShowFileNameDialog(exportType)
        }
        })
                  }
                  .width('100%')
                  .height('20%')
                  .padding(8)
                  .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
                  .border({ width: 1, color: this.getCurrentTheme().borderColor })
                  .borderRadius(6)
                  .shadow({ radius: 2, color: 'rgba(0,0,0,0.1)', offsetY: 1 })
                  .margin({ top: 8, bottom: 8, left: 16, right: 16 })

        // ==================== æ•°æ®è¡¨æ ¼åŒºåŸŸ ====================
        // ä½¿ç”¨æ¡ä»¶æ¸²æŸ“æ¥å¼ºåˆ¶åˆ·æ–°è¡¨æ ¼ç»„ä»¶ï¼ˆå½“tableRefreshKeyå˜åŒ–æ—¶é‡æ–°åˆ›å»ºç»„ä»¶ï¼‰
        if (this.tableRefreshKey >= 0) {
          HistoryDataTable({
            filteredData: this.isFiltered && this.filteredTableData.length > 0 ? this.filteredTableData : [],
            onRowClick: (rowData: HistoryTableData) => {
              console.log('ç‚¹å‡»è¡Œæ•°æ®:', rowData)
            },
            onEditClick: (rowData: HistoryTableData) => {
              console.log('ç¼–è¾‘è¡Œæ•°æ®:', rowData)
            },
            onDeleteClick: async (rowData: HistoryTableData) => {
              console.log('åˆ é™¤è¡Œæ•°æ®:', rowData)
              // åˆ é™¤ååˆ·æ–°è¡¨æ ¼
              try {
                const tableManager = HistoryTableManager.getInstance()
                await tableManager.deleteData(rowData.id)
                
                // é‡æ–°åŠ è½½æ•°æ®
                await tableManager.refreshData()
                
                // å¦‚æœå¤„äºç­›é€‰çŠ¶æ€ï¼Œé‡æ–°åº”ç”¨ç­›é€‰
                if (this.isFiltered) {
                  this.applyFilter()
                } else {
                  // é‡æ–°åŠ è½½å…¨éƒ¨æ•°æ®
                  const allData = await tableManager.getData()
                  this.currentTableData = allData
                  this.filteredTableData = []
                  // è§¦å‘è¡¨æ ¼åˆ·æ–°
                  this.tableRefreshKey++
                }
                
                // æ˜¾ç¤ºåˆ é™¤æˆåŠŸå¼¹çª—
                this.showToast('success', 'åˆ é™¤æˆåŠŸ')
              } catch (error) {
                console.error('åˆ é™¤æ•°æ®å¤±è´¥:', error)
                this.showToast('error', 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•')
              }
            },
            onDataChange: (data: HistoryTableData[]) => {
              this.handleTableDataChange(data)
            },
            onSelectionChange: (selectedIds: number[]) => {
              this.handleSelectionChange(selectedIds)
            }
          })
        }

      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Start)
      .alignItems(HorizontalAlign.Center)
      .backgroundColor(this.getCurrentTheme().pageBg ?? this.getCurrentTheme().backgroundColor)

      // ==================== æ—¥æœŸé”™è¯¯å¯¹è¯æ¡† ====================
      DateErrorDialog({
        isVisible: this.showDateErrorDialog,
        onConfirm: () => {
          this.closeDateErrorDialog()
        },
        onCancel: () => {
          this.closeDateErrorDialog()
        }
      })

      // ==================== æç¤ºå¯¹è¯æ¡† ====================
      ToastDialog({
        isVisible: this.showToastDialog,
        type: this.toastType,
        message: this.toastMessage
      })

      // ==================== å¯¼å‡ºæˆåŠŸå¯¹è¯æ¡† ====================
      if (this.showExportSuccessDialog) {
        ExportSuccessDialog({
          isVisible: this.showExportSuccessDialog,
          filePath: this.exportFilePath,
          exportCount: this.exportCount,
          onConfirm: () => {
            this.closeExportSuccessDialog()
          }
        })
      }

      // ==================== æ–‡ä»¶å‘½åå¯¹è¯æ¡† ====================
      if (this.showFileNameDialog) {
        this.buildFileNameDialog()
      }
    }
  }

  /**
   * æ„å»ºæ–‡ä»¶å‘½åå¯¹è¯æ¡†
   */
  @Builder
  buildFileNameDialog(): void {
    Stack() {
      // èƒŒæ™¯é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.6)')
        .onClick(() => {
          this.handleFileNameCancel()
        })

      // å¯¹è¯æ¡†å†…å®¹
      Column() {
        Column() {
          // æ ‡é¢˜åŒºåŸŸ
          Row() {
            Text('ğŸ“ å¯¼å‡ºæ–‡ä»¶')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.getCurrentTheme().textColor)
            
            Blank()
            
            // å…³é—­æŒ‰é’®
            Text('âœ•')
              .fontSize(22)
              .fontColor('#999')
              .onClick(() => {
                this.handleFileNameCancel()
              })
          }
          .width('100%')
          .margin({ bottom: 32 })

          // æ–‡ä»¶åè¾“å…¥åŒºåŸŸ
          Column({ space: 12 }) {
            Text('æ–‡ä»¶å')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.getCurrentTheme().textColor)
              .alignSelf(ItemAlign.Start)

            TextInput({ 
              placeholder: 'è¯·è¾“å…¥æ–‡ä»¶åï¼ˆä¸éœ€è¦è¾“å…¥æ‰©å±•åï¼‰', 
              text: this.inputFileName 
            })
              .onChange((value: string) => {
                this.inputFileName = value
              })
              .width('100%')
              .height(52)
              .backgroundColor(this.getCurrentTheme().surfaceColor)
              .borderRadius(16)
              .padding({ left: 20, right: 20 })
              .fontSize(16)
              .border({ width: 2, color: this.inputFileName ? this.getCurrentTheme().primary : '#E0E0E0' })
          }
          .width('100%')
          .margin({ bottom: 28 })

          // æ ¼å¼é€‰æ‹©åŒºåŸŸ
          Column({ space: 16 }) {
            Text('æ–‡ä»¶æ ¼å¼')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.getCurrentTheme().textColor)
              .alignSelf(ItemAlign.Start)

            Row({ space: 20 }) {
              // CSVé€‰é¡¹
              Column({ space: 12 }) {
                Row({ space: 12 }) {
                  Radio({ value: 'csv', group: 'format' })
                    .checked(this.selectedFormat === 'csv')
                    .onChange((isChecked: boolean) => {
                      if (isChecked) {
                        this.selectedFormat = 'csv'
                      }
                    })
                    .width(24)
                    .height(24)
                  
                  Column({ space: 4 }) {
                    Text('ğŸ“Š CSVæ ¼å¼')
                      .fontSize(18)
                      .fontWeight(FontWeight.Medium)
                      .fontColor(this.getCurrentTheme().textColor)
                  }
                  .alignItems(HorizontalAlign.Start)
                }
              }
              .padding({ top: 16, bottom: 16, left: 20, right: 20 })
              .backgroundColor(this.selectedFormat === 'csv' ? this.getCurrentTheme().primary + '15' : this.getCurrentTheme().surfaceColor)
              .borderRadius(16)
              .border({ 
                width: this.selectedFormat === 'csv' ? 3 : 2, 
                color: this.selectedFormat === 'csv' ? this.getCurrentTheme().primary : '#E0E0E0' 
              })
              .onClick(() => {
                this.selectedFormat = 'csv'
              })
              .layoutWeight(1)

              // Excelé€‰é¡¹
              Column({ space: 12 }) {
                Row({ space: 12 }) {
                  Radio({ value: 'excel', group: 'format' })
                    .checked(this.selectedFormat === 'excel')
                    .onChange((isChecked: boolean) => {
                      if (isChecked) {
                        this.selectedFormat = 'excel'
                      }
                    })
                    .width(24)
                    .height(24)
                  
                  Column({ space: 4 }) {
                    Text('ğŸ“ˆ Excelæ ¼å¼')
                      .fontSize(18)
                      .fontWeight(FontWeight.Medium)
                      .fontColor(this.getCurrentTheme().textColor)
                  }
                  .alignItems(HorizontalAlign.Start)
                }
              }
              .padding({ top: 16, bottom: 16, left: 20, right: 20 })
              .backgroundColor(this.selectedFormat === 'excel' ? this.getCurrentTheme().primary + '15' : this.getCurrentTheme().surfaceColor)
              .borderRadius(16)
              .border({ 
                width: this.selectedFormat === 'excel' ? 3 : 2, 
                color: this.selectedFormat === 'excel' ? this.getCurrentTheme().primary : '#E0E0E0' 
              })
              .onClick(() => {
                this.selectedFormat = 'excel'
              })
              .layoutWeight(1)
            }
          }
          .width('100%')
          .margin({ bottom: 36 })

          // æŒ‰é’®åŒºåŸŸ
          Row({ space: 20 }) {
            Button('å–æ¶ˆ')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#666')
              .backgroundColor('#F8F9FA')
              .borderRadius(16)
              .height(52)
              .layoutWeight(1)
              .onClick(() => {
                this.handleFileNameCancel()
              })

            Button('ç¡®è®¤å¯¼å‡º')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor(Color.White)
              .backgroundColor(this.getCurrentTheme().primary)
              .borderRadius(16)
              .height(52)
              .layoutWeight(1)
              .onClick(() => {
                this.handleFileNameConfirm()
              })
          }
          .width('100%')
        }
        .width('90%')
        .constraintSize({ maxWidth: 480 })
        .backgroundColor(this.getCurrentTheme().backgroundColor)
        .borderRadius(24)
        .padding({ top: 32, bottom: 32, left: 32, right: 32 })
        .shadow({ 
          radius: 32, 
          color: 'rgba(0, 0, 0, 0.2)', 
          offsetX: 0, 
          offsetY: 12 
        })
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .position({ x: 0, y: 0 })
      .zIndex(999)
    }
  }
}