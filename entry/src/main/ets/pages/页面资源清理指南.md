# é¡µé¢èµ„æºæ¸…ç†æŒ‡å—

## ğŸ¯ é—®é¢˜è¯´æ˜

åœ¨ä½¿ç”¨é¡µé¢æ‡’åŠ è½½åï¼Œåˆ‡æ¢åˆ°ä¸åŒé¡µé¢æ—¶ï¼Œ**ä¹‹å‰çš„é¡µé¢èµ„æºå¯èƒ½æ²¡æœ‰è¢«æ­£ç¡®é‡Šæ”¾**ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚

## âš ï¸ éœ€è¦æ¸…ç†çš„èµ„æºç±»å‹

### 1. å®šæ—¶å™¨ï¼ˆTimerï¼‰
```typescript
// âŒ é—®é¢˜ï¼šå®šæ—¶å™¨æ²¡æœ‰æ¸…ç†
aboutToAppear() {
  this.timer = setInterval(() => {
    // æ›´æ–°æ•°æ®
  }, 1000)
}

// âœ… è§£å†³ï¼šåœ¨ aboutToDisappear ä¸­æ¸…ç†
aboutToDisappear() {
  if (this.timer) {
    clearInterval(this.timer)
    this.timer = undefined
  }
}
```

### 2. AppStorage å¼•ç”¨
```typescript
// âŒ é—®é¢˜ï¼šAppStorage ä¸­çš„å¼•ç”¨æ²¡æœ‰æ¸…ç†
aboutToAppear() {
  AppStorage.setOrCreate('PAGE_REF', this)  // æ³¨å†Œå¼•ç”¨
}

// âœ… è§£å†³ï¼šåœ¨ aboutToDisappear ä¸­æ¸…ç†
aboutToDisappear() {
  AppStorage.setOrCreate('PAGE_REF', null)  // é‡Šæ”¾å¼•ç”¨
}
```

### 3. äº‹ä»¶ç›‘å¬å™¨
```typescript
// âŒ é—®é¢˜ï¼šäº‹ä»¶ç›‘å¬å™¨æ²¡æœ‰ç§»é™¤
aboutToAppear() {
  this.eventBus.on('event', this.handleEvent)
}

// âœ… è§£å†³ï¼šåœ¨ aboutToDisappear ä¸­ç§»é™¤
aboutToDisappear() {
  this.eventBus.off('event', this.handleEvent)
}
```

### 4. å¤§æ•°æ®æ•°ç»„
```typescript
// âŒ é—®é¢˜ï¼šå¤§æ•°æ®æ•°ç»„æ²¡æœ‰æ¸…ç†
@State private largeData: Data[] = []  // å¯èƒ½å ç”¨å¾ˆå¤šå†…å­˜

// âœ… è§£å†³ï¼šåœ¨ aboutToDisappear ä¸­æ¸…ç†
aboutToDisappear() {
  this.largeData = []  // é‡Šæ”¾å†…å­˜
}
```

### 5. Canvas ä¸Šä¸‹æ–‡
```typescript
// âŒ é—®é¢˜ï¼šCanvas ä¸Šä¸‹æ–‡æ²¡æœ‰æ¸…ç†
private ctx: CanvasRenderingContext2D

// âœ… è§£å†³ï¼šåœ¨ aboutToDisappear ä¸­æ¸…ç†
aboutToDisappear() {
  // æ¸…ç† Canvas ç›¸å…³èµ„æº
  this.ctx = null as any
}
```

---

## ğŸ“‹ å„é¡µé¢èµ„æºæ¸…ç†æ£€æŸ¥æ¸…å•

### âœ… HomeContentï¼ˆå·²æ¸…ç†ï¼‰
- âœ… å®šæ—¶å™¨æ¸…ç†ï¼š`timeUpdateTimerId`, `mockSortingInfoTimerId`
- âœ… AppStorage å¼•ç”¨æ¸…ç†ï¼š`HOME_CONTENT_REF`

### âœ… LevelContentï¼ˆå·²æ¸…ç†ï¼‰
- âœ… äº‹ä»¶æ¸…ç†ï¼š`eventHandler.onPageDestroy()`

### âœ… QualityContentï¼ˆå·²æ¸…ç†ï¼‰
- âœ… äº‹ä»¶æ¸…ç†ï¼š`eventHandler.onPageDestroy()`

### âœ… HistoryContentï¼ˆå·²æ·»åŠ æ¸…ç†ï¼‰
- âœ… æ•°æ®æ¸…ç†ï¼š`currentTableData`, `filteredTableData`, `selectedTableData`

### âœ… EndProcessingContentï¼ˆå·²æ·»åŠ æ¸…ç†ï¼‰
- âœ… æ•°æ®æ¸…ç†ï¼š`processingRecords`

### âœ… RealtimeStatsContentï¼ˆå·²æ¸…ç†ï¼‰
- âœ… å®šæ—¶å™¨æ¸…ç†ï¼š`pieTimerId`, `qualityTimerId`, `outletTimerId`

### âœ… DataTablesTabBarï¼ˆå·²æ¸…ç†ï¼‰
- âœ… å®šæ—¶å™¨æ¸…ç†ï¼š`lcFlushTimerId`, `lcTimerId`

### âœ… LiquidCardsAreaï¼ˆå·²æ¸…ç†ï¼‰
- âœ… AppStorage å¼•ç”¨æ¸…ç†ï¼š`LIQUID_CARDS_AREA_REF`

---

## ğŸ”§ æ ‡å‡†èµ„æºæ¸…ç†æ¨¡æ¿

### æ¨¡æ¿ 1ï¼šåŸºç¡€æ¸…ç†ï¼ˆæ— å®šæ—¶å™¨ã€æ— å¼•ç”¨ï¼‰
```typescript
aboutToDisappear(): void {
  // æ¸…ç†æ•°æ®ï¼Œé‡Šæ”¾å†…å­˜
  this.largeDataArray = []
  this.cachedData = null
  console.log('PageName: é¡µé¢èµ„æºå·²æ¸…ç†')
}
```

### æ¨¡æ¿ 2ï¼šåŒ…å«å®šæ—¶å™¨æ¸…ç†
```typescript
aboutToDisappear(): void {
  // æ¸…ç†å®šæ—¶å™¨
  if (this.timerId) {
    clearInterval(this.timerId)
    this.timerId = undefined
  }
  if (this.updateTimerId) {
    clearInterval(this.updateTimerId)
    this.updateTimerId = undefined
  }
  
  // æ¸…ç†æ•°æ®
  this.dataArray = []
  console.log('PageName: é¡µé¢èµ„æºå·²æ¸…ç†')
}
```

### æ¨¡æ¿ 3ï¼šåŒ…å« AppStorage å¼•ç”¨æ¸…ç†
```typescript
aboutToAppear(): void {
  // æ³¨å†Œå¼•ç”¨
  AppStorage.setOrCreate('PAGE_REF', this)
}

aboutToDisappear(): void {
  // æ¸…ç†å®šæ—¶å™¨
  if (this.timerId) {
    clearInterval(this.timerId)
    this.timerId = undefined
  }
  
  // é‡Šæ”¾ AppStorage å¼•ç”¨
  AppStorage.setOrCreate('PAGE_REF', null)
  
  // æ¸…ç†æ•°æ®
  this.dataArray = []
  console.log('PageName: é¡µé¢èµ„æºå·²æ¸…ç†')
}
```

### æ¨¡æ¿ 4ï¼šå®Œæ•´æ¸…ç†ï¼ˆå®šæ—¶å™¨ + å¼•ç”¨ + äº‹ä»¶ + æ•°æ®ï¼‰
```typescript
aboutToAppear(): void {
  // æ³¨å†Œå¼•ç”¨
  AppStorage.setOrCreate('PAGE_REF', this)
  
  // æ³¨å†Œäº‹ä»¶ç›‘å¬
  this.eventBus.on('event', this.handleEvent)
  
  // å¯åŠ¨å®šæ—¶å™¨
  this.timerId = setInterval(() => {
    this.updateData()
  }, 1000)
}

aboutToDisappear(): void {
  // 1. æ¸…ç†å®šæ—¶å™¨
  if (this.timerId) {
    clearInterval(this.timerId)
    this.timerId = undefined
  }
  if (this.updateTimerId) {
    clearInterval(this.updateTimerId)
    this.updateTimerId = undefined
  }
  
  // 2. ç§»é™¤äº‹ä»¶ç›‘å¬
  this.eventBus.off('event', this.handleEvent)
  
  // 3. é‡Šæ”¾ AppStorage å¼•ç”¨
  AppStorage.setOrCreate('PAGE_REF', null)
  
  // 4. æ¸…ç†å¤§æ•°æ®
  this.largeDataArray = []
  this.cachedData = null
  
  // 5. æ¸…ç† Canvas ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœæœ‰ï¼‰
  this.ctx = null as any
  
  console.log('PageName: é¡µé¢èµ„æºå·²æ¸…ç†')
}
```

---

## ğŸ” å¦‚ä½•æ£€æŸ¥èµ„æºæ˜¯å¦è¢«æ¸…ç†

### æ–¹æ³• 1ï¼šä½¿ç”¨ DevEco Studio æ€§èƒ½åˆ†æ
```
1. æ‰“å¼€ DevEco Studio
2. è¿è¡Œåº”ç”¨
3. åˆ‡æ¢åˆ°æ€§èƒ½åˆ†æå·¥å…·
4. è§‚å¯Ÿå†…å­˜å ç”¨
5. åˆ‡æ¢é¡µé¢ï¼Œè§‚å¯Ÿå†…å­˜æ˜¯å¦ä¸‹é™
```

### æ–¹æ³• 2ï¼šæ·»åŠ æ—¥å¿—
```typescript
aboutToDisappear(): void {
  console.log('PageName: å¼€å§‹æ¸…ç†èµ„æº')
  
  // æ¸…ç†èµ„æº
  if (this.timerId) {
    clearInterval(this.timerId)
    console.log('PageName: å®šæ—¶å™¨å·²æ¸…ç†')
  }
  
  this.dataArray = []
  console.log('PageName: æ•°æ®å·²æ¸…ç†')
  
  console.log('PageName: èµ„æºæ¸…ç†å®Œæˆ')
}
```

### æ–¹æ³• 3ï¼šæ£€æŸ¥ AppStorage
```typescript
// åœ¨é¡µé¢åˆ‡æ¢æ—¶æ£€æŸ¥ AppStorage ä¸­çš„å¼•ç”¨
aboutToDisappear(): void {
  const ref = AppStorage.get('PAGE_REF')
  if (ref) {
    console.warn('âš ï¸ è­¦å‘Šï¼šé¡µé¢å¼•ç”¨æœªæ¸…ç†ï¼')
    AppStorage.setOrCreate('PAGE_REF', null)
  }
}
```

---

## ğŸ“Š èµ„æºæ¸…ç†æ•ˆæœå¯¹æ¯”

### ä¸æ¸…ç†èµ„æºï¼ˆé—®é¢˜ï¼‰
```
åˆ‡æ¢åˆ° level é¡µé¢æ—¶ï¼š
- HomeContent çš„å®šæ—¶å™¨è¿˜åœ¨è¿è¡Œ âŒ
- HomeContent çš„ AppStorage å¼•ç”¨è¿˜åœ¨ âŒ
- HomeContent çš„æ•°æ®è¿˜åœ¨å†…å­˜ âŒ
- å†…å­˜å ç”¨ï¼šHomeContent(10MB) + LevelContent(8MB) = 18MB âŒ
```

### æ­£ç¡®æ¸…ç†èµ„æºï¼ˆè§£å†³ï¼‰
```
åˆ‡æ¢åˆ° level é¡µé¢æ—¶ï¼š
- HomeContent çš„å®šæ—¶å™¨å·²åœæ­¢ âœ…
- HomeContent çš„ AppStorage å¼•ç”¨å·²é‡Šæ”¾ âœ…
- HomeContent çš„æ•°æ®å·²æ¸…ç† âœ…
- å†…å­˜å ç”¨ï¼šåªæœ‰ LevelContent(8MB) âœ…
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ¯ä¸ªé¡µé¢éƒ½è¦æœ‰ `aboutToDisappear`
```typescript
// âœ… æ¨èï¼šæ¯ä¸ªé¡µé¢ç»„ä»¶éƒ½è¦å®ç°
@Component
export struct MyPage {
  aboutToAppear() {
    // åˆå§‹åŒ–
  }
  
  aboutToDisappear() {
    // æ¸…ç†èµ„æºï¼ˆå¿…é¡»ï¼‰
  }
}
```

### 2. æ¸…ç†é¡ºåº
```typescript
aboutToDisappear(): void {
  // 1. å…ˆåœæ­¢å®šæ—¶å™¨ï¼ˆé¿å…ç»§ç»­è§¦å‘ï¼‰
  if (this.timerId) {
    clearInterval(this.timerId)
  }
  
  // 2. ç§»é™¤äº‹ä»¶ç›‘å¬ï¼ˆé¿å…ç»§ç»­æ¥æ”¶äº‹ä»¶ï¼‰
  this.eventBus.off('event', this.handleEvent)
  
  // 3. é‡Šæ”¾ AppStorage å¼•ç”¨ï¼ˆé¿å…é˜»æ­¢ GCï¼‰
  AppStorage.setOrCreate('PAGE_REF', null)
  
  // 4. æœ€åæ¸…ç†æ•°æ®ï¼ˆé‡Šæ”¾å†…å­˜ï¼‰
  this.dataArray = []
}
```

### 3. ä½¿ç”¨é˜²å¾¡æ€§ç¼–ç¨‹
```typescript
aboutToDisappear(): void {
  // âœ… æ¨èï¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨å†æ¸…ç†
  if (this.timerId) {
    clearInterval(this.timerId)
    this.timerId = undefined  // è®¾ç½®ä¸º undefined
  }
  
  // âŒ ä¸æ¨èï¼šç›´æ¥æ¸…ç†ï¼ˆå¯èƒ½æŠ¥é”™ï¼‰
  clearInterval(this.timerId)  // å¦‚æœ timerId æ˜¯ nullï¼Œå¯èƒ½æœ‰é—®é¢˜
}
```

### 4. æ·»åŠ æ—¥å¿—ä¾¿äºè°ƒè¯•
```typescript
aboutToDisappear(): void {
  console.log('PageName: å¼€å§‹æ¸…ç†èµ„æº')
  
  // æ¸…ç†é€»è¾‘
  if (this.timerId) {
    clearInterval(this.timerId)
    console.log('PageName: å®šæ—¶å™¨å·²æ¸…ç†')
  }
  
  console.log('PageName: èµ„æºæ¸…ç†å®Œæˆ')
}
```

---

## ğŸš¨ å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šå®šæ—¶å™¨è¿˜åœ¨è¿è¡Œ
**ç—‡çŠ¶**ï¼šåˆ‡æ¢åˆ°å…¶ä»–é¡µé¢åï¼ŒåŸé¡µé¢çš„å®šæ—¶å™¨è¿˜åœ¨è§¦å‘

**åŸå› **ï¼šæ²¡æœ‰åœ¨ `aboutToDisappear` ä¸­æ¸…ç†å®šæ—¶å™¨

**è§£å†³**ï¼š
```typescript
aboutToDisappear(): void {
  if (this.timerId) {
    clearInterval(this.timerId)
    this.timerId = undefined
  }
}
```

### é—®é¢˜ 2ï¼šAppStorage å¼•ç”¨é˜»æ­¢ GC
**ç—‡çŠ¶**ï¼šé¡µé¢åˆ‡æ¢åï¼Œå†…å­˜æ²¡æœ‰ä¸‹é™

**åŸå› **ï¼šAppStorage ä¸­çš„å¼•ç”¨é˜»æ­¢äº†åƒåœ¾å›æ”¶

**è§£å†³**ï¼š
```typescript
aboutToDisappear(): void {
  AppStorage.setOrCreate('PAGE_REF', null)
}
```

### é—®é¢˜ 3ï¼šå¤§æ•°æ®æ•°ç»„æ²¡æœ‰æ¸…ç†
**ç—‡çŠ¶**ï¼šåˆ‡æ¢é¡µé¢åï¼Œå†…å­˜å ç”¨ä»ç„¶å¾ˆé«˜

**åŸå› **ï¼šå¤§æ•°æ®æ•°ç»„è¿˜åœ¨å†…å­˜ä¸­

**è§£å†³**ï¼š
```typescript
aboutToDisappear(): void {
  this.largeDataArray = []  // æ¸…ç©ºæ•°ç»„ï¼Œé‡Šæ”¾å†…å­˜
}
```

---

## ğŸ“ æ£€æŸ¥æ¸…å•

åœ¨å®ç°é¡µé¢æ‡’åŠ è½½åï¼Œç¡®ä¿ï¼š

- [ ] æ¯ä¸ªé¡µé¢éƒ½æœ‰ `aboutToDisappear` æ–¹æ³•
- [ ] æ‰€æœ‰å®šæ—¶å™¨éƒ½åœ¨ `aboutToDisappear` ä¸­æ¸…ç†
- [ ] æ‰€æœ‰ AppStorage å¼•ç”¨éƒ½åœ¨ `aboutToDisappear` ä¸­é‡Šæ”¾
- [ ] æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨éƒ½åœ¨ `aboutToDisappear` ä¸­ç§»é™¤
- [ ] å¤§æ•°æ®æ•°ç»„åœ¨ `aboutToDisappear` ä¸­æ¸…ç©º
- [ ] Canvas ä¸Šä¸‹æ–‡åœ¨ `aboutToDisappear` ä¸­æ¸…ç†
- [ ] æ·»åŠ äº†æ¸…ç†æ—¥å¿—ä¾¿äºè°ƒè¯•
- [ ] æµ‹è¯•äº†é¡µé¢åˆ‡æ¢æ—¶çš„å†…å­˜å ç”¨

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `entry/src/main/ets/pages/Home.ets` - é¡µé¢æ‡’åŠ è½½å®ç°
- `entry/src/main/ets/pages/home/HomeContent.ets` - èµ„æºæ¸…ç†ç¤ºä¾‹
- `entry/src/main/ets/pages/history/HistoryContent.ets` - èµ„æºæ¸…ç†ç¤ºä¾‹
- `entry/src/main/ets/pages/endprocessing/EndProcessingContent.ets` - èµ„æºæ¸…ç†ç¤ºä¾‹

