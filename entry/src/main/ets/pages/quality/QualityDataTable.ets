import { OmniThemeManager, OmniThemeType, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { getCurrentTheme as resolveTheme } from '../../utils/theme/ThemeUtils'
import { OMNI_THEME_KEY, OMNI_THEME_TYPE_KEY, OMNI_THEME_VERSION_KEY } from '../../utils/theme/useOmniTheme'
import { AppleDesignStyle } from '../../utils/theme/AppleDesignStyle'
import { QualityLevelData, CustomComponentConfig, CustomComponentType } from './QualityConstants'
import { t } from '../../utils/i18n/I18nManager'

@Component
export struct QualityDataTable {
  @Prop qualityLevels: QualityLevelData[] = []
  onDataUpdate?: (data: QualityLevelData, index: number) => void
  onDataClick?: (data: QualityLevelData, index: number) => void

  @StorageLink(OMNI_THEME_KEY) consumedTheme: ExtendedOmniThemeStyle = OmniThemeManager.getInstance().getCurrentTheme()
  @StorageLink(OMNI_THEME_TYPE_KEY) consumedThemeType: OmniThemeType = OmniThemeManager.getInstance().getCurrentThemeType()

  @StorageLink(OMNI_THEME_VERSION_KEY) themeVersion: number = 0

  private lastCount: number = 0
  @State private levelNameInputs: string[] = []

  getCurrentTheme(): ExtendedOmniThemeStyle {
    return resolveTheme(this.consumedTheme)
  }

  @Builder
  private buildTableHeader() {
    Row() {
      Text(t('ç­‰çº§åç§°', 'ç­‰çº§åç§°'))
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .textAlign(TextAlign.Center)
        .width('20%')
        .padding({ left: 4, right: 4, top: 4, bottom: 4 })

      // åˆ†éš”çº¿
      Divider()
        .vertical(true)
        .height(60)
        .color(this.getCurrentTheme().borderColor)

      Text(t('é¢œè‰²ç­‰çº§', 'é¢œè‰²ç­‰çº§'))
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .textAlign(TextAlign.Center)
        .layoutWeight(1)
        .padding({ left: 4, right: 4, top: 4, bottom: 4 })

      // åˆ†éš”çº¿
      Divider()
        .vertical(true)
        .height(60)
        .color(this.getCurrentTheme().borderColor)

      Text(t('ç³–åº¦ç­‰çº§', 'ç³–åº¦ç­‰çº§'))
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .textAlign(TextAlign.Center)
        .layoutWeight(1)
        .padding({ left: 4, right: 4, top: 4, bottom: 4 })
    }
    .width('100%')
    .height(40) // è®¾ç½®å›ºå®šé«˜åº¦
    .padding(0)
    .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })
    .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
  }

  /**
   * æ„å»ºè‡ªå®šä¹‰ç»„ä»¶
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ ¹æ®é…ç½®åŠ¨æ€æ¸²æŸ“ä¸åŒç±»å‹çš„è‡ªå®šä¹‰ç»„ä»¶
   * - æ”¯æŒæŒ‰é’®ã€å¼€å…³ã€è¾“å…¥æ¡†ã€ä¸‹æ‹‰é€‰æ‹©ç­‰
   * - å¤„ç†ç»„ä»¶äº‹ä»¶å’Œæ•°æ®åŒæ­¥
   * 
   * @param config è‡ªå®šä¹‰ç»„ä»¶é…ç½®
   * @param data æ•°æ®å¯¹è±¡
   * @param index æ•°æ®ç´¢å¼•
   * @returns è‡ªå®šä¹‰ç»„ä»¶
   */
  @Builder
  private buildCustomComponent(config: CustomComponentConfig, data: QualityLevelData, index: number) {
    if (config.type === CustomComponentType.BUTTON) {
      // æŒ‰é’®ç»„ä»¶
      Button(config.label)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.getCurrentTheme().textColor)
        .backgroundColor(this.getCurrentTheme().primary)
        .borderRadius(AppleDesignStyle.BORDER_RADIUS_SMALL) // Appleé£æ ¼ï¼šå°åœ†è§’
        .padding({ left: 12, right: 12, top: 6, bottom: 6 })
        .enabled(config.enabled ?? true)
        .onClick(() => {
          console.log(`æŒ‰é’®ç‚¹å‡»: ${config.label}, ç­‰çº§: ${data.levelName}`)
          // è¿™é‡Œå¯ä»¥æ·»åŠ æŒ‰é’®ç‚¹å‡»çš„å¤„ç†é€»è¾‘
        })
    } else if (config.type === CustomComponentType.SWITCH) {
      // å¼€å…³ç»„ä»¶
      Row() {
        Text(config.label)
          .fontSize(16)
          .fontColor(this.getCurrentTheme().textColor)
          .margin({ right: 8 })
        
        Toggle({ type: ToggleType.Switch, isOn: config.value as boolean })
          .onChange((isOn: boolean) => {
            console.log(`å¼€å…³åˆ‡æ¢: ${config.label}, çŠ¶æ€: ${isOn}, ç­‰çº§: ${data.levelName}`)
            // è¿™é‡Œå¯ä»¥æ·»åŠ å¼€å…³çŠ¶æ€å˜åŒ–çš„å¤„ç†é€»è¾‘
          })
      }
      .alignItems(VerticalAlign.Center)
    } else if (config.type === CustomComponentType.INPUT) {
      // è¾“å…¥æ¡†ç»„ä»¶
      TextInput({ placeholder: config.placeholder ?? t('è¯·è¾“å…¥', 'è¯·è¾“å…¥') })
        .fontSize(16)
        .fontColor(this.getCurrentTheme().textColor)
        .backgroundColor(this.getCurrentTheme().surfaceColor)
        .border({ width: AppleDesignStyle.BORDER_WIDTH_THIN, color: this.getCurrentTheme().borderColor }) // Appleé£æ ¼ï¼šç»†è¾¹æ¡†
        .borderRadius(AppleDesignStyle.BORDER_RADIUS_SMALL) // Appleé£æ ¼ï¼šå°åœ†è§’
        .padding({ left: 8, right: 8, top: 6, bottom: 6 })
        .onChange((value: string) => {
          console.log(`è¾“å…¥æ¡†å˜åŒ–: ${config.label}, å€¼: ${value}, ç­‰çº§: ${data.levelName}`)
          // è¿™é‡Œå¯ä»¥æ·»åŠ è¾“å…¥æ¡†å€¼å˜åŒ–çš„å¤„ç†é€»è¾‘
        })
    } else if (config.type === CustomComponentType.SELECT) {
      // ä¸‹æ‹‰é€‰æ‹©ç»„ä»¶ - ä½¿ç”¨ç®€å•çš„Textæ˜¾ç¤ºï¼Œç‚¹å‡»æ—¶å¼¹å‡ºé€‰æ‹©
      Text(config.value as string)
        .fontSize(16)
        .fontColor(this.getCurrentTheme().textColor)
        .backgroundColor(this.getCurrentTheme().surfaceColor)
        .border({ width: AppleDesignStyle.BORDER_WIDTH_THIN, color: this.getCurrentTheme().borderColor }) // Appleé£æ ¼ï¼šç»†è¾¹æ¡†
        .borderRadius(AppleDesignStyle.BORDER_RADIUS_SMALL) // Appleé£æ ¼ï¼šå°åœ†è§’
        .padding({ left: 8, right: 8, top: 6, bottom: 6 })
        .onClick(() => {
          console.log(`ä¸‹æ‹‰é€‰æ‹©: ${config.label}, å½“å‰å€¼: ${config.value}, ç­‰çº§: ${data.levelName}`)
          // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸‹æ‹‰é€‰æ‹©å˜åŒ–çš„å¤„ç†é€»è¾‘
        })
    } else {
      // é»˜è®¤æ–‡æœ¬æ˜¾ç¤º
      Text(String(config.value))
        .fontSize(16)
        .fontColor(this.getCurrentTheme().textColor)
        .textAlign(TextAlign.Center)
    }
  }

  @Builder
  private buildListItem(data: QualityLevelData, index: number) {
    Row() {
      // ç­‰çº§åç§°åˆ— - å¯ç¼–è¾‘
      TextInput({ text: this.levelNameInputs[index] ?? data.levelName })
        .type(InputType.Number)
        .fontSize(24)
        .fontColor(this.getCurrentTheme().textColor)
        .backgroundColor(Color.Transparent)
        .textAlign(TextAlign.Center)
        .width('20%')
        .padding({ left: 4, right: 4, top: 6, bottom: 6 })
        .enterKeyType(EnterKeyType.Done)
        .onChange((value: string) => {
          // ä»…ä¿ç•™æ•°å­—ï¼ˆå…è®¸ç©ºä¸²ï¼‰
          const numeric = value.replace(/\D+/g, '')
          this.levelNameInputs[index] = numeric
        })
        .onSubmit((enterKey: EnterKeyType) => {
          // ä½¿ç”¨å½“å‰å—æ§å€¼ä½œä¸ºæäº¤å†…å®¹
          const current = this.levelNameInputs[index] ?? ''
          const numeric = current.replace(/\D+/g, '')
          this.levelNameInputs[index] = numeric
          if (this.onDataUpdate) {
            this.onDataUpdate({
              levelName: numeric,
              colorLevel: data.colorLevel,
              sugarLevel: data.sugarLevel
            }, index)
          }
        })
        .onBlur(() => {
          const current = this.levelNameInputs[index] ?? ''
          const numeric = current.replace(/\D+/g, '')
          this.levelNameInputs[index] = numeric
          if (this.onDataUpdate) {
            this.onDataUpdate({
              levelName: numeric,
              colorLevel: data.colorLevel,
              sugarLevel: data.sugarLevel
            }, index)
          }
        })

      // åˆ†éš”çº¿
      Divider()
        .vertical(true)
        .height(60)
        .color(this.getCurrentTheme().borderColor)

      // é¢œè‰²ç­‰çº§åˆ— - æ”¯æŒè‡ªå®šä¹‰ç»„ä»¶
      if (typeof data.colorLevel === 'string') {
        // ä¼ ç»Ÿæ–‡æœ¬æ˜¾ç¤º
      Text(data.colorLevel)
        .fontSize(24)
        .fontColor(this.getCurrentTheme().textColor)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
          .padding({ left: 4, right: 4, top: 6, bottom: 6 })
      } else {
        // è‡ªå®šä¹‰ç»„ä»¶æ˜¾ç¤º
        Column() {
          this.buildCustomComponent(data.colorLevel as CustomComponentConfig, data, index)
        }
        .layoutWeight(1)
        .padding({ left: 4, right: 4, top: 6, bottom: 6 })
      }

      // åˆ†éš”çº¿
      Divider()
        .vertical(true)
        .height(60)
        .color(this.getCurrentTheme().borderColor)

      // ç³–åº¦ç­‰çº§åˆ—
      Text(data.sugarLevel)
        .fontSize(24)
        .fontColor(this.getCurrentTheme().textColor)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
        .padding({ left: 4, right: 4, top: 6, bottom: 6 })
    }
    .width('100%')
    .height(60)
    .padding(0)
    .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })
    .onClick(() => {
      if (this.onDataClick) {
        this.onDataClick(data, index)
      }
    })
  }

  build() {
    Column() {
      // å›ºå®šè¡¨å¤´
      this.buildTableHeader()

      // å¯æ»šåŠ¨æ•°æ®åŒºåŸŸ - ä½¿ç”¨Listç»„ä»¶
      List() {
        ForEach(this.qualityLevels, (data: QualityLevelData, index: number) => {
          ListItem() {
            this.buildListItem(data, index)
          }
          }, (data: QualityLevelData, index: number) => `${index}`)
        }
        .width('100%')
      .layoutWeight(1) // ä½¿ç”¨layoutWeightå¡«æ»¡å¯ç”¨ç©ºé—´
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
      .friction(100)
      .divider({
        strokeWidth: 1,
        color: this.getCurrentTheme().borderColor,
        startMargin: 0,
        endMargin: 0
      })
    }
    .width('100%')
    .layoutWeight(1)
  }

  aboutToAppear(): void {
    // åˆå§‹åŒ–å—æ§è¾“å…¥æ•°ç»„
    this.levelNameInputs = (this.qualityLevels || []).map(item => (item.levelName ?? '').replace(/\D+/g, ''))
    this.lastCount = this.qualityLevels ? this.qualityLevels.length : 0
    console.log(`ğŸ“Š å“è´¨æ•°æ®è¡¨æ ¼åˆå§‹åŒ– - æ•°æ®æ¡æ•°: ${this.lastCount} æ¡`)
  }

  aboutToRender(): void {
    const current = this.qualityLevels ? this.qualityLevels.length : 0
    if (current !== this.lastCount) {
      // æ•°æ®æ¡æ•°å˜åŒ–æ—¶æ›´æ–°è®¡æ•°
      this.lastCount = current
      console.log(`ğŸ“Š å“è´¨æ•°æ®è¡¨æ ¼ - æ•°æ®æ¡æ•°: ${current} æ¡`)
    }
    // åŒæ­¥å—æ§è¾“å…¥æ•°ç»„é•¿åº¦ä¸å€¼ï¼Œé¿å…å› ä¸ºæ•°æ®åˆ·æ–°å¯¼è‡´è·³åŠ¨
    const source = this.qualityLevels || []
    if (!this.levelNameInputs || this.levelNameInputs.length !== source.length) {
      this.levelNameInputs = source.map(item => (item.levelName ?? '').replace(/\D+/g, ''))
    } else {
      // å¯¹é½å†…å®¹ï¼ˆå½“å¤–éƒ¨æ•°æ®å˜åŒ–æ—¶ï¼‰
      for (let i = 0; i < source.length; i++) {
        const normalized = (source[i].levelName ?? '').replace(/\D+/g, '')
        if (this.levelNameInputs[i] === undefined) {
          this.levelNameInputs[i] = normalized
        }
      }
    }
  }
}
