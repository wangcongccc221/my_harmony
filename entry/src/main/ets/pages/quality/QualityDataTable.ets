/**
 * å“è´¨é¡µé¢æ•°æ®è¡¨æ ¼ç»„ä»¶
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - æ˜¾ç¤ºå“è´¨ç­‰çº§æ•°æ®è¡¨æ ¼
 * - åŒ…å«ç­‰çº§åç§°ã€é¢œè‰²ç­‰çº§ã€ç³–åº¦ç­‰çº§ç­‰åˆ—
 * - æ”¯æŒæ»šåŠ¨æ˜¾ç¤ºå’Œä¸»é¢˜é€‚é…
 * 
 * ä¸»è¦ç‰¹æ€§ï¼š
 * - è¡¨æ ¼æ˜¾ç¤ºï¼šæ˜¾ç¤ºå“è´¨ç­‰çº§æ•°æ®
 * - è¡¨å¤´å›ºå®šï¼šè¡¨å¤´ä¸æ»šåŠ¨ï¼Œå†…å®¹å¯æ»šåŠ¨
 * - ä¸»é¢˜é€‚é…ï¼šæ”¯æŒæ˜æš—ä¸»é¢˜åˆ‡æ¢
 * - å“åº”å¼è®¾è®¡ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸
 * - æ•°æ®ç»‘å®šï¼šæ”¯æŒåŠ¨æ€æ•°æ®æ›´æ–°
 * 
 * ä½¿ç”¨åœºæ™¯ï¼š
 * - å“è´¨é¡µé¢æ•°æ®è¡¨æ ¼æ˜¾ç¤º
 * - å“è´¨ç­‰çº§æ•°æ®å±•ç¤º
 * - æ•°æ®å¯¹æ¯”å’Œåˆ†æ
 * 
 * ç»„ä»¶ç»“æ„ï¼š
 * - è¡¨å¤´åŒºåŸŸï¼šæ˜¾ç¤ºåˆ—æ ‡é¢˜ï¼ˆç­‰çº§åç§°ã€é¢œè‰²ç­‰çº§ã€ç³–åº¦ç­‰çº§ï¼‰
 * - æ•°æ®åŒºåŸŸï¼šæ˜¾ç¤ºå…·ä½“çš„å“è´¨ç­‰çº§æ•°æ®
 * - æ»šåŠ¨åŒºåŸŸï¼šæ”¯æŒå‚ç›´æ»šåŠ¨æŸ¥çœ‹æ›´å¤šæ•°æ®
 * 
 * æ•°æ®æ ¼å¼ï¼š
 * - ç­‰çº§åç§°ï¼š1-7ç­‰çº§ç¼–å·
 * - é¢œè‰²ç­‰çº§ï¼šä¼˜ç§€ã€è‰¯å¥½ã€ä¸€èˆ¬ã€è¾ƒå·®ã€å·®ã€æå·®ã€é›¶ä»·å€¼
 * - ç³–åº¦ç­‰çº§ï¼šé«˜ç³–åº¦ã€ä¸­ç³–åº¦ã€ä½ç³–åº¦ã€æä½ç³–åº¦ã€æ— ç³–åº¦ã€è´Ÿç³–åº¦ã€é›¶ä»·å€¼
 * 
 * æ ·å¼ç‰¹æ€§ï¼š
 * - å“åº”å¼è®¾è®¡ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸
 * - ä¸»é¢˜é€‚é…ï¼šæ”¯æŒæ˜æš—ä¸»é¢˜
 * - è¡¨æ ¼æ ·å¼ï¼šç»Ÿä¸€çš„è¡¨æ ¼è®¾è®¡
 * - æ»šåŠ¨ä¼˜åŒ–ï¼šæµç•…çš„æ»šåŠ¨ä½“éªŒ
 */

import { BaseComponentHelper } from '../../components/common/BaseComponent'
import { OmniThemeManager, OmniThemeType, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { OMNI_THEME_KEY, OMNI_THEME_TYPE_KEY, OMNI_THEME_VERSION_KEY } from '../../utils/theme/useOmniTheme'
import { QualityLevelData, CustomComponentConfig, CustomComponentType } from './QualityConstants'

/**
 * å“è´¨é¡µé¢æ•°æ®è¡¨æ ¼ç»„ä»¶
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - æ˜¾ç¤ºå“è´¨ç­‰çº§æ•°æ®è¡¨æ ¼
 * - åŒ…å«ç­‰çº§åç§°ã€é¢œè‰²ç­‰çº§ã€ç³–åº¦ç­‰çº§ç­‰åˆ—
 * - æ”¯æŒæ»šåŠ¨æ˜¾ç¤ºå’Œä¸»é¢˜é€‚é…
 * 
 * å±æ€§è¯´æ˜ï¼š
 * - qualityLevelsï¼šå“è´¨ç­‰çº§æ•°æ®æ•°ç»„
 * - onDataUpdateï¼šæ•°æ®æ›´æ–°å›è°ƒå‡½æ•°
 * - onDataClickï¼šæ•°æ®ç‚¹å‡»å›è°ƒå‡½æ•°
 * 
 * ä¸»é¢˜æ”¯æŒï¼š
 * - æ”¯æŒæ˜æš—ä¸»é¢˜åˆ‡æ¢
 * - è‡ªåŠ¨é€‚é…ä¸»é¢˜é¢œè‰²
 * - å“åº”ä¸»é¢˜å˜åŒ–
 */
@Component
export struct QualityDataTable {
  // ==================== å±æ€§å®šä¹‰ ====================
  
  /**
   * å“è´¨ç­‰çº§æ•°æ®æ•°ç»„
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨è¦æ˜¾ç¤ºçš„å“è´¨ç­‰çº§æ•°æ®
   * - ç”¨äºæ•°æ®è¡¨æ ¼æ˜¾ç¤º
   * - æ”¯æŒåŠ¨æ€æ›´æ–°
   * 
   * æ•°æ®ç»“æ„ï¼š
   * - æ¯ä¸ªå…ƒç´ åŒ…å«ç­‰çº§åç§°ã€é¢œè‰²ç­‰çº§ã€ç³–åº¦ç­‰çº§
   * - æŒ‰ç…§ç­‰çº§é¡ºåºæ’åˆ—
   * - æ”¯æŒ2-6ä¸ªç­‰çº§çš„åŠ¨æ€æ˜¾ç¤º
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - æ•°æ®è¡¨æ ¼æ˜¾ç¤ºæ•°æ®
   * - æ•°æ®æ›´æ–°å’ŒåŒæ­¥
   * - çŠ¶æ€ç®¡ç†
   */
  @Prop qualityLevels: QualityLevelData[] = []

  // ==================== äº‹ä»¶å›è°ƒ ====================
  
  /**
   * æ•°æ®æ›´æ–°å›è°ƒå‡½æ•°
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å¤„ç†æ•°æ®æ›´æ–°çš„äº‹ä»¶
   * - æ¥æ”¶æ›´æ–°çš„æ•°æ®å’Œç´¢å¼•
   * - å¯é€‰çš„å›è°ƒå‡½æ•°
   * 
   * @param data æ›´æ–°çš„æ•°æ®
   * @param index æ•°æ®ç´¢å¼•
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç”¨æˆ·ç¼–è¾‘æ•°æ®æ—¶
   * - ç¨‹åºè‡ªåŠ¨æ›´æ–°æ•°æ®æ—¶
   */
  onDataUpdate?: (data: QualityLevelData, index: number) => void

  /**
   * æ•°æ®ç‚¹å‡»å›è°ƒå‡½æ•°
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å¤„ç†ç”¨æˆ·ç‚¹å‡»æ•°æ®è¡Œçš„äº‹ä»¶
   * - æ¥æ”¶ç‚¹å‡»çš„æ•°æ®å’Œç´¢å¼•
   * - å¯é€‰çš„å›è°ƒå‡½æ•°
   * 
   * @param data ç‚¹å‡»çš„æ•°æ®
   * @param index æ•°æ®ç´¢å¼•
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç”¨æˆ·é€‰æ‹©æ•°æ®è¡Œæ—¶
   * - ç¨‹åºéœ€è¦å¤„ç†æ•°æ®ç‚¹å‡»æ—¶
   */
  onDataClick?: (data: QualityLevelData, index: number) => void

  // ==================== ä¸»é¢˜ç›¸å…³ ====================
  
  /**
   * å½“å‰ä¸»é¢˜æ ·å¼
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨å½“å‰åº”ç”¨çš„ä¸»é¢˜æ ·å¼
   * - ç”¨äºç»„ä»¶æ ·å¼é€‚é…
   * - è‡ªåŠ¨å“åº”ä¸»é¢˜å˜åŒ–
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç»„ä»¶æ¸²æŸ“æ—¶è·å–ä¸»é¢˜æ ·å¼
   * - ä¸»é¢˜åˆ‡æ¢æ—¶è‡ªåŠ¨æ›´æ–°
   */
  @StorageLink(OMNI_THEME_KEY) consumedTheme: ExtendedOmniThemeStyle = OmniThemeManager.getInstance().getCurrentTheme()

  /**
   * å½“å‰ä¸»é¢˜ç±»å‹
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨å½“å‰åº”ç”¨çš„ä¸»é¢˜ç±»å‹
   * - ç”¨äºä¸»é¢˜ç±»å‹åˆ¤æ–­
   * - è‡ªåŠ¨å“åº”ä¸»é¢˜å˜åŒ–
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ä¸»é¢˜ç±»å‹åˆ¤æ–­æ—¶
   * - ä¸»é¢˜åˆ‡æ¢æ—¶è‡ªåŠ¨æ›´æ–°
   */
  @StorageLink(OMNI_THEME_TYPE_KEY) consumedThemeType: OmniThemeType = OmniThemeManager.getInstance().getCurrentThemeType()

  /**
   * ä¸»é¢˜ç‰ˆæœ¬å·
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨å½“å‰ä¸»é¢˜çš„ç‰ˆæœ¬å·
   * - ç”¨äºä¸»é¢˜æ›´æ–°æ£€æµ‹
   * - è‡ªåŠ¨å“åº”ä¸»é¢˜å˜åŒ–
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ä¸»é¢˜æ›´æ–°æ£€æµ‹æ—¶
   * - ä¸»é¢˜åˆ‡æ¢æ—¶è‡ªåŠ¨æ›´æ–°
   */
  @StorageLink(OMNI_THEME_VERSION_KEY) themeVersion: number = 0

  /**
   * åŸºç¡€ç»„ä»¶åŠ©æ‰‹
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æä¾›åŸºç¡€ç»„ä»¶çš„é€šç”¨åŠŸèƒ½
   * - ç”¨äºä¸»é¢˜è·å–å’Œæ ·å¼å¤„ç†
   * - ç§æœ‰å±æ€§ï¼Œä¸å¯¹å¤–æš´éœ²
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - è·å–å½“å‰ä¸»é¢˜æ—¶
   * - å¤„ç†ç»„ä»¶æ ·å¼æ—¶
   */
  private baseComponentHelper = new BaseComponentHelper()

  // å†…éƒ¨æ»šåŠ¨æ§åˆ¶ï¼šè‡ªåŠ¨ä»é¡¶éƒ¨å¼€å§‹
  private lastCount: number = 0
  // å—æ§è¾“å…¥ï¼šæŒ‰è¡Œå­˜å‚¨â€œç­‰çº§åç§°â€çš„è¾“å…¥å€¼ï¼Œç¡®ä¿ä»…æ•°å­—ä¸ä¸è·³åŠ¨
  @State private levelNameInputs: string[] = []

  // ==================== æ–¹æ³•å®šä¹‰ ====================
  
  /**
   * è·å–å½“å‰ä¸»é¢˜é…ç½®
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - è·å–å½“å‰åº”ç”¨çš„ä¸»é¢˜é…ç½®
   * - è¿”å›ä¸»é¢˜æ ·å¼å¯¹è±¡
   * - ç”¨äºç»„ä»¶æ ·å¼é€‚é…
   * 
   * @returns å½“å‰ä¸»é¢˜æ ·å¼å¯¹è±¡
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç»„ä»¶æ¸²æŸ“æ—¶è·å–ä¸»é¢˜æ ·å¼
   * - æ ·å¼é€‚é…æ—¶è°ƒç”¨
   */
  getCurrentTheme(): ExtendedOmniThemeStyle {
    return this.baseComponentHelper.getCurrentTheme(this.consumedTheme)
  }

  /**
   * æ„å»ºè¡¨å¤´
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ„å»ºå›ºå®šçš„è¡¨å¤´UI
   * - åŒ…å«ç­‰çº§åç§°ã€é¢œè‰²ç­‰çº§ã€ç³–åº¦ç­‰çº§ä¸‰åˆ—
   * - æ”¯æŒä¸»é¢˜é€‚é…
   * 
   * @returns è¡¨å¤´ç»„ä»¶
   */
  @Builder
  private buildTableHeader() {
    Row() {
      Text('ç­‰çº§åç§°')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .textAlign(TextAlign.Center)
        .width('20%')
        .padding({ left: 4, right: 4, top: 4, bottom: 4 })

      // åˆ†éš”çº¿
      Divider()
        .vertical(true)
        .height(60)
        .color(this.getCurrentTheme().borderColor)

      Text('é¢œè‰²ç­‰çº§')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .textAlign(TextAlign.Center)
        .layoutWeight(1)
        .padding({ left: 4, right: 4, top: 4, bottom: 4 })

      // åˆ†éš”çº¿
      Divider()
        .vertical(true)
        .height(60)
        .color(this.getCurrentTheme().borderColor)

      Text('ç³–åº¦ç­‰çº§')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getCurrentTheme().textColor)
        .textAlign(TextAlign.Center)
        .layoutWeight(1)
        .padding({ left: 4, right: 4, top: 4, bottom: 4 })
    }
    .width('100%')
    .height(40) // è®¾ç½®å›ºå®šé«˜åº¦
    .padding(0)
    .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })
    .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
  }

  /**
   * æ„å»ºè‡ªå®šä¹‰ç»„ä»¶
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ ¹æ®é…ç½®åŠ¨æ€æ¸²æŸ“ä¸åŒç±»å‹çš„è‡ªå®šä¹‰ç»„ä»¶
   * - æ”¯æŒæŒ‰é’®ã€å¼€å…³ã€è¾“å…¥æ¡†ã€ä¸‹æ‹‰é€‰æ‹©ç­‰
   * - å¤„ç†ç»„ä»¶äº‹ä»¶å’Œæ•°æ®åŒæ­¥
   * 
   * @param config è‡ªå®šä¹‰ç»„ä»¶é…ç½®
   * @param data æ•°æ®å¯¹è±¡
   * @param index æ•°æ®ç´¢å¼•
   * @returns è‡ªå®šä¹‰ç»„ä»¶
   */
  @Builder
  private buildCustomComponent(config: CustomComponentConfig, data: QualityLevelData, index: number) {
    if (config.type === CustomComponentType.BUTTON) {
      // æŒ‰é’®ç»„ä»¶
      Button(config.label)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.getCurrentTheme().textColor)
        .backgroundColor(this.getCurrentTheme().primary)
        .borderRadius(8)
        .padding({ left: 12, right: 12, top: 6, bottom: 6 })
        .enabled(config.enabled ?? true)
        .onClick(() => {
          console.log(`æŒ‰é’®ç‚¹å‡»: ${config.label}, ç­‰çº§: ${data.levelName}`)
          // è¿™é‡Œå¯ä»¥æ·»åŠ æŒ‰é’®ç‚¹å‡»çš„å¤„ç†é€»è¾‘
        })
    } else if (config.type === CustomComponentType.SWITCH) {
      // å¼€å…³ç»„ä»¶
      Row() {
        Text(config.label)
          .fontSize(16)
          .fontColor(this.getCurrentTheme().textColor)
          .margin({ right: 8 })
        
        Toggle({ type: ToggleType.Switch, isOn: config.value as boolean })
          .onChange((isOn: boolean) => {
            console.log(`å¼€å…³åˆ‡æ¢: ${config.label}, çŠ¶æ€: ${isOn}, ç­‰çº§: ${data.levelName}`)
            // è¿™é‡Œå¯ä»¥æ·»åŠ å¼€å…³çŠ¶æ€å˜åŒ–çš„å¤„ç†é€»è¾‘
          })
      }
      .alignItems(VerticalAlign.Center)
    } else if (config.type === CustomComponentType.INPUT) {
      // è¾“å…¥æ¡†ç»„ä»¶
      TextInput({ placeholder: config.placeholder ?? 'è¯·è¾“å…¥' })
        .fontSize(16)
        .fontColor(this.getCurrentTheme().textColor)
        .backgroundColor(this.getCurrentTheme().surfaceColor)
        .border({ width: 1, color: this.getCurrentTheme().borderColor })
        .borderRadius(6)
        .padding({ left: 8, right: 8, top: 6, bottom: 6 })
        .onChange((value: string) => {
          console.log(`è¾“å…¥æ¡†å˜åŒ–: ${config.label}, å€¼: ${value}, ç­‰çº§: ${data.levelName}`)
          // è¿™é‡Œå¯ä»¥æ·»åŠ è¾“å…¥æ¡†å€¼å˜åŒ–çš„å¤„ç†é€»è¾‘
        })
    } else if (config.type === CustomComponentType.SELECT) {
      // ä¸‹æ‹‰é€‰æ‹©ç»„ä»¶ - ä½¿ç”¨ç®€å•çš„Textæ˜¾ç¤ºï¼Œç‚¹å‡»æ—¶å¼¹å‡ºé€‰æ‹©
      Text(config.value as string)
        .fontSize(16)
        .fontColor(this.getCurrentTheme().textColor)
        .backgroundColor(this.getCurrentTheme().surfaceColor)
        .border({ width: 1, color: this.getCurrentTheme().borderColor })
        .borderRadius(6)
        .padding({ left: 8, right: 8, top: 6, bottom: 6 })
        .onClick(() => {
          console.log(`ä¸‹æ‹‰é€‰æ‹©: ${config.label}, å½“å‰å€¼: ${config.value}, ç­‰çº§: ${data.levelName}`)
          // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸‹æ‹‰é€‰æ‹©å˜åŒ–çš„å¤„ç†é€»è¾‘
        })
    } else {
      // é»˜è®¤æ–‡æœ¬æ˜¾ç¤º
      Text(String(config.value))
        .fontSize(16)
        .fontColor(this.getCurrentTheme().textColor)
        .textAlign(TextAlign.Center)
    }
  }

  /**
   * æ„å»ºåˆ—è¡¨é¡¹
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ„å»ºå•ä¸ªåˆ—è¡¨é¡¹çš„UI
   * - åŒ…å«ç­‰çº§åç§°ã€é¢œè‰²ç­‰çº§ã€ç³–åº¦ç­‰çº§
   * - æ”¯æŒTextInputç¼–è¾‘ã€ç‚¹å‡»äº‹ä»¶å’Œæ ·å¼é€‚é…
   * - æ”¯æŒé¢œè‰²ç­‰çº§çš„è‡ªå®šä¹‰ç»„ä»¶æ¸²æŸ“
   * 
   * @param data æ•°æ®å¯¹è±¡
   * @param index æ•°æ®ç´¢å¼•
   * @returns åˆ—è¡¨é¡¹ç»„ä»¶
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - Listç»„ä»¶çš„æ•°æ®é¡¹æ¸²æŸ“
   * - æ•°æ®ç‚¹å‡»å¤„ç†
   * - æ ·å¼é€‚é…
   * - è‡ªå®šä¹‰ç»„ä»¶æ¸²æŸ“
   */
  @Builder
  private buildListItem(data: QualityLevelData, index: number) {
    Row() {
      // ç­‰çº§åç§°åˆ— - å¯ç¼–è¾‘
      TextInput({ text: this.levelNameInputs[index] ?? data.levelName })
        .type(InputType.Number)
        .fontSize(24)
        .fontColor(this.getCurrentTheme().textColor)
        .backgroundColor(Color.Transparent)
        .textAlign(TextAlign.Center)
        .width('20%')
        .padding({ left: 4, right: 4, top: 6, bottom: 6 })
        .enterKeyType(EnterKeyType.Done)
        .onChange((value: string) => {
          // ä»…ä¿ç•™æ•°å­—ï¼ˆå…è®¸ç©ºä¸²ï¼‰
          const numeric = value.replace(/\D+/g, '')
          this.levelNameInputs[index] = numeric
        })
        .onSubmit((enterKey: EnterKeyType) => {
          // ä½¿ç”¨å½“å‰å—æ§å€¼ä½œä¸ºæäº¤å†…å®¹
          const current = this.levelNameInputs[index] ?? ''
          const numeric = current.replace(/\D+/g, '')
          this.levelNameInputs[index] = numeric
          if (this.onDataUpdate) {
            this.onDataUpdate({
              levelName: numeric,
              colorLevel: data.colorLevel,
              sugarLevel: data.sugarLevel
            }, index)
          }
        })
        .onBlur(() => {
          const current = this.levelNameInputs[index] ?? ''
          const numeric = current.replace(/\D+/g, '')
          this.levelNameInputs[index] = numeric
          if (this.onDataUpdate) {
            this.onDataUpdate({
              levelName: numeric,
              colorLevel: data.colorLevel,
              sugarLevel: data.sugarLevel
            }, index)
          }
        })

      // åˆ†éš”çº¿
      Divider()
        .vertical(true)
        .height(60)
        .color(this.getCurrentTheme().borderColor)

      // é¢œè‰²ç­‰çº§åˆ— - æ”¯æŒè‡ªå®šä¹‰ç»„ä»¶
      if (typeof data.colorLevel === 'string') {
        // ä¼ ç»Ÿæ–‡æœ¬æ˜¾ç¤º
      Text(data.colorLevel)
        .fontSize(24)
        .fontColor(this.getCurrentTheme().textColor)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
          .padding({ left: 4, right: 4, top: 6, bottom: 6 })
      } else {
        // è‡ªå®šä¹‰ç»„ä»¶æ˜¾ç¤º
        Column() {
          this.buildCustomComponent(data.colorLevel as CustomComponentConfig, data, index)
        }
        .layoutWeight(1)
        .padding({ left: 4, right: 4, top: 6, bottom: 6 })
      }

      // åˆ†éš”çº¿
      Divider()
        .vertical(true)
        .height(60)
        .color(this.getCurrentTheme().borderColor)

      // ç³–åº¦ç­‰çº§åˆ—
      Text(data.sugarLevel)
        .fontSize(24)
        .fontColor(this.getCurrentTheme().textColor)
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
        .padding({ left: 4, right: 4, top: 6, bottom: 6 })
    }
    .width('100%')
    .height(60)
    .padding(0)
    .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })
    .onClick(() => {
      if (this.onDataClick) {
        this.onDataClick(data, index)
      }
    })
  }

  /**
   * æ„å»ºç»„ä»¶UI
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ„å»ºå“è´¨é¡µé¢æ•°æ®è¡¨æ ¼çš„UIç»“æ„
   * - ä½¿ç”¨List + ListItemå®ç°é«˜æ€§èƒ½è¡¨æ ¼
   * - åŒ…å«å›ºå®šè¡¨å¤´å’Œå¯æ»šåŠ¨æ•°æ®åŒºåŸŸ
   * - æ”¯æŒæ»šåŠ¨æ˜¾ç¤ºå’Œä¸»é¢˜é€‚é…
   * 
   * ç»„ä»¶ç»“æ„ï¼š
   * - è¡¨å¤´åŒºåŸŸï¼šæ˜¾ç¤ºåˆ—æ ‡é¢˜ï¼ˆç­‰çº§åç§°ã€é¢œè‰²ç­‰çº§ã€ç³–åº¦ç­‰çº§ï¼‰
   * - æ•°æ®åŒºåŸŸï¼šä½¿ç”¨Listç»„ä»¶æ˜¾ç¤ºå…·ä½“çš„å“è´¨ç­‰çº§æ•°æ®
   * - æ»šåŠ¨åŒºåŸŸï¼šListå†…ç½®æ»šåŠ¨ï¼Œæ”¯æŒå‚ç›´æ»šåŠ¨æŸ¥çœ‹æ›´å¤šæ•°æ®
   * 
   * æ ·å¼ç‰¹æ€§ï¼š
   * - å“åº”å¼è®¾è®¡ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸
   * - ä¸»é¢˜é€‚é…ï¼šæ”¯æŒæ˜æš—ä¸»é¢˜
   * - è¡¨æ ¼æ ·å¼ï¼šç»Ÿä¸€çš„è¡¨æ ¼è®¾è®¡
   * - æ»šåŠ¨ä¼˜åŒ–ï¼šListå†…ç½®è™šæ‹ŸåŒ–ï¼Œæµç•…çš„æ»šåŠ¨ä½“éªŒ
   * 
   * äº‹ä»¶å¤„ç†ï¼š
   * - æ•°æ®è¡Œç‚¹å‡»ï¼šè§¦å‘onDataClickäº‹ä»¶
   * - æ•°æ®æ›´æ–°ï¼šè§¦å‘onDataUpdateäº‹ä»¶
   * - TextInputç¼–è¾‘ï¼šæ”¯æŒå®æ—¶ç¼–è¾‘å’ŒéªŒè¯
   */
  build() {
    Column() {
      // å›ºå®šè¡¨å¤´
      this.buildTableHeader()

      // å¯æ»šåŠ¨æ•°æ®åŒºåŸŸ - ä½¿ç”¨Listç»„ä»¶
      List() {
        ForEach(this.qualityLevels, (data: QualityLevelData, index: number) => {
          ListItem() {
            this.buildListItem(data, index)
          }
          }, (data: QualityLevelData, index: number) => `${index}`)
        }
        .width('100%')
      .layoutWeight(1) // ä½¿ç”¨layoutWeightå¡«æ»¡å¯ç”¨ç©ºé—´
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
      .friction(100)
      .divider({
        strokeWidth: 1,
        color: this.getCurrentTheme().borderColor,
        startMargin: 0,
        endMargin: 0
      })
    }
    .width('100%')
    .layoutWeight(1)
  }

  aboutToAppear(): void {
    // åˆå§‹åŒ–å—æ§è¾“å…¥æ•°ç»„
    this.levelNameInputs = (this.qualityLevels || []).map(item => (item.levelName ?? '').replace(/\D+/g, ''))
    this.lastCount = this.qualityLevels ? this.qualityLevels.length : 0
    console.log(`ğŸ“Š å“è´¨æ•°æ®è¡¨æ ¼åˆå§‹åŒ– - æ•°æ®æ¡æ•°: ${this.lastCount} æ¡`)
  }

  aboutToRender(): void {
    const current = this.qualityLevels ? this.qualityLevels.length : 0
    if (current !== this.lastCount) {
      // æ•°æ®æ¡æ•°å˜åŒ–æ—¶æ›´æ–°è®¡æ•°
      this.lastCount = current
      console.log(`ğŸ“Š å“è´¨æ•°æ®è¡¨æ ¼ - æ•°æ®æ¡æ•°: ${current} æ¡`)
    }
    // åŒæ­¥å—æ§è¾“å…¥æ•°ç»„é•¿åº¦ä¸å€¼ï¼Œé¿å…å› ä¸ºæ•°æ®åˆ·æ–°å¯¼è‡´è·³åŠ¨
    const source = this.qualityLevels || []
    if (!this.levelNameInputs || this.levelNameInputs.length !== source.length) {
      this.levelNameInputs = source.map(item => (item.levelName ?? '').replace(/\D+/g, ''))
    } else {
      // å¯¹é½å†…å®¹ï¼ˆå½“å¤–éƒ¨æ•°æ®å˜åŒ–æ—¶ï¼‰
      for (let i = 0; i < source.length; i++) {
        const normalized = (source[i].levelName ?? '').replace(/\D+/g, '')
        if (this.levelNameInputs[i] === undefined) {
          this.levelNameInputs[i] = normalized
        }
      }
    }
  }
}
