import { OmniThemeManager, OmniThemeType, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { getCurrentTheme as resolveTheme } from '../../utils/theme/ThemeUtils'
import { OMNI_THEME_KEY, OMNI_THEME_TYPE_KEY, OMNI_THEME_VERSION_KEY } from '../../utils/theme/useOmniTheme'
import { AppleDesignStyle } from '../../utils/theme/AppleDesignStyle'
import { QualityStateManager } from './core/QualityStateManager'
import { QualityDataManager } from './core/QualityDataManager'
import { QualityEventHandler } from './core/QualityEventHandler'
import { QualityControlPanel } from './QualityControlPanel'
import { QualityDataTable } from './QualityDataTable'
import { QualityOutletDialog } from './QualityOutletDialog'
import { QualityLevelData } from './QualityConstants'
import { QualitySettingsDialog } from '../../components/dialogs/QualitySettingsDialog'
import { DEFAULT_QUALITY_SETTINGS } from './QualityConstants'
import { hilog } from '@kit.PerformanceAnalysisKit'
import { ThreeDButton } from '../../components/ui/buttons/ThreeDButton'
import { HomeDataManager } from '../home/core/HomeDataManager'
import { HOME_SELECTED_FSM } from '../../constants/TopBarKeys'
import { GradeInfoConfigManager } from '../home/core/GradeInfoConfigManager'
import { ConstPreDefine } from '../../protocol/ConstPreDefine'
import { util } from '@kit.ArkTS'
import { getConfigSender } from '../../protocol/ConfigSender'

const DOMAIN = 0x0000
const TAG = 'QualityContent'
interface HomeContentRef {
  refreshAllTables?: () => void
}

type QualityAutoDimKey = 'color' | 'sugar' | 'acidity' | 'mold'

interface QualityAutoDim {
  key: QualityAutoDimKey
  values: string[]
}

interface QualityPickedValues {
  color?: string
  sugar?: string
  acidity?: string
  mold?: string
}

/**
 * å“è´¨å†…å®¹ç»„ä»¶
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - æ˜¾ç¤ºå“è´¨ç›¸å…³çš„å†…å®¹å’ŒåŠŸèƒ½
 * - é›†æˆæ¨¡å—åŒ–ç»„ä»¶æ¶æ„
 * - æ”¯æŒä¸»é¢˜åˆ‡æ¢å’Œæ ·å¼é€‚é…
 * 
 * ç»„ä»¶æ¶æ„ï¼š
 * - çŠ¶æ€ç®¡ç†ï¼šä½¿ç”¨QualityStateManageré›†ä¸­ç®¡ç†çŠ¶æ€
 * - æ•°æ®ç®¡ç†ï¼šä½¿ç”¨QualityDataManagerç®¡ç†æ•°æ®
 * - äº‹ä»¶å¤„ç†ï¼šä½¿ç”¨QualityEventHandlerå¤„ç†äº‹ä»¶
 * - UIç»„ä»¶ï¼šä½¿ç”¨æ¨¡å—åŒ–ç»„ä»¶æ„å»ºç•Œé¢
 * 
 * ä¸»è¦åŠŸèƒ½ï¼š
 * - å“è´¨ç­‰çº§ç®¡ç†
 * - å‡ºå£è®¾ç½®é…ç½®
 * - æ•°æ®è¡¨æ ¼æ˜¾ç¤º
 * - ç”¨æˆ·äº¤äº’å¤„ç†
 */
@Component
export struct QualityContent {
  // ==================== çŠ¶æ€ç®¡ç† ====================
  
  /**
   * å“è´¨é¡µé¢çŠ¶æ€ç®¡ç†å™¨
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - é›†ä¸­ç®¡ç†å“è´¨é¡µé¢çš„æ‰€æœ‰çŠ¶æ€
   * - æä¾›çŠ¶æ€æ›´æ–°å’Œé‡ç½®åŠŸèƒ½
   * - ç®€åŒ–çŠ¶æ€ç®¡ç†é€»è¾‘
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - çŠ¶æ€åˆå§‹åŒ–å’Œæ›´æ–°
   * - çŠ¶æ€é‡ç½®å’Œæ¢å¤
   * - çŠ¶æ€éªŒè¯å’ŒåŒæ­¥
   */
  private stateManager = new QualityStateManager()

  /**
   * å“è´¨é¡µé¢æ•°æ®ç®¡ç†å™¨
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - ç®¡ç†å“è´¨é¡µé¢çš„æ‰€æœ‰æ•°æ®æ“ä½œ
   * - æä¾›æ•°æ®çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½
   * - æ”¯æŒæ•°æ®éªŒè¯å’Œæ ¼å¼åŒ–
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - æ•°æ®åˆå§‹åŒ–å’ŒåŠ è½½
   * - æ•°æ®æ›´æ–°å’ŒåŒæ­¥
   * - æ•°æ®éªŒè¯å’Œæ ¼å¼åŒ–
   */
  private dataManager = new QualityDataManager()

  /**
   * å“è´¨é¡µé¢äº‹ä»¶å¤„ç†å™¨
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å¤„ç†å“è´¨é¡µé¢çš„æ‰€æœ‰ç”¨æˆ·äº¤äº’äº‹ä»¶
   * - æä¾›äº‹ä»¶æ—¥å¿—å’Œè°ƒè¯•åŠŸèƒ½
   * - æ”¯æŒäº‹ä»¶çš„æ‰©å±•å’Œè‡ªå®šä¹‰
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç”¨æˆ·äº¤äº’å¤„ç†
   * - äº‹ä»¶æ—¥å¿—è®°å½•
   * - é”™è¯¯å¤„ç†å’Œè°ƒè¯•
   */
  private eventHandler = new QualityEventHandler()

  // ç”¨äºé©±åŠ¨UIåˆ·æ–°çš„å¯è§‚å¯Ÿæ•°æ®ï¼ˆè¡¨æ ¼ä¸ç­‰çº§æ•°é‡è”åŠ¨ï¼‰
  @State private currentLevels: QualityLevelData[] = []
  
  // æ‚¬æµ®æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
  @State private showFloatingButtons: boolean = true
  // æ‚¬æµ®æŒ‰é’®æ‚¬åœçŠ¶æ€
  @State private isHovering: boolean = false
  // å“è´¨å‚æ•°è®¾ç½®å¯¹è¯æ¡†æ˜¾ç¤ºçŠ¶æ€
  @State private showQualitySettingsDialog: boolean = false

  /**
   * é¡µé¢åˆ‡æ¢å›è°ƒ
   * å½“éœ€è¦åˆ‡æ¢é¡µé¢æ—¶ï¼ˆå¦‚ä¿å­˜åè¿”å›ä¸»é¡µï¼‰ï¼Œé€šè¿‡æ­¤å›è°ƒé€šçŸ¥çˆ¶ç»„ä»¶
   */
  onPageChange?: (pageName: string) => void

  // æ§åˆ¶é¢æ¿ç»„ä»¶å¼•ç”¨
  private controlPanelRef: QualityControlPanel | null = null

  private readFixedName(bytes: Uint8Array, index: number): string {
    const start = index * ConstPreDefine.MAX_TEXT_LENGTH
    let end = start
    while (end < start + ConstPreDefine.MAX_TEXT_LENGTH && bytes[end] !== 0) {
      end++
    }
    if (end <= start) { return '' }
    const slice = bytes.subarray(start, end)
    const decoder = new util.TextDecoder()
    return decoder.decodeWithStream(slice)
  }

  private getFixedNameList(bytes: Uint8Array, maxCount: number): string[] {
    const list: string[] = []
    for (let i = 0; i < maxCount; i++) {
      const name = this.readFixedName(bytes, i).trim()
      if (!name) { break }
      list.push(name)
    }
    return list
  }

  private getSelectedFSM(): 'FSM1' | 'FSM2' {
    const raw = AppStorage.get(HOME_SELECTED_FSM) as string | undefined
    return raw === 'FSM2' ? 'FSM2' : 'FSM1'
  }

  // ==================== ä¸»é¢˜ç›¸å…³ ====================
  
  /**
   * å½“å‰ä¸»é¢˜æ ·å¼
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨å½“å‰åº”ç”¨çš„ä¸»é¢˜æ ·å¼
   * - ç”¨äºç»„ä»¶æ ·å¼é€‚é…
   * - è‡ªåŠ¨å“åº”ä¸»é¢˜å˜åŒ–
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç»„ä»¶æ¸²æŸ“æ—¶è·å–ä¸»é¢˜æ ·å¼
   * - ä¸»é¢˜åˆ‡æ¢æ—¶è‡ªåŠ¨æ›´æ–°
   */
  @StorageLink(OMNI_THEME_KEY) consumedTheme: ExtendedOmniThemeStyle = OmniThemeManager.getInstance().getCurrentTheme()

  /**
   * å½“å‰ä¸»é¢˜ç±»å‹
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨å½“å‰åº”ç”¨çš„ä¸»é¢˜ç±»å‹
   * - ç”¨äºä¸»é¢˜ç±»å‹åˆ¤æ–­
   * - è‡ªåŠ¨å“åº”ä¸»é¢˜å˜åŒ–
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ä¸»é¢˜ç±»å‹åˆ¤æ–­æ—¶
   * - ä¸»é¢˜åˆ‡æ¢æ—¶è‡ªåŠ¨æ›´æ–°
   */
  @StorageLink(OMNI_THEME_TYPE_KEY) consumedThemeType: OmniThemeType = OmniThemeManager.getInstance().getCurrentThemeType()

  /**
   * ä¸»é¢˜ç‰ˆæœ¬å·
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å­˜å‚¨å½“å‰ä¸»é¢˜çš„ç‰ˆæœ¬å·
   * - ç”¨äºä¸»é¢˜æ›´æ–°æ£€æµ‹
   * - è‡ªåŠ¨å“åº”ä¸»é¢˜å˜åŒ–
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ä¸»é¢˜æ›´æ–°æ£€æµ‹æ—¶
   * - ä¸»é¢˜åˆ‡æ¢æ—¶è‡ªåŠ¨æ›´æ–°
   */
  @StorageLink(OMNI_THEME_VERSION_KEY) themeVersion: number = 0

  /**
   * åŸºç¡€ç»„ä»¶åŠ©æ‰‹
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æä¾›åŸºç¡€ç»„ä»¶çš„é€šç”¨åŠŸèƒ½
   * - ç”¨äºä¸»é¢˜è·å–å’Œæ ·å¼å¤„ç†
   * - ç§æœ‰å±æ€§ï¼Œä¸å¯¹å¤–æš´éœ²
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - è·å–å½“å‰ä¸»é¢˜æ—¶
   * - å¤„ç†ç»„ä»¶æ ·å¼æ—¶
   */
  // private baseComponentHelper = new BaseComponentHelper()

  // ==================== æ–¹æ³•å®šä¹‰ ====================
  
  /**
   * è·å–å½“å‰ä¸»é¢˜é…ç½®
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - è·å–å½“å‰åº”ç”¨çš„ä¸»é¢˜é…ç½®
   * - è¿”å›ä¸»é¢˜æ ·å¼å¯¹è±¡
   * - ç”¨äºç»„ä»¶æ ·å¼é€‚é…
   * 
   * @returns å½“å‰ä¸»é¢˜æ ·å¼å¯¹è±¡
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç»„ä»¶æ¸²æŸ“æ—¶è·å–ä¸»é¢˜æ ·å¼
   * - æ ·å¼é€‚é…æ—¶è°ƒç”¨
   */
  getCurrentTheme(): ExtendedOmniThemeStyle {
    // å¼•ç”¨ themeVersionï¼Œç¡®ä¿ä¸»é¢˜ç‰ˆæœ¬å˜åŒ–è§¦å‘æœ¬ç»„ä»¶é‡å»º
    const __version: number = this.themeVersion
    return resolveTheme(this.consumedTheme)
  }

  /**
   * åˆå§‹åŒ–å“è´¨é¡µé¢
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - åˆå§‹åŒ–å“è´¨é¡µé¢çš„æ‰€æœ‰ç»„ä»¶
   * - è®¾ç½®é»˜è®¤çŠ¶æ€å’Œæ•°æ®
   * - æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
   * 
   * åˆå§‹åŒ–å†…å®¹ï¼š
   * - åˆå§‹åŒ–çŠ¶æ€ç®¡ç†å™¨
   * - åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨
   * - åˆå§‹åŒ–äº‹ä»¶å¤„ç†å™¨
   * - è®¾ç½®é»˜è®¤çŠ¶æ€
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - é¡µé¢åˆå§‹åŒ–æ—¶
   * - ç»„ä»¶åˆ›å»ºæ—¶
   * - çŠ¶æ€é‡ç½®æ—¶
   */
  private initializeQualityPage(): void {
    // åˆå§‹åŒ–çŠ¶æ€ç®¡ç†å™¨
    this.stateManager.resetAllStates()
    
    // åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨
    this.dataManager.initializeQualityData()
    
    // åˆå§‹åŒ–äº‹ä»¶å¤„ç†å™¨
    this.eventHandler.onPageInit()

    const savedLevels = AppStorage.get('QUALITY_LEVELS') as QualityLevelData[] | undefined
    const savedIndexRaw = AppStorage.get('QualityLevelCountIndex') as number | undefined
    const savedIndex = typeof savedIndexRaw === 'number'
      ? Math.max(0, Math.min(savedIndexRaw, 16))
      : DEFAULT_QUALITY_SETTINGS.defaultLevelCount

    if (Array.isArray(savedLevels) && savedLevels.length > 0) {
      const trimmed = savedLevels.slice(0, 16)
      this.stateManager.updateQualityLevels(trimmed)
      this.dataManager.setQualityLevels(trimmed)
      const nextCount = savedIndex > 0 ? Math.min(savedIndex, trimmed.length) : trimmed.length
      this.stateManager.updateLevelCountIndex(nextCount)
      this.dataManager.setLevelCount(nextCount)
    } else {
      this.stateManager.updateLevelCountIndex(savedIndex)
      this.dataManager.setLevelCount(savedIndex)
    }

    this.currentLevels = this.stateManager.getQualityLevels()
  }

  // ==================== äº‹ä»¶å¤„ç†æ–¹æ³• ====================
  
  /**
   * å¤„ç†ç­‰çº§æ•°é‡å˜åŒ–
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å¤„ç†ç”¨æˆ·é€‰æ‹©ç­‰çº§æ•°é‡çš„äº‹ä»¶
   * - æ›´æ–°çŠ¶æ€ç®¡ç†å™¨å’Œæ•°æ®ç®¡ç†å™¨
   * - è§¦å‘ç›¸å…³äº‹ä»¶å¤„ç†
   * 
   * @param index ç­‰çº§æ•°é‡ç´¢å¼•
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç”¨æˆ·ä»ä¸‹æ‹‰æ¡†é€‰æ‹©ç­‰çº§æ•°é‡æ—¶
   * - ç¨‹åºè‡ªåŠ¨è®¾ç½®ç­‰çº§æ•°é‡æ—¶
   */
  private handleLevelCountChange(index: number): void {
    console.log(`ğŸ”„ å¤„ç†ç­‰çº§æ•°é‡å˜åŒ–: ${index}`)
    
    // æ›´æ–°çŠ¶æ€ç®¡ç†å™¨
    this.stateManager.updateLevelCountIndex(index)
    
    // æ›´æ–°æ•°æ®ç®¡ç†å™¨
    this.dataManager.setLevelCount(index)
    
    // è§¦å‘äº‹ä»¶å¤„ç†
    this.eventHandler.onLevelCountChange(index)

    // åˆ·æ–°å¯è§‚å¯Ÿæ•°æ®ï¼Œè§¦å‘è¡¨æ ¼è”åŠ¨
    this.currentLevels = this.stateManager.getQualityLevels()
    
    console.log(`âœ… ç­‰çº§æ•°é‡å˜åŒ–å¤„ç†å®Œæˆï¼Œå½“å‰æ•°æ®æ¡æ•°: ${this.currentLevels.length}`)
  }

  /**
   * å¤„ç†è‡ªåŠ¨è®¾å®šäº‹ä»¶
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å¤„ç†ç”¨æˆ·ç‚¹å‡»è‡ªåŠ¨è®¾å®šæŒ‰é’®çš„äº‹ä»¶
   * - æ‰§è¡Œè‡ªåŠ¨è®¾å®šé€»è¾‘
   * - è§¦å‘ç›¸å…³äº‹ä»¶å¤„ç†
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç”¨æˆ·ç‚¹å‡»è‡ªåŠ¨è®¾å®šæŒ‰é’®æ—¶
   * - ç¨‹åºéœ€è¦è‡ªåŠ¨è®¾å®šå‚æ•°æ—¶
   */
  private handleAutoSet(): void {
    // è§¦å‘äº‹ä»¶å¤„ç†
    this.eventHandler.onAutoSet()

    const fsm = this.getSelectedFSM()
    const gradeInfo = GradeInfoConfigManager.getInstance().getOrCreateGradeInfo(fsm)

    const defaultColor: string[] = ['ä¼˜ç§€', 'è‰¯å¥½', 'ä¸€èˆ¬', 'è¾ƒå·®']
    const defaultSugar: string[] = ['é«˜ç³–åº¦', 'ä¸­ç³–åº¦']
    const defaultAcidity: string[] = ['é«˜é…¸åº¦', 'ä¸­é…¸åº¦']
    const defaultMold: string[] = ['æ— éœ‰èŠ¯', 'è½»å¾®éœ‰èŠ¯']

    const colorList = this.getFixedNameList(gradeInfo.strColorGradeName, ConstPreDefine.MAX_COLOR_GRADE_NUM)
    const sugarList = this.getFixedNameList(gradeInfo.stSugarGradeName, ConstPreDefine.MAX_SUGAR_GRADE_NUM)
    const acidityList = this.getFixedNameList(gradeInfo.stAcidityGradeName, ConstPreDefine.MAX_ACIDITY_GRADE_NUM)
    const moldList = this.getFixedNameList(gradeInfo.stHollowGradeName, ConstPreDefine.MAX_HOLLOW_GRADE_NUM)

    const colors = colorList.length > 0 ? colorList : defaultColor
    const sugars = sugarList.length > 0 ? sugarList : defaultSugar
    const acidities = acidityList.length > 0 ? acidityList : defaultAcidity
    const molds = moldList.length > 0 ? moldList : defaultMold

    const activeDims: QualityAutoDim[] = []
    if (colors.length > 1) activeDims.push({ key: 'color', values: colors })
    if (sugars.length > 1) activeDims.push({ key: 'sugar', values: sugars })
    if (acidities.length > 1) activeDims.push({ key: 'acidity', values: acidities })
    if (molds.length > 1) activeDims.push({ key: 'mold', values: molds })

    const rows: QualityLevelData[] = []
    const limit = 16

    const dfs = (idx: number, picked: QualityPickedValues, nameParts: string[]) => {
      if (rows.length >= limit) { return }
      if (idx >= activeDims.length) {
        const levelName = nameParts.length > 0 ? nameParts.join('.') : `${rows.length + 1}`
        const color = (picked.color ?? (colors.length > 0 ? colors[0] : 'å…¨éƒ¨')) || 'å…¨éƒ¨'
        const sugar = (picked.sugar ?? (sugars.length > 0 ? sugars[0] : 'å…¨éƒ¨')) || 'å…¨éƒ¨'
        const acidity = (picked.acidity ?? (acidities.length > 0 ? acidities[0] : 'å…¨éƒ¨')) || 'å…¨éƒ¨'
        const mold = (picked.mold ?? (molds.length > 0 ? molds[0] : 'å…¨éƒ¨')) || 'å…¨éƒ¨'
        rows.push({
          levelName: levelName,
          colorLevel: color,
          sugarLevel: sugar,
          acidityLevel: acidity,
          moldCoreLevel: mold
        })
        return
      }
      const dim = activeDims[idx]
      for (let i = 0; i < dim.values.length; i++) {
        const v = dim.values[i]
        const nextPicked: QualityPickedValues = {
          color: picked.color,
          sugar: picked.sugar,
          acidity: picked.acidity,
          mold: picked.mold
        }
        if (dim.key === 'color') nextPicked.color = v
        else if (dim.key === 'sugar') nextPicked.sugar = v
        else if (dim.key === 'acidity') nextPicked.acidity = v
        else nextPicked.mold = v

        const nextNameParts: string[] = nameParts.slice()
        nextNameParts.push(v)
        dfs(idx + 1, nextPicked, nextNameParts)
        if (rows.length >= limit) { return }
      }
    }

    if (activeDims.length === 0) {
      for (let i = 0; i < Math.min(limit, Math.max(1, this.stateManager.getLevelCountIndex() || 1)); i++) {
        rows.push({
          levelName: `${i + 1}`,
          colorLevel: colors[0] ?? 'å…¨éƒ¨',
          sugarLevel: sugars[0] ?? 'å…¨éƒ¨',
          acidityLevel: acidities[0] ?? 'å…¨éƒ¨',
          moldCoreLevel: molds[0] ?? 'å…¨éƒ¨'
        })
      }
    } else {
      const picked0: QualityPickedValues = {}
      dfs(0, picked0, [])
    }

    this.stateManager.updateQualityLevels(rows)
    this.dataManager.setQualityLevels(rows)
    this.handleLevelCountChange(rows.length)
    AppStorage.setOrCreate('QUALITY_LEVELS', rows)

    hilog.info(DOMAIN, TAG, `å“è´¨é¡µé¢ï¼šè‡ªåŠ¨è®¾å®šç”Ÿæˆ ${rows.length} æ¡`)
  }

  /**
   * å¤„ç†è®¾ç½®å‚æ•°äº‹ä»¶
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å¤„ç†ç”¨æˆ·ç‚¹å‡»è®¾ç½®å‚æ•°æŒ‰é’®çš„äº‹ä»¶
   * - æ‰“å¼€å‚æ•°è®¾ç½®é¢æ¿
   * - è§¦å‘ç›¸å…³äº‹ä»¶å¤„ç†
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç”¨æˆ·ç‚¹å‡»è®¾ç½®å‚æ•°æŒ‰é’®æ—¶
   * - ç¨‹åºéœ€è¦æ‰“å¼€å‚æ•°è®¾ç½®æ—¶
   */
  private handleSettingsClick(): void {
    // è§¦å‘äº‹ä»¶å¤„ç†
    this.eventHandler.onSettingsClick()
    
    // æ‰“å¼€å‚æ•°è®¾ç½®å¯¹è¯æ¡†
    this.showQualitySettingsDialog = true
    hilog.info(DOMAIN, TAG, 'å“è´¨é¡µé¢ï¼šæ‰“å¼€å‚æ•°è®¾ç½®é¢æ¿')
  }

  /**
   * å¤„ç†å‡ºå£æŒ‰é’®ç‚¹å‡»
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å¤„ç†ç”¨æˆ·ç‚¹å‡»å‡ºå£æŒ‰é’®çš„äº‹ä»¶
   * - æ›´æ–°çŠ¶æ€ç®¡ç†å™¨å’Œæ•°æ®ç®¡ç†å™¨
   * - æ˜¾ç¤ºå‡ºå£è®¾ç½®å¯¹è¯æ¡†
   * 
   * @param outletNumber å‡ºå£ç¼–å·
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç”¨æˆ·ç‚¹å‡»å‡ºå£æŒ‰é’®æ—¶
   * - ç¨‹åºéœ€è¦æ‰“å¼€å‡ºå£è®¾ç½®æ—¶
   */
  private handleOutletClick(outletNumber: number): void {
    // æ›´æ–°çŠ¶æ€ç®¡ç†å™¨
    this.stateManager.updateCurrentOutletIndex(outletNumber)
    this.stateManager.updateShowOutletDialog(true)
    
    // æ›´æ–°æ•°æ®ç®¡ç†å™¨
    this.dataManager.setCurrentOutletIndex(outletNumber)
    
    // è§¦å‘äº‹ä»¶å¤„ç†
    this.eventHandler.onOutletClick(outletNumber)
  }

  /**
   * å¤„ç†å‡ºå£åˆ‡æ¢äº‹ä»¶
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å¤„ç†ç”¨æˆ·åˆ‡æ¢å‡ºå£çŠ¶æ€çš„äº‹ä»¶
   * - æ›´æ–°çŠ¶æ€ç®¡ç†å™¨å’Œæ•°æ®ç®¡ç†å™¨
   * - è§¦å‘ç›¸å…³äº‹ä»¶å¤„ç†
   * 
   * @param direction åˆ‡æ¢æ–¹å‘
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç”¨æˆ·ç‚¹å‡»ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªæŒ‰é’®æ—¶
   * - ç¨‹åºéœ€è¦åˆ‡æ¢å‡ºå£æ—¶
   */
  private handleOutletSwitch(direction: 'previous' | 'next'): void {
    // æ›´æ–°æ•°æ®ç®¡ç†å™¨
    if (direction === 'previous') {
      this.dataManager.switchToPreviousOutlet()
    } else {
      this.dataManager.switchToNextOutlet()
    }
    
    // æ›´æ–°çŠ¶æ€ç®¡ç†å™¨
    this.stateManager.updateCurrentOutletIndex(this.dataManager.getCurrentOutletIndex())
    
    // è§¦å‘äº‹ä»¶å¤„ç†
    this.eventHandler.onOutletSwitch(direction, this.stateManager.getCurrentOutletIndex())
  }

  /**
   * å¤„ç†å‡ºå£ç¡®è®¤äº‹ä»¶
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å¤„ç†ç”¨æˆ·ç¡®è®¤å‡ºå£è®¾ç½®çš„äº‹ä»¶
   * - æ›´æ–°çŠ¶æ€ç®¡ç†å™¨
   * - å…³é—­å‡ºå£è®¾ç½®å¯¹è¯æ¡†
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç”¨æˆ·ç¡®è®¤å‡ºå£è®¾ç½®æ—¶
   * - ç¨‹åºéœ€è¦ç¡®è®¤å‡ºå£è®¾ç½®æ—¶
   */
  private handleOutletConfirm(): void {
    // æ›´æ–°çŠ¶æ€ç®¡ç†å™¨
    this.stateManager.updateShowOutletDialog(false)
    
    // è§¦å‘äº‹ä»¶å¤„ç†
    this.eventHandler.onOutletConfirm(this.stateManager.getCurrentOutletIndex())
  }

  /**
   * å¤„ç†å‡ºå£å–æ¶ˆäº‹ä»¶
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å¤„ç†ç”¨æˆ·å–æ¶ˆå‡ºå£è®¾ç½®çš„äº‹ä»¶
   * - æ›´æ–°çŠ¶æ€ç®¡ç†å™¨
   * - å…³é—­å‡ºå£è®¾ç½®å¯¹è¯æ¡†
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç”¨æˆ·å–æ¶ˆå‡ºå£è®¾ç½®æ—¶
   * - ç¨‹åºéœ€è¦å–æ¶ˆå‡ºå£è®¾ç½®æ—¶
   */
  private handleOutletCancel(): void {
    // æ›´æ–°çŠ¶æ€ç®¡ç†å™¨
    this.stateManager.updateShowOutletDialog(false)
    
    // è§¦å‘äº‹ä»¶å¤„ç†
    this.eventHandler.onOutletCancel()
  }

  /**
   * å¤„ç†æ•°æ®æ›´æ–°äº‹ä»¶
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - å¤„ç†å“è´¨ç­‰çº§æ•°æ®æ›´æ–°çš„äº‹ä»¶
   * - æ›´æ–°çŠ¶æ€ç®¡ç†å™¨å’Œæ•°æ®ç®¡ç†å™¨
   * - è§¦å‘ç›¸å…³äº‹ä»¶å¤„ç†
   * 
   * @param data æ›´æ–°çš„æ•°æ®
   * @param index æ•°æ®ç´¢å¼•
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - ç”¨æˆ·ç¼–è¾‘ç­‰çº§æ•°æ®æ—¶
   * - ç¨‹åºè‡ªåŠ¨æ›´æ–°æ•°æ®æ—¶
   */
  private handleDataUpdate(data: QualityLevelData, index: number): void {
    // æ›´æ–°çŠ¶æ€ç®¡ç†å™¨
    this.stateManager.updateQualityLevel(index, {
      levelName: data.levelName,
      colorLevel: typeof data.colorLevel === 'string' ? data.colorLevel : String(data.colorLevel.value),
      sugarLevel: data.sugarLevel,
      acidityLevel: data.acidityLevel,
      moldCoreLevel: data.moldCoreLevel
    })
    
    // æ›´æ–°æ•°æ®ç®¡ç†å™¨
    this.dataManager.updateQualityLevel(index, {
      levelName: data.levelName,
      colorLevel: typeof data.colorLevel === 'string' ? data.colorLevel : String(data.colorLevel.value),
      sugarLevel: data.sugarLevel,
      acidityLevel: data.acidityLevel,
      moldCoreLevel: data.moldCoreLevel
    })
    
    // è§¦å‘äº‹ä»¶å¤„ç†
    this.eventHandler.onDataUpdate(data, index)

    // åŒæ­¥æœ€æ–°æ•°æ®åˆ°å¯è§‚å¯Ÿæ•°ç»„
    this.currentLevels = this.stateManager.getQualityLevels()
  }

  /**
   * å¤„ç†ä¿å­˜å¹¶ç¡®è®¤
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - ä¿å­˜å“è´¨ç­‰çº§æ•°æ®
   * - æ›´æ–°é¦–é¡µæ˜¾ç¤ºçš„å“è´¨åç§°
   * - è¿”å›ä¸»é¡µ
   */
  private async handleSaveAndConfirm(): Promise<void> {
    const levels = this.stateManager.getQualityLevels()
    const selectedFSM = this.getSelectedFSM()
    HomeDataManager.getInstance().updateQualityGradeNames(levels.map(item => item.levelName), selectedFSM)
    HomeDataManager.getInstance().syncStatisticsTableLevels(levels.map(item => item.levelName), selectedFSM)
    const homeContent = AppStorage.get('HOME_CONTENT_REF') as HomeContentRef | null
    if (homeContent?.refreshAllTables) {
      homeContent.refreshAllTables()
    }
    
    // å¦‚æœæœ‰æ•°æ®ï¼Œè§¦å‘æ›´æ–°äº‹ä»¶
    if (levels.length > 0) {
      const first = levels[0]
      this.eventHandler.onDataUpdate(first, -1)
    }
    
    const idx = this.stateManager.getLevelCountIndex()
    AppStorage.setOrCreate('QualityLevelCountIndex', idx)
    AppStorage.setOrCreate('QUALITY_LEVELS', levels)
    
    console.log('å“è´¨é¡µé¢ï¼šç¡®è®¤æ“ä½œ')

    try {
      const info = GradeInfoConfigManager.getInstance().rebuildBaseFromHomeGradeTable(selectedFSM)
      const fsmId = selectedFSM === 'FSM1' ? ConstPreDefine.getFsmId(0) : ConstPreDefine.getFsmId(1)
      const ok = await getConfigSender().sendFullGradeInfo(fsmId, info)
      console.log(ok ? 'å“è´¨é…ç½®å·²ä¸‹å‘åˆ°ä¸‹ä½æœº' : 'å“è´¨é…ç½®ä¸‹å‘å¤±è´¥')
    } catch (e) {
      console.log(`å“è´¨é…ç½®ä¸‹å‘å¼‚å¸¸: ${String(e)}`)
    }

    // ä¿å­˜å®Œæˆåï¼Œè¿”å›ä¸»é¡µ
    if (this.onPageChange) {
      console.log('ã€å“è´¨é¡µé¢ã€‘ä¿å­˜å®Œæˆï¼Œè¿”å›ä¸»é¡µ')
      this.onPageChange('home')
    }
  }

  /**
   * æ„å»ºç»„ä»¶UI
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - æ„å»ºå“è´¨é¡µé¢çš„å®Œæ•´UIç»“æ„
   * - ä½¿ç”¨æ¨¡å—åŒ–ç»„ä»¶æ„å»ºç•Œé¢
   * - æ”¯æŒä¸»é¢˜é€‚é…å’Œäº‹ä»¶å¤„ç†
   * 
   * ç»„ä»¶ç»“æ„ï¼š
   * - æ§åˆ¶é¢æ¿ï¼šç­‰çº§æ•°é‡é€‰æ‹©ã€è‡ªåŠ¨è®¾å®šã€è®¾ç½®å‚æ•°
   * - æ•°æ®è¡¨æ ¼ï¼šæ˜¾ç¤ºå“è´¨ç­‰çº§æ•°æ®
   * - å‡ºå£å¯¹è¯æ¡†ï¼šå‡ºå£è®¾ç½®å’Œé€‰æ‹©
   * 
   * æ ·å¼ç‰¹æ€§ï¼š
   * - å“åº”å¼è®¾è®¡ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸
   * - ä¸»é¢˜é€‚é…ï¼šæ”¯æŒæ˜æš—ä¸»é¢˜
   * - æ¨¡å—åŒ–æ¶æ„ï¼šä½¿ç”¨ç‹¬ç«‹ç»„ä»¶
   * - äº‹ä»¶å¤„ç†ï¼šç»Ÿä¸€çš„äº‹ä»¶ç®¡ç†
   */
  build() {
    Stack() {
      // ä¸»è¦å†…å®¹
      Row() {
        Column() {
        // æ§åˆ¶é¢æ¿ç»„ä»¶
        QualityControlPanel({
          levelCountIndex: this.stateManager.getLevelCountIndex(),
          currentDataCount: this.currentLevels.length,
          onLevelCountChange: (index: number) => {
            this.handleLevelCountChange(index)
          },
          onAutoSet: () => {
            this.handleAutoSet()
          },
          onSettingsClick: () => {
            this.handleSettingsClick()
          }
        })
        .onAppear(() => {
          // è·å–æ§åˆ¶é¢æ¿ç»„ä»¶å¼•ç”¨
          // this.controlPanelRef = this
        })

        // æ•°æ®è¡¨æ ¼ç»„ä»¶
        QualityDataTable({
          qualityLevels: this.currentLevels,
          onDataUpdate: (data: QualityLevelData, index: number) => {
            this.handleDataUpdate(data, index)
          },
          onDataClick: (data: QualityLevelData, index: number) => {
            this.handleDataUpdate(data, index)
          }
        })

        }
        .width('100%')
        .height('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Start)

      }
      .width('100%')
      .height('100%')
      .alignItems(VerticalAlign.Top)
      .backgroundColor(this.getCurrentTheme().pageBg ?? this.getCurrentTheme().backgroundColor)
      
      // ==================== æ‚¬æµ®æŒ‰é’® ====================
      if (this.showFloatingButtons) {
        Column() {
          // ç¡®è®¤æŒ‰é’® - ThreeDButtonæ ·å¼
          ThreeDButton({
            text: 'ç¡®è®¤',
            isSelected: false,
            buttonWidth: 80,
            buttonHeight: 50,
            fontSize: 16,
            onClickCallback: () => {
              this.handleSaveAndConfirm()
            }
          })

          // å–æ¶ˆæŒ‰é’® - ThreeDButtonæ ·å¼
          ThreeDButton({
            text: 'å–æ¶ˆ',
            isSelected: false,
            buttonWidth: 80,
            buttonHeight: 50,
            fontSize: 16,
            onClickCallback: () => {
              this.eventHandler.onDataReset()
              console.log('å“è´¨é¡µé¢ï¼šå–æ¶ˆæ“ä½œ')
            }
          })
          .margin({ top: 12 })
        }
        .position({ x: '100%', y: '50%' })
        .translate({ 
          x: this.isHovering ? -80 : -40, // æ‚¬åœæ—¶å®Œå…¨æ˜¾ç¤ºï¼ŒåŠéšè—æ—¶ä¸€åŠåœ¨å±å¹•å¤–
          y: -56 
        })
        .zIndex(100)
        .animation({
          duration: 300,
          curve: Curve.EaseInOut
        })
        .onHover((isHover: boolean) => {
          this.isHovering = isHover
        })
      }
      
      // å‡ºå£è®¾ç½®å¯¹è¯æ¡† - æ”¾åœ¨Stackçš„æœ€ä¸Šå±‚
      if (this.stateManager.getShowOutletDialog()) {
        QualityOutletDialog({
          showDialog: this.stateManager.getShowOutletDialog(),
          currentOutletIndex: this.stateManager.getCurrentOutletIndex(),
          onOutletSwitch: (direction: 'previous' | 'next') => {
            this.handleOutletSwitch(direction)
          },
          onOutletConfirm: () => {
            this.handleOutletConfirm()
          },
          onOutletCancel: () => {
            this.handleOutletCancel()
          }
        })
      }

      // å“è´¨å‚æ•°è®¾ç½®å¯¹è¯æ¡†
      if (this.showQualitySettingsDialog) {
        Stack() {
          QualitySettingsDialog({
            isVisible: this.showQualitySettingsDialog,
            onConfirm: () => {
              console.log('ç¡®è®¤å“è´¨å‚æ•°è®¾ç½®')
              // TODO: å®ç°ä¿å­˜å‚æ•°é€»è¾‘
              this.showQualitySettingsDialog = false
            },
            onCancel: () => {
              this.showQualitySettingsDialog = false
            }
          })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(3000)
      }
    }
    .width('100%')
    .height('100%')
  }

  // ==================== ç”Ÿå‘½å‘¨æœŸæ–¹æ³• ====================
  
  /**
   * ç»„ä»¶å³å°†å‡ºç°æ—¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - åœ¨ç»„ä»¶å³å°†å‡ºç°æ—¶è°ƒç”¨
   * - åˆå§‹åŒ–å“è´¨é¡µé¢
   * - è®¾ç½®é»˜è®¤çŠ¶æ€
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - é¡µé¢åˆå§‹åŒ–
   * - ç»„ä»¶åˆ›å»º
   * - çŠ¶æ€é‡ç½®
   */
  aboutToAppear(): void {
    this.initializeQualityPage()
  }

  /**
   * ç»„ä»¶å³å°†é”€æ¯æ—¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
   * 
   * åŠŸèƒ½è¯´æ˜ï¼š
   * - åœ¨ç»„ä»¶å³å°†é”€æ¯æ—¶è°ƒç”¨
   * - æ¸…ç†èµ„æºå’ŒçŠ¶æ€
   * - è§¦å‘é¡µé¢é”€æ¯äº‹ä»¶
   * 
   * ä½¿ç”¨åœºæ™¯ï¼š
   * - é¡µé¢é”€æ¯
   * - èµ„æºæ¸…ç†
   * - çŠ¶æ€é‡ç½®
   */
  aboutToDisappear(): void {
    this.eventHandler.onPageDestroy()
  }

}
