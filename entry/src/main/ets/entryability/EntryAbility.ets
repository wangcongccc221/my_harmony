import { AbilityConstant, ConfigurationConstant, UIAbility, Want } from '@kit.AbilityKit';
import common from '@ohos.app.ability.common';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { window } from '@kit.ArkUI';
// import { NetworkOptimizer } from '../utils/network/NetworkOptimizer';
// import { startHttpServer, stopHttpServer, isHttpServerRunning, runHttpServerWorker } from '../utils/network/http/HttpServer';
import { taskpool } from '@kit.ArkTS';
// import { HttpServerHandler } from '../utils/network/http/HttpServerHandler';
import { copyRawDirectoryAuto } from '../utils/FileUtils';
import { AppCleanup } from '../utils/lifecycle/AppCleanup';
import { ProcessingCurveFeed } from '../utils/data/ProcessingCurveFeed';
import { ProcessingBarFeed } from '../utils/data/ProcessingBarFeed';
import { MultiSeriesBarFeed } from '../utils/data/MultiSeriesBarFeed';
import { WavePhaseManager } from '../utils/ui/WavePhaseManager';
import { relationalStore } from '@kit.ArkData';
// import { IBestORMInit, GetIBestORM } from '../database/orm';
// import GlobalStore from '../database/orm/model/GlobalStore';
// import { ProcessingHistory } from '../database/models/ProcessingHistory';
// import { FruitInfo } from '../database/models/FruitInfo';
// import { GradeInfo } from '../database/models/GradeInfo';
// import { ExportInfo } from '../database/models/ExportInfo';
// import { FarmerInfo } from '../database/models/FarmerInfo';
// import { ProcessingTask } from '../database/models/ProcessingTask';
// import { AlarmInfo } from '../database/models/AlarmInfo';
import { I18nManager } from '../utils/i18n/I18nManager';
import { OutletCountStorage } from '../utils/storage/OutletCountStorage';
import { NativeModule, CommandHead } from '../utils/native/NativeModule';
import { getUIDataSync } from '../protocol/UIDataSync';
import { getStatisticsHandler } from '../protocol/StatisticsHandler';
// import { TCPServer } from '../utils/network/tcp/TCPServer';
import { ConstPreDefine } from '../protocol/ConstPreDefine';
import { getConfigSender } from '../protocol/ConfigSender';
// import { taskPoolExecuteInsert, taskPoolExecuteQuery, taskPoolExecuteUpdate, taskPoolExecuteDelete } from '../database/examples/taskpool'; // æ–‡ä»¶å·²åˆ é™¤

const DOMAIN = 0x0000;
const HTTP_SERVER_PORT: number = 8080;

export default class EntryAbility extends UIAbility {
  // private networkOptimizer: NetworkOptimizer = NetworkOptimizer.getInstance();
  private httpServerInitialized: boolean = false; 

  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    this.context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET);
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onCreate');

    // åˆå§‹åŒ– Native æœåŠ¡
    this.initNativeServers();

    this.copyResourceFiles();
    // this.initNetworkOptimizer();
    // this.initHttpServer();
    // åˆå§‹åŒ–è‡ªå®šä¹‰ç¿»è¯‘ï¼ˆJSON æ¨¡å¼ï¼‰
    I18nManager.getInstance().init(this.context).catch((e: Error | object | string) => {
      const reason = typeof e === 'string'
        ? e
        : (e instanceof Error ? e.message : JSON.stringify(e));
      hilog.warn(DOMAIN, 'EntryAbility', `I18n åˆå§‹åŒ–å¤±è´¥: ${reason}`);
    });
  }
  
  /**
   * åˆå§‹åŒ– Native æœåŠ¡
   * å¯åŠ¨ SocketServer (PLC) å’Œ TcpServer (ä¸šåŠ¡)
   */
  private initNativeServers(): void {
    try {
      console.info('========== å¼€å§‹åˆå§‹åŒ– Native æœåŠ¡ ==========');

      // 1. å¯åŠ¨ SocketServer (PLCæ§åˆ¶) - ç«¯å£ 8080
      console.info('ğŸš€ [SocketServer] å°è¯•å¯åŠ¨ (PLC)...');
      const socketSuccess = NativeModule.socketServerStart("", 8080, (clientIP, data) => {
        const dataLen = data.length;
        console.info(`ğŸ“¡ [SocketServer] æ”¶åˆ°æ•°æ® | æ¥è‡ª: ${clientIP} | é•¿åº¦: ${dataLen}`);
        // ä¸šåŠ¡é€»è¾‘...
      });
      
      if (socketSuccess) {
        console.info('âœ… [SocketServer] å¯åŠ¨æˆåŠŸ (Port: 8080)');
      } else {
        console.error('âŒ [SocketServer] å¯åŠ¨å¤±è´¥');
      }

      // 2. å¯åŠ¨ TcpServer (ä¸šåŠ¡æ•°æ®) - ç«¯å£ 9090
      console.info('ğŸš€ [TcpServer] å°è¯•å¯åŠ¨ (ä¸šåŠ¡)...');
      // dstId ç¤ºä¾‹å€¼ 1001
      const tcpSuccess = NativeModule.tcpServerStart("", 9090, 1001, (head: CommandHead) => {
        // console.info(`ğŸ“¡ [TcpServer] æ”¶åˆ°ä¸šåŠ¡åŒ… | cmdId: ${head.cmdId} | srcId: ${head.srcId} | len: ${head.length}`);
        
        // å°†æ•°æ®äº¤ç»™ StatisticsHandler å¤„ç†
        if (head && head.data) {
          getStatisticsHandler().handleSplitMessage(head.cmdId, head.srcId, head.data);
        }
      });

      if (tcpSuccess) {
        console.info('âœ… [TcpServer] å¯åŠ¨æˆåŠŸ (Port: 9090)');
      } else {
        console.error('âŒ [TcpServer] å¯åŠ¨å¤±è´¥');
      }
      
      // 3. (å¯é€‰) TcpClient è¿æ¥ç¤ºä¾‹
      // å¦‚æœéœ€è¦åœ¨å¯åŠ¨æ—¶è¿æ¥æŸä¸ªæœåŠ¡å™¨ï¼Œå¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨
      /*
      NativeModule.tcpClientConnect("192.168.1.100", 8888, (data) => {
        console.info(`[TcpClient] æ”¶åˆ°æ•°æ®: ${data.length}`);
      });
      */

      console.info('========== Native æœåŠ¡åˆå§‹åŒ–å®Œæˆ ==========');
    } catch (error) {
      console.error('âŒ Native æœåŠ¡åˆå§‹åŒ–å¤±è´¥:', error);
    }
  }
  
  private async initOutletCountStorage(): Promise<void> {
    try {
      const storage = OutletCountStorage.getInstance();
      await storage.init(this.context);
      
      // åŠ è½½ä¿å­˜çš„å‡ºå£æ•°é‡å¹¶è®¾ç½®åˆ° AppStorage
      const counts = await storage.loadAllOutletCounts();
      AppStorage.setOrCreate('OutletCount_FSM1', counts.fsm1);
      AppStorage.setOrCreate('OutletCount_FSM2', counts.fsm2);
      
      hilog.info(DOMAIN, 'EntryAbility', `å‡ºå£æ•°é‡å·²åŠ è½½: FSM1=${counts.fsm1}, FSM2=${counts.fsm2}`);
    } catch (e) {
      hilog.error(DOMAIN, 'EntryAbility', `å‡ºå£æ•°é‡å­˜å‚¨åˆå§‹åŒ–å¤±è´¥: ${JSON.stringify(e)}`);
      // ä½¿ç”¨é»˜è®¤å€¼
      AppStorage.setOrCreate('OutletCount_FSM1', 20);
      AppStorage.setOrCreate('OutletCount_FSM2', 20);
    }
  }

  onDestroy(): void {
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onDestroy');

    // this.networkOptimizer.stop();
    
    /*
    if (isHttpServerRunning()) {
      stopHttpServer();
      this.httpServerInitialized = false; 
      hilog.info(DOMAIN, 'EntryAbility', 'HTTPæœåŠ¡å™¨å·²åœæ­¢');
    }
    */

    AppCleanup.shutdownAll();
  }
  
  /**
   * å¯åŠ¨ UI æ•°æ®åŒæ­¥æœåŠ¡
   * å°†åè®®å±‚çš„ä¸‹ä½æœºæ•°æ®åŒæ­¥åˆ° UI ç»„ä»¶
   */
  private startUIDataSync(): void {
    try {
      const uiDataSync = getUIDataSync();
      uiDataSync.start();
      hilog.info(DOMAIN, 'EntryAbility', 'UIæ•°æ®åŒæ­¥æœåŠ¡å·²å¯åŠ¨');
    } catch (e) {
      hilog.error(DOMAIN, 'EntryAbility', `UIæ•°æ®åŒæ­¥æœåŠ¡å¯åŠ¨å¤±è´¥: ${JSON.stringify(e)}`);
    }
  }

  async onWindowStageCreate(windowStage: window.WindowStage): Promise<void> {
    // Main window is created, set main page for this ability
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageCreate');

    try {
      /*
      await GlobalStore.init(this.context, {
        name: 'db_fruitsor.db',
        securityLevel: relationalStore.SecurityLevel.S2,
      });
      GetIBestORM().AutoMigrate(ProcessingHistory);
      GetIBestORM().AutoMigrate(FruitInfo);
      GetIBestORM().AutoMigrate(GradeInfo);
      GetIBestORM().AutoMigrate(ExportInfo);
      GetIBestORM().AutoMigrate(FarmerInfo);
      GetIBestORM().AutoMigrate(ProcessingTask);
      GetIBestORM().AutoMigrate(AlarmInfo);
      // åˆ›å»ºç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
      ProcessingHistory.createIndexes();
      FruitInfo.createIndexes();
      GradeInfo.createIndexes();
      ExportInfo.createIndexes();
      FarmerInfo.createIndexes();
      ProcessingTask.createIndexes();
      AlarmInfo.createIndexes();
      hilog.info(DOMAIN, 'EntryAbility', 'ORM åˆå§‹åŒ–å®Œæˆå¹¶è¿ç§»æ‰€æœ‰è¡¨');
      */

    } catch (e) {
      hilog.error(DOMAIN, 'EntryAbility', `æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: ${JSON.stringify(e)}`);
    }

    // ç¡®ä¿å‡ºå£æ•°é‡å­˜å‚¨å·²åˆå§‹åŒ–å¹¶åŠ è½½æ•°æ®
    await this.initOutletCountStorage();

    // å¯åŠ¨ UI æ•°æ®åŒæ­¥æœåŠ¡ - å°†ä¸‹ä½æœºæ•°æ®åŒæ­¥åˆ° UI
    this.startUIDataSync();

    windowStage.loadContent('pages/Home', async (err) => { 
      if (err.code) {
        hilog.error(DOMAIN, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err));
        return;
      }
      hilog.info(DOMAIN, 'testTag', 'Succeeded in loading the content.');
      try {
        const mainWindow: window.Window = await windowStage.getMainWindow();
        await mainWindow.setWindowLayoutFullScreen(true);
        await mainWindow.setFullScreen(true);
      } catch (e) {
        hilog.error(DOMAIN, 'testTag', `set non-fullscreen failed: ${JSON.stringify(e)}`);
      }

      // æ³¨å†Œå…¨å±€é”®ç›˜ç›‘å¬ï¼ˆå·¦ Ctrlï¼‰ï¼Œä¾›å…¨å±€å¤šé€‰ç­‰åŠŸèƒ½ä½¿ç”¨
    });
  }

  onWindowStageDestroy(): void {
    // Main window is destroyed, release UI related resources
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageDestroy');
  }

  onForeground(): void {
    // Ability has brought to foreground
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onForeground');
    
    Promise.resolve().then(() => {
      try {
        // æ¢å¤æ‰€æœ‰å…¨å±€å®šæ—¶å™¨å’ŒåŠ¨ç”»
        WavePhaseManager.getInstance().resume();
        
        hilog.info(DOMAIN, 'EntryAbility', 'å‰å°æ¢å¤ï¼šå·²æ¢å¤æ‰€æœ‰å…¨å±€å®šæ—¶å™¨å’ŒåŠ¨ç”»');
      } catch (e) {
        hilog.error(DOMAIN, 'EntryAbility', `å‰å°æ¢å¤å¤±è´¥: ${JSON.stringify(e)}`);
      }
    });
  }

  onBackground(): void {
    // Ability has back to background
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onBackground');
    
    Promise.resolve().then(() => {
      try {
        ProcessingCurveFeed.getInstance().stop();
        ProcessingBarFeed.getInstance().stop();
        MultiSeriesBarFeed.getInstance().stop();
        WavePhaseManager.getInstance().stop();
        
        hilog.info(DOMAIN, 'EntryAbility', 'åå°æ¸…ç†ï¼šå·²åœæ­¢æ‰€æœ‰å…¨å±€å®šæ—¶å™¨');
      } catch (e) {
        hilog.error(DOMAIN, 'EntryAbility', `åå°æ¸…ç†å¤±è´¥: ${JSON.stringify(e)}`);
      }
    });
  }

  onStop(): void {

    hilog.info(DOMAIN, 'EntryAbility', 'onStop: æ‰§è¡Œå…¨å±€æ¸…ç†');
    // AppCleanup.shutdownAll();
  }


  private async initNetworkOptimizer() {
    /*
    try {
      hilog.info(DOMAIN, 'EntryAbility', 'å¼€å§‹åˆå§‹åŒ–ç½‘ç»œä¼˜åŒ–å™¨');

      const success = await this.networkOptimizer.initialize();
      if (success) {
        hilog.info(DOMAIN, 'EntryAbility', 'ç½‘ç»œä¼˜åŒ–å™¨åˆå§‹åŒ–æˆåŠŸ');
      } else {
        hilog.error(DOMAIN, 'EntryAbility', 'ç½‘ç»œä¼˜åŒ–å™¨åˆå§‹åŒ–å¤±è´¥');
      }
    } catch (error) {
      hilog.error(DOMAIN, 'EntryAbility', `ç½‘ç»œä¼˜åŒ–å™¨åˆå§‹åŒ–å¼‚å¸¸: ${error.message}`);
    }
    */
  }

  private async initHttpServer() {
    /*
    if (this.httpServerInitialized) {
      hilog.warn(DOMAIN, 'EntryAbility', 'HTTPæœåŠ¡å™¨å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡é‡å¤å¯åŠ¨');
      return;
    }
    
    if (isHttpServerRunning()) {
      hilog.warn(DOMAIN, 'EntryAbility', 'HTTPæœåŠ¡å™¨å·²ç»åœ¨è¿è¡Œä¸­ï¼Œè·³è¿‡é‡å¤å¯åŠ¨');
      this.httpServerInitialized = true;
      return;
    }
    
    try {
      hilog.info(DOMAIN, 'EntryAbility', 'å¼€å§‹å¯åŠ¨HTTPæœåŠ¡å™¨');
      HttpServerHandler.setFileBasePath(this.context);
      const task: taskpool.Task = new taskpool.Task(runHttpServerWorker, this.context as common.Context, HTTP_SERVER_PORT);
      taskpool.execute(task);
      this.httpServerInitialized = true;
      hilog.info(DOMAIN, 'EntryAbility', `HTTPæœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£: ${HTTP_SERVER_PORT}`);
    } catch (error) {
      hilog.error(DOMAIN, 'EntryAbility', `HTTPæœåŠ¡å™¨å¯åŠ¨å¤±è´¥: ${error.message}`);
      this.httpServerInitialized = false;
    }
    */
  }

  private async copyResourceFiles() {
    try {
      hilog.info(DOMAIN, 'EntryAbility', 'å¼€å§‹è‡ªåŠ¨å¤åˆ¶èµ„æºæ–‡ä»¶...');
      

      const result = await copyRawDirectoryAuto(
        this.context,
        'file',
        undefined,
        'file'
      );
      
      hilog.info(DOMAIN, 'EntryAbility', `èµ„æºæ–‡ä»¶å¤åˆ¶æˆåŠŸ: ${result.fileCount} ä¸ªæ–‡ä»¶å·²å¤åˆ¶åˆ° ${result.targetPath}`);
      hilog.info(DOMAIN, 'EntryAbility', `å¤åˆ¶çš„æ–‡ä»¶åˆ—è¡¨: ${result.fileList.join(', ')}`);
    } catch (error) {
      hilog.error(DOMAIN, 'EntryAbility', `èµ„æºæ–‡ä»¶å¤åˆ¶å¤±è´¥: ${error instanceof Error ? error.message : JSON.stringify(error)}`);
    }
  }
}
