/**
 * è®¾å¤‡çŠ¶æ€é¢æ¿ç»„ä»¶
 * æ˜¾ç¤ºFSM/IPMè®¾å¤‡çš„è¿æ¥çŠ¶æ€
 * å¯¹åº”48é¡¹ç›®çš„è®¾å¤‡ç›‘æ§åŒºåŸŸ
 */

import {
  GlobalDataInterface,
  getGlobalDataInterface,
  DeviceStatusListener
} from '../../protocol/GlobalDataInterface'
import { StFsmStatus } from '../../protocol/Structures'
import { ConstPreDefine } from '../../protocol/ConstPreDefine'
import { OmniThemeManager, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { getCurrentTheme } from '../../utils/theme/ThemeUtils'
import { AppleDesignStyle } from '../../utils/theme/AppleDesignStyle'

/**
 * è®¾å¤‡æ˜¾ç¤ºæ•°æ®
 */
interface DeviceDisplayData {
  id: number
  name: string
  ipAddress: string
  online: boolean
  version: string
  lastHeartbeat: number
}

/**
 * è®¾å¤‡çŠ¶æ€é¢æ¿ç»„ä»¶
 */
@Component
export struct DeviceStatusPanel {
  @State private devices: DeviceDisplayData[] = []
  @State private onlineCount: number = 0
  @State private totalCount: number = 0

  private dataInterface: GlobalDataInterface = getGlobalDataInterface()
  private deviceStatusListener: DeviceStatusListener | null = null

  getCurrentTheme(): ExtendedOmniThemeStyle {
    return getCurrentTheme(OmniThemeManager.getInstance().getCurrentTheme())
  }

  aboutToAppear(): void {
    // è·å–åˆå§‹è®¾å¤‡çŠ¶æ€
    this.updateDeviceList()

    // æ³¨å†Œè®¾å¤‡çŠ¶æ€ç›‘å¬å™¨
    this.deviceStatusListener = (deviceMap: Map<number, StFsmStatus>) => {
      this.updateDeviceList()
    }
    this.dataInterface.addDeviceStatusListener(this.deviceStatusListener)
  }

  aboutToDisappear(): void {
    if (this.deviceStatusListener) {
      this.dataInterface.removeDeviceStatusListener(this.deviceStatusListener)
      this.deviceStatusListener = null
    }
  }

  /**
   * æ›´æ–°è®¾å¤‡åˆ—è¡¨
   */
  private updateDeviceList(): void {
    const deviceMap = this.dataInterface.getAllDeviceStatus()
    const devices: DeviceDisplayData[] = []
    let online = 0

    deviceMap.forEach((status: StFsmStatus, deviceId: number) => {
      devices.push({
        id: deviceId,
        name: `FSM-${status.subsysIndex + 1}`,
        ipAddress: status.ipAddress,
        online: status.online,
        version: status.version || 'æœªçŸ¥',
        lastHeartbeat: status.lastHeartbeat
      })

      if (status.online) online++
    })

    // æŒ‰IDæ’åº
    devices.sort((a, b) => a.id - b.id)

    this.devices = devices
    this.onlineCount = online
    this.totalCount = devices.length
  }

  /**
   * æ ¼å¼åŒ–æœ€åå¿ƒè·³æ—¶é—´
   */
  private formatLastHeartbeat(timestamp: number): string {
    if (timestamp === 0) return 'ä»æœª'

    const now = Date.now()
    const diff = Math.floor((now - timestamp) / 1000)

    if (diff < 60) return `${diff}ç§’å‰`
    if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`
    return `${Math.floor(diff / 3600)}å°æ—¶å‰`
  }

  build() {
    Column({ space: 12 }) {
      // æ ‡é¢˜è¡Œ
      Row() {
        Text('ğŸ–¥ï¸ è®¾å¤‡çŠ¶æ€')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getCurrentTheme().textColor)
          .layoutWeight(1)

        Row({ space: 8 }) {
          Circle()
            .width(10)
            .height(10)
            .fill(this.onlineCount > 0 ? '#4CAF50' : '#F44336')

          Text(`${this.onlineCount}/${this.totalCount} åœ¨çº¿`)
            .fontSize(12)
            .fontColor(this.getCurrentTheme().subTextColor ?? this.getCurrentTheme().textColor)
        }
      }
      .width('100%')

      // è®¾å¤‡åˆ—è¡¨
      if (this.devices.length > 0) {
        Column({ space: 8 }) {
          ForEach(this.devices, (device: DeviceDisplayData) => {
            Row() {
              // çŠ¶æ€æŒ‡ç¤ºç¯
              Circle()
                .width(12)
                .height(12)
                .fill(device.online ? '#4CAF50' : '#F44336')
                .margin({ right: 12 })

              // è®¾å¤‡ä¿¡æ¯
              Column({ space: 4 }) {
                Text(device.name)
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(this.getCurrentTheme().textColor)

                Text(`${device.ipAddress} | ç‰ˆæœ¬: ${device.version}`)
                  .fontSize(11)
                  .fontColor(this.getCurrentTheme().subTextColor ?? this.getCurrentTheme().textColor)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)

              // æœ€åå¿ƒè·³
              Column() {
                Text(device.online ? 'åœ¨çº¿' : 'ç¦»çº¿')
                  .fontSize(12)
                  .fontColor(device.online ? '#4CAF50' : '#F44336')

                Text(this.formatLastHeartbeat(device.lastHeartbeat))
                  .fontSize(10)
                  .fontColor(this.getCurrentTheme().subTextColor ?? this.getCurrentTheme().textColor)
              }
              .alignItems(HorizontalAlign.End)
            }
            .width('100%')
            .padding(12)
            .backgroundColor(device.online ?
              (this.getCurrentTheme().surfaceColor ?? this.getCurrentTheme().backgroundColor) :
              '#FFEBEE')
            .borderRadius(8)
            .border({ width: 1, color: device.online ? this.getCurrentTheme().borderColor : '#FFCDD2' })
          })
        }
        .width('100%')
      } else {
        // æ— è®¾å¤‡
        Column({ space: 8 }) {
          Text('ğŸ“¡')
            .fontSize(32)

          Text('æš‚æ— è®¾å¤‡è¿æ¥')
            .fontSize(14)
            .fontColor(this.getCurrentTheme().subTextColor ?? this.getCurrentTheme().textColor)

          Text('ç­‰å¾…ä¸‹ä½æœºè¿æ¥...')
            .fontSize(12)
            .fontColor(this.getCurrentTheme().subTextColor ?? this.getCurrentTheme().textColor)
        }
        .width('100%')
        .height(120)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.getCurrentTheme().surfaceColor ?? this.getCurrentTheme().backgroundColor)
        .borderRadius(AppleDesignStyle.BORDER_RADIUS_MEDIUM)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(this.getCurrentTheme().surfaceColor ?? this.getCurrentTheme().backgroundColor)
    .borderRadius(AppleDesignStyle.BORDER_RADIUS_MEDIUM)
    .border({ width: 1, color: this.getCurrentTheme().borderColor })
  }
}
