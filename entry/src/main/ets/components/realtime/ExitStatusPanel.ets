/**
 * Âá∫Âè£Áä∂ÊÄÅÈù¢ÊùøÁªÑ‰ª∂
 * ÊòæÁ§∫ÂêÑÂá∫Âè£ÁöÑË£ÖÁÆ±Êï∞ÈáèÂíåÈáçÈáè
 * ÂØπÂ∫î48È°πÁõÆÁöÑÂá∫Âè£Áä∂ÊÄÅÊòæÁ§∫Âå∫Âüü
 */

import {
  GlobalDataInterface,
  GlobalRealtimeData,
  getGlobalDataInterface,
  DataChangeListener
} from '../../protocol/GlobalDataInterface'
import { ConstPreDefine } from '../../protocol/ConstPreDefine'
import { OmniThemeManager, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { getCurrentTheme } from '../../utils/theme/ThemeUtils'
import { AppleDesignStyle } from '../../utils/theme/AppleDesignStyle'

/**
 * Âá∫Âè£Êï∞ÊçÆÂ±ïÁ§∫È°π
 */
interface ExitData {
  index: number
  count: number
  weight: number
}

/**
 * Âá∫Âè£Áä∂ÊÄÅÈù¢ÊùøÁªÑ‰ª∂
 */
@Component
export struct ExitStatusPanel {
  @State private exitData: ExitData[] = []
  @State private maxExits: number = 48
  @State private displayColumns: number = 6

  private dataInterface: GlobalDataInterface = getGlobalDataInterface()
  private dataChangeListener: DataChangeListener | null = null

  getCurrentTheme(): ExtendedOmniThemeStyle {
    return getCurrentTheme(OmniThemeManager.getInstance().getCurrentTheme())
  }

  aboutToAppear(): void {
    // Ëé∑ÂèñÂàùÂßãÊï∞ÊçÆ
    this.updateExitData(this.dataInterface.getGlobalData())

    // Ê≥®ÂÜåÊï∞ÊçÆÂèòÂåñÁõëÂê¨Âô®
    this.dataChangeListener = (data: GlobalRealtimeData) => {
      this.updateExitData(data)
    }
    this.dataInterface.addDataChangeListener(this.dataChangeListener)
  }

  aboutToDisappear(): void {
    if (this.dataChangeListener) {
      this.dataInterface.removeDataChangeListener(this.dataChangeListener)
      this.dataChangeListener = null
    }
  }

  /**
   * Êõ¥Êñ∞Âá∫Âè£Êï∞ÊçÆ
   */
  private updateExitData(globalData: GlobalRealtimeData): void {
    const exits: ExitData[] = []
    const count = Math.min(this.maxExits, globalData.exitCount.length)

    for (let i = 0; i < count; i++) {
      if (globalData.exitCount[i] > 0 || i < 12) { // ÊòæÁ§∫ÊúâÊï∞ÊçÆÁöÑÊàñÂâç12‰∏™
        exits.push({
          index: i,
          count: globalData.exitCount[i],
          weight: globalData.exitWeight[i]
        })
      }
    }

    this.exitData = exits
  }

  /**
   * Ê†ºÂºèÂåñÈáçÈáè
   */
  private formatWeight(weightGram: number): string {
    if (weightGram >= 1000) {
      return (weightGram / 1000).toFixed(1) + 'kg'
    }
    return weightGram + 'g'
  }

  /**
   * Ëé∑ÂèñÂá∫Âè£Áä∂ÊÄÅÈ¢úËâ≤
   */
  private getExitColor(count: number): string {
    if (count === 0) return '#E0E0E0'
    if (count < 10) return '#A5D6A7'
    if (count < 50) return '#66BB6A'
    if (count < 100) return '#43A047'
    return '#2E7D32'
  }

  build() {
    Column({ space: 12 }) {
      // Ê†áÈ¢ò
      Row() {
        Text('üì¶ Âá∫Âè£Áä∂ÊÄÅ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getCurrentTheme().textColor)
          .layoutWeight(1)

        Text(`ÂÖ± ${this.exitData.length} ‰∏™Âá∫Âè£`)
          .fontSize(12)
          .fontColor(this.getCurrentTheme().subTextColor ?? this.getCurrentTheme().textColor)
      }
      .width('100%')

      // Âá∫Âè£ÁΩëÊ†º
      if (this.exitData.length > 0) {
        Grid() {
          ForEach(this.exitData, (exit: ExitData) => {
            GridItem() {
              Column({ space: 4 }) {
                // Âá∫Âè£ÁºñÂè∑
                Text(`Âá∫Âè£ ${exit.index + 1}`)
                  .fontSize(12)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(this.getCurrentTheme().textColor)

                // Êï∞Èáè
                Text(`${exit.count}`)
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(exit.count > 0 ? '#2E7D32' : '#9E9E9E')

                // ÈáçÈáè
                Text(this.formatWeight(exit.weight))
                  .fontSize(10)
                  .fontColor(this.getCurrentTheme().subTextColor ?? this.getCurrentTheme().textColor)
              }
              .width('100%')
              .height(80)
              .padding(8)
              .justifyContent(FlexAlign.Center)
              .backgroundColor(this.getExitColor(exit.count))
              .borderRadius(8)
              .border({ width: 1, color: this.getCurrentTheme().borderColor })
            }
          })
        }
        .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr')
        .rowsGap(8)
        .columnsGap(8)
        .width('100%')
      } else {
        // Êó†Êï∞ÊçÆ
        Column() {
          Text('ÊöÇÊó†Âá∫Âè£Êï∞ÊçÆ')
            .fontSize(14)
            .fontColor(this.getCurrentTheme().subTextColor ?? this.getCurrentTheme().textColor)
        }
        .width('100%')
        .height(100)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.getCurrentTheme().surfaceColor ?? this.getCurrentTheme().backgroundColor)
        .borderRadius(AppleDesignStyle.BORDER_RADIUS_MEDIUM)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(this.getCurrentTheme().surfaceColor ?? this.getCurrentTheme().backgroundColor)
    .borderRadius(AppleDesignStyle.BORDER_RADIUS_MEDIUM)
    .border({ width: 1, color: this.getCurrentTheme().borderColor })
  }
}
