/**
 * ÂÆûÊó∂Êï∞ÊçÆÈù¢ÊùøÁªÑ‰ª∂
 * ÊòæÁ§∫‰∫ßÈáè„ÄÅÊÄªÈáç„ÄÅÊïàÁéáÁ≠âÊ†∏ÂøÉÁªüËÆ°Êï∞ÊçÆ
 * ÂØπÂ∫î48È°πÁõÆÁöÑÂÆûÊó∂Êï∞ÊçÆÊòæÁ§∫Âå∫Âüü
 */

import {
  GlobalDataInterface,
  GlobalRealtimeData,
  getGlobalDataInterface,
  DataChangeListener
} from '../../protocol/GlobalDataInterface'
import { OmniThemeManager, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { getCurrentTheme } from '../../utils/theme/ThemeUtils'
import { AppleDesignStyle } from '../../utils/theme/AppleDesignStyle'

/**
 * ÂÆûÊó∂Êï∞ÊçÆÈù¢ÊùøÁªÑ‰ª∂
 * ÊòæÁ§∫ÂÖ≥ÈîÆÁªüËÆ°ÊåáÊ†á
 */
@Component
export struct RealtimeDataPanel {
  @State private realtimeData: GlobalRealtimeData | null = null
  @State private isProcessing: boolean = false

  private dataInterface: GlobalDataInterface = getGlobalDataInterface()
  private dataChangeListener: DataChangeListener | null = null

  getCurrentTheme(): ExtendedOmniThemeStyle {
    return getCurrentTheme(OmniThemeManager.getInstance().getCurrentTheme())
  }

  aboutToAppear(): void {
    // Ëé∑ÂèñÂàùÂßãÊï∞ÊçÆ
    this.realtimeData = this.dataInterface.getGlobalData()
    this.isProcessing = this.dataInterface.isCurrentlyProcessing()

    // Ê≥®ÂÜåÊï∞ÊçÆÂèòÂåñÁõëÂê¨Âô®
    this.dataChangeListener = (data: GlobalRealtimeData) => {
      this.realtimeData = data
      this.isProcessing = this.dataInterface.isCurrentlyProcessing()
    }
    this.dataInterface.addDataChangeListener(this.dataChangeListener)
  }

  aboutToDisappear(): void {
    // ÁßªÈô§ÁõëÂê¨Âô®
    if (this.dataChangeListener) {
      this.dataInterface.removeDataChangeListener(this.dataChangeListener)
      this.dataChangeListener = null
    }
  }

  /**
   * Ê†ºÂºèÂåñÈáçÈáèÔºàÂÖã -> ÂçÉÂÖãÔºâ
   */
  private formatWeight(weightGram: number): string {
    if (weightGram >= 1000000) {
      return (weightGram / 1000000).toFixed(2) + ' Âê®'
    } else if (weightGram >= 1000) {
      return (weightGram / 1000).toFixed(2) + ' kg'
    }
    return weightGram.toFixed(0) + ' g'
  }

  /**
   * Ê†ºÂºèÂåñÊó∂Èó¥ÔºàÁßí -> Êó∂:ÂàÜ:ÁßíÔºâ
   */
  private formatTime(seconds: number): string {
    const hours = Math.floor(seconds / 3600)
    const minutes = Math.floor((seconds % 3600) / 60)
    const secs = Math.floor(seconds % 60)

    if (hours > 0) {
      return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
    }
    return `${minutes}:${secs.toString().padStart(2, '0')}`
  }

  /**
   * ÊûÑÂª∫ÁªüËÆ°Âç°Áâá
   */
  @Builder
  private buildStatCard(title: string, value: string, unit: string, color: string, icon: string) {
    Column({ space: 8 }) {
      Row({ space: 8 }) {
        Text(icon)
          .fontSize(24)

        Text(title)
          .fontSize(14)
          .fontColor(this.getCurrentTheme().subTextColor ?? this.getCurrentTheme().textColor)
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)

      Row() {
        Text(value)
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .fontColor(color)

        Text(unit)
          .fontSize(14)
          .fontColor(this.getCurrentTheme().subTextColor ?? this.getCurrentTheme().textColor)
          .margin({ left: 4, bottom: 4 })
      }
      .alignItems(VerticalAlign.Bottom)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(this.getCurrentTheme().surfaceColor ?? this.getCurrentTheme().backgroundColor)
    .borderRadius(AppleDesignStyle.BORDER_RADIUS_MEDIUM)
    .border({ width: 1, color: this.getCurrentTheme().borderColor })
    .shadow(AppleDesignStyle.getShadowSmall())
  }

  build() {
    Column({ space: 16 }) {
      // Ê†áÈ¢òË°å
      Row() {
        Text('üìä ÂÆûÊó∂ÁªüËÆ°')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getCurrentTheme().textColor)
          .layoutWeight(1)

        // Áä∂ÊÄÅÊåáÁ§∫
        Row({ space: 8 }) {
          Circle()
            .width(10)
            .height(10)
            .fill(this.isProcessing ? '#4CAF50' : '#9E9E9E')

          Text(this.isProcessing ? 'Âä†Â∑•‰∏≠' : 'ÂæÖÊú∫')
            .fontSize(12)
            .fontColor(this.isProcessing ? '#4CAF50' : '#9E9E9E')
        }
      }
      .width('100%')

      // ‰∏ªË¶ÅÁªüËÆ°Âç°Áâá
      if (this.realtimeData) {
        // Á¨¨‰∏ÄË°åÔºö‰∫ßÈáèÂíåÊÄªÈáç
        Row({ space: 12 }) {
          Column() {
            this.buildStatCard(
              '‰∫ßÈáè',
              this.realtimeData.totalYield.toString(),
              '‰∏™',
              '#2196F3',
              'üçé'
            )
          }
          .layoutWeight(1)

          Column() {
            this.buildStatCard(
              'ÊÄªÈáç',
              this.formatWeight(this.realtimeData.totalWeight),
              '',
              '#4CAF50',
              '‚öñÔ∏è'
            )
          }
          .layoutWeight(1)
        }
        .width('100%')

        // Á¨¨‰∫åË°åÔºöÂêàÊ†ºÁéáÂíåÊïàÁéá
        Row({ space: 12 }) {
          Column() {
            const total = this.realtimeData.totalQualified + this.realtimeData.totalUnqualified
            const rate = total > 0 ? ((this.realtimeData.totalQualified / total) * 100).toFixed(1) : '0.0'
            this.buildStatCard(
              'ÂêàÊ†ºÁéá',
              rate,
              '%',
              '#FF9800',
              '‚úÖ'
            )
          }
          .layoutWeight(1)

          Column() {
            this.buildStatCard(
              'ÊïàÁéá',
              this.realtimeData.efficiency.toFixed(1),
              '‰∏™/ÂàÜ',
              '#9C27B0',
              '‚ö°'
            )
          }
          .layoutWeight(1)
        }
        .width('100%')

        // Á¨¨‰∏âË°åÔºöËøêË°åÊó∂Èó¥ÂíåËÆæÂ§áÁä∂ÊÄÅ
        Row({ space: 12 }) {
          Column() {
            this.buildStatCard(
              'ËøêË°åÊó∂Èó¥',
              this.formatTime(this.realtimeData.runningTime),
              '',
              '#607D8B',
              '‚è±Ô∏è'
            )
          }
          .layoutWeight(1)

          Column() {
            this.buildStatCard(
              'ÂêàÊ†º/‰∏çÂêàÊ†º',
              `${this.realtimeData.totalQualified}/${this.realtimeData.totalUnqualified}`,
              '',
              '#E91E63',
              'üìà'
            )
          }
          .layoutWeight(1)
        }
        .width('100%')

        // Á≠âÁ∫ßÂàÜÂ∏ÉÔºàÂèØÈÄâÂ±ïÂºÄÔºâ
        Column({ space: 8 }) {
          Text('Á≠âÁ∫ßÂàÜÂ∏É')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.getCurrentTheme().textColor)
            .width('100%')

          Row() {
            ForEach(this.realtimeData.gradeCount.slice(0, 8), (count: number, index: number) => {
              if (count > 0) {
                Column({ space: 4 }) {
                  Text(`${count}`)
                    .fontSize(12)
                    .fontColor(this.getCurrentTheme().textColor)

                  Text(`Á≠âÁ∫ß${index + 1}`)
                    .fontSize(10)
                    .fontColor(this.getCurrentTheme().subTextColor ?? this.getCurrentTheme().textColor)
                }
                .padding(8)
                .backgroundColor(this.getGradeColor(index))
                .borderRadius(6)
                .margin({ right: 4 })
              }
            })
          }
          .width('100%')
          .justifyContent(FlexAlign.Start)
        }
        .width('100%')
        .padding(16)
        .backgroundColor(this.getCurrentTheme().surfaceColor ?? this.getCurrentTheme().backgroundColor)
        .borderRadius(AppleDesignStyle.BORDER_RADIUS_MEDIUM)
        .border({ width: 1, color: this.getCurrentTheme().borderColor })
      } else {
        // Êó†Êï∞ÊçÆÊó∂ÊòæÁ§∫
        Column() {
          Text('ÊöÇÊó†ÁªüËÆ°Êï∞ÊçÆ')
            .fontSize(16)
            .fontColor(this.getCurrentTheme().subTextColor ?? this.getCurrentTheme().textColor)
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.getCurrentTheme().surfaceColor ?? this.getCurrentTheme().backgroundColor)
        .borderRadius(AppleDesignStyle.BORDER_RADIUS_MEDIUM)
      }
    }
    .width('100%')
    .padding(16)
  }

  /**
   * Ëé∑ÂèñÁ≠âÁ∫ßÂØπÂ∫îÁöÑÈ¢úËâ≤
   */
  private getGradeColor(gradeIndex: number): string {
    const colors = [
      '#E3F2FD', '#BBDEFB', '#90CAF9', '#64B5F6',
      '#42A5F5', '#2196F3', '#1E88E5', '#1976D2'
    ]
    return colors[gradeIndex % colors.length]
  }
}
