/**
 * å¯¼å‡ºæˆåŠŸå¯¹è¯æ¡†ç»„ä»¶
 * 
 * åŠŸèƒ½è¯´æ˜Žï¼š
 * - æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸçš„æç¤ºä¿¡æ¯
 * - æ˜¾ç¤ºå¯¼å‡ºæ–‡ä»¶è·¯å¾„å’Œå¯¼å‡ºæ•°é‡
 * - æä¾›ç¡®è®¤æŒ‰é’®å…³é—­å¯¹è¯æ¡†
 * 
 * ä½¿ç”¨æ–¹å¼ï¼š
 * ```typescript
 * ExportSuccessDialog({
 *   isVisible: this.showSuccessDialog,
 *   filePath: this.exportFilePath,
 *   exportCount: this.exportCount,
 *   onConfirm: () => { this.closeSuccessDialog() }
 * })
 * ```
 */

import { BaseComponentHelper } from '../common/BaseComponent'
import { OmniThemeManager, OmniThemeType, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { OMNI_THEME_KEY, OMNI_THEME_TYPE_KEY, OMNI_THEME_VERSION_KEY } from '../../utils/theme/useOmniTheme'

/**
 * å¯¼å‡ºæˆåŠŸå¯¹è¯æ¡†ç»„ä»¶ç»“æž„ä½“
 * 
 * å±žæ€§è¯´æ˜Žï¼š
 * - isVisible: å¯¹è¯æ¡†æ˜¾ç¤ºçŠ¶æ€
 * - filePath: å¯¼å‡ºæ–‡ä»¶è·¯å¾„
 * - exportCount: å¯¼å‡ºæ•°æ®æ¡æ•°
 * - onConfirm: ç¡®è®¤æŒ‰é’®ç‚¹å‡»å›žè°ƒå‡½æ•°
 * 
 * æ–¹æ³•è¯´æ˜Žï¼š
 * - getCurrentTheme(): èŽ·å–å½“å‰ä¸»é¢˜é…ç½®
 * - build(): æž„å»ºå¯¼å‡ºæˆåŠŸå¯¹è¯æ¡†çš„UIç»“æž„
 */
@Component
export struct ExportSuccessDialog {
  // ==================== å¯¹è¯æ¡†çŠ¶æ€ ====================
  /** å¯¹è¯æ¡†æ˜¾ç¤ºçŠ¶æ€ */
  @Prop isVisible: boolean = false
  /** å¯¼å‡ºæ–‡ä»¶è·¯å¾„ */
  @Prop filePath: string = ''
  /** å¯¼å‡ºæ•°æ®æ¡æ•° */
  @Prop exportCount: number = 0

  // ==================== äº‹ä»¶å›žè°ƒå‡½æ•° ====================
  /** ç¡®è®¤æŒ‰é’®ç‚¹å‡»å›žè°ƒå‡½æ•° */
  onConfirm?: () => void

  // ==================== ä¸»é¢˜ç›¸å…³å±žæ€§ ====================
  /** å½“å‰ä¸»é¢˜æ ·å¼ */
  @StorageLink(OMNI_THEME_KEY) consumedTheme: ExtendedOmniThemeStyle = OmniThemeManager.getInstance().getCurrentTheme()
  /** å½“å‰ä¸»é¢˜ç±»åž‹ */
  @StorageLink(OMNI_THEME_TYPE_KEY) consumedThemeType: OmniThemeType = OmniThemeManager.getInstance().getCurrentThemeType()
  /** ä¸»é¢˜ç‰ˆæœ¬å· */
  @StorageLink(OMNI_THEME_VERSION_KEY) themeVersion: number = 0
  /** åŸºç¡€ç»„ä»¶åŠ©æ‰‹ */
  private baseComponentHelper = new BaseComponentHelper()

  /**
   * èŽ·å–å½“å‰ä¸»é¢˜é…ç½®
   * 
   * åŠŸèƒ½è¯´æ˜Žï¼š
   * - ä»ŽåŸºç¡€ç»„ä»¶åŠ©æ‰‹èŽ·å–å½“å‰ä¸»é¢˜æ ·å¼
   * - ç”¨äºŽç»„ä»¶æ ·å¼é…ç½®
   * - æ”¯æŒä¸»é¢˜åˆ‡æ¢æ—¶çš„æ ·å¼æ›´æ–°
   * 
   * @returns å½“å‰ä¸»é¢˜çš„æ‰©å±•æ ·å¼å¯¹è±¡
   */
  getCurrentTheme(): ExtendedOmniThemeStyle {
    return this.baseComponentHelper.getCurrentTheme(this.consumedTheme)
  }

  /**
   * ç»„ä»¶æž„å»ºæ–¹æ³•
   * 
   * åŠŸèƒ½ï¼š
   * - æž„å»ºå¯¼å‡ºæˆåŠŸå¯¹è¯æ¡†çš„UIç»“æž„
   * - æ˜¾ç¤ºå¯¼å‡ºæˆåŠŸä¿¡æ¯å’Œæ–‡ä»¶è·¯å¾„
   * - å¤„ç†ç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
   * 
   * å¸ƒå±€è¯´æ˜Žï¼š
   * - ä½¿ç”¨Columnå¸ƒå±€åž‚ç›´æŽ’åˆ—
   * - æˆåŠŸå›¾æ ‡ + æ ‡é¢˜ + è¯¦ç»†ä¿¡æ¯ + ç¡®è®¤æŒ‰é’®
   * - å±…ä¸­æ˜¾ç¤ºï¼Œåœ†è§’è®¾è®¡
   * 
   * æ ·å¼è¯´æ˜Žï¼š
   * - å¯¹è¯æ¡†æ ·å¼ï¼šç™½è‰²èƒŒæ™¯ï¼Œåœ†è§’è®¾è®¡ï¼Œé˜´å½±æ•ˆæžœ
   * - å›¾æ ‡æ ·å¼ï¼šç»¿è‰²æˆåŠŸå›¾æ ‡
   * - æ–‡å­—æ ·å¼ï¼šä¸»é¢˜æ–‡å­—é¢œè‰²ï¼Œä¸åŒå­—ä½“å¤§å°
   * - æŒ‰é’®æ ·å¼ï¼šä¸»é¢˜èƒŒæ™¯è‰²ï¼Œç™½è‰²æ–‡å­—ï¼Œåœ†è§’è®¾è®¡
   */
  build() {
    if (this.isVisible) {
      Stack() {
        // èƒŒæ™¯é®ç½©
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.6)')
          .onClick(() => {
            if (this.onConfirm) {
              this.onConfirm()
            }
          })

        // å¯¹è¯æ¡†å†…å®¹
        Column() {
          // æˆåŠŸå›¾æ ‡åŒºåŸŸ - åœ†å½¢èƒŒæ™¯ + å‹¾å·
          Stack() {
            // åœ†å½¢èƒŒæ™¯
            Circle({ width: 80, height: 80 })
              .fill('#4CAF50')
            
            // æˆåŠŸå›¾æ ‡ - å±…ä¸­æ˜¾ç¤º
            Text('âœ“')
              .fontSize(40)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Bold)
          }
          .margin({ bottom: 20 })

          // æˆåŠŸæ ‡é¢˜
          Text('å¯¼å‡ºæˆåŠŸï¼')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getCurrentTheme().textColor)
            .margin({ bottom: 8 })

          // å¯¼å‡ºä¿¡æ¯
          Text(`å·²æˆåŠŸå¯¼å‡º ${this.exportCount} æ¡æ•°æ®`)
            .fontSize(16)
            .fontColor(this.getCurrentTheme().subTextColor)
            .margin({ bottom: 20 })

          // æ–‡ä»¶è·¯å¾„ä¿¡æ¯
          if (this.filePath) {
            Column() {
              Row() {
                Text('ðŸ“')
                  .fontSize(14)
                  .margin({ right: 6 })
                
                Text('æ–‡ä»¶ä¿å­˜ä½ç½®ï¼š')
                  .fontSize(13)
                  .fontColor(this.getCurrentTheme().textColor)
                  .fontWeight(FontWeight.Medium)
              }
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 6 })

              Text(this.filePath)
                .fontSize(11)
                .fontColor(this.getCurrentTheme().subTextColor)
                .textAlign(TextAlign.Start)
                .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
                .padding(8)
                .borderRadius(6)
                .border({ width: 1, color: this.getCurrentTheme().borderColor })
                .width('100%')
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .margin({ bottom: 20 })
          }

          // æŒ‰é’®åŒºåŸŸ
          Row() {
            Button('ç¡®å®š')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor(Color.White)
              .backgroundColor(this.getCurrentTheme().primary)
              .borderRadius(16)
              .height(52)
              .layoutWeight(1)
              .onClick(() => {
                if (this.onConfirm) {
                  this.onConfirm()
                }
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        }
        .width('90%')
        .constraintSize({ maxWidth: 480 })
        .padding({ top: 32, bottom: 32, left: 32, right: 32 })
        .backgroundColor(this.getCurrentTheme().backgroundColor)
        .borderRadius(24)
        .shadow({ 
          radius: 32, 
          color: 'rgba(0, 0, 0, 0.2)', 
          offsetX: 0, 
          offsetY: 12 
        })
      }
      .width('100%')
      .height('100%')
    }
  }
}
