/**
 * å‡ºå£å±è®¾ç½®å¯¹è¯æ¡†ç»„ä»¶
 * åŠŸèƒ½ï¼šé…ç½®å‡ºå£å±çš„ä¼‘çœ å¼€å…³ã€å¼€å±æ—¶é—´ã€æ¯å±æ—¶é—´ç­‰å‚æ•°
 */

import { OmniThemeManager, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { getCurrentTheme } from '../../utils/theme/ThemeUtils'
import { OMNI_THEME_KEY, OMNI_THEME_VERSION_KEY } from '../../utils/theme/useOmniTheme'
import { t, I18N_VERSION_KEY } from '../../utils/i18n/I18nManager'

@Component
export struct ExitScreenSettingsDialog {
  @Prop isVisible: boolean = false
  @StorageLink(OMNI_THEME_KEY) @Watch('onThemeChange') consumedTheme: ExtendedOmniThemeStyle = OmniThemeManager.getInstance().getCurrentTheme()
  @StorageLink(OMNI_THEME_VERSION_KEY) @Watch('onThemeChange') themeVersion: number = 0
  @StorageLink(I18N_VERSION_KEY) i18nVersion: number = 0

  // ä¼‘çœ å¼€å…³çŠ¶æ€
  @State sleepEnabled: boolean = true

  // å¼€å±æ—¶é—´
  @State screenOnTime: string = '10:53:02'
  @State selectedOnTime: Date = new Date()
  @State showOnTimePicker: boolean = false

  // æ¯å±æ—¶é—´
  @State screenOffTime: string = '00:00:00'
  @State selectedOffTime: Date = new Date()
  @State showOffTimePicker: boolean = false

  // å¯¹è¯æ¡†å›žè°ƒ
  onConfirm?: () => void
  onCancel?: () => void

  // èŽ·å–å½“å‰ä¸»é¢˜é…ç½®
  getCurrentTheme(): ExtendedOmniThemeStyle {
    return getCurrentTheme(this.consumedTheme)
  }

  // ç›‘å¬ä¸»é¢˜å˜åŒ–
  onThemeChange(): void {
    console.log('ExitScreenSettingsDialog: ä¸»é¢˜å·²å˜åŒ–ï¼Œé‡æ–°æ¸²æŸ“')
  }

  // å°†æ—¶é—´å­—ç¬¦ä¸²è½¬æ¢ä¸º Date å¯¹è±¡
  private parseTimeString(timeStr: string): Date {
    const parts = timeStr.split(':')
    const date = new Date()
    date.setHours(parseInt(parts[0] || '0'), parseInt(parts[1] || '0'), parseInt(parts[2] || '0'))
    return date
  }

  // å°† Date å¯¹è±¡æ ¼å¼åŒ–ä¸ºæ—¶é—´å­—ç¬¦ä¸² (HH:mm:ss)
  private formatTime(date: Date): string {
    const hours = date.getHours().toString().padStart(2, '0')
    const minutes = date.getMinutes().toString().padStart(2, '0')
    const seconds = date.getSeconds().toString().padStart(2, '0')
    return `${hours}:${minutes}:${seconds}`
  }

  // åˆå§‹åŒ–æ—¶é—´
  aboutToAppear(): void {
    this.selectedOnTime = this.parseTimeString(this.screenOnTime)
    this.selectedOffTime = this.parseTimeString(this.screenOffTime)
  }

  // ç¡®è®¤æŒ‰é’®ç‚¹å‡»
  private handleConfirm(): void {
    if (this.onConfirm) {
      this.onConfirm()
    }
  }

  // å–æ¶ˆ/å…³é—­æŒ‰é’®ç‚¹å‡»
  private handleCancel(): void {
    if (this.onCancel) {
      this.onCancel()
    }
  }

  build() {
    // å¯¹è¯æ¡†é®ç½©å±‚
    Stack() {
      if (!this.isVisible) {
        // ä¸å¯è§æ—¶è¿”å›žç©ºå†…å®¹
        Blank()
      } else {
        // èƒŒæ™¯é®ç½©
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            this.handleCancel()
          })

        // å¯¹è¯æ¡†å†…å®¹
        Column() {
          // æ ‡é¢˜æ ï¼ˆç»¿è‰²èƒŒæ™¯ï¼‰
          Row() {
            Text(t('å‡ºå£å±è®¾ç½®', 'å‡ºå£å±è®¾ç½®'))
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .layoutWeight(1)
              .textAlign(TextAlign.Center)

            Button() {
              Image($r('sys.media.ohos_ic_public_close'))
                .width(20)
                .height(20)
                .fillColor(Color.White)
            }
            .type(ButtonType.Normal)
            .backgroundColor(Color.Transparent)
            .width(32)
            .height(32)
            .onClick(() => {
              this.handleCancel()
            })
          }
          .width('100%')
          .height(48)
          .padding({ left: 20, right: 12, top: 8, bottom: 8 })
          .backgroundColor('#4CAF50')
          .justifyContent(FlexAlign.SpaceBetween)
          .alignItems(VerticalAlign.Center)

          // å†…å®¹åŒºåŸŸ
          Column() {
            // ä¼‘çœ å¼€å…³å¤é€‰æ¡†
            Row() {
              Checkbox({ name: 'sleepEnabled' })
                .select(this.sleepEnabled)
                .onChange((value: boolean) => {
                  this.sleepEnabled = value
                })
                .width(20)
                .height(20)
                .shape(CheckBoxShape.ROUNDED_SQUARE)

              Text(t('ä¼‘çœ å¼€å…³', 'ä¼‘çœ å¼€å…³'))
                .fontSize(16)
                .fontColor(this.getCurrentTheme().textColor)
                .margin({ left: 8 })
            }
            .width('100%')
            .alignItems(VerticalAlign.Center)
            .padding({ top: 20, bottom: 20, left: 20, right: 20 })

            // å¼€å±æ—¶é—´è®¾ç½®
            Column() {
              Row() {
                Text(t('å¼€å±æ—¶é—´:', 'å¼€å±æ—¶é—´:'))
                  .fontSize(16)
                  .fontColor(this.getCurrentTheme().textColor)
                  .width(100)

                TextInput({ text: this.screenOnTime })
                  .width(150)
                  .height(36)
                  .fontSize(16)
                  .fontColor(this.getCurrentTheme().textColor)
                  .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
                  .border({ width: 1, color: this.getCurrentTheme().borderColor })
                  .borderRadius(4)
                  .padding({ left: 8, right: 8 })
                  .onChange((value: string) => {
                    this.screenOnTime = value
                    this.selectedOnTime = this.parseTimeString(value)
                  })

                // æ—¥åŽ†å›¾æ ‡æŒ‰é’®
                Button() {
                  Text('ðŸ“…')
                    .fontSize(18)
                    .fontColor(this.getCurrentTheme().textColor)
                }
                .type(ButtonType.Normal)
                .backgroundColor(Color.Transparent)
                .width(32)
                .height(32)
                .margin({ left: 8 })
                .onClick(() => {
                  this.showOnTimePicker = !this.showOnTimePicker
                })
              }
              .width('100%')
              .alignItems(VerticalAlign.Center)

              // æ—¶é—´é€‰æ‹©å™¨
              if (this.showOnTimePicker) {
                TimePicker({
                  selected: this.selectedOnTime,
                  format: TimePickerFormat.HOUR_MINUTE_SECOND
                })
                  .useMilitaryTime(true)
                  .onChange((value: TimePickerResult) => {
                    if (value.hour >= 0) {
                      this.selectedOnTime.setHours(value.hour, value.minute, value.second || 0)
                      this.screenOnTime = this.formatTime(this.selectedOnTime)
                    }
                  })
                  .margin({ top: 8 })
                  .width('100%')
              }
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
            .padding({ left: 20, right: 20, bottom: 16 })

            // æ¯å±æ—¶é—´è®¾ç½®
            Column() {
              Row() {
                Text(t('æ¯å±æ—¶é—´:', 'æ¯å±æ—¶é—´:'))
                  .fontSize(16)
                  .fontColor(this.getCurrentTheme().textColor)
                  .width(100)

                TextInput({ text: this.screenOffTime })
                  .width(150)
                  .height(36)
                  .fontSize(16)
                  .fontColor(this.getCurrentTheme().textColor)
                  .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
                  .border({ width: 1, color: this.getCurrentTheme().borderColor })
                  .borderRadius(4)
                  .padding({ left: 8, right: 8 })
                  .onChange((value: string) => {
                    this.screenOffTime = value
                    this.selectedOffTime = this.parseTimeString(value)
                  })

                // æ—¥åŽ†å›¾æ ‡æŒ‰é’®
                Button() {
                  Text('ðŸ“…')
                    .fontSize(18)
                    .fontColor(this.getCurrentTheme().textColor)
                }
                .type(ButtonType.Normal)
                .backgroundColor(Color.Transparent)
                .width(32)
                .height(32)
                .margin({ left: 8 })
                .onClick(() => {
                  this.showOffTimePicker = !this.showOffTimePicker
                })
              }
              .width('100%')
              .alignItems(VerticalAlign.Center)

              // æ—¶é—´é€‰æ‹©å™¨
              if (this.showOffTimePicker) {
                TimePicker({
                  selected: this.selectedOffTime,
                  format: TimePickerFormat.HOUR_MINUTE_SECOND
                })
                  .useMilitaryTime(true)
                  .onChange((value: TimePickerResult) => {
                    if (value.hour >= 0) {
                      this.selectedOffTime.setHours(value.hour, value.minute, value.second || 0)
                      this.screenOffTime = this.formatTime(this.selectedOffTime)
                    }
                  })
                  .margin({ top: 8 })
                  .width('100%')
              }
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
            .padding({ left: 20, right: 20, bottom: 20 })
          }
          .width('100%')
          .layoutWeight(1)
          .backgroundColor(this.getCurrentTheme().surfaceColor)

          // åº•éƒ¨æŒ‰é’®åŒºåŸŸ
          Row() {
            Blank().layoutWeight(1)

            // ç¡®å®šæŒ‰é’®
            Button(t('ç¡®å®š', 'ç¡®å®š'))
              .fontSize(16)
              .fontColor(Color.White)
              .backgroundColor('#4CAF50')
              .borderRadius(8)
              .width(100)
              .height(40)
              .onClick(() => {
                this.handleConfirm()
              })
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 16, bottom: 20 })
          .backgroundColor(this.getCurrentTheme().surfaceColor)
        }
        .width(600)
        .height(500)
        .backgroundColor(this.getCurrentTheme().surfaceColor)
        .borderRadius(12)
        .shadow({
          radius: 20,
          color: 'rgba(0, 0, 0, 0.1)',
          offsetX: 0,
          offsetY: 4
        })
      }
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
  }
}

