/**
 * ç¬¬ä¸‰å±‚ç»„ä»¶
 * æ˜¾ç¤ºæ•°æ®åˆ—è¡¨ã€æ³¢æµªå›¾æˆ–å ä½ç¬¦
 */

import { ThreeLayerCardData } from './types'
import { WaveCard } from '../charts/WaveCard'
import { DragData } from '../../utils/ui/DragManager'
import { DragHandlers } from '../../utils/ui/DragHandlers'
import { CardColorConfig } from '../../utils/theme/CardColors'
import { UseDragHandlers } from './hooks/useDragHandlers'
import { WaveConfigManager } from '../../utils/ui/WaveConfig'

// è¿è¡ŒæœŸæ—¥å¿—å¼€å…³ï¼ˆä»…ç”¨äºå±è”½éå…³é”®è°ƒè¯•æ—¥å¿—ï¼‰
const DEBUG_LOGS: boolean = false

@Component
export struct ThirdLayer {
  @Prop cardData: ThreeLayerCardData
  @Prop enableWave: boolean
  @Prop localChartData: number[]
  @Prop localChartDataStrings: string[]
  @Prop hasOriginalFormatData: boolean
  @Prop pendingDragValue: string
  @Prop pendingDragIndex: number
  @Prop cardColors: CardColorConfig
  @Prop waveHeightPercent: number
  @Prop waveBaselinePercent: number
  @Prop cardNumber: number
  @State realtimePercent: number = 0

  // ç›‘å¬å…¨å±€æ›´æ–°ä¿¡å·ï¼Œå¼ºåˆ¶åˆ·æ–°
  @StorageProp('GLOBAL_CARD_DATA_UPDATE_SIGNAL') @Watch('onDataUpdate') dataUpdateSignal: number = 0

  onDataUpdate() {
    const key = `EXIT_PERCENT_${this.cardNumber}`
    if (AppStorage.has(key)) {
      this.realtimePercent = AppStorage.get(key) as number
    }
    this.forceWaveRedraw()
  }

  aboutToAppear() {
    const key = `EXIT_PERCENT_${this.cardNumber}`
    if (AppStorage.has(key)) {
      this.realtimePercent = AppStorage.get(key) as number
    }
    this.forceWaveRedraw()
  }

  // çˆ¶ç»„ä»¶åŒæ­¥æ‹–æ‹½ç¼“å­˜ï¼ˆå€¼ä¸ç´¢å¼•ï¼‰ï¼Œç”¨äº onDragEnd åˆ é™¤å‘½ä¸­
  onCachePending: (value: string, index: number) => void = () => {}
  onDropCallback: (event: DragEvent, extraParams: string) => void = () => {}
  onDragEnterCallback: () => void = () => {}
  onDragLeaveCallback: () => void = () => {}
  onTouchCallback: () => void = () => {}
  onClickCallback: () => void = () => {}
  deleteItemFromThirdLayer: () => void = () => {}

  // æ‹–æ‹½å¤„ç†å™¨
  private dragHandlers: DragHandlers = new DragHandlers()
  
  // æ»šåŠ¨æ§åˆ¶å™¨ï¼Œç¡®ä¿æ–°æ•°æ®ä»é¡¶éƒ¨å¼€å§‹æ˜¾ç¤º
  private scroller: Scroller = new Scroller()
  private lastDataLength: number = 0
  @State private scrollKey: number = 0 // ç”¨äºå¼ºåˆ¶é‡æ–°åˆ›å»ºScrollç»„ä»¶
  
  // åŒå‡»æ£€æµ‹ç›¸å…³
  private lastClickTime: number = 0
  private readonly DOUBLE_CLICK_INTERVAL: number = 300 // åŒå‡»é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

  build() {
    Stack({ alignContent: Alignment.TopStart }) {
      // 1. åº•å±‚ï¼šæ³¢æµªï¼ˆå¦‚æœå¯ç”¨ï¼‰
      if (this.enableWave || (Number.isFinite(this.realtimePercent) && this.realtimePercent > 0)) {
        this.buildWaveCard()
      }

      // 2. ä¸Šå±‚ï¼šæ•°æ®åˆ—è¡¨ï¼ˆå¦‚æœæœ‰æ•°æ®ï¼‰
      if (this.localChartData && this.localChartData.length > 0) {
        this.buildDataList()
      } else if (!this.enableWave) {
        // åªæœ‰å½“æ²¡æœ‰æ³¢æµªä¸”æ²¡æœ‰æ•°æ®æ—¶ï¼Œæ‰æ˜¾ç¤ºå ä½ç¬¦
        this.buildPlaceholder()
      }
    }
    .width('100%')
    .layoutWeight(1) // ç¬¬ä¸‰å±‚ï¼šè‡ªåŠ¨å¡«å……å‰©ä½™ç©ºé—´
    .padding({ left: 0, right: 0, top: 0, bottom: 0 })
    .backgroundColor(Color.Transparent) // ç¬¬ä¸‰å±‚ï¼šé€æ˜èƒŒæ™¯
    .border({ width: 1, color: this.cardColors.cardBorder }) // æ¢å¤åº•éƒ¨è¾¹æ¡†
    .onDrop((event: DragEvent, extraParams: string) => {
      if (DEBUG_LOGS) { console.log('ç¬¬ä¸‰å±‚onDropäº‹ä»¶è§¦å‘:', extraParams) }
      this.onDropCallback(event, extraParams)
    })
    .onTouch((event?: TouchEvent) => {
      if (!event) { return }
      
      // å…ˆæ‰§è¡ŒåŸæœ‰çš„è§¦æ‘¸å›è°ƒï¼ˆç”¨äºæ‹–æ‹½æ£€æµ‹ï¼‰
      this.onTouchCallback()
      
      // åŒå‡»æ£€æµ‹ï¼šå½“è§¦æ‘¸æŠ¬èµ·æ—¶æ£€æŸ¥æ—¶é—´é—´éš”
      if (event.type === TouchType.Up) {
        const currentTime = Date.now()
        const timeSinceLastClick = currentTime - this.lastClickTime
        // å¦‚æœä¸¤æ¬¡ç‚¹å‡»é—´éš”åœ¨é˜ˆå€¼å†…ï¼Œè®¤ä¸ºæ˜¯åŒå‡»
        if (timeSinceLastClick > 0 && timeSinceLastClick <= this.DOUBLE_CLICK_INTERVAL) {
          // åŒå‡»äº‹ä»¶
          console.log('ç¬¬ä¸‰å±‚è¢«åŒå‡»ï¼Œé€šçŸ¥çˆ¶ç»„ä»¶æ˜¾ç¤ºè¯¦æƒ…å¯¹è¯æ¡†')
          if (this.onClickCallback) {
            this.onClickCallback()
          }
          // é‡ç½®æ—¶é—´æˆ³ï¼Œé¿å…è¿ç»­è§¦å‘
          this.lastClickTime = 0
        } else {
          // æ›´æ–°æœ€åç‚¹å‡»æ—¶é—´
          this.lastClickTime = currentTime
        }
      }
    })
    .onDragEnter((event: DragEvent) => {
      if (DEBUG_LOGS) { console.log('ç¬¬ä¸‰å±‚onDragEnteräº‹ä»¶è§¦å‘') }
      this.onDragEnterCallback()
    })
    .onDragLeave((event: DragEvent) => {
      if (DEBUG_LOGS) { console.log('ç¬¬ä¸‰å±‚onDragLeaveäº‹ä»¶è§¦å‘') }
      this.onDragLeaveCallback()
    })
    .onTouch((event?: TouchEvent) => {
      if (!event) { return }
      // æ£€æµ‹åŒå‡»ï¼šå½“è§¦æ‘¸æŠ¬èµ·æ—¶æ£€æŸ¥æ—¶é—´é—´éš”
      if (event.type === TouchType.Up) {
        const currentTime = Date.now()
        const timeSinceLastClick = currentTime - this.lastClickTime
        
        // å¦‚æœä¸¤æ¬¡ç‚¹å‡»é—´éš”åœ¨é˜ˆå€¼å†…ï¼Œè®¤ä¸ºæ˜¯åŒå‡»
        if (timeSinceLastClick > 0 && timeSinceLastClick <= this.DOUBLE_CLICK_INTERVAL) {
          // åŒå‡»äº‹ä»¶
          console.log('ç¬¬ä¸‰å±‚è¢«åŒå‡»ï¼Œé€šçŸ¥çˆ¶ç»„ä»¶æ˜¾ç¤ºè¯¦æƒ…å¯¹è¯æ¡†')
          if (this.onClickCallback) {
            this.onClickCallback()
          }
          // é‡ç½®æ—¶é—´æˆ³ï¼Œé¿å…è¿ç»­è§¦å‘
          this.lastClickTime = 0
        } else {
          // æ›´æ–°æœ€åç‚¹å‡»æ—¶é—´
          this.lastClickTime = currentTime
        }
      }
    })
  }

  @Builder
  private buildDataList() {
    Scroll(this.scroller) {
      Column() {
        ForEach(this.localChartData as number[], (num: number, idx: number) => {
          this.buildDataItem(num, idx)
        })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      .justifyContent(FlexAlign.Start)
      .align(Alignment.TopStart) // å¼ºåˆ¶ä»é¡¶éƒ¨å¼€å§‹å¯¹é½
    }
    .width('100%')
    .height('100%')
    .scrollable(ScrollDirection.Vertical)
    .scrollBar(BarState.Auto)
    .scrollBarColor(this.cardColors.cardBorder)
    .scrollBarWidth(4)
    .edgeEffect(EdgeEffect.Spring)
    .align(Alignment.TopStart) // Scrollç»„ä»¶ä¹Ÿä»é¡¶éƒ¨å¼€å§‹
    .key(`${this.scrollKey}`) // ä½¿ç”¨keyå¼ºåˆ¶é‡æ–°åˆ›å»ºScrollç»„ä»¶
  }

  aboutToRender() {
    // å½“æ•°æ®é•¿åº¦å˜åŒ–æ—¶ï¼Œå¼ºåˆ¶é‡æ–°åˆ›å»ºScrollç»„ä»¶å¹¶æ»šåŠ¨åˆ°é¡¶éƒ¨
    if (this.localChartData.length !== this.lastDataLength) {
      // æ›´æ–°scrollKeyå¼ºåˆ¶é‡æ–°åˆ›å»ºScrollç»„ä»¶
      this.scrollKey++
      this.lastDataLength = this.localChartData.length
      console.log('ğŸ”„ ThirdLayer - æ•°æ®å˜åŒ–ï¼Œå¼ºåˆ¶é‡æ–°åˆ›å»ºScrollç»„ä»¶ï¼ŒscrollKey:', this.scrollKey)
    }
  }

  // å½“ç»„ä»¶å‡ºç°æ—¶ï¼Œç¡®ä¿æ»šåŠ¨åˆ°é¡¶éƒ¨
  onAppear(event: () => void) {
    setTimeout(() => {
      this.scroller.scrollTo({ xOffset: 0, yOffset: 0 })
    }, 100)
    return this
  }

  // åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®ï¼ˆä¸ä¸ºç©ºä¸”ä¸ä¸º0ï¼‰
  private hasData(num: number, idx: number): boolean {
    const hasNum = num !== 0 && num !== null && num !== undefined
    const str = this.localChartDataStrings[idx]
    const hasStr = str && str.trim() !== '' && str !== '0'
    return hasNum || !!hasStr
  }

  @Builder
  private buildDataItem(num: number, idx: number) {
    Row() {
      // ç§»é™¤åºå·æ˜¾ç¤ºï¼Œç›´æ¥æ˜¾ç¤ºæ•°æ®å†…å®¹
      Text(this.localChartDataStrings[idx] || String(num))
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.cardColors.dataListText)
        .draggable(true)
        .onDragStart((event: DragEvent, extraParams: string): DragItemInfo => {
          // ä½¿ç”¨æ¨¡å—åŒ–çš„æ‹–æ‹½ç®¡ç†å™¨
          // å°è¯•ä»æ˜ å°„ä¸­å–ç­‰çº§åï¼Œä¾¿äºè·¨å¡ç‰‡ç§»åŠ¨æ—¶ç›´æ¥æºå¸¦
          let carriedLevelName: string = ''
          try {
            const cardId = String(this.cardData.id || '')
            const mapRaw = AppStorage.get('CARD_ITEM_LEVEL_MAP') as Record<string, Record<string, string>> | null
            const mapObj: Record<string, Record<string, string>> = mapRaw ? mapRaw : {}
            // ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²è¿›è¡Œæ˜ å°„æŸ¥æ‰¾
            const originalValue = this.localChartDataStrings[idx] || String(num)
            carriedLevelName = (mapObj[cardId] && mapObj[cardId][originalValue]) ? String(mapObj[cardId][originalValue]) : ''
          } catch (_e) {}
          const originalValue = this.localChartDataStrings[idx] || String(num)
          console.log('ğŸš€ å¡ç‰‡æ‹–æ‹½å¼€å§‹:')
          console.log('  - idx:', idx)
          console.log('  - num:', num)
          console.log('  - localChartDataStrings[idx]:', this.localChartDataStrings[idx])
          console.log('  - originalValue:', originalValue)
          console.log('  - cardId:', String(this.cardData.id ?? ''))
          
          const dragData: DragData = {
            value: String(num),
            sourceTable: 'card_third_layer',
            rowIndex: 0,
            colIndex: 0,
            sourceCardId: String(this.cardData.id ?? ''),
            sourceValue: originalValue, // ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²
            itemIndex: Number(idx),
            levelName: carriedLevelName // æ·»åŠ ç­‰çº§åç§°
          }
          console.log('  - dragData:', JSON.stringify(dragData))
          
          // ä½¿ç”¨æ‹–æ‹½å¤„ç†å™¨å¼€å§‹æ‹–æ‹½
          this.dragHandlers.handleDragStart(dragData)
          
          // ç«‹å³æ ‡è®°ä¸ºå·²å¤„ç†ï¼Œé˜²æ­¢LevelTableçš„æ‹–æ‹½é€»è¾‘å¹²æ‰°
          UseDragHandlers.markDropHandled()
          
          // æœ¬åœ°å…œåº•ç¼“å­˜
          this.pendingDragValue = originalValue // ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²
          this.pendingDragIndex = Number(idx)
          // åŒæ­¥çˆ¶ç»„ä»¶ç¼“å­˜ï¼Œé¿å… onDragEnd æ—¶çˆ¶ä¾§æ‹¿ä¸åˆ°åŸå§‹å­—ç¬¦ä¸²
          this.onCachePending(this.pendingDragValue, this.pendingDragIndex)
          
          const extra: string = JSON.stringify(dragData)
          const info: DragItemInfo = {
            pixelMap: undefined,
            builder: undefined,
            extraInfo: String(extra)
          }
          return info
        })
        .onDragEnd(() => {
          // ä½¿ç”¨æ¨¡å—åŒ–çš„æ‹–æ‹½å¤„ç†å™¨å¤„ç†æ‹–æ‹½ç»“æŸ
          this.dragHandlers.handleDragEnd(
            () => {
              // åˆ é™¤é€»è¾‘ï¼šæ‹–æ‹½åˆ°ç©ºç™½åŒºåŸŸ
              console.log('ğŸŸ¡ ç§»åŠ¨éå¡ç‰‡åŒºåŸŸï¼Œæ‰§è¡Œåˆ é™¤é€»è¾‘')
              console.log('ğŸ—‘ï¸ åˆ é™¤é€»è¾‘è¯¦æƒ…: idx=', idx, 'num=', num, 'cardId=', String(this.cardData.id || ''))
              try {
                const valStr = this.pendingDragValue || this.localChartDataStrings[idx] || String(num)
                const cardId = String(this.cardData.id || '')
                if (DEBUG_LOGS) {
                  console.log('ğŸ—‘ï¸ åˆ é™¤é€»è¾‘è°ƒè¯•: idx=', idx, 'num=', num, 'valStr=', valStr, 'cardId=', cardId)
                }
                UseDragHandlers.emitRemoveLevelExit(cardId, valStr, this.cardNumber)
              } catch (_e) {}
              this.deleteItemFromThirdLayer()
            },
            () => {
              // å¤åˆ¶é€»è¾‘ï¼šæ‹–æ‹½åˆ°å…¶ä»–å¡ç‰‡
              console.log('ğŸŸ¢ æ‹–æ‹½åˆ°å…¶ä»–å¡ç‰‡ï¼Œæ‰§è¡Œå¤åˆ¶é€»è¾‘')
              console.log('ğŸŸ¢ å¤åˆ¶é€»è¾‘è¯¦æƒ…: idx=', idx, 'num=', num, 'cardId=', String(this.cardData.id || ''))
            }
          )
        })
    }
    .width('100%')
    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
    .margin({ bottom: 2 })
    .borderRadius(4) // æ·»åŠ åœ†è§’
    .backgroundColor(this.hasData(num, idx) ? 'rgba(135, 206, 235, 0.2)' : Color.Transparent) // æœ‰æ•°æ®æ—¶æ·»åŠ æ·¡è“è‰²èƒŒæ™¯ï¼ˆå¤©è“è‰²ï¼Œ20%é€æ˜åº¦ï¼‰
  }

  @Builder
  private buildWaveCard() {
    WaveCard({
      amplitude: this.getWaveAmplitude(),
      frequency: this.getWaveFrequency(),
      speed: 0.02,
      // ä¼˜å…ˆä½¿ç”¨å®æ—¶æ•°æ®
      waveHeightPercent: this.getWavePercentForDisplay(),
      baselinePercent: this.waveBaselinePercent,
      cardBackground: Color.Transparent,
      gradientLeft: this.cardColors.waveGradientLeft,
      gradientMid: this.cardColors.waveGradientMid,
      gradientRight: this.cardColors.waveGradientRight
    })
      .width('100%')
      .height('100%')
  }

  private getWavePercentForDisplay(): number {
    return Number.isFinite(this.realtimePercent) ? this.realtimePercent : this.waveHeightPercent
  }
  
  private forceWaveRedraw(): void {
    this.scrollKey++ // é€šè¿‡keyæ”¹å˜è§¦å‘å­æ ‘é‡å»ºï¼Œç¡®ä¿WaveCardçš„@Watchç”Ÿæ•ˆå¹¶é‡ç»˜
  }
  
  // è·å–å¡ç‰‡ç´¢å¼•
  private getCardIndex(): number {
    const cardId = String(this.cardData.id || '')
    // ä» card_0, card_1 ç­‰æ ¼å¼ä¸­æå–æ•°å­—
    const match = cardId.match(/card_(\d+)/)
    return match ? parseInt(match[1]) : 0
  }
  
  // è·å–æ³¢æµªæŒ¯å¹…
  private getWaveAmplitude(): number {
    const cardIndex = this.getCardIndex()
    const waveConfig = WaveConfigManager.getInstance().getWaveConfig(cardIndex)
    return waveConfig.amplitude
  }
  
  // è·å–æ³¢æµªé¢‘ç‡
  private getWaveFrequency(): number {
    const cardIndex = this.getCardIndex()
    const waveConfig = WaveConfigManager.getInstance().getWaveConfig(cardIndex)
    return waveConfig.frequency
  }

  @Builder
  private buildPlaceholder() {
    Column() {
      // å ä½å†…å®¹
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }
}
