/**
 * GridË°®Ê†ºÁªÑ‰ª∂ - ÊîØÊåÅÊãñÊãΩÂäüËÉΩ
 * 
 * ÂäüËÉΩËØ¥ÊòéÔºö
 * - ‰ΩøÁî®GridÁªÑ‰ª∂ÂÆûÁé∞Ë°®Ê†ºÂ∏ÉÂ±Ä
 * - ÊîØÊåÅÊãñÊãΩ‰∫§Êç¢ÂçïÂÖÉÊ†ºÂÜÖÂÆπ
 * - Âõ∫ÂÆöË°®Â§¥ÔºåÂèØÊªöÂä®Êï∞ÊçÆÂå∫Âüü
 * - ÂÖºÂÆπÂéüÊúâÁöÑTableRowÊï∞ÊçÆÁªìÊûÑ
 * 
 * Âü∫‰∫éÂçé‰∏∫ÂÆòÊñπÊúÄ‰Ω≥ÂÆûË∑µÔºö
 * https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-grid-drag-swap
 */

import { OmniThemeManager, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { TableRow } from './LevelTable'

// ÊãñÊãΩÊï∞ÊçÆÊé•Âè£
interface DragData {
  rowIndex: number
  colIndex: number
  value: string
  sourceTable: string
}

@Component
export struct GridTable {
  // Ë°®Ê†ºÂêçÂ≠ó - Áî®‰∫éÊï∞ÊçÆÁÆ°ÁêÜ
  @Prop tableName: string = 'default'
  // ÊòØÂê¶ÂÖÅËÆ∏ÊãñÊãΩÔºàÈªòËÆ§trueÔºå‰∏ªÈ°µÂèØÊåâ‰∏öÂä°ÂÖ≥Èó≠Ôºâ
  @Prop enableDrag: boolean = true
  
  // Ë°®Ê†ºÊï∞ÊçÆÔºà‰∫åÁª¥Â≠óÁ¨¶‰∏≤Ôºâ
  @Prop tableRows: TableRow[] = [
    ['AÁ∫ß', '15', '8', '5', '2'],
    ['BÁ∫ß', '10', '6', '3', '1'],
    ['CÁ∫ß', '5', '6', '2', '0']
  ]
  
  // Ë°®Ê†ºÊ†áÈ¢ò
  @Prop tableTitle: string = 'Á≠âÁ∫ßË°®'
  
  // Ë°®Â§¥Ê†áÈ¢òÔºà‰∏éÊØèË°åÂàóÊï∞‰∏ÄËá¥Ôºâ
  @Prop headerTitles: string[] = ['Á≠âÁ∫ß', '30', '20', '10', '0']
  
  // Ë°®Ê†ºÂÆΩÂ∫¶
  @Prop tableWidth: string = '55%'
  
  // Ë°®Ê†ºÊúÄÂ§ßÈ´òÂ∫¶ÔºàË∂ÖËøáÊ≠§È´òÂ∫¶ÂèØÊªöÂä®Ôºâ
  @Prop maxHeight: string = '300px'
  
  // Â§ñÂ±ÇÂÆπÂô®ËÉåÊôØËâ≤Ôºà‰∏ç‰º†Âàô‰ΩøÁî®‰∏ªÈ¢ò surfaceColorÔºâ
  @Prop containerBg: string = ''

  // ÂΩìÂâç‰∏ªÈ¢òÊ†∑Âºè
  private currentTheme: ExtendedOmniThemeStyle = OmniThemeManager.getInstance().getCurrentTheme()

  /**
   * Ëé∑ÂèñÂΩìÂâç‰∏ªÈ¢òÈÖçÁΩÆ
   */
  private getCurrentTheme(): ExtendedOmniThemeStyle {
    return this.currentTheme
  }

  /**
   * Ëé∑ÂèñÂàóÊ®°ÊùøÂ≠óÁ¨¶‰∏≤
   * Ê†πÊçÆË°®Â§¥Êï∞ÈáèÂä®ÊÄÅÁîüÊàêÁ≠âÂÆΩÂàóÊ®°Êùø
   */
  private getColumnsTemplate(): string {
    const columnCount = this.headerTitles.length
    return Array(columnCount).fill('1fr').join(' ')
  }

  /**
   * Â§ÑÁêÜÊãñÊãΩÂºÄÂßã‰∫ã‰ª∂
   * Âü∫‰∫éÂçé‰∏∫ÂÆòÊñπÊúÄ‰Ω≥ÂÆûË∑µÂÆûÁé∞
   */
  private handleDragStart(rowIndex: number, colIndex: number, cellValue: string): DragItemInfo {
    if (!this.enableDrag) {
      return { pixelMap: undefined, builder: undefined, extraInfo: '' }
    }

    const dragData: DragData = {
      rowIndex,
      colIndex,
      value: cellValue,
      sourceTable: this.tableName
    }

    const dragDataStr = JSON.stringify(dragData)
    console.log('üöÄ GridTable - ÂºÄÂßãÊãñÊãΩ:', dragDataStr)

    return {
      pixelMap: undefined,
      builder: undefined,
      extraInfo: dragDataStr
    }
  }

  /**
   * Â§ÑÁêÜÊãñÊãΩÊîæÁΩÆ‰∫ã‰ª∂
   * ÂÆûÁé∞ÂçïÂÖÉÊ†ºÂÜÖÂÆπ‰∫§Êç¢
   */
  private handleDrop(fromData: DragData, toRowIndex: number, toColIndex: number): void {
    if (!this.enableDrag) return

    const fromRowIndex = fromData.rowIndex
    const fromColIndex = fromData.colIndex

    // Â¶ÇÊûúÊòØÂêå‰∏Ä‰∏™ÂçïÂÖÉÊ†ºÔºå‰∏çÂ§ÑÁêÜ
    if (fromRowIndex === toRowIndex && fromColIndex === toColIndex) {
      return
    }

    console.log('üéØ GridTable - ÊãñÊãΩ‰∫§Êç¢:', fromData, 'Âà∞', toRowIndex, toColIndex)

    // ‰∫§Êç¢ÂçïÂÖÉÊ†ºÂÜÖÂÆπ
    const fromValue = this.tableRows[fromRowIndex][fromColIndex]
    const toValue = this.tableRows[toRowIndex][toColIndex]

    // ÂàõÂª∫Êñ∞ÁöÑÊï∞ÊçÆÊï∞ÁªÑÔºà‰øùÊåÅÂìçÂ∫îÂºèÔºâ
    const newTableRows = this.tableRows.map((row, rowIdx) => {
      if (rowIdx === fromRowIndex) {
        return row.map((cell, colIdx) => {
          if (colIdx === fromColIndex) {
            return toValue
          }
          return cell
        })
      } else if (rowIdx === toRowIndex) {
        return row.map((cell, colIdx) => {
          if (colIdx === toColIndex) {
            return fromValue
          }
          return cell
        })
      }
      return row
    })

    // Êõ¥Êñ∞Êï∞ÊçÆ
    this.tableRows = newTableRows
  }

  /**
   * ÊûÑÂª∫ÊãñÊãΩÈ¢ÑËßà
   */
  @Builder
  private buildDragPreview(cellValue: string) {
    Text(cellValue)
      .fontSize(24)
      .fontColor(Color.White)
      .backgroundColor('#007DFF')
      .padding(8)
      .borderRadius(6)
      .shadow({ radius: 8, color: 'rgba(0,0,0,0.3)', offsetY: 2 })
  }

  /**
   * ÊûÑÂª∫Ë°®Ê†ºÂçïÂÖÉÊ†º
   */
  @Builder
  private buildTableCell(cellValue: string, rowIndex: number, colIndex: number) {
    Text(cellValue)
      .fontSize(24)
      .fontColor(this.getCurrentTheme().textColor)
      .textAlign(TextAlign.Center)
      .width('100%')
      .height('100%')
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .border({ 
        width: { right: 1, bottom: 1 }, 
        color: this.getCurrentTheme().borderColor 
      })
      .padding(8)
  }

  /**
   * ÊûÑÂª∫Ë°®Â§¥ÂçïÂÖÉÊ†º
   */
  @Builder
  private buildHeaderCell(title: string, colIndex: number) {
    Text(title)
      .fontSize(26)
      .fontWeight(FontWeight.Bold)
      .fontColor(this.getCurrentTheme().textColor)
      .textAlign(TextAlign.Center)
      .width('100%')
      .height('100%')
      .backgroundColor(this.getCurrentTheme().controlBg ?? this.getCurrentTheme().surfaceColor)
      .border({ 
        width: { right: 1, bottom: 1 }, 
        color: this.getCurrentTheme().borderColor 
      })
      .padding(10)
  }

  build() {
    Column() {
      // Ë°®Ê†ºÊ†áÈ¢ò
      Text(this.tableTitle)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.getCurrentTheme().textColor)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 10 })

      // Ë°®Ê†ºÂÆπÂô®
      Column() {
        // Âõ∫ÂÆöË°®Â§¥Grid
        Grid() {
          ForEach(this.headerTitles, (title: string, colIndex: number) => {
            GridItem() {
              this.buildHeaderCell(title, colIndex)
            }
          })
        }
        .columnsTemplate(this.getColumnsTemplate())
        .columnsGap(0)
        .rowsGap(0)
        .width('100%')
        .height(50)

        // ÂèØÊªöÂä®Êï∞ÊçÆÂå∫Âüü
        Scroll() {
          Grid() {
            ForEach(this.tableRows, (row: TableRow, rowIndex: number) => {
              ForEach(row, (cellValue: string, colIndex: number) => {
                GridItem() {
                  this.buildTableCell(cellValue, rowIndex, colIndex)
                }
                .draggable(this.enableDrag)
                .onDragStart((event: DragEvent, extraParams: string): DragItemInfo => {
                  return this.handleDragStart(rowIndex, colIndex, cellValue)
                })
                .onDrop((event: DragEvent, extraParams: string) => {
                  try {
                    const dragData: DragData = JSON.parse(extraParams)
                    this.handleDrop(dragData, rowIndex, colIndex)
                  } catch (error) {
                    console.error('ÊãñÊãΩÊï∞ÊçÆËß£ÊûêÂ§±Ë¥•:', error)
                  }
                })
              })
            })
          }
          .columnsTemplate(this.getColumnsTemplate())
          .columnsGap(0)
          .rowsGap(0)
          .width('100%')
        }
        .width('100%')
        .height(this.maxHeight)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)
        .scrollBarColor(this.getCurrentTheme().borderColor)
        .scrollBarWidth(6)
        .friction(0.6)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
    }
    .width(this.tableWidth)
    .backgroundColor(this.containerBg || this.getCurrentTheme().surfaceColor)
    .border({ width: 1, color: this.getCurrentTheme().borderColor })
    .borderRadius(12)
    .padding(12)
    .margin({ top: 12, left: 12, right: 12, bottom: 8 })
    .alignItems(HorizontalAlign.Center)
    .justifyContent(FlexAlign.Center)
  }
}
