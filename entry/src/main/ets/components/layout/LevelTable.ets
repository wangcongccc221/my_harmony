/**
 * ç­‰çº§è¡¨æ ¼ç»„ä»¶
 * åŠŸèƒ½ï¼šæ˜¾ç¤ºç­‰çº§æ•°æ®çš„è¡¨æ ¼
 * ç”¨é€”ï¼šå¯å¤ç”¨çš„ç­‰çº§è¡¨æ ¼æ§ä»¶
 */

import { OmniThemeManager, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { TableRowComponent } from '../ui/tables/TableRow'
import { SimpleDraggableCell } from '../ui/tables/SimpleDraggableCell'
import { MultiSelectCell, MULTI_SELECT_CELLS_KEY, MULTI_SELECT_ACTIVE_KEY } from '../ui/tables/SimpleDraggableCell'
import { KeyCode } from '@kit.InputKit'; // é”®ç›˜é”®ç 
// é€šç”¨è¡¨æ ¼è¡Œï¼šæ¯è¡Œç”±è‹¥å¹²å­—ç¬¦ä¸²å•å…ƒæ ¼ç»„æˆ
export type TableRow = string[]

// å¤šé€‰çŠ¶æ€æ¥å£
interface MultiSelectState {
  cells: MultiSelectCell[]
  isActive: boolean
}

// æ‹–æ‹½æ•°æ®æ¥å£
interface DragData {
  rowIndex: number
  colIndex: number
  value: string
  sourceTable: string
}

// å¤šé€‰æ‹–æ‹½æ•°æ®æ¥å£
interface MultiSelectDragData {
  type: string
  cells: MultiSelectCell[]
  count: number
}

// å¤šé€‰æ‹–æ‹½å®Œæ•´è´Ÿè½½ï¼ˆæ‰©å±•ï¼šæºå¸¦æ¯ä¸ªå•å…ƒæ ¼å¯¹åº”çš„ç­‰çº§ååˆ—è¡¨ï¼‰
interface MultiSelectPayload {
  type: string
  cells: MultiSelectCell[]
  count: number
  levelNames?: string[]
}

// ç®€åŒ–å¤šé€‰æ‹–æ‹½æ•°æ®æ¥å£
interface SimplifiedMultiSelectData {
  type: string
  count: number
  values: string[]
}

// å¤šé€‰æ‹–æ‹½ç®€åŒ–è´Ÿè½½ï¼ˆæ‰©å±•ï¼šæºå¸¦ç­‰çº§ååˆ—è¡¨ï¼‰
interface SimpleMultiSelectPayload {
  type: string
  count: number
  values: string[]
  levelNames?: string[]
}

// æ•´åˆ—æ‹–æ‹½æ•°æ®æ¥å£
interface ColumnDragData {
  type: 'column'
  columnIndex: number
  columnHeader: string
  columnData: string[]
  levelNames: string[] // æ·»åŠ ç­‰çº§åç§°æ•°ç»„
  sourceTable: string
}

// æ•´è¡Œæ‹–æ‹½æ•°æ®æ¥å£
interface RowDragData {
  type: 'row'
  rowIndex: number
  rowData: string[]
  levelName: string // æ·»åŠ ç­‰çº§åç§°å­—æ®µ
  sourceTable: string
  outletInfo?: string // å‡ºå£ä¿¡æ¯ï¼ˆç”¨äºç­‰çº§ç»Ÿè®¡è¡¨ï¼‰
}

@Component
export struct LevelTable {
  // è¡¨æ ¼åå­— - ç”¨äºæ•°æ®ç®¡ç†
  @Prop tableName: string = 'default'
  // æ˜¯å¦å…è®¸æ‹–æ‹½ï¼ˆé»˜è®¤trueï¼Œä¸»é¡µå¯æŒ‰ä¸šåŠ¡å…³é—­ï¼‰
  @Prop enableDrag: boolean = true
  
  // è¡¨æ ¼æ•°æ®ï¼ˆäºŒç»´å­—ç¬¦ä¸²ï¼‰
  @Prop tableRows: TableRow[] = [
    ['Açº§', '15', '8', '5', '2'],
    ['Bçº§', '10', '6', '3', '1'],
    ['Cçº§', '5', '6', '2', '0']
  ]
  
  // è¡¨æ ¼æ ‡é¢˜
  @Prop tableTitle: string = 'ç­‰çº§è¡¨'
  
  // è¡¨å¤´æ ‡é¢˜ï¼ˆä¸æ¯è¡Œåˆ—æ•°ä¸€è‡´ï¼‰
  @Prop headerTitles: string[] = ['ç­‰çº§', '30', '20', '10', '0']
  
  // è¡¨æ ¼å®½åº¦
  @Prop tableWidth: string = '55%'
  
  // è¡¨æ ¼æœ€å¤§é«˜åº¦ï¼ˆè¶…è¿‡æ­¤é«˜åº¦å¯æ»šåŠ¨ï¼‰
  @Prop maxHeight: string = '300px'
  
  // å¤–å±‚å®¹å™¨èƒŒæ™¯è‰²ï¼ˆä¸ä¼ åˆ™ä½¿ç”¨ä¸»é¢˜ surfaceColorï¼‰
  @Prop containerBg: string = ''
  
  // å¤šé€‰çŠ¶æ€ç®¡ç†
  @State private selectedCells: Set<string> = new Set()
  @State private isMultiSelectMode: boolean = false
  
  // æ‹–æ‹½å›è°ƒï¼ˆä¿ç•™å ä½ï¼Œå½“å‰ä»¥å•å…ƒæ ¼æŠ•æ”¾ä¸ºä¸»ï¼‰
  // onRowDragStart?: (dragData: DragData) => void
  // onRowDragEnd?: () => void

  private getCurrentTheme(): ExtendedOmniThemeStyle {
    return OmniThemeManager.getInstance().getCurrentTheme()
  }

  // åˆ‡æ¢å•å…ƒæ ¼é€‰ä¸­çŠ¶æ€
  private toggleCellSelection(rowIndex: number, colIndex: number, cellText: string) {
    // æœªå¼€å¯æ‹–æ‹½/å¤šé€‰æ—¶ï¼Œç›´æ¥å¿½ç•¥
    if (!this.enableDrag) {
      return
    }
    const cellId = `${rowIndex}_${colIndex}`

    // ä» AppStorage è¯»å–æ˜¯å¦æŒ‰ä¸‹å·¦ Ctrlï¼ˆç”±é¡µé¢çº§ç›‘å¬ç»´æŠ¤ï¼‰
    const ctrlPressedRaw = AppStorage.get('HOME_CTRL_PRESSED') as boolean | undefined
    const isCtrlMultiSelect = ctrlPressedRaw === true

    if (isCtrlMultiSelect) {
      // Ctrl å¤šé€‰æ¨¡å¼ï¼šç±»ä¼¼ Excelï¼Œç‚¹å‡»æ—¶åˆ‡æ¢å½“å‰å•å…ƒæ ¼çš„é€‰ä¸­çŠ¶æ€ï¼ˆä¸æ¸…ç©ºå…¶ä»–é€‰ä¸­ï¼‰
      if (this.selectedCells.has(cellId)) {
        // å–æ¶ˆé€‰ä¸­
        this.selectedCells.delete(cellId)
        console.log('ğŸ”´ LevelTable - Ctrl å¤šé€‰æ¨¡å¼å–æ¶ˆé€‰ä¸­å•å…ƒæ ¼:', cellText)
      } else {
        // è¿½åŠ é€‰ä¸­
        this.selectedCells.add(cellId)
        console.log('ğŸŸ¢ LevelTable - Ctrl å¤šé€‰æ¨¡å¼é€‰ä¸­å•å…ƒæ ¼:', cellText)
      }
    } else {
      // å•é€‰æ¨¡å¼ï¼šæ¸…ç©ºå·²æœ‰é€‰ä¸­ï¼Œåªä¿ç•™å½“å‰å•å…ƒæ ¼
      this.selectedCells.clear()
      this.selectedCells.add(cellId)
      console.log('ğŸŸ¢ LevelTable - å•é€‰æ¨¡å¼é€‰ä¸­å•å…ƒæ ¼:', cellText)
    }

    // æ›´æ–°å¤šé€‰æ¨¡å¼çŠ¶æ€
    this.isMultiSelectMode = this.selectedCells.size > 1

    // æ›´æ–°å…¨å±€å¤šé€‰çŠ¶æ€
    this.updateGlobalMultiSelectState()

    console.log('ğŸ“Š LevelTable - å½“å‰é€‰ä¸­å•å…ƒæ ¼æ•°é‡:', this.selectedCells.size)
  }

  // æ›´æ–°å…¨å±€å¤šé€‰çŠ¶æ€
  private updateGlobalMultiSelectState() {
    // æœªå¼€å¯æ‹–æ‹½/å¤šé€‰æ—¶ï¼Œç›´æ¥å¿½ç•¥
    if (!this.enableDrag) {
      return
    }
    const selectedCellsArray: MultiSelectCell[] = []
    
    this.selectedCells.forEach(cellId => {
      const parts = cellId.split('_')
      const rowIndex = Number(parts[0])
      const colIndex = Number(parts[1])
      const cellText = this.tableRows[rowIndex]?.[colIndex] || ''
      
      selectedCellsArray.push({
        rowIndex: rowIndex,
        colIndex: colIndex,
        value: cellText,
        sourceTable: this.tableName,
        cellId: cellId
      })
    })
    
    const multiSelectState: MultiSelectState = {
      cells: selectedCellsArray,
      isActive: selectedCellsArray.length > 0
    }
    
    AppStorage.set(MULTI_SELECT_CELLS_KEY, multiSelectState)
    AppStorage.set(MULTI_SELECT_ACTIVE_KEY, multiSelectState.isActive)
    
    console.log('ğŸ”„ LevelTable - æ›´æ–°å…¨å±€å¤šé€‰çŠ¶æ€:', JSON.stringify(multiSelectState))
  }

  // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
  private clearAllSelections() {
    this.selectedCells.clear()
    this.isMultiSelectMode = false
    this.updateGlobalMultiSelectState()
    console.log('ğŸ§¹ LevelTable - æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€')
  }

  // æ£€æŸ¥å•å…ƒæ ¼æ˜¯å¦è¢«é€‰ä¸­
  private isCellSelected(rowIndex: number, colIndex: number): boolean {
    const cellId = `${rowIndex}_${colIndex}`
    return this.selectedCells.has(cellId)
  }

  // ç»Ÿä¸€å¤„ç†æ‹–æ‹½ç»“æŸæ—¥å¿—ä¸çŠ¶æ€æ¸…ç†
  private handleDragEnd(): void {
    console.log('ğŸ¯ LevelTable - æ‹–æ‹½ç»“æŸäº‹ä»¶è§¦å‘')
    const handled = AppStorage.get('GLOBAL_DROP_HANDLED') as boolean
    const lastValue = AppStorage.get('GLOBAL_DROP_VALUE') as string
    if (!handled && lastValue !== undefined) {
      console.log('ğŸŸ¡ ç§»åŠ¨éå¡ç‰‡åŒºåŸŸ ç§»åŠ¨å†…å®¹:', lastValue)
    }
    AppStorage.set('GLOBAL_DROP_HANDLED', false)
    AppStorage.set('GLOBAL_DROP_VALUE', '')
    this.clearAllSelections()
  }

  // æ„å»ºè‡ªå®šä¹‰å•å…ƒæ ¼
  @Builder
  private buildCustomCell(cellText: string, rowIndex: number, colIndex: number) {
    if (this.tableName === 'ç­‰çº§ç»Ÿè®¡è¡¨' && colIndex === 2 && rowIndex >= 0) {
      // ç”¨æ¨ªå‘ Scroll åŒ…è£¹ Textï¼Œä»…è¯¥åˆ—å¯å·¦å³æ‹–åŠ¨æŸ¥çœ‹
      Scroll() {
        Row() {
          Text(cellText)
            .fontSize(13)
            .fontColor(this.getCurrentTheme().subTextColor)
            .fontWeight(FontWeight.Normal)
            .textAlign(TextAlign.Start)
            .padding(0)
            .draggable(false) // ç¦ç”¨æ‹–æ‹½
            .onClick(() => {
              // å…è®¸ç‚¹å‡»ä»»æ„åˆ—è§¦å‘é€‰ä¸­ï¼ˆåŒ…å«ç­‰çº§åˆ—ï¼‰
              this.toggleCellSelection(rowIndex, colIndex, cellText)
            })
            .onDragStart((event: DragEvent, extraParams: string): DragItemInfo => {
              return { pixelMap: undefined, builder: undefined, extraInfo: '' }
            })
            .onDragEnd(() => {
              return
            })
        }
      }
      .layoutWeight(1)
      .padding(6)
      // é€‰ä¸­æ—¶ï¼šèƒŒæ™¯æ›´é²œè‰³ + ä¸»é¢˜è‰²è¾¹æ¡†åŠ ç²—ï¼Œæ›´æ˜¾çœ¼
      .backgroundColor(this.isCellSelected(rowIndex, colIndex) ? (this.getCurrentTheme().primary + 'AA') : this.getCurrentTheme().surfaceColor)
      .border({
        width: this.isCellSelected(rowIndex, colIndex) ? { right: 2, top: 2, bottom: 2, left: 2 } : { right: 1 },
        color: this.isCellSelected(rowIndex, colIndex) ? this.getCurrentTheme().primary : this.getCurrentTheme().borderColor
      })
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Auto)
      .scrollBarWidth(6)
    } else {
      // å¸¸è§„å•å…ƒæ ¼
      Text(cellText)
        .fontSize(26)
        .fontColor(this.isCellSelected(rowIndex, colIndex) ? this.getCurrentTheme().primary : this.getCurrentTheme().subTextColor)
        .fontWeight(this.isCellSelected(rowIndex, colIndex) ? FontWeight.Medium : FontWeight.Normal)
        .textAlign(TextAlign.Center)
        .layoutWeight(1)
        .padding(10)
        // é€‰ä¸­æ—¶ï¼šèƒŒæ™¯æ›´é²œè‰³ + ä¸»é¢˜è‰²è¾¹æ¡†åŠ ç²—ï¼Œæ›´æ˜¾çœ¼
        .backgroundColor(this.isCellSelected(rowIndex, colIndex) ? (this.getCurrentTheme().primary + 'AA') : this.getCurrentTheme().surfaceColor)
        .border({
          width: this.isCellSelected(rowIndex, colIndex) ? { right: 2, top: 2, bottom: 2, left: 2 } : { right: 1 },
          color: this.isCellSelected(rowIndex, colIndex) ? this.getCurrentTheme().primary : this.getCurrentTheme().borderColor
        })
        .draggable(this.enableDrag)
        .onClick(() => {
          // å…è®¸ç‚¹å‡»ä»»æ„åˆ—è§¦å‘é€‰ä¸­ï¼ˆåŒ…å«ç­‰çº§åˆ—ï¼‰
          this.toggleCellSelection(rowIndex, colIndex, cellText)
        })
        .onDragStart((event: DragEvent, extraParams: string): DragItemInfo => {
          if (!this.enableDrag) {
            return { pixelMap: undefined, builder: undefined, extraInfo: '' }
          }
          // ç¬¬ä¸€åˆ—ï¼ˆç­‰çº§åˆ—ï¼‰æ‹–æ‹½æ•´è¡Œï¼Œå…¶ä»–åˆ—æ‹–æ‹½å•ä¸ªå•å…ƒæ ¼
          if (colIndex === 0) {
            return this.handleRowDragStart(rowIndex)
          } else {
            return this.handleDragStart(rowIndex, colIndex, cellText)
          }
        })
        .onDragEnd(() => {
          if (!this.enableDrag) {
            return
          }
          this.handleDragEnd()
        })
    }
  }

  // å¤„ç†æ•´åˆ—æ‹–æ‹½å¼€å§‹
  private handleColumnDragStart(colIndex: number, columnHeader: string): DragItemInfo {
    // æ”¶é›†æ•´åˆ—æ•°æ®
    const columnData: string[] = this.tableRows.map(row => row[colIndex] || '')
    // æ”¶é›†å¯¹åº”çš„ç­‰çº§åç§°ï¼ˆæ¯è¡Œçš„ç¬¬ä¸€åˆ—ï¼‰
    const levelNames: string[] = this.tableRows.map(row => row[0] || '')
    
    const columnDragData: ColumnDragData = {
      type: 'column',
      columnIndex: colIndex,
      columnHeader: columnHeader,
      columnData: columnData,
      levelNames: levelNames,
      sourceTable: this.tableName
    }
    
    const dragDataStr: string = JSON.stringify(columnDragData)
    console.log('ğŸš€ LevelTable - å¼€å§‹æ•´åˆ—æ‹–æ‹½:', columnHeader, 'æ•°æ®:', dragDataStr)
    
    // è®°å½•å…¨å±€æœªæ¥æ”¶çŠ¶æ€åŠæ‹–æ‹½å†…å®¹ï¼ˆæ•´åˆ—ç”¨é€—å·æ‹¼æ¥ï¼‰
    const joined = columnData.join(',')
    // æ³¨æ„ï¼šä¸è¦é‡ç½®GLOBAL_DROP_HANDLEDï¼Œå› ä¸ºThirdLayerå¯èƒ½å·²ç»è®¾ç½®äº†å®ƒ
    AppStorage.set('GLOBAL_DROP_VALUE', joined)
    
    const dragItemInfo: DragItemInfo = {
      pixelMap: undefined,
      builder: undefined,
      extraInfo: dragDataStr
    }
    
    return dragItemInfo
  }

  // å¤„ç†æ•´è¡Œæ‹–æ‹½å¼€å§‹
  private handleRowDragStart(rowIndex: number): DragItemInfo {
    // è·å–æ•´è¡Œæ•°æ®ï¼Œä½†æ’é™¤ç¬¬ä¸€åˆ—ï¼ˆç­‰çº§åç§°ï¼‰
    const fullRowData: string[] = this.tableRows[rowIndex] || []
    const rowData: string[] = fullRowData.slice(1) // æ’é™¤ç¬¬ä¸€åˆ—ï¼ˆç­‰çº§åç§°ï¼‰
    const levelName: string = fullRowData[0] || '' // ç¬¬ä¸€åˆ—æ˜¯ç­‰çº§åç§°
    
    // å¦‚æœæ˜¯ç­‰çº§ç»Ÿè®¡è¡¨ï¼Œéœ€è¦æå–å‡ºå£ä¿¡æ¯
    let outletInfo: string = ''
    if (this.tableName === 'ç­‰çº§ç»Ÿè®¡è¡¨' && fullRowData.length > 2) {
      outletInfo = fullRowData[2] || '' // ç¬¬3åˆ—æ˜¯å‡ºå£ä¿¡æ¯
    }
    
    const rowDragData: RowDragData = {
      type: 'row',
      rowIndex: rowIndex,
      rowData: rowData,
      levelName: levelName, // æ·»åŠ ç­‰çº§åç§°
      sourceTable: this.tableName,
      outletInfo: outletInfo // æ·»åŠ å‡ºå£ä¿¡æ¯
    }
    
    const dragDataStr: string = JSON.stringify(rowDragData)
    console.log('ğŸš€ LevelTable - å¼€å§‹æ•´è¡Œæ‹–æ‹½:', `ç¬¬${rowIndex + 1}è¡Œ`, 'æ•°æ®:', dragDataStr, 'å‡ºå£:', outletInfo)
    
    // è®°å½•å…¨å±€æœªæ¥æ”¶çŠ¶æ€åŠæ‹–æ‹½å†…å®¹ï¼ˆæ•´è¡Œç”¨é€—å·æ‹¼æ¥ï¼Œæ’é™¤ç­‰çº§åç§°ï¼‰
    const joined = rowData.join(',')
    // æ³¨æ„ï¼šä¸è¦é‡ç½®GLOBAL_DROP_HANDLEDï¼Œå› ä¸ºThirdLayerå¯èƒ½å·²ç»è®¾ç½®äº†å®ƒ
    AppStorage.set('GLOBAL_DROP_VALUE', joined)
    
    const dragItemInfo: DragItemInfo = {
      pixelMap: undefined,
      builder: undefined,
      extraInfo: dragDataStr
    }
    
    return dragItemInfo
  }

  // å¤„ç†æ‹–æ‹½å¼€å§‹
  private handleDragStart(rowIndex: number, colIndex: number, cellText: string): DragItemInfo {
    // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªé€‰ä¸­çš„å•å…ƒæ ¼
    if (this.isMultiSelectMode && this.selectedCells.size > 1) {
      // å¤šé€‰æ‹–æ‹½ï¼šä½¿ç”¨æ‰€æœ‰é€‰ä¸­çš„å•å…ƒæ ¼æ•°æ®
      console.log('ğŸ¯ LevelTable - å¼€å§‹å¤šé€‰æ‹–æ‹½ï¼Œé€‰ä¸­å•å…ƒæ ¼æ•°é‡:', this.selectedCells.size)
      
      const selectedCellsArray: MultiSelectCell[] = []
      this.selectedCells.forEach(cellId => {
        const parts = cellId.split('_')
        const r = Number(parts[0])
        const c = Number(parts[1])
        const text = this.tableRows[r]?.[c] || ''
        selectedCellsArray.push({
          rowIndex: r,
          colIndex: c,
          value: text,
          sourceTable: this.tableName,
          cellId: cellId
        })
      })
      
      // ä½¿ç”¨æ›´ç®€æ´çš„æ•°æ®æ ¼å¼ï¼Œé¿å…é•¿åº¦é™åˆ¶
      // ç”Ÿæˆä¸cellså¯¹é½çš„ç­‰çº§åæ•°ç»„ï¼ˆå–å„è¡Œé¦–åˆ—ï¼‰
      const levelNamesArr: string[] = selectedCellsArray.map((cell) => {
        return (this.tableRows[cell.rowIndex] && this.tableRows[cell.rowIndex][0]) ? String(this.tableRows[cell.rowIndex][0]) : ''
      })
      const dragData: MultiSelectPayload = {
        type: 'multi_select',
        cells: selectedCellsArray,
        count: selectedCellsArray.length,
        levelNames: levelNamesArr
      }
      const dragDataStr: string = JSON.stringify(dragData)
      console.log('ğŸ¯ LevelTable - å¤šé€‰æ‹–æ‹½æ•°æ®:', dragDataStr)
      console.log('ğŸ¯ LevelTable - å¤šé€‰æ‹–æ‹½æ•°æ®é•¿åº¦:', dragDataStr.length)

      // è®°å½•å…¨å±€æœªæ¥æ”¶çŠ¶æ€åŠæ‹–æ‹½å†…å®¹ï¼ˆå¤šé€‰ä½¿ç”¨é€—å·æ‹¼æ¥ï¼‰
      const joined = selectedCellsArray.map(cell => String(cell.value)).join(',')
      AppStorage.set('GLOBAL_DROP_HANDLED', false)
      AppStorage.set('GLOBAL_DROP_VALUE', joined)
      
      // å¦‚æœæ•°æ®å¤ªé•¿ï¼Œä½¿ç”¨ç®€åŒ–æ ¼å¼
      if (dragDataStr.length > 100) {
        const simplifiedData: SimpleMultiSelectPayload = {
          type: 'multi_select',
          count: selectedCellsArray.length,
          values: selectedCellsArray.map(cell => cell.value),
          levelNames: levelNamesArr
        }
        const simplifiedStr = JSON.stringify(simplifiedData)
        console.log('ğŸ¯ LevelTable - ä½¿ç”¨ç®€åŒ–æ•°æ®æ ¼å¼:', simplifiedStr)
        console.log('ğŸ¯ LevelTable - ç®€åŒ–æ•°æ®é•¿åº¦:', simplifiedStr.length)
        
        const dragItemInfo: DragItemInfo = {
          pixelMap: undefined,
          builder: undefined,
          extraInfo: simplifiedStr
        }
        console.log('ğŸ¯ LevelTable - è¿”å›çš„ç®€åŒ–DragItemInfo:', JSON.stringify(dragItemInfo))
        return dragItemInfo
      }
      
      const dragItemInfo: DragItemInfo = {
        pixelMap: undefined,
        builder: undefined,
        extraInfo: dragDataStr
      }
      console.log('ğŸ¯ LevelTable - è¿”å›çš„DragItemInfo:', JSON.stringify(dragItemInfo))
      return dragItemInfo
    } else {
      // å•é€‰æ‹–æ‹½ï¼šä½¿ç”¨å½“å‰å•å…ƒæ ¼æ•°æ®ï¼Œå¹¶é™„å¸¦ç­‰çº§åï¼ˆå–è¯¥è¡Œç¬¬ä¸€åˆ—ï¼‰
      const levelName: string = (this.tableRows[rowIndex] && this.tableRows[rowIndex][0]) ? String(this.tableRows[rowIndex][0]) : ''
      const dragDataStr: string = JSON.stringify({
        rowIndex: rowIndex,
        colIndex: colIndex,
        value: cellText,
        sourceTable: this.tableName,
        levelName: levelName
      })
      console.log('ğŸš€ LevelTable - å¼€å§‹æ‹–æ‹½å•å…ƒæ ¼æ•°æ®:', dragDataStr)

      // è®°å½•å…¨å±€æœªæ¥æ”¶çŠ¶æ€åŠæ‹–æ‹½å†…å®¹ï¼ˆå•é€‰ï¼‰
      // æ³¨æ„ï¼šä¸è¦é‡ç½®GLOBAL_DROP_HANDLEDï¼Œå› ä¸ºThirdLayerå¯èƒ½å·²ç»è®¾ç½®äº†å®ƒ
      AppStorage.set('GLOBAL_DROP_VALUE', String(cellText))
      
      const dragItemInfo: DragItemInfo = {
        pixelMap: undefined,
        builder: undefined,
        extraInfo: dragDataStr
      }
      return dragItemInfo
    }
  }


  build() {
    Column() {
      // è¡¨æ ¼æ ‡é¢˜
      Text(this.tableTitle)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.getCurrentTheme().textColor)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 10 })

      // é€šç”¨è¡¨æ ¼ï¼ˆå¸¦æ»šåŠ¨åŠŸèƒ½ï¼‰
      Column() {
        // è¡¨å¤´ï¼ˆå›ºå®šä¸æ»šåŠ¨ï¼‰
        Row() {
          ForEach(this.headerTitles, (title: string, idx: number) => {
            // ç¬¬ä¸€åˆ—ï¼ˆç­‰çº§åˆ—ï¼‰ä¸å…è®¸æ‹–æ‹½ï¼Œå…¶ä»–åˆ—å…è®¸æ•´åˆ—æ‹–æ‹½
            if (idx === 0) {
              SimpleDraggableCell({
                text: title,
                rowIndex: -1,
                colIndex: idx,
                fontSize: (this.tableName === 'ç­‰çº§ç»Ÿè®¡è¡¨' ? 24 : 26),
                cellPadding: 10,
                isHeader: true,
                canDrag: false
              })
            } else {
              // å¯æ‹–æ‹½çš„è¡¨å¤´å•å…ƒæ ¼
              Text(title)
                .fontSize(this.tableName === 'ç­‰çº§ç»Ÿè®¡è¡¨' ? 24 : 26)
                .fontColor(this.getCurrentTheme().tableHeaderTextColor ?? this.getCurrentTheme().textColor)
                .fontWeight(FontWeight.Bold)
                .textAlign(TextAlign.Center)
                .layoutWeight(1)
                .padding(10)
                .backgroundColor(this.getCurrentTheme().tableHeaderBg ?? this.getCurrentTheme().surfaceColor)
                .border({ width: { right: 1 }, color: this.getCurrentTheme().borderColor })
                .draggable(this.enableDrag)
                .onDragStart((event: DragEvent, extraParams: string): DragItemInfo => {
                  if (!this.enableDrag) {
                    return { pixelMap: undefined, builder: undefined, extraInfo: '' }
                  }
                  return this.handleColumnDragStart(idx, title)
                })
                .onDragEnd(() => {
                  if (!this.enableDrag) {
                    return
                  }
                  this.handleDragEnd()
                })
            }
          })
        }
        .width('100%')

        // æ•°æ®è¡Œï¼ˆå¯æ»šåŠ¨åŒºåŸŸï¼‰
        Scroll() {
          Column() {
            ForEach(this.tableRows, (row: TableRow, rowIndex: number) => {
              Row() {
                ForEach(row, (cellText: string, colIndex: number) => {
                  this.buildCustomCell(cellText, rowIndex, colIndex)
                })
              }
              .width('100%')
              .draggable(this.enableDrag)
              .onDragStart((event: DragEvent, extraParams: string): DragItemInfo => {
                if (!this.enableDrag) {
                  return { pixelMap: undefined, builder: undefined, extraInfo: '' }
                }
                return this.handleRowDragStart(rowIndex)
              })
              .onDragEnd(() => {
                if (!this.enableDrag) {
                  return
                }
                this.handleDragEnd()
              })
            })
          }
          .width('100%')
        }
        .width('100%')
        .height(this.maxHeight)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)
        .scrollBarColor(this.getCurrentTheme().borderColor)
        .scrollBarWidth(6)
        .friction(0.6) // è¿›ä¸€æ­¥å‡å°‘æ‘©æ“¦ç³»æ•°ï¼Œæå‡æµç•…åº¦
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
    }
    .width(this.tableWidth)
    .backgroundColor(this.containerBg || this.getCurrentTheme().surfaceColor)
    .border({ width: 1, color: this.getCurrentTheme().borderColor })
    .borderRadius(12)
    .padding(12)
    .margin({ top: 12, left: 12, right: 12, bottom: 8 })
    .alignItems(HorizontalAlign.Center)
    .justifyContent(FlexAlign.Center)
    .focusable(true)
    .onKeyEvent((event) => {
      // åªè¦æ£€æµ‹åˆ°å·¦ Ctrlï¼ˆæŒ‰ä¸‹/æŠ¬èµ·éƒ½ä¼šè¿›æ¥ï¼‰å°±æ‰“å°
      if (event.keyCode === KeyCode.KEYCODE_CTRL_LEFT) {
        console.log('æŒ‰äº†å·¦Ctrl');
      }
    })
  }
}
