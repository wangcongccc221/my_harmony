import { OmniThemeManager, ExtendedOmniThemeStyle } from '../../utils/theme/OmniThemeManager'
import { OMNI_THEME_VERSION_KEY } from '../../utils/theme/useOmniTheme'
import { TOP_PRODUCTION_TON_H, TOP_SUM_WEIGHT_TON, TOP_SUM_COUNTS, TOP_AVG_G, TOP_STATUS_TEXT, TOP_ALERT_HIDE, TCP_CONNECTION_STATUS } from '../../constants/TopBarKeys'
import { CompactFsmToggle } from './CompactFsmToggle'
import { IBestAvatar, IBestButton } from '@ibestservices/ibest-ui'
import common from '@ohos.app.ability.common'
import { MinimizeAppUtil } from '../../utils/window/MinimizeAppUtil'
import { AppleDesignStyle } from '../../utils/theme/AppleDesignStyle'
import { ThreeDButton } from '../ui/buttons/ThreeDButton'
import { ProfileInfoBar } from './ProfileInfoBar'

@Component
export struct TopStatusBar {
  @Prop currentPage: string = ''
  @StorageLink(TOP_PRODUCTION_TON_H) productionTonPerHour: string = '--'
  @StorageLink(TOP_SUM_WEIGHT_TON) sumWeightTon: string = '--'
  @StorageLink(TOP_SUM_COUNTS) sumCounts: string = '--'
  @StorageLink(TOP_AVG_G) avgGram: string = '--'
  @StorageLink(TOP_STATUS_TEXT) statusText: string = ''
  @StorageLink(TOP_ALERT_HIDE) alertHide: boolean = true
  @StorageLink(TCP_CONNECTION_STATUS) tcpConnected: boolean = false
  @StorageLink(OMNI_THEME_VERSION_KEY) private themeVersion: number = 0
  @StorageLink('TOP_USER_LABEL') private userLabel: string = 'å§“å'
  @StorageLink('SELECTED_AVATAR_URL') private selectedAvatarUrl: string = 'https://img1.baidu.com/it/u=700838104,4078529388&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500'
  // å®¢æˆ·ä¿¡æ¯ï¼ˆå¯ç”±å…¶ä»–é¡µé¢å†™å…¥ AppStorageï¼Œä¸æ”¹åŠ¨ä¸šåŠ¡å«ä¹‰ï¼‰
  @StorageLink('CUSTOMER_LOGO_URL') private customerLogoUrl: string = ''
  @StorageLink('FARM_NAME') private farmName: string = ''
  @StorageLink('FRUIT_TYPE') private fruitType: string = ''
  
  // FSMçŠ¶æ€
  @Prop selectedFSM: 'FSM1' | 'FSM2' = 'FSM1'
  onFSMChange?: (fsm: 'FSM1' | 'FSM2') => void
  onEditCustomer?: () => void
  @Prop layoutMode: 'top' | 'side' = 'top'
  
  // å®æ—¶æ—¶é—´çŠ¶æ€ï¼ˆä¸¤è¡Œæ˜¾ç¤ºï¼‰
  @State private currentDate: string = ''
  @State private currentTime: string = ''
  @State private showSubsystemDropdown: boolean = false
  private timeTimer: number | null = null

  // æ¨¡æ‹Ÿæ•°æ®
  @State private mockFaults: string[] = [
    '[user]: é€šä¿¡å¼‚å¸¸ 11111111111ï¼Œæ¢è¡Œæµ‹è¯•ã€‚',
    '[user1]: è¿è¡Œæ­£å¸¸',
    '[user2]: é€šä¿¡å¼‚å¸¸ 11111111111ï¼Œæ¢è¡Œæµ‹è¯•ï¼Œæ¢è¡Œä¼š...'
  ]

  @State private mockLogs: string[] = [
    '[ERR]: é€šä¿¡å¼‚å¸¸ 11111111111ï¼Œæ¢è¡Œæµ‹è¯•ã€‚',
    '[ERR1]: è¿è¡Œæ­£å¸¸',
    '[ERR2]: é€šä¿¡å¼‚å¸¸ 11111111111ï¼Œæ¢è¡Œæµ‹è¯•ï¼Œæ¢è¡Œä¼š...',
    '[ERR3]: é€šä¿¡å¼‚å¸¸ 11111111111ï¼Œæ¢è¡Œæµ‹è¯•ã€‚'
  ]

  private async minimizeApp() { //æœ€å°åŒ–
    try {
      const ctx = getContext(this) as common.UIAbilityContext
      const ok = await MinimizeAppUtil.getInstance(ctx, {
        maxRetries: 3,
        retryDelay: 800,
        enableLogging: true,
        onError: (_) => {}
      }).minimize()
      if (!ok) {
        // å…œåº•ï¼šé€€åˆ°åå°
        interface MoveMinimize { moveMissionToBackground?: () => Promise<void> }
        const maybe = ctx as MoveMinimize
        if (typeof maybe.moveMissionToBackground === 'function') {
          await maybe.moveMissionToBackground()
        } else {
          console.warn('[TopStatusBar] ä¸æ”¯æŒæœ€å°åŒ–ä¸”æ— é€€åå°æ¥å£ï¼Œå·²è·³è¿‡')
        }
      }
    } catch (e) {
      console.error('[TopStatusBar] æœ€å°åŒ–å¤±è´¥:', JSON.stringify(e))
    }
  }

  private async closeApp() { //å…³é—­ç¨‹åº
    try {
      const ctx = getContext(this) as common.UIAbilityContext
      await ctx.terminateSelf()
    } catch (e) {
      console.error('[TopStatusBar] å…³é—­åº”ç”¨å¤±è´¥:', JSON.stringify(e))
    }
  }

  private getCurrentTheme(): ExtendedOmniThemeStyle { //è·å–ä¸»é¢˜
    const __v: number = this.themeVersion
    return OmniThemeManager.getInstance().getCurrentTheme()
  }

  aboutToAppear() {
    // åˆå§‹åŒ–æ—¶é—´
    this.updateCurrentTime()
    // å¯åŠ¨å®šæ—¶å™¨ï¼Œæ¯ç§’æ›´æ–°ä¸€æ¬¡
    this.timeTimer = setInterval(() => {
      this.updateCurrentTime()
    }, 1000)
  }

  aboutToDisappear() {
    // æ¸…ç†å®šæ—¶å™¨
    if (this.timeTimer) {
      clearInterval(this.timeTimer)
      this.timeTimer = null
    }
  }

  private updateCurrentTime() {
    const now = new Date()
    const y = now.getFullYear()
    const m = String(now.getMonth() + 1).padStart(2, '0')
    const d = String(now.getDate()).padStart(2, '0')
    const hh = String(now.getHours()).padStart(2, '0')
    const mm = String(now.getMinutes()).padStart(2, '0')
    const ss = String(now.getSeconds()).padStart(2, '0')
    // ç¬¬ä¸€è¡Œï¼šæ—¥æœŸ
    this.currentDate = `${y}-${m}-${d}`
    // ç¬¬äºŒè¡Œï¼šæ—¶é—´
    this.currentTime = `${hh}:${mm}:${ss}`
  }

  private getSubsystemLabel(): string {
    return this.selectedFSM === 'FSM1' ? 'å­ç³»ç»Ÿ 1' : 'å­ç³»ç»Ÿ 2'
  }

  @Builder
  private buildSubsystemMenuItem(label: string, fsm: 'FSM1' | 'FSM2') {
    Row() {
      Text(label)
        .fontSize(16)
        .fontColor('#333')
    }
    .width('100%')
    .height(40)
    .padding({ left: 12, right: 12 })
    .alignItems(VerticalAlign.Center)
    .backgroundColor(this.selectedFSM === fsm ? '#e6f0ff' : Color.White)
    .onClick(() => {
      this.showSubsystemDropdown = false
      if (this.onFSMChange) {
        this.onFSMChange(fsm)
      }
    })
  }

  @Builder
  private buildSubsystemMenu() {
    Column() {
      this.buildSubsystemMenuItem('å­ç³»ç»Ÿ 1', 'FSM1')
      this.buildSubsystemMenuItem('å­ç³»ç»Ÿ 2', 'FSM2')
    }
    .width(140)
    .backgroundColor(Color.White)
    .border({ width: 1, color: '#ddd' })
    .borderRadius(6)
    .padding({ top: 4, bottom: 4 })
  }

  build() {
    if (this.layoutMode === 'side') {
      Stack() {
        Column() {
          Row() {
            Row() {
              Text(this.getSubsystemLabel())
                .fontSize(16)
                .fontColor('#333')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
              Text('â–¼')
                .fontSize(11)
                .fontColor('#666')
                .margin({ left: 6 })
            }
            .width(140)
            .height(44)
            .justifyContent(FlexAlign.SpaceBetween)
            .alignItems(VerticalAlign.Center)
              .backgroundColor(Color.White)
              .border({ width: 1, color: '#ddd' })
              .borderRadius(6)
              .padding({ left: 14, right: 14 })
              .onClick(() => {
                this.showSubsystemDropdown = !this.showSubsystemDropdown
              })
              .bindPopup(this.showSubsystemDropdown, {
                builder: this.buildSubsystemMenu(),
                placement: Placement.Bottom,
                mask: false,
                popupColor: Color.Transparent,
                enableArrow: false,
                onStateChange: (e) => {
                  if (!e.isVisible) {
                    this.showSubsystemDropdown = false
                  }
                }
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .margin({ top: 10, bottom: 24 })
          .padding({ left: 10, right: 10 })
          Scroll() {
          Column() {
            Row({ space: 12 }) {
            Text('ğŸ‘¨â€ğŸŒ¾')
              .fontSize(28)
              .fontColor(Color.White)
              .width(44)
              .height(44)
              .textAlign(TextAlign.Center)
              .backgroundColor('#4a90e2')
              .borderRadius(22)

            Column() {
              Text(this.userLabel)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })

              Text(this.farmName)
                .fontSize(15)
                .fontColor('#999')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .alignItems(HorizontalAlign.Start)
          }
          .width('100%')
          .alignItems(VerticalAlign.Center)
          .justifyContent(FlexAlign.Start)
          .margin({ bottom: 36 })
          .onClick(() => {
            if (this.onEditCustomer) {
              this.onEditCustomer()
            }
          })

          Row({ space: 12 }) {
            Text('ğŸŠ')
              .fontSize(28)
              .fontColor(Color.White)
              .width(44)
              .height(44)
              .textAlign(TextAlign.Center)
              .backgroundColor('#ff8c00')
              .borderRadius(22)

            Text(this.fruitType)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .maxLines(1)
              .textAlign(TextAlign.Start)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
          .width('100%')
          .alignItems(VerticalAlign.Center)
          .justifyContent(FlexAlign.Start)
          .margin({ bottom: 24 })
          .onClick(() => {
            if (this.onEditCustomer) {
              this.onEditCustomer()
            }
          })


          Column() {
            Text('çŠ¶æ€ç›‘æ§')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')
              .padding({ left: 0, right: 0, top: 6, bottom: 0 })
              .textAlign(TextAlign.Start) // 
              .width('100%') // å æ»¡å®¹å™¨å®½åº¦
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start) // å®¹å™¨å†…å…ƒç´ å·¦å¯¹é½
          .margin({ bottom: 6 })

          Column() {
            this.buildStatusRow('æ•ˆç‡(å¨/å°æ—¶)', this.productionTonPerHour)
            this.buildStatusRow('æ€»é‡(å¨)', this.sumWeightTon)
            this.buildStatusRow('æ€»ä¸ªæ•°', this.sumCounts)
            this.buildStatusRow('å¹³å‡é‡é‡(å…‹)', this.avgGram)
          }
          .width('100%')
          .height(160)
          .justifyContent(FlexAlign.SpaceEvenly)
          .backgroundColor(Color.White)
          .border({ width: 1, color: '#ddd' })
          .borderRadius(4)
          .padding(8)

          this.buildLogSection('ç³»ç»Ÿæ•…éšœ', this.mockFaults, 230)
          this.buildLogSection('æ“ä½œæ—¥å¿—', this.mockLogs, 230)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
          .align(Alignment.TopStart)
        }
        .height('100%')
      }
      .align(Alignment.TopStart)
      .width(150)
      .height('100%')
      .backgroundColor('#f8f8f8')
      .border({ width: { right: 1 }, color: '#ddd' })
    } else {
      Row() {
      // ===============================================
      // å·¦ä¾§åŒºåŸŸï¼šLogo + ç”Ÿäº§æŒ‡æ ‡ (ç´§å‡‘å¸ƒå±€)
      // ===============================================
      Row() {
        // 1. Logo
        Image($r('app.media.logo'))
          .height('60%')
          .objectFit(ImageFit.Contain)
          .margin({ right: 16 })
        
        // 2. åˆ†å‰²çº¿
        Divider()
          .vertical(true)
          .height('40%')
          .color(this.getCurrentTheme().borderColor)
          .opacity(0.5)
          .margin({ right: 16 })

        // 3. ç”Ÿäº§æŒ‡æ ‡ (ä½¿ç”¨ Flex è‡ªåŠ¨æ¢è¡Œæˆ– Row ç´§å‡‘æ’åˆ—)
        Row({ space: 24 }) { // å¢åŠ é—´è·ï¼Œå‡å°‘æ‹¥æŒ¤æ„Ÿ
          MetricItem({ label: 'Production', value: this.productionTonPerHour, unit: 'Ton/h' })
          MetricItem({ label: 'SumWeight', value: this.sumWeightTon, unit: 'Ton' })
          MetricItem({ label: 'SumCounts', value: this.sumCounts, unit: 'PCS' })
          MetricItem({ label: 'Avg', value: this.avgGram, unit: 'g' })
        }
      }
      .layoutWeight(0) // å·¦ä¾§æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦
      .height('100%')
      .alignItems(VerticalAlign.Center)

      Row() {
        Blank() // å¡«å……å·¦è¾¹ç©ºé—´ï¼Œè®©ä¸­é—´å†…å®¹å±…ä¸­æˆ–åå³

        // status & Customer Group
        Row({ space: 16 }) {
           // çŠ¶æ€/å‘Šè­¦ä¿¡æ¯
           this.buildStatusAlert()

           // å®¢æˆ·ä¿¡æ¯ (Logo + å†œåœºå)
           this.buildCustomerInfo()
        }
        
        Blank() // å¡«å……å³è¾¹ç©ºé—´
      }
      .layoutWeight(1) // å æ®å‰©ä½™æ‰€æœ‰ç©ºé—´
      .height('100%')
      .alignItems(VerticalAlign.Center)
      
      // ===============================================
      // å³ä¾§åŒºåŸŸï¼šFSMåˆ‡æ¢ + ä¸ªäººä¿¡æ¯ + çª—å£æ§åˆ¶ (å›ºå®šåœ¨å³ä¾§)
      // ===============================================
      Row({ space: 12 }) {
        // FSM åˆ‡æ¢
        CompactFsmToggle({
          selectedFSM: this.selectedFSM,
          onFSMChange: (fsm: 'FSM1' | 'FSM2') => {
            if (this.onFSMChange) {
              this.onFSMChange(fsm)
            }
          }
        })

        // ä¸ªäººä¿¡æ¯
        ProfileInfoBar({
          userName: this.userLabel,
          userRole: 'ç®¡ç†å‘˜',
          currentDate: this.currentDate,
          currentTime: this.currentTime,
          avatarUrl: this.selectedAvatarUrl,
          isLoading: false
        })

        // åˆ†å‰²çº¿
        Divider()
          .vertical(true)
          .height('40%')
          .color(this.getCurrentTheme().borderColor)
          .opacity(0.5)
          .margin({ left: 4, right: 4 })

        // çª—å£æ§åˆ¶æŒ‰é’®
        Row({ space: 8 }) {
          ThreeDButton({
            text: 'âˆ’',
            isSelected: false,
            buttonWidth: 36, // ç¨å¾®è°ƒå°ä¸€ç‚¹ï¼Œæ›´ç²¾è‡´
            buttonHeight: 36,
            fontSize: 20,
            onClickCallback: () => { this.minimizeApp() }
          })

          ThreeDButton({
            text: 'Ã—',
            isSelected: false,
            buttonWidth: 36,
            buttonHeight: 36,
            fontSize: 20,
            onClickCallback: () => { this.closeApp() }
          })
        }
      }
      .layoutWeight(0) // å³ä¾§è‡ªé€‚åº”å®½åº¦ï¼Œç¡®ä¿æ˜¾ç¤º
      .height('100%')
      .alignItems(VerticalAlign.Center)

      }
      .width('100%')
      .height('8%') // ä¿æŒåŸæœ‰é«˜åº¦è®¾ç½®
      .backgroundColor(this.getCurrentTheme().headerColor ?? this.getCurrentTheme().backgroundColor)
      .padding({ left: 16, right: 16 }) // å‡å°‘ paddingï¼Œè®©å‡ºæ›´å¤šç©ºé—´
      .border({ width: { bottom: 1 }, color: this.getCurrentTheme().borderColor })
      .shadow({ radius: 6, color: 'rgba(0,0,0,0.05)', offsetY: 2 }) // æ›´æŸ”å’Œçš„é˜´å½±
    }
  }

  // Helper: çŠ¶æ€/å‘Šè­¦æ¡
  @Builder
  buildStatusAlert() {
    if (this.tcpConnected) {
      // æ­£å¸¸çŠ¶æ€ï¼šç®€æ´çš„èƒ¶å›Šæ ·å¼
      Row() {
        Circle({ width: 8, height: 8 })
          .fill('#4CAF50') // ç»¿è‰²
          .margin({ right: 8 })
        Text(this.statusText || 'ç³»ç»Ÿå°±ç»ª')
          .fontSize(16)
          .fontColor(this.getCurrentTheme().primary)
      }
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .backgroundColor(this.getCurrentTheme().surfaceColor)
      .borderRadius(16)
      .border({ width: 1, color: this.getCurrentTheme().borderColor })
    } else {
      // æ•…éšœ/æ–­å¼€çŠ¶æ€ï¼šé†’ç›®ä½†ä¸çªå…€çš„èƒ¶å›Šæ ·å¼
      Row() {
        Text('âš ï¸')
          .fontSize(16)
          .margin({ right: 6 })
        Text('è¿æ¥æ–­å¼€')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FF3B30')
      }
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .backgroundColor('#FFF0F0') // æµ…çº¢èƒŒæ™¯
      .borderRadius(16)
      .border({ width: 1, color: '#FFcccc' })
    }
  }

  // Helper: å®¢æˆ·ä¿¡æ¯
  @Builder
  buildCustomerInfo() {
    Row() {
       Image(this.customerLogoUrl || $r('app.media.customer_logo'))
        .width(32)
        .height(32)
        .objectFit(ImageFit.Contain)
        .borderRadius(4)
        .margin({ right: 8 })
      
      Column() {
        Text(this.farmName || 'æœªé€‰å®šå†œåœº')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getCurrentTheme().textColor)
        Text(this.fruitType || 'â€”')
          .fontSize(12)
          .fontColor(this.getCurrentTheme().subTextColor)
      }
      .alignItems(HorizontalAlign.Start)
    }
    .padding({ left: 12, right: 12, top: 4, bottom: 4 })
  }

  @Builder
  private buildStatusRow(label: string, value: string) {
    Column() {
      Text(label)
        .fontSize(13)
        .fontColor('#666')
        .textAlign(TextAlign.Start)
        .width('100%')

      Text(value)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')
        .textAlign(TextAlign.Start)
        .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .padding({ left: 2, right: 2 })
  }

  private getPrefixColor(prefix: string): string {
    if (prefix.includes('user') && !prefix.includes('1') && !prefix.includes('2')) return '#FF0000' // Red
    if (prefix.includes('ERR') && !prefix.includes('1') && !prefix.includes('2')) return '#FF0000' // Red
    if (prefix.includes('1')) return '#008000' // Green
    if (prefix.includes('2')) return '#FFA500' // Orange
    return '#333'
  }

  @Builder
  private buildLogItem(text: string) {
    if (text.startsWith('[') && text.indexOf(']') > -1) {
      Text() {
        Span(text.substring(0, text.indexOf(']') + 1))
          .fontColor(this.getPrefixColor(text.substring(0, text.indexOf(']') + 1)))
          .fontSize(13)
          .fontWeight(FontWeight.Bold)
        Span(text.substring(text.indexOf(']') + 1))
          .fontColor('#333')
          .fontSize(13)
      }
      .width('100%')
      .textAlign(TextAlign.Start)
    } else {
      Text(text)
        .fontSize(13)
        .fontColor('#333')
        .width('100%')
        .textAlign(TextAlign.Start)
    }
  }

  @Builder
  private buildLogSection(title: string, data: string[], height: number) {
    Column() {
      Text(title)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')
        .padding({ left: 0, right: 0, top: 6, bottom: 0 })
        .textAlign(TextAlign.Start)
        .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .margin({ bottom: 6 })

    List() {
      ForEach(data, (item: string) => {
        ListItem() {
          this.buildLogItem(item)
        }
        .width('100%')
        .margin({ bottom: 4 })
      })
    }
    .width('100%')
    .height(height)
    .backgroundColor(Color.White)
    .border({ width: 1, color: '#ddd' })
    .borderRadius(4)
    .padding(8)
    .alignListItem(ListItemAlign.Start)
    .scrollBar(BarState.Auto)
  }
}

@Component
export struct WindowControlButtons {
  private async minimizeApp() {
    try {
      const ctx = getContext(this) as common.UIAbilityContext
      const ok = await MinimizeAppUtil.getInstance(ctx, {
        maxRetries: 3,
        retryDelay: 800,
        enableLogging: true,
        onError: (_) => {}
      }).minimize()
      if (!ok) {
        interface MoveMinimize { moveMissionToBackground?: () => Promise<void> }
        const maybe = ctx as MoveMinimize
        if (typeof maybe.moveMissionToBackground === 'function') {
          await maybe.moveMissionToBackground()
        } else {
          console.warn('[WindowControlButtons] ä¸æ”¯æŒæœ€å°åŒ–ä¸”æ— é€€åå°æ¥å£ï¼Œå·²è·³è¿‡')
        }
      }
    } catch (e) {
      console.error('[WindowControlButtons] æœ€å°åŒ–å¤±è´¥:', JSON.stringify(e))
    }
  }

  private async closeApp() {
    try {
      const ctx = getContext(this) as common.UIAbilityContext
      await ctx.terminateSelf()
    } catch (e) {
      console.error('[WindowControlButtons] å…³é—­åº”ç”¨å¤±è´¥:', JSON.stringify(e))
    }
  }

  build() {
    Row({ space: 8 }) {
      ThreeDButton({
        text: 'âˆ’',
        isSelected: false,
        buttonWidth: 36,
        buttonHeight: 36,
        fontSize: 20,
        onClickCallback: () => { this.minimizeApp() }
      })

      ThreeDButton({
        text: 'Ã—',
        isSelected: false,
        buttonWidth: 36,
        buttonHeight: 36,
        fontSize: 20,
        onClickCallback: () => { this.closeApp() }
      })
    }
  }
}

/**
 * ç‹¬ç«‹çš„æŒ‡æ ‡é¡¹ç»„ä»¶ï¼Œç¡®ä¿å“åº”å¼æ›´æ–°
 */
@Component
struct MetricItem {
  @Prop label: string
  @Prop value: string
  @Prop unit: string
  @StorageLink(OMNI_THEME_VERSION_KEY) private themeVersion: number = 0

  private getCurrentTheme(): ExtendedOmniThemeStyle {
    return OmniThemeManager.getInstance().getCurrentTheme()
  }

  build() {
    Column() {
      Text(this.label)
        .fontSize(14)
        .fontColor(this.getCurrentTheme().subTextColor)
        .margin({ bottom: 2 })
      
      Row() {
        Text(this.value)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getCurrentTheme().primary)
        Text(this.unit)
          .fontSize(12)
          .fontColor(this.getCurrentTheme().subTextColor)
          .opacity(0.8)
          .margin({ left: 2, top: 4 }) // å•ä½ç¨å¾®ä¸‹æ²‰
      }
    }
    .alignItems(HorizontalAlign.Start)
  }
}
