import { OmniThemeManager, ExtendedOmniThemeStyle } from '../../../utils/theme/OmniThemeManager'

export interface CellDragData {
  rowIndex: number
  colIndex: number
  value: string
  sourceTable: string
}

export const CELL_DRAG_STORAGE_KEY: string = 'CELL_DRAG_DATA'
export const CELL_DRAG_ACTIVE_KEY: string = 'CELL_DRAG_ACTIVE'
export const CELL_DRAG_POINT_KEY: string = 'CELL_DRAG_POINT' // { x:number, y:number }

// å¤šé€‰ç›¸å…³å¸¸é‡
export const MULTI_SELECT_CELLS_KEY: string = 'MULTI_SELECT_CELLS'
export const MULTI_SELECT_ACTIVE_KEY: string = 'MULTI_SELECT_ACTIVE'
export const CLEAR_ALL_HIGHLIGHTS_KEY: string = 'CLEAR_ALL_HIGHLIGHTS'

// å¤šé€‰å•å…ƒæ ¼æ•°æ®æŽ¥å£
export interface MultiSelectCell {
  rowIndex: number
  colIndex: number
  value: string
  sourceTable: string
  cellId: string // å”¯ä¸€æ ‡è¯†ç¬¦
}

// å¤šé€‰çŠ¶æ€æŽ¥å£
export interface MultiSelectState {
  cells: MultiSelectCell[]
  isActive: boolean
}

@Component
export struct SimpleDraggableCell {
  @Prop text: string = ''
  @Prop rowIndex: number = 0
  @Prop colIndex: number = 0
  @Prop fontSize: number = 13
  @Prop cellPadding: number = 6
  @Prop sourceTable: string = 'ç­‰çº§è¡¨'
  @Prop isHeader: boolean = false
  @Prop canDrag: boolean = true

  @State private isDragging: boolean = false
  @State private isSelected: boolean = false
  
  // ç›‘å¬å…¨å±€æ¸…é™¤é«˜äº®ä¿¡å·
  @StorageLink(CLEAR_ALL_HIGHLIGHTS_KEY) private clearAllHighlights: boolean = false

  private getTheme(): ExtendedOmniThemeStyle {
    return OmniThemeManager.getInstance().getCurrentTheme()
  }

  private beginDrag() {
    if (!this.canDrag || this.isHeader) { return }
    this.isDragging = true
    const data: CellDragData = {
      rowIndex: this.rowIndex,
      colIndex: this.colIndex,
      value: this.text,
      sourceTable: this.sourceTable
    }
    AppStorage.setOrCreate(CELL_DRAG_STORAGE_KEY, data)
    AppStorage.setOrCreate(CELL_DRAG_ACTIVE_KEY, true)
    // åˆå§‹æŒ‡é’ˆåæ ‡ç”±é¡¶å±‚ä»£ç†å±‚è·Ÿè¸ªï¼Œè¿™é‡Œä»…æ ‡è®°æ¿€æ´»
    console.log('Cell drag selected:', JSON.stringify(data))
  }

  private endDrag() {
    if (!this.canDrag || this.isHeader) { return }
    this.isDragging = false
    // æ‹–æ‹½ç»“æŸåŽå–æ¶ˆé«˜äº®
    this.isSelected = false
    console.log('ðŸ§¹ æ‹–æ‹½ç»“æŸï¼Œå·²å–æ¶ˆé«˜äº®:', this.text)
    // ä¸åœ¨æ­¤å¼ºåˆ¶ç»“æŸå…¨å±€dragï¼Œäº¤ç”±é¡¶å±‚ä»£ç†åœ¨æŠ•æ”¾/å–æ¶ˆæ—¶æ›´æ–°
  }

  // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
  private toggleSelection() {
    if (this.isHeader || !this.canDrag) {
      console.log('ðŸš« è¡¨å¤´æˆ–ä¸å¯æ‹–æ‹½å•å…ƒæ ¼ï¼Œæ— æ³•é€‰ä¸­')
      return
    }
    
    this.isSelected = !this.isSelected
    console.log('ðŸ”„ å•å…ƒæ ¼é€‰ä¸­çŠ¶æ€:', this.text, this.isSelected ? 'âœ… å·²é€‰ä¸­' : 'âŒ æœªé€‰ä¸­')
    
    // æ›´æ–°å…¨å±€å¤šé€‰çŠ¶æ€
    this.updateMultiSelectState()
    
    // å¼ºåˆ¶åˆ·æ–°AppStorageï¼Œç¡®ä¿çŠ¶æ€åŒæ­¥
    setTimeout(() => {
      const currentState = AppStorage.get(MULTI_SELECT_CELLS_KEY) as MultiSelectState
      console.log('ðŸ”„ å»¶è¿Ÿæ£€æŸ¥å¤šé€‰çŠ¶æ€:', JSON.stringify(currentState))
    }, 50)
  }
  
  // æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„å•å…ƒæ ¼
  private collectAllSelectedCells() {
    // å¦‚æžœå½“å‰å•å…ƒæ ¼è¢«é€‰ä¸­ï¼Œæ”¶é›†æ‰€æœ‰é€‰ä¸­çš„å•å…ƒæ ¼
    if (this.isSelected) {
      const currentState = AppStorage.get(MULTI_SELECT_CELLS_KEY) as MultiSelectState || { cells: [], isActive: false }
      
      // ç¡®ä¿å½“å‰å•å…ƒæ ¼åœ¨å¤šé€‰åˆ—è¡¨ä¸­
      const cellId = `${this.sourceTable}_${this.rowIndex}_${this.colIndex}`
      const currentCell: MultiSelectCell = {
        rowIndex: this.rowIndex,
        colIndex: this.colIndex,
        value: this.text,
        sourceTable: this.sourceTable,
        cellId: cellId
      }
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™æ·»åŠ 
      const exists = currentState.cells.some(cell => cell.cellId === cellId)
      if (!exists) {
        const newState: MultiSelectState = {
          cells: [...(currentState.cells || []), currentCell],
          isActive: true
        }
        AppStorage.set(MULTI_SELECT_CELLS_KEY, newState)
        AppStorage.set(MULTI_SELECT_ACTIVE_KEY, true)
        console.log('ðŸ” æ‹–æ‹½æ—¶æ·»åŠ å½“å‰å•å…ƒæ ¼åˆ°å¤šé€‰åˆ—è¡¨:', currentCell)
      }
    }
  }

  // æ›´æ–°å…¨å±€å¤šé€‰çŠ¶æ€
  private updateMultiSelectState() {
    const currentState = AppStorage.get(MULTI_SELECT_CELLS_KEY) as MultiSelectState || { cells: [], isActive: false }
    const cellId = `${this.sourceTable}_${this.rowIndex}_${this.colIndex}`
    
    // åˆ›å»ºæ–°çš„çŠ¶æ€å¯¹è±¡ï¼Œé¿å…ç›´æŽ¥ä¿®æ”¹å¼•ç”¨
    const newState: MultiSelectState = {
      cells: [...(currentState.cells || [])],
      isActive: currentState.isActive || false
    }
    
    if (this.isSelected) {
      // æ·»åŠ åˆ°å¤šé€‰åˆ—è¡¨
      const newCell: MultiSelectCell = {
        rowIndex: this.rowIndex,
        colIndex: this.colIndex,
        value: this.text,
        sourceTable: this.sourceTable,
        cellId: cellId
      }
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ 
      const exists = newState.cells.some(cell => cell.cellId === cellId)
      if (!exists) {
        newState.cells.push(newCell)
        newState.isActive = true
        AppStorage.set(MULTI_SELECT_CELLS_KEY, newState)
        AppStorage.set(MULTI_SELECT_ACTIVE_KEY, true)
        console.log('ðŸ“ æ·»åŠ åˆ°å¤šé€‰åˆ—è¡¨:', newCell)
      }
    } else {
      // ä»Žå¤šé€‰åˆ—è¡¨ç§»é™¤
      newState.cells = newState.cells.filter(cell => cell.cellId !== cellId)
      newState.isActive = newState.cells.length > 0
      AppStorage.set(MULTI_SELECT_CELLS_KEY, newState)
      AppStorage.set(MULTI_SELECT_ACTIVE_KEY, newState.isActive)
      console.log('ðŸ—‘ï¸ ä»Žå¤šé€‰åˆ—è¡¨ç§»é™¤:', cellId)
    }
    
    console.log('ðŸ“Š å½“å‰å¤šé€‰çŠ¶æ€:', newState)
  }

  // ç›‘å¬å…¨å±€æ¸…é™¤é«˜äº®ä¿¡å·
  aboutToAppear() {
    // ç›‘å¬æ¸…é™¤é«˜äº®ä¿¡å·
    this.clearAllHighlights = false
  }
  
  // å½“æ¸…é™¤é«˜äº®ä¿¡å·å˜åŒ–æ—¶ï¼Œæ¸…é™¤å½“å‰å•å…ƒæ ¼çš„é«˜äº®
  onClearHighlightsChanged() {
    if (this.clearAllHighlights) {
      this.isSelected = false
      console.log('ðŸ§¹ å…¨å±€æ¸…é™¤é«˜äº®:', this.text)
    }
  }

  build() {
    Text(this.text)
      .fontSize(this.fontSize)
      .fontColor(this.isHeader ? this.getTheme().textColor : this.getTheme().subTextColor)
      .fontWeight(this.isHeader ? FontWeight.Bold : FontWeight.Normal)
      .textAlign(TextAlign.Center)
      .layoutWeight(1)
      .padding(this.cellPadding)
      .backgroundColor(
        this.isHeader 
          ? (this.getTheme().tableHeaderBg ?? this.getTheme().surfaceColor)
          : (this.isDragging 
              ? (this.getTheme().primary + '40') // æ‹–æ‹½é«˜äº®
              : (this.isSelected ? (this.getTheme().primary + '20') : this.getTheme().surfaceColor))
      )
      .border({ 
        width: { right: 1, bottom: 1 }, 
        color: (this.isDragging || this.isSelected) ? this.getTheme().primary : this.getTheme().borderColor 
      })
      .borderRadius((this.isDragging || this.isSelected) ? 4 : 0) // æ‹–æ‹½æˆ–é€‰ä¸­æ—¶æ·»åŠ åœ†è§’
      .shadow(
        (this.isDragging || this.isSelected)
          ? { radius: 4, color: this.getTheme().primary + '30', offsetX: 0, offsetY: 2 }
          : undefined
      )
      .onClick(() => {
        this.toggleSelection()
      })
      .onDragStart((event: DragEvent, extraParams: string): DragItemInfo => {
        // é‡æ–°æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„å•å…ƒæ ¼
        this.collectAllSelectedCells()
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªé€‰ä¸­çš„å•å…ƒæ ¼
        const multiSelectState = AppStorage.get(MULTI_SELECT_CELLS_KEY) as MultiSelectState
        const hasMultiSelect = multiSelectState && multiSelectState.cells && multiSelectState.cells.length > 1
        
        console.log('ðŸ” æ‹–æ‹½å¼€å§‹æ£€æŸ¥å¤šé€‰çŠ¶æ€:', {
          multiSelectState: JSON.stringify(multiSelectState),
          hasMultiSelect,
          cellsLength: multiSelectState?.cells?.length || 0,
          cells: multiSelectState?.cells
        })
        
        if (hasMultiSelect) {
          // å¤šé€‰æ‹–æ‹½ï¼šä½¿ç”¨æ‰€æœ‰é€‰ä¸­çš„å•å…ƒæ ¼æ•°æ®
          console.log('ðŸŽ¯ å¼€å§‹å¤šé€‰æ‹–æ‹½ï¼Œé€‰ä¸­å•å…ƒæ ¼æ•°é‡:', multiSelectState.cells.length)
          console.log('ðŸŽ¯ å¤šé€‰å•å…ƒæ ¼æ•°æ®:', multiSelectState.cells)
          
          const dragDataStr: string = JSON.stringify({
            type: 'multi_select',
            cells: multiSelectState.cells,
            count: multiSelectState.cells.length
          })
          
          const dragItemInfo: DragItemInfo = {
            pixelMap: undefined,
            builder: undefined,
            extraInfo: dragDataStr
          }
          return dragItemInfo
        } else {
          // å•é€‰æ‹–æ‹½ï¼šä½¿ç”¨å½“å‰å•å…ƒæ ¼æ•°æ®
          const dragData: CellDragData = {
            rowIndex: this.rowIndex,
            colIndex: this.colIndex,
            value: this.text,
            sourceTable: this.sourceTable
          }
          
          const dragDataStr: string = JSON.stringify(dragData)
          console.log('å¼€å§‹æ‹–æ‹½å•å…ƒæ ¼æ•°æ®:', dragDataStr)
          
          const dragItemInfo: DragItemInfo = {
            pixelMap: undefined,
            builder: undefined,
            extraInfo: dragDataStr
          }
          return dragItemInfo
        }
      })
      .onDragEnd(() => {
        this.endDrag()
        console.log('ðŸŽ¯ æ‹–æ‹½ç»“æŸäº‹ä»¶è§¦å‘')
        
        // æ¸…é™¤æ‰€æœ‰é«˜äº®
        AppStorage.set(CLEAR_ALL_HIGHLIGHTS_KEY, true)
        setTimeout(() => {
          AppStorage.set(CLEAR_ALL_HIGHLIGHTS_KEY, false)
        }, 100)
      })
  }
}

export const getCurrentCellDragData = (): CellDragData | null => {
  const d = AppStorage.get(CELL_DRAG_STORAGE_KEY) as CellDragData | null
  if (d && typeof d.rowIndex === 'number' && typeof d.colIndex === 'number' && typeof d.value !== 'undefined' && typeof d.sourceTable === 'string') {
    return d
  }
  return null
}


