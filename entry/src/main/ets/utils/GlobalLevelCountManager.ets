/**
 * å…¨å±€ç­‰çº§æ•°é‡ç®¡ç†å™¨
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - ç®¡ç†å…¨å±€çš„ç­‰çº§æ•°é‡çŠ¶æ€
 * - æ”¯æŒæ»šè½®äº‹ä»¶ç›´æ¥ä¿®æ”¹ç­‰çº§æ•°é‡
 * - æä¾›çŠ¶æ€å˜åŒ–ç›‘å¬åŠŸèƒ½
 * 
 * ä½¿ç”¨åœºæ™¯ï¼š
 * - å“è´¨é¡µé¢çš„ç­‰çº§æ•°é‡é€‰æ‹©å™¨
 * - æ»šè½®äº‹ä»¶å¤„ç†
 * - è·¨ç»„ä»¶çŠ¶æ€åŒæ­¥
 */

import { LEVEL_COUNT_OPTIONS } from '../pages/quality/QualityConstants'

/**
 * ç­‰çº§æ•°é‡å˜åŒ–å›è°ƒå‡½æ•°ç±»å‹
 */
export type LevelCountChangeCallback = (newCount: number, newIndex: number) => void

/**
 * å…¨å±€ç­‰çº§æ•°é‡ç®¡ç†å™¨
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - å•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿å…¨å±€å”¯ä¸€
 * - ç®¡ç†å½“å‰ç­‰çº§æ•°é‡å’Œç´¢å¼•
 * - æä¾›æ»šè½®äº‹ä»¶å¤„ç†
 * - æ”¯æŒçŠ¶æ€å˜åŒ–ç›‘å¬
 */
export class GlobalLevelCountManager {
  private static instance: GlobalLevelCountManager
  private currentIndex: number = 16 // å½“å‰ç´¢å¼•ï¼Œé»˜è®¤ä¸º16ï¼ˆ16ä¸ªç­‰çº§ï¼‰
  private callbacks: LevelCountChangeCallback[] = [] // çŠ¶æ€å˜åŒ–å›è°ƒå‡½æ•°åˆ—è¡¨

  /**
   * ç§æœ‰æ„é€ å‡½æ•°ï¼Œç¡®ä¿å•ä¾‹æ¨¡å¼
   */
  private constructor() {
    console.log('ğŸ¯ å…¨å±€ç­‰çº§æ•°é‡ç®¡ç†å™¨åˆå§‹åŒ–')
  }

  /**
   * è·å–å•ä¾‹å®ä¾‹
   * @returns GlobalLevelCountManagerå®ä¾‹
   */
  public static getInstance(): GlobalLevelCountManager {
    if (!GlobalLevelCountManager.instance) {
      GlobalLevelCountManager.instance = new GlobalLevelCountManager()
    }
    return GlobalLevelCountManager.instance
  }

  /**
   * è·å–å½“å‰ç­‰çº§æ•°é‡ç´¢å¼•
   * @returns å½“å‰ç´¢å¼•
   */
  public getCurrentIndex(): number {
    return this.currentIndex
  }

  /**
   * è·å–å½“å‰ç­‰çº§æ•°é‡å€¼
   * @returns å½“å‰ç­‰çº§æ•°é‡å€¼
   */
  public getCurrentCount(): number {
    return parseInt(LEVEL_COUNT_OPTIONS[this.currentIndex].value)
  }

  /**
   * è®¾ç½®ç­‰çº§æ•°é‡ç´¢å¼•
   * @param index æ–°çš„ç´¢å¼•å€¼
   */
  public setIndex(index: number): void {
    const clampedIndex = Math.max(0, Math.min(index, LEVEL_COUNT_OPTIONS.length - 1))
    if (clampedIndex !== this.currentIndex) {
      const oldIndex = this.currentIndex
      this.currentIndex = clampedIndex
      const newCount = this.getCurrentCount()
      
      console.log(`ğŸ”„ ç­‰çº§æ•°é‡ç´¢å¼•å˜åŒ–: ${oldIndex} -> ${clampedIndex}`)
      console.log(`ğŸ“Š ç­‰çº§æ•°é‡å€¼å˜åŒ–: ${parseInt(LEVEL_COUNT_OPTIONS[oldIndex].value)} -> ${newCount}`)
      
      // é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
      this.notifyCallbacks(newCount, clampedIndex)
    }
  }

  /**
   * æ ¹æ®ç­‰çº§æ•°é‡å€¼è®¾ç½®ç´¢å¼•
   * @param count ç­‰çº§æ•°é‡å€¼
   */
  public setCount(count: number): void {
    const index = LEVEL_COUNT_OPTIONS.findIndex(option => parseInt(option.value) === count)
    if (index !== -1) {
      this.setIndex(index)
    } else {
      console.warn(`âš ï¸ æ— æ•ˆçš„ç­‰çº§æ•°é‡å€¼: ${count}`)
    }
  }

  /**
   * å¤„ç†æ»šè½®äº‹ä»¶
   * @param verticalValue å‚ç›´æ»šè½®å€¼
   * @param currentDataCount å½“å‰å®é™…æ•°æ®æ¡æ•°ï¼ˆå¯é€‰ï¼‰
   */
  public handleWheelEvent(verticalValue: number, currentDataCount?: number): void {
    console.log(`ğŸ¡ å¤„ç†æ»šè½®äº‹ä»¶ - å‚ç›´å€¼: ${verticalValue}`)
    console.log(`ğŸ” è¯¦ç»†æ£€æŸ¥ - verticalValueç±»å‹: ${typeof verticalValue}, å€¼: ${verticalValue}`)
    console.log(`ğŸ” å½“å‰ç´¢å¼•: ${this.currentIndex}, å½“å‰æ•°å€¼: ${this.getCurrentCount()}`)
    console.log(`ğŸ” å½“å‰å®é™…æ•°æ®æ¡æ•°: ${currentDataCount}`)
    
    // å¦‚æœæœ‰å®é™…æ•°æ®æ¡æ•°ï¼ŒåŸºäºå®é™…æ•°æ®æ¡æ•°è¿›è¡Œå¢å‡
    // å¦åˆ™åŸºäºå½“å‰é€‰æ‹©å™¨çš„æ˜¾ç¤ºå€¼è¿›è¡Œå¢å‡
    const baseCount = currentDataCount !== undefined ? currentDataCount : this.getCurrentCount()
    
    if (verticalValue > 0) {
      // å‘ä¸Šæ»šåŠ¨ï¼Œç­‰çº§æ•°é‡ -1ï¼ˆå‡å°‘ï¼‰
      const newCount = Math.max(baseCount - 1, 0)
      console.log(`â¬†ï¸ å‘ä¸Šæ»šåŠ¨ï¼Œä»æ•°å€¼ ${baseCount} åˆ°æ•°å€¼ ${newCount}`)
      this.setCount(newCount)
    } else if (verticalValue < 0) {
      // å‘ä¸‹æ»šåŠ¨ï¼Œç­‰çº§æ•°é‡ +1ï¼ˆå¢åŠ ï¼‰
      const newCount = Math.min(baseCount + 1, 16)
      console.log(`â¬‡ï¸ å‘ä¸‹æ»šåŠ¨ï¼Œä»æ•°å€¼ ${baseCount} åˆ°æ•°å€¼ ${newCount}`)
      this.setCount(newCount)
    } else {
      console.log(`â“ å‚ç›´å€¼ä¸º0ï¼Œä¸å¤„ç†`)
    }
  }

  /**
   * æ·»åŠ çŠ¶æ€å˜åŒ–ç›‘å¬å™¨
   * @param callback å›è°ƒå‡½æ•°
   */
  public addChangeListener(callback: LevelCountChangeCallback): void {
    this.callbacks.push(callback)
    console.log(`ğŸ“ æ·»åŠ ç­‰çº§æ•°é‡å˜åŒ–ç›‘å¬å™¨ï¼Œå½“å‰ç›‘å¬å™¨æ•°é‡: ${this.callbacks.length}`)
  }

  /**
   * ç§»é™¤çŠ¶æ€å˜åŒ–ç›‘å¬å™¨
   * @param callback å›è°ƒå‡½æ•°
   */
  public removeChangeListener(callback: LevelCountChangeCallback): void {
    const index = this.callbacks.indexOf(callback)
    if (index !== -1) {
      this.callbacks.splice(index, 1)
      console.log(`ğŸ—‘ï¸ ç§»é™¤ç­‰çº§æ•°é‡å˜åŒ–ç›‘å¬å™¨ï¼Œå½“å‰ç›‘å¬å™¨æ•°é‡: ${this.callbacks.length}`)
    }
  }

  /**
   * é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨çŠ¶æ€å˜åŒ–
   * @param newCount æ–°çš„ç­‰çº§æ•°é‡å€¼
   * @param newIndex æ–°çš„ç´¢å¼•å€¼
   */
  private notifyCallbacks(newCount: number, newIndex: number): void {
    console.log(`ğŸ“¢ é€šçŸ¥ ${this.callbacks.length} ä¸ªç›‘å¬å™¨çŠ¶æ€å˜åŒ–`)
    this.callbacks.forEach((callback, index) => {
      try {
        callback(newCount, newIndex)
        console.log(`âœ… ç›‘å¬å™¨ ${index + 1} é€šçŸ¥æˆåŠŸ`)
      } catch (error) {
        console.error(`âŒ ç›‘å¬å™¨ ${index + 1} é€šçŸ¥å¤±è´¥:`, error)
      }
    })
  }

  /**
   * è·å–æ‰€æœ‰ç­‰çº§æ•°é‡é€‰é¡¹
   * @returns ç­‰çº§æ•°é‡é€‰é¡¹æ•°ç»„
   */
  public getLevelCountOptions() {
    return LEVEL_COUNT_OPTIONS
  }

  /**
   * é‡ç½®ä¸ºé»˜è®¤å€¼
   */
  public reset(): void {
    this.setIndex(0) // é‡ç½®ä¸º16ä¸ªç­‰çº§
    console.log('ğŸ”„ ç­‰çº§æ•°é‡ç®¡ç†å™¨å·²é‡ç½®ä¸ºé»˜è®¤å€¼')
  }
}
