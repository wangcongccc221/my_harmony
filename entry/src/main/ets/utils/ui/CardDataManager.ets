/**
 * å¡ç‰‡æ•°æ®ç®¡ç†å™¨
 * åŠŸèƒ½ï¼šç»Ÿä¸€ç®¡ç†å¡ç‰‡æ•°æ®æ“ä½œå’ŒIDä¿®æ­£é€»è¾‘
 * ç”¨é€”ï¼šæä¾›æ ‡å‡†åŒ–çš„å¡ç‰‡æ•°æ®ç®¡ç†API
 */

import { ThreeLayerCardData } from '../../components/cards/ThreeLayerCard'

/**
 * å¡ç‰‡æ•°æ®ç®¡ç†å™¨ç±»
 * æä¾›ç»Ÿä¸€çš„å¡ç‰‡æ•°æ®æ“ä½œå’ŒéªŒè¯
 */
export class CardDataManager {
  private static instance: CardDataManager

  private constructor() {}

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): CardDataManager {
    if (!CardDataManager.instance) {
      CardDataManager.instance = new CardDataManager()
    }
    return CardDataManager.instance
  }

  /**
   * ä¿®æ­£å¡ç‰‡ID
   * @param data å¡ç‰‡æ•°æ®
   * @param expectedIndex æœŸæœ›çš„ç´¢å¼•
   */
  public correctCardId(data: ThreeLayerCardData, expectedIndex: number): ThreeLayerCardData {
    const correctId = `card_${expectedIndex}`
    
    if (data.id !== correctId) {
      console.log(`ğŸ”§ ä¿®æ­£ID: ${data.id} -> ${correctId}`)
      data.id = correctId
    }
    
    return data
  }

  /**
   * éªŒè¯å¡ç‰‡æ•°æ®
   * @param data å¡ç‰‡æ•°æ®
   */
  public validateCardData(data: ThreeLayerCardData): boolean {
    if (!data) {
      console.error('âŒ å¡ç‰‡æ•°æ®ä¸ºç©º')
      return false
    }

    if (!data.id) {
      console.error('âŒ å¡ç‰‡IDä¸ºç©º')
      return false
    }

    if (!data.firstLayer) {
      console.error('âŒ ç¬¬ä¸€å±‚æ•°æ®ä¸ºç©º')
      return false
    }

    if (!data.secondLayer) {
      console.error('âŒ ç¬¬äºŒå±‚æ•°æ®ä¸ºç©º')
      return false
    }

    if (!data.thirdLayer) {
      console.error('âŒ ç¬¬ä¸‰å±‚æ•°æ®ä¸ºç©º')
      return false
    }

    return true
  }

  /**
   * åˆ›å»ºæ–°çš„å¡ç‰‡æ•°æ®
   * @param originalData åŸå§‹æ•°æ®
   * @param updates æ›´æ–°æ•°æ®
   */
  public createNewCardData(
    originalData: ThreeLayerCardData,
    updates: Partial<ThreeLayerCardData>
  ): ThreeLayerCardData {
    return {
      id: originalData.id, // ä¿ç•™åŸå§‹ID
      firstLayer: updates.firstLayer || originalData.firstLayer,
      secondLayer: updates.secondLayer || originalData.secondLayer,
      thirdLayer: updates.thirdLayer || originalData.thirdLayer
    }
  }

  /**
   * æ›´æ–°å¡ç‰‡æ•°æ®
   * @param originalData åŸå§‹æ•°æ®
   * @param updates æ›´æ–°æ•°æ®
   */
  public updateCardData(
    originalData: ThreeLayerCardData,
    updates: Partial<ThreeLayerCardData>
  ): ThreeLayerCardData {
    const newData = this.createNewCardData(originalData, updates)
    
    if (!this.validateCardData(newData)) {
      console.error('âŒ æ›´æ–°åçš„å¡ç‰‡æ•°æ®éªŒè¯å¤±è´¥')
      return originalData
    }

    return newData
  }

  /**
   * ä»å¡ç‰‡IDè§£æç´¢å¼•
   * @param cardId å¡ç‰‡ID
   */
  public parseCardIndex(cardId: string): number {
    if (!cardId || !cardId.startsWith('card_')) {
      console.error('âŒ æ— æ•ˆçš„å¡ç‰‡IDæ ¼å¼:', cardId)
      return 0
    }

    const indexStr = cardId.replace('card_', '')
    const index = parseInt(indexStr, 10)
    
    if (isNaN(index)) {
      console.error('âŒ æ— æ³•è§£æå¡ç‰‡ç´¢å¼•:', cardId)
      return 0
    }

    return index
  }

  /**
   * ä»å¡ç‰‡IDè·å–æ˜¾ç¤ºç¼–å·
   * @param cardId å¡ç‰‡ID
   */
  public getCardNumber(cardId: string): number {
    const index = this.parseCardIndex(cardId)
    return index + 1
  }

  /**
   * ç”Ÿæˆå¡ç‰‡ID
   * @param index ç´¢å¼•
   */
  public generateCardId(index: number): string {
    return `card_${index}`
  }

  /**
   * æ£€æŸ¥å¡ç‰‡IDæ˜¯å¦æœ‰æ•ˆ
   * @param cardId å¡ç‰‡ID
   */
  public isValidCardId(cardId: string): boolean {
    if (!cardId) return false
    return cardId.startsWith('card_') && !isNaN(parseInt(cardId.replace('card_', ''), 10))
  }

  /**
   * æ·±åº¦å¤åˆ¶å¡ç‰‡æ•°æ®
   * @param data åŸå§‹æ•°æ®
   */
  public deepCopyCardData(data: ThreeLayerCardData): ThreeLayerCardData {
    try {
      return JSON.parse(JSON.stringify(data)) as ThreeLayerCardData
    } catch (error) {
      console.error('âŒ æ·±åº¦å¤åˆ¶å¡ç‰‡æ•°æ®å¤±è´¥:', error)
      return data
    }
  }

  /**
   * æ¯”è¾ƒä¸¤ä¸ªå¡ç‰‡æ•°æ®æ˜¯å¦ç›¸ç­‰
   * @param data1 æ•°æ®1
   * @param data2 æ•°æ®2
   */
  public areCardDataEqual(data1: ThreeLayerCardData, data2: ThreeLayerCardData): boolean {
    if (!data1 || !data2) return false
    if (data1.id !== data2.id) return false
    
    try {
      const str1 = JSON.stringify(data1)
      const str2 = JSON.stringify(data2)
      return str1 === str2
    } catch (error) {
      console.error('âŒ æ¯”è¾ƒå¡ç‰‡æ•°æ®å¤±è´¥:', error)
      return false
    }
  }

  /**
   * è·å–å¡ç‰‡æ•°æ®æ‘˜è¦
   * @param data å¡ç‰‡æ•°æ®
   */
  public getCardDataSummary(data: ThreeLayerCardData): string {
    if (!data) return 'æ— æ•°æ®'
    
    const cardNumber = this.getCardNumber(data.id || 'card_0')
    const thirdLayerCount = data.thirdLayer?.chartData?.length || 0
    
    return `å¡ç‰‡${cardNumber} (ID: ${data.id || 'unknown'}, ç¬¬ä¸‰å±‚æ•°æ®: ${thirdLayerCount}é¡¹)`
  }

  /**
   * æ‰¹é‡æ›´æ–°å¡ç‰‡æ•°æ®
   * @param cardDataList å¡ç‰‡æ•°æ®åˆ—è¡¨
   * @param updates æ›´æ–°æ•°æ®æ˜ å°„
   */
  public batchUpdateCardData(
    cardDataList: ThreeLayerCardData[],
    updates: Map<number, Partial<ThreeLayerCardData>>
  ): ThreeLayerCardData[] {
    const newList: ThreeLayerCardData[] = []
    
    for (let i = 0; i < cardDataList.length; i++) {
      const originalData = cardDataList[i]
      const updateData = updates.get(i)
      
      if (updateData) {
        const newData = this.updateCardData(originalData, updateData)
        newList.push(newData)
      } else {
        newList.push(originalData)
      }
    }
    
    return newList
  }
}

