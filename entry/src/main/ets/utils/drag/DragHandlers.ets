/**
 * æ‹–æ‹½å¤„ç†å™¨
 * åŠŸèƒ½ï¼šç»Ÿä¸€å¤„ç†æ‹–æ‹½äº‹ä»¶å’Œé€»è¾‘
 * ç”¨é€”ï¼šæä¾›æ ‡å‡†åŒ–çš„æ‹–æ‹½äº‹ä»¶å¤„ç†å‡½æ•°
 */

import { DragManager, DragData, MultiSelectDragData, DragResult } from './DragManager'

/**
 * æ‹–æ‹½å¤„ç†å™¨ç±»
 * æä¾›ç»Ÿä¸€çš„æ‹–æ‹½äº‹ä»¶å¤„ç†é€»è¾‘
 */
export class DragHandlers {
  private dragManager: DragManager

  constructor() {
    this.dragManager = DragManager.getInstance()
  }

  /**
   * å¤„ç†æ‹–æ‹½å¼€å§‹äº‹ä»¶
   * @param data æ‹–æ‹½æ•°æ®
   * @param isMultiSelect æ˜¯å¦å¤šé€‰
   */
  public handleDragStart(data: DragData | MultiSelectDragData, isMultiSelect: boolean = false): void {
    if (!this.dragManager.validateDragData(data)) {
      console.error('âŒ æ‹–æ‹½æ•°æ®éªŒè¯å¤±è´¥:', data)
      return
    }

    this.dragManager.startDrag(data, isMultiSelect)
  }

  /**
   * å¤„ç†æ‹–æ‹½ç»“æŸäº‹ä»¶
   * @param onDelete åˆ é™¤å›è°ƒå‡½æ•°
   * @param onCopy å¤åˆ¶å›è°ƒå‡½æ•°
   * @param delay å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
   */
  public handleDragEnd(
    onDelete?: () => void,
    onCopy?: () => void,
    delay: number = 50
  ): void {
    // ä½¿ç”¨å»¶è¿Ÿç¡®ä¿ç›®æ ‡ç»„ä»¶çš„onDropå…ˆæ‰§è¡Œ
    setTimeout(() => {
      const isHandled = this.dragManager.isDropHandled()
      
      if (isHandled) {
        // æ‹–æ‹½è¢«å¤„ç†ï¼ˆå¤åˆ¶æ¨¡å¼ï¼‰
        console.log('ğŸŸ¢ æ‹–æ‹½è¢«å¤„ç†ï¼Œæ‰§è¡Œå¤åˆ¶é€»è¾‘')
        if (onCopy) {
          onCopy()
        }
      } else {
        // æ‹–æ‹½æœªè¢«å¤„ç†ï¼ˆåˆ é™¤æ¨¡å¼ï¼‰
        console.log('ğŸŸ¡ æ‹–æ‹½æœªè¢«å¤„ç†ï¼Œæ‰§è¡Œåˆ é™¤é€»è¾‘')
        if (onDelete) {
          onDelete()
        }
      }

      // ç»“æŸæ‹–æ‹½
      this.dragManager.endDrag()
    }, delay)
  }

  /**
   * å¤„ç†æ‹–æ‹½æŠ•æ”¾äº‹ä»¶
   * @param targetId ç›®æ ‡ID
   * @param isHandled æ˜¯å¦è¢«å¤„ç†
   */
  public handleDrop(targetId: string, isHandled: boolean = true): void {
    this.dragManager.handleDrop(targetId, isHandled)
  }

  /**
   * å¤„ç†ç¬¬ä¸‰å±‚æ‹–æ‹½æŠ•æ”¾
   * @param data æ‹–æ‹½æ•°æ®
   * @param targetCardId ç›®æ ‡å¡ç‰‡ID
   * @param isFromCard æ˜¯å¦æ¥è‡ªå…¶ä»–å¡ç‰‡
   * @param isFromTable æ˜¯å¦æ¥è‡ªè¡¨æ ¼
   */
  public handleThirdLayerDrop(
    data: DragData,
    targetCardId: string,
    isFromCard: boolean,
    isFromTable: boolean
  ): void {
    if (isFromCard) {
      // ä»å…¶ä»–å¡ç‰‡æ‹–æ‹½ï¼šå¤åˆ¶æ¨¡å¼
      console.log('ğŸŸ¢ å¤åˆ¶æ¨¡å¼ ç§»åŠ¨å†…å®¹:', data.value)
      this.dragManager.setThirdLayerInfo(data)
      this.dragManager.handleDrop(targetCardId, true)
    } else if (isFromTable) {
      // ä»è¡¨æ ¼æ‹–æ‹½ï¼šå†…å®¹ä¸å˜
      console.log('ğŸŸ¢ å†…å®¹ä¸å˜ ç§»åŠ¨å†…å®¹:', data.value)
      this.dragManager.handleDrop(targetCardId, true)
    } else {
      // å…¶ä»–æƒ…å†µï¼šç§»åŠ¨éå¡ç‰‡åŒºåŸŸ
      console.log('ğŸŸ¡ ç§»åŠ¨éå¡ç‰‡åŒºåŸŸ ç§»åŠ¨å†…å®¹:', data.value)
      this.dragManager.handleDrop(targetCardId, false)
    }
  }

  /**
   * å¤„ç†å¡ç‰‡å¤–å±‚æ‹–æ‹½æŠ•æ”¾
   * @param targetCardId ç›®æ ‡å¡ç‰‡ID
   * @param data æ‹–æ‹½æ•°æ®
   */
  public handleCardOuterDrop(targetCardId: string, data: DragData): void {
    console.log('ğŸŸ¢ å†…å®¹ä¸å˜ ç§»åŠ¨å†…å®¹:', data.value)
    this.dragManager.handleDrop(targetCardId, true)
  }

  /**
   * å¤„ç†è¡¨æ ¼æ‹–æ‹½æŠ•æ”¾
   * @param data æ‹–æ‹½æ•°æ®
   * @param isMultiSelect æ˜¯å¦å¤šé€‰
   */
  public handleTableDrop(data: DragData | MultiSelectDragData, isMultiSelect: boolean = false): void {
    if (isMultiSelect) {
      const multiData = data as MultiSelectDragData
      console.log('ğŸŸ¢ å†…å®¹ä¸å˜ ç§»åŠ¨å†…å®¹:', `å¤šé€‰${multiData.count}é¡¹`)
    } else {
      const singleData = data as DragData
      console.log('ğŸŸ¢ å†…å®¹ä¸å˜ ç§»åŠ¨å†…å®¹:', singleData.value)
    }
    
    this.dragManager.handleDrop('table', true)
  }

  /**
   * å¤„ç†æ‹–æ‹½åˆ°ç©ºç™½åŒºåŸŸ
   * @param data æ‹–æ‹½æ•°æ®
   */
  public handleBlankAreaDrop(data: DragData | MultiSelectDragData): void {
    if (data.type === 'multi_select') {
      const multiData = data as MultiSelectDragData
      console.log('ğŸŸ¡ ç§»åŠ¨éå¡ç‰‡åŒºåŸŸ ç§»åŠ¨å†…å®¹:', `å¤šé€‰${multiData.count}é¡¹`)
    } else {
      const singleData = data as DragData
      console.log('ğŸŸ¡ ç§»åŠ¨éå¡ç‰‡åŒºåŸŸ ç§»åŠ¨å†…å®¹:', singleData.value)
    }
    
    this.dragManager.handleDrop('blank', false)
  }

  /**
   * åˆ›å»ºæ‹–æ‹½æ•°æ®
   * @param value å€¼
   * @param sourceTable æºè¡¨æ ¼
   * @param rowIndex è¡Œç´¢å¼•
   * @param colIndex åˆ—ç´¢å¼•
   * @param sourceCardId æºå¡ç‰‡ID
   * @param sourceValue æºå€¼
   * @param itemIndex é¡¹ç›®ç´¢å¼•
   */
  public createDragData(
    value: string,
    sourceTable: string,
    rowIndex?: number,
    colIndex?: number,
    sourceCardId?: string,
    sourceValue?: string,
    itemIndex?: number
  ): DragData {
    return {
      value,
      sourceTable,
      rowIndex,
      colIndex,
      sourceCardId,
      sourceValue,
      itemIndex
    }
  }

  /**
   * åˆ›å»ºå¤šé€‰æ‹–æ‹½æ•°æ®
   * @param cells å•å…ƒæ ¼æ•°ç»„
   */
  public createMultiSelectDragData(cells: Array<{
    rowIndex: number
    colIndex: number
    value: string
    sourceTable: string
  }>): MultiSelectDragData {
    return {
      type: 'multi_select',
      cells,
      count: cells.length
    }
  }

  /**
   * è§£ææ‹–æ‹½æ•°æ®å­—ç¬¦ä¸²
   * @param dataStr æ•°æ®å­—ç¬¦ä¸²
   */
  public parseDragData(dataStr: string): DragData | MultiSelectDragData | null {
    return this.dragManager.deserializeDragData(dataStr)
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æ¥è‡ªå…¶ä»–å¡ç‰‡
   * @param sourceCardId æºå¡ç‰‡ID
   * @param targetCardId ç›®æ ‡å¡ç‰‡ID
   * @param sourceTable æºè¡¨æ ¼
   */
  public isFromOtherCard(sourceCardId: string, targetCardId: string, sourceTable: string): boolean {
    return (
      (sourceCardId && String(sourceCardId) !== String(targetCardId)) ||
      (sourceTable === 'card_third_layer' && String(sourceCardId) !== String(targetCardId))
    )
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æ¥è‡ªè¡¨æ ¼
   * @param sourceTable æºè¡¨æ ¼
   */
  public isFromTable(sourceTable: string): boolean {
    return sourceTable === 'ç­‰çº§è¡¨' || sourceTable === 'card_third_layer'
  }
}
