/**
 * æ‹–æ‹½ç®¡ç†å™¨
 * åŠŸèƒ½ï¼šç»Ÿä¸€ç®¡ç†æ‹–æ‹½çŠ¶æ€ã€æ•°æ®å’Œäº‹ä»¶å¤„ç†
 * ç”¨é€”ï¼šå‡å°‘æ‹–æ‹½ç›¸å…³ä»£ç é‡å¤ï¼Œæä¾›ç»Ÿä¸€çš„æ‹–æ‹½API
 */

// AppStorage is globally available

// æ‹–æ‹½æ•°æ®æ¥å£
export interface DragData {
  value: string
  sourceTable: string
  rowIndex?: number
  colIndex?: number
  sourceCardId?: string
  sourceValue?: string
  itemIndex?: number
  levelName?: string // æ·»åŠ ç­‰çº§åç§°å­—æ®µ
}

// å¤šé€‰å•å…ƒæ ¼æ¥å£
export interface MultiSelectCell {
  rowIndex: number
  colIndex: number
  value: string
  sourceTable: string
}

// å¤šé€‰æ‹–æ‹½æ•°æ®æ¥å£
export interface MultiSelectDragData {
  type: 'multi_select'
  cells: MultiSelectCell[]
  count: number
}

// ç§»é™¤æºæ•°æ®æ¥å£
export interface RemoveSourceData {
  sourceCardId: string
  sourceValue: string
}

// æ‹–æ‹½çŠ¶æ€æšä¸¾
export enum DragStatus {
  IDLE = 'idle',
  DRAGGING = 'dragging',
  DROPPING = 'dropping'
}

// æ‹–æ‹½ç»“æœæšä¸¾
export enum DragResult {
  SUCCESS = 'success',
  FAILED = 'failed',
  CANCELLED = 'cancelled'
}

// å…¨å±€æ‹–æ‹½å­˜å‚¨é”®æ¥å£
export interface DragStorageKeys {
  GLOBAL_DROP_HANDLED: string
  GLOBAL_DROP_VALUE: string
  GLOBAL_DROP_THIRD_INFO: string
  REMOVE_SOURCE_DATA: string
  CELL_DRAG_ACTIVE_KEY: string
  MULTI_SELECT_CELLS_KEY: string
  CLEAR_ALL_HIGHLIGHTS_KEY: string
}

// å…¨å±€æ‹–æ‹½å­˜å‚¨é”®
export const DRAG_STORAGE_KEYS: DragStorageKeys = {
  GLOBAL_DROP_HANDLED: 'GLOBAL_DROP_HANDLED',
  GLOBAL_DROP_VALUE: 'GLOBAL_DROP_VALUE',
  GLOBAL_DROP_THIRD_INFO: 'GLOBAL_DROP_THIRD_INFO',
  REMOVE_SOURCE_DATA: 'REMOVE_SOURCE_DATA',
  CELL_DRAG_ACTIVE_KEY: 'CELL_DRAG_ACTIVE_KEY',
  MULTI_SELECT_CELLS_KEY: 'MULTI_SELECT_CELLS_KEY',
  CLEAR_ALL_HIGHLIGHTS_KEY: 'CLEAR_ALL_HIGHLIGHTS_KEY'
}

/**
 * æ‹–æ‹½ç®¡ç†å™¨
 * æä¾›ç»Ÿä¸€çš„æ‹–æ‹½çŠ¶æ€ç®¡ç†å’Œæ•°æ®å¤„ç†
 */
export class DragManager {
  private static instance: DragManager
  private currentStatus: DragStatus = DragStatus.IDLE
  private dragData: DragData | null = null
  private multiSelectData: MultiSelectDragData | null = null

  private constructor() {}

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): DragManager {
    if (!DragManager.instance) {
      DragManager.instance = new DragManager()
    }
    return DragManager.instance
  }

  /**
   * å¼€å§‹æ‹–æ‹½
   * @param data æ‹–æ‹½æ•°æ®
   * @param isMultiSelect æ˜¯å¦å¤šé€‰æ‹–æ‹½
   */
  public startDrag(data: DragData | MultiSelectDragData, isMultiSelect: boolean = false): void {
    this.currentStatus = DragStatus.DRAGGING

    if (isMultiSelect) {
      this.multiSelectData = data as MultiSelectDragData
      this.dragData = null
    } else {
      this.dragData = data as DragData
      this.multiSelectData = null
    }

    // è®¾ç½®å…¨å±€çŠ¶æ€
    // æ³¨æ„ï¼šä¸é‡ç½®GLOBAL_DROP_HANDLEDï¼Œå› ä¸ºThirdLayerå¯èƒ½å·²ç»è®¾ç½®äº†å®ƒ
    
    if (isMultiSelect) {
      const multiData = data as MultiSelectDragData
      AppStorage.set(DRAG_STORAGE_KEYS.GLOBAL_DROP_VALUE, JSON.stringify(multiData))
    } else {
      const singleData = data as DragData
      AppStorage.set(DRAG_STORAGE_KEYS.GLOBAL_DROP_VALUE, singleData.value)
    }

    console.log('ğŸ¯ æ‹–æ‹½ç®¡ç†å™¨ï¼šå¼€å§‹æ‹–æ‹½', isMultiSelect ? 'å¤šé€‰' : 'å•é€‰')
  }

  /**
   * ç»“æŸæ‹–æ‹½
   * @param result æ‹–æ‹½ç»“æœ
   */
  public endDrag(result: DragResult = DragResult.SUCCESS): void {
    this.currentStatus = DragStatus.IDLE
    this.dragData = null
    this.multiSelectData = null

    // æ¸…ç†å…¨å±€çŠ¶æ€
    this.clearGlobalState()
    
    console.log('ğŸ§¹ æ‹–æ‹½ç®¡ç†å™¨ï¼šç»“æŸæ‹–æ‹½ï¼Œç»“æœ:', result)
  }

  /**
   * å¤„ç†æ‹–æ‹½æŠ•æ”¾
   * @param targetId ç›®æ ‡ID
   * @param isHandled æ˜¯å¦è¢«å¤„ç†
   */
  public handleDrop(targetId: string, isHandled: boolean = true): void {
    AppStorage.set(DRAG_STORAGE_KEYS.GLOBAL_DROP_HANDLED, isHandled)
    
    if (isHandled) {
      console.log('ğŸŸ¢ æ‹–æ‹½ç®¡ç†å™¨ï¼šæ‹–æ‹½è¢«å¤„ç†ï¼Œç›®æ ‡:', targetId)
    } else {
      console.log('ğŸŸ¡ æ‹–æ‹½ç®¡ç†å™¨ï¼šæ‹–æ‹½æœªè¢«å¤„ç†ï¼Œç›®æ ‡:', targetId)
    }
  }

  /**
   * æ£€æŸ¥æ‹–æ‹½æ˜¯å¦è¢«å¤„ç†
   */
  public isDropHandled(): boolean {
    return AppStorage.get(DRAG_STORAGE_KEYS.GLOBAL_DROP_HANDLED) as boolean || false
  }

  /**
   * è·å–æ‹–æ‹½æ•°æ®
   */
  public getDragData(): DragData | null {
    return this.dragData
  }

  /**
   * è·å–å¤šé€‰æ‹–æ‹½æ•°æ®
   */
  public getMultiSelectData(): MultiSelectDragData | null {
    return this.multiSelectData
  }

  /**
   * è·å–å½“å‰æ‹–æ‹½çŠ¶æ€
   */
  public getCurrentStatus(): DragStatus {
    return this.currentStatus
  }

  /**
   * è®¾ç½®ç¬¬ä¸‰å±‚æ‹–æ‹½ä¿¡æ¯
   * @param info ç¬¬ä¸‰å±‚æ‹–æ‹½ä¿¡æ¯
   */
  public setThirdLayerInfo(info: DragData): void {
    AppStorage.set(DRAG_STORAGE_KEYS.GLOBAL_DROP_THIRD_INFO, JSON.stringify(info))
  }

  /**
   * è·å–ç¬¬ä¸‰å±‚æ‹–æ‹½ä¿¡æ¯
   */
  public getThirdLayerInfo(): DragData | null {
    const infoStr = AppStorage.get(DRAG_STORAGE_KEYS.GLOBAL_DROP_THIRD_INFO) as string
    if (!infoStr) return null
    
    try {
      return JSON.parse(infoStr) as DragData
    } catch (error) {
      console.error('è§£æç¬¬ä¸‰å±‚æ‹–æ‹½ä¿¡æ¯å¤±è´¥:', error)
      return null
    }
  }

  /**
   * è®¾ç½®ç§»é™¤æºæ•°æ®æ ‡å¿—
   * @param sourceCardId æºå¡ç‰‡ID
   * @param sourceValue æºå€¼
   */
  public setRemoveSourceData(sourceCardId: string, sourceValue: string): void {
    const removeData: RemoveSourceData = {
      sourceCardId,
      sourceValue
    }
    AppStorage.set(DRAG_STORAGE_KEYS.REMOVE_SOURCE_DATA, removeData)
  }

  /**
   * è·å–ç§»é™¤æºæ•°æ®æ ‡å¿—
   */
  public getRemoveSourceData(): RemoveSourceData | null {
    return AppStorage.get(DRAG_STORAGE_KEYS.REMOVE_SOURCE_DATA) as RemoveSourceData | null
  }

  /**
   * æ¸…ç†å…¨å±€çŠ¶æ€
   */
  private clearGlobalState(): void {
    AppStorage.set(DRAG_STORAGE_KEYS.GLOBAL_DROP_HANDLED, false)
    AppStorage.set(DRAG_STORAGE_KEYS.GLOBAL_DROP_VALUE, '')
    AppStorage.set(DRAG_STORAGE_KEYS.GLOBAL_DROP_THIRD_INFO, '')
    AppStorage.set(DRAG_STORAGE_KEYS.REMOVE_SOURCE_DATA, null)
  }

  /**
   * éªŒè¯æ‹–æ‹½æ•°æ®
   * @param data æ‹–æ‹½æ•°æ®
   */
  public validateDragData(data: DragData | MultiSelectDragData): boolean {
    if (!data) return false
    
    if (this.isMultiSelectData(data)) {
      const multiData = data as MultiSelectDragData
      return multiData.cells && Array.isArray(multiData.cells) && multiData.count > 0
    } else {
      const singleData = data as DragData
      return !!(singleData.value && singleData.sourceTable)
    }
  }

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºå¤šé€‰æ•°æ®
   * @param data æ‹–æ‹½æ•°æ®
   */
  private isMultiSelectData(data: DragData | MultiSelectDragData): boolean {
    return (data as MultiSelectDragData).type === 'multi_select'
  }

  /**
   * åºåˆ—åŒ–æ‹–æ‹½æ•°æ®
   * @param data æ‹–æ‹½æ•°æ®
   */
  public serializeDragData(data: DragData | MultiSelectDragData): string {
    return JSON.stringify(data)
  }

  /**
   * ååºåˆ—åŒ–æ‹–æ‹½æ•°æ®
   * @param dataStr æ•°æ®å­—ç¬¦ä¸²
   */
  public deserializeDragData(dataStr: string): DragData | MultiSelectDragData | null {
    try {
      return JSON.parse(dataStr)
    } catch (error) {
      console.error('ååºåˆ—åŒ–æ‹–æ‹½æ•°æ®å¤±è´¥:', error)
      return null
    }
  }
}

/**
 * æ‹–æ‹½å¤„ç†å™¨
 * æä¾›ç»Ÿä¸€çš„æ‹–æ‹½äº‹ä»¶å¤„ç†é€»è¾‘
 */
export class DragHandlers {
  private dragManager: DragManager

  constructor() {
    this.dragManager = DragManager.getInstance()
  }

  /**
   * å¤„ç†æ‹–æ‹½å¼€å§‹
   * @param data æ‹–æ‹½æ•°æ®
   */
  public handleDragStart(data: DragData): void {
    this.dragManager.startDrag(data, false)
  }

  /**
   * å¤„ç†æ‹–æ‹½ç»“æŸ
   * @param onDelete åˆ é™¤å›è°ƒ
   * @param onCopy å¤åˆ¶å›è°ƒ
   */
  public handleDragEnd(onDelete: () => void, onCopy: () => void): void {
    // ä½¿ç”¨setTimeoutç¡®ä¿ç›®æ ‡å¡ç‰‡çš„onDropå…ˆæ‰§è¡Œ
    setTimeout(() => {
      const isHandled = this.dragManager.isDropHandled()
      console.log('ğŸ” handleDragEnd - isDropHandled:', isHandled)
      
      if (!isHandled) {
        // æ‹–æ‹½åˆ°ç©ºç™½åŒºåŸŸï¼Œæ‰§è¡Œåˆ é™¤
        console.log('ğŸ—‘ï¸ æ‰§è¡Œåˆ é™¤é€»è¾‘')
        onDelete()
      } else {
        // æ‹–æ‹½åˆ°å…¶ä»–å¡ç‰‡ï¼Œæ‰§è¡Œå¤åˆ¶
        console.log('ğŸŸ¢ æ‰§è¡Œå¤åˆ¶é€»è¾‘')
        onCopy()
      }
      
      this.dragManager.endDrag()
    }, 100) // å¢åŠ å»¶è¿Ÿæ—¶é—´ä»50msåˆ°100ms
  }

  /**
   * å¤„ç†æ‹–æ‹½æŠ•æ”¾
   * @param targetId ç›®æ ‡ID
   * @param isHandled æ˜¯å¦è¢«å¤„ç†
   */
  public handleDrop(targetId: string, isHandled: boolean = true): void {
    this.dragManager.handleDrop(targetId, isHandled)
  }
}