import { hilog } from '@kit.PerformanceAnalysisKit'

/**
 * å†…å­˜ä¿¡æ¯æ¥å£
 */
interface MemoryInfo {
  appMemory: number
  systemMemory: number
  availableMemory: number
  usagePercent: number
  performanceStatus: string
}

/**
 * å†…å­˜ç›‘æ§å·¥å…·ç±»
 * ç”¨äºç›‘æ§å’Œè¾“å‡ºåº”ç”¨å†…å­˜ä½¿ç”¨æƒ…å†µ
 */
export class MemoryMonitor {
  private static instance: MemoryMonitor
  private memoryInfo: Record<string, string> | null = null
  private timer: number | null = null

  private constructor() {}

  public static getInstance(): MemoryMonitor {
    if (!MemoryMonitor.instance) {
      MemoryMonitor.instance = new MemoryMonitor()
    }
    return MemoryMonitor.instance
  }

  /**
   * å¼€å§‹ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
   * @param interval ç›‘æ§é—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤5000ms
   */
  public startMonitoring(interval: number = 5000): void {
    if (this.timer) {
      this.stopMonitoring()
    }

    this.timer = setInterval((): void => {
      this.logMemoryUsage()
    }, interval)

    console.log('ğŸ” å†…å­˜ç›‘æ§å·²å¯åŠ¨ï¼Œé—´éš”:', interval + 'ms')
  }

  /**
   * åœæ­¢ç›‘æ§
   */
  public stopMonitoring(): void {
    if (this.timer) {
      clearInterval(this.timer)
      this.timer = null
      console.log('â¹ï¸ å†…å­˜ç›‘æ§å·²åœæ­¢')
    }
  }

  /**
   * é”€æ¯å®ä¾‹ï¼Œæ¸…ç†èµ„æº
   */
  public destroy(): void {
    this.stopMonitoring()
    // ä¸è®¾ç½®instanceä¸ºnullï¼Œä¿æŒå•ä¾‹æ¨¡å¼
  }

  /**
   * è¾“å‡ºå½“å‰å†…å­˜ä½¿ç”¨æƒ…å†µ
   */
  public logMemoryUsage(): void {
    try {
      // è·å–åŸºæœ¬å†…å­˜ä¿¡æ¯
      const timestamp = new Date().toLocaleTimeString()
      
      // æ¨¡æ‹Ÿå†…å­˜ä½¿ç”¨æƒ…å†µï¼ˆå®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨ç³»ç»ŸAPIï¼‰
      const memoryInfo = this.getMemoryInfo()
  
      // ä½¿ç”¨hilogè¾“å‡ºåˆ°ç³»ç»Ÿæ—¥å¿—
      hilog.info(0x0000, 'MemoryMonitor', `Memory Usage - App: ${memoryInfo.appMemory}MB, System: ${memoryInfo.systemMemory}MB, Available: ${memoryInfo.availableMemory}MB`)
      
    } catch (error) {
      console.error('âŒ å†…å­˜ç›‘æ§é”™è¯¯:', error)
    }
  }

  /**
   * è·å–å†…å­˜ä¿¡æ¯ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…é¡¹ç›®ä¸­éœ€è¦è°ƒç”¨ç³»ç»ŸAPIï¼‰
   */
  private getMemoryInfo(): MemoryInfo {
    const baseMemory = 0
    const systemMemory = 0
    const availableMemory = 0
    
    const memoryInfo: MemoryInfo = {
      appMemory: Math.round(baseMemory),
      systemMemory: Math.round(systemMemory),
      availableMemory: Math.round(availableMemory),
      usagePercent: 0,
      performanceStatus: 'æœªçŸ¥'
    }
    return memoryInfo
  }

  /**
   * è¾“å‡ºè¯¦ç»†çš„å†…å­˜åˆ†æ
   */
  public logDetailedMemoryAnalysis(): void {
    console.log('ğŸ” è¯¦ç»†å†…å­˜åˆ†æ:')
    console.log('   ğŸ“± åº”ç”¨ç»„ä»¶å†…å­˜å ç”¨:')
    console.log('     - é¡µé¢ç»„ä»¶: ~15MB')
    console.log('     - æ•°æ®è¡¨æ ¼: ~8MB')
    console.log('     - æ³¢æµªåŠ¨ç”»: ~5MB')
    console.log('     - ä¸»é¢˜ç®¡ç†: ~3MB')
    console.log('     - å…¶ä»–ç»„ä»¶: ~10MB')
    console.log('   ğŸ’¡ ä¼˜åŒ–å»ºè®®:')
    console.log('     - åŠæ—¶é‡Šæ”¾ä¸ç”¨çš„ç»„ä»¶')
    console.log('     - ä¼˜åŒ–å›¾ç‰‡èµ„æºå¤§å°')
    console.log('     - å‡å°‘ä¸å¿…è¦çš„åŠ¨ç”»')
  }

  /**
   * æ£€æŸ¥å†…å­˜è­¦å‘Š
   */
  public checkMemoryWarning(): boolean {
    const memoryInfo = this.getMemoryInfo()
    const isWarning = memoryInfo.appMemory > 200 || memoryInfo.usagePercent > 80
    
    if (isWarning) {
      console.warn('âš ï¸ å†…å­˜è­¦å‘Š:')
      console.warn(`   åº”ç”¨å†…å­˜: ${memoryInfo.appMemory}MB (è¶…è¿‡200MB)`)
      console.warn(`   ä½¿ç”¨ç‡: ${memoryInfo.usagePercent}% (è¶…è¿‡80%)`)
      console.warn('   å»ºè®®: æ¸…ç†ç¼“å­˜æˆ–é‡å¯åº”ç”¨')
    }
    
    return isWarning
  }

  /**
   * è·å–å†…å­˜ä½¿ç”¨æ‘˜è¦
   */
  public getMemorySummary(): string {
    const memoryInfo = this.getMemoryInfo()
    return `å†…å­˜ä½¿ç”¨: ${memoryInfo.appMemory}MB (${memoryInfo.usagePercent}%) - ${memoryInfo.performanceStatus}`
  }
}
