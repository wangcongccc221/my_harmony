# 项目交接文档

## 📋 项目基本信息

- **项目名称**: My_Project（HarmonyOS/OpenHarmony 应用）
- **包名**: `com.nutpi.My_Project`
- **版本**: 1.0.0 (Code: 1000000)
- **开发框架**: HarmonyOS ArkTS
- **构建工具**: DevEco Studio (hvigor)
- **主要功能**: 水果分选加工管理系统（包含实时监控、历史数据、质量等级管理、HTTP/TCP服务）

---

## 🛠️ 技术栈

### 核心框架
- **HarmonyOS ArkTS**: 主要开发语言
- **ArkUI**: UI框架
- **RDB (Relational Database)**: SQLite数据库

### 第三方依赖
```json
{
  "@wuba58/omni-ui": "^1.0.1",        // UI组件库
  "@ibestservices/ibest-ui": "^2.1.7", // UI组件库
  "@mcui/mccharts": "^2.8.9"          // 图表组件库
}
```

### 开发工具依赖
- `@ohos/hypium`: 单元测试框架
- `@ohos/hamock`: Mock工具

---

## 📁 项目结构

```
my_harmony-master/
├── AppScope/                    # 应用级配置
│   ├── app.json5               # 应用配置
│   └── resources/              # 应用级资源
├── entry/                      # 主模块
│   ├── src/main/
│   │   ├── ets/                # 源代码目录
│   │   │   ├── components/    # UI组件
│   │   │   │   ├── cards/     # 卡片组件（液体卡片、三层卡片）
│   │   │   │   ├── charts/    # 图表组件（折线图、柱状图、波浪图）
│   │   │   │   ├── dialogs/   # 对话框组件
│   │   │   │   ├── layout/    # 布局组件（表格、导航栏、状态栏）
│   │   │   │   └── ui/        # 基础UI组件
│   │   │   ├── pages/         # 页面
│   │   │   │   ├── home/      # 首页（实时监控、加工曲线）
│   │   │   │   ├── history/   # 历史数据页面
│   │   │   │   ├── level/     # 等级管理页面
│   │   │   │   ├── quality/   # 品质管理页面
│   │   │   │   ├── endprocessing/ # 结束加工页面
│   │   │   │   └── realtime/  # 实时统计页面
│   │   │   ├── db/            # 数据库服务
│   │   │   │   ├── ArkDataDemo.ets  # 数据库操作实现
│   │   │   │   └── RdbService.ets   # 数据库服务别名导出
│   │   │   ├── utils/         # 工具类
│   │   │   │   ├── network/   # 网络服务（HTTP/TCP）
│   │   │   │   ├── theme/     # 主题管理
│   │   │   │   └── ...        # 其他工具
│   │   │   └── entryability/  # 应用入口
│   │   └── resources/         # 资源文件
│   └── build-profile.json5     # 构建配置
├── oh_modules/                 # 第三方依赖
├── playwright-tests/           # 自动化测试
└── README*.md                  # 文档
```

---

## 🎯 核心功能模块

### 1. 首页（Home）
- **文件**: `pages/home/HomeContent.ets`
- **功能**:
  - 实时监控卡片（速度、产量、重量等）
  - 液体动画卡片（波浪效果）
  - 加工曲线图表（折线图，15秒更新一次）
  - 加工柱状图（15秒更新一次）
  - FSM状态切换（FSM1/FSM2）
  - 顶部状态栏（时间、客户信息、最小化/关闭按钮）

### 2. 历史数据（History）
- **文件**: `pages/history/HistoryContent.ets`
- **功能**:
  - 按客户/农场/水果名称查询
  - 按日期范围查询
  - 数据表格展示
  - 数据导出（CSV/XLSX）
  - 数据删除

### 3. 等级管理（Level）
- **文件**: `pages/level/LevelContent.ets`
- **功能**:
  - 等级标准设置
  - 出口报警设置
  - 装箱量计算
  - 等级数据表格

### 4. 品质管理（Quality）
- **文件**: `pages/quality/QualityContent.ets`
- **功能**:
  - 品质标准设置
  - 品质数据统计

### 5. 结束加工（EndProcessing）
- **文件**: `pages/endprocessing/EndProcessingContent.ets`
- **功能**:
  - 加工记录录入
  - 加工数据表格
  - 数据保存到数据库

### 6. 实时统计（Realtime）
- **文件**: `pages/realtime/RealtimeStatsContent.ets`
- **功能**:
  - 实时数据统计
  - 饼图展示
  - 品质统计

---

## 🗄️ 数据库设计

### 数据库服务
- **文件**: `db/ArkDataDemo.ets` (实现) / `db/RdbService.ets` (别名)
- **初始化**: `EntryAbility.onCreate()` 中调用

### 数据表

#### 1. `users` 表
```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  age INTEGER
)
```

#### 2. `processing_history` 表（加工历史）
```sql
CREATE TABLE processing_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  startTime TEXT,
  endTime TEXT,
  productType TEXT,
  totalWeight REAL,
  customerName TEXT,
  farmName TEXT,
  fruitName TEXT,
  status TEXT,
  count INTEGER,
  weight REAL
)
```
- **索引**: `idx_processing_time` (startTime, endTime)
- **分页查询**: `queryProcessingPaged(limit, offset)`
- **缓存限制**: 最多1000条（在 `HttpServerHandler` 中）

#### 3. `fruit_info` 表（水果信息）
```sql
CREATE TABLE fruit_info (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  lane TEXT NOT NULL,
  fruitName TEXT,
  variety TEXT,
  origin TEXT,
  grade TEXT,
  weight REAL,
  color TEXT,
  size TEXT,
  createdAt TEXT
)
```
- **索引**: `idx_fruit_lane` (lane)
- **Upsert逻辑**: 按 `lane` 唯一，存在则更新，不存在则插入

### 数据库操作
- **查询**: `RdbService.queryAllProcessing()`, `RdbService.queryProcessingPaged()`
- **插入**: `RdbService.insertProcessingFull()`, `RdbService.insertFruitInfo()`
- **更新**: `RdbService.updateProcessingById()`, `RdbService.upsertFruitInfo()`
- **删除**: `RdbService.deleteProcessingById()`, `RdbService.deleteFruitInfo()`

---

## 🌐 网络服务

### HTTP服务器
- **文件**: `utils/network/HttpServer.ets` (服务器管理)
- **文件**: `utils/network/HttpServerHandler.ets` (请求处理)
- **端口**: 8080（默认）
- **启动**: `EntryAbility.onCreate()` 中自动启动

#### 主要接口

##### 1. 加工历史接口 (`/api/processing`)
- **查询**: `GET /api/processing?action=listJson`
- **插入**: `GET /api/processing?action=insert&startTime=...&endTime=...&...`
- **更新**: `GET /api/processing?action=update&id=...&...`
- **删除**: `GET /api/processing?action=delete&id=...`

##### 2. 水果信息接口 (`/api/fruit-info`)
- **查询**: `GET /api/fruit-info?action=listJson`
- **插入/更新**: `GET /api/fruit-info?action=upsert&lane=...&...`
- **删除**: `GET /api/fruit-info?action=delete&lane=...`

##### 3. 文件浏览接口 (`/api/files`)
- **列表**: `GET /api/files?path=...`
- **下载**: `GET /api/files?path=...&download=true`

#### 端口映射（开发调试）
```bash
# 将设备8080端口映射到本机8080
hdc fport tcp:8080 tcp:8080

# 查看映射
hdc fport ls

# 删除映射
hdc fport rm tcp:8080
```

### TCP服务器/客户端
- **文件**: `utils/network/TCPServer.ets` (服务器)
- **文件**: `utils/network/TcpClient.ets` / `TcpClientManager.ets` (客户端)
- **用途**: 用于设备间数据传输

---

## 🎨 主题系统

### 主题管理
- **文件**: `utils/theme/OmniThemeManager.ets`
- **功能**:
  - 支持明暗主题切换
  - FSM状态相关主题（FSM1/FSM2）
  - 主题持久化（AppStorage）

### 使用方式
```typescript
import { OmniThemeManager } from '../../utils/theme/OmniThemeManager'

// 获取当前主题
const theme = OmniThemeManager.getInstance().getCurrentTheme()

// 切换主题
OmniThemeManager.getInstance().setThemeType(OmniThemeType.LIGHT)
```

---

## ⚡ 性能优化

### 内存优化（已实施）

#### 1. 图表数据源优化
- **文件**: `utils/ProcessingCurveFeed.ets`, `utils/ProcessingBarFeed.ets`
- **优化**:
  - 使用固定长度环形缓冲区（60个点）
  - `getSnapshot()` 复用数组对象，避免频繁创建新数组
  - 数据更新频率：15秒一次

#### 2. 缓存大小限制
- **文件**: `utils/network/HttpServerHandler.ets`
- **优化**:
  - `processingCache` 限制最大1000条记录
  - 使用 `limitCacheSize()` 方法自动截断

#### 3. 定时器管理
- 所有定时器在 `aboutToDisappear()` 中清理
- 使用 `clearInterval()` 释放资源

### 已知内存问题
- **现象**: 长时间运行后 ArkTS 堆内存可能增长（已优化，但需持续监控）
- **监控工具**: `mem_watch.ps1` (PowerShell脚本)
- **建议**: 定期检查内存使用情况

---

## 🔧 开发环境配置

### 必需工具
1. **DevEco Studio**: HarmonyOS开发IDE
2. **hdc**: HarmonyOS设备连接工具（DevEco Studio自带）
3. **Node.js**: 用于运行测试脚本（playwright-tests）

### 环境检查
```bash
# 检查设备连接
hdc list targets

# 检查端口映射
hdc fport ls

# 查看应用日志
hdc hilog
```

### 构建命令
```bash
# 清理构建
hvigorw clean

# 构建项目
hvigorw assembleHap

# 减少构建并发（内存不足时）
$env:HVIGOR_WORKER_NUM="1"
```

---

## 📦 构建与打包

### 开发构建
1. 打开 DevEco Studio
2. 打开项目
3. Build > Make Project (Ctrl+F9)

### 发布构建
1. Project Structure > Signing Configs 配置签名
2. Build > Generate App Package(s)
3. 产物位置: `entry/build/default/outputs/default/entry-default-signed.hap`

---

## 🧪 测试

### 自动化测试
- **目录**: `playwright-tests/`
- **测试文件**:
  - `tests/smoke.spec.ts`: 接口冒烟测试
  - `tests/database-stability.spec.ts`: 数据库稳定性测试（15分钟）
- **压测脚本**:
  - `k6-load-test.js`: 标准压测（15分钟）
  - `k6-load-test-extreme.js`: 极端压测

### 运行测试
```bash
cd playwright-tests
npm install
npm test
```

---

## 📝 代码规范

### 命名规范
- **组件**: PascalCase (如 `HomeContent.ets`)
- **函数/变量**: camelCase (如 `getCurrentTheme()`)
- **常量**: UPPER_SNAKE_CASE (如 `MAX_CACHE_SIZE`)
- **文件**: PascalCase for components, camelCase for utilities

### 代码组织
- **单例模式**: 使用 `getInstance()` 方法（如 `ProcessingCurveFeed`, `RdbService`）
- **状态管理**: 使用 `@State`, `@Prop`, `@StorageLink` 等装饰器
- **异步操作**: 使用 `Promise` 和 `async/await`

### 注释规范
- 关键函数需要 JSDoc 注释
- 复杂逻辑需要行内注释
- TODO 标记需要说明原因

---

## ⚠️ 已知问题和注意事项

### 1. 内存管理
- **问题**: 长时间运行后内存可能增长
- **状态**: 已优化，需持续监控
- **建议**: 定期使用 `mem_watch.ps1` 监控内存

### 2. 图表更新频率
- **当前**: 15秒更新一次（折线图、柱状图）
- **原因**: 降低内存占用和CPU使用
- **如需调整**: 修改 `ProcessingCurveFeed.start()` 和 `ProcessingBarFeed.start()` 中的 `setInterval` 间隔

### 3. 数据库查询
- **分页**: `processing_history` 表支持分页查询（`queryProcessingPaged`）
- **缓存**: HTTP接口缓存限制1000条，超出部分会被截断

### 4. FSM状态切换
- **行为**: 切换FSM时，设置会自动保存和恢复
- **存储**: 使用 AppStorage 持久化

### 5. 文件导出
- **格式**: 支持 CSV（UTF-8 with BOM）和 XLSX
- **位置**: 保存到应用沙箱目录
- **权限**: 需要文件访问权限

---

## 🔐 权限配置

### 应用权限（module.json5）
```json
{
  "requestPermissions": [
    {
      "name": "ohos.permission.INTERNET"
    },
    {
      "name": "ohos.permission.GET_NETWORK_INFO"
    }
  ]
}
```

---

## 📚 相关文档

- `README使用文档.md`: 使用说明
- `README详细文档.md`: 详细技术文档
- `测试总结文档.md`: 测试相关文档
- `db/README.md`: 数据库使用说明

---

## 🚀 快速开始

### 1. 克隆项目
```bash
git clone <repository-url>
cd my_harmony-master
```

### 2. 安装依赖
```bash
# 在 DevEco Studio 中会自动安装 oh_modules
# 如需手动安装测试依赖
cd playwright-tests
npm install
```

### 3. 连接设备
```bash
# 检查设备连接
hdc list targets

# 配置端口映射（如需）
hdc fport tcp:8080 tcp:8080
```

### 4. 运行项目
- 在 DevEco Studio 中点击运行按钮
- 或使用快捷键 Shift+F10

### 5. 测试接口
```bash
# 查询加工历史
curl "http://127.0.0.1:8080/api/processing?action=listJson"

# 插入数据
curl "http://127.0.0.1:8080/api/processing?action=insert&startTime=2025-01-01&endTime=2025-01-02&productType=苹果&totalWeight=100"
```


## 🔧 最近重构与统一约定（task-1 ~ task-2 已完成）

### 1) 表单组件抽取与复用
- 新增组件：
  - `components/ui/FormInputField.ets`：数值输入统一组件（内置样式、范围校验、空值格式化）。
  - `components/ui/FormTextField.ets`、`components/ui/FormTextArea.ets`：文本/多行文本输入统一组件。
- 依赖工具：`utils/helpers/NumberUtils.ets`
  - `parseNumberWithBounds(raw: string, min?: number, max?: number): number`
  - `formatNumberForDisplay(value: number): string`
  - `safeParseNumber(value: unknown, defaultValue=0): number`
  - `roundToDecimal(value: number, decimals=1): number`
  - `calculateTotalWeight(weightKg: number, count: number): number`

使用规范：
- 数值输入一律使用 `FormInputField`，并通过 `config.minValue/maxValue` 控制边界；`onValueChange` 回写 `@State`。
- 直接使用 `TextInput` 写数字会绕过统一校验，新增页面请避免。

### 2) 主题获取统一
- 目标：去除各处 `BaseComponentHelper` 实例化，统一使用 `utils/theme/ThemeUtils.ets`：
  - `getCurrentTheme(consumedTheme?: ExtendedOmniThemeStyle)`
  - `getCurrentThemeType()` / `getThemeManager()`
- 已替换的核心页面/卡片（示例，不限于）：
  - `pages/home/DataTablesTabBar.ets`
  - `pages/endprocessing/*`
  - `pages/history/*`
  - `pages/quality/*`
  - `pages/level/LevelContent.ets`、`pages/level/LevelOutletDialog.ets`
  - `pages/more/MoreContent.ets`
  - `components/feedback/RealtimeStatsDialog.ets`

注意：部分对话框仍使用传统结构（Stack + Column + DialogButtons），未强制切至 `BaseDialog`，以保持当前稳定性。

### 3) 修改影响与收益
- 重复样式和解析逻辑显著减少，新增输入项可低成本扩展。
- 主题切换时的样式一致性提升；后续只需维护 `ThemeUtils` 和主题管理器。

---

## 📌 开发约定（必须遵循）

### 数字输入规范
- 组件：`FormInputField`；禁止手写裸 `TextInput` 处理数字。
- 显示：`NumberUtils.formatNumberForDisplay`，0/无效值显示为空串，避免“0”干扰输入体验。
- 边界：在 `config` 中声明 `minValue/maxValue`，组件会自动 `clamp`。

### 主题使用规范
- 页面/组件统一：`import { getCurrentTheme } from '../../utils/theme/ThemeUtils'`，调用 `getCurrentTheme(this.consumedTheme)`。
- 不再 new `BaseComponentHelper()`。

### 组件/页面风格
- ArkUI DSL 语句仅出现在 `build()/@Builder` 函数体中；对象字面量里仅放纯数据，避免“UI component cannot be used in this place”。
- 需要对象字面量的地方（如 `padding`、`Select` 选项）务必有显式接口或断言（如 `as Padding`、`as { value: string }[]`）。

---

## 🧭 继续开发指引

### A. 页面常见任务模板
1. 新增数值输入项：
   - 引入 `FormInputField`，声明本地 `@State`，配置 `min/max` 与 `unit`。
2. 新增文本输入项：
   - 使用 `FormTextField` 或 `FormTextArea`，统一边框/圆角/颜色。
3. 主题适配：
   - 直接调用 `getCurrentTheme()` 获取 `textColor/borderColor/backgroundColor/surfaceColor/primary` 等。

### B. 构建/运行问题快速排查
- 构建卡死/内存高：将并发降至 1（PowerShell）
  ```bash
  $env:HVIGOR_WORKER_NUM="1"; hvigorw assembleHap
  ```
- 设备未连接：`hdc list targets` 检查；必要时重插数据线或重启设备服务。
- 日志查看：`hdc hilog`，过滤 `My_Project` 关键字。

### C. 常见 ArkTS 编译错误对照（节选）
- `arkts-no-untyped-obj-literals`
  - 现象：对象字面量缺少类型。
  - 处理：补充接口或断言，如 `customPadding: { left: 12, ... } as Padding`。
- `UI component 'X' cannot be used in this place`
  - 现象：在对象字面量或非 DSL 位置写了 `Row()/Text()`。
  - 处理：把 UI 语句移动到 `build()` / `@Builder` 函数体内。
- `arkts-no-implicit-return-types`
  - 现象：回调/函数未显式返回类型。
  - 处理：补 `(): void => {}`、`(e: TouchEvent): void => {}`。

---

## 🗃️ 数据与发布运维

### 数据库备份/恢复（RDB）
- 备份：导出沙箱数据库文件（通过自带 HTTP 接口 `/api/files?path=...&download=true`）。
- 恢复：将备份文件推回沙箱目录后重启应用（注意权限）。

### 发布与签名
1. 配置签名：Project Structure > Signing Configs。
2. 生成 HAP：Build > Generate App Package(s)。
3. 产物：`entry/build/default/outputs/default/entry-default-signed.hap`。

### 运行参数/端口
- HTTP：默认 8080；可通过设备端口转发到本机（见文档“端口映射”）。
- TCP：参见 `utils/network/TCPServer.ets`、`TcpClientManager.ets`。

---

## 🧾 组件与文件变更清单（近期）

- 新增
  - `components/ui/FormInputField.ets`
  - `components/ui/FormTextField.ets`
  - `components/ui/FormTextArea.ets`
  - `utils/helpers/NumberUtils.ets`
  - `components/ui/DialogHeader.ets`
  - `utils/theme/ThemeUtils.ets`

- 主要替换（主题获取方式）
  - `DataTablesTabBar.ets`、`ProcessingDataTable.ets`、`EndProcessingContent.ets`、`HistoryContent.ets`、`HistoryDataTable.ets`、`HistoryQueryPanel.ets`、`CustomerQueryCard.ets`、`QualityControlPanel.ets`、`QualityDataTable.ets`、`QualityOutletDialog.ets`、`LevelContent.ets`、`LevelOutletDialog.ets`、`MoreContent.ets`、`RealtimeStatsContent.ets` 等。

---

## 🧭 待办与建议

1. 对话框容器统一（可选）
   - 使用已有 `DialogHeader` + 现有 `DialogButtons`，维持稳定；如需进一步抽象，可引入稳定版 `BaseDialog`，但需严格通过编译规范（UI DSL 仅在函数体内、对象字面量必须有类型）。
2. `History`/`Quality` 页面输入项逐步替换为 `FormInputField`/`FormTextField`，统一风格与校验。
3. 主题：如需新增主题/配色，集中修改 `OmniThemeManager` 与资源色值。
4. 文档：把 HTTP/TCP 的联调说明合并至 `TCP服务器访问说明.md` 与 README，避免分散。


## ✅ 交接清单补充

- [x] 统一数字输入与主题获取的代码规范说明
- [x] 常见编译错误对照与修复策略
- [x] 数据备份/恢复与发布流程说明
- [x] 后续建议与优先级提示


---

## 🧰 重要配置清单与默认值

### 端口与服务
- **HTTP 服务端口**: `8080`
- **TCP 服务端口**: 参考 `utils/network/TCPServer.ets`（如需对外调试，使用 hdc 端口映射，见下文）

### 构建/运行环境变量（可选）
- `HVIGOR_WORKER_NUM`: 限制构建并发，内存吃紧时设为 `1`
  ```powershell
  $env:HVIGOR_WORKER_NUM="1"; hvigorw assembleHap
  ```

### 签名与产物路径
- 签名配置: DevEco Studio > Project Structure > Signing Configs
- 发布产物（HAP）: `entry/build/default/outputs/default/entry-default-signed.hap`


---

## 💾 数据备份与回滚流程（RDB）

> 推荐通过内置 HTTP 文件接口备份/恢复，避免直接进入沙箱。

### 文件位置（参考）
- 应用沙箱（设备端，参考路径）：
  - 数据库: `/data/storage/el2/database/haps/entry/`（HarmonyOS 机型可能不同）
  - 应用文件: `/data/storage/el2/base/haps/entry/files/`
  - 建议优先使用内置 HTTP 文件接口 `/api/files` 获取实际可见路径

### 备份（通过 HTTP 接口）
1. 列出可用文件：
   ```bash
   curl "http://127.0.0.1:8080/api/files?path=/"
   ```
2. 下载数据库/文件：
   ```bash
   curl -o backup.db "http://127.0.0.1:8080/api/files?path=/data/storage/el2/database/haps/entry/APP.db&download=true"
   ```

### 恢复（回滚）
1. 通过设备文件通道或自定义上传接口将备份文件放回沙箱（如需，先 `Stop App`）。
2. 重启应用，检查数据一致性。

> 若使用 hdc：`hdc file send backup.db /data/storage/el2/database/haps/entry/APP.db`


---

## 🧯 常见故障排查表

- **构建失败（内存不足/卡死）**
  - 将 `HVIGOR_WORKER_NUM=1`，重试 `hvigorw assembleHap`
  - 关闭其它占内存进程/减少并发编译

- **设备连接失败**
  - `hdc list targets` 检查设备是否在线；不在线则重插数据线或重启开发者服务
  - 在 DevEco Studio 选择正确设备并启用 HDB 权限

- **端口占用（8080）**
  - Windows: `netstat -ano | findstr 8080` 定位占用进程并释放
  - 或修改服务端口并同步 hdc 端口映射

- **权限不足（文件/网络）**
  - 确认 `module.json5` 已声明所需权限（见下文“权限清单与合规”）
  - 重新安装应用以应用新权限

- **ArkTS 编译告警/错误**
  - 见“常见 ArkTS 编译错误对照”，严格遵循对象字面量类型与 DSL 位置约束


---

## 🔌 API 示例（curl）与 TCP 调试

### HTTP 示例
```bash
# 1) 查询加工历史
curl "http://127.0.0.1:8080/api/processing?action=listJson"

# 2) 插入加工历史（示例）
curl "http://127.0.0.1:8080/api/processing?action=insert&startTime=2025-01-01&endTime=2025-01-02&productType=苹果&totalWeight=100"

# 3) 查询水果信息
curl "http://127.0.0.1:8080/api/fruit-info?action=listJson"

# 4) Upsert 水果信息（示例，根据参数定义填写）
curl "http://127.0.0.1:8080/api/fruit-info?action=upsert&lane=lane-1&fruitName=苹果&weight=150"

# 5) 文件列表与下载
curl "http://127.0.0.1:8080/api/files?path=/"
curl -o out.bin "http://127.0.0.1:8080/api/files?path=/data/storage/el2/base/haps/entry/files/example.bin&download=true"
```

### TCP 调试（含 hdc 端口映射）
```bash
# 将设备 TCP 9000 端口映射到本机 9000（示例）
hdc fport tcp:9000 tcp:9000

# 查看映射
hdc fport ls

# 移除映射
hdc fport rm tcp:9000
```

> 客户端可用 `TcpClientManager.ets` 或第三方工具（如 netcat）连到 `127.0.0.1:9000` 做联调。


---

## 🧪 内存监控工具与分析

本项目提供一套“采集 + 分析”的内存稳定性评估工具链，便于长期运行监控与回归对比。

### 1) 采集脚本：mem_watch.ps1（PowerShell）
- 位置：项目根目录 `mem_watch.ps1`
- 依赖：PowerShell 7+；`hdc` 已加入 PATH；真机已开启 HDB 权限
- 作用：周期性调用 `hidumper --mem <PID>`，解析内存指标并写入 CSV
- 输出：`mem_monitor_<bundle>.csv`，列包含：
  - `timestamp`：时间戳
  - `pss_mb`：PSS 总内存（MB）
  - `uss_mb`：USS（近似，受系统版本影响，仅用于趋势参考）
  - `rss_mb`：RSS（近似，受系统版本影响，仅用于趋势参考）
  - `gl_mb`：GL 图形内存（MB）
  - `arkts_heap_mb`：ArkTS 堆（MB）
  - `native_heap_mb`：Native 堆（MB）
  - `brk_heap_mb`：brk 堆（MB）

使用示例：
```powershell
# 最简单用法：按包名自动解析 PID，每5秒采样，输出到当前目录
pwsh ./mem_watch.ps1 -Bundle com.nutpi.My_Project -IntervalSec 5

# 指定输出CSV路径
pwsh ./mem_watch.ps1 -Bundle com.nutpi.My_Project -OutCsv ./mem_monitor_com.nutpi.My_Project.csv

# 同时保存原始 hidumper 文本（用于排障留存）
pwsh ./mem_watch.ps1 -Bundle com.nutpi.My_Project -RawOut -RawDir ./logs

# 已知PID时可直接传入（跳过包名解析）
pwsh ./mem_watch.ps1 -ProcId 12345 -IntervalSec 3 -OutCsv ./monitor.csv
```

注意事项：
- 如果 `pss_mb` 长时间单调走高（而业务无明显压力提升），需排查潜在泄漏；脚本在 PSS 突增时会打印告警。
- USS/RSS 列位在不同系统版本可能差异，脚本已做兼容，建议以 `pss_mb` 为主指标。

### 2) 监控结果：mem_monitor_com.nutpi.My_Project.csv（样例）
- 位置：项目根目录 `mem_monitor_com.nutpi.My_Project.csv`
- 作用：一次 15 分钟稳定性测试的样例输出，可作为后续回归的对照基线；新版本上线前建议复用 `mem_watch.ps1` 重新采集并用分析脚本比对。

### 3) 分析脚本：analyze_memory.py（Python）
- 位置：项目根目录 `analyze_memory.py`
- 依赖：Python 3（标准库 `csv`/`statistics`）
- 作用：读取 CSV，输出 PSS/Native/ArkTS 的最小、最大、均值、标准差；对最后 100/200 个点做稳定性与趋势分析；峰值与恢复检测。

使用示例：
```bash
# 确保 CSV 文件名为 mem_monitor_com.nutpi.My_Project.csv（或修改脚本第6行文件名）
python analyze_memory.py
```

输出解读要点：
- “最后200个数据点 前/后半段平均差异”小于 5MB 判定“非常稳定”；大于 10MB 则需警惕。
- 会标注最大峰值的时间点，并评估峰值后50个点是否回落到 80% 以下。

推荐流程：
1. 启动应用，运行典型业务 15 分钟以上。
2. 运行 `mem_watch.ps1` 采集，生成 CSV。
3. 运行 `analyze_memory.py` 输出评估报告并入库（和历史 CSV 留存对比）。

---

## 🔒 权限清单与合规检查

### 已使用权限（module.json5）
```json
{
  "requestPermissions": [
    { "name": "ohos.permission.INTERNET" },
    { "name": "ohos.permission.GET_NETWORK_INFO" }
  ]
}
```

### 合规建议
- 只在必要时请求网络/存储权限；涉及用户数据导出须在 UI 明示并经用户触发
- 访问设备文件系统时，应限定在应用沙箱，并提供下载提示与来源说明


---

## 🧱 环境矩阵（建议范围）

- DevEco Studio: 最新稳定版（建议 5.x 及以上）
- HarmonyOS/OpenHarmony SDK: 与目标设备系统版本匹配的最新稳定包
- Node.js: LTS 版本（建议 v18.x 或 v20.x）
- 设备系统版本：与项目当前编译 SDK 适配版本一致（以实际设备为准）

