# HarmonyOS 项目实现状态对比文档

## 📋 总体概览

本文档对比 HarmonyOS 项目与 48项目（Qt）的实现状态，帮助识别已完成和待实现的功能。

---

## ✅ 已实现功能

### 1. 协议层基础架构

#### ✅ 消息头解析和构建
- **文件**: `ProtocolParser.ets`
- **功能**: 
  - `parseHeader()` - 解析消息头
  - `buildHeader()` - 构建消息头
  - 支持小端序字节序
  - 消息长度验证

#### ✅ 二进制协议识别
- **文件**: `ProtocolParser.ets`
- **功能**: `isBinaryProtocol()` - 自动识别二进制协议格式

#### ✅ 命令类型定义
- **文件**: `CommandTypes.ets`
- **功能**: 完整定义了所有命令枚举
  - HC → FSM 命令 (0x0000 - 0x00FF)
  - FSM → HC 命令 (0x1000 - 0x10FF)
  - HC → IPM 命令 (0x2000 - 0x20FF)
  - IPM → HC 命令 (0x3000 - 0x30FF)
  - FSM → IPM 命令 (0x4000 - 0x40FF)

#### ✅ 数据结构定义
- **文件**: `Structures.ets`
- **功能**: 定义了所有数据结构
  - `StStatistics` - 统计数据
  - `StWeightInfo` - 重量信息
  - `StGradeInfo` - 分级信息
  - `StSystemConfig` - 系统配置
  - `StSizeGradeSetting` - 尺寸等级设置
  - `StQualityGradeSetting` - 品质等级设置
  - `StExitSetting` - 出口设置
  - `StChannelSetting` - 通道设置
  - `StFsmStatus` - FSM设备状态
  - `GlobalRealtimeData` - 全局实时数据

---

### 2. 数据接收和解析

#### ✅ 统计数据解析 (FSM_CMD_STATISTICS = 0x1001)
- **文件**: `ProtocolParser.ets`, `StatisticsHandler.ets`
- **功能**: 
  - 解析产量、总重、合格数、不合格数等
  - 更新 `GlobalDataInterface`
  - 自动更新设备在线状态

#### ✅ 重量信息解析 (FSM_CMD_WEIGHTINFO = 0x1003)
- **文件**: `ProtocolParser.ets`, `StatisticsHandler.ets`
- **功能**: 
  - 解析单个水果的重量、直径、体积、面积
  - 解析等级信息（重量等级、尺寸等级、品质等级）
  - 更新全局重量信息

#### ✅ 分级信息解析 (FSM_CMD_GRADEINFO = 0x1002)
- **文件**: `ProtocolParser.ets`, `StatisticsHandler.ets`
- **功能**: 
  - 解析水果的分级信息
  - 更新全局分级信息

#### ✅ 配置回复解析 (FSM_CMD_CONFIG = 0x1000)
- **文件**: `StatisticsHandler.ets`
- **功能**: 处理配置命令的回复（暂不处理具体数据）

#### ✅ 版本信息解析 (FSM_CMD_GETVERSION = 0x1008)
- **文件**: `ProtocolParser.ets`, `StatisticsHandler.ets`
- **功能**: 
  - 解析FSM版本信息
  - 更新设备状态中的版本字段

---

### 3. 命令发送功能

#### ✅ 连接控制命令
- **文件**: `ConfigSender.ets`, `ProtocolParser.ets`
- **已实现**:
  - `HC_CMD_DISPLAY_ON` (0x0050) - 连接命令（带版本号）✅
  - `HC_CMD_DISPLAY_OFF` (0x0000) - 断开连接 ✅

#### ✅ 数据控制命令
- **文件**: `ConfigSender.ets`
- **已实现**:
  - `HC_CMD_CLEAR_DATA` (0x0001) - 数据清零 ✅
  - `HC_CMD_SAVE_CURRENT_DATA` (0x0002) - 保存数据 ✅
  - `HC_CMD_EXIT_CLEAR` (0x0065) - 出口清空 ✅

#### ✅ 信息获取命令
- **文件**: `ConfigSender.ets`
- **已实现**:
  - `HC_CMD_GETVERSION` (0x0060) - 获取版本 ✅

#### ✅ 上报控制命令
- **文件**: `ConfigSender.ets`
- **已实现**:
  - `HC_CMD_WEIGHTINFO_ON` (0x0011) - 开启重量信息上报 ✅
  - `HC_CMD_WEIGHTINFO_OFF` (0x0012) - 关闭重量信息上报 ✅
  - `HC_CMD_GRADEINFO_ON` (0x000F) - 开启分级信息上报 ✅
  - `HC_CMD_GRADEINFO_OFF` (0x0010) - 关闭分级信息上报 ✅

#### ✅ 配置发送命令
- **文件**: `ConfigSender.ets`
- **已实现**:
  - `HC_CMD_GRADE_INFO` (0x0051) - 尺寸等级配置 ✅
  - `HC_CMD_EXIT_INFO` (0x0052) - 出口配置 ✅

#### ✅ 测试命令
- **文件**: `ConfigSender.ets`
- **已实现**:
  - `HC_CMD_TEST_VOLVE` (0x0055) - 电磁阀测试 ✅
  - `HC_CMD_TEST_NET` (0x0015) - 网络测试 ✅

#### ✅ 系统控制命令
- **文件**: `ConfigSender.ets`
- **已实现**:
  - `HC_CMD_WEIGHTRESET` (0x0005) - 称重重置 ✅
  - `HC_CMD_SHUT_DOWN` (0x000E) - 网络关机 ✅

---

### 4. 全局数据管理

#### ✅ 全局数据接口 (GlobalDataInterface)
- **文件**: `GlobalDataInterface.ets`
- **功能**:
  - 单例模式管理全局实时数据
  - 提供数据更新方法
  - 监听器模式支持数据变化通知
  - 设备状态管理（在线/离线、版本信息等）

#### ✅ UI数据同步 (UIDataSync)
- **文件**: `UIDataSync.ets`
- **功能**:
  - 监听 `GlobalDataInterface` 数据变化
  - 自动同步到 `AppStorage`
  - UI组件通过 `@StorageLink` 响应式更新

#### ✅ 数据库同步 (DatabaseSync)
- **文件**: `DatabaseSync.ets`
- **功能**: 数据库同步服务（已定义接口）

---

### 5. 网络通信

#### ✅ TCP服务器 (TCPServer)
- **文件**: `TCPServer.ets`
- **功能**:
  - TCP服务器监听FSM连接
  - 消息接收和分发
  - 实现 `ITcpSender` 接口
  - 支持按设备ID发送消息
  - 支持广播消息
  - 设备连接映射（deviceId → ClientInfo）

#### ✅ 设备ID管理
- **文件**: `ConstPreDefine.ets`
- **功能**:
  - `getFsmId()` - 根据子系统索引获取FSM ID
  - `getSubsysIndex()` - 从设备ID提取子系统索引
  - 设备ID编码规则（子系统+通道）

---

### 6. UI集成

#### ✅ 主页面数据绑定
- **文件**: `HomeContent.ets`
- **功能**:
  - 从 `AppStorage` 读取实时数据
  - 禁用模拟数据（`USE_MOCK_DATA = false`）
  - 显示真实统计数据

#### ✅ UI命令调用
- **文件**: `Home.ets`, `HomeContent.ets`
- **功能**:
  - "数据清零" 按钮 → 调用 `configSender.sendClearData()`
  - "出口清空" 按钮 → 调用 `configSender.sendExitClear()`

#### ✅ 实时统计对话框
- **文件**: `RealtimeStatsDialog.ets`
- **功能**: 显示实时统计数据（从 `GlobalDataInterface` 读取）

---

## ❌ 未实现功能

### 1. 协议解析器扩展

#### ❌ 更多命令的构建方法
- **文件**: `ProtocolParser.ets`
- **待实现**:
  - `buildSystemConfigCommand()` - 系统配置 (HC_CMD_SYS_CONFIG = 0x0050)
  - `buildWeightInfoConfigCommand()` - 重量信息设置 (HC_CMD_WEIGHT_INFO = 0x0053)
  - `buildChannelParamsCommand()` - 通道参数设置 (HC_CMD_PARAS_INFO = 0x0054)
  - `buildGlobalExitInfoCommand()` - 全局出口信息 (HC_CMD_GLOBAL_EXIT_INFO = 0x0058)
  - `buildGlobalWeightInfoCommand()` - 全局重量信息 (HC_CMD_GLOBAL_WEIGHT_INFO = 0x0059)
  - `buildFlawAreaInfoCommand()` - 瑕疵参数设置 (HC_CMD_FLAWAREA_INFO = 0x005A)
  - `buildGlobalInfoCommand()` - 初始化配置参数 (HC_CMD_GLOBAL_INFO = 0x005B)
  - `buildMotorInfoCommand()` - 电机使能参数 (HC_CMD_MOTOR_INFO = 0x005C)
  - `buildColorGradeInfoCommand()` - 品质等级设置 (HC_CMD_COLOR_GRADE_INFO = 0x005D)
  - `buildDensityInfoCommand()` - 模拟密度信息 (HC_CMD_DENSITY_INFO = 0x005E)
  - `buildMotorInfoAllCommand()` - 电机使能参数（全部）(HC_CMD_MOTOR_INFO_ALL = 0x005F)

#### ❌ 更多命令的解析方法
- **文件**: `ProtocolParser.ets`
- **待实现**:
  - `parseWaveInfo()` - 波形数据解析 (FSM_CMD_WAVEINFO = 0x1004)
  - `parseVersionError()` - 版本错误解析 (FSM_CMD_VERSIONERROR = 0x1005)
  - `parseBurnFlashProgress()` - 烧写进度解析 (FSM_CMD_BURN_FLASH_PROGRESS = 0x1006)
  - `parseBootFlashProgress()` - Boot烧写进度 (FSM_CMD_BOOT_FLASH_PROGRESS = 0x1009)

---

### 2. 统计数据处理器扩展

#### ❌ 更多命令的处理逻辑
- **文件**: `StatisticsHandler.ets`
- **待实现**:
  - `handleWaveInfo()` - 处理波形数据 (FSM_CMD_WAVEINFO)
  - `handleVersionError()` - 处理版本错误 (FSM_CMD_VERSIONERROR)
  - `handleBurnFlashProgress()` - 处理烧写进度 (FSM_CMD_BURN_FLASH_PROGRESS)
  - `handleBootFlashProgress()` - 处理Boot烧写进度 (FSM_CMD_BOOT_FLASH_PROGRESS)

---

### 3. 配置发送器扩展

#### ❌ 更多配置命令的发送方法
- **文件**: `ConfigSender.ets`
- **待实现**:
  - `sendSystemConfig()` - 发送系统配置 (HC_CMD_SYS_CONFIG)
  - `sendWeightInfoConfig()` - 发送重量信息设置 (HC_CMD_WEIGHT_INFO)
  - `sendChannelParams()` - 发送通道参数 (HC_CMD_PARAS_INFO)
  - `sendGlobalExitInfo()` - 发送全局出口信息 (HC_CMD_GLOBAL_EXIT_INFO)
  - `sendGlobalWeightInfo()` - 发送全局重量信息 (HC_CMD_GLOBAL_WEIGHT_INFO)
  - `sendFlawAreaInfo()` - 发送瑕疵参数 (HC_CMD_FLAWAREA_INFO)
  - `sendGlobalInfo()` - 发送初始化配置 (HC_CMD_GLOBAL_INFO)
  - `sendMotorInfo()` - 发送电机使能参数 (HC_CMD_MOTOR_INFO)
  - `sendColorGradeInfo()` - 发送品质等级设置 (HC_CMD_COLOR_GRADE_INFO)
  - `sendDensityInfo()` - 发送模拟密度信息 (HC_CMD_DENSITY_INFO)
  - `sendMotorInfoAll()` - 发送电机使能参数（全部）(HC_CMD_MOTOR_INFO_ALL)

#### ❌ 更多控制命令
- **文件**: `ConfigSender.ets`
- **待实现**:
  - `sendProjectOpened()` - 打开工程配置 (HC_CMD_PROJ_OPENED = 0x0003)
  - `sendProjectClosed()` - 关闭工程配置 (HC_CMD_PROJ_CLOSED = 0x0004)
  - `sendTestCupOn()` - 果杯测试开 (HC_CMD_TEST_CUP_ON = 0x0006)
  - `sendTestCupOff()` - 果杯测试关 (HC_CMD_TEST_CUP_OFF = 0x0007)
  - `sendCupStateReset()` - 果杯状态复位 (HC_CMD_CUPSTATERESET = 0x0008)
  - `sendWaveFormOn()` - 波形捕捉开 (HC_CMD_WAVE_FORM_ON = 0x0009)
  - `sendWaveFormOff()` - 波形捕捉关 (HC_CMD_WAVE_FORM_OFF = 0x000A)
  - `sendDataTrackingOn()` - 数据追踪开 (HC_CMD_DATA_TRACKING_ON = 0x000B)
  - `sendDataTrackingOff()` - 数据追踪关 (HC_CMD_DATA_TRACKING_OFF = 0x000C)
  - `sendBackLearn()` - 更新背景 (HC_CMD_BACK_LEARN = 0x000D)
  - `sendSimulatedPulseOn()` - 内信号源开 (HC_CMD_SIMULATEDPULSE_ON = 0x0013)
  - `sendSimulatedPulseOff()` - 内信号源关 (HC_CMD_SIMULATEDPULSE_OFF = 0x0014)
  - `sendMotorEnable()` - 电机使能 (HC_CMD_MOTOR_ENABLE = 0x0016)
  - `sendBootAppToBoot()` - APP跳转boot程序 (HC_CMD_BOOT_APP_TO_BOOT = 0x0017)
  - `sendSaveParas()` - 保存参数到Flash (HC_CMD_SAVE_PARAS = 0x0018)
  - `sendTestAllLaneValve()` - 测试所有通道的同一出口 (HC_CMD_TEST_ALL_LANE_VOLVE = 0x0056)
  - `sendResetAD()` - AD归零 (HC_CMD_RESET_AD = 0x0057)
  - `sendAutoMatchOn()` - 自动匹配开启 (HC_CMD_AUTO_MATCH_ON = 0x0061)
  - `sendAutoMatchOff()` - 自动匹配关闭 (HC_CMD_AUTO_MATCH_OFF = 0x0062)
  - `sendLockOn()` - 程序自锁开启 (HC_CMD_LOCK_ON = 0x0063)
  - `sendLockOff()` - 程序自锁关闭 (HC_CMD_LOCK_OFF = 0x0064)
  - `sendClearQueue()` - 清除水果队列 (HC_CMD_CLEAR_QUEUE = 0x0066)

---

### 4. 设备连接管理

#### ❌ 主动连接下位机（TCP客户端模式）
- **文件**: 需要新建或扩展 `TcpClient.ets`
- **功能**:
  - 主动连接到FSM设备
  - 连接状态管理
  - 自动重连机制

#### ❌ 设备列表管理
- **文件**: 需要新建 `DeviceManager.ets` 或扩展 `GlobalDataInterface.ets`
- **功能**:
  - 设备列表维护
  - 设备信息管理（IP地址、端口、状态等）
  - 设备添加/删除

#### ❌ 连接状态监控
- **文件**: 需要扩展 `TCPServer.ets` 或新建监控服务
- **功能**:
  - 心跳检测
  - 连接超时处理
  - 设备离线检测

---

### 5. 配置命令UI

#### ❌ 等级设置页面
- **文件**: `pages/level/` 目录下的页面
- **功能**:
  - 尺寸等级配置界面
  - 品质等级配置界面
  - 调用 `ConfigSender.sendSizeGradeConfig()`
  - 调用 `ConfigSender.sendColorGradeInfo()`

#### ❌ 出口设置页面
- **文件**: `pages/level/` 或 `pages/more/` 目录
- **功能**:
  - 出口配置界面
  - 调用 `ConfigSender.sendExitConfig()`
  - 调用 `ConfigSender.sendGlobalExitInfo()`

#### ❌ 重量信息设置页面
- **文件**: `pages/quality/` 或相关页面
- **功能**:
  - 重量信息配置界面
  - 调用 `ConfigSender.sendWeightInfoConfig()`
  - 调用 `ConfigSender.sendGlobalWeightInfo()`

#### ❌ 通道参数设置页面
- **文件**: 需要新建或扩展相关页面
- **功能**:
  - 通道参数配置界面
  - 调用 `ConfigSender.sendChannelParams()`

#### ❌ 系统配置页面
- **文件**: `pages/more/` 或相关页面
- **功能**:
  - 系统配置界面
  - 调用 `ConfigSender.sendSystemConfig()`
  - 调用 `ConfigSender.sendGlobalInfo()`

---

### 6. 版本信息显示

#### ❌ 设备信息对话框
- **文件**: 需要新建或扩展设备信息对话框组件
- **功能**:
  - 显示设备版本信息（从 `GlobalDataInterface` 读取）
  - 显示设备连接状态
  - 显示设备IP地址

---

### 7. 波形数据处理

#### ❌ 波形数据接收
- **文件**: `StatisticsHandler.ets`
- **功能**: 处理 `FSM_CMD_WAVEINFO` (0x1004) 命令

#### ❌ 波形数据解析
- **文件**: `ProtocolParser.ets`
- **功能**: `parseWaveInfo()` 方法解析波形数据

#### ❌ 波形数据显示
- **文件**: 需要新建波形显示组件
- **功能**:
  - 波形图表显示
  - 实时波形更新
  - 波形数据存储

---

### 8. IPM相关功能（图像处理机）

#### ❌ IPM命令发送
- **文件**: 需要新建 `IPMConfigSender.ets` 或扩展 `ConfigSender.ets`
- **功能**: 实现所有 `HC_IPM_COMMAND_TYPE` 命令的发送

#### ❌ IPM数据接收
- **文件**: 需要扩展 `StatisticsHandler.ets` 或新建 `IPMDataHandler.ets`
- **功能**: 处理所有 `IPM_HC_COMMAND_TYPE` 命令

---

### 9. 其他功能

#### ❌ 数据保存功能
- **文件**: `Home.ets` 或相关页面
- **功能**: "保存数据" 按钮 → 调用 `configSender.sendSaveData()`

#### ❌ 称重重置功能
- **文件**: 相关页面
- **功能**: "称重重置" 按钮 → 调用 `configSender.sendWeightReset()`

#### ❌ 实时统计页面数据绑定
- **文件**: `pages/realtime/` 或相关页面
- **功能**: 将页面从模拟数据改为绑定 `GlobalDataInterface` 的真实数据

---

## 📊 实现进度统计

### 协议层
- **命令定义**: ✅ 100% (所有命令类型已定义)
- **数据解析**: ✅ 50% (5/10个核心命令已实现)
- **命令构建**: ✅ 30% (约15/50个命令已实现)

### 数据管理
- **全局数据接口**: ✅ 100%
- **UI数据同步**: ✅ 100%
- **数据库同步**: ⚠️ 50% (接口已定义，实现待完善)

### 网络通信
- **TCP服务器**: ✅ 100%
- **TCP客户端**: ❌ 0% (主动连接功能未实现)
- **设备管理**: ⚠️ 50% (设备ID映射已实现，设备列表管理未实现)

### UI集成
- **主页面**: ✅ 80% (数据绑定完成，部分按钮功能未实现)
- **配置页面**: ❌ 0% (等级、出口、重量等配置页面未实现)
- **实时统计页面**: ⚠️ 50% (对话框已实现，页面数据绑定未完成)

---

## 🎯 优先级建议

### 高优先级（核心功能）
1. ✅ **数据接收和解析** - 已完成
2. ✅ **基础命令发送** - 已完成
3. ⚠️ **实时统计页面数据绑定** - 部分完成
4. ❌ **配置命令UI** - 未实现（等级、出口、重量设置）

### 中优先级（重要功能）
1. ❌ **更多命令的构建方法** - 系统配置、通道参数等
2. ❌ **设备连接管理** - 主动连接、设备列表
3. ❌ **版本信息显示** - 设备信息对话框

### 低优先级（扩展功能）
1. ❌ **波形数据处理** - 波形接收、解析、显示
2. ❌ **IPM相关功能** - 图像处理机通信
3. ❌ **其他控制命令** - 果杯测试、波形捕捉等

---

## 📝 备注

- ✅ 表示已完全实现
- ⚠️ 表示部分实现
- ❌ 表示未实现
- 所有命令ID和数据结构定义已完成，为后续实现提供了良好基础
- 核心的数据接收和基础命令发送功能已实现，可以正常接收和显示实时数据
- 配置相关的UI和命令发送功能是下一步的重点
