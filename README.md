# 分选机控制程序（HarmonyOS/ArkTS）

本项目为分选机控制程序的 HarmonyOS 版实现，使用 ArkTS 开发，已完成首页骨架、数据表格、液体水平卡片区域，以及“单元格选中→卡片投放”的数据可视化流程。

## 已完成功能

- 首页总体布局（`entry/src/main/ets/pages/home/HomeContent.ets`）
  - 顶部信息卡片：分选速度、本批重量、本批个数、开始时间、分选程序、分选效率、平均重量、实时产量、间隔速度
  - 液体卡片区域：网格排列的液体水平卡片（20 个可见，支持纵向滚动）
  - 功能按钮行：等级表、等级统计表、加工曲线、加工柱状图、动态装箱、成品
  - 底部数据区：按按钮切换不同表格卡片

- 数据表格与主题
  - `LevelTable.ets`：通用等级表组件，首列（等级名）与表头禁拖
  - 主题管理：通过 `OmniThemeManager` 统一颜色、文字、边框等样式

- 单元格选中与卡片投放（当前推荐交互）
  - 在等级表的“非首列单元格”长按，选中该单元格数据（如 45 或 45%）
  - 点击任意液体卡片，即将当前选中数据投放到该卡片：
    - 解析 value→0~100 的百分比，更新该卡片的水位
    - 卡片标签显示原始 value 文本
  - 规则：表头不可选、首列不可选，其他列均可选

- 拖拽浮层（可选，默认建议关闭）
  - 已实现随指尖移动的预览文字浮层与部分兜底逻辑
  - 受设备/容器触控事件分发影响，“拖到卡片抬手生效”在部分环境下不如点击稳定
  - 现阶段推荐使用“长按选中→点击卡片落入”的稳定模式

## 使用说明（当前推荐）

1. 在“等级表”页面，长按某个“非首列单元格”进行选中
2. 在液体卡片区域，点击任意卡片完成投放
3. 卡片水位根据数值自动更新（支持“45%”或“45”两种格式）

## 目录与关键文件

- 首页与布局
  - `entry/src/main/ets/pages/home/HomeContent.ets`：首页骨架、信息卡片、液体卡片区、按钮区、数据区
  - `entry/src/main/ets/pages/home/LiquidCardsArea.ets`：液体卡片区域（网格/滚动/投放处理）
  - `entry/src/main/ets/pages/home/DataTablesCard.ets`：数据区卡片，切换不同表格
  - `entry/src/main/ets/pages/home/SortingInfoCard.ets`：顶部信息卡片
  - `entry/src/main/ets/pages/home/FunctionButtons.ets`：功能按钮
- 表格与单元格
  - `entry/src/main/ets/components/layout/LevelTable.ets`：通用等级表
  - `entry/src/main/ets/components/ui/SimpleDraggableCell.ets`：单元格组件，长按选中，存入全局
- 主题与工具
  - `entry/src/main/ets/utils/theme/OmniThemeManager.*`：主题管理

## 构建与运行

- IDE：DevEco Studio 4.x（或与项目一致版本）
- 构建命令（由 IDE 执行）：
  - assembleHap（默认构建任务）
- 运行目标：鸿蒙模拟器或真机

常见注意：
- ArkTS 对 any/unknown、对象类型声明有严格限制，已在代码中按类型化处理
- 部分三方库 API 有“deprecated”警告，不影响当前核心流程

## 已知问题与当前策略

- 拖到卡片抬手无效：在个别环境中，触控 Up 事件可能被父级容器消耗
  - 已增加悬停索引与容器兜底，但仍可能受布局/设备差异影响
  - 当前推荐稳定模式：长按选中→点击卡片投放
- 浮层残留：已在顶层统一清空逻辑修复（未激活或抬手即清空）

## Roadmap（后续计划）

- 交互与可用性
  - [ ] 卡片“点击落入”动效与 hover 高亮（提高可视反馈）
  - [ ] 输入容错：非数字/超范围值的提示与拦截
  - [ ] 设置开关新增“启用拖拽模式”选项（默认关闭，点击模式默认开启）
- 拖拽增强（按需再开）
  - [ ] 顶层命中检测：依据卡片网格（宽/高/间距）做精确坐标映射，提升抬手命中率
  - [ ] 拖拽预览浮层的尺寸自适应与贴边处理，避免遮挡
  - [ ] 拖拽过程目标卡片 hover 高亮，抬手瞬间落卡动画
- 数据与性能
  - [ ] 按需渲染与懒加载：大量卡片/表格数据下进一步优化
  - [ ] 与设备/服务层或后端对接真实数据（HTTP/WebSocket/MQTT）
  - [ ] 日志与埋点：选中与投放操作的关键行为记录

## 变更摘要（本次迭代）

- 建立单元格选中（长按）→卡片点击投放的稳定流程
- 修复浮层残留问题，提升可视性（黑字白底）
- 增加投放解析：兼容“45%/45”两种格式，统一按 0~100 更新水位

---
如需切换为“拖拽抬手落卡”模式，请告知目标设备与系统版本，我将按设备行为补充更强的坐标命中与事件兜底策略。
