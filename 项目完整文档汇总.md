# 项目完整文档汇总

> 更新时间：2025-11-28  
> 项目：HarmonyOS 水果分选系统  
> 版本：v2.0

---

## 1. 项目概述

- ✅ 数据库抽象层（支持替换数据库）
- ✅ HTTP 通用格式与 JSON 序列化
- ✅ 页面懒加载 & 资源清理
- ✅ LazyForEach 大数据渲染
- ✅ TaskPool 异步数据库队列

### 技术栈

| 领域 | 技术 |
|------|------|
| 框架 | HarmonyOS ArkUI |
| 语言 | ArkTS (TypeScript) |
| 数据库 | SQLite + IBestORM |
| 并发 | TaskPool / DispatchQueue |
| 网络 | 自建 HTTP 服务器 |

---

## 2. 快速开始（将数据库模块用于其他项目）

### 步骤 1：复制 `database` 目录

```
你的项目/
  └── src/main/ets/
      └── database/          ← 整个目录复制
          ├── index.ets      ← 统一导出入口
          ├── DatabaseHelper.ets
          ├── adapters/
          ├── orm/
          └── ...
```

> 可以删除当前项目专用内容：`database/init.ets`、`database/models/ProcessingHistory.ets`

### 步骤 2：导入并使用

#### 方式 A：基础使用（不自动迁移）

```typescript
import { DatabaseHelper } from './database';

export async function myFunction(ctx: Context) {
  const data = await DatabaseHelper.queryAll(ctx, 'my_table');
  const id = await DatabaseHelper.insert(ctx, 'my_table', { name: '测试', value: 100 });
  await DatabaseHelper.update(ctx, 'my_table', id, { name: '更新后的名称' });
  await DatabaseHelper.delete(ctx, 'my_table', id);
}
```

#### 方式 B：带配置使用（自动迁移模型）

```typescript
import { DatabaseHelper, DatabaseAdapterFactory } from './database';
import { User, Product } from './models';

DatabaseAdapterFactory.initialize({
  dbName: 'my_app.db',
  models: [User, Product]
});

export async function myFunction(ctx: Context) {
  const users = await DatabaseHelper.queryAll(ctx, 'users');
}
```

### 步骤 3：完成

在首次调用时数据库会自动初始化，无需额外步骤。

### 完整示例

```typescript
import { Context } from '@kit.AbilityKit';
import { DatabaseHelper } from './database';

export class UserService {
  static async getAllUsers(ctx: Context) {
    return await DatabaseHelper.queryAll(ctx, 'users');
  }

  static async addUser(ctx: Context, name: string, email: string) {
    return await DatabaseHelper.insert(ctx, 'users', {
      name,
      email,
      created_at: new Date().toISOString()
    });
  }

  static async updateUser(ctx: Context, id: number, name: string) {
    return await DatabaseHelper.update(ctx, 'users', id, { name });
  }

  static async deleteUser(ctx: Context, id: number) {
    return await DatabaseHelper.delete(ctx, 'users', id);
  }
}
```

### 切换到其他数据库

```typescript
import { DatabaseAdapterFactory, MySQLAdapter } from './database';

DatabaseAdapterFactory.setAdapter(new MySQLAdapter());
// 之后所有 DatabaseHelper 调用都会使用新的适配器
```

---

## 3. 数据库模块速览

### 架构模式

- **Adapter**：`IDatabaseAdapter` 定义统一接口
- **Factory**：`DatabaseAdapterFactory` 管理实例
- **Singleton**：保证适配器实例唯一

```
业务调用 ➜ DatabaseHelper ➜ DatabaseAdapterFactory ➜ IDatabaseAdapter ➜ SQLiteAdapter / 自定义 Adapter
```

### 关键 API

| 方法 | 说明 |
|------|------|
| `queryAll(ctx, table)` | 查询所有数据，支持模型映射 |
| `queryPage(ctx, table, page, size)` | 分页查询 |
| `count(ctx, table)` | 统计总数 |
| `insert / batchInsert` | 插入单条 / 批量 |
| `update / delete` | 更新 / 删除 |
| `querySql / executeSql` | 执行原生 SQL |

---

## 4. HTTP 与 JSON 规范

### JSON 响应格式

```json
{
  "ok": true,
  "code": 200,
  "message": "操作成功",
  "data": {},
  "timestamp": 1703123456789
}
```

| 字段 | 说明 |
|------|------|
| `ok` | 成功标记 |
| `code` | 状态码 |
| `message` | 提示信息 |
| `data` | 业务数据 |
| `timestamp` | 毫秒时间戳 |

### JsonResponseFormat 用法

```typescript
import { JsonResponseFormat } from './utils/json/JsonResponseFormat';

const ok = JsonResponseFormat.buildSuccess({ id: 1 }, '查询成功', 200);
const fail = JsonResponseFormat.buildError('参数错误', 400);
const json = JsonResponseFormat.serialize(ok);
```

### JsonUtils 常用方法

| 方法 | 作用 |
|------|------|
| `serialize(obj)` | 对象 ➜ JSON 字符串 |
| `deserialize<T>(json)` | JSON 字符串 ➜ 对象 |
| `deserializeSafe<T>(json, fallback)` | 带兜底的反序列化 |
| `isValid(json)` | 判断是否为合法 JSON |
| `deepClone(obj)` | 深拷贝 |

---

## 5. 性能与排查

### 已实施优化

- **数据库 PRAGMA**：cache_size / temp_store / synchronous / WAL
- **Promise 缓存**：避免重复初始化
- **LazyForEach**：大列表懒加载
- **页面懒加载 + aboutToDisappear 清理**

### 页面懒加载效果

| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| 启动内存 | ~43MB | ~10MB |
| 启动速度 | 慢 | 快 |
| 页面数量 | 一次加载全部 | 仅当前页面 |

### 常见排查步骤

1. **波浪图卡顿**：临时禁用 WaveCard 动画确认是否是根因  
2. **页面切换内存不降**：检查 `aboutToDisappear` 是否被调用  
3. **数据库慢**：确认索引、分页、TaskPool 是否正常  
4. **HTTP 问题**：用 `hdc hilog | grep HttpServer` 查看日志  

---

## 6. 项目完成总结

| 任务 | 状态 | 说明 |
|------|------|------|
| 数据库抽象层 | ✅ | Adapter + Factory + Helper |
| 数据库文档 | ✅ | Quick Start + API |
| HTTP/JSON 规范 | ✅ | JsonResponseFormat + 文档 |
| LazyForEach 优化 | ✅ | HistoryDataTable |
| 页面懒加载 | ✅ | 独立 Builder + 清理机制 |
| TaskPool 队列 | ✅ | DatabaseQueueManager |

### 核心成果

- **架构**：数据库抽象层、HTTP 规范、统一 JSON
- **性能**：启动内存减少 77%，页面按需加载
- **文档**：快速开始、规范、排查、总结

> 如需扩展：可在此文档末尾继续补充 FAQ、版本记录或新增模块说明。

---

*文档结束*

